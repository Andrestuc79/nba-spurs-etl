[0m22:05:56.755438 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x729346ca21b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x729346dd7320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x729346d6cec0>]}


============================== 22:05:56.762215 | c48c58a2-fa5f-4090-a97f-e8319634b2c9 ==============================
[0m22:05:56.762215 [info ] [MainThread]: Running with dbt=1.7.9
[0m22:05:56.763684 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:05:57.459586 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c48c58a2-fa5f-4090-a97f-e8319634b2c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x729347094da0>]}
[0m22:05:57.603537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c48c58a2-fa5f-4090-a97f-e8319634b2c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72934612f110>]}
[0m22:05:57.605194 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m22:05:57.619056 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m22:05:57.634401 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:05:57.635434 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'c48c58a2-fa5f-4090-a97f-e8319634b2c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x729346153e60>]}
[0m22:05:59.314482 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.spurs_dbt.home_vs_away' (models/spurs_analysis/home_vs_away.sql) depends on a node named 'spurs_games' in package or project 'raw' which was not found
[0m22:05:59.318674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x729346cceff0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7293455817f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7293459b1a30>]}
[0m22:05:59.320449 [debug] [MainThread]: Flushing usage events
[0m22:27:21.548870 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bcb04ec90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bcb04e090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bcb04fef0>]}


============================== 22:27:21.555228 | 610c7a7b-23d6-4bc2-9a9a-ff3446bb5acf ==============================
[0m22:27:21.555228 [info ] [MainThread]: Running with dbt=1.7.9
[0m22:27:21.556638 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m22:27:21.846732 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '610c7a7b-23d6-4bc2-9a9a-ff3446bb5acf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bcb3d2f90>]}
[0m22:27:21.969979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '610c7a7b-23d6-4bc2-9a9a-ff3446bb5acf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bcdb126c0>]}
[0m22:27:21.971430 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m22:27:21.983840 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m22:27:21.994622 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:27:21.995564 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '610c7a7b-23d6-4bc2-9a9a-ff3446bb5acf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bca302420>]}
[0m22:27:23.129118 [error] [MainThread]: Encountered an error:
Compilation Error in model top_players_by_metric (models/spurs_analysis/top_players_by_metric.sql)
  source() takes exactly two arguments (1 given)
[0m22:27:23.131592 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bcb43d0d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bc9f93aa0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706bc9b99ca0>]}
[0m22:27:23.132538 [debug] [MainThread]: Flushing usage events
[0m22:32:12.469028 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7236a062aba0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7236a06295b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7236a062b080>]}


============================== 22:32:12.476050 | 76df2b90-bf45-4923-a44d-14ef829d30de ==============================
[0m22:32:12.476050 [info ] [MainThread]: Running with dbt=1.7.9
[0m22:32:12.477769 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m22:32:12.754111 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '76df2b90-bf45-4923-a44d-14ef829d30de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7236a192b800>]}
[0m22:32:12.867255 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '76df2b90-bf45-4923-a44d-14ef829d30de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72369f53b560>]}
[0m22:32:12.868765 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m22:32:12.880185 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m22:32:12.893758 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:32:12.894775 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '76df2b90-bf45-4923-a44d-14ef829d30de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72369f564980>]}
[0m22:32:14.543694 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.spurs_dbt.home_vs_away' (models/spurs_analysis/home_vs_away.sql) depends on a source named 'raw.spurs_games' which was not found
[0m22:32:14.545711 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7236a0a1bb90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72369f14c920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72369f1616d0>]}
[0m22:32:14.546745 [debug] [MainThread]: Flushing usage events
[0m22:37:53.867114 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c669e369b20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c669fb59a00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c669e369a60>]}


============================== 22:37:53.873941 | 3def9f8a-72f6-45fa-a9e7-652290d2665d ==============================
[0m22:37:53.873941 [info ] [MainThread]: Running with dbt=1.7.9
[0m22:37:53.875267 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:37:54.158972 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3def9f8a-72f6-45fa-a9e7-652290d2665d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c669e3c68a0>]}
[0m22:37:54.572006 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3def9f8a-72f6-45fa-a9e7-652290d2665d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c669e49fc20>]}
[0m22:37:54.573589 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m22:37:54.584426 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m22:37:54.598621 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:37:54.599593 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '3def9f8a-72f6-45fa-a9e7-652290d2665d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c669dbf3c50>]}
[0m22:37:56.681330 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m22:37:56.689106 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3def9f8a-72f6-45fa-a9e7-652290d2665d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c669c3086e0>]}
[0m22:37:56.759734 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3def9f8a-72f6-45fa-a9e7-652290d2665d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c669cb44f50>]}
[0m22:37:56.760858 [info ] [MainThread]: Found 4 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m22:37:56.761981 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3def9f8a-72f6-45fa-a9e7-652290d2665d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c669cf46f60>]}
[0m22:37:56.764849 [info ] [MainThread]: 
[0m22:37:56.766312 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:37:56.768702 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m22:37:56.783920 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m22:37:56.785041 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m22:37:56.785980 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:37:56.797377 [debug] [ThreadPool]: SQL status: SELECT 7 in 0.0 seconds
[0m22:37:56.799608 [debug] [ThreadPool]: On list_nba: Close
[0m22:37:56.803017 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_raw)
[0m22:37:56.814356 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m22:37:56.815542 [debug] [ThreadPool]: On list_nba_raw: BEGIN
[0m22:37:56.816540 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:37:56.824433 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m22:37:56.825640 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m22:37:56.826788 [debug] [ThreadPool]: On list_nba_raw: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_raw"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'raw'
  
[0m22:37:56.852419 [debug] [ThreadPool]: SQL status: SELECT 1 in 0.0 seconds
[0m22:37:56.855747 [debug] [ThreadPool]: On list_nba_raw: ROLLBACK
[0m22:37:56.857371 [debug] [ThreadPool]: On list_nba_raw: Close
[0m22:37:56.864156 [debug] [MainThread]: Using postgres connection "master"
[0m22:37:56.865209 [debug] [MainThread]: On master: BEGIN
[0m22:37:56.866434 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:37:56.873981 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:37:56.875200 [debug] [MainThread]: Using postgres connection "master"
[0m22:37:56.876359 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:37:56.893849 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m22:37:56.895938 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3def9f8a-72f6-45fa-a9e7-652290d2665d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c669ecae8d0>]}
[0m22:37:56.896929 [debug] [MainThread]: On master: ROLLBACK
[0m22:37:56.898126 [debug] [MainThread]: Using postgres connection "master"
[0m22:37:56.899119 [debug] [MainThread]: On master: BEGIN
[0m22:37:56.900662 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:37:56.901913 [debug] [MainThread]: On master: COMMIT
[0m22:37:56.902987 [debug] [MainThread]: Using postgres connection "master"
[0m22:37:56.904227 [debug] [MainThread]: On master: COMMIT
[0m22:37:56.905915 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:37:56.907064 [debug] [MainThread]: On master: Close
[0m22:37:56.908706 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:37:56.909829 [info ] [MainThread]: 
[0m22:37:56.915303 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m22:37:56.916757 [info ] [Thread-1 (]: 1 of 4 START sql view model raw.home_vs_away ................................... [RUN]
[0m22:37:56.918714 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_raw, now model.spurs_dbt.home_vs_away)
[0m22:37:56.919807 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m22:37:56.929370 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m22:37:56.966899 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 22:37:56.920726 => 22:37:56.966467
[0m22:37:56.967888 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m22:37:57.017785 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m22:37:57.052478 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:37:57.054076 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m22:37:57.055858 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:37:57.062368 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:37:57.063388 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:37:57.064273 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  create view "nba"."raw"."home_vs_away__dbt_tmp"
    
    
  as (
    with base as (
  select
    season,
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season, location
order by season, location;
  );
[0m22:37:57.065986 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near ";"
LINE 28: order by season, location;
                                  ^

[0m22:37:57.067175 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: ROLLBACK
[0m22:37:57.068670 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 22:37:56.968606 => 22:37:57.068356
[0m22:37:57.069650 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m22:37:57.080065 [debug] [Thread-1 (]: Database Error in model home_vs_away (models/spurs_analysis/home_vs_away.sql)
  syntax error at or near ";"
  LINE 28: order by season, location;
                                    ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/home_vs_away.sql
[0m22:37:57.081240 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3def9f8a-72f6-45fa-a9e7-652290d2665d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c669cb3cb60>]}
[0m22:37:57.082581 [error] [Thread-1 (]: 1 of 4 ERROR creating sql view model raw.home_vs_away .......................... [[31mERROR[0m in 0.16s]
[0m22:37:57.083882 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m22:37:57.084950 [debug] [Thread-1 (]: Began running node model.spurs_dbt.spurs_games
[0m22:37:57.086784 [info ] [Thread-1 (]: 2 of 4 START sql view model raw.spurs_games .................................... [RUN]
[0m22:37:57.089537 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.spurs_games)
[0m22:37:57.091276 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.spurs_games
[0m22:37:57.094111 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.spurs_games"
[0m22:37:57.110734 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.spurs_games (compile): 22:37:57.092110 => 22:37:57.110302
[0m22:37:57.111765 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.spurs_games
[0m22:37:57.117713 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.spurs_games"
[0m22:37:57.133202 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_games"
[0m22:37:57.133993 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_games: BEGIN
[0m22:37:57.134798 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:37:57.141904 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:37:57.143186 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_games"
[0m22:37:57.144148 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_games: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.spurs_games"} */

  create view "nba"."raw"."spurs_games__dbt_tmp"
    
    
  as (
    version: 2
sources:
  - name: raw
    tables:
      - name: spurs_games
  );
[0m22:37:57.145693 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "version"
LINE 7:     version: 2
            ^

[0m22:37:57.146739 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_games: ROLLBACK
[0m22:37:57.148151 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.spurs_games (execute): 22:37:57.112616 => 22:37:57.147849
[0m22:37:57.149170 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_games: Close
[0m22:37:57.153244 [debug] [Thread-1 (]: Database Error in model spurs_games (models/spurs_analysis/spurs_games.sql)
  syntax error at or near "version"
  LINE 7:     version: 2
              ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/spurs_games.sql
[0m22:37:57.155064 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3def9f8a-72f6-45fa-a9e7-652290d2665d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c669c3334a0>]}
[0m22:37:57.156556 [error] [Thread-1 (]: 2 of 4 ERROR creating sql view model raw.spurs_games ........................... [[31mERROR[0m in 0.07s]
[0m22:37:57.157869 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.spurs_games
[0m22:37:57.159158 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m22:37:57.160202 [info ] [Thread-1 (]: 3 of 4 START sql view model raw.summary_by_season .............................. [RUN]
[0m22:37:57.161635 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.spurs_games, now model.spurs_dbt.summary_by_season)
[0m22:37:57.162616 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m22:37:57.168147 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m22:37:57.187362 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 22:37:57.163427 => 22:37:57.186539
[0m22:37:57.189174 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m22:37:57.195063 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m22:37:57.210799 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:37:57.211690 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m22:37:57.212485 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:37:57.219025 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:37:57.220383 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:37:57.222146 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  create view "nba"."raw"."summary_by_season__dbt_tmp"
    
    
  as (
    with base as (
  select
    season,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season
order by season;
  );
[0m22:37:57.223760 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near ";"
LINE 23: order by season;
                        ^

[0m22:37:57.224758 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: ROLLBACK
[0m22:37:57.226278 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 22:37:57.190289 => 22:37:57.225857
[0m22:37:57.227319 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m22:37:57.231129 [debug] [Thread-1 (]: Database Error in model summary_by_season (models/spurs_analysis/summary_by_season.sql)
  syntax error at or near ";"
  LINE 23: order by season;
                          ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/summary_by_season.sql
[0m22:37:57.232274 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3def9f8a-72f6-45fa-a9e7-652290d2665d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c669d3cb620>]}
[0m22:37:57.233430 [error] [Thread-1 (]: 3 of 4 ERROR creating sql view model raw.summary_by_season ..................... [[31mERROR[0m in 0.07s]
[0m22:37:57.234756 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m22:37:57.235806 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m22:37:57.237365 [info ] [Thread-1 (]: 4 of 4 START sql view model raw.team_weaknesses ................................ [RUN]
[0m22:37:57.239770 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m22:37:57.240786 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m22:37:57.244394 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m22:37:57.262799 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 22:37:57.241547 => 22:37:57.262297
[0m22:37:57.263958 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m22:37:57.271707 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m22:37:57.290598 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:37:57.291736 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m22:37:57.292769 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:37:57.299935 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:37:57.301092 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:37:57.302159 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  create view "nba"."raw"."team_weaknesses__dbt_tmp"
    
    
  as (
    with base as (
  select
    season,
    fg_pct::float as fg_pct,
    tov::int as turnovers
  from "nba"."raw"."spurs_games"
)

select
  season,
   round(avg(fg_pct)::numeric, 3) as avg_fg_pct,
  round(avg(turnovers), 2) as avg_turnovers
from base
group by season
having round(avg(fg_pct)::numeric, 3) < 0.45 or round(avg(turnovers), 2) > 14
order by season;
  );
[0m22:37:57.304619 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near ";"
LINE 22: order by season;
                        ^

[0m22:37:57.306164 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: ROLLBACK
[0m22:37:57.308011 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 22:37:57.264824 => 22:37:57.307649
[0m22:37:57.309120 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m22:37:57.313025 [debug] [Thread-1 (]: Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  syntax error at or near ";"
  LINE 22: order by season;
                          ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m22:37:57.314349 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3def9f8a-72f6-45fa-a9e7-652290d2665d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c669cb82180>]}
[0m22:37:57.315662 [error] [Thread-1 (]: 4 of 4 ERROR creating sql view model raw.team_weaknesses ....................... [[31mERROR[0m in 0.07s]
[0m22:37:57.317070 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m22:37:57.321462 [debug] [MainThread]: Using postgres connection "master"
[0m22:37:57.322918 [debug] [MainThread]: On master: BEGIN
[0m22:37:57.323945 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:37:57.331832 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:37:57.332999 [debug] [MainThread]: On master: COMMIT
[0m22:37:57.334428 [debug] [MainThread]: Using postgres connection "master"
[0m22:37:57.335712 [debug] [MainThread]: On master: COMMIT
[0m22:37:57.338020 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:37:57.339642 [debug] [MainThread]: On master: Close
[0m22:37:57.341504 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:37:57.342760 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m22:37:57.344023 [info ] [MainThread]: 
[0m22:37:57.345280 [info ] [MainThread]: Finished running 4 view models in 0 hours 0 minutes and 0.58 seconds (0.58s).
[0m22:37:57.348954 [debug] [MainThread]: Command end result
[0m22:37:57.427349 [info ] [MainThread]: 
[0m22:37:57.428788 [info ] [MainThread]: [31mCompleted with 4 errors and 0 warnings:[0m
[0m22:37:57.430036 [info ] [MainThread]: 
[0m22:37:57.431326 [error] [MainThread]:   Database Error in model home_vs_away (models/spurs_analysis/home_vs_away.sql)
  syntax error at or near ";"
  LINE 28: order by season, location;
                                    ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/home_vs_away.sql
[0m22:37:57.432536 [info ] [MainThread]: 
[0m22:37:57.433642 [error] [MainThread]:   Database Error in model spurs_games (models/spurs_analysis/spurs_games.sql)
  syntax error at or near "version"
  LINE 7:     version: 2
              ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/spurs_games.sql
[0m22:37:57.434703 [info ] [MainThread]: 
[0m22:37:57.436099 [error] [MainThread]:   Database Error in model summary_by_season (models/spurs_analysis/summary_by_season.sql)
  syntax error at or near ";"
  LINE 23: order by season;
                          ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/summary_by_season.sql
[0m22:37:57.437662 [info ] [MainThread]: 
[0m22:37:57.439747 [error] [MainThread]:   Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  syntax error at or near ";"
  LINE 22: order by season;
                          ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m22:37:57.441129 [info ] [MainThread]: 
[0m22:37:57.442350 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=4 SKIP=0 TOTAL=4
[0m22:37:57.444487 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c669e36bd10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c669d795fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c669d797140>]}
[0m22:37:57.445738 [debug] [MainThread]: Flushing usage events
[0m22:43:22.839160 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a1b596c76e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a1b597366c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a1b597cad20>]}


============================== 22:43:22.845285 | e202ff32-43f3-4358-abb2-92147838f103 ==============================
[0m22:43:22.845285 [info ] [MainThread]: Running with dbt=1.7.9
[0m22:43:22.846534 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'profiles_dir': '/usr/local/airflow/dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:43:23.163783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e202ff32-43f3-4358-abb2-92147838f103', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a1b59a5e930>]}
[0m22:43:23.325987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e202ff32-43f3-4358-abb2-92147838f103', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a1b5969b590>]}
[0m22:43:23.327473 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m22:43:23.356446 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m22:43:23.563908 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 3 files changed.
[0m22:43:23.565206 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/home_vs_away.sql
[0m22:43:23.566207 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/summary_by_season.sql
[0m22:43:23.567149 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m22:43:23.979444 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m22:43:23.986149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e202ff32-43f3-4358-abb2-92147838f103', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a1b581e8a40>]}
[0m22:43:24.045702 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e202ff32-43f3-4358-abb2-92147838f103', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a1b589d4da0>]}
[0m22:43:24.046761 [info ] [MainThread]: Found 4 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m22:43:24.047829 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e202ff32-43f3-4358-abb2-92147838f103', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a1b57d35dc0>]}
[0m22:43:24.050604 [info ] [MainThread]: 
[0m22:43:24.052277 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:43:24.055447 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m22:43:24.073897 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m22:43:24.075117 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m22:43:24.076288 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:43:24.087989 [debug] [ThreadPool]: SQL status: SELECT 7 in 0.0 seconds
[0m22:43:24.091482 [debug] [ThreadPool]: On list_nba: Close
[0m22:43:24.095289 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_raw)
[0m22:43:24.104079 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m22:43:24.105822 [debug] [ThreadPool]: On list_nba_raw: BEGIN
[0m22:43:24.107927 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:43:24.115170 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m22:43:24.116293 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m22:43:24.117242 [debug] [ThreadPool]: On list_nba_raw: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_raw"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'raw'
  
[0m22:43:24.123207 [debug] [ThreadPool]: SQL status: SELECT 1 in 0.0 seconds
[0m22:43:24.125860 [debug] [ThreadPool]: On list_nba_raw: ROLLBACK
[0m22:43:24.127548 [debug] [ThreadPool]: On list_nba_raw: Close
[0m22:43:24.137729 [debug] [MainThread]: Using postgres connection "master"
[0m22:43:24.139233 [debug] [MainThread]: On master: BEGIN
[0m22:43:24.141257 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:43:24.149278 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:43:24.150410 [debug] [MainThread]: Using postgres connection "master"
[0m22:43:24.151822 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:43:24.163433 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m22:43:24.166267 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e202ff32-43f3-4358-abb2-92147838f103', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a1b58525310>]}
[0m22:43:24.167873 [debug] [MainThread]: On master: ROLLBACK
[0m22:43:24.169348 [debug] [MainThread]: Using postgres connection "master"
[0m22:43:24.170468 [debug] [MainThread]: On master: BEGIN
[0m22:43:24.172550 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:43:24.174634 [debug] [MainThread]: On master: COMMIT
[0m22:43:24.175874 [debug] [MainThread]: Using postgres connection "master"
[0m22:43:24.176867 [debug] [MainThread]: On master: COMMIT
[0m22:43:24.178339 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:43:24.179413 [debug] [MainThread]: On master: Close
[0m22:43:24.181294 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:43:24.182383 [info ] [MainThread]: 
[0m22:43:24.188648 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m22:43:24.191133 [info ] [Thread-1 (]: 1 of 4 START sql view model raw.home_vs_away ................................... [RUN]
[0m22:43:24.193274 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_raw, now model.spurs_dbt.home_vs_away)
[0m22:43:24.194538 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m22:43:24.204447 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m22:43:24.224354 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 22:43:24.195432 => 22:43:24.223954
[0m22:43:24.225332 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m22:43:24.274806 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m22:43:24.360377 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:43:24.361356 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m22:43:24.362312 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:43:24.369405 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:43:24.370552 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:43:24.371705 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  create view "nba"."raw"."home_vs_away__dbt_tmp"
    
    
  as (
    with base as (
  select
    season,
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season, location
order by season, location
  );
[0m22:43:24.418173 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m22:43:24.426845 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:43:24.427947 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m22:43:24.433761 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:43:24.457473 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:43:24.458884 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:43:24.460173 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:43:24.468670 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:43:24.479348 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."home_vs_away__dbt_backup"
[0m22:43:24.488547 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:43:24.490196 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop view if exists "nba"."raw"."home_vs_away__dbt_backup" cascade
[0m22:43:24.493258 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m22:43:24.495994 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 22:43:24.226038 => 22:43:24.495493
[0m22:43:24.497066 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m22:43:24.498668 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e202ff32-43f3-4358-abb2-92147838f103', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a1b5796d7c0>]}
[0m22:43:24.500052 [info ] [Thread-1 (]: 1 of 4 OK created sql view model raw.home_vs_away .............................. [[32mCREATE VIEW[0m in 0.31s]
[0m22:43:24.501619 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m22:43:24.502776 [debug] [Thread-1 (]: Began running node model.spurs_dbt.spurs_games
[0m22:43:24.504009 [info ] [Thread-1 (]: 2 of 4 START sql view model raw.spurs_games .................................... [RUN]
[0m22:43:24.506247 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.spurs_games)
[0m22:43:24.508328 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.spurs_games
[0m22:43:24.511521 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.spurs_games"
[0m22:43:24.530258 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.spurs_games (compile): 22:43:24.509407 => 22:43:24.529868
[0m22:43:24.531122 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.spurs_games
[0m22:43:24.537920 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.spurs_games"
[0m22:43:24.557583 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_games"
[0m22:43:24.558564 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_games: BEGIN
[0m22:43:24.559431 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:43:24.566434 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:43:24.567498 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_games"
[0m22:43:24.568623 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_games: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.spurs_games"} */

  create view "nba"."raw"."spurs_games__dbt_tmp"
    
    
  as (
    version: 2
sources:
  - name: raw
    tables:
      - name: spurs_games
  );
[0m22:43:24.570440 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "version"
LINE 7:     version: 2
            ^

[0m22:43:24.571805 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_games: ROLLBACK
[0m22:43:24.574010 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.spurs_games (execute): 22:43:24.531835 => 22:43:24.573628
[0m22:43:24.575007 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_games: Close
[0m22:43:24.580166 [debug] [Thread-1 (]: Database Error in model spurs_games (models/spurs_analysis/spurs_games.sql)
  syntax error at or near "version"
  LINE 7:     version: 2
              ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/spurs_games.sql
[0m22:43:24.581305 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e202ff32-43f3-4358-abb2-92147838f103', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a1b575294c0>]}
[0m22:43:24.582486 [error] [Thread-1 (]: 2 of 4 ERROR creating sql view model raw.spurs_games ........................... [[31mERROR[0m in 0.08s]
[0m22:43:24.583841 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.spurs_games
[0m22:43:24.584861 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m22:43:24.586365 [info ] [Thread-1 (]: 3 of 4 START sql view model raw.summary_by_season .............................. [RUN]
[0m22:43:24.587790 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.spurs_games, now model.spurs_dbt.summary_by_season)
[0m22:43:24.589196 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m22:43:24.593913 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m22:43:24.613640 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 22:43:24.590699 => 22:43:24.613227
[0m22:43:24.614591 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m22:43:24.619851 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m22:43:24.646448 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:43:24.647532 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m22:43:24.648845 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:43:24.658475 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:43:24.660026 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:43:24.661315 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  create view "nba"."raw"."summary_by_season__dbt_tmp"
    
    
  as (
    with base as (
  select
    season,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season
order by season
  );
[0m22:43:24.667519 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m22:43:24.674116 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:43:24.676459 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m22:43:24.678111 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:43:24.680822 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:43:24.681878 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:43:24.682914 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:43:24.691553 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:43:24.695436 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."summary_by_season__dbt_backup"
[0m22:43:24.697054 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:43:24.698112 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop view if exists "nba"."raw"."summary_by_season__dbt_backup" cascade
[0m22:43:24.699522 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m22:43:24.702033 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 22:43:24.615370 => 22:43:24.701763
[0m22:43:24.703350 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m22:43:24.705059 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e202ff32-43f3-4358-abb2-92147838f103', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a1b57529250>]}
[0m22:43:24.707030 [info ] [Thread-1 (]: 3 of 4 OK created sql view model raw.summary_by_season ......................... [[32mCREATE VIEW[0m in 0.12s]
[0m22:43:24.708654 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m22:43:24.709855 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m22:43:24.710931 [info ] [Thread-1 (]: 4 of 4 START sql view model raw.team_weaknesses ................................ [RUN]
[0m22:43:24.712333 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m22:43:24.713419 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m22:43:24.717410 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m22:43:24.736980 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 22:43:24.714293 => 22:43:24.736599
[0m22:43:24.737953 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m22:43:24.744120 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m22:43:24.763419 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:43:24.764439 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m22:43:24.765279 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:43:24.772877 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:43:24.774677 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:43:24.775934 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  create view "nba"."raw"."team_weaknesses__dbt_tmp"
    
    
  as (
    with base as (
  select
    season,
    fg_pct::float as fg_pct,
    tov::int as turnovers
  from "nba"."raw"."spurs_games"
)

select
  season,
   round(avg(fg_pct)::numeric, 3) as avg_fg_pct,
  round(avg(turnovers), 2) as avg_turnovers
from base
group by season
having round(avg(fg_pct)::numeric, 3) < 0.45 or round(avg(turnovers), 2) > 14
order by season
  );
[0m22:43:24.781045 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m22:43:24.785428 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:43:24.786574 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m22:43:24.788869 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:43:24.792438 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m22:43:24.793507 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:43:24.794453 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m22:43:24.804672 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:43:24.809235 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."team_weaknesses__dbt_backup"
[0m22:43:24.810758 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:43:24.811685 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop view if exists "nba"."raw"."team_weaknesses__dbt_backup" cascade
[0m22:43:24.813035 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m22:43:24.815403 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 22:43:24.738824 => 22:43:24.815120
[0m22:43:24.816540 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m22:43:24.818062 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e202ff32-43f3-4358-abb2-92147838f103', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a1b579ab8c0>]}
[0m22:43:24.819283 [info ] [Thread-1 (]: 4 of 4 OK created sql view model raw.team_weaknesses ........................... [[32mCREATE VIEW[0m in 0.11s]
[0m22:43:24.820669 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m22:43:24.824954 [debug] [MainThread]: Using postgres connection "master"
[0m22:43:24.826086 [debug] [MainThread]: On master: BEGIN
[0m22:43:24.827095 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:43:24.834033 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:43:24.835063 [debug] [MainThread]: On master: COMMIT
[0m22:43:24.836016 [debug] [MainThread]: Using postgres connection "master"
[0m22:43:24.837356 [debug] [MainThread]: On master: COMMIT
[0m22:43:24.838596 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:43:24.839932 [debug] [MainThread]: On master: Close
[0m22:43:24.841788 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:43:24.842898 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m22:43:24.844118 [info ] [MainThread]: 
[0m22:43:24.845218 [info ] [MainThread]: Finished running 4 view models in 0 hours 0 minutes and 0.79 seconds (0.79s).
[0m22:43:24.846958 [debug] [MainThread]: Command end result
[0m22:43:24.904385 [info ] [MainThread]: 
[0m22:43:24.906216 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:43:24.907741 [info ] [MainThread]: 
[0m22:43:24.908728 [error] [MainThread]:   Database Error in model spurs_games (models/spurs_analysis/spurs_games.sql)
  syntax error at or near "version"
  LINE 7:     version: 2
              ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/spurs_games.sql
[0m22:43:24.910204 [info ] [MainThread]: 
[0m22:43:24.911028 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m22:43:24.912605 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a1b59cb5160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a1b57553050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a1b57553d70>]}
[0m22:43:24.913608 [debug] [MainThread]: Flushing usage events
[0m22:50:15.837924 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7468a59a5c40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7468a59a60c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7468a59a5d30>]}


============================== 22:50:15.842929 | c3995ba4-4c4f-438d-8ba0-7ea510923f20 ==============================
[0m22:50:15.842929 [info ] [MainThread]: Running with dbt=1.7.9
[0m22:50:15.844400 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m22:50:16.131984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c3995ba4-4c4f-438d-8ba0-7ea510923f20', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7468a59a66c0>]}
[0m22:50:16.247578 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c3995ba4-4c4f-438d-8ba0-7ea510923f20', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7468a5af8290>]}
[0m22:50:16.249082 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m22:50:16.274261 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m22:50:16.523756 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 0 files added, 3 files changed.
[0m22:50:16.524815 [debug] [MainThread]: Partial parsing: deleted file: spurs_dbt://models/spurs_analysis/spurs_games.sql
[0m22:50:16.525892 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/home_vs_away.sql
[0m22:50:16.527217 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m22:50:16.529165 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/summary_by_season.sql
[0m22:50:16.683392 [error] [MainThread]: Encountered an error:
Compilation Error in model home_vs_away (models/spurs_analysis/home_vs_away.sql)
  expected token 'end of print statement', got 'with'
    line 2
      with base as (
[0m22:50:16.685379 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7468a59a6ae0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7468a516efc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7468a4912e10>]}
[0m22:50:16.686500 [debug] [MainThread]: Flushing usage events
[0m22:56:20.387893 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7402174bd820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7402174be060>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7402174bd850>]}


============================== 22:56:20.394344 | 66564152-fff6-49ac-9cdb-5708ceb3f58e ==============================
[0m22:56:20.394344 [info ] [MainThread]: Running with dbt=1.7.9
[0m22:56:20.395747 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:56:20.728774 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '66564152-fff6-49ac-9cdb-5708ceb3f58e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7402174be750>]}
[0m22:56:20.894999 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '66564152-fff6-49ac-9cdb-5708ceb3f58e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74021787e7e0>]}
[0m22:56:20.896514 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m22:56:20.921824 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m22:56:21.172640 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 0 files added, 3 files changed.
[0m22:56:21.174588 [debug] [MainThread]: Partial parsing: deleted file: spurs_dbt://models/spurs_analysis/spurs_games.sql
[0m22:56:21.176220 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/summary_by_season.sql
[0m22:56:21.177680 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m22:56:21.179412 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/home_vs_away.sql
[0m22:56:21.570504 [error] [MainThread]: Encountered an error:
Compilation Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  expected token 'end of print statement', got 'with'
    line 3
      with base as (
[0m22:56:21.578897 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74021bddaf60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x740215f5f9b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x740215f5e1b0>]}
[0m22:56:21.581065 [debug] [MainThread]: Flushing usage events
[0m22:59:58.203395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7db8030cd910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7db806901d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7db8031fe5a0>]}


============================== 22:59:58.208517 | dfedd7d6-80ec-4c16-bc5a-bed53c2aff15 ==============================
[0m22:59:58.208517 [info ] [MainThread]: Running with dbt=1.7.9
[0m22:59:58.209711 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:59:58.830737 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dfedd7d6-80ec-4c16-bc5a-bed53c2aff15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7db802776960>]}
[0m22:59:58.944279 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dfedd7d6-80ec-4c16-bc5a-bed53c2aff15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7db802f2db80>]}
[0m22:59:58.946762 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m22:59:58.986398 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m22:59:59.190738 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 0 files added, 3 files changed.
[0m22:59:59.191985 [debug] [MainThread]: Partial parsing: deleted file: spurs_dbt://models/spurs_analysis/spurs_games.sql
[0m22:59:59.193113 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m22:59:59.194677 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/home_vs_away.sql
[0m22:59:59.196733 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/summary_by_season.sql
[0m22:59:59.613407 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m22:59:59.621459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dfedd7d6-80ec-4c16-bc5a-bed53c2aff15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7db80171a0c0>]}
[0m22:59:59.680139 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dfedd7d6-80ec-4c16-bc5a-bed53c2aff15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7db8023b0bc0>]}
[0m22:59:59.681271 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m22:59:59.682362 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dfedd7d6-80ec-4c16-bc5a-bed53c2aff15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7db80177ebd0>]}
[0m22:59:59.685651 [info ] [MainThread]: 
[0m22:59:59.687265 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:59:59.689975 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m22:59:59.707464 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m22:59:59.708474 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m22:59:59.709933 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:59:59.720494 [debug] [ThreadPool]: SQL status: SELECT 7 in 0.0 seconds
[0m22:59:59.722744 [debug] [ThreadPool]: On list_nba: Close
[0m22:59:59.727012 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_raw)
[0m22:59:59.735931 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m22:59:59.737107 [debug] [ThreadPool]: On list_nba_raw: BEGIN
[0m22:59:59.738230 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:59:59.746288 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m22:59:59.747745 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m22:59:59.748635 [debug] [ThreadPool]: On list_nba_raw: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_raw"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'raw'
  
[0m22:59:59.754057 [debug] [ThreadPool]: SQL status: SELECT 1 in 0.0 seconds
[0m22:59:59.757346 [debug] [ThreadPool]: On list_nba_raw: ROLLBACK
[0m22:59:59.758985 [debug] [ThreadPool]: On list_nba_raw: Close
[0m22:59:59.770200 [debug] [MainThread]: Using postgres connection "master"
[0m22:59:59.771559 [debug] [MainThread]: On master: BEGIN
[0m22:59:59.772752 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:59:59.782109 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:59:59.783141 [debug] [MainThread]: Using postgres connection "master"
[0m22:59:59.784138 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:59:59.797999 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m22:59:59.800679 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dfedd7d6-80ec-4c16-bc5a-bed53c2aff15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7db803806930>]}
[0m22:59:59.801821 [debug] [MainThread]: On master: ROLLBACK
[0m22:59:59.805885 [debug] [MainThread]: Using postgres connection "master"
[0m22:59:59.806868 [debug] [MainThread]: On master: BEGIN
[0m22:59:59.808329 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:59:59.809478 [debug] [MainThread]: On master: COMMIT
[0m22:59:59.810458 [debug] [MainThread]: Using postgres connection "master"
[0m22:59:59.811590 [debug] [MainThread]: On master: COMMIT
[0m22:59:59.813676 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:59:59.814796 [debug] [MainThread]: On master: Close
[0m22:59:59.816337 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:59:59.818044 [info ] [MainThread]: 
[0m22:59:59.824657 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m22:59:59.826237 [info ] [Thread-1 (]: 1 of 3 START sql table model raw.home_vs_away .................................. [RUN]
[0m22:59:59.828035 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_raw, now model.spurs_dbt.home_vs_away)
[0m22:59:59.829763 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m22:59:59.839501 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m22:59:59.857787 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 22:59:59.830923 => 22:59:59.857385
[0m22:59:59.858843 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m22:59:59.908450 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m22:59:59.930259 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:59:59.931353 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m22:59:59.932378 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:59:59.939489 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:59:59.940618 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:59:59.941553 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."raw"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season, location
order by season, location
  );
  
[0m22:59:59.968196 [debug] [Thread-1 (]: SQL status: SELECT 20 in 0.0 seconds
[0m22:59:59.977052 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:59:59.978840 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m22:59:59.981016 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:00:00.005679 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:00:00.006836 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:00:00.007807 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:00:00.013568 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:00:00.022529 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."home_vs_away__dbt_backup"
[0m23:00:00.031973 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:00:00.033319 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."raw"."home_vs_away__dbt_backup" cascade
[0m23:00:00.035038 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:00:00.037826 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 22:59:59.859651 => 23:00:00.037505
[0m23:00:00.038920 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m23:00:00.040680 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dfedd7d6-80ec-4c16-bc5a-bed53c2aff15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7db80138b740>]}
[0m23:00:00.041955 [info ] [Thread-1 (]: 1 of 3 OK created sql table model raw.home_vs_away ............................. [[32mSELECT 20[0m in 0.21s]
[0m23:00:00.043537 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m23:00:00.044960 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m23:00:00.046685 [info ] [Thread-1 (]: 2 of 3 START sql table model raw.summary_by_season ............................. [RUN]
[0m23:00:00.048147 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m23:00:00.049283 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m23:00:00.055025 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m23:00:00.074401 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 23:00:00.050081 => 23:00:00.073980
[0m23:00:00.075362 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m23:00:00.081524 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m23:00:00.100359 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:00:00.101418 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m23:00:00.102330 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:00:00.110122 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:00:00.111518 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:00:00.113168 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."raw"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season
order by season
  );
  
[0m23:00:00.130829 [debug] [Thread-1 (]: SQL status: SELECT 10 in 0.0 seconds
[0m23:00:00.135291 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:00:00.136426 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m23:00:00.137950 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:00:00.140615 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:00:00.141750 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:00:00.142795 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:00:00.148883 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:00:00.152803 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."summary_by_season__dbt_backup"
[0m23:00:00.154254 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:00:00.155266 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."raw"."summary_by_season__dbt_backup" cascade
[0m23:00:00.156855 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:00:00.159184 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 23:00:00.076105 => 23:00:00.158909
[0m23:00:00.160454 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m23:00:00.162634 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dfedd7d6-80ec-4c16-bc5a-bed53c2aff15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7db8013f3230>]}
[0m23:00:00.164293 [info ] [Thread-1 (]: 2 of 3 OK created sql table model raw.summary_by_season ........................ [[32mSELECT 10[0m in 0.11s]
[0m23:00:00.165921 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m23:00:00.167143 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m23:00:00.168475 [info ] [Thread-1 (]: 3 of 3 START sql table model raw.team_weaknesses ............................... [RUN]
[0m23:00:00.169895 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m23:00:00.170984 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m23:00:00.175077 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m23:00:00.194222 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 23:00:00.171862 => 23:00:00.193827
[0m23:00:00.195926 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m23:00:00.201415 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m23:00:00.220121 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:00:00.221049 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m23:00:00.221901 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:00:00.228687 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:00:00.230196 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:00:00.231255 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."raw"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    fg_pct::float as fg_pct,
    tov::int as turnovers
  from "nba"."raw"."spurs_games"
)

select
  season,
   round(avg(fg_pct)::numeric, 3) as avg_fg_pct,
  round(avg(turnovers), 2) as avg_turnovers
from base
group by season
having round(avg(fg_pct)::numeric, 3) < 0.45 or round(avg(turnovers), 2) > 14
order by season
  );
  
[0m23:00:00.246539 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m23:00:00.250973 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:00:00.252122 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m23:00:00.253663 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:00:00.256299 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:00:00.257547 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:00:00.258645 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:00:00.264529 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:00:00.268689 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."team_weaknesses__dbt_backup"
[0m23:00:00.270178 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:00:00.271142 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."raw"."team_weaknesses__dbt_backup" cascade
[0m23:00:00.272522 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:00:00.274894 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 23:00:00.196917 => 23:00:00.274598
[0m23:00:00.276410 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m23:00:00.278520 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dfedd7d6-80ec-4c16-bc5a-bed53c2aff15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7db8013cd3d0>]}
[0m23:00:00.281473 [info ] [Thread-1 (]: 3 of 3 OK created sql table model raw.team_weaknesses .......................... [[32mSELECT 2[0m in 0.11s]
[0m23:00:00.282882 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m23:00:00.286003 [debug] [MainThread]: Using postgres connection "master"
[0m23:00:00.286884 [debug] [MainThread]: On master: BEGIN
[0m23:00:00.287598 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:00:00.294275 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:00:00.295755 [debug] [MainThread]: On master: COMMIT
[0m23:00:00.297005 [debug] [MainThread]: Using postgres connection "master"
[0m23:00:00.298082 [debug] [MainThread]: On master: COMMIT
[0m23:00:00.299305 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:00:00.300263 [debug] [MainThread]: On master: Close
[0m23:00:00.301876 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:00:00.302821 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m23:00:00.303831 [info ] [MainThread]: 
[0m23:00:00.304868 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.62 seconds (0.62s).
[0m23:00:00.306733 [debug] [MainThread]: Command end result
[0m23:00:00.360258 [info ] [MainThread]: 
[0m23:00:00.362476 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:00:00.364316 [info ] [MainThread]: 
[0m23:00:00.365765 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m23:00:00.367948 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7db8079eaf60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7db8013179b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7db801b837d0>]}
[0m23:00:00.369377 [debug] [MainThread]: Flushing usage events
[0m23:11:10.271464 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4681c03650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4681c00950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4681c00350>]}


============================== 23:11:10.277667 | 3d336d45-61ed-4de7-a4b2-8c5bccf1c060 ==============================
[0m23:11:10.277667 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:11:10.279602 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m23:11:10.743360 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3d336d45-61ed-4de7-a4b2-8c5bccf1c060', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4681a97d70>]}
[0m23:11:10.884174 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3d336d45-61ed-4de7-a4b2-8c5bccf1c060', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4681aaebd0>]}
[0m23:11:10.885771 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:11:10.913819 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:11:11.141334 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:11:11.142514 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:11:11.143818 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m23:11:11.153331 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3d336d45-61ed-4de7-a4b2-8c5bccf1c060', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4680b23e00>]}
[0m23:11:11.214317 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3d336d45-61ed-4de7-a4b2-8c5bccf1c060', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4680bbdd00>]}
[0m23:11:11.216671 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m23:11:11.218056 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3d336d45-61ed-4de7-a4b2-8c5bccf1c060', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4680bbd520>]}
[0m23:11:11.221376 [info ] [MainThread]: 
[0m23:11:11.223427 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:11:11.227209 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m23:11:11.245421 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m23:11:11.247143 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m23:11:11.249313 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:11:11.260218 [debug] [ThreadPool]: SQL status: SELECT 7 in 0.0 seconds
[0m23:11:11.262702 [debug] [ThreadPool]: On list_nba: Close
[0m23:11:11.267507 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_raw)
[0m23:11:11.278183 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m23:11:11.279565 [debug] [ThreadPool]: On list_nba_raw: BEGIN
[0m23:11:11.281355 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:11:11.289743 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m23:11:11.290915 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m23:11:11.291981 [debug] [ThreadPool]: On list_nba_raw: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_raw"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'raw'
  
[0m23:11:11.297384 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m23:11:11.300305 [debug] [ThreadPool]: On list_nba_raw: ROLLBACK
[0m23:11:11.301979 [debug] [ThreadPool]: On list_nba_raw: Close
[0m23:11:11.311759 [debug] [MainThread]: Using postgres connection "master"
[0m23:11:11.312975 [debug] [MainThread]: On master: BEGIN
[0m23:11:11.314271 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:11:11.322042 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:11:11.323170 [debug] [MainThread]: Using postgres connection "master"
[0m23:11:11.324287 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m23:11:11.344771 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m23:11:11.348580 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3d336d45-61ed-4de7-a4b2-8c5bccf1c060', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4681c032c0>]}
[0m23:11:11.350100 [debug] [MainThread]: On master: ROLLBACK
[0m23:11:11.351658 [debug] [MainThread]: Using postgres connection "master"
[0m23:11:11.352545 [debug] [MainThread]: On master: BEGIN
[0m23:11:11.354217 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:11:11.355225 [debug] [MainThread]: On master: COMMIT
[0m23:11:11.356200 [debug] [MainThread]: Using postgres connection "master"
[0m23:11:11.357454 [debug] [MainThread]: On master: COMMIT
[0m23:11:11.359064 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:11:11.360210 [debug] [MainThread]: On master: Close
[0m23:11:11.361855 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m23:11:11.362947 [info ] [MainThread]: 
[0m23:11:11.369329 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m23:11:11.370634 [info ] [Thread-1 (]: 1 of 3 START sql table model raw.home_vs_away .................................. [RUN]
[0m23:11:11.372017 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_raw, now model.spurs_dbt.home_vs_away)
[0m23:11:11.372927 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m23:11:11.385444 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m23:11:11.400570 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 23:11:11.373561 => 23:11:11.400148
[0m23:11:11.401446 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m23:11:11.458139 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m23:11:11.474261 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:11:11.475208 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m23:11:11.476061 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:11:11.483739 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:11:11.484856 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:11:11.485992 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."raw"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season, location
order by season, location
  );
  
[0m23:11:11.507995 [debug] [Thread-1 (]: SQL status: SELECT 20 in 0.0 seconds
[0m23:11:11.517966 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:11:11.519100 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m23:11:11.520744 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:11:11.525101 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:11:11.526023 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m23:11:11.527471 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:11:11.557089 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:11:11.558098 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:11:11.559034 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:11:11.566396 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:11:11.575273 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."home_vs_away__dbt_backup"
[0m23:11:11.586301 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:11:11.587466 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."raw"."home_vs_away__dbt_backup" cascade
[0m23:11:11.595881 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:11:11.599702 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 23:11:11.402103 => 23:11:11.599380
[0m23:11:11.600765 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m23:11:11.602350 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3d336d45-61ed-4de7-a4b2-8c5bccf1c060', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4680b6e9c0>]}
[0m23:11:11.603542 [info ] [Thread-1 (]: 1 of 3 OK created sql table model raw.home_vs_away ............................. [[32mSELECT 20[0m in 0.23s]
[0m23:11:11.604873 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m23:11:11.606123 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m23:11:11.607132 [info ] [Thread-1 (]: 2 of 3 START sql table model raw.summary_by_season ............................. [RUN]
[0m23:11:11.608501 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m23:11:11.609421 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m23:11:11.614506 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m23:11:11.633926 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 23:11:11.610237 => 23:11:11.633415
[0m23:11:11.634974 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m23:11:11.640645 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m23:11:11.658463 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:11:11.659457 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m23:11:11.660377 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:11:11.668499 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:11:11.669597 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:11:11.670668 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."raw"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season
order by season
  );
  
[0m23:11:11.687428 [debug] [Thread-1 (]: SQL status: SELECT 10 in 0.0 seconds
[0m23:11:11.692036 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:11:11.693110 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m23:11:11.694632 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:11:11.700841 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:11:11.702165 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m23:11:11.703772 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:11:11.706970 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:11:11.708059 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:11:11.709027 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:11:11.714948 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:11:11.719356 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."summary_by_season__dbt_backup"
[0m23:11:11.721015 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:11:11.722168 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."raw"."summary_by_season__dbt_backup" cascade
[0m23:11:11.729073 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:11:11.732711 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 23:11:11.635779 => 23:11:11.732319
[0m23:11:11.734012 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m23:11:11.736107 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3d336d45-61ed-4de7-a4b2-8c5bccf1c060', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a468036df40>]}
[0m23:11:11.739936 [info ] [Thread-1 (]: 2 of 3 OK created sql table model raw.summary_by_season ........................ [[32mSELECT 10[0m in 0.13s]
[0m23:11:11.742138 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m23:11:11.743678 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m23:11:11.745158 [info ] [Thread-1 (]: 3 of 3 START sql table model raw.team_weaknesses ............................... [RUN]
[0m23:11:11.747252 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m23:11:11.748917 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m23:11:11.754081 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m23:11:11.772800 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 23:11:11.750105 => 23:11:11.772344
[0m23:11:11.774646 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m23:11:11.782708 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m23:11:11.801775 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:11:11.802954 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m23:11:11.804143 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:11:11.811838 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:11:11.813014 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:11:11.814315 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."raw"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    fg_pct::float as fg_pct,
    tov::int as turnovers
  from "nba"."raw"."spurs_games"
)

select
  season,
   round(avg(fg_pct)::numeric, 3) as avg_fg_pct,
  round(avg(turnovers), 2) as avg_turnovers
from base
group by season
having round(avg(fg_pct)::numeric, 3) < 0.45 or round(avg(turnovers), 2) > 14
order by season
  );
  
[0m23:11:11.833635 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m23:11:11.840401 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:11:11.841569 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m23:11:11.843116 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:11:11.847816 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:11:11.848981 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m23:11:11.850601 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:11:11.854452 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:11:11.856203 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:11:11.857252 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:11:11.863060 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:11:11.867724 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."team_weaknesses__dbt_backup"
[0m23:11:11.869366 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:11:11.870387 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."raw"."team_weaknesses__dbt_backup" cascade
[0m23:11:11.876809 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:11:11.879724 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 23:11:11.775957 => 23:11:11.879419
[0m23:11:11.881055 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m23:11:11.882817 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3d336d45-61ed-4de7-a4b2-8c5bccf1c060', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a46803baf90>]}
[0m23:11:11.885804 [info ] [Thread-1 (]: 3 of 3 OK created sql table model raw.team_weaknesses .......................... [[32mSELECT 2[0m in 0.14s]
[0m23:11:11.887371 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m23:11:11.890989 [debug] [MainThread]: Using postgres connection "master"
[0m23:11:11.892057 [debug] [MainThread]: On master: BEGIN
[0m23:11:11.893163 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:11:11.900533 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:11:11.901607 [debug] [MainThread]: On master: COMMIT
[0m23:11:11.902662 [debug] [MainThread]: Using postgres connection "master"
[0m23:11:11.903544 [debug] [MainThread]: On master: COMMIT
[0m23:11:11.904804 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:11:11.905888 [debug] [MainThread]: On master: Close
[0m23:11:11.907504 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:11:11.908509 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m23:11:11.910012 [info ] [MainThread]: 
[0m23:11:11.911167 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.69 seconds (0.69s).
[0m23:11:11.913209 [debug] [MainThread]: Command end result
[0m23:11:11.980478 [info ] [MainThread]: 
[0m23:11:11.981908 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:11:11.983208 [info ] [MainThread]: 
[0m23:11:11.984471 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m23:11:11.986595 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a46841ce240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a468037fa70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a46803a39b0>]}
[0m23:11:11.987956 [debug] [MainThread]: Flushing usage events
[0m23:13:36.251826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccaf6f3f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccb1e2d730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccaf6f27b0>]}


============================== 23:13:36.262350 | 969768b6-1622-4a10-ba5a-405246026f06 ==============================
[0m23:13:36.262350 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:13:36.266261 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:13:36.649120 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '969768b6-1622-4a10-ba5a-405246026f06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccaf6f3350>]}
[0m23:13:36.768985 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '969768b6-1622-4a10-ba5a-405246026f06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccaf5ebf80>]}
[0m23:13:36.770888 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:13:36.796765 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:13:36.987407 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:13:36.988424 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:13:36.989706 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m23:13:36.996584 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '969768b6-1622-4a10-ba5a-405246026f06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccaedc1b80>]}
[0m23:13:37.069710 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '969768b6-1622-4a10-ba5a-405246026f06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccae9d5b80>]}
[0m23:13:37.070886 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m23:13:37.072594 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '969768b6-1622-4a10-ba5a-405246026f06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccb052a930>]}
[0m23:13:37.075484 [info ] [MainThread]: 
[0m23:13:37.077035 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:13:37.079692 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m23:13:37.097851 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m23:13:37.098925 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m23:13:37.099919 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:13:37.110787 [debug] [ThreadPool]: SQL status: SELECT 7 in 0.0 seconds
[0m23:13:37.113184 [debug] [ThreadPool]: On list_nba: Close
[0m23:13:37.117026 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_raw)
[0m23:13:37.126940 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m23:13:37.127978 [debug] [ThreadPool]: On list_nba_raw: BEGIN
[0m23:13:37.128891 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:13:37.135722 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m23:13:37.136989 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m23:13:37.138002 [debug] [ThreadPool]: On list_nba_raw: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_raw"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'raw'
  
[0m23:13:37.143241 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m23:13:37.145804 [debug] [ThreadPool]: On list_nba_raw: ROLLBACK
[0m23:13:37.147357 [debug] [ThreadPool]: On list_nba_raw: Close
[0m23:13:37.156445 [debug] [MainThread]: Using postgres connection "master"
[0m23:13:37.157678 [debug] [MainThread]: On master: BEGIN
[0m23:13:37.158924 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:13:37.165918 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:13:37.167018 [debug] [MainThread]: Using postgres connection "master"
[0m23:13:37.168069 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m23:13:37.181600 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m23:13:37.183644 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '969768b6-1622-4a10-ba5a-405246026f06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccae93b860>]}
[0m23:13:37.184768 [debug] [MainThread]: On master: ROLLBACK
[0m23:13:37.186203 [debug] [MainThread]: Using postgres connection "master"
[0m23:13:37.187157 [debug] [MainThread]: On master: BEGIN
[0m23:13:37.188844 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:13:37.189929 [debug] [MainThread]: On master: COMMIT
[0m23:13:37.190875 [debug] [MainThread]: Using postgres connection "master"
[0m23:13:37.191805 [debug] [MainThread]: On master: COMMIT
[0m23:13:37.193087 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:13:37.194241 [debug] [MainThread]: On master: Close
[0m23:13:37.195737 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m23:13:37.197218 [info ] [MainThread]: 
[0m23:13:37.203125 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m23:13:37.204369 [info ] [Thread-1 (]: 1 of 3 START sql table model raw.home_vs_away .................................. [RUN]
[0m23:13:37.205846 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_raw, now model.spurs_dbt.home_vs_away)
[0m23:13:37.206862 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m23:13:37.217039 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m23:13:37.242803 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 23:13:37.207700 => 23:13:37.242409
[0m23:13:37.243802 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m23:13:37.290073 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m23:13:37.316244 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:13:37.317252 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m23:13:37.318218 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:13:37.325568 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:13:37.326620 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:13:37.327543 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."raw"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season, location
order by season, location
  );
  
[0m23:13:37.349559 [debug] [Thread-1 (]: SQL status: SELECT 20 in 0.0 seconds
[0m23:13:37.357754 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:13:37.358842 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m23:13:37.360245 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:13:37.364360 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:13:37.365389 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m23:13:37.366795 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:13:37.391986 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:13:37.393238 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:13:37.394344 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:13:37.402238 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:13:37.411835 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."home_vs_away__dbt_backup"
[0m23:13:37.419269 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:13:37.420763 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."raw"."home_vs_away__dbt_backup" cascade
[0m23:13:37.432132 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:13:37.435342 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 23:13:37.244631 => 23:13:37.434716
[0m23:13:37.437097 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m23:13:37.438867 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '969768b6-1622-4a10-ba5a-405246026f06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccaf5cade0>]}
[0m23:13:37.440115 [info ] [Thread-1 (]: 1 of 3 OK created sql table model raw.home_vs_away ............................. [[32mSELECT 20[0m in 0.23s]
[0m23:13:37.441715 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m23:13:37.442895 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m23:13:37.443960 [info ] [Thread-1 (]: 2 of 3 START sql table model raw.summary_by_season ............................. [RUN]
[0m23:13:37.445460 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m23:13:37.446414 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m23:13:37.450601 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m23:13:37.478247 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 23:13:37.447166 => 23:13:37.477857
[0m23:13:37.479244 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m23:13:37.484869 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m23:13:37.510779 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:13:37.511886 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m23:13:37.512862 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:13:37.520845 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:13:37.521935 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:13:37.522923 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."raw"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season
order by season
  );
  
[0m23:13:37.539683 [debug] [Thread-1 (]: SQL status: SELECT 10 in 0.0 seconds
[0m23:13:37.544091 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:13:37.545285 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m23:13:37.546901 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:13:37.551029 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:13:37.552224 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m23:13:37.553887 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:13:37.556707 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:13:37.557735 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:13:37.558740 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:13:37.564888 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:13:37.568682 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."summary_by_season__dbt_backup"
[0m23:13:37.570243 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:13:37.571248 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."raw"."summary_by_season__dbt_backup" cascade
[0m23:13:37.578214 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:13:37.580809 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 23:13:37.480008 => 23:13:37.580450
[0m23:13:37.581839 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m23:13:37.583423 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '969768b6-1622-4a10-ba5a-405246026f06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccae187290>]}
[0m23:13:37.584709 [info ] [Thread-1 (]: 2 of 3 OK created sql table model raw.summary_by_season ........................ [[32mSELECT 10[0m in 0.14s]
[0m23:13:37.586075 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m23:13:37.587347 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m23:13:37.588414 [info ] [Thread-1 (]: 3 of 3 START sql table model raw.team_weaknesses ............................... [RUN]
[0m23:13:37.589915 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m23:13:37.590814 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m23:13:37.594955 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m23:13:37.626349 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 23:13:37.591530 => 23:13:37.625537
[0m23:13:37.627944 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m23:13:37.634143 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m23:13:37.660280 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:13:37.661568 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m23:13:37.662596 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:13:37.669934 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:13:37.671069 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:13:37.672135 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."raw"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    fg_pct::float as fg_pct,
    tov::int as turnovers
  from "nba"."raw"."spurs_games"
)

select
  season,
   round(avg(fg_pct)::numeric, 3) as avg_fg_pct,
  round(avg(turnovers), 2) as avg_turnovers
from base
group by season
having round(avg(fg_pct)::numeric, 3) < 0.45 or round(avg(turnovers), 2) > 14
order by season
  );
  
[0m23:13:37.689010 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m23:13:37.694986 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:13:37.695995 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m23:13:37.697915 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:13:37.702432 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:13:37.703595 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m23:13:37.705148 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:13:37.708073 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:13:37.709091 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:13:37.710205 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:13:37.716233 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:13:37.720491 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."team_weaknesses__dbt_backup"
[0m23:13:37.722064 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:13:37.722991 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."raw"."team_weaknesses__dbt_backup" cascade
[0m23:13:37.731547 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:13:37.734315 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 23:13:37.628937 => 23:13:37.733854
[0m23:13:37.735853 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m23:13:37.737514 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '969768b6-1622-4a10-ba5a-405246026f06', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccae1a13a0>]}
[0m23:13:37.738761 [info ] [Thread-1 (]: 3 of 3 OK created sql table model raw.team_weaknesses .......................... [[32mSELECT 2[0m in 0.15s]
[0m23:13:37.740171 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m23:13:37.743976 [debug] [MainThread]: Using postgres connection "master"
[0m23:13:37.745089 [debug] [MainThread]: On master: BEGIN
[0m23:13:37.746119 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:13:37.753025 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:13:37.754285 [debug] [MainThread]: On master: COMMIT
[0m23:13:37.755260 [debug] [MainThread]: Using postgres connection "master"
[0m23:13:37.756202 [debug] [MainThread]: On master: COMMIT
[0m23:13:37.757464 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:13:37.758454 [debug] [MainThread]: On master: Close
[0m23:13:37.759869 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:13:37.760735 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m23:13:37.761754 [info ] [MainThread]: 
[0m23:13:37.762714 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.69 seconds (0.69s).
[0m23:13:37.764411 [debug] [MainThread]: Command end result
[0m23:13:37.832611 [info ] [MainThread]: 
[0m23:13:37.833813 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:13:37.834937 [info ] [MainThread]: 
[0m23:13:37.836419 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m23:13:37.838341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccaf5cade0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccaf80e4e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fccaf80dc70>]}
[0m23:13:37.839656 [debug] [MainThread]: Flushing usage events
[0m23:25:41.311975 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x741307b12c90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x741307ae6f00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x741308355820>]}


============================== 23:25:41.322620 | ef086e7f-0b8f-4a15-b286-237dba77a46e ==============================
[0m23:25:41.322620 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:25:41.325154 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m23:25:41.784525 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ef086e7f-0b8f-4a15-b286-237dba77a46e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7413071220f0>]}
[0m23:25:41.925463 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ef086e7f-0b8f-4a15-b286-237dba77a46e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7413075c67b0>]}
[0m23:25:41.928707 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:25:41.957522 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:25:42.156182 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:25:42.157366 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:25:42.162213 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m23:25:42.173699 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ef086e7f-0b8f-4a15-b286-237dba77a46e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x741306d3ee40>]}
[0m23:25:42.233879 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ef086e7f-0b8f-4a15-b286-237dba77a46e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x741306dd9d00>]}
[0m23:25:42.234988 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m23:25:42.236219 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ef086e7f-0b8f-4a15-b286-237dba77a46e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x741307791ac0>]}
[0m23:25:42.239333 [info ] [MainThread]: 
[0m23:25:42.241216 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:25:42.244913 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m23:25:42.266615 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m23:25:42.268152 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m23:25:42.269222 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:25:42.281611 [debug] [ThreadPool]: SQL status: SELECT 7 in 0.0 seconds
[0m23:25:42.284570 [debug] [ThreadPool]: On list_nba: Close
[0m23:25:42.288513 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_raw)
[0m23:25:42.299914 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m23:25:42.300943 [debug] [ThreadPool]: On list_nba_raw: BEGIN
[0m23:25:42.301870 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:25:42.310540 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m23:25:42.312105 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m23:25:42.313289 [debug] [ThreadPool]: On list_nba_raw: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_raw"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'raw'
  
[0m23:25:42.318984 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m23:25:42.321342 [debug] [ThreadPool]: On list_nba_raw: ROLLBACK
[0m23:25:42.322708 [debug] [ThreadPool]: On list_nba_raw: Close
[0m23:25:42.332738 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:42.334261 [debug] [MainThread]: On master: BEGIN
[0m23:25:42.335762 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:25:42.343913 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:25:42.345316 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:42.346254 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m23:25:42.361410 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m23:25:42.363443 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ef086e7f-0b8f-4a15-b286-237dba77a46e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x741306dd9e20>]}
[0m23:25:42.364605 [debug] [MainThread]: On master: ROLLBACK
[0m23:25:42.365705 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:42.366640 [debug] [MainThread]: On master: BEGIN
[0m23:25:42.368261 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:25:42.369317 [debug] [MainThread]: On master: COMMIT
[0m23:25:42.370235 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:42.371087 [debug] [MainThread]: On master: COMMIT
[0m23:25:42.372182 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:25:42.372962 [debug] [MainThread]: On master: Close
[0m23:25:42.374242 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m23:25:42.375314 [info ] [MainThread]: 
[0m23:25:42.381335 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m23:25:42.382623 [info ] [Thread-1 (]: 1 of 3 START sql table model raw.home_vs_away .................................. [RUN]
[0m23:25:42.384338 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_raw, now model.spurs_dbt.home_vs_away)
[0m23:25:42.385316 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m23:25:42.396071 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m23:25:42.412320 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 23:25:42.386096 => 23:25:42.411688
[0m23:25:42.414187 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m23:25:42.474606 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m23:25:42.488631 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:25:42.489430 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m23:25:42.490122 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:25:42.497294 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:25:42.498455 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:25:42.499330 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."raw"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season, location
order by season, location
  );
  
[0m23:25:42.519692 [debug] [Thread-1 (]: SQL status: SELECT 20 in 0.0 seconds
[0m23:25:42.528388 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:25:42.529556 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m23:25:42.531216 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:25:42.535357 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:25:42.536453 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m23:25:42.537941 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:25:42.564815 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:25:42.565955 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:25:42.566814 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:25:42.574484 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:25:42.584102 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."home_vs_away__dbt_backup"
[0m23:25:42.591919 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:25:42.593476 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."raw"."home_vs_away__dbt_backup" cascade
[0m23:25:42.600255 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:25:42.602737 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 23:25:42.417573 => 23:25:42.602446
[0m23:25:42.603777 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m23:25:42.605213 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ef086e7f-0b8f-4a15-b286-237dba77a46e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x741306538500>]}
[0m23:25:42.606406 [info ] [Thread-1 (]: 1 of 3 OK created sql table model raw.home_vs_away ............................. [[32mSELECT 20[0m in 0.22s]
[0m23:25:42.608117 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m23:25:42.610031 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m23:25:42.611728 [info ] [Thread-1 (]: 2 of 3 START sql table model raw.summary_by_season ............................. [RUN]
[0m23:25:42.613082 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m23:25:42.613958 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m23:25:42.618038 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m23:25:42.634322 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 23:25:42.614680 => 23:25:42.633923
[0m23:25:42.635236 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m23:25:42.640503 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m23:25:42.656029 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:25:42.656917 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m23:25:42.657744 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:25:42.664895 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:25:42.665834 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:25:42.666708 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."raw"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season
order by season
  );
  
[0m23:25:42.681402 [debug] [Thread-1 (]: SQL status: SELECT 10 in 0.0 seconds
[0m23:25:42.686497 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:25:42.687688 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m23:25:42.689231 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:25:42.694481 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:25:42.695641 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m23:25:42.697097 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:25:42.700002 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:25:42.700893 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:25:42.701724 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:25:42.709544 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:25:42.713800 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."summary_by_season__dbt_backup"
[0m23:25:42.715112 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:25:42.716068 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."raw"."summary_by_season__dbt_backup" cascade
[0m23:25:42.722124 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:25:42.725065 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 23:25:42.635971 => 23:25:42.724667
[0m23:25:42.726356 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m23:25:42.728158 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ef086e7f-0b8f-4a15-b286-237dba77a46e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x741306537ef0>]}
[0m23:25:42.729382 [info ] [Thread-1 (]: 2 of 3 OK created sql table model raw.summary_by_season ........................ [[32mSELECT 10[0m in 0.12s]
[0m23:25:42.730905 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m23:25:42.731980 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m23:25:42.732984 [info ] [Thread-1 (]: 3 of 3 START sql table model raw.team_weaknesses ............................... [RUN]
[0m23:25:42.734307 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m23:25:42.735179 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m23:25:42.739053 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m23:25:42.755102 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 23:25:42.735880 => 23:25:42.754709
[0m23:25:42.756158 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m23:25:42.762368 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m23:25:42.777445 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:25:42.778388 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m23:25:42.779206 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:25:42.785646 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:25:42.786578 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:25:42.787444 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."raw"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    fg_pct::float as fg_pct,
    tov::int as turnovers
  from "nba"."raw"."spurs_games"
)

select
  season,
   round(avg(fg_pct)::numeric, 3) as avg_fg_pct,
  round(avg(turnovers), 2) as avg_turnovers
from base
group by season
having round(avg(fg_pct)::numeric, 3) < 0.45 or round(avg(turnovers), 2) > 14
order by season
  );
  
[0m23:25:42.803105 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m23:25:42.812559 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:25:42.813782 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m23:25:42.815437 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:25:42.820459 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:25:42.821549 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m23:25:42.823146 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:25:42.826675 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:25:42.828108 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:25:42.829104 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:25:42.834822 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:25:42.838488 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."team_weaknesses__dbt_backup"
[0m23:25:42.840049 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:25:42.841044 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."raw"."team_weaknesses__dbt_backup" cascade
[0m23:25:42.850788 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:25:42.853450 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 23:25:42.756809 => 23:25:42.853175
[0m23:25:42.854500 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m23:25:42.856101 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ef086e7f-0b8f-4a15-b286-237dba77a46e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7413065a68d0>]}
[0m23:25:42.858700 [info ] [Thread-1 (]: 3 of 3 OK created sql table model raw.team_weaknesses .......................... [[32mSELECT 2[0m in 0.12s]
[0m23:25:42.860899 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m23:25:42.863818 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:42.864768 [debug] [MainThread]: On master: BEGIN
[0m23:25:42.865582 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:25:42.872088 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:25:42.873073 [debug] [MainThread]: On master: COMMIT
[0m23:25:42.874003 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:42.875121 [debug] [MainThread]: On master: COMMIT
[0m23:25:42.877138 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:25:42.878357 [debug] [MainThread]: On master: Close
[0m23:25:42.880373 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:25:42.881765 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m23:25:42.882916 [info ] [MainThread]: 
[0m23:25:42.883906 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.64 seconds (0.64s).
[0m23:25:42.885621 [debug] [MainThread]: Command end result
[0m23:25:42.937190 [info ] [MainThread]: 
[0m23:25:42.938299 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:25:42.939252 [info ] [MainThread]: 
[0m23:25:42.940200 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m23:25:42.941818 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x741307767290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x741309ea1910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74130659be90>]}
[0m23:25:42.942887 [debug] [MainThread]: Flushing usage events
[0m23:31:28.129170 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b783a13080>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b783a5de20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b783a12ed0>]}


============================== 23:31:28.134251 | 71fd83cf-8532-4928-b0cb-5787e85ea7da ==============================
[0m23:31:28.134251 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:31:28.135592 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:31:28.418985 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '71fd83cf-8532-4928-b0cb-5787e85ea7da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b783dbbc80>]}
[0m23:31:28.531480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '71fd83cf-8532-4928-b0cb-5787e85ea7da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b7838d3830>]}
[0m23:31:28.532878 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:31:28.558568 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:31:28.778534 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:31:28.780439 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:31:28.782510 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m23:31:28.791844 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '71fd83cf-8532-4928-b0cb-5787e85ea7da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b783dd4920>]}
[0m23:31:28.845065 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '71fd83cf-8532-4928-b0cb-5787e85ea7da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b7829d60c0>]}
[0m23:31:28.846090 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m23:31:28.846978 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '71fd83cf-8532-4928-b0cb-5787e85ea7da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b782d92e40>]}
[0m23:31:28.849546 [info ] [MainThread]: 
[0m23:31:28.850910 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:31:28.853058 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m23:31:28.866876 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m23:31:28.867950 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m23:31:28.868907 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:31:28.879155 [debug] [ThreadPool]: SQL status: SELECT 7 in 0.0 seconds
[0m23:31:28.881378 [debug] [ThreadPool]: On list_nba: Close
[0m23:31:28.884610 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_raw)
[0m23:31:28.894185 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m23:31:28.895357 [debug] [ThreadPool]: On list_nba_raw: BEGIN
[0m23:31:28.896350 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:31:28.903434 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m23:31:28.904577 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m23:31:28.905559 [debug] [ThreadPool]: On list_nba_raw: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_raw"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'raw'
  
[0m23:31:28.911684 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m23:31:28.913854 [debug] [ThreadPool]: On list_nba_raw: ROLLBACK
[0m23:31:28.915149 [debug] [ThreadPool]: On list_nba_raw: Close
[0m23:31:28.922508 [debug] [MainThread]: Using postgres connection "master"
[0m23:31:28.923652 [debug] [MainThread]: On master: BEGIN
[0m23:31:28.925190 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:31:28.931856 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:31:28.932863 [debug] [MainThread]: Using postgres connection "master"
[0m23:31:28.933923 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m23:31:28.946192 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m23:31:28.948329 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '71fd83cf-8532-4928-b0cb-5787e85ea7da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b782d90920>]}
[0m23:31:28.949372 [debug] [MainThread]: On master: ROLLBACK
[0m23:31:28.950656 [debug] [MainThread]: Using postgres connection "master"
[0m23:31:28.951625 [debug] [MainThread]: On master: BEGIN
[0m23:31:28.953397 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:31:28.954337 [debug] [MainThread]: On master: COMMIT
[0m23:31:28.955389 [debug] [MainThread]: Using postgres connection "master"
[0m23:31:28.956242 [debug] [MainThread]: On master: COMMIT
[0m23:31:28.957871 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:31:28.958898 [debug] [MainThread]: On master: Close
[0m23:31:28.960285 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m23:31:28.961267 [info ] [MainThread]: 
[0m23:31:28.965348 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m23:31:28.966488 [info ] [Thread-1 (]: 1 of 3 START sql table model raw.home_vs_away .................................. [RUN]
[0m23:31:28.967872 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_raw, now model.spurs_dbt.home_vs_away)
[0m23:31:28.968814 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m23:31:28.978837 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m23:31:28.997882 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 23:31:28.969653 => 23:31:28.997461
[0m23:31:28.998826 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m23:31:29.052124 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m23:31:29.074036 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:31:29.075588 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m23:31:29.076551 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:31:29.083281 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:31:29.084507 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:31:29.085537 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."raw"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season, location
order by season, location
  );
  
[0m23:31:29.105819 [debug] [Thread-1 (]: SQL status: SELECT 20 in 0.0 seconds
[0m23:31:29.116437 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:31:29.117556 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m23:31:29.119092 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:31:29.124641 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:31:29.126459 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m23:31:29.128867 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:31:29.175963 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:31:29.177573 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:31:29.178629 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:31:29.184385 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:31:29.195807 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."home_vs_away__dbt_backup"
[0m23:31:29.204307 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:31:29.205710 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."raw"."home_vs_away__dbt_backup" cascade
[0m23:31:29.213383 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:31:29.216423 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 23:31:28.999643 => 23:31:29.216062
[0m23:31:29.217433 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m23:31:29.218979 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71fd83cf-8532-4928-b0cb-5787e85ea7da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b78215fef0>]}
[0m23:31:29.220680 [info ] [Thread-1 (]: 1 of 3 OK created sql table model raw.home_vs_away ............................. [[32mSELECT 20[0m in 0.25s]
[0m23:31:29.222325 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m23:31:29.223887 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m23:31:29.225740 [info ] [Thread-1 (]: 2 of 3 START sql table model raw.summary_by_season ............................. [RUN]
[0m23:31:29.227187 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m23:31:29.228294 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m23:31:29.232446 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m23:31:29.253858 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 23:31:29.229040 => 23:31:29.253448
[0m23:31:29.254821 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m23:31:29.261525 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m23:31:29.280634 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:31:29.281649 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m23:31:29.282574 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:31:29.289859 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:31:29.291846 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:31:29.293054 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."raw"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season
order by season
  );
  
[0m23:31:29.310811 [debug] [Thread-1 (]: SQL status: SELECT 10 in 0.0 seconds
[0m23:31:29.315148 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:31:29.316309 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m23:31:29.317826 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:31:29.321873 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:31:29.323218 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m23:31:29.325431 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:31:29.328505 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:31:29.329467 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:31:29.330419 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:31:29.338249 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:31:29.344143 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."summary_by_season__dbt_backup"
[0m23:31:29.345873 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:31:29.347189 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."raw"."summary_by_season__dbt_backup" cascade
[0m23:31:29.354446 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:31:29.358448 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 23:31:29.255618 => 23:31:29.358010
[0m23:31:29.359634 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m23:31:29.361967 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71fd83cf-8532-4928-b0cb-5787e85ea7da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b782186120>]}
[0m23:31:29.363603 [info ] [Thread-1 (]: 2 of 3 OK created sql table model raw.summary_by_season ........................ [[32mSELECT 10[0m in 0.13s]
[0m23:31:29.365196 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m23:31:29.366342 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m23:31:29.367860 [info ] [Thread-1 (]: 3 of 3 START sql table model raw.team_weaknesses ............................... [RUN]
[0m23:31:29.369442 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m23:31:29.370591 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m23:31:29.376422 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m23:31:29.396652 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 23:31:29.371471 => 23:31:29.396137
[0m23:31:29.397861 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m23:31:29.404498 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m23:31:29.425168 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:31:29.426748 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m23:31:29.428306 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:31:29.436810 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:31:29.438089 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:31:29.439857 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."raw"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    fg_pct::float as fg_pct,
    tov::int as turnovers
  from "nba"."raw"."spurs_games"
)

select
  season,
   round(avg(fg_pct)::numeric, 3) as avg_fg_pct,
  round(avg(turnovers), 2) as avg_turnovers
from base
group by season
having round(avg(fg_pct)::numeric, 3) < 0.45 or round(avg(turnovers), 2) > 14
order by season
  );
  
[0m23:31:29.459442 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m23:31:29.467162 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:31:29.468726 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m23:31:29.470606 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:31:29.478900 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:31:29.480400 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m23:31:29.482250 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:31:29.485667 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:31:29.486712 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:31:29.488016 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:31:29.495625 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:31:29.500208 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."team_weaknesses__dbt_backup"
[0m23:31:29.501871 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:31:29.503101 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."raw"."team_weaknesses__dbt_backup" cascade
[0m23:31:29.509439 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:31:29.512625 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 23:31:29.398753 => 23:31:29.512285
[0m23:31:29.513929 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m23:31:29.516577 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71fd83cf-8532-4928-b0cb-5787e85ea7da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b7821bbd10>]}
[0m23:31:29.519278 [info ] [Thread-1 (]: 3 of 3 OK created sql table model raw.team_weaknesses .......................... [[32mSELECT 2[0m in 0.15s]
[0m23:31:29.521462 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m23:31:29.526224 [debug] [MainThread]: Using postgres connection "master"
[0m23:31:29.527686 [debug] [MainThread]: On master: BEGIN
[0m23:31:29.529264 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:31:29.539183 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:31:29.541083 [debug] [MainThread]: On master: COMMIT
[0m23:31:29.542916 [debug] [MainThread]: Using postgres connection "master"
[0m23:31:29.545546 [debug] [MainThread]: On master: COMMIT
[0m23:31:29.547607 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:31:29.549531 [debug] [MainThread]: On master: Close
[0m23:31:29.552134 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:31:29.553900 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m23:31:29.555897 [info ] [MainThread]: 
[0m23:31:29.559245 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.70 seconds (0.70s).
[0m23:31:29.562594 [debug] [MainThread]: Command end result
[0m23:31:29.652286 [info ] [MainThread]: 
[0m23:31:29.653958 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:31:29.655617 [info ] [MainThread]: 
[0m23:31:29.657623 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m23:31:29.660927 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b783aae810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b78408ee40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b7821bbd10>]}
[0m23:31:29.664779 [debug] [MainThread]: Flushing usage events
[0m23:41:45.871101 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79a0e3092b70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79a0e31c7320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79a0e3512270>]}


============================== 23:41:45.876861 | e84ddb60-7771-4a60-8fda-9bbf2cd670f8 ==============================
[0m23:41:45.876861 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:41:45.878093 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:41:46.148314 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e84ddb60-7771-4a60-8fda-9bbf2cd670f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79a0e257a720>]}
[0m23:41:46.263716 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e84ddb60-7771-4a60-8fda-9bbf2cd670f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79a0e3190ef0>]}
[0m23:41:46.265690 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:41:46.294345 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:41:46.536900 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:41:46.538109 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:41:46.540507 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m23:41:46.547478 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e84ddb60-7771-4a60-8fda-9bbf2cd670f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79a0e257b020>]}
[0m23:41:46.596488 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e84ddb60-7771-4a60-8fda-9bbf2cd670f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79a0e1d694c0>]}
[0m23:41:46.597488 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m23:41:46.598431 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e84ddb60-7771-4a60-8fda-9bbf2cd670f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79a0e30beae0>]}
[0m23:41:46.601168 [info ] [MainThread]: 
[0m23:41:46.602636 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:41:46.605322 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m23:41:46.618906 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m23:41:46.620024 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m23:41:46.621253 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:41:46.630078 [debug] [ThreadPool]: SQL status: SELECT 7 in 0.0 seconds
[0m23:41:46.632302 [debug] [ThreadPool]: On list_nba: Close
[0m23:41:46.635536 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_raw)
[0m23:41:46.645272 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m23:41:46.646256 [debug] [ThreadPool]: On list_nba_raw: BEGIN
[0m23:41:46.647149 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:41:46.654075 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m23:41:46.655857 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m23:41:46.656925 [debug] [ThreadPool]: On list_nba_raw: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_raw"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'raw'
  
[0m23:41:46.661503 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m23:41:46.663716 [debug] [ThreadPool]: On list_nba_raw: ROLLBACK
[0m23:41:46.665084 [debug] [ThreadPool]: On list_nba_raw: Close
[0m23:41:46.673017 [debug] [MainThread]: Using postgres connection "master"
[0m23:41:46.674058 [debug] [MainThread]: On master: BEGIN
[0m23:41:46.674923 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:41:46.681961 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:41:46.683068 [debug] [MainThread]: Using postgres connection "master"
[0m23:41:46.684092 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m23:41:46.696037 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m23:41:46.698005 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e84ddb60-7771-4a60-8fda-9bbf2cd670f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79a0e190fbf0>]}
[0m23:41:46.699027 [debug] [MainThread]: On master: ROLLBACK
[0m23:41:46.700371 [debug] [MainThread]: Using postgres connection "master"
[0m23:41:46.701257 [debug] [MainThread]: On master: BEGIN
[0m23:41:46.703011 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:41:46.704124 [debug] [MainThread]: On master: COMMIT
[0m23:41:46.705579 [debug] [MainThread]: Using postgres connection "master"
[0m23:41:46.706710 [debug] [MainThread]: On master: COMMIT
[0m23:41:46.708080 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:41:46.709018 [debug] [MainThread]: On master: Close
[0m23:41:46.710467 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m23:41:46.711554 [info ] [MainThread]: 
[0m23:41:46.716627 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m23:41:46.717879 [info ] [Thread-1 (]: 1 of 3 START sql table model raw.home_vs_away .................................. [RUN]
[0m23:41:46.719320 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_raw, now model.spurs_dbt.home_vs_away)
[0m23:41:46.720323 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m23:41:46.730198 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m23:41:46.750446 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 23:41:46.721432 => 23:41:46.750040
[0m23:41:46.751372 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m23:41:46.800638 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m23:41:46.822122 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:41:46.823279 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m23:41:46.824275 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:41:46.831008 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:41:46.832218 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:41:46.833221 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."raw"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season, location
order by season, location
  );
  
[0m23:41:46.848204 [debug] [Thread-1 (]: SQL status: SELECT 20 in 0.0 seconds
[0m23:41:46.857042 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:41:46.858174 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m23:41:46.859887 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:41:46.864101 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:41:46.865150 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m23:41:46.866703 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:41:46.892546 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:41:46.893661 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:41:46.894593 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:41:46.907689 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:41:46.915898 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."home_vs_away__dbt_backup"
[0m23:41:46.924408 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:41:46.925648 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."raw"."home_vs_away__dbt_backup" cascade
[0m23:41:46.932513 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:41:46.935176 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 23:41:46.752036 => 23:41:46.934871
[0m23:41:46.936198 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m23:41:46.937967 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e84ddb60-7771-4a60-8fda-9bbf2cd670f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79a0e19c44a0>]}
[0m23:41:46.939631 [info ] [Thread-1 (]: 1 of 3 OK created sql table model raw.home_vs_away ............................. [[32mSELECT 20[0m in 0.22s]
[0m23:41:46.941150 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m23:41:46.942339 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m23:41:46.943400 [info ] [Thread-1 (]: 2 of 3 START sql table model raw.summary_by_season ............................. [RUN]
[0m23:41:46.944867 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m23:41:46.945824 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m23:41:46.950095 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m23:41:46.969850 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 23:41:46.946668 => 23:41:46.969440
[0m23:41:46.971695 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m23:41:46.977592 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m23:41:46.996323 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:41:46.997267 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m23:41:46.998133 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:41:47.006444 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:41:47.007512 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:41:47.008638 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."raw"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season
order by season
  );
  
[0m23:41:47.026557 [debug] [Thread-1 (]: SQL status: SELECT 10 in 0.0 seconds
[0m23:41:47.030982 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:41:47.032055 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m23:41:47.033556 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:41:47.038261 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:41:47.039421 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m23:41:47.040923 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:41:47.043919 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:41:47.045000 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:41:47.046002 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:41:47.053116 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:41:47.062479 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."summary_by_season__dbt_backup"
[0m23:41:47.065730 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:41:47.068103 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."raw"."summary_by_season__dbt_backup" cascade
[0m23:41:47.077861 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:41:47.083828 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 23:41:46.972984 => 23:41:47.082995
[0m23:41:47.085928 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m23:41:47.090725 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e84ddb60-7771-4a60-8fda-9bbf2cd670f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79a0e19c3e30>]}
[0m23:41:47.094603 [info ] [Thread-1 (]: 2 of 3 OK created sql table model raw.summary_by_season ........................ [[32mSELECT 10[0m in 0.15s]
[0m23:41:47.097790 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m23:41:47.100203 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m23:41:47.102549 [info ] [Thread-1 (]: 3 of 3 START sql table model raw.team_weaknesses ............................... [RUN]
[0m23:41:47.105243 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m23:41:47.106665 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m23:41:47.112313 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m23:41:47.133548 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 23:41:47.107665 => 23:41:47.133037
[0m23:41:47.134767 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m23:41:47.144086 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m23:41:47.164612 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:41:47.165818 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m23:41:47.166911 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:41:47.175436 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:41:47.176807 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:41:47.177995 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."raw"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    fg_pct::float as fg_pct,
    tov::int as turnovers
  from "nba"."raw"."spurs_games"
)

select
  season,
   round(avg(fg_pct)::numeric, 3) as avg_fg_pct,
  round(avg(turnovers), 2) as avg_turnovers
from base
group by season
having round(avg(fg_pct)::numeric, 3) < 0.45 or round(avg(turnovers), 2) > 14
order by season
  );
  
[0m23:41:47.195613 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m23:41:47.203406 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:41:47.204992 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m23:41:47.206945 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:41:47.211019 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:41:47.212254 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m23:41:47.213797 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:41:47.216868 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:41:47.217880 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:41:47.218809 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:41:47.224770 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:41:47.228598 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."team_weaknesses__dbt_backup"
[0m23:41:47.229943 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:41:47.230885 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."raw"."team_weaknesses__dbt_backup" cascade
[0m23:41:47.238447 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:41:47.241811 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 23:41:47.135668 => 23:41:47.241491
[0m23:41:47.242911 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m23:41:47.244967 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e84ddb60-7771-4a60-8fda-9bbf2cd670f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79a0e15656d0>]}
[0m23:41:47.246617 [info ] [Thread-1 (]: 3 of 3 OK created sql table model raw.team_weaknesses .......................... [[32mSELECT 2[0m in 0.14s]
[0m23:41:47.248531 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m23:41:47.251835 [debug] [MainThread]: Using postgres connection "master"
[0m23:41:47.253103 [debug] [MainThread]: On master: BEGIN
[0m23:41:47.254062 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:41:47.261946 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:41:47.263076 [debug] [MainThread]: On master: COMMIT
[0m23:41:47.264142 [debug] [MainThread]: Using postgres connection "master"
[0m23:41:47.265145 [debug] [MainThread]: On master: COMMIT
[0m23:41:47.266467 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:41:47.267447 [debug] [MainThread]: On master: Close
[0m23:41:47.268979 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:41:47.269909 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m23:41:47.271065 [info ] [MainThread]: 
[0m23:41:47.272554 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.67 seconds (0.67s).
[0m23:41:47.274322 [debug] [MainThread]: Command end result
[0m23:41:47.331192 [info ] [MainThread]: 
[0m23:41:47.332299 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:41:47.333240 [info ] [MainThread]: 
[0m23:41:47.334187 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m23:41:47.335855 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79a0e343d7c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79a0e254f830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79a0e1523da0>]}
[0m23:41:47.336956 [debug] [MainThread]: Flushing usage events
[0m21:16:43.210446 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76467fb41a30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76467fc3d070>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76467fb419a0>]}


============================== 21:16:43.216391 | 5ab42e3e-4977-40cd-bb30-9ecb80e8ddee ==============================
[0m21:16:43.216391 [info ] [MainThread]: Running with dbt=1.7.9
[0m21:16:43.568034 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m21:16:44.134386 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5ab42e3e-4977-40cd-bb30-9ecb80e8ddee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76467fc08d70>]}
[0m21:16:44.303318 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5ab42e3e-4977-40cd-bb30-9ecb80e8ddee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76467fa961e0>]}
[0m21:16:44.304868 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m21:16:44.334975 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m21:16:44.986173 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:16:44.987896 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:16:44.990627 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m21:16:45.006203 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5ab42e3e-4977-40cd-bb30-9ecb80e8ddee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76467f574d10>]}
[0m21:16:45.175531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5ab42e3e-4977-40cd-bb30-9ecb80e8ddee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76467f1c1b20>]}
[0m21:16:45.177647 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m21:16:45.179758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5ab42e3e-4977-40cd-bb30-9ecb80e8ddee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76467ed07fe0>]}
[0m21:16:45.187770 [info ] [MainThread]: 
[0m21:16:45.191093 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:16:45.195700 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m21:16:45.224954 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m21:16:45.226464 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m21:16:45.228726 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:16:45.268469 [debug] [ThreadPool]: SQL status: SELECT 7 in 0.0 seconds
[0m21:16:45.277322 [debug] [ThreadPool]: On list_nba: Close
[0m21:16:45.288570 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_raw)
[0m21:16:45.309433 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m21:16:45.314985 [debug] [ThreadPool]: On list_nba_raw: BEGIN
[0m21:16:45.324010 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:16:45.336156 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:16:45.347961 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m21:16:45.352423 [debug] [ThreadPool]: On list_nba_raw: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_raw"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'raw'
  
[0m21:16:45.388525 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m21:16:45.393453 [debug] [ThreadPool]: On list_nba_raw: ROLLBACK
[0m21:16:45.395417 [debug] [ThreadPool]: On list_nba_raw: Close
[0m21:16:45.413644 [debug] [MainThread]: Using postgres connection "master"
[0m21:16:45.415234 [debug] [MainThread]: On master: BEGIN
[0m21:16:45.418202 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:16:45.427540 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:16:45.428662 [debug] [MainThread]: Using postgres connection "master"
[0m21:16:45.429785 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:16:45.453147 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m21:16:45.456546 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5ab42e3e-4977-40cd-bb30-9ecb80e8ddee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76467fa676b0>]}
[0m21:16:45.458023 [debug] [MainThread]: On master: ROLLBACK
[0m21:16:45.459548 [debug] [MainThread]: Using postgres connection "master"
[0m21:16:45.460594 [debug] [MainThread]: On master: BEGIN
[0m21:16:45.462449 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:16:45.463481 [debug] [MainThread]: On master: COMMIT
[0m21:16:45.464443 [debug] [MainThread]: Using postgres connection "master"
[0m21:16:45.465701 [debug] [MainThread]: On master: COMMIT
[0m21:16:45.467799 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:16:45.469247 [debug] [MainThread]: On master: Close
[0m21:16:45.471948 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:16:45.474712 [info ] [MainThread]: 
[0m21:16:45.480490 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m21:16:45.482248 [info ] [Thread-1 (]: 1 of 3 START sql table model raw.home_vs_away .................................. [RUN]
[0m21:16:45.485293 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_raw, now model.spurs_dbt.home_vs_away)
[0m21:16:45.487253 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m21:16:45.505753 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m21:16:45.523933 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 21:16:45.488569 => 21:16:45.523426
[0m21:16:45.525036 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m21:16:45.593723 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m21:16:45.614192 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:16:45.615655 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m21:16:45.617632 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:16:45.626829 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:16:45.628090 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:16:45.629283 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."raw"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season, location
order by season, location
  );
  
[0m21:16:45.672471 [debug] [Thread-1 (]: SQL status: SELECT 20 in 0.0 seconds
[0m21:16:45.682889 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:16:45.684292 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m21:16:45.686145 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:16:45.691273 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:16:45.692489 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m21:16:45.694371 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:16:45.726601 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:16:45.728803 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:16:45.730435 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:16:45.736975 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:16:45.750058 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."home_vs_away__dbt_backup"
[0m21:16:45.763365 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:16:45.764792 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."raw"."home_vs_away__dbt_backup" cascade
[0m21:16:45.777234 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:16:45.780475 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 21:16:45.525790 => 21:16:45.780086
[0m21:16:45.781824 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m21:16:45.784267 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ab42e3e-4977-40cd-bb30-9ecb80e8ddee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76467e9301a0>]}
[0m21:16:45.786582 [info ] [Thread-1 (]: 1 of 3 OK created sql table model raw.home_vs_away ............................. [[32mSELECT 20[0m in 0.30s]
[0m21:16:45.789229 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m21:16:45.791078 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m21:16:45.792426 [info ] [Thread-1 (]: 2 of 3 START sql table model raw.summary_by_season ............................. [RUN]
[0m21:16:45.794137 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m21:16:45.795458 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m21:16:45.801768 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m21:16:45.823286 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 21:16:45.796337 => 21:16:45.822781
[0m21:16:45.824668 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m21:16:45.831304 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m21:16:45.851703 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:16:45.853535 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m21:16:45.855160 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:16:45.863563 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:16:45.864807 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:16:45.866095 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."raw"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season
order by season
  );
  
[0m21:16:45.882982 [debug] [Thread-1 (]: SQL status: SELECT 10 in 0.0 seconds
[0m21:16:45.888827 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:16:45.890055 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m21:16:45.891837 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:16:45.897020 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:16:45.898321 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m21:16:45.900259 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:16:45.904009 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:16:45.905385 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:16:45.906538 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:16:45.912324 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:16:45.917543 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."summary_by_season__dbt_backup"
[0m21:16:45.919877 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:16:45.921644 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."raw"."summary_by_season__dbt_backup" cascade
[0m21:16:45.930475 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:16:45.934617 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 21:16:45.825504 => 21:16:45.933902
[0m21:16:45.936751 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m21:16:45.939650 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ab42e3e-4977-40cd-bb30-9ecb80e8ddee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76467e91ffe0>]}
[0m21:16:45.942549 [info ] [Thread-1 (]: 2 of 3 OK created sql table model raw.summary_by_season ........................ [[32mSELECT 10[0m in 0.15s]
[0m21:16:45.944338 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m21:16:45.946137 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m21:16:45.947907 [info ] [Thread-1 (]: 3 of 3 START sql table model raw.team_weaknesses ............................... [RUN]
[0m21:16:45.950098 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m21:16:45.951900 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m21:16:45.959521 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m21:16:45.981894 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 21:16:45.953526 => 21:16:45.981103
[0m21:16:45.983364 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m21:16:45.997679 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m21:16:46.019959 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:16:46.022141 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m21:16:46.023592 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:16:46.031872 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:16:46.033188 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:16:46.034641 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."raw"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    fg_pct::float as fg_pct,
    tov::int as turnovers
  from "nba"."raw"."spurs_games"
)

select
  season,
   round(avg(fg_pct)::numeric, 3) as avg_fg_pct,
  round(avg(turnovers), 2) as avg_turnovers
from base
group by season
having round(avg(fg_pct)::numeric, 3) < 0.45 or round(avg(turnovers), 2) > 14
order by season
  );
  
[0m21:16:46.054702 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m21:16:46.062033 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:16:46.063308 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m21:16:46.065167 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:16:46.071346 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:16:46.073014 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m21:16:46.075121 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:16:46.078678 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:16:46.079861 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:16:46.080884 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:16:46.089838 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:16:46.094823 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."team_weaknesses__dbt_backup"
[0m21:16:46.099044 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:16:46.102779 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."raw"."team_weaknesses__dbt_backup" cascade
[0m21:16:46.115210 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:16:46.129638 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 21:16:45.984987 => 21:16:46.127762
[0m21:16:46.137747 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m21:16:46.147084 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ab42e3e-4977-40cd-bb30-9ecb80e8ddee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76467e9bf0e0>]}
[0m21:16:46.154378 [info ] [Thread-1 (]: 3 of 3 OK created sql table model raw.team_weaknesses .......................... [[32mSELECT 2[0m in 0.20s]
[0m21:16:46.159542 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m21:16:46.166359 [debug] [MainThread]: Using postgres connection "master"
[0m21:16:46.169023 [debug] [MainThread]: On master: BEGIN
[0m21:16:46.171820 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:16:46.185186 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:16:46.187600 [debug] [MainThread]: On master: COMMIT
[0m21:16:46.189757 [debug] [MainThread]: Using postgres connection "master"
[0m21:16:46.191707 [debug] [MainThread]: On master: COMMIT
[0m21:16:46.194509 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:16:46.196327 [debug] [MainThread]: On master: Close
[0m21:16:46.198881 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:16:46.201669 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m21:16:46.204154 [info ] [MainThread]: 
[0m21:16:46.206734 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 1.01 seconds (1.01s).
[0m21:16:46.210576 [debug] [MainThread]: Command end result
[0m21:16:46.315453 [info ] [MainThread]: 
[0m21:16:46.318136 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:16:46.320065 [info ] [MainThread]: 
[0m21:16:46.321764 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m21:16:46.324565 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x764684452ed0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76467e9afc20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76467e988470>]}
[0m21:16:46.326274 [debug] [MainThread]: Flushing usage events
[0m21:21:53.503761 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7931f05259d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7931f14a3a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7931f1522270>]}


============================== 21:21:53.511708 | 1a495db1-56b5-4c1b-8dd6-f901208071fa ==============================
[0m21:21:53.511708 [info ] [MainThread]: Running with dbt=1.7.9
[0m21:21:53.513178 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m21:21:53.879034 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1a495db1-56b5-4c1b-8dd6-f901208071fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7931efd790d0>]}
[0m21:21:54.204687 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1a495db1-56b5-4c1b-8dd6-f901208071fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7931f182ade0>]}
[0m21:21:54.207656 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m21:21:54.261077 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m21:21:54.623679 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:21:54.625022 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:21:54.627055 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m21:21:54.640636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1a495db1-56b5-4c1b-8dd6-f901208071fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7931efdc2270>]}
[0m21:21:54.700872 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1a495db1-56b5-4c1b-8dd6-f901208071fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7931ef561700>]}
[0m21:21:54.703034 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m21:21:54.705538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1a495db1-56b5-4c1b-8dd6-f901208071fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7931f0557080>]}
[0m21:21:54.709768 [info ] [MainThread]: 
[0m21:21:54.711861 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:21:54.715373 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m21:21:54.746081 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m21:21:54.751071 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m21:21:54.753717 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:21:54.768066 [debug] [ThreadPool]: SQL status: SELECT 7 in 0.0 seconds
[0m21:21:54.771738 [debug] [ThreadPool]: On list_nba: Close
[0m21:21:54.777671 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_raw)
[0m21:21:54.793450 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m21:21:54.795420 [debug] [ThreadPool]: On list_nba_raw: BEGIN
[0m21:21:54.797372 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:21:54.809068 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:21:54.810792 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m21:21:54.812561 [debug] [ThreadPool]: On list_nba_raw: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_raw"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'raw'
  
[0m21:21:54.823953 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m21:21:54.830722 [debug] [ThreadPool]: On list_nba_raw: ROLLBACK
[0m21:21:54.834547 [debug] [ThreadPool]: On list_nba_raw: Close
[0m21:21:54.862592 [debug] [MainThread]: Using postgres connection "master"
[0m21:21:54.866197 [debug] [MainThread]: On master: BEGIN
[0m21:21:54.879891 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:21:54.900551 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:21:54.913032 [debug] [MainThread]: Using postgres connection "master"
[0m21:21:54.917520 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:21:54.965599 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m21:21:54.970733 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1a495db1-56b5-4c1b-8dd6-f901208071fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7931efd4f830>]}
[0m21:21:54.975518 [debug] [MainThread]: On master: ROLLBACK
[0m21:21:54.978742 [debug] [MainThread]: Using postgres connection "master"
[0m21:21:54.983301 [debug] [MainThread]: On master: BEGIN
[0m21:21:54.988863 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:21:54.997832 [debug] [MainThread]: On master: COMMIT
[0m21:21:55.000853 [debug] [MainThread]: Using postgres connection "master"
[0m21:21:55.008982 [debug] [MainThread]: On master: COMMIT
[0m21:21:55.011876 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:21:55.015114 [debug] [MainThread]: On master: Close
[0m21:21:55.018542 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:21:55.020512 [info ] [MainThread]: 
[0m21:21:55.045716 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m21:21:55.067785 [info ] [Thread-1 (]: 1 of 3 START sql table model raw.home_vs_away .................................. [RUN]
[0m21:21:55.086933 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_raw, now model.spurs_dbt.home_vs_away)
[0m21:21:55.096328 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m21:21:55.134740 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m21:21:55.173201 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 21:21:55.098729 => 21:21:55.172363
[0m21:21:55.175887 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m21:21:55.343257 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m21:21:55.408889 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:21:55.411336 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m21:21:55.413097 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:21:55.427915 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:21:55.430091 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:21:55.431998 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."raw"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season, location
order by season, location
  );
  
[0m21:21:55.476904 [debug] [Thread-1 (]: SQL status: SELECT 20 in 0.0 seconds
[0m21:21:55.512980 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:21:55.515810 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m21:21:55.519765 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:21:55.545062 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:21:55.549836 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m21:21:55.554825 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:21:55.645561 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:21:55.648189 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:21:55.649438 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:21:55.656784 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:21:55.668801 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."home_vs_away__dbt_backup"
[0m21:21:55.683544 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:21:55.685083 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."raw"."home_vs_away__dbt_backup" cascade
[0m21:21:55.693477 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:21:55.697654 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 21:21:55.177141 => 21:21:55.697047
[0m21:21:55.699181 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m21:21:55.701339 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1a495db1-56b5-4c1b-8dd6-f901208071fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7931ef1c4650>]}
[0m21:21:55.702958 [info ] [Thread-1 (]: 1 of 3 OK created sql table model raw.home_vs_away ............................. [[32mSELECT 20[0m in 0.62s]
[0m21:21:55.704901 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m21:21:55.706379 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m21:21:55.708064 [info ] [Thread-1 (]: 2 of 3 START sql table model raw.summary_by_season ............................. [RUN]
[0m21:21:55.710113 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m21:21:55.711445 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m21:21:55.718053 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m21:21:55.737632 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 21:21:55.712508 => 21:21:55.737003
[0m21:21:55.738776 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m21:21:55.745915 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m21:21:55.772104 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:21:55.773817 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m21:21:55.775438 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:21:55.785275 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:21:55.787029 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:21:55.789441 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."raw"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season
order by season
  );
  
[0m21:21:55.813594 [debug] [Thread-1 (]: SQL status: SELECT 10 in 0.0 seconds
[0m21:21:55.819535 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:21:55.821144 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m21:21:55.823138 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:21:55.829887 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:21:55.831220 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m21:21:55.834136 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:21:55.839510 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:21:55.841058 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:21:55.842522 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:21:55.849663 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:21:55.855043 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."summary_by_season__dbt_backup"
[0m21:21:55.857759 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:21:55.859354 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."raw"."summary_by_season__dbt_backup" cascade
[0m21:21:55.868012 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:21:55.872121 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 21:21:55.739763 => 21:21:55.871492
[0m21:21:55.873748 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m21:21:55.876654 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1a495db1-56b5-4c1b-8dd6-f901208071fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7931eed121e0>]}
[0m21:21:55.878687 [info ] [Thread-1 (]: 2 of 3 OK created sql table model raw.summary_by_season ........................ [[32mSELECT 10[0m in 0.17s]
[0m21:21:55.881536 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m21:21:55.883663 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m21:21:55.886050 [info ] [Thread-1 (]: 3 of 3 START sql table model raw.team_weaknesses ............................... [RUN]
[0m21:21:55.889075 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m21:21:55.890898 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m21:21:55.899612 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m21:21:55.920448 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 21:21:55.891966 => 21:21:55.919623
[0m21:21:55.922192 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m21:21:55.931709 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m21:21:55.953078 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:21:55.955163 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m21:21:55.957167 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:21:55.968352 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:21:55.970675 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:21:55.972909 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."raw"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    fg_pct::float as fg_pct,
    tov::int as turnovers
  from "nba"."raw"."spurs_games"
)

select
  season,
   round(avg(fg_pct)::numeric, 3) as avg_fg_pct,
  round(avg(turnovers), 2) as avg_turnovers
from base
group by season
having round(avg(fg_pct)::numeric, 3) < 0.45 or round(avg(turnovers), 2) > 14
order by season
  );
  
[0m21:21:55.999645 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m21:21:56.015342 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:21:56.017683 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m21:21:56.020384 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:21:56.031061 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:21:56.033729 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m21:21:56.036353 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:21:56.044457 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:21:56.049702 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:21:56.054568 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:21:56.077745 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:21:56.086378 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."team_weaknesses__dbt_backup"
[0m21:21:56.092637 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:21:56.094226 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."raw"."team_weaknesses__dbt_backup" cascade
[0m21:21:56.101481 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:21:56.104464 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 21:21:55.923271 => 21:21:56.104045
[0m21:21:56.106108 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m21:21:56.108904 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1a495db1-56b5-4c1b-8dd6-f901208071fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7931eed5f170>]}
[0m21:21:56.110477 [info ] [Thread-1 (]: 3 of 3 OK created sql table model raw.team_weaknesses .......................... [[32mSELECT 2[0m in 0.22s]
[0m21:21:56.112216 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m21:21:56.116153 [debug] [MainThread]: Using postgres connection "master"
[0m21:21:56.117369 [debug] [MainThread]: On master: BEGIN
[0m21:21:56.118509 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:21:56.129857 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:21:56.131699 [debug] [MainThread]: On master: COMMIT
[0m21:21:56.133103 [debug] [MainThread]: Using postgres connection "master"
[0m21:21:56.134613 [debug] [MainThread]: On master: COMMIT
[0m21:21:56.136757 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:21:56.138614 [debug] [MainThread]: On master: Close
[0m21:21:56.141763 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:21:56.144101 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m21:21:56.151250 [info ] [MainThread]: 
[0m21:21:56.153337 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 1.44 seconds (1.44s).
[0m21:21:56.157352 [debug] [MainThread]: Command end result
[0m21:21:56.246334 [info ] [MainThread]: 
[0m21:21:56.247681 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:21:56.248853 [info ] [MainThread]: 
[0m21:21:56.250540 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m21:21:56.252822 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7931f08ab950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7931f4e62f60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7931eed5df70>]}
[0m21:21:56.254056 [debug] [MainThread]: Flushing usage events
[0m21:30:37.920573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788f7e1f5be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788f7de1eae0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788f7de1d1c0>]}


============================== 21:30:37.926431 | 683164af-e44b-4cdf-b1cc-4502c45b3f47 ==============================
[0m21:30:37.926431 [info ] [MainThread]: Running with dbt=1.7.9
[0m21:30:37.928012 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:30:38.284397 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '683164af-e44b-4cdf-b1cc-4502c45b3f47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788f7d502720>]}
[0m21:30:38.462302 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '683164af-e44b-4cdf-b1cc-4502c45b3f47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788f7d907b00>]}
[0m21:30:38.464323 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m21:30:38.492899 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m21:30:38.808568 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:30:38.809982 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:30:38.811349 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m21:30:38.819641 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '683164af-e44b-4cdf-b1cc-4502c45b3f47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788f7d96c560>]}
[0m21:30:38.882559 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '683164af-e44b-4cdf-b1cc-4502c45b3f47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788f7d1752b0>]}
[0m21:30:38.883902 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m21:30:38.885057 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '683164af-e44b-4cdf-b1cc-4502c45b3f47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788f7d8df590>]}
[0m21:30:38.888348 [info ] [MainThread]: 
[0m21:30:38.890196 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:30:38.892799 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m21:30:38.909213 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m21:30:38.910585 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m21:30:38.911715 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:30:38.939281 [debug] [ThreadPool]: SQL status: SELECT 7 in 0.0 seconds
[0m21:30:38.946447 [debug] [ThreadPool]: On list_nba: Close
[0m21:30:38.958776 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_raw)
[0m21:30:38.986177 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m21:30:38.989109 [debug] [ThreadPool]: On list_nba_raw: BEGIN
[0m21:30:38.992159 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:30:39.013788 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:30:39.017573 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m21:30:39.021328 [debug] [ThreadPool]: On list_nba_raw: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_raw"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'raw'
  
[0m21:30:39.047875 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m21:30:39.055256 [debug] [ThreadPool]: On list_nba_raw: ROLLBACK
[0m21:30:39.059144 [debug] [ThreadPool]: On list_nba_raw: Close
[0m21:30:39.083694 [debug] [MainThread]: Using postgres connection "master"
[0m21:30:39.086713 [debug] [MainThread]: On master: BEGIN
[0m21:30:39.089642 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:30:39.110502 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:30:39.113448 [debug] [MainThread]: Using postgres connection "master"
[0m21:30:39.116895 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:30:39.168131 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m21:30:39.175054 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '683164af-e44b-4cdf-b1cc-4502c45b3f47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788f7d167c80>]}
[0m21:30:39.178459 [debug] [MainThread]: On master: ROLLBACK
[0m21:30:39.182294 [debug] [MainThread]: Using postgres connection "master"
[0m21:30:39.185644 [debug] [MainThread]: On master: BEGIN
[0m21:30:39.190668 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:30:39.193840 [debug] [MainThread]: On master: COMMIT
[0m21:30:39.196595 [debug] [MainThread]: Using postgres connection "master"
[0m21:30:39.199798 [debug] [MainThread]: On master: COMMIT
[0m21:30:39.203868 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:30:39.206791 [debug] [MainThread]: On master: Close
[0m21:30:39.211617 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:30:39.214649 [info ] [MainThread]: 
[0m21:30:39.228579 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m21:30:39.232529 [info ] [Thread-1 (]: 1 of 3 START sql table model raw.home_vs_away .................................. [RUN]
[0m21:30:39.237318 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_raw, now model.spurs_dbt.home_vs_away)
[0m21:30:39.240747 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m21:30:39.275115 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m21:30:39.310607 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 21:30:39.243175 => 21:30:39.309803
[0m21:30:39.312632 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m21:30:39.383166 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m21:30:39.404718 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:30:39.405933 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m21:30:39.406997 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:30:39.414430 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:30:39.415824 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:30:39.416962 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."raw"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season, location
order by season, location
  );
  
[0m21:30:39.442743 [debug] [Thread-1 (]: SQL status: SELECT 20 in 0.0 seconds
[0m21:30:39.452580 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:30:39.454140 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m21:30:39.456010 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:30:39.460983 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:30:39.462365 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m21:30:39.464083 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:30:39.516055 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:30:39.519401 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:30:39.522839 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:30:39.536606 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:30:39.567308 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."home_vs_away__dbt_backup"
[0m21:30:39.599455 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:30:39.604151 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."raw"."home_vs_away__dbt_backup" cascade
[0m21:30:39.616469 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:30:39.621968 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 21:30:39.314306 => 21:30:39.621289
[0m21:30:39.624000 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m21:30:39.627286 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '683164af-e44b-4cdf-b1cc-4502c45b3f47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788f7cdcbda0>]}
[0m21:30:39.632366 [info ] [Thread-1 (]: 1 of 3 OK created sql table model raw.home_vs_away ............................. [[32mSELECT 20[0m in 0.39s]
[0m21:30:39.635151 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m21:30:39.637650 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m21:30:39.639880 [info ] [Thread-1 (]: 2 of 3 START sql table model raw.summary_by_season ............................. [RUN]
[0m21:30:39.642596 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m21:30:39.644783 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m21:30:39.653825 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m21:30:39.687319 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 21:30:39.646179 => 21:30:39.686042
[0m21:30:39.689613 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m21:30:39.700878 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m21:30:39.734225 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:30:39.736249 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m21:30:39.738150 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:30:39.750663 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:30:39.752804 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:30:39.754832 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."raw"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season
order by season
  );
  
[0m21:30:39.778839 [debug] [Thread-1 (]: SQL status: SELECT 10 in 0.0 seconds
[0m21:30:39.787970 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:30:39.789855 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m21:30:39.792714 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:30:39.801610 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:30:39.803669 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m21:30:39.806458 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:30:39.812387 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:30:39.814559 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:30:39.816222 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:30:39.829263 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:30:39.836993 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."summary_by_season__dbt_backup"
[0m21:30:39.839872 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:30:39.841651 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."raw"."summary_by_season__dbt_backup" cascade
[0m21:30:39.850895 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:30:39.855826 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 21:30:39.691079 => 21:30:39.855189
[0m21:30:39.857611 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m21:30:39.860552 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '683164af-e44b-4cdf-b1cc-4502c45b3f47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788f7cdfb9b0>]}
[0m21:30:39.864754 [info ] [Thread-1 (]: 2 of 3 OK created sql table model raw.summary_by_season ........................ [[32mSELECT 10[0m in 0.22s]
[0m21:30:39.867202 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m21:30:39.869559 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m21:30:39.871663 [info ] [Thread-1 (]: 3 of 3 START sql table model raw.team_weaknesses ............................... [RUN]
[0m21:30:39.874226 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m21:30:39.876563 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m21:30:39.885288 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m21:30:39.917175 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 21:30:39.878169 => 21:30:39.916451
[0m21:30:39.919040 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m21:30:39.930602 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m21:30:39.962957 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:30:39.965046 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m21:30:39.967703 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:30:39.980032 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:30:39.981989 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:30:39.984141 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."raw"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    fg_pct::float as fg_pct,
    tov::int as turnovers
  from "nba"."raw"."spurs_games"
)

select
  season,
   round(avg(fg_pct)::numeric, 3) as avg_fg_pct,
  round(avg(turnovers), 2) as avg_turnovers
from base
group by season
having round(avg(fg_pct)::numeric, 3) < 0.45 or round(avg(turnovers), 2) > 14
order by season
  );
  
[0m21:30:40.011655 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m21:30:40.024934 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:30:40.026892 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m21:30:40.029830 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:30:40.038858 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:30:40.040942 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m21:30:40.044021 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:30:40.050192 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:30:40.052461 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:30:40.054450 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:30:40.063290 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:30:40.073075 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."team_weaknesses__dbt_backup"
[0m21:30:40.076059 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:30:40.078073 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."raw"."team_weaknesses__dbt_backup" cascade
[0m21:30:40.089509 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:30:40.094459 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 21:30:39.920626 => 21:30:40.093880
[0m21:30:40.096383 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m21:30:40.100076 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '683164af-e44b-4cdf-b1cc-4502c45b3f47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788f7c973e90>]}
[0m21:30:40.103590 [info ] [Thread-1 (]: 3 of 3 OK created sql table model raw.team_weaknesses .......................... [[32mSELECT 2[0m in 0.23s]
[0m21:30:40.106974 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m21:30:40.113532 [debug] [MainThread]: Using postgres connection "master"
[0m21:30:40.115361 [debug] [MainThread]: On master: BEGIN
[0m21:30:40.117387 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:30:40.130548 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:30:40.132809 [debug] [MainThread]: On master: COMMIT
[0m21:30:40.134535 [debug] [MainThread]: Using postgres connection "master"
[0m21:30:40.136606 [debug] [MainThread]: On master: COMMIT
[0m21:30:40.139176 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:30:40.141208 [debug] [MainThread]: On master: Close
[0m21:30:40.144117 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:30:40.146172 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m21:30:40.147992 [info ] [MainThread]: 
[0m21:30:40.149943 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 1.26 seconds (1.26s).
[0m21:30:40.153824 [debug] [MainThread]: Command end result
[0m21:30:40.260748 [info ] [MainThread]: 
[0m21:30:40.263930 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:30:40.266447 [info ] [MainThread]: 
[0m21:30:40.269091 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m21:30:40.273051 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.452289, "process_user_time": 4.833524, "process_kernel_time": 0.618659, "process_mem_max_rss": "200932", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:30:40.275203 [debug] [MainThread]: Command `dbt run` succeeded at 21:30:40.274771 after 2.45 seconds
[0m21:30:40.277795 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788f7def6300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788f7c941f10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788f7c941e80>]}
[0m21:30:40.281084 [debug] [MainThread]: Flushing usage events
[0m14:20:52.488947 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d540b573ec0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d540b572a50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d540b572630>]}


============================== 14:20:52.493489 | 2ab8d449-aeb3-403b-8c41-d0115927ef22 ==============================
[0m14:20:52.493489 [info ] [MainThread]: Running with dbt=1.7.9
[0m14:20:52.494655 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m14:20:52.987636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2ab8d449-aeb3-403b-8c41-d0115927ef22', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d540af3d550>]}
[0m14:20:53.159704 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2ab8d449-aeb3-403b-8c41-d0115927ef22', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d540c86dca0>]}
[0m14:20:53.546776 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m14:20:53.576863 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m14:20:54.405426 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:20:54.407139 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:20:54.408559 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m14:20:54.424437 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2ab8d449-aeb3-403b-8c41-d0115927ef22', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d540ab64b00>]}
[0m14:20:54.505213 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2ab8d449-aeb3-403b-8c41-d0115927ef22', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d540a709190>]}
[0m14:20:54.507152 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m14:20:54.509011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2ab8d449-aeb3-403b-8c41-d0115927ef22', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d540b446360>]}
[0m14:20:54.514886 [info ] [MainThread]: 
[0m14:20:54.519542 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:20:54.523544 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m14:20:54.557004 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m14:20:54.558176 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m14:20:54.559449 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:20:54.586090 [debug] [ThreadPool]: SQL status: SELECT 7 in 0.0 seconds
[0m14:20:54.589261 [debug] [ThreadPool]: On list_nba: Close
[0m14:20:54.594397 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_raw)
[0m14:20:54.605563 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m14:20:54.607240 [debug] [ThreadPool]: On list_nba_raw: BEGIN
[0m14:20:54.608366 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:20:54.616501 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:20:54.618479 [debug] [ThreadPool]: Using postgres connection "list_nba_raw"
[0m14:20:54.620010 [debug] [ThreadPool]: On list_nba_raw: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_raw"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'raw'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'raw'
  
[0m14:20:54.641565 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m14:20:54.645425 [debug] [ThreadPool]: On list_nba_raw: ROLLBACK
[0m14:20:54.646927 [debug] [ThreadPool]: On list_nba_raw: Close
[0m14:20:54.660860 [debug] [MainThread]: Using postgres connection "master"
[0m14:20:54.662044 [debug] [MainThread]: On master: BEGIN
[0m14:20:54.663491 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:20:54.674533 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:20:54.675550 [debug] [MainThread]: Using postgres connection "master"
[0m14:20:54.676634 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:20:54.718164 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:20:54.720588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2ab8d449-aeb3-403b-8c41-d0115927ef22', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d540a70b590>]}
[0m14:20:54.722131 [debug] [MainThread]: On master: ROLLBACK
[0m14:20:54.723593 [debug] [MainThread]: Using postgres connection "master"
[0m14:20:54.724531 [debug] [MainThread]: On master: BEGIN
[0m14:20:54.726317 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:20:54.727499 [debug] [MainThread]: On master: COMMIT
[0m14:20:54.728465 [debug] [MainThread]: Using postgres connection "master"
[0m14:20:54.729344 [debug] [MainThread]: On master: COMMIT
[0m14:20:54.730515 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m14:20:54.733818 [debug] [MainThread]: On master: Close
[0m14:20:54.735803 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m14:20:54.738763 [info ] [MainThread]: 
[0m14:20:54.745214 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m14:20:54.746896 [info ] [Thread-1 (]: 1 of 3 START sql table model raw.home_vs_away .................................. [RUN]
[0m14:20:54.751860 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_raw, now model.spurs_dbt.home_vs_away)
[0m14:20:54.754407 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m14:20:54.771806 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m14:20:54.791622 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 14:20:54.755922 => 14:20:54.791097
[0m14:20:54.792744 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m14:20:54.878305 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m14:20:54.905566 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:20:54.907315 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m14:20:54.908523 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:20:54.917852 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m14:20:54.919552 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:20:54.920774 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."raw"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season, location
order by season, location
  );
  
[0m14:20:55.030267 [debug] [Thread-1 (]: SQL status: SELECT 20 in 0.0 seconds
[0m14:20:55.045587 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:20:55.046795 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m14:20:55.056303 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:20:55.062988 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:20:55.065910 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."raw"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m14:20:55.068964 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:20:55.108021 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m14:20:55.110923 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:20:55.112207 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m14:20:55.122774 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m14:20:55.139634 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."home_vs_away__dbt_backup"
[0m14:20:55.152357 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:20:55.153363 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."raw"."home_vs_away__dbt_backup" cascade
[0m14:20:55.171449 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m14:20:55.174819 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 14:20:54.793503 => 14:20:55.174443
[0m14:20:55.175819 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m14:20:55.177531 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2ab8d449-aeb3-403b-8c41-d0115927ef22', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d540a3292e0>]}
[0m14:20:55.179253 [info ] [Thread-1 (]: 1 of 3 OK created sql table model raw.home_vs_away ............................. [[32mSELECT 20[0m in 0.43s]
[0m14:20:55.276811 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m14:20:55.278487 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m14:20:55.280460 [info ] [Thread-1 (]: 2 of 3 START sql table model raw.summary_by_season ............................. [RUN]
[0m14:20:55.283727 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m14:20:55.285315 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m14:20:55.291153 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m14:20:55.311296 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 14:20:55.286415 => 14:20:55.310849
[0m14:20:55.312448 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m14:20:55.323932 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m14:20:55.350334 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:20:55.351997 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m14:20:55.353185 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:20:55.361384 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m14:20:55.362541 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:20:55.365534 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."raw"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    wl,
    pts::int as pts
  from "nba"."raw"."spurs_games"
)

select
  season,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season
order by season
  );
  
[0m14:20:55.385669 [debug] [Thread-1 (]: SQL status: SELECT 10 in 0.0 seconds
[0m14:20:55.394487 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:20:55.403457 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m14:20:55.406939 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:20:55.419400 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:20:55.421528 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."raw"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m14:20:55.426767 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:20:55.436941 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m14:20:55.439030 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:20:55.442150 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m14:20:55.453904 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m14:20:55.465188 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."summary_by_season__dbt_backup"
[0m14:20:55.468328 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:20:55.470187 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."raw"."summary_by_season__dbt_backup" cascade
[0m14:20:55.479415 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m14:20:55.488356 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 14:20:55.314773 => 14:20:55.487422
[0m14:20:55.490587 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m14:20:55.493602 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2ab8d449-aeb3-403b-8c41-d0115927ef22', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d540a3619a0>]}
[0m14:20:55.498629 [info ] [Thread-1 (]: 2 of 3 OK created sql table model raw.summary_by_season ........................ [[32mSELECT 10[0m in 0.21s]
[0m14:20:55.502373 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m14:20:55.505088 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m14:20:55.507073 [info ] [Thread-1 (]: 3 of 3 START sql table model raw.team_weaknesses ............................... [RUN]
[0m14:20:55.509515 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m14:20:55.510839 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m14:20:55.524861 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m14:20:55.571121 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 14:20:55.512056 => 14:20:55.570121
[0m14:20:55.572849 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m14:20:55.590590 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m14:20:55.625447 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:20:55.627129 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m14:20:55.628820 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:20:55.642595 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m14:20:55.644468 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:20:55.653462 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."raw"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    fg_pct::float as fg_pct,
    tov::int as turnovers
  from "nba"."raw"."spurs_games"
)

select
  season,
   round(avg(fg_pct)::numeric, 3) as avg_fg_pct,
  round(avg(turnovers), 2) as avg_turnovers
from base
group by season
having round(avg(fg_pct)::numeric, 3) < 0.45 or round(avg(turnovers), 2) > 14
order by season
  );
  
[0m14:20:55.692978 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m14:20:55.718376 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:20:55.730380 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m14:20:55.734618 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:20:55.756197 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:20:55.760268 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."raw"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m14:20:55.766904 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:20:55.771894 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m14:20:55.773327 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:20:55.775914 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m14:20:55.787354 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m14:20:55.795649 [debug] [Thread-1 (]: Applying DROP to: "nba"."raw"."team_weaknesses__dbt_backup"
[0m14:20:55.801651 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:20:55.805939 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."raw"."team_weaknesses__dbt_backup" cascade
[0m14:20:55.814463 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m14:20:55.817787 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 14:20:55.574353 => 14:20:55.817502
[0m14:20:55.819338 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m14:20:55.821139 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2ab8d449-aeb3-403b-8c41-d0115927ef22', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d540a3b2870>]}
[0m14:20:55.823090 [info ] [Thread-1 (]: 3 of 3 OK created sql table model raw.team_weaknesses .......................... [[32mSELECT 2[0m in 0.31s]
[0m14:20:55.825385 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m14:20:55.830909 [debug] [MainThread]: Using postgres connection "master"
[0m14:20:55.836002 [debug] [MainThread]: On master: BEGIN
[0m14:20:55.837854 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:20:55.848070 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:20:55.849522 [debug] [MainThread]: On master: COMMIT
[0m14:20:55.851017 [debug] [MainThread]: Using postgres connection "master"
[0m14:20:55.852475 [debug] [MainThread]: On master: COMMIT
[0m14:20:55.854545 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m14:20:55.855928 [debug] [MainThread]: On master: Close
[0m14:20:55.857725 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:20:55.859469 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m14:20:55.865502 [info ] [MainThread]: 
[0m14:20:55.866683 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 1.35 seconds (1.35s).
[0m14:20:55.869012 [debug] [MainThread]: Command end result
[0m14:20:55.939041 [info ] [MainThread]: 
[0m14:20:55.940832 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:20:55.942004 [info ] [MainThread]: 
[0m14:20:55.943159 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m14:20:55.949068 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.5698059, "process_user_time": 5.899141, "process_kernel_time": 0.896278, "process_mem_max_rss": "200816", "process_in_blocks": "26488", "process_out_blocks": "0"}
[0m14:20:55.951101 [debug] [MainThread]: Command `dbt run` succeeded at 14:20:55.950618 after 3.57 seconds
[0m14:20:55.953758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d540c2f1460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d540c26e600>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d540ff06f60>]}
[0m14:20:55.958651 [debug] [MainThread]: Flushing usage events
[0m12:25:00.323633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e35a001a150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e35a0165760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e35a001a270>]}


============================== 12:25:00.329788 | fe17b337-5cab-4e72-be18-5be2e4189633 ==============================
[0m12:25:00.329788 [info ] [MainThread]: Running with dbt=1.7.9
[0m12:25:00.331267 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:25:00.877021 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fe17b337-5cab-4e72-be18-5be2e4189633', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e35a06cf140>]}
[0m12:25:01.027672 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fe17b337-5cab-4e72-be18-5be2e4189633', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e35a1131b50>]}
[0m12:25:01.030117 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m12:25:01.058994 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m12:25:01.105327 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m12:25:01.106813 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'fe17b337-5cab-4e72-be18-5be2e4189633', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e359ef76600>]}
[0m12:25:03.101466 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m12:25:03.107986 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fe17b337-5cab-4e72-be18-5be2e4189633', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e359eb26e70>]}
[0m12:25:03.155156 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fe17b337-5cab-4e72-be18-5be2e4189633', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e359eb6c7a0>]}
[0m12:25:03.156161 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m12:25:03.157069 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fe17b337-5cab-4e72-be18-5be2e4189633', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e359eb01340>]}
[0m12:25:03.159703 [info ] [MainThread]: 
[0m12:25:03.161196 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m12:25:03.164624 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m12:25:03.189147 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m12:25:03.190323 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m12:25:03.202091 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:25:03.214758 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m12:25:03.217614 [debug] [ThreadPool]: On list_nba: Close
[0m12:25:03.222295 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_silver)
[0m12:25:03.234314 [debug] [ThreadPool]: Using postgres connection "list_nba_silver"
[0m12:25:03.235634 [debug] [ThreadPool]: On list_nba_silver: BEGIN
[0m12:25:03.236763 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:25:03.246694 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m12:25:03.248464 [debug] [ThreadPool]: Using postgres connection "list_nba_silver"
[0m12:25:03.250642 [debug] [ThreadPool]: On list_nba_silver: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_silver"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'silver'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'silver'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'silver'
  
[0m12:25:03.266772 [debug] [ThreadPool]: SQL status: SELECT 7 in 0.0 seconds
[0m12:25:03.269341 [debug] [ThreadPool]: On list_nba_silver: ROLLBACK
[0m12:25:03.270859 [debug] [ThreadPool]: On list_nba_silver: Close
[0m12:25:03.289437 [debug] [MainThread]: Using postgres connection "master"
[0m12:25:03.291072 [debug] [MainThread]: On master: BEGIN
[0m12:25:03.292081 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:25:03.305204 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m12:25:03.306468 [debug] [MainThread]: Using postgres connection "master"
[0m12:25:03.307704 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m12:25:03.352763 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m12:25:03.355295 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fe17b337-5cab-4e72-be18-5be2e4189633', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e359eb84f20>]}
[0m12:25:03.356429 [debug] [MainThread]: On master: ROLLBACK
[0m12:25:03.357613 [debug] [MainThread]: Using postgres connection "master"
[0m12:25:03.358464 [debug] [MainThread]: On master: BEGIN
[0m12:25:03.359807 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m12:25:03.360676 [debug] [MainThread]: On master: COMMIT
[0m12:25:03.361362 [debug] [MainThread]: Using postgres connection "master"
[0m12:25:03.362384 [debug] [MainThread]: On master: COMMIT
[0m12:25:03.365280 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m12:25:03.366211 [debug] [MainThread]: On master: Close
[0m12:25:03.368225 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m12:25:03.371236 [info ] [MainThread]: 
[0m12:25:03.376286 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m12:25:03.377513 [info ] [Thread-1 (]: 1 of 3 START sql table model silver.home_vs_away ............................... [RUN]
[0m12:25:03.379563 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_silver, now model.spurs_dbt.home_vs_away)
[0m12:25:03.381552 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m12:25:03.392856 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m12:25:03.408356 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 12:25:03.382551 => 12:25:03.407859
[0m12:25:03.409781 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m12:25:03.476165 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m12:25:03.490998 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m12:25:03.491938 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m12:25:03.492769 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:25:03.500427 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m12:25:03.501486 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m12:25:03.502384 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."silver"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."silver"."spurs_games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season, location
order by season, location
  );
  
[0m12:25:03.522565 [debug] [Thread-1 (]: SQL status: SELECT 4 in 0.0 seconds
[0m12:25:03.531450 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m12:25:03.532500 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."silver"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m12:25:03.534218 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m12:25:03.558515 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m12:25:03.559619 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m12:25:03.560656 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m12:25:03.566568 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m12:25:03.575855 [debug] [Thread-1 (]: Applying DROP to: "nba"."silver"."home_vs_away__dbt_backup"
[0m12:25:03.584848 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m12:25:03.586121 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."silver"."home_vs_away__dbt_backup" cascade
[0m12:25:03.587949 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m12:25:03.590920 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 12:25:03.411157 => 12:25:03.590615
[0m12:25:03.591991 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m12:25:03.593621 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fe17b337-5cab-4e72-be18-5be2e4189633', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e359efc2660>]}
[0m12:25:03.594906 [info ] [Thread-1 (]: 1 of 3 OK created sql table model silver.home_vs_away .......................... [[32mSELECT 4[0m in 0.22s]
[0m12:25:03.597192 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m12:25:03.598599 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m12:25:03.599795 [info ] [Thread-1 (]: 2 of 3 START sql table model silver.summary_by_season .......................... [RUN]
[0m12:25:03.601222 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m12:25:03.602293 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m12:25:03.607738 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m12:25:03.627568 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 12:25:03.603304 => 12:25:03.627092
[0m12:25:03.628991 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m12:25:03.636272 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m12:25:03.654820 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m12:25:03.655917 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m12:25:03.656753 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:25:03.665184 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m12:25:03.666310 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m12:25:03.667794 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."silver"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    wl,
    pts::int as pts
  from "nba"."silver"."spurs_games"
)

select
  season,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season
order by season
  );
  
[0m12:25:03.685270 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m12:25:03.690022 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m12:25:03.691538 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."silver"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m12:25:03.693709 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m12:25:03.697949 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m12:25:03.699171 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m12:25:03.700370 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m12:25:03.706309 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m12:25:03.710452 [debug] [Thread-1 (]: Applying DROP to: "nba"."silver"."summary_by_season__dbt_backup"
[0m12:25:03.712478 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m12:25:03.714291 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."silver"."summary_by_season__dbt_backup" cascade
[0m12:25:03.716476 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m12:25:03.719365 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 12:25:03.630370 => 12:25:03.718875
[0m12:25:03.720431 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m12:25:03.722080 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fe17b337-5cab-4e72-be18-5be2e4189633', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e359efc0920>]}
[0m12:25:03.723531 [info ] [Thread-1 (]: 2 of 3 OK created sql table model silver.summary_by_season ..................... [[32mSELECT 2[0m in 0.12s]
[0m12:25:03.725435 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m12:25:03.726573 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m12:25:03.727652 [info ] [Thread-1 (]: 3 of 3 START sql table model silver.team_weaknesses ............................ [RUN]
[0m12:25:03.729303 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m12:25:03.731095 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m12:25:03.735735 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m12:25:03.755143 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 12:25:03.732098 => 12:25:03.754607
[0m12:25:03.756650 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m12:25:03.766285 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m12:25:03.784102 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m12:25:03.785000 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m12:25:03.785798 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:25:03.792652 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m12:25:03.793753 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m12:25:03.794836 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."silver"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    fg_pct::float as fg_pct,
    tov::int as turnovers
  from "nba"."silver"."spurs_games"
)

select
  season,
   round(avg(fg_pct)::numeric, 3) as avg_fg_pct,
  round(avg(turnovers), 2) as avg_turnovers
from base
group by season
having round(avg(fg_pct)::numeric, 3) < 0.45 or round(avg(turnovers), 2) > 14
order by season
  );
  
[0m12:25:03.813557 [debug] [Thread-1 (]: Postgres adapter: Postgres error: invalid input syntax for type integer: "12.0"

[0m12:25:03.814897 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: ROLLBACK
[0m12:25:03.816626 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 12:25:03.757560 => 12:25:03.816324
[0m12:25:03.817729 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m12:25:03.829663 [debug] [Thread-1 (]: Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  invalid input syntax for type integer: "12.0"
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m12:25:03.831158 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fe17b337-5cab-4e72-be18-5be2e4189633', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e359df48770>]}
[0m12:25:03.832509 [error] [Thread-1 (]: 3 of 3 ERROR creating sql table model silver.team_weaknesses ................... [[31mERROR[0m in 0.10s]
[0m12:25:03.833751 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m12:25:03.837580 [debug] [MainThread]: Using postgres connection "master"
[0m12:25:03.838642 [debug] [MainThread]: On master: BEGIN
[0m12:25:03.839480 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:25:03.846419 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m12:25:03.848372 [debug] [MainThread]: On master: COMMIT
[0m12:25:03.849729 [debug] [MainThread]: Using postgres connection "master"
[0m12:25:03.850700 [debug] [MainThread]: On master: COMMIT
[0m12:25:03.852498 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m12:25:03.853910 [debug] [MainThread]: On master: Close
[0m12:25:03.855748 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:25:03.856732 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m12:25:03.857747 [info ] [MainThread]: 
[0m12:25:03.858716 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.70 seconds (0.70s).
[0m12:25:03.861347 [debug] [MainThread]: Command end result
[0m12:25:03.918598 [info ] [MainThread]: 
[0m12:25:03.919671 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:25:03.920593 [info ] [MainThread]: 
[0m12:25:03.921458 [error] [MainThread]:   Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  invalid input syntax for type integer: "12.0"
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m12:25:03.922333 [info ] [MainThread]: 
[0m12:25:03.923219 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m12:25:03.925624 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 3.699582, "process_user_time": 5.195523, "process_kernel_time": 1.1715, "process_mem_max_rss": "200928", "process_in_blocks": "4592", "command_success": false, "process_out_blocks": "0"}
[0m12:25:03.926651 [debug] [MainThread]: Command `dbt run` failed at 12:25:03.926469 after 3.70 seconds
[0m12:25:03.927552 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e35a0134fe0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e359eb25700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e359df49bb0>]}
[0m12:25:03.928567 [debug] [MainThread]: Flushing usage events
[0m19:00:58.729256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7480533d5400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7480533d6180>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7480533d5340>]}


============================== 19:00:58.736081 | aedc8a1a-7893-47c0-9220-c08ccbfd1b47 ==============================
[0m19:00:58.736081 [info ] [MainThread]: Running with dbt=1.7.9
[0m19:00:58.737362 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:00:59.145909 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aedc8a1a-7893-47c0-9220-c08ccbfd1b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7480532f5760>]}
[0m19:00:59.279351 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aedc8a1a-7893-47c0-9220-c08ccbfd1b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x748053acfbf0>]}
[0m19:00:59.280989 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m19:00:59.307256 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m19:00:59.463808 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m19:00:59.464951 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'aedc8a1a-7893-47c0-9220-c08ccbfd1b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7480527a31d0>]}
[0m19:01:01.153921 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m19:01:01.161305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'aedc8a1a-7893-47c0-9220-c08ccbfd1b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x748051ba03b0>]}
[0m19:01:01.349365 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'aedc8a1a-7893-47c0-9220-c08ccbfd1b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x748051f69d90>]}
[0m19:01:01.351960 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m19:01:01.354386 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aedc8a1a-7893-47c0-9220-c08ccbfd1b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x748051b85940>]}
[0m19:01:01.362339 [info ] [MainThread]: 
[0m19:01:01.366311 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m19:01:01.372071 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m19:01:01.395422 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m19:01:01.396921 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m19:01:01.398249 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:01:01.410026 [debug] [ThreadPool]: SQL status: SELECT 7 in 0.0 seconds
[0m19:01:01.413389 [debug] [ThreadPool]: On list_nba: Close
[0m19:01:01.415970 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now create_nba_gold)
[0m19:01:01.417879 [debug] [ThreadPool]: Creating schema "database: "nba"
schema: "gold"
"
[0m19:01:01.424846 [debug] [ThreadPool]: Using postgres connection "create_nba_gold"
[0m19:01:01.425904 [debug] [ThreadPool]: On create_nba_gold: BEGIN
[0m19:01:01.427743 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:01:01.437526 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m19:01:01.438638 [debug] [ThreadPool]: Using postgres connection "create_nba_gold"
[0m19:01:01.439581 [debug] [ThreadPool]: On create_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "create_nba_gold"} */
create schema if not exists "gold"
[0m19:01:01.443998 [debug] [ThreadPool]: SQL status: CREATE SCHEMA in 0.0 seconds
[0m19:01:01.446431 [debug] [ThreadPool]: On create_nba_gold: COMMIT
[0m19:01:01.447479 [debug] [ThreadPool]: Using postgres connection "create_nba_gold"
[0m19:01:01.448548 [debug] [ThreadPool]: On create_nba_gold: COMMIT
[0m19:01:01.454584 [debug] [ThreadPool]: SQL status: COMMIT in 0.0 seconds
[0m19:01:01.455632 [debug] [ThreadPool]: On create_nba_gold: Close
[0m19:01:01.459599 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly create_nba_gold, now list_nba_gold)
[0m19:01:01.468152 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:01:01.469264 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m19:01:01.470302 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:01:01.478728 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m19:01:01.479849 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:01:01.480994 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m19:01:01.487968 [debug] [ThreadPool]: SQL status: SELECT 0 in 0.0 seconds
[0m19:01:01.490601 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m19:01:01.492355 [debug] [ThreadPool]: On list_nba_gold: Close
[0m19:01:01.499829 [debug] [MainThread]: Using postgres connection "master"
[0m19:01:01.500883 [debug] [MainThread]: On master: BEGIN
[0m19:01:01.501783 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:01:01.508151 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:01:01.509644 [debug] [MainThread]: Using postgres connection "master"
[0m19:01:01.511587 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m19:01:01.528504 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m19:01:01.530519 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aedc8a1a-7893-47c0-9220-c08ccbfd1b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x748051b0b530>]}
[0m19:01:01.531531 [debug] [MainThread]: On master: ROLLBACK
[0m19:01:01.532843 [debug] [MainThread]: Using postgres connection "master"
[0m19:01:01.533754 [debug] [MainThread]: On master: BEGIN
[0m19:01:01.535347 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:01:01.536349 [debug] [MainThread]: On master: COMMIT
[0m19:01:01.537400 [debug] [MainThread]: Using postgres connection "master"
[0m19:01:01.538266 [debug] [MainThread]: On master: COMMIT
[0m19:01:01.539410 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:01:01.540303 [debug] [MainThread]: On master: Close
[0m19:01:01.541860 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m19:01:01.543090 [info ] [MainThread]: 
[0m19:01:01.549068 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m19:01:01.550494 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m19:01:01.551969 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m19:01:01.553021 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m19:01:01.564364 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m19:01:01.590048 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 19:01:01.553858 => 19:01:01.589649
[0m19:01:01.591039 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m19:01:01.640172 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m19:01:01.666752 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:01:01.667763 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m19:01:01.668712 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:01:01.675463 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:01:01.677794 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:01:01.679347 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season, location
order by season, location
  );
  
[0m19:01:01.702914 [debug] [Thread-1 (]: SQL status: SELECT 4 in 0.0 seconds
[0m19:01:01.711750 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:01:01.712831 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m19:01:01.714564 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:01:01.740312 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:01:01.741329 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:01:01.742115 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:01:01.749853 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:01:01.757582 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m19:01:01.766184 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:01:01.767155 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m19:01:01.768489 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:01:01.770755 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 19:01:01.591811 => 19:01:01.770498
[0m19:01:01.771615 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m19:01:01.773045 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aedc8a1a-7893-47c0-9220-c08ccbfd1b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7480513ae330>]}
[0m19:01:01.774204 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 4[0m in 0.22s]
[0m19:01:01.775513 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m19:01:01.777362 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m19:01:01.778959 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m19:01:01.780290 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m19:01:01.781317 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m19:01:01.785143 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m19:01:01.806424 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 19:01:01.781941 => 19:01:01.806022
[0m19:01:01.807257 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m19:01:01.814779 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m19:01:01.839521 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:01:01.840556 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m19:01:01.841496 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:01:01.850353 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:01:01.851516 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:01:01.852668 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season
order by season
  );
  
[0m19:01:01.873197 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m19:01:01.879626 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:01:01.880817 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m19:01:01.882337 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:01:01.885314 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:01:01.886396 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:01:01.887457 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:01:01.893464 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:01:01.898421 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m19:01:01.900147 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:01:01.901496 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m19:01:01.903287 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:01:01.905982 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 19:01:01.807858 => 19:01:01.905676
[0m19:01:01.907110 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m19:01:01.909077 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aedc8a1a-7893-47c0-9220-c08ccbfd1b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7480513c3440>]}
[0m19:01:01.911150 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 2[0m in 0.13s]
[0m19:01:01.913222 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m19:01:01.914549 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m19:01:01.916038 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m19:01:01.917874 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m19:01:01.919116 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m19:01:01.924192 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m19:01:01.949023 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 19:01:01.920049 => 19:01:01.948580
[0m19:01:01.950110 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m19:01:01.957449 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m19:01:01.988608 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:01:01.989752 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m19:01:01.990756 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:01:01.999828 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:01:02.001052 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:01:02.002109 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    season,
    fg_pct::float as fg_pct,
    tov::int as turnovers
  from "nba"."silver"."games"
)

select
  season,
   round(avg(fg_pct)::numeric, 3) as avg_fg_pct,
  round(avg(turnovers), 2) as avg_turnovers
from base
group by season
having round(avg(fg_pct)::numeric, 3) < 0.45 or round(avg(turnovers), 2) > 14
order by season
  );
  
[0m19:01:02.019674 [debug] [Thread-1 (]: Postgres adapter: Postgres error: invalid input syntax for type integer: "12.0"

[0m19:01:02.020783 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: ROLLBACK
[0m19:01:02.022375 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 19:01:01.950950 => 19:01:02.022074
[0m19:01:02.023433 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m19:01:02.032368 [debug] [Thread-1 (]: Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  invalid input syntax for type integer: "12.0"
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m19:01:02.033720 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aedc8a1a-7893-47c0-9220-c08ccbfd1b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74805013c2c0>]}
[0m19:01:02.034969 [error] [Thread-1 (]: 3 of 3 ERROR creating sql table model gold.team_weaknesses ..................... [[31mERROR[0m in 0.12s]
[0m19:01:02.036207 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m19:01:02.040327 [debug] [MainThread]: Using postgres connection "master"
[0m19:01:02.041445 [debug] [MainThread]: On master: BEGIN
[0m19:01:02.042284 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m19:01:02.051261 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:01:02.052382 [debug] [MainThread]: On master: COMMIT
[0m19:01:02.053384 [debug] [MainThread]: Using postgres connection "master"
[0m19:01:02.054254 [debug] [MainThread]: On master: COMMIT
[0m19:01:02.055405 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:01:02.056305 [debug] [MainThread]: On master: Close
[0m19:01:02.057841 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:01:02.058760 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m19:01:02.060160 [info ] [MainThread]: 
[0m19:01:02.061978 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.70 seconds (0.70s).
[0m19:01:02.063792 [debug] [MainThread]: Command end result
[0m19:01:02.135491 [info ] [MainThread]: 
[0m19:01:02.136573 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:01:02.137506 [info ] [MainThread]: 
[0m19:01:02.138434 [error] [MainThread]:   Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  invalid input syntax for type integer: "12.0"
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m19:01:02.139355 [info ] [MainThread]: 
[0m19:01:02.140353 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m19:01:02.142414 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 3.8663821, "process_user_time": 5.438136, "process_kernel_time": 1.165602, "process_mem_max_rss": "200936", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m19:01:02.144569 [debug] [MainThread]: Command `dbt run` failed at 19:01:02.144103 after 3.87 seconds
[0m19:01:02.145850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7480542c2c00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x748051bf3560>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x748053520740>]}
[0m19:01:02.146809 [debug] [MainThread]: Flushing usage events
[0m19:33:39.097541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b93b628d190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b93b628f770>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b93b628d3d0>]}


============================== 19:33:39.101958 | 0176b35d-41fe-4ff7-9f8e-0785429713c0 ==============================
[0m19:33:39.101958 [info ] [MainThread]: Running with dbt=1.7.9
[0m19:33:39.103081 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:33:39.388170 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0176b35d-41fe-4ff7-9f8e-0785429713c0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b93bac52f30>]}
[0m19:33:39.503273 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0176b35d-41fe-4ff7-9f8e-0785429713c0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b93bac52f30>]}
[0m19:33:39.504783 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m19:33:39.530433 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m19:33:39.788573 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 3 files changed.
[0m19:33:39.789728 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/home_vs_away.sql
[0m19:33:39.790670 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m19:33:39.791627 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/summary_by_season.sql
[0m19:33:40.189136 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m19:33:40.197262 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0176b35d-41fe-4ff7-9f8e-0785429713c0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b93b2ef9f70>]}
[0m19:33:40.364433 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0176b35d-41fe-4ff7-9f8e-0785429713c0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b93b4f74950>]}
[0m19:33:40.365531 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m19:33:40.366558 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0176b35d-41fe-4ff7-9f8e-0785429713c0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b93b578b470>]}
[0m19:33:40.369135 [info ] [MainThread]: 
[0m19:33:40.370616 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m19:33:40.373137 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m19:33:40.387464 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m19:33:40.388588 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m19:33:40.389570 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:33:40.400562 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m19:33:40.402703 [debug] [ThreadPool]: On list_nba: Close
[0m19:33:40.406066 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m19:33:40.415037 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:33:40.416142 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m19:33:40.417015 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:33:40.424304 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m19:33:40.426746 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:33:40.428209 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m19:33:40.433426 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.0 seconds
[0m19:33:40.435665 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m19:33:40.436917 [debug] [ThreadPool]: On list_nba_gold: Close
[0m19:33:40.444059 [debug] [MainThread]: Using postgres connection "master"
[0m19:33:40.445714 [debug] [MainThread]: On master: BEGIN
[0m19:33:40.446630 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:33:40.454098 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:33:40.455237 [debug] [MainThread]: Using postgres connection "master"
[0m19:33:40.456274 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m19:33:40.472708 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m19:33:40.475179 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0176b35d-41fe-4ff7-9f8e-0785429713c0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b93b2f63c80>]}
[0m19:33:40.476321 [debug] [MainThread]: On master: ROLLBACK
[0m19:33:40.478004 [debug] [MainThread]: Using postgres connection "master"
[0m19:33:40.479429 [debug] [MainThread]: On master: BEGIN
[0m19:33:40.481205 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:33:40.482295 [debug] [MainThread]: On master: COMMIT
[0m19:33:40.483307 [debug] [MainThread]: Using postgres connection "master"
[0m19:33:40.484167 [debug] [MainThread]: On master: COMMIT
[0m19:33:40.485435 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:33:40.486435 [debug] [MainThread]: On master: Close
[0m19:33:40.487937 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m19:33:40.489015 [info ] [MainThread]: 
[0m19:33:40.493540 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m19:33:40.495509 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m19:33:40.496983 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m19:33:40.498017 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m19:33:40.507198 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m19:33:40.533825 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 19:33:40.498810 => 19:33:40.533439
[0m19:33:40.534886 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m19:33:40.584432 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m19:33:40.610129 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:33:40.612078 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m19:33:40.613139 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:33:40.621206 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:33:40.622389 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:33:40.623605 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
         else season end as season,
    team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m19:33:40.653262 [debug] [Thread-1 (]: SQL status: SELECT 211 in 0.0 seconds
[0m19:33:40.671019 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:33:40.672916 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m19:33:40.675739 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:33:40.686785 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:33:40.688818 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m19:33:40.691643 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:33:40.723188 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:33:40.724529 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:33:40.725578 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:33:40.733497 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:33:40.743192 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m19:33:40.754116 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:33:40.755417 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m19:33:40.762869 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:33:40.767732 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 19:33:40.535887 => 19:33:40.767249
[0m19:33:40.769128 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m19:33:40.771006 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0176b35d-41fe-4ff7-9f8e-0785429713c0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b93b2fb2000>]}
[0m19:33:40.772703 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 211[0m in 0.27s]
[0m19:33:40.774657 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m19:33:40.776007 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m19:33:40.777651 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m19:33:40.779838 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m19:33:40.781139 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m19:33:40.787631 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m19:33:40.812648 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 19:33:40.782139 => 19:33:40.812260
[0m19:33:40.813677 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m19:33:40.819413 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m19:33:40.849294 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:33:40.850481 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m19:33:40.851637 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:33:40.860486 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:33:40.862443 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:33:40.863913 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m19:33:40.883927 [debug] [Thread-1 (]: SQL status: SELECT 106 in 0.0 seconds
[0m19:33:40.892697 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:33:40.894867 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m19:33:40.897012 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:33:40.901909 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:33:40.903294 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m19:33:40.904971 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:33:40.908535 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:33:40.909740 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:33:40.911298 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:33:40.919559 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:33:40.925186 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m19:33:40.927697 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:33:40.929456 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m19:33:40.937976 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:33:40.940452 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 19:33:40.814467 => 19:33:40.940175
[0m19:33:40.941377 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m19:33:40.943049 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0176b35d-41fe-4ff7-9f8e-0785429713c0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b93b2fb27e0>]}
[0m19:33:40.945146 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 106[0m in 0.16s]
[0m19:33:40.946751 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m19:33:40.947879 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m19:33:40.948936 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m19:33:40.950206 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m19:33:40.951240 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m19:33:40.956281 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m19:33:40.981207 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 19:33:40.951992 => 19:33:40.980820
[0m19:33:40.982167 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m19:33:40.987860 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m19:33:41.011461 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:33:41.012782 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m19:33:41.014858 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:33:41.023547 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:33:41.024604 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:33:41.025834 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        season,
        AVG(fg_pct) AS avg_fg_pct,
        AVG(fg3_pct) AS avg_fg3_pct,
        AVG(tov) AS avg_turnovers,
        AVG(reb) AS avg_rebounds,
        AVG(blk) AS avg_blocks,
        AVG(stl) AS avg_steals,
        AVG(plus_minus) AS avg_plus_minus
    FROM "nba"."silver"."games"
    where team_name = 'San Antonio Spurs'
    GROUP BY season
),

team_averages AS (
    SELECT
        season,
        AVG(fg_pct) AS avg_league_fg_pct,
        AVG(fg3_pct) AS avg_league_fg3_pct,
        AVG(tov) AS avg_league_turnovers,
        AVG(reb) AS avg_league_rebounds,
        AVG(blk) AS avg_league_blocks,
        AVG(stl) AS avg_league_steals,
        AVG(plus_minus) AS avg_league_plus_minus
    FROM "nba"."silver"."games" -- Asume que 'games' incluye todos los partidos de la liga
    GROUP BY season
)

all_teams_stats AS (
    SELECT
        season,
        team_id,
        AVG(fg_pct) AS avg_fg_pct,
        AVG(fg3_pct) AS avg_fg3_pct,
        AVG(tov) AS avg_turnovers,
        AVG(reb) AS avg_rebounds,
        AVG(blk) AS avg_blocks,
        AVG(stl) AS avg_steals,
        AVG(plus_minus) AS avg_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_stl AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_stl,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    )
    WHERE rn = 1
)

SELECT
    ss.season,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season = ta.season
JOIN best_team_stats bts ON ss.season = bts.season
  );
  
[0m19:33:41.029201 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "all_teams_stats"
LINE 43: all_teams_stats AS (
         ^

[0m19:33:41.030377 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: ROLLBACK
[0m19:33:41.031895 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 19:33:40.982955 => 19:33:41.031582
[0m19:33:41.032777 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m19:33:41.038799 [debug] [Thread-1 (]: Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  syntax error at or near "all_teams_stats"
  LINE 43: all_teams_stats AS (
           ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m19:33:41.040042 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0176b35d-41fe-4ff7-9f8e-0785429713c0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b93b2fd16d0>]}
[0m19:33:41.041160 [error] [Thread-1 (]: 3 of 3 ERROR creating sql table model gold.team_weaknesses ..................... [[31mERROR[0m in 0.09s]
[0m19:33:41.042305 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m19:33:41.048243 [debug] [MainThread]: Using postgres connection "master"
[0m19:33:41.049959 [debug] [MainThread]: On master: BEGIN
[0m19:33:41.051483 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m19:33:41.059436 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:33:41.060617 [debug] [MainThread]: On master: COMMIT
[0m19:33:41.062021 [debug] [MainThread]: Using postgres connection "master"
[0m19:33:41.063052 [debug] [MainThread]: On master: COMMIT
[0m19:33:41.064318 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:33:41.065362 [debug] [MainThread]: On master: Close
[0m19:33:41.067403 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:33:41.068986 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m19:33:41.070226 [info ] [MainThread]: 
[0m19:33:41.071379 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.70 seconds (0.70s).
[0m19:33:41.073117 [debug] [MainThread]: Command end result
[0m19:33:41.130559 [info ] [MainThread]: 
[0m19:33:41.131738 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:33:41.132745 [info ] [MainThread]: 
[0m19:33:41.133671 [error] [MainThread]:   Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  syntax error at or near "all_teams_stats"
  LINE 43: all_teams_stats AS (
           ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m19:33:41.134596 [info ] [MainThread]: 
[0m19:33:41.135538 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m19:33:41.137116 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.1284983, "process_user_time": 3.637499, "process_kernel_time": 0.462157, "process_mem_max_rss": "200876", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m19:33:41.138264 [debug] [MainThread]: Command `dbt run` failed at 19:33:41.138087 after 2.13 seconds
[0m19:33:41.139283 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b93b66fc440>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b93b4fc8320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b93b533b020>]}
[0m19:33:41.140229 [debug] [MainThread]: Flushing usage events
[0m19:35:19.231838 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a867f4952e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a867f5985c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a867f840aa0>]}


============================== 19:35:19.236644 | 815d6b9c-89a3-4d13-9b5e-3c3baafca562 ==============================
[0m19:35:19.236644 [info ] [MainThread]: Running with dbt=1.7.9
[0m19:35:19.238014 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:35:19.546960 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '815d6b9c-89a3-4d13-9b5e-3c3baafca562', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a867e9fb710>]}
[0m19:35:19.660320 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '815d6b9c-89a3-4d13-9b5e-3c3baafca562', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a867e95f5f0>]}
[0m19:35:19.661808 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m19:35:19.687764 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m19:35:19.876095 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:35:19.877709 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m19:35:20.124294 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m19:35:20.132473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '815d6b9c-89a3-4d13-9b5e-3c3baafca562', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a867d593320>]}
[0m19:35:20.201212 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '815d6b9c-89a3-4d13-9b5e-3c3baafca562', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a867e179820>]}
[0m19:35:20.202319 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m19:35:20.203475 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '815d6b9c-89a3-4d13-9b5e-3c3baafca562', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a867e178c80>]}
[0m19:35:20.206305 [info ] [MainThread]: 
[0m19:35:20.208407 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m19:35:20.212021 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m19:35:20.225606 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m19:35:20.227049 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m19:35:20.228106 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:35:20.237050 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m19:35:20.239115 [debug] [ThreadPool]: On list_nba: Close
[0m19:35:20.243456 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m19:35:20.251027 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:35:20.252055 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m19:35:20.252899 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:35:20.260308 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m19:35:20.261312 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:35:20.262174 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m19:35:20.266731 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.0 seconds
[0m19:35:20.268934 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m19:35:20.270146 [debug] [ThreadPool]: On list_nba_gold: Close
[0m19:35:20.278000 [debug] [MainThread]: Using postgres connection "master"
[0m19:35:20.278880 [debug] [MainThread]: On master: BEGIN
[0m19:35:20.279827 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:35:20.286608 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:35:20.287619 [debug] [MainThread]: Using postgres connection "master"
[0m19:35:20.288725 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m19:35:20.304613 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m19:35:20.307026 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '815d6b9c-89a3-4d13-9b5e-3c3baafca562', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a86803a7380>]}
[0m19:35:20.308233 [debug] [MainThread]: On master: ROLLBACK
[0m19:35:20.309815 [debug] [MainThread]: Using postgres connection "master"
[0m19:35:20.310790 [debug] [MainThread]: On master: BEGIN
[0m19:35:20.312203 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:35:20.313139 [debug] [MainThread]: On master: COMMIT
[0m19:35:20.314017 [debug] [MainThread]: Using postgres connection "master"
[0m19:35:20.314874 [debug] [MainThread]: On master: COMMIT
[0m19:35:20.315999 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:35:20.316892 [debug] [MainThread]: On master: Close
[0m19:35:20.318552 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m19:35:20.320927 [info ] [MainThread]: 
[0m19:35:20.326936 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m19:35:20.328723 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m19:35:20.330526 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m19:35:20.331945 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m19:35:20.344325 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m19:35:20.371093 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 19:35:20.332930 => 19:35:20.370702
[0m19:35:20.372120 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m19:35:20.424323 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m19:35:20.449991 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:35:20.451003 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m19:35:20.452000 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:35:20.460146 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:35:20.461282 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:35:20.462255 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
         else season end as season,
    team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m19:35:20.487749 [debug] [Thread-1 (]: SQL status: SELECT 211 in 0.0 seconds
[0m19:35:20.500195 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:35:20.501296 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m19:35:20.502768 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:35:20.506818 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:35:20.508625 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m19:35:20.511098 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:35:20.536298 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:35:20.537417 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:35:20.538279 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:35:20.547787 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:35:20.556074 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m19:35:20.564900 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:35:20.566003 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m19:35:20.572986 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:35:20.576666 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 19:35:20.372870 => 19:35:20.576179
[0m19:35:20.577746 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m19:35:20.579276 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '815d6b9c-89a3-4d13-9b5e-3c3baafca562', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a867d99c800>]}
[0m19:35:20.580543 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 211[0m in 0.25s]
[0m19:35:20.581951 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m19:35:20.583050 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m19:35:20.584124 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m19:35:20.585446 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m19:35:20.586430 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m19:35:20.590679 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m19:35:20.616958 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 19:35:20.587258 => 19:35:20.616580
[0m19:35:20.617953 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m19:35:20.623176 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m19:35:20.648014 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:35:20.649024 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m19:35:20.649930 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:35:20.656666 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:35:20.657989 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:35:20.659948 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m19:35:20.679923 [debug] [Thread-1 (]: SQL status: SELECT 106 in 0.0 seconds
[0m19:35:20.684222 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:35:20.685132 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m19:35:20.686400 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:35:20.690206 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:35:20.691452 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m19:35:20.693701 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:35:20.696663 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:35:20.697526 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:35:20.698327 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:35:20.704232 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:35:20.709267 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m19:35:20.710791 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:35:20.711705 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m19:35:20.720078 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:35:20.722779 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 19:35:20.618728 => 19:35:20.722444
[0m19:35:20.723932 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m19:35:20.726443 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '815d6b9c-89a3-4d13-9b5e-3c3baafca562', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a867d99c800>]}
[0m19:35:20.728510 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 106[0m in 0.14s]
[0m19:35:20.729848 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m19:35:20.730814 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m19:35:20.731888 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m19:35:20.733133 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m19:35:20.733958 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m19:35:20.738978 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m19:35:20.761991 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 19:35:20.734590 => 19:35:20.761287
[0m19:35:20.765805 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m19:35:20.773924 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m19:35:20.823553 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:35:20.826502 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m19:35:20.830476 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:35:20.842018 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:35:20.845290 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:35:20.846648 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        season,
        AVG(fg_pct) AS avg_fg_pct,
        AVG(fg3_pct) AS avg_fg3_pct,
        AVG(tov) AS avg_turnovers,
        AVG(reb) AS avg_rebounds,
        AVG(blk) AS avg_blocks,
        AVG(stl) AS avg_steals,
        AVG(plus_minus) AS avg_plus_minus
    FROM "nba"."silver"."games"
    where team_name = 'San Antonio Spurs'
    GROUP BY season
),

team_averages AS (
    SELECT
        season,
        AVG(fg_pct) AS avg_league_fg_pct,
        AVG(fg3_pct) AS avg_league_fg3_pct,
        AVG(tov) AS avg_league_turnovers,
        AVG(reb) AS avg_league_rebounds,
        AVG(blk) AS avg_league_blocks,
        AVG(stl) AS avg_league_steals,
        AVG(plus_minus) AS avg_league_plus_minus
    FROM "nba"."silver"."games" -- Asume que 'games' incluye todos los partidos de la liga
    GROUP BY season
),

all_teams_stats AS (
    SELECT
        season,
        team_id,
        AVG(fg_pct) AS avg_fg_pct,
        AVG(fg3_pct) AS avg_fg3_pct,
        AVG(tov) AS avg_turnovers,
        AVG(reb) AS avg_rebounds,
        AVG(blk) AS avg_blocks,
        AVG(stl) AS avg_steals,
        AVG(plus_minus) AS avg_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_stl AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_stl,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    )
    WHERE rn = 1
)

SELECT
    ss.season,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season = ta.season
JOIN best_team_stats bts ON ss.season = bts.season
  );
  
[0m19:35:20.848738 [debug] [Thread-1 (]: Postgres adapter: Postgres error: subquery in FROM must have an alias
LINE 68:     FROM (
                  ^
HINT:  For example, FROM (SELECT ...) [AS] foo.

[0m19:35:20.849661 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: ROLLBACK
[0m19:35:20.850954 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 19:35:20.766548 => 19:35:20.850642
[0m19:35:20.851824 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m19:35:20.857432 [debug] [Thread-1 (]: Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  subquery in FROM must have an alias
  LINE 68:     FROM (
                    ^
  HINT:  For example, FROM (SELECT ...) [AS] foo.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m19:35:20.859142 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '815d6b9c-89a3-4d13-9b5e-3c3baafca562', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a867d5c4650>]}
[0m19:35:20.860443 [error] [Thread-1 (]: 3 of 3 ERROR creating sql table model gold.team_weaknesses ..................... [[31mERROR[0m in 0.13s]
[0m19:35:20.861605 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m19:35:20.865311 [debug] [MainThread]: Using postgres connection "master"
[0m19:35:20.866284 [debug] [MainThread]: On master: BEGIN
[0m19:35:20.867056 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m19:35:20.874884 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:35:20.876586 [debug] [MainThread]: On master: COMMIT
[0m19:35:20.877507 [debug] [MainThread]: Using postgres connection "master"
[0m19:35:20.878316 [debug] [MainThread]: On master: COMMIT
[0m19:35:20.879489 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:35:20.880490 [debug] [MainThread]: On master: Close
[0m19:35:20.881872 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:35:20.882978 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m19:35:20.884280 [info ] [MainThread]: 
[0m19:35:20.885308 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.68 seconds (0.68s).
[0m19:35:20.886970 [debug] [MainThread]: Command end result
[0m19:35:20.945193 [info ] [MainThread]: 
[0m19:35:20.946444 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:35:20.947477 [info ] [MainThread]: 
[0m19:35:20.948548 [error] [MainThread]:   Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  subquery in FROM must have an alias
  LINE 68:     FROM (
                    ^
  HINT:  For example, FROM (SELECT ...) [AS] foo.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m19:35:20.949508 [info ] [MainThread]: 
[0m19:35:20.950387 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m19:35:20.951890 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.8135749, "process_user_time": 3.416956, "process_kernel_time": 0.388563, "process_mem_max_rss": "200868", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m19:35:20.953020 [debug] [MainThread]: Command `dbt run` failed at 19:35:20.952844 after 1.81 seconds
[0m19:35:20.954022 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a867f5ca540>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a867f5985c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a8683e5af30>]}
[0m19:35:20.955037 [debug] [MainThread]: Flushing usage events
[0m19:36:37.244382 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7792b15f8d40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7792b19a2570>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7792b15fa000>]}


============================== 19:36:37.248729 | 0d3da0cc-925e-4c31-9fb7-060f5cc8ceef ==============================
[0m19:36:37.248729 [info ] [MainThread]: Running with dbt=1.7.9
[0m19:36:37.249902 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m19:36:37.520736 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0d3da0cc-925e-4c31-9fb7-060f5cc8ceef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7792b1727c80>]}
[0m19:36:37.632490 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0d3da0cc-925e-4c31-9fb7-060f5cc8ceef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7792b1c82030>]}
[0m19:36:37.633927 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m19:36:37.657590 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m19:36:37.856282 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:36:37.857675 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m19:36:38.120003 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m19:36:38.133229 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0d3da0cc-925e-4c31-9fb7-060f5cc8ceef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7792af9cf530>]}
[0m19:36:38.207080 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0d3da0cc-925e-4c31-9fb7-060f5cc8ceef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7792b05b96a0>]}
[0m19:36:38.208330 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m19:36:38.209929 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0d3da0cc-925e-4c31-9fb7-060f5cc8ceef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7792b1625b20>]}
[0m19:36:38.212826 [info ] [MainThread]: 
[0m19:36:38.214435 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m19:36:38.217008 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m19:36:38.239564 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m19:36:38.240744 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m19:36:38.241903 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:36:38.251482 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m19:36:38.253711 [debug] [ThreadPool]: On list_nba: Close
[0m19:36:38.256704 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m19:36:38.265577 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:36:38.266535 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m19:36:38.267344 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:36:38.274241 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m19:36:38.275624 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:36:38.276923 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m19:36:38.281814 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.0 seconds
[0m19:36:38.284051 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m19:36:38.285988 [debug] [ThreadPool]: On list_nba_gold: Close
[0m19:36:38.296033 [debug] [MainThread]: Using postgres connection "master"
[0m19:36:38.297320 [debug] [MainThread]: On master: BEGIN
[0m19:36:38.298687 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:36:38.306699 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:36:38.307863 [debug] [MainThread]: Using postgres connection "master"
[0m19:36:38.309427 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m19:36:38.324532 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m19:36:38.327547 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0d3da0cc-925e-4c31-9fb7-060f5cc8ceef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7792af907e90>]}
[0m19:36:38.328817 [debug] [MainThread]: On master: ROLLBACK
[0m19:36:38.330196 [debug] [MainThread]: Using postgres connection "master"
[0m19:36:38.331014 [debug] [MainThread]: On master: BEGIN
[0m19:36:38.332623 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:36:38.333698 [debug] [MainThread]: On master: COMMIT
[0m19:36:38.334533 [debug] [MainThread]: Using postgres connection "master"
[0m19:36:38.335435 [debug] [MainThread]: On master: COMMIT
[0m19:36:38.336615 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:36:38.337615 [debug] [MainThread]: On master: Close
[0m19:36:38.339115 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m19:36:38.340161 [info ] [MainThread]: 
[0m19:36:38.346148 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m19:36:38.347663 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m19:36:38.349664 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m19:36:38.350853 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m19:36:38.361362 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m19:36:38.387031 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 19:36:38.351652 => 19:36:38.386647
[0m19:36:38.388320 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m19:36:38.436235 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m19:36:38.462032 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:36:38.463122 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m19:36:38.464066 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:36:38.470741 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:36:38.471991 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:36:38.473187 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
         else season end as season,
    team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m19:36:38.496209 [debug] [Thread-1 (]: SQL status: SELECT 211 in 0.0 seconds
[0m19:36:38.505763 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:36:38.506910 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m19:36:38.508913 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:36:38.513532 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:36:38.514663 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m19:36:38.516204 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:36:38.543094 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:36:38.544475 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:36:38.545558 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:36:38.551772 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:36:38.560871 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m19:36:38.568490 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:36:38.569491 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m19:36:38.576906 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:36:38.579445 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 19:36:38.389216 => 19:36:38.579186
[0m19:36:38.580378 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m19:36:38.581962 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d3da0cc-925e-4c31-9fb7-060f5cc8ceef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7792afdd87d0>]}
[0m19:36:38.583191 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 211[0m in 0.23s]
[0m19:36:38.584677 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m19:36:38.585900 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m19:36:38.586996 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m19:36:38.588327 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m19:36:38.589474 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m19:36:38.594719 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m19:36:38.619818 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 19:36:38.590335 => 19:36:38.619429
[0m19:36:38.620866 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m19:36:38.626721 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m19:36:38.651559 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:36:38.652581 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m19:36:38.653516 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:36:38.661753 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:36:38.662803 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:36:38.663765 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m19:36:38.681401 [debug] [Thread-1 (]: SQL status: SELECT 106 in 0.0 seconds
[0m19:36:38.685822 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:36:38.686790 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m19:36:38.688352 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:36:38.693916 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:36:38.695089 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m19:36:38.696691 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:36:38.699505 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:36:38.700507 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:36:38.701678 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:36:38.710285 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:36:38.714159 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m19:36:38.715591 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:36:38.716574 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m19:36:38.727161 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:36:38.729883 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 19:36:38.621637 => 19:36:38.729573
[0m19:36:38.730882 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m19:36:38.732436 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d3da0cc-925e-4c31-9fb7-060f5cc8ceef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7792afdcdaf0>]}
[0m19:36:38.733684 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 106[0m in 0.14s]
[0m19:36:38.735067 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m19:36:38.736181 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m19:36:38.737356 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m19:36:38.739030 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m19:36:38.741942 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m19:36:38.747984 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m19:36:38.771359 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 19:36:38.743407 => 19:36:38.770778
[0m19:36:38.772422 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m19:36:38.778434 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m19:36:38.804007 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:36:38.805286 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m19:36:38.806263 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:36:38.814308 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:36:38.815670 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:36:38.817201 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        season,
        AVG(fg_pct) AS avg_fg_pct,
        AVG(fg3_pct) AS avg_fg3_pct,
        AVG(tov) AS avg_turnovers,
        AVG(reb) AS avg_rebounds,
        AVG(blk) AS avg_blocks,
        AVG(stl) AS avg_steals,
        AVG(plus_minus) AS avg_plus_minus
    FROM "nba"."silver"."games"
    where team_name = 'San Antonio Spurs'
    GROUP BY season
),

team_averages AS (
    SELECT
        season,
        AVG(fg_pct) AS avg_league_fg_pct,
        AVG(fg3_pct) AS avg_league_fg3_pct,
        AVG(tov) AS avg_league_turnovers,
        AVG(reb) AS avg_league_rebounds,
        AVG(blk) AS avg_league_blocks,
        AVG(stl) AS avg_league_steals,
        AVG(plus_minus) AS avg_league_plus_minus
    FROM "nba"."silver"."games" -- Asume que 'games' incluye todos los partidos de la liga
    GROUP BY season
),

all_teams_stats AS (
    SELECT
        season,
        team_id,
        AVG(fg_pct) AS avg_fg_pct,
        AVG(fg3_pct) AS avg_fg3_pct,
        AVG(tov) AS avg_turnovers,
        AVG(reb) AS avg_rebounds,
        AVG(blk) AS avg_blocks,
        AVG(stl) AS avg_steals,
        AVG(plus_minus) AS avg_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_stl AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_stl,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    )
    WHERE rn = 1
),

SELECT
    ss.season,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season = ta.season
JOIN best_team_stats bts ON ss.season = bts.season
  );
  
[0m19:36:38.819564 [debug] [Thread-1 (]: Postgres adapter: Postgres error: subquery in FROM must have an alias
LINE 68:     FROM (
                  ^
HINT:  For example, FROM (SELECT ...) [AS] foo.

[0m19:36:38.820651 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: ROLLBACK
[0m19:36:38.822244 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 19:36:38.773182 => 19:36:38.821951
[0m19:36:38.823219 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m19:36:38.830511 [debug] [Thread-1 (]: Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  subquery in FROM must have an alias
  LINE 68:     FROM (
                    ^
  HINT:  For example, FROM (SELECT ...) [AS] foo.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m19:36:38.831645 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d3da0cc-925e-4c31-9fb7-060f5cc8ceef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7792afdf4680>]}
[0m19:36:38.832856 [error] [Thread-1 (]: 3 of 3 ERROR creating sql table model gold.team_weaknesses ..................... [[31mERROR[0m in 0.09s]
[0m19:36:38.834255 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m19:36:38.838553 [debug] [MainThread]: Using postgres connection "master"
[0m19:36:38.839571 [debug] [MainThread]: On master: BEGIN
[0m19:36:38.840552 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m19:36:38.849696 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:36:38.851074 [debug] [MainThread]: On master: COMMIT
[0m19:36:38.852100 [debug] [MainThread]: Using postgres connection "master"
[0m19:36:38.853134 [debug] [MainThread]: On master: COMMIT
[0m19:36:38.854465 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:36:38.855433 [debug] [MainThread]: On master: Close
[0m19:36:38.857261 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:36:38.859274 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m19:36:38.860637 [info ] [MainThread]: 
[0m19:36:38.861982 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.65 seconds (0.65s).
[0m19:36:38.863844 [debug] [MainThread]: Command end result
[0m19:36:38.932790 [info ] [MainThread]: 
[0m19:36:38.933879 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:36:38.934799 [info ] [MainThread]: 
[0m19:36:38.935714 [error] [MainThread]:   Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  subquery in FROM must have an alias
  LINE 68:     FROM (
                    ^
  HINT:  For example, FROM (SELECT ...) [AS] foo.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m19:36:38.936620 [info ] [MainThread]: 
[0m19:36:38.937577 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m19:36:38.939058 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.7803097, "process_user_time": 3.362959, "process_kernel_time": 0.387567, "process_mem_max_rss": "200876", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m19:36:38.940082 [debug] [MainThread]: Command `dbt run` failed at 19:36:38.939901 after 1.78 seconds
[0m19:36:38.940982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7792b168bef0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7792b1625b20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7792b16248f0>]}
[0m19:36:38.942878 [debug] [MainThread]: Flushing usage events
[0m19:38:33.399162 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79766ccb2060>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79766ccb3680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79766ccb2240>]}


============================== 19:38:33.404581 | 363f4e10-5049-4e84-be48-d13844087c0c ==============================
[0m19:38:33.404581 [info ] [MainThread]: Running with dbt=1.7.9
[0m19:38:33.405756 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m19:38:33.679122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '363f4e10-5049-4e84-be48-d13844087c0c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79766c310ef0>]}
[0m19:38:33.791653 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '363f4e10-5049-4e84-be48-d13844087c0c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79766ccdd5b0>]}
[0m19:38:33.793040 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m19:38:33.818424 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m19:38:34.057082 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:38:34.058402 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m19:38:34.377982 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m19:38:34.387561 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '363f4e10-5049-4e84-be48-d13844087c0c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79766b3db8f0>]}
[0m19:38:34.457129 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '363f4e10-5049-4e84-be48-d13844087c0c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79766bfc1850>]}
[0m19:38:34.458176 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m19:38:34.459249 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '363f4e10-5049-4e84-be48-d13844087c0c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79766bfc0c80>]}
[0m19:38:34.461907 [info ] [MainThread]: 
[0m19:38:34.463533 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m19:38:34.465720 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m19:38:34.480597 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m19:38:34.481712 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m19:38:34.482596 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:38:34.492971 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m19:38:34.495104 [debug] [ThreadPool]: On list_nba: Close
[0m19:38:34.498309 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m19:38:34.507851 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:38:34.508943 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m19:38:34.509798 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:38:34.517738 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m19:38:34.519226 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:38:34.520965 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m19:38:34.526071 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.0 seconds
[0m19:38:34.528259 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m19:38:34.529444 [debug] [ThreadPool]: On list_nba_gold: Close
[0m19:38:34.537263 [debug] [MainThread]: Using postgres connection "master"
[0m19:38:34.538326 [debug] [MainThread]: On master: BEGIN
[0m19:38:34.539378 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:38:34.547552 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:38:34.548609 [debug] [MainThread]: Using postgres connection "master"
[0m19:38:34.549530 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m19:38:34.565949 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m19:38:34.568698 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '363f4e10-5049-4e84-be48-d13844087c0c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79766d3eed80>]}
[0m19:38:34.570179 [debug] [MainThread]: On master: ROLLBACK
[0m19:38:34.571831 [debug] [MainThread]: Using postgres connection "master"
[0m19:38:34.572692 [debug] [MainThread]: On master: BEGIN
[0m19:38:34.574375 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:38:34.575280 [debug] [MainThread]: On master: COMMIT
[0m19:38:34.576086 [debug] [MainThread]: Using postgres connection "master"
[0m19:38:34.576861 [debug] [MainThread]: On master: COMMIT
[0m19:38:34.578004 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:38:34.578877 [debug] [MainThread]: On master: Close
[0m19:38:34.580425 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m19:38:34.581421 [info ] [MainThread]: 
[0m19:38:34.586660 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m19:38:34.588248 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m19:38:34.589867 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m19:38:34.591111 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m19:38:34.600707 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m19:38:34.625183 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 19:38:34.591912 => 19:38:34.624784
[0m19:38:34.626142 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m19:38:34.688091 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m19:38:34.713564 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:38:34.714548 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m19:38:34.715499 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:38:34.724079 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:38:34.725222 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:38:34.726252 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
         else season end as season,
    team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m19:38:34.747588 [debug] [Thread-1 (]: SQL status: SELECT 211 in 0.0 seconds
[0m19:38:34.758118 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:38:34.759428 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m19:38:34.761147 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:38:34.765501 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:38:34.766668 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m19:38:34.769739 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:38:34.809712 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:38:34.811254 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:38:34.812309 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:38:34.818390 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:38:34.828036 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m19:38:34.838689 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:38:34.839988 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m19:38:34.846625 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:38:34.849343 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 19:38:34.626920 => 19:38:34.849024
[0m19:38:34.850324 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m19:38:34.853117 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '363f4e10-5049-4e84-be48-d13844087c0c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79766b7e8980>]}
[0m19:38:34.855736 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 211[0m in 0.26s]
[0m19:38:34.857383 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m19:38:34.858776 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m19:38:34.860200 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m19:38:34.862222 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m19:38:34.863725 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m19:38:34.868794 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m19:38:34.894585 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 19:38:34.864550 => 19:38:34.894177
[0m19:38:34.895753 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m19:38:34.902021 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m19:38:34.927492 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:38:34.928585 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m19:38:34.929559 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:38:34.939097 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:38:34.940156 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:38:34.941118 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m19:38:34.962534 [debug] [Thread-1 (]: SQL status: SELECT 106 in 0.0 seconds
[0m19:38:34.967822 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:38:34.969088 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m19:38:34.970797 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:38:34.976060 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:38:34.977108 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m19:38:34.978572 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:38:34.981721 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:38:34.982784 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:38:34.983797 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:38:34.990254 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:38:34.994096 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m19:38:34.995617 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:38:34.996548 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m19:38:35.003363 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:38:35.006007 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 19:38:34.896599 => 19:38:35.005666
[0m19:38:35.007055 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m19:38:35.008612 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '363f4e10-5049-4e84-be48-d13844087c0c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79766bb11640>]}
[0m19:38:35.009812 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 106[0m in 0.15s]
[0m19:38:35.011258 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m19:38:35.012303 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m19:38:35.013359 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m19:38:35.014744 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m19:38:35.015835 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m19:38:35.022279 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m19:38:35.046489 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 19:38:35.016536 => 19:38:35.045938
[0m19:38:35.047892 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m19:38:35.056181 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m19:38:35.082701 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:38:35.083732 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m19:38:35.084967 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:38:35.093369 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:38:35.094437 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:38:35.095658 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        season,
        AVG(fg_pct) AS avg_fg_pct,
        AVG(fg3_pct) AS avg_fg3_pct,
        AVG(tov) AS avg_turnovers,
        AVG(reb) AS avg_rebounds,
        AVG(blk) AS avg_blocks,
        AVG(stl) AS avg_steals,
        AVG(plus_minus) AS avg_plus_minus
    FROM "nba"."silver"."games"
    where team_name = 'San Antonio Spurs'
    GROUP BY season
),

team_averages AS (
    SELECT
        season,
        AVG(fg_pct) AS avg_league_fg_pct,
        AVG(fg3_pct) AS avg_league_fg3_pct,
        AVG(tov) AS avg_league_turnovers,
        AVG(reb) AS avg_league_rebounds,
        AVG(blk) AS avg_league_blocks,
        AVG(stl) AS avg_league_steals,
        AVG(plus_minus) AS avg_league_plus_minus
    FROM "nba"."silver"."games" -- Asume que 'games' incluye todos los partidos de la liga
    GROUP BY season
),

all_teams_stats AS (
    SELECT
        season,
        team_id,
        AVG(fg_pct) AS avg_fg_pct,
        AVG(fg3_pct) AS avg_fg3_pct,
        AVG(tov) AS avg_turnovers,
        AVG(reb) AS avg_rebounds,
        AVG(blk) AS avg_blocks,
        AVG(stl) AS avg_steals,
        AVG(plus_minus) AS avg_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_stl AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_stl,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) x
    WHERE x.rn = 1
),

SELECT
    ss.season,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season = ta.season
JOIN best_team_stats bts ON ss.season = bts.season
  );
  
[0m19:38:35.097931 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "SELECT"
LINE 84: SELECT
         ^

[0m19:38:35.099308 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: ROLLBACK
[0m19:38:35.100795 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 19:38:35.048585 => 19:38:35.100478
[0m19:38:35.102532 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m19:38:35.108839 [debug] [Thread-1 (]: Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  syntax error at or near "SELECT"
  LINE 84: SELECT
           ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m19:38:35.109949 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '363f4e10-5049-4e84-be48-d13844087c0c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79766b78e420>]}
[0m19:38:35.111197 [error] [Thread-1 (]: 3 of 3 ERROR creating sql table model gold.team_weaknesses ..................... [[31mERROR[0m in 0.10s]
[0m19:38:35.112398 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m19:38:35.116552 [debug] [MainThread]: Using postgres connection "master"
[0m19:38:35.117495 [debug] [MainThread]: On master: BEGIN
[0m19:38:35.118504 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m19:38:35.126009 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:38:35.127229 [debug] [MainThread]: On master: COMMIT
[0m19:38:35.128371 [debug] [MainThread]: Using postgres connection "master"
[0m19:38:35.129289 [debug] [MainThread]: On master: COMMIT
[0m19:38:35.130927 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:38:35.132097 [debug] [MainThread]: On master: Close
[0m19:38:35.133732 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:38:35.135090 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m19:38:35.136911 [info ] [MainThread]: 
[0m19:38:35.138463 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.67 seconds (0.67s).
[0m19:38:35.140908 [debug] [MainThread]: Command end result
[0m19:38:35.194310 [info ] [MainThread]: 
[0m19:38:35.195344 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:38:35.196233 [info ] [MainThread]: 
[0m19:38:35.197030 [error] [MainThread]:   Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  syntax error at or near "SELECT"
  LINE 84: SELECT
           ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m19:38:35.197817 [info ] [MainThread]: 
[0m19:38:35.198582 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m19:38:35.200141 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.8838913, "process_user_time": 3.676298, "process_kernel_time": 0.38003, "process_mem_max_rss": "200872", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m19:38:35.201529 [debug] [MainThread]: Command `dbt run` failed at 19:38:35.200855 after 1.88 seconds
[0m19:38:35.203123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79766ccdd8b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79766cd19970>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79766af27650>]}
[0m19:38:35.204148 [debug] [MainThread]: Flushing usage events
[0m19:39:45.198143 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b7568c49b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b756600890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b7564b6450>]}


============================== 19:39:45.203004 | be4a586a-898a-4586-8ac8-fb7396c6886d ==============================
[0m19:39:45.203004 [info ] [MainThread]: Running with dbt=1.7.9
[0m19:39:45.204977 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:39:45.519862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'be4a586a-898a-4586-8ac8-fb7396c6886d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b7565e3ad0>]}
[0m19:39:45.634871 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'be4a586a-898a-4586-8ac8-fb7396c6886d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b7565b75c0>]}
[0m19:39:45.637371 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m19:39:45.664738 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m19:39:45.912282 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:39:45.913454 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m19:39:46.188512 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m19:39:46.197052 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'be4a586a-898a-4586-8ac8-fb7396c6886d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b754bd3380>]}
[0m19:39:46.271903 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'be4a586a-898a-4586-8ac8-fb7396c6886d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b7557b54c0>]}
[0m19:39:46.273538 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m19:39:46.274979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'be4a586a-898a-4586-8ac8-fb7396c6886d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b755b049e0>]}
[0m19:39:46.277919 [info ] [MainThread]: 
[0m19:39:46.279613 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m19:39:46.282264 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m19:39:46.314122 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m19:39:46.315232 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m19:39:46.316174 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:39:46.327091 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m19:39:46.329704 [debug] [ThreadPool]: On list_nba: Close
[0m19:39:46.333262 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m19:39:46.344753 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:39:46.345917 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m19:39:46.346763 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:39:46.353846 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m19:39:46.355673 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:39:46.356895 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m19:39:46.362106 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.0 seconds
[0m19:39:46.364894 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m19:39:46.366309 [debug] [ThreadPool]: On list_nba_gold: Close
[0m19:39:46.374901 [debug] [MainThread]: Using postgres connection "master"
[0m19:39:46.376237 [debug] [MainThread]: On master: BEGIN
[0m19:39:46.377169 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:39:46.385893 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:39:46.387282 [debug] [MainThread]: Using postgres connection "master"
[0m19:39:46.389301 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m19:39:46.407518 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m19:39:46.409874 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'be4a586a-898a-4586-8ac8-fb7396c6886d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b75534cc80>]}
[0m19:39:46.410940 [debug] [MainThread]: On master: ROLLBACK
[0m19:39:46.412301 [debug] [MainThread]: Using postgres connection "master"
[0m19:39:46.413318 [debug] [MainThread]: On master: BEGIN
[0m19:39:46.415088 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:39:46.416181 [debug] [MainThread]: On master: COMMIT
[0m19:39:46.417283 [debug] [MainThread]: Using postgres connection "master"
[0m19:39:46.418370 [debug] [MainThread]: On master: COMMIT
[0m19:39:46.422581 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:39:46.425894 [debug] [MainThread]: On master: Close
[0m19:39:46.428296 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m19:39:46.430028 [info ] [MainThread]: 
[0m19:39:46.439264 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m19:39:46.442403 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m19:39:46.444861 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m19:39:46.445844 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m19:39:46.456360 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m19:39:46.477982 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 19:39:46.446601 => 19:39:46.477574
[0m19:39:46.478893 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m19:39:46.530397 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m19:39:46.557978 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:39:46.559015 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m19:39:46.560050 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:39:46.568998 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:39:46.573085 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:39:46.574789 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
         else season end as season,
    team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m19:39:46.599613 [debug] [Thread-1 (]: SQL status: SELECT 211 in 0.0 seconds
[0m19:39:46.609730 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:39:46.610848 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m19:39:46.612347 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:39:46.616438 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:39:46.617457 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m19:39:46.619050 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:39:46.647881 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:39:46.649002 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:39:46.649956 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:39:46.656287 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:39:46.665526 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m19:39:46.675641 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:39:46.676878 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m19:39:46.684107 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:39:46.687922 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 19:39:46.479528 => 19:39:46.687380
[0m19:39:46.689873 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m19:39:46.691767 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'be4a586a-898a-4586-8ac8-fb7396c6886d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b754fdc770>]}
[0m19:39:46.693544 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 211[0m in 0.25s]
[0m19:39:46.700230 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m19:39:46.702400 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m19:39:46.703740 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m19:39:46.705830 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m19:39:46.706970 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m19:39:46.711631 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m19:39:46.747093 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 19:39:46.707816 => 19:39:46.746656
[0m19:39:46.748150 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m19:39:46.753342 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m19:39:46.779828 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:39:46.780930 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m19:39:46.781948 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:39:46.789065 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:39:46.790223 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:39:46.791185 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m19:39:46.811500 [debug] [Thread-1 (]: SQL status: SELECT 106 in 0.0 seconds
[0m19:39:46.815989 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:39:46.817125 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m19:39:46.818768 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:39:46.823862 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:39:46.825014 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m19:39:46.826724 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:39:46.829607 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:39:46.830753 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:39:46.831791 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:39:46.838967 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:39:46.850060 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m19:39:46.852808 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:39:46.855884 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m19:39:46.865300 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:39:46.867617 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 19:39:46.748951 => 19:39:46.867316
[0m19:39:46.868808 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m19:39:46.871287 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'be4a586a-898a-4586-8ac8-fb7396c6886d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b754fcda60>]}
[0m19:39:46.873867 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 106[0m in 0.17s]
[0m19:39:46.876218 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m19:39:46.878149 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m19:39:46.880124 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m19:39:46.882198 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m19:39:46.883437 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m19:39:46.890123 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m19:39:46.917500 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 19:39:46.884323 => 19:39:46.917117
[0m19:39:46.918636 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m19:39:46.926104 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m19:39:46.949612 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:39:46.950701 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m19:39:46.951567 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:39:46.959112 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:39:46.960246 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:39:46.961445 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        season,
        AVG(fg_pct) AS avg_fg_pct,
        AVG(fg3_pct) AS avg_fg3_pct,
        AVG(tov) AS avg_turnovers,
        AVG(reb) AS avg_rebounds,
        AVG(blk) AS avg_blocks,
        AVG(stl) AS avg_steals,
        AVG(plus_minus) AS avg_plus_minus
    FROM "nba"."silver"."games"
    where team_name = 'San Antonio Spurs'
    GROUP BY season
),

team_averages AS (
    SELECT
        season,
        AVG(fg_pct) AS avg_league_fg_pct,
        AVG(fg3_pct) AS avg_league_fg3_pct,
        AVG(tov) AS avg_league_turnovers,
        AVG(reb) AS avg_league_rebounds,
        AVG(blk) AS avg_league_blocks,
        AVG(stl) AS avg_league_steals,
        AVG(plus_minus) AS avg_league_plus_minus
    FROM "nba"."silver"."games" -- Asume que 'games' incluye todos los partidos de la liga
    GROUP BY season
),

all_teams_stats AS (
    SELECT
        season,
        team_id,
        AVG(fg_pct) AS avg_fg_pct,
        AVG(fg3_pct) AS avg_fg3_pct,
        AVG(tov) AS avg_turnovers,
        AVG(reb) AS avg_rebounds,
        AVG(blk) AS avg_blocks,
        AVG(stl) AS avg_steals,
        AVG(plus_minus) AS avg_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_stl AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_stl,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) x
    WHERE x.rn = 1
)

SELECT
    ss.season,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season = ta.season
JOIN best_team_stats bts ON ss.season = bts.season
  );
  
[0m19:39:46.963918 [debug] [Thread-1 (]: Postgres adapter: Postgres error: function avg(character varying) does not exist
LINE 17:         AVG(fg_pct) AS avg_fg_pct,
                 ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.

[0m19:39:46.965122 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: ROLLBACK
[0m19:39:46.966738 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 19:39:46.919522 => 19:39:46.966320
[0m19:39:46.967756 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m19:39:46.975324 [debug] [Thread-1 (]: Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  function avg(character varying) does not exist
  LINE 17:         AVG(fg_pct) AS avg_fg_pct,
                   ^
  HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m19:39:46.980141 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'be4a586a-898a-4586-8ac8-fb7396c6886d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b754fe8620>]}
[0m19:39:46.983385 [error] [Thread-1 (]: 3 of 3 ERROR creating sql table model gold.team_weaknesses ..................... [[31mERROR[0m in 0.10s]
[0m19:39:46.985612 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m19:39:46.995289 [debug] [MainThread]: Using postgres connection "master"
[0m19:39:46.996578 [debug] [MainThread]: On master: BEGIN
[0m19:39:46.997832 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m19:39:47.006044 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:39:47.007144 [debug] [MainThread]: On master: COMMIT
[0m19:39:47.008071 [debug] [MainThread]: Using postgres connection "master"
[0m19:39:47.008980 [debug] [MainThread]: On master: COMMIT
[0m19:39:47.010194 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:39:47.011117 [debug] [MainThread]: On master: Close
[0m19:39:47.012676 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:39:47.013652 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m19:39:47.014755 [info ] [MainThread]: 
[0m19:39:47.015947 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.74 seconds (0.74s).
[0m19:39:47.017739 [debug] [MainThread]: Command end result
[0m19:39:47.076678 [info ] [MainThread]: 
[0m19:39:47.077762 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:39:47.078684 [info ] [MainThread]: 
[0m19:39:47.079591 [error] [MainThread]:   Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  function avg(character varying) does not exist
  LINE 17:         AVG(fg_pct) AS avg_fg_pct,
                   ^
  HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m19:39:47.081216 [info ] [MainThread]: 
[0m19:39:47.082233 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m19:39:47.083851 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.9913766, "process_user_time": 3.620166, "process_kernel_time": 0.35476, "process_mem_max_rss": "200872", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m19:39:47.084899 [debug] [MainThread]: Command `dbt run` failed at 19:39:47.084715 after 1.99 seconds
[0m19:39:47.085822 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b7564b5ee0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b756831fa0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b75471da90>]}
[0m19:39:47.086879 [debug] [MainThread]: Flushing usage events
[0m19:47:18.853383 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78abe5381f10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78abe54125a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78abe54118e0>]}


============================== 19:47:18.857714 | 9f6b9ff7-b4dc-476a-b4ad-b10e0cdf22ec ==============================
[0m19:47:18.857714 [info ] [MainThread]: Running with dbt=1.7.9
[0m19:47:18.859056 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:47:19.135984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9f6b9ff7-b4dc-476a-b4ad-b10e0cdf22ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78abe5413ec0>]}
[0m19:47:19.245742 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9f6b9ff7-b4dc-476a-b4ad-b10e0cdf22ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78abe66a6d20>]}
[0m19:47:19.247173 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m19:47:19.270449 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m19:47:19.441722 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:47:19.443040 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m19:47:19.692205 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m19:47:19.700892 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9f6b9ff7-b4dc-476a-b4ad-b10e0cdf22ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78abe3dd7680>]}
[0m19:47:19.772043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9f6b9ff7-b4dc-476a-b4ad-b10e0cdf22ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78abe49ad8b0>]}
[0m19:47:19.773134 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m19:47:19.774121 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9f6b9ff7-b4dc-476a-b4ad-b10e0cdf22ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78abe49acd10>]}
[0m19:47:19.776918 [info ] [MainThread]: 
[0m19:47:19.778456 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m19:47:19.780897 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m19:47:19.794901 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m19:47:19.796007 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m19:47:19.797002 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:47:19.806734 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m19:47:19.808974 [debug] [ThreadPool]: On list_nba: Close
[0m19:47:19.812349 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m19:47:19.821199 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:47:19.822284 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m19:47:19.823152 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:47:19.829898 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m19:47:19.831208 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:47:19.832222 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m19:47:19.838237 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.0 seconds
[0m19:47:19.840487 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m19:47:19.841820 [debug] [ThreadPool]: On list_nba_gold: Close
[0m19:47:19.849683 [debug] [MainThread]: Using postgres connection "master"
[0m19:47:19.851301 [debug] [MainThread]: On master: BEGIN
[0m19:47:19.852359 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:47:19.859233 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:47:19.860345 [debug] [MainThread]: Using postgres connection "master"
[0m19:47:19.861369 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m19:47:19.876559 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m19:47:19.879067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9f6b9ff7-b4dc-476a-b4ad-b10e0cdf22ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78abe3d0bb00>]}
[0m19:47:19.880297 [debug] [MainThread]: On master: ROLLBACK
[0m19:47:19.881523 [debug] [MainThread]: Using postgres connection "master"
[0m19:47:19.882616 [debug] [MainThread]: On master: BEGIN
[0m19:47:19.885264 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:47:19.886509 [debug] [MainThread]: On master: COMMIT
[0m19:47:19.887478 [debug] [MainThread]: Using postgres connection "master"
[0m19:47:19.888468 [debug] [MainThread]: On master: COMMIT
[0m19:47:19.889721 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:47:19.890835 [debug] [MainThread]: On master: Close
[0m19:47:19.892561 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m19:47:19.893647 [info ] [MainThread]: 
[0m19:47:19.898196 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m19:47:19.899508 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m19:47:19.901461 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m19:47:19.902952 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m19:47:19.912442 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m19:47:19.938728 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 19:47:19.903895 => 19:47:19.938331
[0m19:47:19.939672 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m19:47:19.990928 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m19:47:20.018894 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:47:20.020041 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m19:47:20.021181 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:47:20.028906 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:47:20.030195 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:47:20.031373 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
         else season end as season,
    team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m19:47:20.057246 [debug] [Thread-1 (]: SQL status: SELECT 211 in 0.0 seconds
[0m19:47:20.066217 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:47:20.067804 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m19:47:20.069770 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:47:20.074160 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:47:20.075241 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m19:47:20.076691 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:47:20.107915 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:47:20.109133 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:47:20.110404 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:47:20.116725 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:47:20.128756 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m19:47:20.139804 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:47:20.141033 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m19:47:20.148488 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:47:20.152540 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 19:47:19.940393 => 19:47:20.152246
[0m19:47:20.153621 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m19:47:20.155477 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f6b9ff7-b4dc-476a-b4ad-b10e0cdf22ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78abe3db9eb0>]}
[0m19:47:20.156903 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 211[0m in 0.25s]
[0m19:47:20.158844 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m19:47:20.160066 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m19:47:20.161184 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m19:47:20.162900 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m19:47:20.163953 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m19:47:20.170583 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m19:47:20.197872 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 19:47:20.164857 => 19:47:20.197495
[0m19:47:20.199040 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m19:47:20.205830 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m19:47:20.232136 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:47:20.233316 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m19:47:20.234726 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:47:20.244527 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:47:20.245895 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:47:20.247104 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m19:47:20.269968 [debug] [Thread-1 (]: SQL status: SELECT 106 in 0.0 seconds
[0m19:47:20.275187 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:47:20.276526 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m19:47:20.278400 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:47:20.284032 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:47:20.285989 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m19:47:20.288393 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:47:20.295579 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:47:20.296976 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:47:20.298460 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:47:20.305714 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:47:20.309710 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m19:47:20.311153 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:47:20.312169 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m19:47:20.319357 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:47:20.321809 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 19:47:20.200210 => 19:47:20.321543
[0m19:47:20.322937 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m19:47:20.324379 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f6b9ff7-b4dc-476a-b4ad-b10e0cdf22ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78abe454c680>]}
[0m19:47:20.325651 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 106[0m in 0.16s]
[0m19:47:20.327292 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m19:47:20.328365 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m19:47:20.329407 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m19:47:20.330806 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m19:47:20.331775 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m19:47:20.338738 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m19:47:20.368402 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 19:47:20.332781 => 19:47:20.367643
[0m19:47:20.369716 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m19:47:20.375385 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m19:47:20.402285 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:47:20.403343 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m19:47:20.404304 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:47:20.411221 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:47:20.412402 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:47:20.413586 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season
),

all_teams_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    )
    WHERE rn = 1
)

SELECT
    ss.season,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season = ta.season
JOIN best_team_stats bts ON ss.season = bts.season
  );
  
[0m19:47:20.415714 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near ","
LINE 17:             else season end as season,,
                                               ^

[0m19:47:20.416924 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: ROLLBACK
[0m19:47:20.419131 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 19:47:20.370756 => 19:47:20.418783
[0m19:47:20.420199 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m19:47:20.425994 [debug] [Thread-1 (]: Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  syntax error at or near ","
  LINE 17:             else season end as season,,
                                                 ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m19:47:20.427244 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f6b9ff7-b4dc-476a-b4ad-b10e0cdf22ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78abe39322a0>]}
[0m19:47:20.428342 [error] [Thread-1 (]: 3 of 3 ERROR creating sql table model gold.team_weaknesses ..................... [[31mERROR[0m in 0.10s]
[0m19:47:20.429604 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m19:47:20.434211 [debug] [MainThread]: Using postgres connection "master"
[0m19:47:20.435933 [debug] [MainThread]: On master: BEGIN
[0m19:47:20.436929 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m19:47:20.444628 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:47:20.445743 [debug] [MainThread]: On master: COMMIT
[0m19:47:20.446743 [debug] [MainThread]: Using postgres connection "master"
[0m19:47:20.447697 [debug] [MainThread]: On master: COMMIT
[0m19:47:20.448971 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:47:20.449849 [debug] [MainThread]: On master: Close
[0m19:47:20.451860 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:47:20.453899 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m19:47:20.455117 [info ] [MainThread]: 
[0m19:47:20.456079 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.68 seconds (0.68s).
[0m19:47:20.457712 [debug] [MainThread]: Command end result
[0m19:47:20.515948 [info ] [MainThread]: 
[0m19:47:20.517146 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:47:20.518602 [info ] [MainThread]: 
[0m19:47:20.519664 [error] [MainThread]:   Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  syntax error at or near ","
  LINE 17:             else season end as season,,
                                                 ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m19:47:20.520649 [info ] [MainThread]: 
[0m19:47:20.521605 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m19:47:20.523260 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.7576768, "process_user_time": 3.421712, "process_kernel_time": 0.366043, "process_mem_max_rss": "200880", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m19:47:20.524296 [debug] [MainThread]: Command `dbt run` failed at 19:47:20.524098 after 1.76 seconds
[0m19:47:20.525258 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78abe9d0ef60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78abe4d6a0f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78abe54b2000>]}
[0m19:47:20.526227 [debug] [MainThread]: Flushing usage events
[0m19:48:30.216141 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d4f1138f80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d4f178a3c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d4f113a0c0>]}


============================== 19:48:30.221414 | 4d62bc2a-44b0-4758-92b4-90efe3b42bd7 ==============================
[0m19:48:30.221414 [info ] [MainThread]: Running with dbt=1.7.9
[0m19:48:30.222761 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m19:48:30.498158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4d62bc2a-44b0-4758-92b4-90efe3b42bd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d4f098a240>]}
[0m19:48:30.636631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4d62bc2a-44b0-4758-92b4-90efe3b42bd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d4f1195eb0>]}
[0m19:48:30.638194 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m19:48:30.666179 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m19:48:30.880532 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:48:30.881895 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m19:48:31.181267 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m19:48:31.190701 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4d62bc2a-44b0-4758-92b4-90efe3b42bd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d4ef593320>]}
[0m19:48:31.257336 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4d62bc2a-44b0-4758-92b4-90efe3b42bd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d4f0179100>]}
[0m19:48:31.258599 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m19:48:31.259641 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4d62bc2a-44b0-4758-92b4-90efe3b42bd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d4f19dde50>]}
[0m19:48:31.262459 [info ] [MainThread]: 
[0m19:48:31.264338 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m19:48:31.267477 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m19:48:31.282516 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m19:48:31.283573 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m19:48:31.284591 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:48:31.297708 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m19:48:31.299937 [debug] [ThreadPool]: On list_nba: Close
[0m19:48:31.304195 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m19:48:31.312325 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:48:31.313241 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m19:48:31.314094 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:48:31.322521 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m19:48:31.323583 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:48:31.324487 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m19:48:31.330201 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.0 seconds
[0m19:48:31.332341 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m19:48:31.333736 [debug] [ThreadPool]: On list_nba_gold: Close
[0m19:48:31.341203 [debug] [MainThread]: Using postgres connection "master"
[0m19:48:31.342355 [debug] [MainThread]: On master: BEGIN
[0m19:48:31.343212 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:48:31.351513 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:48:31.352967 [debug] [MainThread]: Using postgres connection "master"
[0m19:48:31.354028 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m19:48:31.371055 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m19:48:31.373355 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4d62bc2a-44b0-4758-92b4-90efe3b42bd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d4f215aa20>]}
[0m19:48:31.374603 [debug] [MainThread]: On master: ROLLBACK
[0m19:48:31.375915 [debug] [MainThread]: Using postgres connection "master"
[0m19:48:31.376890 [debug] [MainThread]: On master: BEGIN
[0m19:48:31.378802 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:48:31.379897 [debug] [MainThread]: On master: COMMIT
[0m19:48:31.380835 [debug] [MainThread]: Using postgres connection "master"
[0m19:48:31.381774 [debug] [MainThread]: On master: COMMIT
[0m19:48:31.383550 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:48:31.384861 [debug] [MainThread]: On master: Close
[0m19:48:31.387279 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m19:48:31.389531 [info ] [MainThread]: 
[0m19:48:31.394717 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m19:48:31.396201 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m19:48:31.398467 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m19:48:31.400075 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m19:48:31.412490 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m19:48:31.434984 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 19:48:31.401069 => 19:48:31.434218
[0m19:48:31.436383 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m19:48:31.489817 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m19:48:31.513676 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:48:31.514707 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m19:48:31.515664 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:48:31.523700 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:48:31.524651 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:48:31.525788 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
         else season end as season,
    team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m19:48:31.546948 [debug] [Thread-1 (]: SQL status: SELECT 211 in 0.0 seconds
[0m19:48:31.558172 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:48:31.559455 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m19:48:31.561178 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:48:31.565899 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:48:31.567197 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m19:48:31.569685 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:48:31.599361 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:48:31.600427 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:48:31.601654 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:48:31.608161 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:48:31.616607 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m19:48:31.625417 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:48:31.626549 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m19:48:31.633763 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:48:31.636955 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 19:48:31.437216 => 19:48:31.636671
[0m19:48:31.638162 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m19:48:31.639914 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d62bc2a-44b0-4758-92b4-90efe3b42bd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d4ef57a360>]}
[0m19:48:31.641116 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 211[0m in 0.24s]
[0m19:48:31.642581 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m19:48:31.643752 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m19:48:31.644917 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m19:48:31.646370 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m19:48:31.647436 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m19:48:31.653059 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m19:48:31.677280 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 19:48:31.648183 => 19:48:31.676879
[0m19:48:31.678296 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m19:48:31.684017 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m19:48:31.705300 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:48:31.706228 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m19:48:31.707055 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:48:31.712907 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:48:31.713860 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:48:31.714706 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m19:48:31.733194 [debug] [Thread-1 (]: SQL status: SELECT 106 in 0.0 seconds
[0m19:48:31.738688 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:48:31.739871 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m19:48:31.741619 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:48:31.746597 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:48:31.747724 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m19:48:31.749255 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:48:31.753021 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:48:31.754085 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:48:31.754918 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:48:31.761068 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:48:31.764751 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m19:48:31.766311 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:48:31.767627 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m19:48:31.775873 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:48:31.783997 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 19:48:31.679030 => 19:48:31.783111
[0m19:48:31.790292 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m19:48:31.794045 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d62bc2a-44b0-4758-92b4-90efe3b42bd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d4f01ca180>]}
[0m19:48:31.797186 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 106[0m in 0.15s]
[0m19:48:31.800117 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m19:48:31.804291 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m19:48:31.807025 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m19:48:31.813646 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m19:48:31.816686 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m19:48:31.829471 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m19:48:31.868968 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 19:48:31.819504 => 19:48:31.868404
[0m19:48:31.869961 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m19:48:31.875410 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m19:48:31.892677 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:48:31.893466 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m19:48:31.894204 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:48:31.901311 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:48:31.902845 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:48:31.903884 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season
),

all_teams_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    )
    WHERE rn = 1
)

SELECT
    ss.season,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season = ta.season
JOIN best_team_stats bts ON ss.season = bts.season
  );
  
[0m19:48:31.905782 [debug] [Thread-1 (]: Postgres adapter: Postgres error: subquery in FROM must have an alias
LINE 71:     FROM (
                  ^
HINT:  For example, FROM (SELECT ...) [AS] foo.

[0m19:48:31.906552 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: ROLLBACK
[0m19:48:31.907631 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 19:48:31.870553 => 19:48:31.907336
[0m19:48:31.908308 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m19:48:31.913381 [debug] [Thread-1 (]: Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  subquery in FROM must have an alias
  LINE 71:     FROM (
                    ^
  HINT:  For example, FROM (SELECT ...) [AS] foo.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m19:48:31.914322 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d62bc2a-44b0-4758-92b4-90efe3b42bd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d4ef569a90>]}
[0m19:48:31.915209 [error] [Thread-1 (]: 3 of 3 ERROR creating sql table model gold.team_weaknesses ..................... [[31mERROR[0m in 0.10s]
[0m19:48:31.916265 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m19:48:31.921045 [debug] [MainThread]: Using postgres connection "master"
[0m19:48:31.922122 [debug] [MainThread]: On master: BEGIN
[0m19:48:31.923004 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m19:48:31.928598 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:48:31.929450 [debug] [MainThread]: On master: COMMIT
[0m19:48:31.930164 [debug] [MainThread]: Using postgres connection "master"
[0m19:48:31.930839 [debug] [MainThread]: On master: COMMIT
[0m19:48:31.931673 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:48:31.932402 [debug] [MainThread]: On master: Close
[0m19:48:31.933855 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:48:31.934873 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m19:48:31.936040 [info ] [MainThread]: 
[0m19:48:31.936836 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.67 seconds (0.67s).
[0m19:48:31.938404 [debug] [MainThread]: Command end result
[0m19:48:31.988653 [info ] [MainThread]: 
[0m19:48:31.989735 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:48:31.990556 [info ] [MainThread]: 
[0m19:48:31.991378 [error] [MainThread]:   Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  subquery in FROM must have an alias
  LINE 71:     FROM (
                    ^
  HINT:  For example, FROM (SELECT ...) [AS] foo.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m19:48:31.992913 [info ] [MainThread]: 
[0m19:48:31.993839 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m19:48:31.995266 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.8809152, "process_user_time": 3.56235, "process_kernel_time": 0.362205, "process_mem_max_rss": "200880", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m19:48:31.996177 [debug] [MainThread]: Command `dbt run` failed at 19:48:31.996003 after 1.88 seconds
[0m19:48:31.996963 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d4f5afef30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d4f14e6de0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d4f1165490>]}
[0m19:48:31.997769 [debug] [MainThread]: Flushing usage events
[0m19:49:10.759238 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b3b5f8e510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b3b5f8eb40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b3b5f8e330>]}


============================== 19:49:10.764672 | 0100bdc4-40fa-4c48-8f7f-f3eeff1467dd ==============================
[0m19:49:10.764672 [info ] [MainThread]: Running with dbt=1.7.9
[0m19:49:10.765867 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m19:49:11.125321 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0100bdc4-40fa-4c48-8f7f-f3eeff1467dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b3b63983e0>]}
[0m19:49:11.241192 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0100bdc4-40fa-4c48-8f7f-f3eeff1467dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b3b63ce270>]}
[0m19:49:11.242606 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m19:49:11.267981 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m19:49:11.459762 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:49:11.461335 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m19:49:11.721068 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m19:49:11.730169 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0100bdc4-40fa-4c48-8f7f-f3eeff1467dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b3b49d7800>]}
[0m19:49:11.802579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0100bdc4-40fa-4c48-8f7f-f3eeff1467dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b3b55b94c0>]}
[0m19:49:11.803550 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m19:49:11.804586 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0100bdc4-40fa-4c48-8f7f-f3eeff1467dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b3b6e77b30>]}
[0m19:49:11.807446 [info ] [MainThread]: 
[0m19:49:11.809035 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m19:49:11.812046 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m19:49:11.827576 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m19:49:11.829255 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m19:49:11.830559 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:49:11.842505 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m19:49:11.845729 [debug] [ThreadPool]: On list_nba: Close
[0m19:49:11.849976 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m19:49:11.858831 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:49:11.859790 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m19:49:11.860709 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:49:11.869442 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m19:49:11.870673 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:49:11.871738 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m19:49:11.877772 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.0 seconds
[0m19:49:11.880898 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m19:49:11.882214 [debug] [ThreadPool]: On list_nba_gold: Close
[0m19:49:11.890381 [debug] [MainThread]: Using postgres connection "master"
[0m19:49:11.891437 [debug] [MainThread]: On master: BEGIN
[0m19:49:11.892528 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:49:11.901978 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:49:11.903218 [debug] [MainThread]: Using postgres connection "master"
[0m19:49:11.904632 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m19:49:11.920638 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m19:49:11.923031 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0100bdc4-40fa-4c48-8f7f-f3eeff1467dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b3b5108f20>]}
[0m19:49:11.924087 [debug] [MainThread]: On master: ROLLBACK
[0m19:49:11.925265 [debug] [MainThread]: Using postgres connection "master"
[0m19:49:11.926091 [debug] [MainThread]: On master: BEGIN
[0m19:49:11.927799 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:49:11.929786 [debug] [MainThread]: On master: COMMIT
[0m19:49:11.930930 [debug] [MainThread]: Using postgres connection "master"
[0m19:49:11.931753 [debug] [MainThread]: On master: COMMIT
[0m19:49:11.932903 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:49:11.933728 [debug] [MainThread]: On master: Close
[0m19:49:11.935418 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m19:49:11.936357 [info ] [MainThread]: 
[0m19:49:11.940990 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m19:49:11.942182 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m19:49:11.943792 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m19:49:11.945295 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m19:49:11.955206 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m19:49:11.976992 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 19:49:11.946646 => 19:49:11.976598
[0m19:49:11.978326 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m19:49:12.026723 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m19:49:12.067268 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:49:12.068434 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m19:49:12.069712 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:49:12.078329 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:49:12.079893 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:49:12.080821 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
         else season end as season,
    team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m19:49:12.104135 [debug] [Thread-1 (]: SQL status: SELECT 211 in 0.0 seconds
[0m19:49:12.114338 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:49:12.115347 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m19:49:12.116783 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:49:12.120958 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:49:12.121937 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m19:49:12.123273 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:49:12.150111 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:49:12.151294 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:49:12.153086 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:49:12.159351 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:49:12.170827 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m19:49:12.181213 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:49:12.182491 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m19:49:12.189434 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:49:12.191967 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 19:49:11.979679 => 19:49:12.191701
[0m19:49:12.193044 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m19:49:12.195385 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0100bdc4-40fa-4c48-8f7f-f3eeff1467dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b3b5f8e0c0>]}
[0m19:49:12.197032 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 211[0m in 0.25s]
[0m19:49:12.198537 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m19:49:12.199696 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m19:49:12.200733 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m19:49:12.202257 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m19:49:12.203302 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m19:49:12.207395 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m19:49:12.233254 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 19:49:12.204139 => 19:49:12.232847
[0m19:49:12.234185 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m19:49:12.239494 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m19:49:12.263455 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:49:12.264561 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m19:49:12.265625 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:49:12.272805 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:49:12.274081 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:49:12.275140 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m19:49:12.297786 [debug] [Thread-1 (]: SQL status: SELECT 106 in 0.0 seconds
[0m19:49:12.302406 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:49:12.303419 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m19:49:12.304994 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:49:12.309139 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:49:12.310287 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m19:49:12.312680 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:49:12.315919 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:49:12.316905 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:49:12.318077 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:49:12.325769 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:49:12.330863 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m19:49:12.332341 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:49:12.333444 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m19:49:12.340608 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:49:12.343206 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 19:49:12.234954 => 19:49:12.342935
[0m19:49:12.344489 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m19:49:12.346622 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0100bdc4-40fa-4c48-8f7f-f3eeff1467dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b3b5108230>]}
[0m19:49:12.347964 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 106[0m in 0.14s]
[0m19:49:12.349404 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m19:49:12.350599 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m19:49:12.351675 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m19:49:12.353017 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m19:49:12.354102 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m19:49:12.359561 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m19:49:12.386363 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 19:49:12.354863 => 19:49:12.385964
[0m19:49:12.387368 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m19:49:12.392750 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m19:49:12.417877 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:49:12.419162 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m19:49:12.420363 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:49:12.431043 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:49:12.432498 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:49:12.434751 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season
),

all_teams_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season = ta.season
JOIN best_team_stats bts ON ss.season = bts.season
  );
  
[0m19:49:12.478576 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m19:49:12.483854 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:49:12.484949 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m19:49:12.486552 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:49:12.489390 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m19:49:12.490450 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:49:12.491470 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m19:49:12.497376 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:49:12.503736 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m19:49:12.506429 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:49:12.507741 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m19:49:12.509710 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:49:12.513813 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 19:49:12.388137 => 19:49:12.513518
[0m19:49:12.515047 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m19:49:12.517065 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0100bdc4-40fa-4c48-8f7f-f3eeff1467dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b3b452f5c0>]}
[0m19:49:12.519661 [info ] [Thread-1 (]: 3 of 3 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 2[0m in 0.16s]
[0m19:49:12.521206 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m19:49:12.524772 [debug] [MainThread]: Using postgres connection "master"
[0m19:49:12.525637 [debug] [MainThread]: On master: BEGIN
[0m19:49:12.526659 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m19:49:12.535249 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:49:12.536614 [debug] [MainThread]: On master: COMMIT
[0m19:49:12.537629 [debug] [MainThread]: Using postgres connection "master"
[0m19:49:12.538744 [debug] [MainThread]: On master: COMMIT
[0m19:49:12.540046 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:49:12.541082 [debug] [MainThread]: On master: Close
[0m19:49:12.542646 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:49:12.545366 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m19:49:12.546828 [info ] [MainThread]: 
[0m19:49:12.548110 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.74 seconds (0.74s).
[0m19:49:12.550087 [debug] [MainThread]: Command end result
[0m19:49:12.622959 [info ] [MainThread]: 
[0m19:49:12.624028 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:49:12.624954 [info ] [MainThread]: 
[0m19:49:12.625957 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m19:49:12.627490 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 1.9539971, "process_user_time": 3.506438, "process_kernel_time": 0.355841, "process_mem_max_rss": "200872", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m19:49:12.628853 [debug] [MainThread]: Command `dbt run` succeeded at 19:49:12.628575 after 1.96 seconds
[0m19:49:12.629974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b3b59530b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b3ba916f60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b3b727a2a0>]}
[0m19:49:12.630971 [debug] [MainThread]: Flushing usage events
[0m19:50:16.941927 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c64dc17bfb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c64dc1792e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c64dc179a90>]}


============================== 19:50:16.946687 | 117c6baf-14b4-4b99-ad27-2b2b0ba6eed5 ==============================
[0m19:50:16.946687 [info ] [MainThread]: Running with dbt=1.7.9
[0m19:50:16.948093 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:50:17.236985 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '117c6baf-14b4-4b99-ad27-2b2b0ba6eed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c64dbfd9a90>]}
[0m19:50:17.356474 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '117c6baf-14b4-4b99-ad27-2b2b0ba6eed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c64dbb3f470>]}
[0m19:50:17.357793 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m19:50:17.382692 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m19:50:17.602775 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:50:17.604518 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/home_vs_away.sql
[0m19:50:18.028126 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m19:50:18.035617 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '117c6baf-14b4-4b99-ad27-2b2b0ba6eed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c64dabc4410>]}
[0m19:50:18.117951 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '117c6baf-14b4-4b99-ad27-2b2b0ba6eed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c64db7c4200>]}
[0m19:50:18.119135 [info ] [MainThread]: Found 3 models, 5 tests, 1 source, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m19:50:18.120018 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '117c6baf-14b4-4b99-ad27-2b2b0ba6eed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c64dabf64e0>]}
[0m19:50:18.122564 [info ] [MainThread]: 
[0m19:50:18.123939 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m19:50:18.126104 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m19:50:18.140803 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m19:50:18.141815 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m19:50:18.142594 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:50:18.152757 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m19:50:18.155231 [debug] [ThreadPool]: On list_nba: Close
[0m19:50:18.158633 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m19:50:18.167642 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:50:18.168689 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m19:50:18.169676 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:50:18.176695 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m19:50:18.177803 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m19:50:18.178708 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m19:50:18.183892 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m19:50:18.186106 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m19:50:18.187419 [debug] [ThreadPool]: On list_nba_gold: Close
[0m19:50:18.194348 [debug] [MainThread]: Using postgres connection "master"
[0m19:50:18.195524 [debug] [MainThread]: On master: BEGIN
[0m19:50:18.196441 [debug] [MainThread]: Opening a new connection, currently in state init
[0m19:50:18.204672 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:50:18.205886 [debug] [MainThread]: Using postgres connection "master"
[0m19:50:18.207021 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m19:50:18.223387 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m19:50:18.225706 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '117c6baf-14b4-4b99-ad27-2b2b0ba6eed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c64db318b30>]}
[0m19:50:18.226813 [debug] [MainThread]: On master: ROLLBACK
[0m19:50:18.228196 [debug] [MainThread]: Using postgres connection "master"
[0m19:50:18.229208 [debug] [MainThread]: On master: BEGIN
[0m19:50:18.231041 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:50:18.232252 [debug] [MainThread]: On master: COMMIT
[0m19:50:18.233814 [debug] [MainThread]: Using postgres connection "master"
[0m19:50:18.234797 [debug] [MainThread]: On master: COMMIT
[0m19:50:18.236083 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:50:18.237066 [debug] [MainThread]: On master: Close
[0m19:50:18.238706 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m19:50:18.239796 [info ] [MainThread]: 
[0m19:50:18.244639 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m19:50:18.245902 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m19:50:18.247444 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m19:50:18.248527 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m19:50:18.258206 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m19:50:18.284198 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 19:50:18.249658 => 19:50:18.283791
[0m19:50:18.285271 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m19:50:18.333054 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m19:50:18.357636 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:50:18.358597 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m19:50:18.359510 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:50:18.366368 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:50:18.367511 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:50:18.368502 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
         else season end as season,
    team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m19:50:18.392845 [debug] [Thread-1 (]: SQL status: SELECT 211 in 0.0 seconds
[0m19:50:18.401515 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:50:18.402627 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m19:50:18.404177 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:50:18.408304 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:50:18.409283 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m19:50:18.410713 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:50:18.439151 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:50:18.440211 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:50:18.441134 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m19:50:18.449393 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:50:18.457722 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m19:50:18.467308 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m19:50:18.468403 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m19:50:18.475302 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:50:18.477727 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 19:50:18.286004 => 19:50:18.477456
[0m19:50:18.478834 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m19:50:18.480354 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '117c6baf-14b4-4b99-ad27-2b2b0ba6eed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c64dbacbec0>]}
[0m19:50:18.481885 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 211[0m in 0.23s]
[0m19:50:18.484201 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m19:50:18.485308 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m19:50:18.486389 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m19:50:18.488071 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m19:50:18.489272 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m19:50:18.495058 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m19:50:18.521624 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 19:50:18.490126 => 19:50:18.521152
[0m19:50:18.522745 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m19:50:18.527850 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m19:50:18.552975 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:50:18.554018 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m19:50:18.554906 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:50:18.562469 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:50:18.563652 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:50:18.564696 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

with base as (
  select
    case when season like '2024' then '2024-2025'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from "nba"."silver"."games"
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m19:50:18.585562 [debug] [Thread-1 (]: SQL status: SELECT 106 in 0.0 seconds
[0m19:50:18.590036 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:50:18.591035 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m19:50:18.592576 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:50:18.596722 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:50:18.597768 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m19:50:18.599738 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:50:18.603129 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:50:18.604176 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:50:18.605257 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m19:50:18.612978 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:50:18.617975 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m19:50:18.619559 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m19:50:18.620555 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m19:50:18.627663 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:50:18.630082 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 19:50:18.523531 => 19:50:18.629818
[0m19:50:18.631082 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m19:50:18.633141 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '117c6baf-14b4-4b99-ad27-2b2b0ba6eed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c64da304530>]}
[0m19:50:18.634930 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 106[0m in 0.15s]
[0m19:50:18.636380 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m19:50:18.637452 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m19:50:18.638802 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m19:50:18.640143 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m19:50:18.641044 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m19:50:18.646168 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m19:50:18.674680 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 19:50:18.641806 => 19:50:18.674104
[0m19:50:18.675715 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m19:50:18.680885 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m19:50:18.706768 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:50:18.707782 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m19:50:18.708719 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m19:50:18.716264 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m19:50:18.717575 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:50:18.718858 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season
),

all_teams_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season = ta.season
JOIN best_team_stats bts ON ss.season = bts.season
  );
  
[0m19:50:18.750043 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m19:50:18.755104 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:50:18.756451 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m19:50:18.758009 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:50:18.762889 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:50:18.764101 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m19:50:18.766077 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m19:50:18.769443 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m19:50:18.770588 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:50:18.771573 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m19:50:18.779986 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m19:50:18.786387 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m19:50:18.787874 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m19:50:18.788873 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m19:50:18.795347 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m19:50:18.798078 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 19:50:18.676533 => 19:50:18.797744
[0m19:50:18.799407 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m19:50:18.801564 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '117c6baf-14b4-4b99-ad27-2b2b0ba6eed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c64da778050>]}
[0m19:50:18.803310 [info ] [Thread-1 (]: 3 of 3 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 2[0m in 0.16s]
[0m19:50:18.804891 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m19:50:18.808621 [debug] [MainThread]: Using postgres connection "master"
[0m19:50:18.809702 [debug] [MainThread]: On master: BEGIN
[0m19:50:18.810836 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m19:50:18.819414 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m19:50:18.820450 [debug] [MainThread]: On master: COMMIT
[0m19:50:18.821285 [debug] [MainThread]: Using postgres connection "master"
[0m19:50:18.822176 [debug] [MainThread]: On master: COMMIT
[0m19:50:18.823510 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m19:50:18.824391 [debug] [MainThread]: On master: Close
[0m19:50:18.825799 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:50:18.826757 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m19:50:18.828305 [info ] [MainThread]: 
[0m19:50:18.829403 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.70 seconds (0.70s).
[0m19:50:18.831226 [debug] [MainThread]: Command end result
[0m19:50:18.890767 [info ] [MainThread]: 
[0m19:50:18.891885 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:50:18.892964 [info ] [MainThread]: 
[0m19:50:18.893997 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m19:50:18.895651 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.0350003, "process_user_time": 3.651835, "process_kernel_time": 0.377222, "process_mem_max_rss": "200852", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m19:50:18.896758 [debug] [MainThread]: Command `dbt run` succeeded at 19:50:18.896554 after 2.04 seconds
[0m19:50:18.897796 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c64dc0c8860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c64dc2097f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c64dbacaa80>]}
[0m19:50:18.898945 [debug] [MainThread]: Flushing usage events
[0m19:58:08.426959 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7541490b3dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7541491ccce0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7541494c3530>]}


============================== 19:58:08.431280 | 7a133655-29de-49fa-b0b3-1fe091c55b17 ==============================
[0m19:58:08.431280 [info ] [MainThread]: Running with dbt=1.7.9
[0m19:58:08.432531 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m19:58:08.698616 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7a133655-29de-49fa-b0b3-1fe091c55b17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75414d62ccb0>]}
[0m19:58:08.810241 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7a133655-29de-49fa-b0b3-1fe091c55b17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7541494c1c40>]}
[0m19:58:08.811622 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m19:58:08.837790 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m19:58:09.050147 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 3 files changed.
[0m19:58:09.051390 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m19:58:09.052466 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/home_vs_away.sql
[0m19:58:09.053470 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/summary_by_season.sql
[0m19:58:09.481111 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.spurs_dbt.team_weaknesses' (models/spurs_analysis/team_weaknesses.sql) depends on a source named 'silver.teams' which was not found
[0m19:58:09.483220 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.1484963, "process_user_time": 3.346702, "process_kernel_time": 0.306052, "process_mem_max_rss": "200852", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m19:58:09.484321 [debug] [MainThread]: Command `dbt run` failed at 19:58:09.484135 after 1.15 seconds
[0m19:58:09.485350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75414a02efc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x754148f7f0e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75414778e810>]}
[0m19:58:09.486297 [debug] [MainThread]: Flushing usage events
[0m19:58:57.963316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb9c8de7d40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb9c9294a70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb9c8de4e00>]}


============================== 19:58:57.967471 | 2f5db2c2-1302-416a-87ff-eca40c08d952 ==============================
[0m19:58:57.967471 [info ] [MainThread]: Running with dbt=1.7.9
[0m19:58:57.968872 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m19:58:58.363633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2f5db2c2-1302-416a-87ff-eca40c08d952', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb9c8180ec0>]}
[0m19:58:58.557637 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2f5db2c2-1302-416a-87ff-eca40c08d952', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb9c7d46d80>]}
[0m19:58:58.558952 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m19:58:58.580494 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m19:58:58.779604 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 3 files changed.
[0m19:58:58.781060 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m19:58:58.784331 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/home_vs_away.sql
[0m19:58:58.785289 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/summary_by_season.sql
[0m19:58:59.224490 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.spurs_dbt.team_weaknesses' (models/spurs_analysis/team_weaknesses.sql) depends on a source named 'silver.teams' which was not found
[0m19:58:59.227158 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.3505348, "process_user_time": 3.517277, "process_kernel_time": 0.304456, "process_mem_max_rss": "200864", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m19:58:59.228798 [debug] [MainThread]: Command `dbt run` failed at 19:58:59.228399 after 1.35 seconds
[0m19:58:59.230217 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb9c9294a70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb9c75f85c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb9c6d1b7d0>]}
[0m19:58:59.231462 [debug] [MainThread]: Flushing usage events
[0m20:00:21.043731 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70fd3b76cf80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70fd3b76fad0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70fd3b76d100>]}


============================== 20:00:21.049252 | fded494c-faec-423f-b4d7-effca4e46f8b ==============================
[0m20:00:21.049252 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:00:21.050458 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:00:21.326204 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fded494c-faec-423f-b4d7-effca4e46f8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70fd3b86e630>]}
[0m20:00:21.437112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fded494c-faec-423f-b4d7-effca4e46f8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70fd3ca59820>]}
[0m20:00:21.438495 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:00:21.465174 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:00:21.644953 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 3 files changed.
[0m20:00:21.646624 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/home_vs_away.sql
[0m20:00:21.648520 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m20:00:21.649617 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/summary_by_season.sql
[0m20:00:22.033425 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.spurs_dbt.home_vs_away' (models/spurs_analysis/home_vs_away.sql) depends on a source named 'silver.teams' which was not found
[0m20:00:22.035392 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.077899, "process_user_time": 3.42164, "process_kernel_time": 0.287801, "process_mem_max_rss": "200876", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:00:22.036526 [debug] [MainThread]: Command `dbt run` failed at 20:00:22.036345 after 1.08 seconds
[0m20:00:22.037459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70fd3b79a120>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70fd3a1918e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70fd3a192e10>]}
[0m20:00:22.038397 [debug] [MainThread]: Flushing usage events
[0m20:01:29.030747 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x775f22cee180>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x775f22ced8b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x775f22cee240>]}


============================== 20:01:29.036177 | 7217d749-cba0-47cf-87a7-6ba2b95435e7 ==============================
[0m20:01:29.036177 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:01:29.037503 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:01:29.304714 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7217d749-cba0-47cf-87a7-6ba2b95435e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x775f22ba65a0>]}
[0m20:01:29.439327 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7217d749-cba0-47cf-87a7-6ba2b95435e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x775f23dfe120>]}
[0m20:01:29.440734 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:01:29.471148 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:01:29.663315 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 4 files changed.
[0m20:01:29.665317 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/sources.yml
[0m20:01:29.667103 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m20:01:29.668108 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/summary_by_season.sql
[0m20:01:29.669117 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/home_vs_away.sql
[0m20:01:30.168249 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:01:30.175103 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7217d749-cba0-47cf-87a7-6ba2b95435e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x775f21307680>]}
[0m20:01:30.243302 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7217d749-cba0-47cf-87a7-6ba2b95435e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x775f21fc0920>]}
[0m20:01:30.244423 [info ] [MainThread]: Found 3 models, 5 tests, 3 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:01:30.245405 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7217d749-cba0-47cf-87a7-6ba2b95435e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x775f21f6fe60>]}
[0m20:01:30.248134 [info ] [MainThread]: 
[0m20:01:30.250423 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:01:30.252955 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:01:30.267282 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:01:30.268278 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:01:30.269333 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:01:30.278202 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:01:30.280244 [debug] [ThreadPool]: On list_nba: Close
[0m20:01:30.284227 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:01:30.291601 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:01:30.292690 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:01:30.293573 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:01:30.301138 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:01:30.302209 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:01:30.303065 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:01:30.307585 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m20:01:30.309748 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:01:30.310939 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:01:30.318939 [debug] [MainThread]: Using postgres connection "master"
[0m20:01:30.319996 [debug] [MainThread]: On master: BEGIN
[0m20:01:30.320817 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:01:30.327326 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:01:30.328395 [debug] [MainThread]: Using postgres connection "master"
[0m20:01:30.329567 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:01:30.345296 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:01:30.347735 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7217d749-cba0-47cf-87a7-6ba2b95435e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x775f217ea6c0>]}
[0m20:01:30.349190 [debug] [MainThread]: On master: ROLLBACK
[0m20:01:30.350720 [debug] [MainThread]: Using postgres connection "master"
[0m20:01:30.351725 [debug] [MainThread]: On master: BEGIN
[0m20:01:30.353507 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:01:30.354539 [debug] [MainThread]: On master: COMMIT
[0m20:01:30.355485 [debug] [MainThread]: Using postgres connection "master"
[0m20:01:30.356417 [debug] [MainThread]: On master: COMMIT
[0m20:01:30.357814 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:01:30.358830 [debug] [MainThread]: On master: Close
[0m20:01:30.360328 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:01:30.361455 [info ] [MainThread]: 
[0m20:01:30.367701 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:01:30.368932 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:01:30.370397 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:01:30.371392 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:01:30.383019 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:01:30.564101 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:01:30.372256 => 20:01:30.563619
[0m20:01:30.565842 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:01:30.623051 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:01:30.649373 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:01:30.650986 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:01:30.652243 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:01:30.659299 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:01:30.660476 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:01:30.661718 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


with base as (
  select
    case when season like '2024' then '2024-2025'
         else season end as season,
    team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
),

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:01:30.663387 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "with"
LINE 22: with base as (
         ^

[0m20:01:30.664474 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: ROLLBACK
[0m20:01:30.666767 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:01:30.566838 => 20:01:30.666350
[0m20:01:30.667858 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:01:30.673343 [debug] [Thread-1 (]: Database Error in model home_vs_away (models/spurs_analysis/home_vs_away.sql)
  syntax error at or near "with"
  LINE 22: with base as (
           ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/home_vs_away.sql
[0m20:01:30.674564 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7217d749-cba0-47cf-87a7-6ba2b95435e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x775f20b016d0>]}
[0m20:01:30.675822 [error] [Thread-1 (]: 1 of 3 ERROR creating sql table model gold.home_vs_away ........................ [[31mERROR[0m in 0.30s]
[0m20:01:30.677105 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:01:30.678229 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:01:30.679905 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:01:30.681636 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m20:01:30.683371 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:01:30.688345 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:01:30.713600 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:01:30.684238 => 20:01:30.713216
[0m20:01:30.714796 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:01:30.720689 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:01:30.744784 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:01:30.745826 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:01:30.746788 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:01:30.754299 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:01:30.755403 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:01:30.756323 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

with base as (
  select
    case when season like '2024' then '2024-2025'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m20:01:30.758120 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "with"
LINE 22: with base as (
         ^

[0m20:01:30.759188 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: ROLLBACK
[0m20:01:30.760828 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:01:30.715893 => 20:01:30.760420
[0m20:01:30.761830 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:01:30.766240 [debug] [Thread-1 (]: Database Error in model summary_by_season (models/spurs_analysis/summary_by_season.sql)
  syntax error at or near "with"
  LINE 22: with base as (
           ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/summary_by_season.sql
[0m20:01:30.767533 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7217d749-cba0-47cf-87a7-6ba2b95435e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x775f20b566c0>]}
[0m20:01:30.768851 [error] [Thread-1 (]: 2 of 3 ERROR creating sql table model gold.summary_by_season ................... [[31mERROR[0m in 0.09s]
[0m20:01:30.770097 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:01:30.771158 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:01:30.772228 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:01:30.773721 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:01:30.774735 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:01:30.779783 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:01:30.806330 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:01:30.775596 => 20:01:30.805955
[0m20:01:30.807339 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:01:30.812588 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:01:30.838370 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:01:30.839442 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:01:30.840422 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:01:30.848726 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:01:30.850438 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:01:30.851705 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season
),

all_teams_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season = ta.season
JOIN best_team_stats bts ON ss.season = bts.season
  );
  
[0m20:01:30.853842 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "WITH"
LINE 22: WITH spurs_stats AS (
         ^

[0m20:01:30.855031 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: ROLLBACK
[0m20:01:30.856881 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:01:30.808080 => 20:01:30.856382
[0m20:01:30.857997 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:01:30.862033 [debug] [Thread-1 (]: Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  syntax error at or near "WITH"
  LINE 22: WITH spurs_stats AS (
           ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m20:01:30.863294 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7217d749-cba0-47cf-87a7-6ba2b95435e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x775f20bf1610>]}
[0m20:01:30.864636 [error] [Thread-1 (]: 3 of 3 ERROR creating sql table model gold.team_weaknesses ..................... [[31mERROR[0m in 0.09s]
[0m20:01:30.866700 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:01:30.870201 [debug] [MainThread]: Using postgres connection "master"
[0m20:01:30.871277 [debug] [MainThread]: On master: BEGIN
[0m20:01:30.872306 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:01:30.879845 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:01:30.881197 [debug] [MainThread]: On master: COMMIT
[0m20:01:30.882979 [debug] [MainThread]: Using postgres connection "master"
[0m20:01:30.884146 [debug] [MainThread]: On master: COMMIT
[0m20:01:30.885838 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:01:30.887048 [debug] [MainThread]: On master: Close
[0m20:01:30.888792 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:01:30.890000 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m20:01:30.891206 [info ] [MainThread]: 
[0m20:01:30.892378 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.64 seconds (0.64s).
[0m20:01:30.894643 [debug] [MainThread]: Command end result
[0m20:01:30.958475 [info ] [MainThread]: 
[0m20:01:30.959720 [info ] [MainThread]: [31mCompleted with 3 errors and 0 warnings:[0m
[0m20:01:30.961062 [info ] [MainThread]: 
[0m20:01:30.962839 [error] [MainThread]:   Database Error in model home_vs_away (models/spurs_analysis/home_vs_away.sql)
  syntax error at or near "with"
  LINE 22: with base as (
           ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/home_vs_away.sql
[0m20:01:30.964232 [info ] [MainThread]: 
[0m20:01:30.966470 [error] [MainThread]:   Database Error in model summary_by_season (models/spurs_analysis/summary_by_season.sql)
  syntax error at or near "with"
  LINE 22: with base as (
           ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/summary_by_season.sql
[0m20:01:30.967889 [info ] [MainThread]: 
[0m20:01:30.969103 [error] [MainThread]:   Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  syntax error at or near "WITH"
  LINE 22: WITH spurs_stats AS (
           ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m20:01:30.970392 [info ] [MainThread]: 
[0m20:01:30.971590 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=3 SKIP=0 TOTAL=3
[0m20:01:30.973766 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.0279253, "process_user_time": 3.637023, "process_kernel_time": 0.3561, "process_mem_max_rss": "200876", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:01:30.975201 [debug] [MainThread]: Command `dbt run` failed at 20:01:30.974932 after 2.03 seconds
[0m20:01:30.976464 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x775f22cee180>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x775f20b56690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x775f20b566f0>]}
[0m20:01:30.977774 [debug] [MainThread]: Flushing usage events
[0m20:05:07.331764 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d761215a6f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d761215b620>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d761215a450>]}


============================== 20:05:07.335879 | 05892200-8f33-4910-ad71-20c688153ca3 ==============================
[0m20:05:07.335879 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:05:07.337050 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:05:07.616759 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '05892200-8f33-4910-ad71-20c688153ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7611fbd970>]}
[0m20:05:07.738340 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '05892200-8f33-4910-ad71-20c688153ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d761202a3f0>]}
[0m20:05:07.740138 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:05:07.767334 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:05:08.044998 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 3 files changed.
[0m20:05:08.046578 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/summary_by_season.sql
[0m20:05:08.047742 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/home_vs_away.sql
[0m20:05:08.048837 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m20:05:08.457632 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:05:08.464426 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '05892200-8f33-4910-ad71-20c688153ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d76121ed430>]}
[0m20:05:08.534738 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '05892200-8f33-4910-ad71-20c688153ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7610741970>]}
[0m20:05:08.535879 [info ] [MainThread]: Found 3 models, 5 tests, 3 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:05:08.537072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '05892200-8f33-4910-ad71-20c688153ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7611aebfb0>]}
[0m20:05:08.540381 [info ] [MainThread]: 
[0m20:05:08.542389 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:05:08.544855 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:05:08.559026 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:05:08.560189 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:05:08.561125 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:05:08.570303 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:05:08.572431 [debug] [ThreadPool]: On list_nba: Close
[0m20:05:08.576476 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:05:08.584150 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:05:08.585246 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:05:08.586282 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:05:08.593877 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:05:08.595015 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:05:08.596076 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:05:08.600656 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m20:05:08.602940 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:05:08.604251 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:05:08.612094 [debug] [MainThread]: Using postgres connection "master"
[0m20:05:08.613084 [debug] [MainThread]: On master: BEGIN
[0m20:05:08.614015 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:05:08.620421 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:05:08.621513 [debug] [MainThread]: Using postgres connection "master"
[0m20:05:08.622553 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:05:08.637641 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:05:08.640854 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '05892200-8f33-4910-ad71-20c688153ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d761207ebd0>]}
[0m20:05:08.642344 [debug] [MainThread]: On master: ROLLBACK
[0m20:05:08.643708 [debug] [MainThread]: Using postgres connection "master"
[0m20:05:08.644619 [debug] [MainThread]: On master: BEGIN
[0m20:05:08.646366 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:05:08.647392 [debug] [MainThread]: On master: COMMIT
[0m20:05:08.648300 [debug] [MainThread]: Using postgres connection "master"
[0m20:05:08.649230 [debug] [MainThread]: On master: COMMIT
[0m20:05:08.650535 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:05:08.651444 [debug] [MainThread]: On master: Close
[0m20:05:08.652884 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:05:08.653979 [info ] [MainThread]: 
[0m20:05:08.659822 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:05:08.660982 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:05:08.662444 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:05:08.663449 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:05:08.674047 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:05:08.700632 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:05:08.664242 => 20:05:08.700259
[0m20:05:08.701622 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:05:08.750365 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:05:08.778360 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:05:08.779431 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:05:08.780405 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:05:08.787380 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:05:08.788506 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:05:08.789535 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-2025'
         else season end as season,
    team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
),

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:05:08.791825 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "select"
LINE 36: select
         ^

[0m20:05:08.792986 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: ROLLBACK
[0m20:05:08.794686 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:05:08.702453 => 20:05:08.794389
[0m20:05:08.795712 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:05:08.801023 [debug] [Thread-1 (]: Database Error in model home_vs_away (models/spurs_analysis/home_vs_away.sql)
  syntax error at or near "select"
  LINE 36: select
           ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/home_vs_away.sql
[0m20:05:08.802271 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '05892200-8f33-4910-ad71-20c688153ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7610787770>]}
[0m20:05:08.803542 [error] [Thread-1 (]: 1 of 3 ERROR creating sql table model gold.home_vs_away ........................ [[31mERROR[0m in 0.14s]
[0m20:05:08.804892 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:05:08.806134 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:05:08.809237 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:05:08.810864 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m20:05:08.812028 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:05:08.817120 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:05:08.845759 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:05:08.812960 => 20:05:08.845381
[0m20:05:08.846942 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:05:08.852160 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:05:08.879180 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:05:08.880191 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:05:08.881104 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:05:08.888019 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:05:08.889104 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:05:08.891081 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-2025'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m20:05:08.913684 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:05:08.922035 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:05:08.923152 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:05:08.925328 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:05:08.932072 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:05:08.933168 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:05:08.934638 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:05:08.962732 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:05:08.963940 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:05:08.964822 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:05:08.987821 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:05:08.997116 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:05:09.004925 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:05:09.006204 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:05:09.013940 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:05:09.016433 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:05:08.847702 => 20:05:09.016168
[0m20:05:09.017525 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:05:09.019089 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '05892200-8f33-4910-ad71-20c688153ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7610363170>]}
[0m20:05:09.020304 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 52[0m in 0.21s]
[0m20:05:09.021673 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:05:09.023604 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:05:09.025300 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:05:09.027047 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:05:09.028139 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:05:09.032837 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:05:09.061367 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:05:09.028979 => 20:05:09.060981
[0m20:05:09.062462 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:05:09.068737 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:05:09.097654 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:05:09.098846 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:05:09.099846 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:05:09.107015 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:05:09.108681 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:05:09.109987 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season
),

all_teams_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season = ta.season
JOIN best_team_stats bts ON ss.season = bts.season
  );
  
[0m20:05:09.144636 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m20:05:09.149041 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:05:09.150156 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m20:05:09.151776 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:05:09.155816 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:05:09.157499 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m20:05:09.159481 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:05:09.162708 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:05:09.163806 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:05:09.164852 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:05:09.171239 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:05:09.175853 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m20:05:09.177550 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:05:09.178649 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m20:05:09.185778 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:05:09.188690 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:05:09.063324 => 20:05:09.188339
[0m20:05:09.189795 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:05:09.191924 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '05892200-8f33-4910-ad71-20c688153ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7610799040>]}
[0m20:05:09.193201 [info ] [Thread-1 (]: 3 of 3 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 2[0m in 0.17s]
[0m20:05:09.195189 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:05:09.200692 [debug] [MainThread]: Using postgres connection "master"
[0m20:05:09.202570 [debug] [MainThread]: On master: BEGIN
[0m20:05:09.204190 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:05:09.217194 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:05:09.219140 [debug] [MainThread]: On master: COMMIT
[0m20:05:09.220827 [debug] [MainThread]: Using postgres connection "master"
[0m20:05:09.222469 [debug] [MainThread]: On master: COMMIT
[0m20:05:09.224890 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:05:09.226740 [debug] [MainThread]: On master: Close
[0m20:05:09.229389 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:05:09.231172 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m20:05:09.232905 [info ] [MainThread]: 
[0m20:05:09.234823 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.69 seconds (0.69s).
[0m20:05:09.238182 [debug] [MainThread]: Command end result
[0m20:05:09.304964 [info ] [MainThread]: 
[0m20:05:09.306178 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:05:09.307844 [info ] [MainThread]: 
[0m20:05:09.308900 [error] [MainThread]:   Database Error in model home_vs_away (models/spurs_analysis/home_vs_away.sql)
  syntax error at or near "select"
  LINE 36: select
           ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/home_vs_away.sql
[0m20:05:09.310708 [info ] [MainThread]: 
[0m20:05:09.311948 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m20:05:09.313580 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.0680845, "process_user_time": 3.637321, "process_kernel_time": 0.333957, "process_mem_max_rss": "200860", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:05:09.314825 [debug] [MainThread]: Command `dbt run` failed at 20:05:09.314612 after 2.07 seconds
[0m20:05:09.315835 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d761215a6f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7610f0b740>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7610be7170>]}
[0m20:05:09.316758 [debug] [MainThread]: Flushing usage events
[0m20:06:23.453531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75d1d2aed0a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75d1d2aef3e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75d1d2aed1c0>]}


============================== 20:06:23.458103 | e0a38ce3-641e-4f02-b7ea-b6161f962452 ==============================
[0m20:06:23.458103 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:06:23.460127 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:06:23.761271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e0a38ce3-641e-4f02-b7ea-b6161f962452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75d1d2a0e930>]}
[0m20:06:23.891468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e0a38ce3-641e-4f02-b7ea-b6161f962452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75d1d2ed8470>]}
[0m20:06:23.893836 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:06:23.919711 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:06:24.205847 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:06:24.207271 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/home_vs_away.sql
[0m20:06:24.651305 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:06:24.659516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e0a38ce3-641e-4f02-b7ea-b6161f962452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75d1d29a6f30>]}
[0m20:06:24.729522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e0a38ce3-641e-4f02-b7ea-b6161f962452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75d1d1db0170>]}
[0m20:06:24.730874 [info ] [MainThread]: Found 3 models, 5 tests, 3 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:06:24.732208 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e0a38ce3-641e-4f02-b7ea-b6161f962452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75d1d21a70e0>]}
[0m20:06:24.735434 [info ] [MainThread]: 
[0m20:06:24.737884 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:06:24.740908 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:06:24.759961 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:06:24.760939 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:06:24.761707 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:06:24.770187 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:06:24.772175 [debug] [ThreadPool]: On list_nba: Close
[0m20:06:24.775577 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:06:24.783438 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:06:24.784325 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:06:24.785202 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:06:24.791773 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:06:24.793540 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:06:24.794428 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:06:24.798933 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m20:06:24.801116 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:06:24.802299 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:06:24.809964 [debug] [MainThread]: Using postgres connection "master"
[0m20:06:24.810882 [debug] [MainThread]: On master: BEGIN
[0m20:06:24.811608 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:06:24.817674 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:06:24.818654 [debug] [MainThread]: Using postgres connection "master"
[0m20:06:24.819502 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:06:24.835244 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:06:24.837573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e0a38ce3-641e-4f02-b7ea-b6161f962452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75d1d3232ba0>]}
[0m20:06:24.838675 [debug] [MainThread]: On master: ROLLBACK
[0m20:06:24.839892 [debug] [MainThread]: Using postgres connection "master"
[0m20:06:24.840821 [debug] [MainThread]: On master: BEGIN
[0m20:06:24.843235 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:06:24.844296 [debug] [MainThread]: On master: COMMIT
[0m20:06:24.845275 [debug] [MainThread]: Using postgres connection "master"
[0m20:06:24.846042 [debug] [MainThread]: On master: COMMIT
[0m20:06:24.847171 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:06:24.847988 [debug] [MainThread]: On master: Close
[0m20:06:24.849462 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:06:24.850575 [info ] [MainThread]: 
[0m20:06:24.855345 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:06:24.856594 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:06:24.858054 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:06:24.859577 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:06:24.869281 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:06:24.894062 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:06:24.860756 => 20:06:24.893677
[0m20:06:24.895143 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:06:24.943421 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:06:24.970973 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:06:24.972013 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:06:24.972890 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:06:24.980627 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:06:24.981708 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:06:24.982673 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-2025'
         else season end as season,
    team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:06:25.002303 [debug] [Thread-1 (]: SQL status: SELECT 104 in 0.0 seconds
[0m20:06:25.011608 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:06:25.012725 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m20:06:25.014275 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:06:25.018423 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:06:25.019452 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m20:06:25.021099 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:06:25.048363 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:06:25.049682 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:06:25.050717 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:06:25.057323 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:06:25.066612 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m20:06:25.074198 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:06:25.075556 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m20:06:25.084329 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:06:25.086782 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:06:24.895971 => 20:06:25.086527
[0m20:06:25.087680 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:06:25.089281 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0a38ce3-641e-4f02-b7ea-b6161f962452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75d1d0d8ff80>]}
[0m20:06:25.090478 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 104[0m in 0.23s]
[0m20:06:25.093287 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:06:25.094842 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:06:25.095854 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:06:25.097388 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m20:06:25.098391 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:06:25.104246 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:06:25.127426 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:06:25.099204 => 20:06:25.127054
[0m20:06:25.128710 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:06:25.134660 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:06:25.161368 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:06:25.162350 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:06:25.163324 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:06:25.170540 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:06:25.171664 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:06:25.172785 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-2025'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m20:06:25.190880 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:06:25.196075 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:06:25.197064 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:06:25.198481 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:06:25.202568 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:06:25.203484 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:06:25.204867 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:06:25.207698 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:06:25.209074 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:06:25.210456 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:06:25.216208 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:06:25.220182 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:06:25.221676 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:06:25.222556 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:06:25.229289 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:06:25.231661 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:06:25.129611 => 20:06:25.231393
[0m20:06:25.232648 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:06:25.234243 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0a38ce3-641e-4f02-b7ea-b6161f962452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75d1d0d5ecc0>]}
[0m20:06:25.235440 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 52[0m in 0.14s]
[0m20:06:25.237082 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:06:25.238150 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:06:25.239275 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:06:25.240777 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:06:25.242075 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:06:25.247992 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:06:25.269473 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:06:25.243743 => 20:06:25.268361
[0m20:06:25.270483 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:06:25.277166 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:06:25.304788 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:06:25.305986 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:06:25.306891 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:06:25.314985 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:06:25.316260 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:06:25.317552 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season
),

all_teams_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season = ta.season
JOIN best_team_stats bts ON ss.season = bts.season
  );
  
[0m20:06:25.350085 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m20:06:25.354237 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:06:25.355076 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m20:06:25.356382 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:06:25.361854 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:06:25.362807 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m20:06:25.364104 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:06:25.366780 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:06:25.367613 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:06:25.368408 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:06:25.374344 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:06:25.379009 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m20:06:25.380374 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:06:25.381315 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m20:06:25.387491 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:06:25.389811 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:06:25.271188 => 20:06:25.389548
[0m20:06:25.390772 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:06:25.392780 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0a38ce3-641e-4f02-b7ea-b6161f962452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75d1d11df6e0>]}
[0m20:06:25.394316 [info ] [Thread-1 (]: 3 of 3 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 2[0m in 0.15s]
[0m20:06:25.395698 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:06:25.399013 [debug] [MainThread]: Using postgres connection "master"
[0m20:06:25.399775 [debug] [MainThread]: On master: BEGIN
[0m20:06:25.400632 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:06:25.407322 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:06:25.408425 [debug] [MainThread]: On master: COMMIT
[0m20:06:25.410190 [debug] [MainThread]: Using postgres connection "master"
[0m20:06:25.411015 [debug] [MainThread]: On master: COMMIT
[0m20:06:25.509921 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:06:25.512999 [debug] [MainThread]: On master: Close
[0m20:06:25.517813 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:06:25.522193 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m20:06:25.524260 [info ] [MainThread]: 
[0m20:06:25.527814 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.79 seconds (0.79s).
[0m20:06:25.531986 [debug] [MainThread]: Command end result
[0m20:06:25.603234 [info ] [MainThread]: 
[0m20:06:25.604293 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:06:25.605195 [info ] [MainThread]: 
[0m20:06:25.606063 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m20:06:25.607487 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.2424135, "process_user_time": 3.863442, "process_kernel_time": 0.376725, "process_mem_max_rss": "200876", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:06:25.608878 [debug] [MainThread]: Command `dbt run` succeeded at 20:06:25.608478 after 2.24 seconds
[0m20:06:25.610593 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75d1d2aef3e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75d1d21a70e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75d1d2b1af30>]}
[0m20:06:25.611695 [debug] [MainThread]: Flushing usage events
[0m20:08:37.375956 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b2117a64ec0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b2117afe150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b2117e58530>]}


============================== 20:08:37.380047 | 666eefb9-a832-4ed0-98c7-4e4c1949d109 ==============================
[0m20:08:37.380047 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:08:37.381789 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:08:37.642216 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '666eefb9-a832-4ed0-98c7-4e4c1949d109', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b2117ac5370>]}
[0m20:08:37.771236 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '666eefb9-a832-4ed0-98c7-4e4c1949d109', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b2117b6e600>]}
[0m20:08:37.772521 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:08:37.796331 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:08:37.976353 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:08:37.977585 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/home_vs_away.sql
[0m20:08:38.361114 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:08:38.368796 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '666eefb9-a832-4ed0-98c7-4e4c1949d109', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b2116b63aa0>]}
[0m20:08:38.438691 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '666eefb9-a832-4ed0-98c7-4e4c1949d109', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b2116768440>]}
[0m20:08:38.439715 [info ] [MainThread]: Found 3 models, 5 tests, 3 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:08:38.440773 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '666eefb9-a832-4ed0-98c7-4e4c1949d109', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b21163d8f80>]}
[0m20:08:38.443614 [info ] [MainThread]: 
[0m20:08:38.445134 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:08:38.447614 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:08:38.462772 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:08:38.464020 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:08:38.464977 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:08:38.474214 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:08:38.476523 [debug] [ThreadPool]: On list_nba: Close
[0m20:08:38.479800 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:08:38.490314 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:08:38.491584 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:08:38.492535 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:08:38.500080 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:08:38.501013 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:08:38.501890 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:08:38.506939 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m20:08:38.509420 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:08:38.510928 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:08:38.520740 [debug] [MainThread]: Using postgres connection "master"
[0m20:08:38.521863 [debug] [MainThread]: On master: BEGIN
[0m20:08:38.522952 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:08:38.532202 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:08:38.534161 [debug] [MainThread]: Using postgres connection "master"
[0m20:08:38.535607 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:08:38.554985 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:08:38.557365 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '666eefb9-a832-4ed0-98c7-4e4c1949d109', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b2116b06b10>]}
[0m20:08:38.558854 [debug] [MainThread]: On master: ROLLBACK
[0m20:08:38.560386 [debug] [MainThread]: Using postgres connection "master"
[0m20:08:38.561366 [debug] [MainThread]: On master: BEGIN
[0m20:08:38.563214 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:08:38.564261 [debug] [MainThread]: On master: COMMIT
[0m20:08:38.565794 [debug] [MainThread]: Using postgres connection "master"
[0m20:08:38.567575 [debug] [MainThread]: On master: COMMIT
[0m20:08:38.569164 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:08:38.570252 [debug] [MainThread]: On master: Close
[0m20:08:38.571947 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:08:38.573162 [info ] [MainThread]: 
[0m20:08:38.578257 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:08:38.579646 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:08:38.581390 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:08:38.583156 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:08:38.595001 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:08:38.619852 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:08:38.584428 => 20:08:38.619461
[0m20:08:38.620773 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:08:38.679026 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:08:38.704439 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:08:38.705543 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:08:38.706598 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:08:38.714234 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:08:38.715731 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:08:38.717426 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-2025'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:08:38.721645 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column t2.name does not exist
LINE 15:         t1.*,t2.name AS team_name2
                      ^

[0m20:08:38.722845 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: ROLLBACK
[0m20:08:38.724357 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:08:38.621632 => 20:08:38.724046
[0m20:08:38.725385 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:08:38.730908 [debug] [Thread-1 (]: Database Error in model home_vs_away (models/spurs_analysis/home_vs_away.sql)
  column t2.name does not exist
  LINE 15:         t1.*,t2.name AS team_name2
                        ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/home_vs_away.sql
[0m20:08:38.732476 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '666eefb9-a832-4ed0-98c7-4e4c1949d109', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b211473c4a0>]}
[0m20:08:38.734141 [error] [Thread-1 (]: 1 of 3 ERROR creating sql table model gold.home_vs_away ........................ [[31mERROR[0m in 0.15s]
[0m20:08:38.735567 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:08:38.736749 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:08:38.738428 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:08:38.739887 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m20:08:38.740930 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:08:38.746129 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:08:38.771658 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:08:38.742082 => 20:08:38.771276
[0m20:08:38.772694 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:08:38.779051 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:08:38.806193 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:08:38.807205 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:08:38.808179 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:08:38.816339 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:08:38.817626 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:08:38.818741 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-2025'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m20:08:38.843961 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:08:38.856125 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:08:38.857490 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:08:38.860042 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:08:38.865594 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:08:38.867442 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:08:38.869296 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:08:38.900620 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:08:38.901980 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:08:38.903003 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:08:38.911568 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:08:38.922011 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:08:38.931913 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:08:38.933826 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:08:38.943210 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:08:38.945689 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:08:38.773841 => 20:08:38.945395
[0m20:08:38.946885 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:08:38.948704 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '666eefb9-a832-4ed0-98c7-4e4c1949d109', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b2114627350>]}
[0m20:08:38.951089 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 52[0m in 0.21s]
[0m20:08:38.953081 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:08:38.954324 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:08:38.955477 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:08:38.956936 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:08:38.958473 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:08:38.963957 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:08:38.993532 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:08:38.959826 => 20:08:38.993144
[0m20:08:38.994726 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:08:39.001686 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:08:39.028837 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:08:39.029919 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:08:39.030936 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:08:39.039354 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:08:39.040405 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:08:39.041462 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season
),

all_teams_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season = ta.season
JOIN best_team_stats bts ON ss.season = bts.season
  );
  
[0m20:08:39.079208 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m20:08:39.084889 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:08:39.086665 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m20:08:39.088683 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:08:39.092906 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:08:39.094017 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m20:08:39.095639 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:08:39.099327 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:08:39.101056 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:08:39.102182 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:08:39.111041 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:08:39.114919 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m20:08:39.117078 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:08:39.118227 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m20:08:39.127706 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:08:39.130187 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:08:38.995432 => 20:08:39.129913
[0m20:08:39.131356 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:08:39.134598 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '666eefb9-a832-4ed0-98c7-4e4c1949d109', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b211461dc40>]}
[0m20:08:39.136151 [info ] [Thread-1 (]: 3 of 3 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 2[0m in 0.18s]
[0m20:08:39.137670 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:08:39.141224 [debug] [MainThread]: Using postgres connection "master"
[0m20:08:39.142701 [debug] [MainThread]: On master: BEGIN
[0m20:08:39.143788 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:08:39.151192 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:08:39.152189 [debug] [MainThread]: On master: COMMIT
[0m20:08:39.153050 [debug] [MainThread]: Using postgres connection "master"
[0m20:08:39.153932 [debug] [MainThread]: On master: COMMIT
[0m20:08:39.155173 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:08:39.156108 [debug] [MainThread]: On master: Close
[0m20:08:39.157830 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:08:39.158862 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m20:08:39.159930 [info ] [MainThread]: 
[0m20:08:39.160921 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.72 seconds (0.72s).
[0m20:08:39.162642 [debug] [MainThread]: Command end result
[0m20:08:39.225150 [info ] [MainThread]: 
[0m20:08:39.226166 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:08:39.227095 [info ] [MainThread]: 
[0m20:08:39.228021 [error] [MainThread]:   Database Error in model home_vs_away (models/spurs_analysis/home_vs_away.sql)
  column t2.name does not exist
  LINE 15:         t1.*,t2.name AS team_name2
                        ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/home_vs_away.sql
[0m20:08:39.229522 [info ] [MainThread]: 
[0m20:08:39.230792 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m20:08:39.233154 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.9391803, "process_user_time": 3.57975, "process_kernel_time": 0.339976, "process_mem_max_rss": "200876", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:08:39.234705 [debug] [MainThread]: Command `dbt run` failed at 20:08:39.234449 after 1.94 seconds
[0m20:08:39.235670 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b2117afe150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b2114625d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b2117e39d00>]}
[0m20:08:39.236621 [debug] [MainThread]: Flushing usage events
[0m20:10:00.552259 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa6320da150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa63220e150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa6321aa3c0>]}


============================== 20:10:00.556246 | def5f9b4-a26c-4793-8742-0d6eab5d9e86 ==============================
[0m20:10:00.556246 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:10:00.557501 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m20:10:00.853094 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'def5f9b4-a26c-4793-8742-0d6eab5d9e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa631922ea0>]}
[0m20:10:00.994789 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'def5f9b4-a26c-4793-8742-0d6eab5d9e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa6321044a0>]}
[0m20:10:00.996272 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:10:01.022708 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:10:01.263412 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:10:01.264872 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/home_vs_away.sql
[0m20:10:01.678086 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:10:01.686775 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'def5f9b4-a26c-4793-8742-0d6eab5d9e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa630dc7920>]}
[0m20:10:01.758661 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'def5f9b4-a26c-4793-8742-0d6eab5d9e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa631168d10>]}
[0m20:10:01.760127 [info ] [MainThread]: Found 3 models, 5 tests, 3 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:10:01.761645 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'def5f9b4-a26c-4793-8742-0d6eab5d9e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa63059b710>]}
[0m20:10:01.765735 [info ] [MainThread]: 
[0m20:10:01.768047 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:10:01.771008 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:10:01.786571 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:10:01.787837 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:10:01.788867 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:10:01.802181 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:10:01.804877 [debug] [ThreadPool]: On list_nba: Close
[0m20:10:01.808978 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:10:01.822791 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:10:01.823920 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:10:01.824816 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:10:01.831504 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:10:01.833208 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:10:01.834231 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:10:01.838742 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m20:10:01.840953 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:10:01.842270 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:10:01.850005 [debug] [MainThread]: Using postgres connection "master"
[0m20:10:01.851101 [debug] [MainThread]: On master: BEGIN
[0m20:10:01.852054 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:10:01.858812 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:10:01.859972 [debug] [MainThread]: Using postgres connection "master"
[0m20:10:01.861046 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:10:01.877004 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:10:01.879333 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'def5f9b4-a26c-4793-8742-0d6eab5d9e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa6309c7aa0>]}
[0m20:10:01.880750 [debug] [MainThread]: On master: ROLLBACK
[0m20:10:01.882604 [debug] [MainThread]: Using postgres connection "master"
[0m20:10:01.884172 [debug] [MainThread]: On master: BEGIN
[0m20:10:01.886077 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:10:01.887253 [debug] [MainThread]: On master: COMMIT
[0m20:10:01.888632 [debug] [MainThread]: Using postgres connection "master"
[0m20:10:01.889818 [debug] [MainThread]: On master: COMMIT
[0m20:10:01.891230 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:10:01.892476 [debug] [MainThread]: On master: Close
[0m20:10:01.894273 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:10:01.895753 [info ] [MainThread]: 
[0m20:10:01.901705 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:10:01.903033 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:10:01.904481 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:10:01.905438 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:10:01.915557 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:10:01.941674 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:10:01.906136 => 20:10:01.941164
[0m20:10:01.942860 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:10:01.996523 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:10:02.022101 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:10:02.023109 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:10:02.023893 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:10:02.030199 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:10:02.031356 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:10:02.032682 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-2025'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:10:02.053733 [debug] [Thread-1 (]: SQL status: SELECT 104 in 0.0 seconds
[0m20:10:02.061793 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:10:02.062884 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m20:10:02.065666 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:10:02.078400 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:10:02.081058 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m20:10:02.084882 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:10:02.126682 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:10:02.128264 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:10:02.130060 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:10:02.138401 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:10:02.148025 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m20:10:02.158502 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:10:02.160009 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m20:10:02.168913 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:10:02.171809 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:10:01.943683 => 20:10:02.171257
[0m20:10:02.172907 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:10:02.174646 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'def5f9b4-a26c-4793-8742-0d6eab5d9e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa630570d40>]}
[0m20:10:02.177315 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 104[0m in 0.27s]
[0m20:10:02.178843 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:10:02.180336 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:10:02.181925 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:10:02.184386 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m20:10:02.185515 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:10:02.192632 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:10:02.215145 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:10:02.186384 => 20:10:02.214257
[0m20:10:02.218245 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:10:02.230231 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:10:02.253634 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:10:02.254578 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:10:02.255408 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:10:02.262300 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:10:02.263333 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:10:02.264268 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-2025'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m20:10:02.284906 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:10:02.289954 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:10:02.291095 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:10:02.292699 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:10:02.297487 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:10:02.298939 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:10:02.300882 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:10:02.303972 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:10:02.304955 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:10:02.305900 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:10:02.312251 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:10:02.317266 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:10:02.318808 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:10:02.319875 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:10:02.326567 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:10:02.329145 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:10:02.221438 => 20:10:02.328885
[0m20:10:02.330174 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:10:02.332724 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'def5f9b4-a26c-4793-8742-0d6eab5d9e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa6301d82c0>]}
[0m20:10:02.334294 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 52[0m in 0.15s]
[0m20:10:02.335943 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:10:02.337094 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:10:02.338165 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:10:02.339510 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:10:02.340605 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:10:02.345475 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:10:02.374120 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:10:02.341406 => 20:10:02.373736
[0m20:10:02.375124 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:10:02.380456 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:10:02.410728 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:10:02.412211 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:10:02.413593 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:10:02.421960 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:10:02.423047 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:10:02.424113 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season
),

all_teams_stats AS (
    SELECT
        case when season like '2024' then '2024-2025'
            else season end as season,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season = ta.season
JOIN best_team_stats bts ON ss.season = bts.season
  );
  
[0m20:10:02.457268 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m20:10:02.462676 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:10:02.463921 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m20:10:02.466229 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:10:02.470908 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:10:02.471971 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m20:10:02.473430 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:10:02.476534 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:10:02.477628 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:10:02.478608 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:10:02.484445 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:10:02.488454 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m20:10:02.490055 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:10:02.491188 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m20:10:02.500129 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:10:02.502548 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:10:02.375921 => 20:10:02.502283
[0m20:10:02.503559 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:10:02.505248 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'def5f9b4-a26c-4793-8742-0d6eab5d9e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa6301cdca0>]}
[0m20:10:02.506452 [info ] [Thread-1 (]: 3 of 3 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 2[0m in 0.17s]
[0m20:10:02.507906 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:10:02.511679 [debug] [MainThread]: Using postgres connection "master"
[0m20:10:02.512658 [debug] [MainThread]: On master: BEGIN
[0m20:10:02.513541 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:10:02.521149 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:10:02.522102 [debug] [MainThread]: On master: COMMIT
[0m20:10:02.522904 [debug] [MainThread]: Using postgres connection "master"
[0m20:10:02.523771 [debug] [MainThread]: On master: COMMIT
[0m20:10:02.524897 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:10:02.525690 [debug] [MainThread]: On master: Close
[0m20:10:02.527056 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:10:02.527815 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m20:10:02.528773 [info ] [MainThread]: 
[0m20:10:02.530011 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.76 seconds (0.76s).
[0m20:10:02.532454 [debug] [MainThread]: Command end result
[0m20:10:02.591269 [info ] [MainThread]: 
[0m20:10:02.592355 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:10:02.593272 [info ] [MainThread]: 
[0m20:10:02.594233 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m20:10:02.595758 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.1321352, "process_user_time": 4.313474, "process_kernel_time": 0.329334, "process_mem_max_rss": "200872", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:10:02.596790 [debug] [MainThread]: Command `dbt run` succeeded at 20:10:02.596610 after 2.13 seconds
[0m20:10:02.597683 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa636a9ef30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa6320da4b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa631594920>]}
[0m20:10:02.599037 [debug] [MainThread]: Flushing usage events
[0m20:13:35.401853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72299936cec0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72299936df10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72299936e4b0>]}


============================== 20:13:35.406206 | 1b3b39e0-cd15-4163-9ad1-fcba16376064 ==============================
[0m20:13:35.406206 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:13:35.408000 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:13:35.720076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1b3b39e0-cd15-4163-9ad1-fcba16376064', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7229993d1c70>]}
[0m20:13:35.854030 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1b3b39e0-cd15-4163-9ad1-fcba16376064', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7229994a6600>]}
[0m20:13:35.855749 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:13:35.884014 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:13:36.132003 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 3 files changed.
[0m20:13:36.133339 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/summary_by_season.sql
[0m20:13:36.134422 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/home_vs_away.sql
[0m20:13:36.135463 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m20:13:36.614281 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:13:36.622011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1b3b39e0-cd15-4163-9ad1-fcba16376064', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7229977cfef0>]}
[0m20:13:36.695481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1b3b39e0-cd15-4163-9ad1-fcba16376064', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x722998323f80>]}
[0m20:13:36.696594 [info ] [MainThread]: Found 3 models, 5 tests, 3 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:13:36.697665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1b3b39e0-cd15-4163-9ad1-fcba16376064', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72299770e1b0>]}
[0m20:13:36.700484 [info ] [MainThread]: 
[0m20:13:36.702081 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:13:36.704977 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:13:36.720992 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:13:36.722030 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:13:36.722920 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:13:36.732819 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:13:36.734895 [debug] [ThreadPool]: On list_nba: Close
[0m20:13:36.738483 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:13:36.748639 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:13:36.749859 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:13:36.751042 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:13:36.760345 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:13:36.761627 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:13:36.762529 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:13:36.767678 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m20:13:36.769820 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:13:36.771063 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:13:36.780212 [debug] [MainThread]: Using postgres connection "master"
[0m20:13:36.781241 [debug] [MainThread]: On master: BEGIN
[0m20:13:36.782284 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:13:36.790679 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:13:36.792522 [debug] [MainThread]: Using postgres connection "master"
[0m20:13:36.793665 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:13:36.816343 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:13:36.818981 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1b3b39e0-cd15-4163-9ad1-fcba16376064', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x722997373c80>]}
[0m20:13:36.820360 [debug] [MainThread]: On master: ROLLBACK
[0m20:13:36.821856 [debug] [MainThread]: Using postgres connection "master"
[0m20:13:36.823083 [debug] [MainThread]: On master: BEGIN
[0m20:13:36.825663 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:13:36.826799 [debug] [MainThread]: On master: COMMIT
[0m20:13:36.827816 [debug] [MainThread]: Using postgres connection "master"
[0m20:13:36.828937 [debug] [MainThread]: On master: COMMIT
[0m20:13:36.830486 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:13:36.831454 [debug] [MainThread]: On master: Close
[0m20:13:36.832991 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:13:36.835639 [info ] [MainThread]: 
[0m20:13:36.843618 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:13:36.844928 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:13:36.846918 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:13:36.848354 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:13:36.866234 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:13:36.892876 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:13:36.849364 => 20:13:36.892338
[0m20:13:36.894167 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:13:36.957412 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:13:36.982751 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:13:36.983742 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:13:36.984758 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:13:36.992159 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:13:36.993435 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:13:36.994553 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:13:37.013878 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:13:37.022189 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:13:37.023536 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m20:13:37.025478 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:13:37.030005 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:13:37.031151 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m20:13:37.032769 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:13:37.064478 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:13:37.065612 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:13:37.066639 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:13:37.075335 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:13:37.086047 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m20:13:37.096108 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:13:37.097222 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m20:13:37.104251 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:13:37.107171 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:13:36.895152 => 20:13:37.106618
[0m20:13:37.109132 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:13:37.111715 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1b3b39e0-cd15-4163-9ad1-fcba16376064', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7229973c6450>]}
[0m20:13:37.113009 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.27s]
[0m20:13:37.114630 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:13:37.115916 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:13:37.117024 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:13:37.118810 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m20:13:37.119922 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:13:37.125556 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:13:37.151449 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:13:37.120784 => 20:13:37.150967
[0m20:13:37.152565 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:13:37.159503 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:13:37.186326 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:13:37.187381 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:13:37.188288 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:13:37.195951 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:13:37.197011 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:13:37.198077 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m20:13:37.215573 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m20:13:37.220081 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:13:37.221302 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:13:37.223684 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:13:37.228864 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:13:37.230734 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:13:37.232404 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:13:37.235383 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:13:37.236482 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:13:37.237480 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:13:37.245447 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:13:37.249407 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:13:37.250900 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:13:37.251890 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:13:37.258586 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:13:37.261004 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:13:37.153402 => 20:13:37.260718
[0m20:13:37.262037 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:13:37.263641 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1b3b39e0-cd15-4163-9ad1-fcba16376064', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7229973c6330>]}
[0m20:13:37.264806 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m20:13:37.266015 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:13:37.267263 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:13:37.268305 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:13:37.269651 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:13:37.270649 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:13:37.276769 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:13:37.303024 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:13:37.271419 => 20:13:37.302627
[0m20:13:37.303987 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:13:37.310361 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:13:37.339186 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:13:37.340560 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:13:37.342348 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:13:37.349232 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:13:37.350609 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:13:37.351869 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season
),

all_teams_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season = ta.season
JOIN best_team_stats bts ON ss.season = bts.season
  );
  
[0m20:13:37.386515 [debug] [Thread-1 (]: SQL status: SELECT 4 in 0.0 seconds
[0m20:13:37.392426 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:13:37.394183 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m20:13:37.396639 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:13:37.401193 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:13:37.402253 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m20:13:37.403879 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:13:37.407800 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:13:37.409342 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:13:37.410262 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:13:37.417579 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:13:37.421612 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m20:13:37.423351 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:13:37.424834 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m20:13:37.432345 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:13:37.434723 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:13:37.304659 => 20:13:37.434462
[0m20:13:37.435825 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:13:37.437351 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1b3b39e0-cd15-4163-9ad1-fcba16376064', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x722997345940>]}
[0m20:13:37.438532 [info ] [Thread-1 (]: 3 of 3 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 4[0m in 0.17s]
[0m20:13:37.440778 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:13:37.444984 [debug] [MainThread]: Using postgres connection "master"
[0m20:13:37.446081 [debug] [MainThread]: On master: BEGIN
[0m20:13:37.447002 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:13:37.454028 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:13:37.455367 [debug] [MainThread]: On master: COMMIT
[0m20:13:37.456357 [debug] [MainThread]: Using postgres connection "master"
[0m20:13:37.457498 [debug] [MainThread]: On master: COMMIT
[0m20:13:37.459376 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:13:37.460379 [debug] [MainThread]: On master: Close
[0m20:13:37.461781 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:13:37.462690 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m20:13:37.463750 [info ] [MainThread]: 
[0m20:13:37.464777 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.76 seconds (0.76s).
[0m20:13:37.466295 [debug] [MainThread]: Command end result
[0m20:13:37.529525 [info ] [MainThread]: 
[0m20:13:37.530856 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:13:37.532034 [info ] [MainThread]: 
[0m20:13:37.533054 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m20:13:37.534723 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.2227857, "process_user_time": 3.839687, "process_kernel_time": 0.305566, "process_mem_max_rss": "200876", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:13:37.535897 [debug] [MainThread]: Command `dbt run` succeeded at 20:13:37.535668 after 2.22 seconds
[0m20:13:37.536918 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7229996f2300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72299773ac90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72299773a000>]}
[0m20:13:37.537910 [debug] [MainThread]: Flushing usage events
[0m20:22:42.529888 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7cad182390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7cad182450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7cad180dd0>]}


============================== 20:22:42.534339 | 709a6dd4-f40a-4a0b-ae33-da994d40db08 ==============================
[0m20:22:42.534339 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:22:42.536179 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:22:42.898614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '709a6dd4-f40a-4a0b-ae33-da994d40db08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7cad183ad0>]}
[0m20:22:43.035389 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '709a6dd4-f40a-4a0b-ae33-da994d40db08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7cac935eb0>]}
[0m20:22:43.038011 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:22:43.068397 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:22:43.291938 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:22:43.293543 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m20:22:43.607726 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:22:43.617639 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '709a6dd4-f40a-4a0b-ae33-da994d40db08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7cab9cb9b0>]}
[0m20:22:43.686467 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '709a6dd4-f40a-4a0b-ae33-da994d40db08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7cac1756a0>]}
[0m20:22:43.687598 [info ] [MainThread]: Found 3 models, 5 tests, 3 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:22:43.688649 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '709a6dd4-f40a-4a0b-ae33-da994d40db08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7cac174ec0>]}
[0m20:22:43.691413 [info ] [MainThread]: 
[0m20:22:43.692941 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:22:43.695359 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:22:43.711192 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:22:43.712332 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:22:43.713282 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:22:43.722905 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:22:43.725123 [debug] [ThreadPool]: On list_nba: Close
[0m20:22:43.728110 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:22:43.736839 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:22:43.738024 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:22:43.738970 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:22:43.746296 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:22:43.747353 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:22:43.748363 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:22:43.754609 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m20:22:43.757035 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:22:43.758543 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:22:43.766170 [debug] [MainThread]: Using postgres connection "master"
[0m20:22:43.767683 [debug] [MainThread]: On master: BEGIN
[0m20:22:43.769182 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:22:43.776566 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:22:43.777785 [debug] [MainThread]: Using postgres connection "master"
[0m20:22:43.778849 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:22:43.795591 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:22:43.797917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '709a6dd4-f40a-4a0b-ae33-da994d40db08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7cade92a20>]}
[0m20:22:43.799680 [debug] [MainThread]: On master: ROLLBACK
[0m20:22:43.801881 [debug] [MainThread]: Using postgres connection "master"
[0m20:22:43.803115 [debug] [MainThread]: On master: BEGIN
[0m20:22:43.804890 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:22:43.805936 [debug] [MainThread]: On master: COMMIT
[0m20:22:43.806904 [debug] [MainThread]: Using postgres connection "master"
[0m20:22:43.807927 [debug] [MainThread]: On master: COMMIT
[0m20:22:43.809096 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:22:43.810252 [debug] [MainThread]: On master: Close
[0m20:22:43.811909 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:22:43.813032 [info ] [MainThread]: 
[0m20:22:43.818202 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:22:43.819686 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:22:43.821070 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:22:43.822117 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:22:43.832229 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:22:43.859340 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:22:43.823005 => 20:22:43.858952
[0m20:22:43.860708 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:22:43.909366 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:22:43.935700 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:22:43.936801 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:22:43.937790 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:22:43.944739 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:22:43.945990 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:22:43.947032 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:22:43.967097 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:22:43.977179 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:22:43.978468 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m20:22:43.980376 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:22:43.985697 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:22:43.987020 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m20:22:43.988759 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:22:44.015682 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:22:44.017501 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:22:44.019350 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:22:44.029009 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:22:44.038034 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m20:22:44.045443 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:22:44.046416 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m20:22:44.055625 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:22:44.058013 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:22:43.861501 => 20:22:44.057742
[0m20:22:44.058954 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:22:44.060665 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '709a6dd4-f40a-4a0b-ae33-da994d40db08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7cab9a5160>]}
[0m20:22:44.063130 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.24s]
[0m20:22:44.064632 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:22:44.065747 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:22:44.067363 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:22:44.069969 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m20:22:44.071372 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:22:44.077589 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:22:44.103914 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:22:44.072498 => 20:22:44.103420
[0m20:22:44.104858 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:22:44.110118 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:22:44.134625 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:22:44.136060 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:22:44.136992 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:22:44.144088 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:22:44.145096 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:22:44.146043 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m20:22:44.172647 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m20:22:44.177076 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:22:44.178115 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:22:44.179658 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:22:44.185454 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:22:44.186554 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:22:44.188107 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:22:44.191067 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:22:44.192074 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:22:44.192993 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:22:44.200661 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:22:44.204959 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:22:44.206400 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:22:44.207344 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:22:44.214993 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:22:44.218418 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:22:44.105562 => 20:22:44.218021
[0m20:22:44.219713 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:22:44.221350 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '709a6dd4-f40a-4a0b-ae33-da994d40db08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7cab995520>]}
[0m20:22:44.222604 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m20:22:44.224195 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:22:44.225311 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:22:44.226409 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:22:44.227936 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:22:44.228857 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:22:44.234861 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:22:44.265208 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:22:44.229614 => 20:22:44.264830
[0m20:22:44.266386 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:22:44.272928 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:22:44.296839 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:22:44.297928 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:22:44.298881 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:22:44.306194 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:22:44.307202 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:22:44.308351 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when season like '2024' then '2024-25'
            else season end as sesion2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m20:22:44.317427 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "season2" does not exist
LINE 25:         season2,
                 ^
HINT:  Perhaps you meant to reference the column "nba_games.season".

[0m20:22:44.319495 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: ROLLBACK
[0m20:22:44.321396 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:22:44.267625 => 20:22:44.320987
[0m20:22:44.322400 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:22:44.329578 [debug] [Thread-1 (]: Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  column "season2" does not exist
  LINE 25:         season2,
                   ^
  HINT:  Perhaps you meant to reference the column "nba_games.season".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m20:22:44.330804 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '709a6dd4-f40a-4a0b-ae33-da994d40db08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7cab5a8890>]}
[0m20:22:44.332260 [error] [Thread-1 (]: 3 of 3 ERROR creating sql table model gold.team_weaknesses ..................... [[31mERROR[0m in 0.10s]
[0m20:22:44.334709 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:22:44.340485 [debug] [MainThread]: Using postgres connection "master"
[0m20:22:44.341810 [debug] [MainThread]: On master: BEGIN
[0m20:22:44.343323 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:22:44.353459 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:22:44.354458 [debug] [MainThread]: On master: COMMIT
[0m20:22:44.355427 [debug] [MainThread]: Using postgres connection "master"
[0m20:22:44.356803 [debug] [MainThread]: On master: COMMIT
[0m20:22:44.358374 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:22:44.359699 [debug] [MainThread]: On master: Close
[0m20:22:44.361419 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:22:44.362411 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m20:22:44.363625 [info ] [MainThread]: 
[0m20:22:44.364674 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.67 seconds (0.67s).
[0m20:22:44.366336 [debug] [MainThread]: Command end result
[0m20:22:44.423884 [info ] [MainThread]: 
[0m20:22:44.425166 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:22:44.426422 [info ] [MainThread]: 
[0m20:22:44.427775 [error] [MainThread]:   Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  column "season2" does not exist
  LINE 25:         season2,
                   ^
  HINT:  Perhaps you meant to reference the column "nba_games.season".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m20:22:44.428798 [info ] [MainThread]: 
[0m20:22:44.429724 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m20:22:44.431258 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.9923779, "process_user_time": 3.817592, "process_kernel_time": 0.3934, "process_mem_max_rss": "200872", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:22:44.432435 [debug] [MainThread]: Command `dbt run` failed at 20:22:44.432261 after 1.99 seconds
[0m20:22:44.433579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7cad256e70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7cad2d03e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7cac567770>]}
[0m20:22:44.435354 [debug] [MainThread]: Flushing usage events
[0m20:23:56.054907 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728f8af450d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728f8af47920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728f8af45010>]}


============================== 20:23:56.059729 | 3d58fca6-1be2-4f4b-80e2-11b6f5abb94a ==============================
[0m20:23:56.059729 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:23:56.060815 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:23:56.341362 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3d58fca6-1be2-4f4b-80e2-11b6f5abb94a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728f8ae6a840>]}
[0m20:23:56.460148 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3d58fca6-1be2-4f4b-80e2-11b6f5abb94a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728f8ae3f440>]}
[0m20:23:56.461710 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:23:56.486233 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:23:56.715761 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:23:56.717110 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m20:23:56.973058 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:23:56.980881 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3d58fca6-1be2-4f4b-80e2-11b6f5abb94a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728f899dffe0>]}
[0m20:23:57.049512 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3d58fca6-1be2-4f4b-80e2-11b6f5abb94a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728f8a5b5460>]}
[0m20:23:57.050745 [info ] [MainThread]: Found 3 models, 5 tests, 3 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:23:57.051858 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3d58fca6-1be2-4f4b-80e2-11b6f5abb94a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728f8a5b48c0>]}
[0m20:23:57.055116 [info ] [MainThread]: 
[0m20:23:57.057224 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:23:57.059749 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:23:57.074644 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:23:57.075673 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:23:57.076545 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:23:57.085461 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:23:57.087715 [debug] [ThreadPool]: On list_nba: Close
[0m20:23:57.091782 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:23:57.099485 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:23:57.100518 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:23:57.101496 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:23:57.109843 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:23:57.110903 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:23:57.111870 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:23:57.116851 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m20:23:57.119332 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:23:57.120603 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:23:57.129746 [debug] [MainThread]: Using postgres connection "master"
[0m20:23:57.130977 [debug] [MainThread]: On master: BEGIN
[0m20:23:57.132167 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:23:57.141367 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:23:57.142811 [debug] [MainThread]: Using postgres connection "master"
[0m20:23:57.144203 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:23:57.165942 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:23:57.168773 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3d58fca6-1be2-4f4b-80e2-11b6f5abb94a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728f8b68aed0>]}
[0m20:23:57.170180 [debug] [MainThread]: On master: ROLLBACK
[0m20:23:57.172130 [debug] [MainThread]: Using postgres connection "master"
[0m20:23:57.173603 [debug] [MainThread]: On master: BEGIN
[0m20:23:57.175750 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:23:57.176917 [debug] [MainThread]: On master: COMMIT
[0m20:23:57.178058 [debug] [MainThread]: Using postgres connection "master"
[0m20:23:57.179187 [debug] [MainThread]: On master: COMMIT
[0m20:23:57.180445 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:23:57.181407 [debug] [MainThread]: On master: Close
[0m20:23:57.183190 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:23:57.184517 [info ] [MainThread]: 
[0m20:23:57.192609 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:23:57.194097 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:23:57.195752 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:23:57.196859 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:23:57.210333 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:23:57.233738 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:23:57.197881 => 20:23:57.232898
[0m20:23:57.231263 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:23:57.297995 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:23:57.322213 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:23:57.323248 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:23:57.324161 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:23:57.331338 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:23:57.332537 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:23:57.333597 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:23:57.357466 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:23:57.366382 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:23:57.368009 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m20:23:57.370601 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:23:57.375170 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:23:57.376339 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m20:23:57.377915 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:23:57.404138 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:23:57.405303 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:23:57.406495 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:23:57.412298 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:23:57.422880 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m20:23:57.431616 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:23:57.432819 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m20:23:57.441827 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:23:57.444247 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:23:57.232879 => 20:23:57.443976
[0m20:23:57.445216 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:23:57.446874 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3d58fca6-1be2-4f4b-80e2-11b6f5abb94a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728f89de11c0>]}
[0m20:23:57.448087 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.25s]
[0m20:23:57.449764 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:23:57.451280 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:23:57.452709 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:23:57.454157 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m20:23:57.455124 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:23:57.460879 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:23:57.487157 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:23:57.455828 => 20:23:57.486772
[0m20:23:57.488267 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:23:57.494090 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:23:57.519078 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:23:57.520349 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:23:57.521768 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:23:57.531302 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:23:57.532483 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:23:57.533494 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m20:23:57.558863 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m20:23:57.563449 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:23:57.564617 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:23:57.566187 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:23:57.571714 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:23:57.572745 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:23:57.574184 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:23:57.577287 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:23:57.578511 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:23:57.579378 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:23:57.587278 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:23:57.591456 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:23:57.593283 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:23:57.594510 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:23:57.601999 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:23:57.604702 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:23:57.489079 => 20:23:57.604390
[0m20:23:57.605703 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:23:57.607484 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3d58fca6-1be2-4f4b-80e2-11b6f5abb94a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728f8a10f9b0>]}
[0m20:23:57.608914 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m20:23:57.610447 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:23:57.611578 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:23:57.612700 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:23:57.614165 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:23:57.615155 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:23:57.620920 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:23:57.647122 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:23:57.615935 => 20:23:57.646750
[0m20:23:57.648108 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:23:57.655422 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:23:57.680993 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:23:57.682161 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:23:57.683798 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:23:57.691665 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:23:57.692765 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:23:57.693971 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as sesion2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m20:23:57.698985 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "season2" does not exist
LINE 25:         season2,
                 ^
HINT:  Perhaps you meant to reference the column "nba_games.season".

[0m20:23:57.700187 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: ROLLBACK
[0m20:23:57.702616 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:23:57.648908 => 20:23:57.702165
[0m20:23:57.703720 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:23:57.709660 [debug] [Thread-1 (]: Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  column "season2" does not exist
  LINE 25:         season2,
                   ^
  HINT:  Perhaps you meant to reference the column "nba_games.season".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m20:23:57.710846 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3d58fca6-1be2-4f4b-80e2-11b6f5abb94a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728f8a51da30>]}
[0m20:23:57.712057 [error] [Thread-1 (]: 3 of 3 ERROR creating sql table model gold.team_weaknesses ..................... [[31mERROR[0m in 0.10s]
[0m20:23:57.713538 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:23:57.718434 [debug] [MainThread]: Using postgres connection "master"
[0m20:23:57.719841 [debug] [MainThread]: On master: BEGIN
[0m20:23:57.720894 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:23:57.728121 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:23:57.729110 [debug] [MainThread]: On master: COMMIT
[0m20:23:57.730150 [debug] [MainThread]: Using postgres connection "master"
[0m20:23:57.731055 [debug] [MainThread]: On master: COMMIT
[0m20:23:57.732302 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:23:57.733522 [debug] [MainThread]: On master: Close
[0m20:23:57.735576 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:23:57.736688 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m20:23:57.737817 [info ] [MainThread]: 
[0m20:23:57.739090 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.68 seconds (0.68s).
[0m20:23:57.741060 [debug] [MainThread]: Command end result
[0m20:23:57.798046 [info ] [MainThread]: 
[0m20:23:57.799067 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:23:57.799990 [info ] [MainThread]: 
[0m20:23:57.801285 [error] [MainThread]:   Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  column "season2" does not exist
  LINE 25:         season2,
                   ^
  HINT:  Perhaps you meant to reference the column "nba_games.season".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m20:23:57.802840 [info ] [MainThread]: 
[0m20:23:57.803891 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m20:23:57.805725 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.8395365, "process_user_time": 3.513684, "process_kernel_time": 0.285763, "process_mem_max_rss": "200876", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:23:57.806934 [debug] [MainThread]: Command `dbt run` failed at 20:23:57.806739 after 1.84 seconds
[0m20:23:57.807973 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728f8afd82f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728f8afb3b00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x728f89525310>]}
[0m20:23:57.809021 [debug] [MainThread]: Flushing usage events
[0m20:26:32.059084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdfdf3b8e90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdfe06d7320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdfdf3ba180>]}


============================== 20:26:32.063429 | 42444150-dae2-47c8-9e7b-f44ca7272ada ==============================
[0m20:26:32.063429 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:26:32.064698 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:26:32.343231 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '42444150-dae2-47c8-9e7b-f44ca7272ada', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdfdf2aecf0>]}
[0m20:26:32.509237 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '42444150-dae2-47c8-9e7b-f44ca7272ada', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdfe06ff560>]}
[0m20:26:32.510826 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:26:32.537631 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:26:32.748283 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:26:32.749544 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m20:26:33.020171 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:26:33.030127 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '42444150-dae2-47c8-9e7b-f44ca7272ada', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdfdd7f3fe0>]}
[0m20:26:33.098129 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '42444150-dae2-47c8-9e7b-f44ca7272ada', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdfde3bd490>]}
[0m20:26:33.099207 [info ] [MainThread]: Found 3 models, 5 tests, 3 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:26:33.100231 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '42444150-dae2-47c8-9e7b-f44ca7272ada', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdfde3bc8f0>]}
[0m20:26:33.102947 [info ] [MainThread]: 
[0m20:26:33.104785 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:26:33.108057 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:26:33.122932 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:26:33.124048 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:26:33.124918 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:26:33.134589 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:26:33.136841 [debug] [ThreadPool]: On list_nba: Close
[0m20:26:33.141452 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:26:33.152173 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:26:33.153442 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:26:33.154690 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:26:33.164276 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:26:33.165221 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:26:33.166114 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:26:33.171855 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m20:26:33.174254 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:26:33.175626 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:26:33.182505 [debug] [MainThread]: Using postgres connection "master"
[0m20:26:33.183628 [debug] [MainThread]: On master: BEGIN
[0m20:26:33.184582 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:26:33.191830 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:26:33.192807 [debug] [MainThread]: Using postgres connection "master"
[0m20:26:33.193809 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:26:33.210063 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:26:33.212513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '42444150-dae2-47c8-9e7b-f44ca7272ada', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdfdfae29c0>]}
[0m20:26:33.213703 [debug] [MainThread]: On master: ROLLBACK
[0m20:26:33.215137 [debug] [MainThread]: Using postgres connection "master"
[0m20:26:33.216186 [debug] [MainThread]: On master: BEGIN
[0m20:26:33.217731 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:26:33.218723 [debug] [MainThread]: On master: COMMIT
[0m20:26:33.219658 [debug] [MainThread]: Using postgres connection "master"
[0m20:26:33.220570 [debug] [MainThread]: On master: COMMIT
[0m20:26:33.222326 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:26:33.223635 [debug] [MainThread]: On master: Close
[0m20:26:33.225253 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:26:33.226334 [info ] [MainThread]: 
[0m20:26:33.231358 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:26:33.232559 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:26:33.234110 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:26:33.235181 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:26:33.248344 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:26:33.272611 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:26:33.236136 => 20:26:33.272044
[0m20:26:33.273686 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:26:33.322855 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:26:33.350314 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:26:33.351258 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:26:33.352312 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:26:33.359804 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:26:33.360876 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:26:33.361845 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:26:33.382477 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:26:33.392294 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:26:33.393459 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m20:26:33.394999 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:26:33.399060 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:26:33.400076 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m20:26:33.401589 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:26:33.428677 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:26:33.429818 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:26:33.430797 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:26:33.437068 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:26:33.446059 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m20:26:33.453944 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:26:33.455659 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m20:26:33.462943 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:26:33.465353 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:26:33.274555 => 20:26:33.465098
[0m20:26:33.466380 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:26:33.468248 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42444150-dae2-47c8-9e7b-f44ca7272ada', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdfddbe1130>]}
[0m20:26:33.469667 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.23s]
[0m20:26:33.471362 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:26:33.473364 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:26:33.474522 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:26:33.476042 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m20:26:33.476987 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:26:33.481356 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:26:33.504778 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:26:33.477812 => 20:26:33.504138
[0m20:26:33.506391 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:26:33.511784 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:26:33.534588 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:26:33.535789 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:26:33.536794 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:26:33.544325 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:26:33.545462 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:26:33.546437 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m20:26:33.562884 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m20:26:33.567225 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:26:33.568341 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:26:33.569821 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:26:33.574878 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:26:33.575926 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:26:33.577383 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:26:33.580368 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:26:33.581378 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:26:33.582325 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:26:33.588374 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:26:33.592650 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:26:33.594109 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:26:33.595058 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:26:33.601761 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:26:33.604695 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:26:33.507233 => 20:26:33.604133
[0m20:26:33.606391 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:26:33.608090 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42444150-dae2-47c8-9e7b-f44ca7272ada', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdfddf10860>]}
[0m20:26:33.609372 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.13s]
[0m20:26:33.610811 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:26:33.611943 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:26:33.613048 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:26:33.614385 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:26:33.615344 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:26:33.620575 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:26:33.646499 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:26:33.616353 => 20:26:33.646085
[0m20:26:33.647471 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:26:33.652878 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:26:33.680703 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:26:33.681657 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:26:33.682526 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:26:33.689799 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:26:33.690816 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:26:33.691961 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m20:26:33.695028 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "nba_games.season2" must appear in the GROUP BY clause or be used in an aggregate function
LINE 54:         season2,
                 ^

[0m20:26:33.696044 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: ROLLBACK
[0m20:26:33.697456 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:26:33.648282 => 20:26:33.697149
[0m20:26:33.698412 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:26:33.704024 [debug] [Thread-1 (]: Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  column "nba_games.season2" must appear in the GROUP BY clause or be used in an aggregate function
  LINE 54:         season2,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m20:26:33.705721 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '42444150-dae2-47c8-9e7b-f44ca7272ada', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdfdd33dbe0>]}
[0m20:26:33.707182 [error] [Thread-1 (]: 3 of 3 ERROR creating sql table model gold.team_weaknesses ..................... [[31mERROR[0m in 0.09s]
[0m20:26:33.708628 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:26:33.712665 [debug] [MainThread]: Using postgres connection "master"
[0m20:26:33.713652 [debug] [MainThread]: On master: BEGIN
[0m20:26:33.714461 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:26:33.721433 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:26:33.722980 [debug] [MainThread]: On master: COMMIT
[0m20:26:33.723849 [debug] [MainThread]: Using postgres connection "master"
[0m20:26:33.724668 [debug] [MainThread]: On master: COMMIT
[0m20:26:33.725977 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:26:33.726866 [debug] [MainThread]: On master: Close
[0m20:26:33.728400 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:26:33.729379 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m20:26:33.730479 [info ] [MainThread]: 
[0m20:26:33.731465 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.63 seconds (0.63s).
[0m20:26:33.733202 [debug] [MainThread]: Command end result
[0m20:26:33.789457 [info ] [MainThread]: 
[0m20:26:33.790487 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:26:33.791426 [info ] [MainThread]: 
[0m20:26:33.792394 [error] [MainThread]:   Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  column "nba_games.season2" must appear in the GROUP BY clause or be used in an aggregate function
  LINE 54:         season2,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m20:26:33.793387 [info ] [MainThread]: 
[0m20:26:33.794329 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m20:26:33.795985 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.8572203, "process_user_time": 3.603239, "process_kernel_time": 0.319577, "process_mem_max_rss": "200876", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:26:33.797040 [debug] [MainThread]: Command `dbt run` failed at 20:26:33.796837 after 1.86 seconds
[0m20:26:33.797942 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdfe3d3aed0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdfe06ff560>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdfdd32eae0>]}
[0m20:26:33.798918 [debug] [MainThread]: Flushing usage events
[0m20:27:28.343874 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71c3950791f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71c39507a570>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71c3950790d0>]}


============================== 20:27:28.348695 | 20373af8-8a91-47d2-8459-0510ae0df559 ==============================
[0m20:27:28.348695 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:27:28.350028 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:27:28.662293 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '20373af8-8a91-47d2-8459-0510ae0df559', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71c395079040>]}
[0m20:27:28.770433 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '20373af8-8a91-47d2-8459-0510ae0df559', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71c396022d80>]}
[0m20:27:28.771793 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:27:28.796003 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:27:28.999382 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:27:29.000803 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m20:27:29.266840 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:27:29.274221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '20373af8-8a91-47d2-8459-0510ae0df559', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71c393183da0>]}
[0m20:27:29.341902 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '20373af8-8a91-47d2-8459-0510ae0df559', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71c393dc8920>]}
[0m20:27:29.343345 [info ] [MainThread]: Found 3 models, 5 tests, 3 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:27:29.345017 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '20373af8-8a91-47d2-8459-0510ae0df559', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71c393d23a40>]}
[0m20:27:29.347726 [info ] [MainThread]: 
[0m20:27:29.349224 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:27:29.351494 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:27:29.366234 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:27:29.367508 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:27:29.368610 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:27:29.380313 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:27:29.382687 [debug] [ThreadPool]: On list_nba: Close
[0m20:27:29.386406 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:27:29.397698 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:27:29.398947 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:27:29.400074 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:27:29.408563 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:27:29.410339 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:27:29.411712 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:27:29.417342 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m20:27:29.419560 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:27:29.420933 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:27:29.429993 [debug] [MainThread]: Using postgres connection "master"
[0m20:27:29.431133 [debug] [MainThread]: On master: BEGIN
[0m20:27:29.432044 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:27:29.440699 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:27:29.442027 [debug] [MainThread]: Using postgres connection "master"
[0m20:27:29.443942 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:27:29.464532 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:27:29.467359 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '20373af8-8a91-47d2-8459-0510ae0df559', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71c395d3cef0>]}
[0m20:27:29.468537 [debug] [MainThread]: On master: ROLLBACK
[0m20:27:29.470273 [debug] [MainThread]: Using postgres connection "master"
[0m20:27:29.471559 [debug] [MainThread]: On master: BEGIN
[0m20:27:29.473951 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:27:29.475460 [debug] [MainThread]: On master: COMMIT
[0m20:27:29.477700 [debug] [MainThread]: Using postgres connection "master"
[0m20:27:29.479702 [debug] [MainThread]: On master: COMMIT
[0m20:27:29.481403 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:27:29.482549 [debug] [MainThread]: On master: Close
[0m20:27:29.484610 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:27:29.487143 [info ] [MainThread]: 
[0m20:27:29.492932 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:27:29.494551 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:27:29.496395 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:27:29.497405 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:27:29.507487 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:27:29.530181 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:27:29.498148 => 20:27:29.529768
[0m20:27:29.531408 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:27:29.589773 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:27:29.612827 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:27:29.613838 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:27:29.614618 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:27:29.621481 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:27:29.622448 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:27:29.623333 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:27:29.644809 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:27:29.654042 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:27:29.655072 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m20:27:29.656488 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:27:29.662501 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:27:29.663635 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m20:27:29.665130 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:27:29.690181 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:27:29.691258 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:27:29.692095 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:27:29.699731 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:27:29.707598 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m20:27:29.716248 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:27:29.717456 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m20:27:29.724673 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:27:29.728154 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:27:29.532486 => 20:27:29.727842
[0m20:27:29.729464 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:27:29.731067 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '20373af8-8a91-47d2-8459-0510ae0df559', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71c39359d190>]}
[0m20:27:29.732273 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.24s]
[0m20:27:29.733622 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:27:29.734771 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:27:29.735879 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:27:29.737376 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m20:27:29.738417 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:27:29.742996 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:27:29.767674 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:27:29.739272 => 20:27:29.767274
[0m20:27:29.768694 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:27:29.774115 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:27:29.799941 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:27:29.801051 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:27:29.801992 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:27:29.808601 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:27:29.810350 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:27:29.812029 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m20:27:29.829588 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m20:27:29.834149 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:27:29.835203 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:27:29.836653 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:27:29.841001 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:27:29.842057 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:27:29.844034 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:27:29.847523 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:27:29.848564 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:27:29.849494 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:27:29.856260 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:27:29.860436 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:27:29.862779 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:27:29.863776 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:27:29.870943 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:27:29.873426 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:27:29.769667 => 20:27:29.873177
[0m20:27:29.874324 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:27:29.875765 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '20373af8-8a91-47d2-8459-0510ae0df559', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71c393d826c0>]}
[0m20:27:29.877731 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.14s]
[0m20:27:29.879446 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:27:29.880458 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:27:29.881532 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:27:29.882819 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:27:29.883767 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:27:29.888605 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:27:29.917033 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:27:29.884480 => 20:27:29.916594
[0m20:27:29.918029 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:27:29.923177 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:27:29.948383 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:27:29.949434 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:27:29.950397 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:27:29.957034 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:27:29.958054 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:27:29.959265 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m20:27:29.963197 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "season" does not exist
LINE 87:             ROW_NUMBER() OVER (PARTITION BY season ORDER BY ...
                                                     ^
HINT:  Perhaps you meant to reference the column "all_teams_stats.season2".

[0m20:27:29.964455 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: ROLLBACK
[0m20:27:29.966108 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:27:29.918706 => 20:27:29.965711
[0m20:27:29.967726 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:27:29.974578 [debug] [Thread-1 (]: Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  column "season" does not exist
  LINE 87:             ROW_NUMBER() OVER (PARTITION BY season ORDER BY ...
                                                       ^
  HINT:  Perhaps you meant to reference the column "all_teams_stats.season2".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m20:27:29.976147 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '20373af8-8a91-47d2-8459-0510ae0df559', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71c3939c6ae0>]}
[0m20:27:29.978402 [error] [Thread-1 (]: 3 of 3 ERROR creating sql table model gold.team_weaknesses ..................... [[31mERROR[0m in 0.09s]
[0m20:27:29.979974 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:27:29.984426 [debug] [MainThread]: Using postgres connection "master"
[0m20:27:29.985683 [debug] [MainThread]: On master: BEGIN
[0m20:27:29.986762 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:27:29.994297 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:27:29.995369 [debug] [MainThread]: On master: COMMIT
[0m20:27:29.996311 [debug] [MainThread]: Using postgres connection "master"
[0m20:27:29.997145 [debug] [MainThread]: On master: COMMIT
[0m20:27:29.998394 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:27:29.999298 [debug] [MainThread]: On master: Close
[0m20:27:30.000835 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:27:30.002899 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m20:27:30.004035 [info ] [MainThread]: 
[0m20:27:30.005166 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.66 seconds (0.66s).
[0m20:27:30.007268 [debug] [MainThread]: Command end result
[0m20:27:30.066805 [info ] [MainThread]: 
[0m20:27:30.067848 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:27:30.068646 [info ] [MainThread]: 
[0m20:27:30.069698 [error] [MainThread]:   Database Error in model team_weaknesses (models/spurs_analysis/team_weaknesses.sql)
  column "season" does not exist
  LINE 87:             ROW_NUMBER() OVER (PARTITION BY season ORDER BY ...
                                                       ^
  HINT:  Perhaps you meant to reference the column "all_teams_stats.season2".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses.sql
[0m20:27:30.071254 [info ] [MainThread]: 
[0m20:27:30.072191 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
[0m20:27:30.073755 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.8209035, "process_user_time": 3.430635, "process_kernel_time": 0.39569, "process_mem_max_rss": "200868", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:27:30.074852 [debug] [MainThread]: Command `dbt run` failed at 20:27:30.074587 after 1.82 seconds
[0m20:27:30.075824 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71c395792300>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71c3959783e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71c395eb02f0>]}
[0m20:27:30.077342 [debug] [MainThread]: Flushing usage events
[0m20:28:08.175454 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x720f5186f890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x720f51b82f00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x720f51741190>]}


============================== 20:28:08.179509 | de8b977a-d8a3-4716-ae52-8c9567a668b8 ==============================
[0m20:28:08.179509 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:28:08.184119 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:28:08.514162 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'de8b977a-d8a3-4716-ae52-8c9567a668b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x720f51660da0>]}
[0m20:28:08.659322 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'de8b977a-d8a3-4716-ae52-8c9567a668b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x720f52adbfe0>]}
[0m20:28:08.661010 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:28:08.687987 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:28:08.906213 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:28:08.907476 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m20:28:09.198341 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:28:09.207062 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'de8b977a-d8a3-4716-ae52-8c9567a668b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x720f501dfdd0>]}
[0m20:28:09.275408 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'de8b977a-d8a3-4716-ae52-8c9567a668b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x720f50dad370>]}
[0m20:28:09.276776 [info ] [MainThread]: Found 3 models, 5 tests, 3 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:28:09.277726 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'de8b977a-d8a3-4716-ae52-8c9567a668b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x720f50dacb00>]}
[0m20:28:09.280462 [info ] [MainThread]: 
[0m20:28:09.281881 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:28:09.285076 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:28:09.298845 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:28:09.299993 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:28:09.301028 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:28:09.310547 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:28:09.312874 [debug] [ThreadPool]: On list_nba: Close
[0m20:28:09.316196 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:28:09.324873 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:28:09.325968 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:28:09.326860 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:28:09.334317 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:28:09.335826 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:28:09.337072 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:28:09.342044 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m20:28:09.344294 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:28:09.345627 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:28:09.353402 [debug] [MainThread]: Using postgres connection "master"
[0m20:28:09.354640 [debug] [MainThread]: On master: BEGIN
[0m20:28:09.355745 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:28:09.363286 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:28:09.364416 [debug] [MainThread]: Using postgres connection "master"
[0m20:28:09.365485 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:28:09.382145 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:28:09.384621 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'de8b977a-d8a3-4716-ae52-8c9567a668b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x720f50909070>]}
[0m20:28:09.386429 [debug] [MainThread]: On master: ROLLBACK
[0m20:28:09.387925 [debug] [MainThread]: Using postgres connection "master"
[0m20:28:09.388806 [debug] [MainThread]: On master: BEGIN
[0m20:28:09.390411 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:28:09.391439 [debug] [MainThread]: On master: COMMIT
[0m20:28:09.392453 [debug] [MainThread]: Using postgres connection "master"
[0m20:28:09.393288 [debug] [MainThread]: On master: COMMIT
[0m20:28:09.394438 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:28:09.395474 [debug] [MainThread]: On master: Close
[0m20:28:09.397120 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:28:09.398146 [info ] [MainThread]: 
[0m20:28:09.403015 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:28:09.404265 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:28:09.405615 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:28:09.406636 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:28:09.416280 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:28:09.442044 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:28:09.407416 => 20:28:09.441664
[0m20:28:09.443025 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:28:09.491815 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:28:09.516207 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:28:09.517397 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:28:09.519041 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:28:09.525672 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:28:09.526855 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:28:09.527939 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:28:09.549016 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:28:09.560807 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:28:09.561946 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m20:28:09.563500 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:28:09.567900 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:28:09.569872 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m20:28:09.571396 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:28:09.598282 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:28:09.599467 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:28:09.600675 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:28:09.607603 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:28:09.615712 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m20:28:09.624448 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:28:09.625626 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m20:28:09.632887 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:28:09.636319 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:28:09.443722 => 20:28:09.635880
[0m20:28:09.637320 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:28:09.638887 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de8b977a-d8a3-4716-ae52-8c9567a668b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x720f505e1010>]}
[0m20:28:09.640079 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.23s]
[0m20:28:09.641401 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:28:09.642434 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:28:09.643349 [info ] [Thread-1 (]: 2 of 3 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:28:09.644765 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m20:28:09.645721 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:28:09.649993 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:28:09.671166 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:28:09.646468 => 20:28:09.670771
[0m20:28:09.672079 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:28:09.677221 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:28:09.699047 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:28:09.700140 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:28:09.701197 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:28:09.709093 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:28:09.710131 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:28:09.711147 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m20:28:09.729017 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m20:28:09.733768 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:28:09.735171 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:28:09.737280 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:28:09.741655 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:28:09.742704 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:28:09.744173 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:28:09.747037 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:28:09.748119 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:28:09.749124 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:28:09.755515 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:28:09.759360 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:28:09.760895 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:28:09.761915 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:28:09.769384 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:28:09.772124 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:28:09.672741 => 20:28:09.771847
[0m20:28:09.773229 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:28:09.774834 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de8b977a-d8a3-4716-ae52-8c9567a668b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x720f505e07d0>]}
[0m20:28:09.776142 [info ] [Thread-1 (]: 2 of 3 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.13s]
[0m20:28:09.777492 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:28:09.778652 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:28:09.779890 [info ] [Thread-1 (]: 3 of 3 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:28:09.781221 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:28:09.782314 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:28:09.789789 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:28:09.815905 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:28:09.783137 => 20:28:09.815357
[0m20:28:09.817312 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:28:09.824445 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:28:09.853637 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:28:09.854783 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:28:09.856028 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:28:09.863265 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:28:09.864889 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:28:09.866108 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m20:28:09.897069 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m20:28:09.902519 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:28:09.903943 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m20:28:09.905528 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:28:09.911181 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:28:09.912282 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m20:28:09.913762 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:28:09.916676 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:28:09.918374 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:28:09.920295 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:28:09.927078 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:28:09.930809 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m20:28:09.932246 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:28:09.933134 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m20:28:09.941040 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:28:09.943798 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:28:09.819483 => 20:28:09.943410
[0m20:28:09.944881 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:28:09.946454 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de8b977a-d8a3-4716-ae52-8c9567a668b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x720f4fd35040>]}
[0m20:28:09.947815 [info ] [Thread-1 (]: 3 of 3 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.17s]
[0m20:28:09.949267 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:28:09.953464 [debug] [MainThread]: Using postgres connection "master"
[0m20:28:09.954543 [debug] [MainThread]: On master: BEGIN
[0m20:28:09.955469 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:28:09.962541 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:28:09.963875 [debug] [MainThread]: On master: COMMIT
[0m20:28:09.964876 [debug] [MainThread]: Using postgres connection "master"
[0m20:28:09.965806 [debug] [MainThread]: On master: COMMIT
[0m20:28:09.967021 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:28:09.968484 [debug] [MainThread]: On master: Close
[0m20:28:09.970541 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:28:09.971527 [debug] [MainThread]: Connection 'model.spurs_dbt.team_weaknesses' was properly closed.
[0m20:28:09.972765 [info ] [MainThread]: 
[0m20:28:09.973749 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 0.69 seconds (0.69s).
[0m20:28:09.975324 [debug] [MainThread]: Command end result
[0m20:28:10.030691 [info ] [MainThread]: 
[0m20:28:10.031841 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:28:10.032756 [info ] [MainThread]: 
[0m20:28:10.033793 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m20:28:10.035978 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 1.9688436, "process_user_time": 3.922913, "process_kernel_time": 0.329556, "process_mem_max_rss": "200876", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:28:10.037278 [debug] [MainThread]: Command `dbt run` succeeded at 20:28:10.037096 after 1.97 seconds
[0m20:28:10.038269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x720f51c557c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x720f4fd16f00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x720f4fd24dd0>]}
[0m20:28:10.039272 [debug] [MainThread]: Flushing usage events
[0m21:38:22.250661 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7018dd47e090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7018dd47d580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7018dd47e2d0>]}


============================== 21:38:22.256868 | b2882e99-db07-4ce4-822d-570f62c278ba ==============================
[0m21:38:22.256868 [info ] [MainThread]: Running with dbt=1.7.9
[0m21:38:22.257964 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m21:38:22.616098 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b2882e99-db07-4ce4-822d-570f62c278ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7018dc5355b0>]}
[0m21:38:22.733414 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b2882e99-db07-4ce4-822d-570f62c278ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7018dc93a300>]}
[0m21:38:22.734951 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m21:38:22.760655 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m21:38:23.037073 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m21:38:23.038539 [debug] [MainThread]: Partial parsing: added file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m21:38:23.216820 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.spurs_dbt.players_recommendations' (models/spurs_analysis/players_recommendations.sql) depends on a source named 'silver.free_agents' which was not found
[0m21:38:23.218830 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.0774593, "process_user_time": 3.300213, "process_kernel_time": 0.865956, "process_mem_max_rss": "200868", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:38:23.220291 [debug] [MainThread]: Command `dbt run` failed at 21:38:23.219954 after 1.08 seconds
[0m21:38:23.221439 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7018dd8900e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7018dc168200>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7018dd4d9d00>]}
[0m21:38:23.222476 [debug] [MainThread]: Flushing usage events
[0m21:39:21.474624 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b6d7bd58b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b6d7c60fe0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b6d8243d70>]}


============================== 21:39:21.479345 | 5b2352b2-c57f-421c-b1ab-5abcfe1755b0 ==============================
[0m21:39:21.479345 [info ] [MainThread]: Running with dbt=1.7.9
[0m21:39:21.480776 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:39:21.748734 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5b2352b2-c57f-421c-b1ab-5abcfe1755b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b6d79a5730>]}
[0m21:39:21.861864 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5b2352b2-c57f-421c-b1ab-5abcfe1755b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b6d7b73290>]}
[0m21:39:21.863245 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m21:39:21.888899 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m21:39:22.109610 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m21:39:22.110870 [debug] [MainThread]: Partial parsing: added file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m21:39:22.112193 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/sources.yml
[0m21:39:22.606366 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.spurs_dbt.players_recommendations' (models/spurs_analysis/players_recommendations.sql) depends on a source named 'silver.player_stats' which was not found
[0m21:39:22.608713 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.2174269, "process_user_time": 3.378548, "process_kernel_time": 0.299871, "process_mem_max_rss": "200888", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:39:22.609772 [debug] [MainThread]: Command `dbt run` failed at 21:39:22.609604 after 1.22 seconds
[0m21:39:22.610620 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b6d7b46000>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b6d713e9f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74b6d7493b60>]}
[0m21:39:22.611590 [debug] [MainThread]: Flushing usage events
[0m21:40:10.897209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b1545dd010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b1545dd820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b1545dcce0>]}


============================== 21:40:10.901388 | 80ad8f39-92e2-4729-9cba-4baa014ac69d ==============================
[0m21:40:10.901388 [info ] [MainThread]: Running with dbt=1.7.9
[0m21:40:10.902395 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'profiles_dir': '/usr/local/airflow/dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:40:11.163687 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '80ad8f39-92e2-4729-9cba-4baa014ac69d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b1545df530>]}
[0m21:40:11.274815 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '80ad8f39-92e2-4729-9cba-4baa014ac69d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b1544af3e0>]}
[0m21:40:11.276139 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m21:40:11.300582 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m21:40:11.485967 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m21:40:11.487103 [debug] [MainThread]: Partial parsing: added file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m21:40:11.488260 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/sources.yml
[0m21:40:12.096883 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m21:40:12.103475 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '80ad8f39-92e2-4729-9cba-4baa014ac69d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b152541220>]}
[0m21:40:12.176219 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '80ad8f39-92e2-4729-9cba-4baa014ac69d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b1535acf80>]}
[0m21:40:12.177332 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m21:40:12.178316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '80ad8f39-92e2-4729-9cba-4baa014ac69d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b152dd7ad0>]}
[0m21:40:12.181036 [info ] [MainThread]: 
[0m21:40:12.182458 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:40:12.184799 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m21:40:12.198751 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m21:40:12.199876 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m21:40:12.200792 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:40:12.211955 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m21:40:12.214150 [debug] [ThreadPool]: On list_nba: Close
[0m21:40:12.217588 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m21:40:12.226409 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:40:12.227421 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m21:40:12.228366 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:40:12.235087 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:40:12.236150 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:40:12.237094 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m21:40:12.243405 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m21:40:12.245676 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m21:40:12.246949 [debug] [ThreadPool]: On list_nba_gold: Close
[0m21:40:12.253894 [debug] [MainThread]: Using postgres connection "master"
[0m21:40:12.255075 [debug] [MainThread]: On master: BEGIN
[0m21:40:12.256349 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:40:12.264732 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:40:12.265812 [debug] [MainThread]: Using postgres connection "master"
[0m21:40:12.266818 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:40:12.286853 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m21:40:12.290107 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '80ad8f39-92e2-4729-9cba-4baa014ac69d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b15297e930>]}
[0m21:40:12.291451 [debug] [MainThread]: On master: ROLLBACK
[0m21:40:12.292650 [debug] [MainThread]: Using postgres connection "master"
[0m21:40:12.293616 [debug] [MainThread]: On master: BEGIN
[0m21:40:12.295370 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:40:12.296439 [debug] [MainThread]: On master: COMMIT
[0m21:40:12.297361 [debug] [MainThread]: Using postgres connection "master"
[0m21:40:12.298257 [debug] [MainThread]: On master: COMMIT
[0m21:40:12.299553 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:40:12.300472 [debug] [MainThread]: On master: Close
[0m21:40:12.301949 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:40:12.303023 [info ] [MainThread]: 
[0m21:40:12.309380 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m21:40:12.310744 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m21:40:12.312380 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m21:40:12.313236 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m21:40:12.324935 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m21:40:12.350330 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 21:40:12.314021 => 21:40:12.349945
[0m21:40:12.351415 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m21:40:12.399093 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m21:40:12.421671 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:40:12.423201 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m21:40:12.424261 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:40:12.430987 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:40:12.432051 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:40:12.432992 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m21:40:12.469566 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m21:40:12.478435 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:40:12.479606 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m21:40:12.481498 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:40:12.485607 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:40:12.486698 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m21:40:12.489046 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:40:12.519105 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:40:12.520348 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:40:12.522351 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:40:12.529302 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:40:12.538802 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m21:40:12.547139 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:40:12.548281 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m21:40:12.557307 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:40:12.560305 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 21:40:12.352204 => 21:40:12.560023
[0m21:40:12.561245 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m21:40:12.562821 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '80ad8f39-92e2-4729-9cba-4baa014ac69d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b151133aa0>]}
[0m21:40:12.564069 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.25s]
[0m21:40:12.565450 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m21:40:12.566430 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m21:40:12.567413 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m21:40:12.568680 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m21:40:12.569585 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m21:40:12.575199 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m21:40:12.595908 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 21:40:12.570394 => 21:40:12.595525
[0m21:40:12.596759 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m21:40:12.601793 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m21:40:12.623994 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:40:12.625003 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m21:40:12.625869 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:40:12.633475 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:40:12.634635 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:40:12.635822 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m21:40:12.653156 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m21:40:12.658912 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:40:12.660092 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m21:40:12.661862 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:40:12.666701 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:40:12.667825 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m21:40:12.669224 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:40:12.672472 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:40:12.674045 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:40:12.675105 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:40:12.683375 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:40:12.690702 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m21:40:12.692220 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:40:12.693140 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m21:40:12.700041 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:40:12.702498 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 21:40:12.597375 => 21:40:12.702229
[0m21:40:12.703922 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m21:40:12.706367 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '80ad8f39-92e2-4729-9cba-4baa014ac69d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b1511e22d0>]}
[0m21:40:12.708012 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.14s]
[0m21:40:12.709604 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m21:40:12.710750 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m21:40:12.712063 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m21:40:12.713576 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m21:40:12.714614 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m21:40:12.719876 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m21:40:12.746768 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 21:40:12.715508 => 21:40:12.746392
[0m21:40:12.747861 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m21:40:12.752924 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m21:40:12.779384 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:40:12.780360 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m21:40:12.781243 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:40:12.788248 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:40:12.789803 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:40:12.791443 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m21:40:12.837584 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:40:12.842654 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:40:12.843862 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m21:40:12.845563 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:40:12.849566 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:40:12.850597 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m21:40:12.852169 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:40:12.855002 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:40:12.856623 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:40:12.857954 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:40:12.864581 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:40:12.868416 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m21:40:12.869866 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:40:12.871003 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m21:40:12.878741 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:40:12.881554 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 21:40:12.748581 => 21:40:12.881249
[0m21:40:12.882561 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m21:40:12.884240 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '80ad8f39-92e2-4729-9cba-4baa014ac69d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b1511e2e70>]}
[0m21:40:12.885860 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.17s]
[0m21:40:12.887958 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m21:40:12.890783 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m21:40:12.892187 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m21:40:12.893772 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m21:40:12.894958 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m21:40:12.903446 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m21:40:12.926634 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 21:40:12.895993 => 21:40:12.926128
[0m21:40:12.927820 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m21:40:12.935805 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m21:40:12.969141 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:40:12.970204 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m21:40:12.971233 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:40:12.979228 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:40:12.980343 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:40:12.981516 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season,
        'avg_fg3_pct' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season,
        'avg_rebounds' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season,
        'avg_turnovers' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season,
        'avg_plus_minus' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season,
        'avg_steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season,
        'avg_blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
select SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),



ranked_free_agents AS (
    SELECT
        p.id,
        p.player_name,
        p.position,
        fa.is_free_agent,
        COALESCE(i.is_injured, FALSE) AS is_injured,
        s.salary,
        s.salary_currency,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk
    FROM "nba"."silver"."players" AS p
    LEFT JOIN player_stats AS pgs ON p.id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.id = s.player_id
    WHERE fa.is_free_agent = TRUE AND COALESCE(i.is_injured, FALSE) = FALSE
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')

    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        salary_currency,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        salary_currency,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        salary_currency,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)

SELECT
    ss.season,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.salary_currency,
    tt.reason
FROM spurs_weaknesses ss
JOIN top_targets tt ON 1=1
ORDER BY ss.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m21:40:12.983930 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "SELECT"
LINE 63: select SELECT
                ^

[0m21:40:12.985204 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m21:40:12.986660 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 21:40:12.929550 => 21:40:12.986346
[0m21:40:12.987810 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m21:40:12.995927 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "SELECT"
  LINE 63: select SELECT
                  ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:40:12.997054 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '80ad8f39-92e2-4729-9cba-4baa014ac69d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b15117d880>]}
[0m21:40:12.998281 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m21:40:12.999567 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m21:40:13.003496 [debug] [MainThread]: Using postgres connection "master"
[0m21:40:13.004549 [debug] [MainThread]: On master: BEGIN
[0m21:40:13.006113 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:40:13.013426 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:40:13.014557 [debug] [MainThread]: On master: COMMIT
[0m21:40:13.015736 [debug] [MainThread]: Using postgres connection "master"
[0m21:40:13.016602 [debug] [MainThread]: On master: COMMIT
[0m21:40:13.017860 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:40:13.018848 [debug] [MainThread]: On master: Close
[0m21:40:13.020481 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:40:13.021352 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m21:40:13.022828 [info ] [MainThread]: 
[0m21:40:13.024416 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 0.84 seconds (0.84s).
[0m21:40:13.026415 [debug] [MainThread]: Command end result
[0m21:40:13.082989 [info ] [MainThread]: 
[0m21:40:13.084053 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:40:13.084978 [info ] [MainThread]: 
[0m21:40:13.085881 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "SELECT"
  LINE 63: select SELECT
                  ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:40:13.086800 [info ] [MainThread]: 
[0m21:40:13.087733 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m21:40:13.089719 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.2740295, "process_user_time": 3.77304, "process_kernel_time": 0.395689, "process_mem_max_rss": "200868", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:40:13.090880 [debug] [MainThread]: Command `dbt run` failed at 21:40:13.090684 after 2.28 seconds
[0m21:40:13.091959 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b1546aa150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b152d1d070>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71b1511f0320>]}
[0m21:40:13.093009 [debug] [MainThread]: Flushing usage events
[0m21:42:50.471356 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71903b42acf0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71903b579730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71903b428f20>]}


============================== 21:42:50.475466 | 5b640e1c-9929-4fff-b059-6849dd6ecd45 ==============================
[0m21:42:50.475466 [info ] [MainThread]: Running with dbt=1.7.9
[0m21:42:50.476561 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m21:42:50.757564 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5b640e1c-9929-4fff-b059-6849dd6ecd45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71903af0aea0>]}
[0m21:42:50.870306 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5b640e1c-9929-4fff-b059-6849dd6ecd45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71903b485820>]}
[0m21:42:50.871605 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m21:42:50.899845 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m21:42:51.128292 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:42:51.130106 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m21:42:51.324200 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m21:42:51.331418 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5b640e1c-9929-4fff-b059-6849dd6ecd45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71903a702e40>]}
[0m21:42:51.402672 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5b640e1c-9929-4fff-b059-6849dd6ecd45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71903a76d580>]}
[0m21:42:51.403797 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m21:42:51.404750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5b640e1c-9929-4fff-b059-6849dd6ecd45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71903a3ceea0>]}
[0m21:42:51.407761 [info ] [MainThread]: 
[0m21:42:51.409188 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:42:51.412369 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m21:42:51.425765 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m21:42:51.427249 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m21:42:51.428597 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:42:51.439427 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m21:42:51.441920 [debug] [ThreadPool]: On list_nba: Close
[0m21:42:51.446458 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m21:42:51.455828 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:42:51.456960 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m21:42:51.458124 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:42:51.468404 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:42:51.469886 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:42:51.470816 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m21:42:51.476715 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m21:42:51.479479 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m21:42:51.480809 [debug] [ThreadPool]: On list_nba_gold: Close
[0m21:42:51.488887 [debug] [MainThread]: Using postgres connection "master"
[0m21:42:51.490176 [debug] [MainThread]: On master: BEGIN
[0m21:42:51.491189 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:42:51.499837 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:42:51.501015 [debug] [MainThread]: Using postgres connection "master"
[0m21:42:51.502090 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:42:51.518168 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m21:42:51.520438 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5b640e1c-9929-4fff-b059-6849dd6ecd45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71903a76e4b0>]}
[0m21:42:51.521618 [debug] [MainThread]: On master: ROLLBACK
[0m21:42:51.522915 [debug] [MainThread]: Using postgres connection "master"
[0m21:42:51.523827 [debug] [MainThread]: On master: BEGIN
[0m21:42:51.525538 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:42:51.526508 [debug] [MainThread]: On master: COMMIT
[0m21:42:51.527645 [debug] [MainThread]: Using postgres connection "master"
[0m21:42:51.529471 [debug] [MainThread]: On master: COMMIT
[0m21:42:51.530833 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:42:51.531709 [debug] [MainThread]: On master: Close
[0m21:42:51.533076 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:42:51.534152 [info ] [MainThread]: 
[0m21:42:51.538599 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m21:42:51.539733 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m21:42:51.541089 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m21:42:51.542102 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m21:42:51.554807 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m21:42:51.582349 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 21:42:51.542865 => 21:42:51.581933
[0m21:42:51.583383 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m21:42:51.641923 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m21:42:51.669650 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:42:51.670740 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m21:42:51.672041 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:42:51.679802 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:42:51.680878 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:42:51.681844 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m21:42:51.707085 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m21:42:51.721477 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:42:51.722675 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m21:42:51.724400 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:42:51.730702 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:42:51.731771 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m21:42:51.733181 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:42:51.759449 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:42:51.761027 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:42:51.763006 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:42:51.775287 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:42:51.784468 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m21:42:51.792008 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:42:51.793328 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m21:42:51.802960 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:42:51.805555 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 21:42:51.584248 => 21:42:51.805182
[0m21:42:51.806592 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m21:42:51.808089 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5b640e1c-9929-4fff-b059-6849dd6ecd45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x719039fbb7a0>]}
[0m21:42:51.809427 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.27s]
[0m21:42:51.811904 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m21:42:51.813385 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m21:42:51.814485 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m21:42:51.815840 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m21:42:51.816843 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m21:42:51.821222 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m21:42:51.845210 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 21:42:51.817645 => 21:42:51.844672
[0m21:42:51.846605 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m21:42:51.852152 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m21:42:51.875356 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:42:51.876327 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m21:42:51.877724 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:42:51.886292 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:42:51.887270 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:42:51.888273 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m21:42:51.907300 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m21:42:51.912815 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:42:51.913840 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m21:42:51.915276 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:42:51.920015 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:42:51.920971 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m21:42:51.922320 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:42:51.925002 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:42:51.925982 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:42:51.926883 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:42:51.935559 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:42:51.940638 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m21:42:51.942011 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:42:51.942850 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m21:42:51.954991 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:42:51.957388 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 21:42:51.847278 => 21:42:51.957030
[0m21:42:51.958282 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m21:42:51.959624 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5b640e1c-9929-4fff-b059-6849dd6ecd45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71903ab0bbc0>]}
[0m21:42:51.961403 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.14s]
[0m21:42:51.963294 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m21:42:51.964254 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m21:42:51.965189 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m21:42:51.966646 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m21:42:51.967477 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m21:42:51.972160 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m21:42:51.997883 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 21:42:51.968103 => 21:42:51.997479
[0m21:42:51.998819 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m21:42:52.003802 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m21:42:52.035086 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:42:52.036652 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m21:42:52.038696 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:42:52.048400 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:42:52.049652 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:42:52.051097 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m21:42:52.087851 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:42:52.093124 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:42:52.094747 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m21:42:52.097090 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:42:52.101408 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:42:52.102854 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m21:42:52.104933 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:42:52.108122 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:42:52.109121 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:42:52.110419 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:42:52.123869 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:42:52.128730 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m21:42:52.130411 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:42:52.131450 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m21:42:52.145686 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:42:52.148148 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 21:42:51.999475 => 21:42:52.147878
[0m21:42:52.149197 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m21:42:52.150916 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5b640e1c-9929-4fff-b059-6849dd6ecd45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x719039b8b260>]}
[0m21:42:52.152189 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.18s]
[0m21:42:52.153800 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m21:42:52.155647 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m21:42:52.156873 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m21:42:52.158348 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m21:42:52.159339 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m21:42:52.167964 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m21:42:52.191700 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 21:42:52.160134 => 21:42:52.191310
[0m21:42:52.193107 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m21:42:52.199683 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m21:42:52.226251 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:42:52.228090 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m21:42:52.229870 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:42:52.238075 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:42:52.239650 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:42:52.240999 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season,
        'avg_fg3_pct' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season,
        'avg_rebounds' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season,
        'avg_turnovers' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season,
        'avg_plus_minus' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season,
        'avg_steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season,
        'avg_blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),



ranked_free_agents AS (
    SELECT
        p.id,
        p.player_name,
        p.position,
        fa.is_free_agent,
        COALESCE(i.is_injured, FALSE) AS is_injured,
        s.salary,
        s.salary_currency,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk
    FROM "nba"."silver"."players" AS p
    LEFT JOIN player_stats AS pgs ON p.id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.id = s.player_id
    WHERE fa.is_free_agent = TRUE AND COALESCE(i.is_injured, FALSE) = FALSE
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')

    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        salary_currency,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        salary_currency,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        salary_currency,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)

SELECT
    ss.season,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.salary_currency,
    tt.reason
FROM spurs_weaknesses ss
JOIN top_targets tt ON 1=1
ORDER BY ss.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m21:42:52.243761 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "season" does not exist
LINE 16:         season,
                 ^
HINT:  Perhaps you meant to reference the column "team_weaknesses.season2".

[0m21:42:52.245658 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m21:42:52.247277 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 21:42:52.194360 => 21:42:52.246959
[0m21:42:52.248222 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m21:42:52.257942 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column "season" does not exist
  LINE 16:         season,
                   ^
  HINT:  Perhaps you meant to reference the column "team_weaknesses.season2".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:42:52.261244 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5b640e1c-9929-4fff-b059-6849dd6ecd45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x719039fe8b00>]}
[0m21:42:52.263831 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m21:42:52.265200 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m21:42:52.268920 [debug] [MainThread]: Using postgres connection "master"
[0m21:42:52.269908 [debug] [MainThread]: On master: BEGIN
[0m21:42:52.270802 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:42:52.277689 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:42:52.279337 [debug] [MainThread]: On master: COMMIT
[0m21:42:52.280322 [debug] [MainThread]: Using postgres connection "master"
[0m21:42:52.281249 [debug] [MainThread]: On master: COMMIT
[0m21:42:52.282723 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:42:52.283683 [debug] [MainThread]: On master: Close
[0m21:42:52.285138 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:42:52.286189 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m21:42:52.287341 [info ] [MainThread]: 
[0m21:42:52.288334 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 0.88 seconds (0.88s).
[0m21:42:52.290331 [debug] [MainThread]: Command end result
[0m21:42:52.349135 [info ] [MainThread]: 
[0m21:42:52.350365 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:42:52.351332 [info ] [MainThread]: 
[0m21:42:52.352352 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column "season" does not exist
  LINE 16:         season,
                   ^
  HINT:  Perhaps you meant to reference the column "team_weaknesses.season2".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:42:52.353428 [info ] [MainThread]: 
[0m21:42:52.354398 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m21:42:52.355907 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.971126, "process_user_time": 3.448115, "process_kernel_time": 0.380454, "process_mem_max_rss": "200880", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:42:52.357052 [debug] [MainThread]: Command `dbt run` failed at 21:42:52.356876 after 1.97 seconds
[0m21:42:52.358139 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71903b578830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71903b429160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71903af0b080>]}
[0m21:42:52.359184 [debug] [MainThread]: Flushing usage events
[0m21:44:21.083063 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cd31802cd70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cd31802fd10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cd31802cc50>]}


============================== 21:44:21.087095 | bd9299d3-1b41-46d6-ad12-c1b73e1e9225 ==============================
[0m21:44:21.087095 [info ] [MainThread]: Running with dbt=1.7.9
[0m21:44:21.088179 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m21:44:21.366592 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bd9299d3-1b41-46d6-ad12-c1b73e1e9225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cd31802ce90>]}
[0m21:44:21.480766 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bd9299d3-1b41-46d6-ad12-c1b73e1e9225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cd317342360>]}
[0m21:44:21.482304 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m21:44:21.510787 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m21:44:21.759061 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:44:21.761462 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m21:44:21.947978 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m21:44:21.955342 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bd9299d3-1b41-46d6-ad12-c1b73e1e9225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cd31731ca10>]}
[0m21:44:22.027286 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bd9299d3-1b41-46d6-ad12-c1b73e1e9225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cd3173ada00>]}
[0m21:44:22.028968 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m21:44:22.030055 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bd9299d3-1b41-46d6-ad12-c1b73e1e9225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cd316b82ff0>]}
[0m21:44:22.033051 [info ] [MainThread]: 
[0m21:44:22.034840 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:44:22.037603 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m21:44:22.051820 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m21:44:22.052934 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m21:44:22.053901 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:44:22.063814 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m21:44:22.066292 [debug] [ThreadPool]: On list_nba: Close
[0m21:44:22.069879 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m21:44:22.078791 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:44:22.079872 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m21:44:22.080870 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:44:22.088548 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:44:22.089612 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:44:22.090674 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m21:44:22.097110 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m21:44:22.099336 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m21:44:22.100778 [debug] [ThreadPool]: On list_nba_gold: Close
[0m21:44:22.108072 [debug] [MainThread]: Using postgres connection "master"
[0m21:44:22.109137 [debug] [MainThread]: On master: BEGIN
[0m21:44:22.110847 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:44:22.119410 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:44:22.120486 [debug] [MainThread]: Using postgres connection "master"
[0m21:44:22.121426 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:44:22.137800 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m21:44:22.140057 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bd9299d3-1b41-46d6-ad12-c1b73e1e9225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cd3173afd70>]}
[0m21:44:22.141076 [debug] [MainThread]: On master: ROLLBACK
[0m21:44:22.142346 [debug] [MainThread]: Using postgres connection "master"
[0m21:44:22.143541 [debug] [MainThread]: On master: BEGIN
[0m21:44:22.146018 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:44:22.147063 [debug] [MainThread]: On master: COMMIT
[0m21:44:22.147930 [debug] [MainThread]: Using postgres connection "master"
[0m21:44:22.148760 [debug] [MainThread]: On master: COMMIT
[0m21:44:22.150002 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:44:22.150870 [debug] [MainThread]: On master: Close
[0m21:44:22.152325 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:44:22.154594 [info ] [MainThread]: 
[0m21:44:22.159972 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m21:44:22.162063 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m21:44:22.164403 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m21:44:22.166411 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m21:44:22.179196 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m21:44:22.204866 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 21:44:22.167475 => 21:44:22.204471
[0m21:44:22.206052 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m21:44:22.264794 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m21:44:22.288491 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:44:22.289529 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m21:44:22.290618 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:22.298122 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:22.299339 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:44:22.300334 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m21:44:22.319358 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m21:44:22.328314 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:44:22.329453 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m21:44:22.331033 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:22.335235 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:44:22.336227 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m21:44:22.337973 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:22.366265 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:44:22.367374 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:44:22.368263 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:44:22.374230 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:22.383374 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m21:44:22.391314 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:44:22.392442 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m21:44:22.401351 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:22.403945 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 21:44:22.206866 => 21:44:22.403671
[0m21:44:22.404940 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m21:44:22.406658 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bd9299d3-1b41-46d6-ad12-c1b73e1e9225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cd31670b740>]}
[0m21:44:22.407934 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.24s]
[0m21:44:22.409769 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m21:44:22.411997 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m21:44:22.413110 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m21:44:22.414463 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m21:44:22.415497 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m21:44:22.419993 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m21:44:22.441625 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 21:44:22.416245 => 21:44:22.441228
[0m21:44:22.442794 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m21:44:22.448574 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m21:44:22.471351 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:44:22.472313 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m21:44:22.473358 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:22.481225 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:22.482259 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:44:22.483246 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m21:44:22.504129 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m21:44:22.508660 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:44:22.509973 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m21:44:22.511871 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:22.519815 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:44:22.522253 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m21:44:22.525316 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:22.533574 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:44:22.536121 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:44:22.538316 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:44:22.549412 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:22.563839 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m21:44:22.567635 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:44:22.569879 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m21:44:22.579315 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:22.582496 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 21:44:22.444046 => 21:44:22.582122
[0m21:44:22.583674 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m21:44:22.585490 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bd9299d3-1b41-46d6-ad12-c1b73e1e9225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cd3167cc590>]}
[0m21:44:22.586944 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.17s]
[0m21:44:22.589211 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m21:44:22.591111 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m21:44:22.592748 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m21:44:22.595574 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m21:44:22.596854 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m21:44:22.603455 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m21:44:22.631352 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 21:44:22.597812 => 21:44:22.630858
[0m21:44:22.632722 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m21:44:22.637829 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m21:44:22.664067 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:44:22.665030 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m21:44:22.666046 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:22.673423 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:22.674598 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:44:22.675738 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m21:44:22.712300 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:22.716656 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:44:22.717804 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m21:44:22.719432 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:22.723578 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:44:22.724635 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m21:44:22.726815 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:22.730328 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:44:22.731414 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:44:22.732472 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:44:22.741652 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:22.746570 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m21:44:22.748158 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:44:22.749238 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m21:44:22.756525 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:22.759147 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 21:44:22.633521 => 21:44:22.758883
[0m21:44:22.760602 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m21:44:22.762731 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bd9299d3-1b41-46d6-ad12-c1b73e1e9225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cd3167ceb10>]}
[0m21:44:22.765731 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.17s]
[0m21:44:22.767268 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m21:44:22.769246 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m21:44:22.770507 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m21:44:22.772075 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m21:44:22.773280 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m21:44:22.782865 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m21:44:22.809178 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 21:44:22.774107 => 21:44:22.808767
[0m21:44:22.811137 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m21:44:22.816647 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m21:44:22.841275 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:44:22.842294 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m21:44:22.843555 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:22.850390 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:22.851547 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:44:22.852781 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        'avg_fg3_pct' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_rebounds' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_turnovers' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_plus_minus' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'avg_steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),



ranked_free_agents AS (
    SELECT
        p.id,
        p.player_name,
        p.position,
        fa.is_free_agent,
        COALESCE(i.is_injured, FALSE) AS is_injured,
        s.salary,
        s.salary_currency,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk
    FROM "nba"."silver"."players" AS p
    LEFT JOIN player_stats AS pgs ON p.id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.id = s.player_id
    WHERE fa.is_free_agent = TRUE AND COALESCE(i.is_injured, FALSE) = FALSE
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')

    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        salary_currency,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        salary_currency,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        salary_currency,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)

SELECT
    ss.season,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.salary_currency,
    tt.reason
FROM spurs_weaknesses ss
JOIN top_targets tt ON 1=1
ORDER BY ss.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m21:44:22.857055 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column p.id does not exist
LINE 94:     LEFT JOIN player_stats AS pgs ON p.id = pgs.player_id
                                              ^

[0m21:44:22.858248 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m21:44:22.860120 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 21:44:22.812184 => 21:44:22.859582
[0m21:44:22.861289 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m21:44:22.866935 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column p.id does not exist
  LINE 94:     LEFT JOIN player_stats AS pgs ON p.id = pgs.player_id
                                                ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:44:22.868160 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bd9299d3-1b41-46d6-ad12-c1b73e1e9225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cd3167cdc10>]}
[0m21:44:22.869442 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m21:44:22.870932 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m21:44:22.875008 [debug] [MainThread]: Using postgres connection "master"
[0m21:44:22.876311 [debug] [MainThread]: On master: BEGIN
[0m21:44:22.878279 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:44:22.887291 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:44:22.888283 [debug] [MainThread]: On master: COMMIT
[0m21:44:22.889120 [debug] [MainThread]: Using postgres connection "master"
[0m21:44:22.889983 [debug] [MainThread]: On master: COMMIT
[0m21:44:22.891383 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:44:22.892264 [debug] [MainThread]: On master: Close
[0m21:44:22.894038 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:44:22.895057 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m21:44:22.896138 [info ] [MainThread]: 
[0m21:44:22.897205 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 0.86 seconds (0.86s).
[0m21:44:22.899125 [debug] [MainThread]: Command end result
[0m21:44:22.953455 [info ] [MainThread]: 
[0m21:44:22.954615 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:44:22.955454 [info ] [MainThread]: 
[0m21:44:22.956298 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column p.id does not exist
  LINE 94:     LEFT JOIN player_stats AS pgs ON p.id = pgs.player_id
                                                ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:44:22.957157 [info ] [MainThread]: 
[0m21:44:22.957999 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m21:44:22.959756 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.9618374, "process_user_time": 3.380652, "process_kernel_time": 0.398661, "process_mem_max_rss": "200872", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:44:22.961319 [debug] [MainThread]: Command `dbt run` failed at 21:44:22.961097 after 1.96 seconds
[0m21:44:22.962367 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cd318646ea0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cd3177e6360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cd316bfb1a0>]}
[0m21:44:22.963334 [debug] [MainThread]: Flushing usage events
[0m21:46:51.557454 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x703154a54c20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x703154a564b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x703154a54dd0>]}


============================== 21:46:51.562597 | 8fbbc45f-424b-4529-82f5-7b00013eaab1 ==============================
[0m21:46:51.562597 [info ] [MainThread]: Running with dbt=1.7.9
[0m21:46:51.571107 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m21:46:51.870128 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8fbbc45f-424b-4529-82f5-7b00013eaab1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x703154977dd0>]}
[0m21:46:51.980641 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8fbbc45f-424b-4529-82f5-7b00013eaab1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x703154976360>]}
[0m21:46:51.982131 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m21:46:52.007393 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m21:46:52.249661 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:46:52.251044 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m21:46:52.453402 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m21:46:52.459952 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8fbbc45f-424b-4529-82f5-7b00013eaab1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x703153d42840>]}
[0m21:46:52.526294 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8fbbc45f-424b-4529-82f5-7b00013eaab1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x703153dad7f0>]}
[0m21:46:52.527396 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m21:46:52.528601 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8fbbc45f-424b-4529-82f5-7b00013eaab1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x703153578380>]}
[0m21:46:52.532332 [info ] [MainThread]: 
[0m21:46:52.534015 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:46:52.536452 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m21:46:52.550219 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m21:46:52.551288 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m21:46:52.552190 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:46:52.561389 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m21:46:52.564212 [debug] [ThreadPool]: On list_nba: Close
[0m21:46:52.567656 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m21:46:52.575235 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:46:52.576243 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m21:46:52.577210 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:46:52.585223 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:46:52.586230 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:46:52.587007 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m21:46:52.591879 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m21:46:52.593880 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m21:46:52.595303 [debug] [ThreadPool]: On list_nba_gold: Close
[0m21:46:52.603377 [debug] [MainThread]: Using postgres connection "master"
[0m21:46:52.604617 [debug] [MainThread]: On master: BEGIN
[0m21:46:52.605610 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:46:52.612722 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:46:52.614091 [debug] [MainThread]: Using postgres connection "master"
[0m21:46:52.615143 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:46:52.631354 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m21:46:52.633666 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8fbbc45f-424b-4529-82f5-7b00013eaab1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x703153d43b60>]}
[0m21:46:52.634615 [debug] [MainThread]: On master: ROLLBACK
[0m21:46:52.635876 [debug] [MainThread]: Using postgres connection "master"
[0m21:46:52.636876 [debug] [MainThread]: On master: BEGIN
[0m21:46:52.638698 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:46:52.639682 [debug] [MainThread]: On master: COMMIT
[0m21:46:52.640741 [debug] [MainThread]: Using postgres connection "master"
[0m21:46:52.641637 [debug] [MainThread]: On master: COMMIT
[0m21:46:52.642854 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:46:52.643807 [debug] [MainThread]: On master: Close
[0m21:46:52.645962 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:46:52.647676 [info ] [MainThread]: 
[0m21:46:52.651737 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m21:46:52.652925 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m21:46:52.654337 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m21:46:52.655305 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m21:46:52.667441 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m21:46:52.692873 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 21:46:52.656089 => 21:46:52.692215
[0m21:46:52.693979 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m21:46:52.741417 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m21:46:52.767624 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:46:52.768687 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m21:46:52.769580 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:46:52.776166 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:46:52.777350 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:46:52.778536 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m21:46:52.806478 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m21:46:52.815574 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:46:52.816743 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m21:46:52.818251 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:52.822454 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:46:52.823437 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m21:46:52.825015 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:52.851987 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:46:52.853139 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:46:52.853978 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:46:52.859871 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:46:52.869380 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m21:46:52.876718 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:46:52.877701 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m21:46:52.887934 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:46:52.890404 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 21:46:52.695088 => 21:46:52.890147
[0m21:46:52.891389 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m21:46:52.893085 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fbbc45f-424b-4529-82f5-7b00013eaab1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70315310b710>]}
[0m21:46:52.894398 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.24s]
[0m21:46:52.897025 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m21:46:52.898332 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m21:46:52.899408 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m21:46:52.900877 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m21:46:52.901774 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m21:46:52.906414 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m21:46:52.934449 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 21:46:52.902664 => 21:46:52.934026
[0m21:46:52.935485 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m21:46:52.941228 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m21:46:52.964822 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:46:52.965786 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m21:46:52.966635 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:46:52.974011 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:46:52.975249 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:46:52.976816 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m21:46:52.997001 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m21:46:53.002108 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:46:53.003434 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m21:46:53.005236 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:53.011291 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:46:53.013150 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m21:46:53.015406 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:53.018836 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:46:53.020048 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:46:53.021166 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:46:53.026952 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:46:53.035678 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m21:46:53.037654 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:46:53.039001 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m21:46:53.046579 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:46:53.049224 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 21:46:52.936249 => 21:46:53.048922
[0m21:46:53.050174 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m21:46:53.051829 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fbbc45f-424b-4529-82f5-7b00013eaab1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7031531caa20>]}
[0m21:46:53.053294 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m21:46:53.054854 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m21:46:53.056146 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m21:46:53.057567 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m21:46:53.059112 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m21:46:53.060175 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m21:46:53.067323 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m21:46:53.098196 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 21:46:53.061079 => 21:46:53.097803
[0m21:46:53.099119 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m21:46:53.104807 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m21:46:53.130929 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:46:53.131945 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m21:46:53.132842 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:46:53.139433 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:46:53.140408 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:46:53.141572 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m21:46:53.175407 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:46:53.181141 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:46:53.182373 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m21:46:53.183966 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:53.188325 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:46:53.189735 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m21:46:53.191811 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:53.195079 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:46:53.196908 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:46:53.198115 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:46:53.204217 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:46:53.208788 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m21:46:53.210391 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:46:53.211464 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m21:46:53.221453 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:46:53.223842 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 21:46:53.099807 => 21:46:53.223581
[0m21:46:53.225048 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m21:46:53.226592 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fbbc45f-424b-4529-82f5-7b00013eaab1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7031531c8d40>]}
[0m21:46:53.230324 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.17s]
[0m21:46:53.231805 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m21:46:53.233758 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m21:46:53.234875 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m21:46:53.236228 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m21:46:53.237357 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m21:46:53.245187 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m21:46:53.273034 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 21:46:53.238167 => 21:46:53.272468
[0m21:46:53.274011 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m21:46:53.280814 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m21:46:53.306534 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:46:53.307561 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m21:46:53.308580 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:46:53.316755 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:46:53.317870 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:46:53.319026 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        'avg_fg3_pct' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_rebounds' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_turnovers' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_plus_minus' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'avg_steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),



ranked_free_agents AS (
    SELECT
        p.id,
        p.player_name,
        p.position,
        fa.is_free_agent,
        COALESCE(i.is_injured, FALSE) AS is_injured,
        s.salary,
        s.salary_currency,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk
    FROM "nba"."silver"."players" AS p
    LEFT JOIN player_stats AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    WHERE fa.is_free_agent = TRUE AND COALESCE(i.is_injured, FALSE) = FALSE
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')

    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        salary_currency,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        salary_currency,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        salary_currency,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)

SELECT
    ss.season,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.salary_currency,
    tt.reason
FROM spurs_weaknesses ss
JOIN top_targets tt ON 1=1
ORDER BY ss.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m21:46:53.322558 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column p.id does not exist
LINE 75:         p.id,
                 ^

[0m21:46:53.323698 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m21:46:53.325201 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 21:46:53.274768 => 21:46:53.324907
[0m21:46:53.326175 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m21:46:53.332635 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column p.id does not exist
  LINE 75:         p.id,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:46:53.333837 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fbbc45f-424b-4529-82f5-7b00013eaab1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70315317b320>]}
[0m21:46:53.335076 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m21:46:53.336398 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m21:46:53.340761 [debug] [MainThread]: Using postgres connection "master"
[0m21:46:53.341649 [debug] [MainThread]: On master: BEGIN
[0m21:46:53.342441 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:46:53.350841 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:46:53.351908 [debug] [MainThread]: On master: COMMIT
[0m21:46:53.352888 [debug] [MainThread]: Using postgres connection "master"
[0m21:46:53.353863 [debug] [MainThread]: On master: COMMIT
[0m21:46:53.355045 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:46:53.356066 [debug] [MainThread]: On master: Close
[0m21:46:53.357606 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:46:53.358595 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m21:46:53.359704 [info ] [MainThread]: 
[0m21:46:53.360812 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 0.83 seconds (0.83s).
[0m21:46:53.363450 [debug] [MainThread]: Command end result
[0m21:46:53.421948 [info ] [MainThread]: 
[0m21:46:53.423047 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:46:53.424039 [info ] [MainThread]: 
[0m21:46:53.425244 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column p.id does not exist
  LINE 75:         p.id,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:46:53.426289 [info ] [MainThread]: 
[0m21:46:53.427323 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m21:46:53.429427 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.9590901, "process_user_time": 3.783586, "process_kernel_time": 0.387547, "process_mem_max_rss": "200868", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:46:53.431028 [debug] [MainThread]: Command `dbt run` failed at 21:46:53.430809 after 1.96 seconds
[0m21:46:53.432016 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x703154a54c20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70315316a810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7031531c6930>]}
[0m21:46:53.432906 [debug] [MainThread]: Flushing usage events
[0m21:47:54.497999 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7566dc2e4d70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7566dc2e7920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7566dc2e4e60>]}


============================== 21:47:54.503017 | 9fd8750d-4aa7-4e39-9cc0-2cf5d1cf0210 ==============================
[0m21:47:54.503017 [info ] [MainThread]: Running with dbt=1.7.9
[0m21:47:54.504155 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m21:47:54.824015 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9fd8750d-4aa7-4e39-9cc0-2cf5d1cf0210', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7566dc204a70>]}
[0m21:47:54.935515 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9fd8750d-4aa7-4e39-9cc0-2cf5d1cf0210', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7566db949d90>]}
[0m21:47:54.937065 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m21:47:54.961018 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m21:47:55.249530 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:47:55.251448 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m21:47:55.461268 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m21:47:55.469005 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9fd8750d-4aa7-4e39-9cc0-2cf5d1cf0210', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7566dc205e50>]}
[0m21:47:55.546521 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9fd8750d-4aa7-4e39-9cc0-2cf5d1cf0210', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7566db5ac7a0>]}
[0m21:47:55.547513 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m21:47:55.548459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9fd8750d-4aa7-4e39-9cc0-2cf5d1cf0210', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7566dad0f860>]}
[0m21:47:55.552767 [info ] [MainThread]: 
[0m21:47:55.554323 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:47:55.556883 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m21:47:55.571278 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m21:47:55.572417 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m21:47:55.573595 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:47:55.585745 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m21:47:55.587931 [debug] [ThreadPool]: On list_nba: Close
[0m21:47:55.590993 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m21:47:55.598559 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:47:55.599616 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m21:47:55.600960 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:47:55.608960 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:47:55.610026 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:47:55.610989 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m21:47:55.616144 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m21:47:55.621482 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m21:47:55.625785 [debug] [ThreadPool]: On list_nba_gold: Close
[0m21:47:55.634228 [debug] [MainThread]: Using postgres connection "master"
[0m21:47:55.637230 [debug] [MainThread]: On master: BEGIN
[0m21:47:55.639761 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:47:55.646798 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:47:55.647979 [debug] [MainThread]: Using postgres connection "master"
[0m21:47:55.648984 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:47:55.664415 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m21:47:55.666889 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9fd8750d-4aa7-4e39-9cc0-2cf5d1cf0210', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7566db5afd10>]}
[0m21:47:55.668987 [debug] [MainThread]: On master: ROLLBACK
[0m21:47:55.670266 [debug] [MainThread]: Using postgres connection "master"
[0m21:47:55.671129 [debug] [MainThread]: On master: BEGIN
[0m21:47:55.672826 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:47:55.673722 [debug] [MainThread]: On master: COMMIT
[0m21:47:55.674549 [debug] [MainThread]: Using postgres connection "master"
[0m21:47:55.675392 [debug] [MainThread]: On master: COMMIT
[0m21:47:55.676757 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:47:55.677779 [debug] [MainThread]: On master: Close
[0m21:47:55.679301 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:47:55.680378 [info ] [MainThread]: 
[0m21:47:55.686384 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m21:47:55.688170 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m21:47:55.690030 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m21:47:55.691237 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m21:47:55.702231 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m21:47:55.727884 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 21:47:55.692122 => 21:47:55.727480
[0m21:47:55.728916 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m21:47:55.796928 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m21:47:55.824930 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:47:55.825980 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m21:47:55.826949 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:47:55.833786 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:47:55.835582 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:47:55.836805 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m21:47:55.869107 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m21:47:55.877452 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:47:55.878559 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m21:47:55.880130 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:55.888184 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:47:55.891646 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m21:47:55.894621 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:55.931695 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:47:55.933000 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:47:55.934796 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:47:55.940869 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:47:55.950202 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m21:47:55.958831 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:47:55.959931 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m21:47:55.968949 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:47:55.971776 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 21:47:55.729747 => 21:47:55.971503
[0m21:47:55.973058 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m21:47:55.974858 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fd8750d-4aa7-4e39-9cc0-2cf5d1cf0210', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7566db9a3ad0>]}
[0m21:47:55.976489 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.29s]
[0m21:47:55.978185 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m21:47:55.979381 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m21:47:55.980445 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m21:47:55.982097 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m21:47:55.983337 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m21:47:55.988674 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m21:47:56.012504 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 21:47:55.984498 => 21:47:56.012099
[0m21:47:56.013671 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m21:47:56.019905 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m21:47:56.048200 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:47:56.049363 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m21:47:56.050641 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:47:56.057801 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:47:56.058926 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:47:56.059930 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m21:47:56.078945 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m21:47:56.084807 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:47:56.085984 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m21:47:56.087504 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:56.091835 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:47:56.092946 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m21:47:56.094418 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:56.097486 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:47:56.098580 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:47:56.099630 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:47:56.107553 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:47:56.112952 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m21:47:56.114490 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:47:56.115495 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m21:47:56.123819 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:47:56.126359 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 21:47:56.014487 => 21:47:56.126086
[0m21:47:56.127346 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m21:47:56.128955 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fd8750d-4aa7-4e39-9cc0-2cf5d1cf0210', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7566da9ca600>]}
[0m21:47:56.130167 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m21:47:56.131533 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m21:47:56.132800 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m21:47:56.134651 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m21:47:56.136409 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m21:47:56.137568 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m21:47:56.142553 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m21:47:56.179976 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 21:47:56.138292 => 21:47:56.179588
[0m21:47:56.180913 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m21:47:56.187164 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m21:47:56.212239 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:47:56.213330 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m21:47:56.214175 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:47:56.221910 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:47:56.223129 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:47:56.224381 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m21:47:56.257724 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:47:56.262568 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:47:56.263779 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m21:47:56.265502 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:56.272818 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:47:56.274583 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m21:47:56.277222 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:56.281092 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:47:56.282313 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:47:56.283611 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:47:56.292296 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:47:56.299303 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m21:47:56.308627 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:47:56.310899 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m21:47:56.320059 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:47:56.323045 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 21:47:56.181715 => 21:47:56.322709
[0m21:47:56.324344 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m21:47:56.326555 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fd8750d-4aa7-4e39-9cc0-2cf5d1cf0210', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7566da9c9220>]}
[0m21:47:56.328973 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.19s]
[0m21:47:56.330976 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m21:47:56.333807 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m21:47:56.335868 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m21:47:56.337592 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m21:47:56.338961 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m21:47:56.349883 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m21:47:56.376130 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 21:47:56.339870 => 21:47:56.375594
[0m21:47:56.377381 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m21:47:56.385528 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m21:47:56.411946 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:47:56.413850 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m21:47:56.415678 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:47:56.433975 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:47:56.437459 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:47:56.439810 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        'avg_fg3_pct' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_rebounds' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_turnovers' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_plus_minus' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'avg_steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player_name,
        p.position,
        fa.is_free_agent,
        COALESCE(i.is_injured, FALSE) AS is_injured,
        s.salary,
        s.salary_currency,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk
    FROM "nba"."silver"."players" AS p
    LEFT JOIN player_stats AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    WHERE fa.is_free_agent = TRUE AND COALESCE(i.is_injured, FALSE) = FALSE
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')

    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        salary_currency,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        salary_currency,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        salary_currency,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)

SELECT
    ss.season,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.salary_currency,
    tt.reason
FROM spurs_weaknesses ss
JOIN top_targets tt ON 1=1
ORDER BY ss.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m21:47:56.444649 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column p.player_name does not exist
LINE 76:         p.player_name,
                 ^
HINT:  Perhaps you meant to reference the column "i.player_name" or the column "s.player_name".

[0m21:47:56.446165 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m21:47:56.447794 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 21:47:56.378285 => 21:47:56.447452
[0m21:47:56.448949 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m21:47:56.455205 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column p.player_name does not exist
  LINE 76:         p.player_name,
                   ^
  HINT:  Perhaps you meant to reference the column "i.player_name" or the column "s.player_name".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:47:56.456184 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fd8750d-4aa7-4e39-9cc0-2cf5d1cf0210', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7566da9ca8a0>]}
[0m21:47:56.457244 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.12s]
[0m21:47:56.458415 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m21:47:56.461684 [debug] [MainThread]: Using postgres connection "master"
[0m21:47:56.462494 [debug] [MainThread]: On master: BEGIN
[0m21:47:56.463162 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:47:56.470156 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:47:56.470977 [debug] [MainThread]: On master: COMMIT
[0m21:47:56.471678 [debug] [MainThread]: Using postgres connection "master"
[0m21:47:56.472302 [debug] [MainThread]: On master: COMMIT
[0m21:47:56.473247 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:47:56.473900 [debug] [MainThread]: On master: Close
[0m21:47:56.475063 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:47:56.476961 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m21:47:56.477779 [info ] [MainThread]: 
[0m21:47:56.478780 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 0.92 seconds (0.92s).
[0m21:47:56.480437 [debug] [MainThread]: Command end result
[0m21:47:56.528929 [info ] [MainThread]: 
[0m21:47:56.530244 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:47:56.531197 [info ] [MainThread]: 
[0m21:47:56.532061 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column p.player_name does not exist
  LINE 76:         p.player_name,
                   ^
  HINT:  Perhaps you meant to reference the column "i.player_name" or the column "s.player_name".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:47:56.532954 [info ] [MainThread]: 
[0m21:47:56.534453 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m21:47:56.536200 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.1373549, "process_user_time": 3.632665, "process_kernel_time": 0.396509, "process_mem_max_rss": "200876", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:47:56.537239 [debug] [MainThread]: Command `dbt run` failed at 21:47:56.537063 after 2.14 seconds
[0m21:47:56.538032 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7566dc2e4d70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7566dc413260>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7566dad1bda0>]}
[0m21:47:56.538920 [debug] [MainThread]: Flushing usage events
[0m21:49:29.027613 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e069ca32570>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e069d0eb8c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e069cb33a10>]}


============================== 21:49:29.035244 | 86b4afd4-0af0-45ff-b112-4b8d5b8e4876 ==============================
[0m21:49:29.035244 [info ] [MainThread]: Running with dbt=1.7.9
[0m21:49:29.036811 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m21:49:29.315716 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '86b4afd4-0af0-45ff-b112-4b8d5b8e4876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e069c178770>]}
[0m21:49:29.435077 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '86b4afd4-0af0-45ff-b112-4b8d5b8e4876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e069c92b920>]}
[0m21:49:29.436560 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m21:49:29.461934 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m21:49:29.703952 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:49:29.705217 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m21:49:29.896925 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m21:49:29.903844 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '86b4afd4-0af0-45ff-b112-4b8d5b8e4876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e069b505580>]}
[0m21:49:29.974042 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '86b4afd4-0af0-45ff-b112-4b8d5b8e4876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e069bdad700>]}
[0m21:49:29.975114 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m21:49:29.976256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '86b4afd4-0af0-45ff-b112-4b8d5b8e4876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e069d0bd460>]}
[0m21:49:29.979628 [info ] [MainThread]: 
[0m21:49:29.981738 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:49:29.984261 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m21:49:29.997915 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m21:49:29.999053 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m21:49:29.999954 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:49:30.008904 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m21:49:30.011196 [debug] [ThreadPool]: On list_nba: Close
[0m21:49:30.015717 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m21:49:30.023423 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:49:30.024445 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m21:49:30.025337 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:49:30.033981 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:49:30.035094 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:49:30.036039 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m21:49:30.040885 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m21:49:30.043174 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m21:49:30.044622 [debug] [ThreadPool]: On list_nba_gold: Close
[0m21:49:30.052679 [debug] [MainThread]: Using postgres connection "master"
[0m21:49:30.053722 [debug] [MainThread]: On master: BEGIN
[0m21:49:30.054623 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:49:30.062634 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:49:30.064569 [debug] [MainThread]: Using postgres connection "master"
[0m21:49:30.065681 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:49:30.083706 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m21:49:30.085967 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '86b4afd4-0af0-45ff-b112-4b8d5b8e4876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e069bd619d0>]}
[0m21:49:30.087136 [debug] [MainThread]: On master: ROLLBACK
[0m21:49:30.088398 [debug] [MainThread]: Using postgres connection "master"
[0m21:49:30.089306 [debug] [MainThread]: On master: BEGIN
[0m21:49:30.091078 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:49:30.092225 [debug] [MainThread]: On master: COMMIT
[0m21:49:30.093171 [debug] [MainThread]: Using postgres connection "master"
[0m21:49:30.094071 [debug] [MainThread]: On master: COMMIT
[0m21:49:30.095517 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:49:30.096936 [debug] [MainThread]: On master: Close
[0m21:49:30.098884 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:49:30.099979 [info ] [MainThread]: 
[0m21:49:30.104646 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m21:49:30.105879 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m21:49:30.107700 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m21:49:30.108832 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m21:49:30.126135 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m21:49:30.151246 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 21:49:30.109661 => 21:49:30.150669
[0m21:49:30.152308 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m21:49:30.202153 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m21:49:30.226642 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:49:30.227711 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m21:49:30.228644 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:49:30.236750 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:49:30.237821 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:49:30.238841 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m21:49:30.261792 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m21:49:30.270570 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:49:30.271717 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m21:49:30.273244 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:49:30.277575 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:49:30.278655 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m21:49:30.281213 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:49:30.307348 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:49:30.308400 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:49:30.309446 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:49:30.317522 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:49:30.326287 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m21:49:30.335371 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:49:30.336511 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m21:49:30.343671 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:49:30.346582 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 21:49:30.153099 => 21:49:30.346100
[0m21:49:30.348259 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m21:49:30.349970 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '86b4afd4-0af0-45ff-b112-4b8d5b8e4876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e069b10f7a0>]}
[0m21:49:30.351288 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.24s]
[0m21:49:30.352734 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m21:49:30.353783 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m21:49:30.354913 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m21:49:30.356326 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m21:49:30.357329 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m21:49:30.361818 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m21:49:30.383279 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 21:49:30.358079 => 21:49:30.382858
[0m21:49:30.384199 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m21:49:30.389394 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m21:49:30.410108 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:49:30.411150 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m21:49:30.411939 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:49:30.418568 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:49:30.419550 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:49:30.420389 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m21:49:30.445989 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m21:49:30.451403 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:49:30.452450 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m21:49:30.453915 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:49:30.458554 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:49:30.459509 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m21:49:30.460789 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:49:30.464800 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:49:30.465860 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:49:30.466946 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:49:30.477861 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:49:30.484283 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m21:49:30.485771 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:49:30.486768 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m21:49:30.495326 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:49:30.498685 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 21:49:30.384854 => 21:49:30.498410
[0m21:49:30.499784 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m21:49:30.501346 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '86b4afd4-0af0-45ff-b112-4b8d5b8e4876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e069b1c6300>]}
[0m21:49:30.502566 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m21:49:30.504128 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m21:49:30.505147 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m21:49:30.506170 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m21:49:30.507509 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m21:49:30.508494 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m21:49:30.514532 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m21:49:30.540397 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 21:49:30.509209 => 21:49:30.539996
[0m21:49:30.541368 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m21:49:30.548959 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m21:49:30.580685 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:49:30.582025 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m21:49:30.583314 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:49:30.591698 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:49:30.593008 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:49:30.594596 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m21:49:30.633181 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:49:30.637837 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:49:30.639232 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m21:49:30.640821 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:49:30.645286 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:49:30.647071 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m21:49:30.649056 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:49:30.652181 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:49:30.653247 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:49:30.654204 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:49:30.659677 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:49:30.664357 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m21:49:30.665922 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:49:30.667057 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m21:49:30.673851 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:49:30.676434 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 21:49:30.542074 => 21:49:30.676154
[0m21:49:30.677508 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m21:49:30.680739 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '86b4afd4-0af0-45ff-b112-4b8d5b8e4876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e069b1c58e0>]}
[0m21:49:30.682478 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.17s]
[0m21:49:30.684057 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m21:49:30.686280 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m21:49:30.687575 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m21:49:30.689137 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m21:49:30.690192 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m21:49:30.699192 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m21:49:30.725156 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 21:49:30.691032 => 21:49:30.724762
[0m21:49:30.726221 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m21:49:30.733086 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m21:49:30.759309 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:49:30.760387 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m21:49:30.761547 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:49:30.769368 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:49:30.770484 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:49:30.771821 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        'avg_fg3_pct' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_rebounds' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_turnovers' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_plus_minus' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'avg_steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        fa.is_free_agent,
        COALESCE(i.is_injured, FALSE) AS is_injured,
        s.salary,
        s.salary_currency,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk
    FROM "nba"."silver"."players" AS p
    LEFT JOIN player_stats AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    WHERE fa.is_free_agent = TRUE AND COALESCE(i.is_injured, FALSE) = FALSE
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')

    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        salary_currency,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        salary_currency,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        salary_currency,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)

SELECT
    ss.season,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.salary_currency,
    tt.reason
FROM spurs_weaknesses ss
JOIN top_targets tt ON 1=1
ORDER BY ss.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m21:49:30.776130 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column fa.is_free_agent does not exist
LINE 78:         fa.is_free_agent,
                 ^

[0m21:49:30.777302 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m21:49:30.778951 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 21:49:30.727083 => 21:49:30.778432
[0m21:49:30.780466 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m21:49:30.786327 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column fa.is_free_agent does not exist
  LINE 78:         fa.is_free_agent,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:49:30.787655 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '86b4afd4-0af0-45ff-b112-4b8d5b8e4876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e069b1bb350>]}
[0m21:49:30.788874 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m21:49:30.790235 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m21:49:30.794202 [debug] [MainThread]: Using postgres connection "master"
[0m21:49:30.795408 [debug] [MainThread]: On master: BEGIN
[0m21:49:30.797027 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:49:30.805327 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:49:30.806487 [debug] [MainThread]: On master: COMMIT
[0m21:49:30.807567 [debug] [MainThread]: Using postgres connection "master"
[0m21:49:30.808516 [debug] [MainThread]: On master: COMMIT
[0m21:49:30.809801 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:49:30.810954 [debug] [MainThread]: On master: Close
[0m21:49:30.812959 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:49:30.814576 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m21:49:30.815818 [info ] [MainThread]: 
[0m21:49:30.816941 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 0.83 seconds (0.83s).
[0m21:49:30.819309 [debug] [MainThread]: Command end result
[0m21:49:30.891312 [info ] [MainThread]: 
[0m21:49:30.892564 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:49:30.893669 [info ] [MainThread]: 
[0m21:49:30.895025 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column fa.is_free_agent does not exist
  LINE 78:         fa.is_free_agent,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:49:30.898390 [info ] [MainThread]: 
[0m21:49:30.899878 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m21:49:30.901749 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.9593716, "process_user_time": 3.466046, "process_kernel_time": 0.341052, "process_mem_max_rss": "200872", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:49:30.903185 [debug] [MainThread]: Command `dbt run` failed at 21:49:30.902935 after 1.96 seconds
[0m21:49:30.904351 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e069cb03e30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e069c1e0830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e069b1bb410>]}
[0m21:49:30.905517 [debug] [MainThread]: Flushing usage events
[0m21:55:11.174647 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x776ec1782090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x776ec1783c20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x776ec1780d70>]}


============================== 21:55:11.180109 | b20d8b86-f5e4-4edf-8fcf-59bcf9d98f60 ==============================
[0m21:55:11.180109 [info ] [MainThread]: Running with dbt=1.7.9
[0m21:55:11.181632 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:55:11.457643 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b20d8b86-f5e4-4edf-8fcf-59bcf9d98f60', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x776ec18ae720>]}
[0m21:55:11.574865 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b20d8b86-f5e4-4edf-8fcf-59bcf9d98f60', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x776ec17ac860>]}
[0m21:55:11.576263 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m21:55:11.601159 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m21:55:11.907235 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:55:11.908332 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m21:55:12.101856 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m21:55:12.108282 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b20d8b86-f5e4-4edf-8fcf-59bcf9d98f60', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x776ec056b7d0>]}
[0m21:55:12.210687 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b20d8b86-f5e4-4edf-8fcf-59bcf9d98f60', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x776ec0db9e80>]}
[0m21:55:12.212876 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m21:55:12.214882 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b20d8b86-f5e4-4edf-8fcf-59bcf9d98f60', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x776ec0db92e0>]}
[0m21:55:12.220206 [info ] [MainThread]: 
[0m21:55:12.222672 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:55:12.227364 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m21:55:12.250037 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m21:55:12.251129 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m21:55:12.251977 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:55:12.261052 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m21:55:12.263953 [debug] [ThreadPool]: On list_nba: Close
[0m21:55:12.267646 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m21:55:12.275365 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:55:12.276463 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m21:55:12.277543 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:55:12.284779 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:55:12.285947 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:55:12.286924 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m21:55:12.291217 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m21:55:12.293534 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m21:55:12.294962 [debug] [ThreadPool]: On list_nba_gold: Close
[0m21:55:12.302501 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:12.303705 [debug] [MainThread]: On master: BEGIN
[0m21:55:12.304814 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:55:12.312216 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:55:12.313884 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:12.314873 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:55:12.331170 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m21:55:12.333284 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b20d8b86-f5e4-4edf-8fcf-59bcf9d98f60', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x776ec0d4d640>]}
[0m21:55:12.334486 [debug] [MainThread]: On master: ROLLBACK
[0m21:55:12.335757 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:12.336645 [debug] [MainThread]: On master: BEGIN
[0m21:55:12.338342 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:55:12.339310 [debug] [MainThread]: On master: COMMIT
[0m21:55:12.340179 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:12.341039 [debug] [MainThread]: On master: COMMIT
[0m21:55:12.342240 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:55:12.343122 [debug] [MainThread]: On master: Close
[0m21:55:12.344905 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:55:12.347124 [info ] [MainThread]: 
[0m21:55:12.352566 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m21:55:12.353786 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m21:55:12.355141 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m21:55:12.356091 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m21:55:12.367934 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m21:55:12.391930 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 21:55:12.356851 => 21:55:12.391513
[0m21:55:12.392913 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m21:55:12.446157 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m21:55:12.472273 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:12.473243 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m21:55:12.474238 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:55:12.482952 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:55:12.484062 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:12.484982 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m21:55:12.506048 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m21:55:12.515797 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:12.517009 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m21:55:12.518584 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:12.522877 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:12.523868 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m21:55:12.525537 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:12.551848 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:55:12.552867 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:12.553707 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:55:12.559809 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:55:12.568979 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m21:55:12.576243 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:12.577356 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m21:55:12.588427 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:55:12.591274 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 21:55:12.393697 => 21:55:12.590896
[0m21:55:12.592148 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m21:55:12.593664 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b20d8b86-f5e4-4edf-8fcf-59bcf9d98f60', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x776ec01136e0>]}
[0m21:55:12.595063 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.24s]
[0m21:55:12.596892 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m21:55:12.598128 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m21:55:12.599126 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m21:55:12.600366 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m21:55:12.601266 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m21:55:12.605932 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m21:55:12.627036 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 21:55:12.602051 => 21:55:12.626630
[0m21:55:12.627881 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m21:55:12.636713 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m21:55:12.656634 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:12.657627 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m21:55:12.658423 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:55:12.665592 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:55:12.666537 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:12.667383 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m21:55:12.684791 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m21:55:12.689209 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:12.690292 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m21:55:12.691623 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:12.697439 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:12.698662 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m21:55:12.700202 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:12.704688 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:55:12.705938 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:12.707049 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:55:12.712845 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:55:12.720896 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m21:55:12.722710 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:12.723691 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m21:55:12.730408 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:55:12.732664 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 21:55:12.629682 => 21:55:12.732395
[0m21:55:12.733595 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m21:55:12.734919 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b20d8b86-f5e4-4edf-8fcf-59bcf9d98f60', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x776ec01dbec0>]}
[0m21:55:12.736024 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.13s]
[0m21:55:12.737470 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m21:55:12.738441 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m21:55:12.739346 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m21:55:12.740529 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m21:55:12.741491 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m21:55:12.747587 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m21:55:12.769468 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 21:55:12.742112 => 21:55:12.768944
[0m21:55:12.770351 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m21:55:12.775328 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m21:55:12.800024 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:12.801137 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m21:55:12.802348 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:55:12.809367 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:55:12.810497 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:12.812155 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m21:55:12.844031 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:55:12.849202 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:12.850325 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m21:55:12.851708 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:12.855668 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:12.856659 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m21:55:12.858324 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:12.861072 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:55:12.862767 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:12.864132 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:55:12.873565 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:55:12.877092 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m21:55:12.879327 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:12.880715 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m21:55:12.888275 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:55:12.890714 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 21:55:12.770941 => 21:55:12.890451
[0m21:55:12.891722 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m21:55:12.893705 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b20d8b86-f5e4-4edf-8fcf-59bcf9d98f60', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x776ec01da0c0>]}
[0m21:55:12.897534 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.15s]
[0m21:55:12.899965 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m21:55:12.904007 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m21:55:12.914604 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m21:55:12.918771 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m21:55:12.920176 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m21:55:12.932021 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m21:55:12.960822 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 21:55:12.921167 => 21:55:12.960434
[0m21:55:12.962276 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m21:55:12.970744 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m21:55:12.998251 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:55:12.999483 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m21:55:13.000613 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:55:13.008792 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:55:13.011256 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:55:13.013240 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        'avg_fg3_pct' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_rebounds' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_turnovers' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_plus_minus' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'avg_steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE as is_free_agent,
        COALESCE(i.is_injured, FALSE) AS is_injured,
        s.salary,
        s.salary_currency,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk
    FROM "nba"."silver"."players" AS p
    LEFT JOIN player_stats AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    WHERE COALESCE(i.is_injured, FALSE) = FALSE
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        salary_currency,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        salary_currency,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        salary_currency,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)

SELECT
    ss.season,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.salary_currency,
    tt.reason,
    tt.is_free_agent
FROM spurs_weaknesses ss
JOIN top_targets tt ON 1=1
ORDER BY ss.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m21:55:13.016099 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "as"
LINE 78: ...se when fa.player_id is null then FALSE else TRUE as is_free...
                                                              ^

[0m21:55:13.017623 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m21:55:13.019142 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 21:55:12.964954 => 21:55:13.018814
[0m21:55:13.020125 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m21:55:13.028201 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "as"
  LINE 78: ...se when fa.player_id is null then FALSE else TRUE as is_free...
                                                                ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:55:13.030162 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b20d8b86-f5e4-4edf-8fcf-59bcf9d98f60', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x776ec01db3e0>]}
[0m21:55:13.031606 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.11s]
[0m21:55:13.033060 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m21:55:13.036906 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:13.038134 [debug] [MainThread]: On master: BEGIN
[0m21:55:13.039619 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:55:13.048558 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:55:13.049815 [debug] [MainThread]: On master: COMMIT
[0m21:55:13.051257 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:13.052510 [debug] [MainThread]: On master: COMMIT
[0m21:55:13.054123 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:55:13.055530 [debug] [MainThread]: On master: Close
[0m21:55:13.057278 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:55:13.058430 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m21:55:13.060215 [info ] [MainThread]: 
[0m21:55:13.061785 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 0.84 seconds (0.84s).
[0m21:55:13.064663 [debug] [MainThread]: Command end result
[0m21:55:13.120161 [info ] [MainThread]: 
[0m21:55:13.121168 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:55:13.122117 [info ] [MainThread]: 
[0m21:55:13.123018 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "as"
  LINE 78: ...se when fa.player_id is null then FALSE else TRUE as is_free...
                                                                ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:55:13.124146 [info ] [MainThread]: 
[0m21:55:13.125272 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m21:55:13.126797 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.0461905, "process_user_time": 4.037317, "process_kernel_time": 0.319787, "process_mem_max_rss": "200872", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:55:13.127738 [debug] [MainThread]: Command `dbt run` failed at 21:55:13.127543 after 2.05 seconds
[0m21:55:13.128819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x776ec1b90a40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x776ec11a5af0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x776ec056a750>]}
[0m21:55:13.130092 [debug] [MainThread]: Flushing usage events
[0m21:55:52.845214 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7673ec9e8fe0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7673ecd6a3c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7673ecdfcaa0>]}


============================== 21:55:52.849459 | 38b60a4f-eea9-4154-a7f4-9bd4cfd6868c ==============================
[0m21:55:52.849459 [info ] [MainThread]: Running with dbt=1.7.9
[0m21:55:52.850583 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m21:55:53.121229 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '38b60a4f-eea9-4154-a7f4-9bd4cfd6868c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7673ecd6b410>]}
[0m21:55:53.238075 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '38b60a4f-eea9-4154-a7f4-9bd4cfd6868c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7673ec9ebaa0>]}
[0m21:55:53.239801 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m21:55:53.265587 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m21:55:53.521899 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:55:53.523447 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m21:55:53.720513 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m21:55:53.728835 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '38b60a4f-eea9-4154-a7f4-9bd4cfd6868c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7673ec1e15b0>]}
[0m21:55:53.795571 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '38b60a4f-eea9-4154-a7f4-9bd4cfd6868c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7673ebd6c770>]}
[0m21:55:53.796705 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m21:55:53.797718 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '38b60a4f-eea9-4154-a7f4-9bd4cfd6868c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7673ebd6d010>]}
[0m21:55:53.800410 [info ] [MainThread]: 
[0m21:55:53.801896 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:55:53.804238 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m21:55:53.818068 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m21:55:53.819049 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m21:55:53.820041 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:55:53.829259 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m21:55:53.831351 [debug] [ThreadPool]: On list_nba: Close
[0m21:55:53.834804 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m21:55:53.844392 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:55:53.845429 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m21:55:53.846378 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:55:53.852790 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:55:53.853896 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:55:53.854926 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m21:55:53.860713 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m21:55:53.862773 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m21:55:53.864164 [debug] [ThreadPool]: On list_nba_gold: Close
[0m21:55:53.871265 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:53.872273 [debug] [MainThread]: On master: BEGIN
[0m21:55:53.873171 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:55:53.880008 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:55:53.881049 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:53.882146 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:55:53.900217 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m21:55:53.902621 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '38b60a4f-eea9-4154-a7f4-9bd4cfd6868c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7673ec13cb60>]}
[0m21:55:53.903767 [debug] [MainThread]: On master: ROLLBACK
[0m21:55:53.905134 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:53.906086 [debug] [MainThread]: On master: BEGIN
[0m21:55:53.908123 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:55:53.909596 [debug] [MainThread]: On master: COMMIT
[0m21:55:53.910588 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:53.911564 [debug] [MainThread]: On master: COMMIT
[0m21:55:53.913005 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:55:53.913918 [debug] [MainThread]: On master: Close
[0m21:55:53.915442 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:55:53.916591 [info ] [MainThread]: 
[0m21:55:53.921548 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m21:55:53.922820 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m21:55:53.924872 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m21:55:53.926733 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m21:55:53.938094 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m21:55:53.963155 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 21:55:53.927515 => 21:55:53.962758
[0m21:55:53.964186 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m21:55:54.015344 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m21:55:54.041711 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:54.042903 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m21:55:54.043886 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:55:54.050443 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:55:54.051590 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:54.052662 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m21:55:54.076950 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m21:55:54.085225 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:54.086337 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m21:55:54.088088 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:54.093021 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:54.094152 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m21:55:54.095848 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:54.122648 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:55:54.124023 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:54.125871 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:55:54.132201 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:55:54.140728 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m21:55:54.149081 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:54.150246 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m21:55:54.157390 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:55:54.160506 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 21:55:53.964987 => 21:55:54.160207
[0m21:55:54.161488 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m21:55:54.163156 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '38b60a4f-eea9-4154-a7f4-9bd4cfd6868c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7673ec1a65a0>]}
[0m21:55:54.164489 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.24s]
[0m21:55:54.165868 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m21:55:54.167022 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m21:55:54.168088 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m21:55:54.169454 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m21:55:54.170568 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m21:55:54.176535 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m21:55:54.197141 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 21:55:54.171464 => 21:55:54.196750
[0m21:55:54.198008 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m21:55:54.203415 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m21:55:54.223867 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:54.225551 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m21:55:54.226633 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:55:54.233680 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:55:54.234784 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:54.235843 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m21:55:54.254614 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m21:55:54.259675 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:54.260768 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m21:55:54.262331 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:54.266546 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:54.267741 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m21:55:54.269128 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:54.272516 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:55:54.273504 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:54.274839 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:55:54.283174 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:55:54.288714 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m21:55:54.290218 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:54.291719 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m21:55:54.298568 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:55:54.301132 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 21:55:54.198683 => 21:55:54.300872
[0m21:55:54.302102 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m21:55:54.304007 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '38b60a4f-eea9-4154-a7f4-9bd4cfd6868c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7673eb18ca10>]}
[0m21:55:54.305219 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.13s]
[0m21:55:54.306560 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m21:55:54.308505 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m21:55:54.310037 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m21:55:54.311458 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m21:55:54.312589 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m21:55:54.317586 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m21:55:54.344574 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 21:55:54.313394 => 21:55:54.344196
[0m21:55:54.345557 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m21:55:54.350893 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m21:55:54.378527 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:54.379516 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m21:55:54.380642 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:55:54.387245 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:55:54.388326 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:54.389446 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m21:55:54.432006 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:55:54.436325 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:54.437250 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m21:55:54.438753 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:54.443748 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:54.444862 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m21:55:54.446533 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:54.449632 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:55:54.450752 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:54.451750 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:55:54.458040 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:55:54.461916 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m21:55:54.463418 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:54.464482 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m21:55:54.471796 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:55:54.475406 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 21:55:54.346420 => 21:55:54.474963
[0m21:55:54.476797 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m21:55:54.478688 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '38b60a4f-eea9-4154-a7f4-9bd4cfd6868c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7673eb18ec90>]}
[0m21:55:54.480246 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.17s]
[0m21:55:54.481707 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m21:55:54.484257 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m21:55:54.485506 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m21:55:54.487039 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m21:55:54.488836 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m21:55:54.498697 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m21:55:54.525912 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 21:55:54.490225 => 21:55:54.525471
[0m21:55:54.527060 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m21:55:54.532397 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m21:55:54.557693 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:55:54.559388 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m21:55:54.560599 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:55:54.567460 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:55:54.568778 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:55:54.570043 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        'avg_fg3_pct' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_rebounds' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_turnovers' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_plus_minus' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'avg_steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        COALESCE(i.is_injured, FALSE) AS is_injured,
        s.salary,
        s.salary_currency,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk
    FROM "nba"."silver"."players" AS p
    LEFT JOIN player_stats AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    WHERE COALESCE(i.is_injured, FALSE) = FALSE
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        salary_currency,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        salary_currency,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        salary_currency,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)

SELECT
    ss.season,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.salary_currency,
    tt.reason,
    tt.is_free_agent
FROM spurs_weaknesses ss
JOIN top_targets tt ON 1=1
ORDER BY ss.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m21:55:54.573589 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column i.is_injured does not exist
LINE 79:         COALESCE(i.is_injured, FALSE) AS is_injured,
                          ^

[0m21:55:54.575843 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m21:55:54.577449 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 21:55:54.527911 => 21:55:54.577133
[0m21:55:54.578496 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m21:55:54.584005 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column i.is_injured does not exist
  LINE 79:         COALESCE(i.is_injured, FALSE) AS is_injured,
                            ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:55:54.585357 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '38b60a4f-eea9-4154-a7f4-9bd4cfd6868c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7673eb164ad0>]}
[0m21:55:54.586597 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m21:55:54.588096 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m21:55:54.592863 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:54.593954 [debug] [MainThread]: On master: BEGIN
[0m21:55:54.595033 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:55:54.602502 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:55:54.603592 [debug] [MainThread]: On master: COMMIT
[0m21:55:54.604672 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:54.605544 [debug] [MainThread]: On master: COMMIT
[0m21:55:54.606959 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:55:54.608698 [debug] [MainThread]: On master: Close
[0m21:55:54.610534 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:55:54.611543 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m21:55:54.612744 [info ] [MainThread]: 
[0m21:55:54.613834 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 0.81 seconds (0.81s).
[0m21:55:54.615790 [debug] [MainThread]: Command end result
[0m21:55:54.678444 [info ] [MainThread]: 
[0m21:55:54.679821 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:55:54.680938 [info ] [MainThread]: 
[0m21:55:54.681997 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column i.is_injured does not exist
  LINE 79:         COALESCE(i.is_injured, FALSE) AS is_injured,
                            ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:55:54.683778 [info ] [MainThread]: 
[0m21:55:54.684806 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m21:55:54.686739 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.9259005, "process_user_time": 3.399279, "process_kernel_time": 0.439906, "process_mem_max_rss": "200868", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:55:54.688018 [debug] [MainThread]: Command `dbt run` failed at 21:55:54.687791 after 1.93 seconds
[0m21:55:54.689164 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7673ec9e8f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7673eb183080>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7673eb5ef740>]}
[0m21:55:54.690279 [debug] [MainThread]: Flushing usage events
[0m21:58:50.351630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7728b16fcd10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7728b1ac9f10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7728b2339070>]}


============================== 21:58:50.356459 | aff038e7-479f-4e57-bddb-cf70abef7cd3 ==============================
[0m21:58:50.356459 [info ] [MainThread]: Running with dbt=1.7.9
[0m21:58:50.358297 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m21:58:50.629769 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aff038e7-479f-4e57-bddb-cf70abef7cd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7728b2811fa0>]}
[0m21:58:50.752068 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aff038e7-479f-4e57-bddb-cf70abef7cd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7728b17ca0f0>]}
[0m21:58:50.753519 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m21:58:50.778081 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m21:58:51.004211 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:58:51.005882 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m21:58:51.202467 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m21:58:51.210073 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'aff038e7-479f-4e57-bddb-cf70abef7cd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7728b0114620>]}
[0m21:58:51.282056 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'aff038e7-479f-4e57-bddb-cf70abef7cd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7728b09bd280>]}
[0m21:58:51.283172 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m21:58:51.284135 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aff038e7-479f-4e57-bddb-cf70abef7cd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7728b01447a0>]}
[0m21:58:51.286890 [info ] [MainThread]: 
[0m21:58:51.288349 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:58:51.292149 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m21:58:51.305324 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m21:58:51.306827 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m21:58:51.308384 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:58:51.316811 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m21:58:51.318824 [debug] [ThreadPool]: On list_nba: Close
[0m21:58:51.322009 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m21:58:51.330201 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:58:51.331267 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m21:58:51.332310 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:58:51.341232 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:58:51.342936 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:58:51.343917 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m21:58:51.349291 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m21:58:51.351357 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m21:58:51.352571 [debug] [ThreadPool]: On list_nba_gold: Close
[0m21:58:51.360680 [debug] [MainThread]: Using postgres connection "master"
[0m21:58:51.361813 [debug] [MainThread]: On master: BEGIN
[0m21:58:51.362746 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:58:51.369614 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:58:51.370743 [debug] [MainThread]: Using postgres connection "master"
[0m21:58:51.371789 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:58:51.387195 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m21:58:51.390233 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aff038e7-479f-4e57-bddb-cf70abef7cd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7728b0165490>]}
[0m21:58:51.391669 [debug] [MainThread]: On master: ROLLBACK
[0m21:58:51.392910 [debug] [MainThread]: Using postgres connection "master"
[0m21:58:51.393836 [debug] [MainThread]: On master: BEGIN
[0m21:58:51.395511 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:58:51.396592 [debug] [MainThread]: On master: COMMIT
[0m21:58:51.397506 [debug] [MainThread]: Using postgres connection "master"
[0m21:58:51.398464 [debug] [MainThread]: On master: COMMIT
[0m21:58:51.399750 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:58:51.400903 [debug] [MainThread]: On master: Close
[0m21:58:51.402396 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:58:51.403632 [info ] [MainThread]: 
[0m21:58:51.409456 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m21:58:51.410685 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m21:58:51.412195 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m21:58:51.413326 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m21:58:51.424697 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m21:58:51.448639 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 21:58:51.414116 => 21:58:51.448229
[0m21:58:51.449692 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m21:58:51.498967 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m21:58:51.522956 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:58:51.524686 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m21:58:51.525771 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:58:51.533436 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:58:51.534504 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:58:51.535595 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m21:58:51.560058 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m21:58:51.568379 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:58:51.569462 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m21:58:51.571134 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:58:51.576981 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:58:51.578110 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m21:58:51.579550 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:58:51.606012 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:58:51.607685 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:58:51.608771 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:58:51.623937 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:58:51.632200 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m21:58:51.641782 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:58:51.642939 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m21:58:51.650280 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:58:51.652897 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 21:58:51.450459 => 21:58:51.652626
[0m21:58:51.654024 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m21:58:51.655853 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aff038e7-479f-4e57-bddb-cf70abef7cd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7728afd13890>]}
[0m21:58:51.657826 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.24s]
[0m21:58:51.659423 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m21:58:51.660619 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m21:58:51.661773 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m21:58:51.663151 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m21:58:51.664356 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m21:58:51.670226 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m21:58:51.694143 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 21:58:51.665200 => 21:58:51.693762
[0m21:58:51.695242 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m21:58:51.703001 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m21:58:51.728327 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:58:51.729300 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m21:58:51.730194 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:58:51.736992 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:58:51.738305 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:58:51.739711 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m21:58:51.765662 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m21:58:51.770236 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:58:51.771317 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m21:58:51.773194 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:58:51.777576 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:58:51.778684 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m21:58:51.780200 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:58:51.783230 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:58:51.784415 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:58:51.785441 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:58:51.794170 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:58:51.799595 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m21:58:51.801253 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:58:51.802328 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m21:58:51.809483 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:58:51.812545 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 21:58:51.696185 => 21:58:51.812144
[0m21:58:51.813798 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m21:58:51.815802 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aff038e7-479f-4e57-bddb-cf70abef7cd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7728afdce3c0>]}
[0m21:58:51.817496 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m21:58:51.818981 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m21:58:51.820451 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m21:58:51.821537 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m21:58:51.823460 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m21:58:51.825004 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m21:58:51.830195 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m21:58:51.858639 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 21:58:51.825902 => 21:58:51.858260
[0m21:58:51.859797 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m21:58:51.865230 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m21:58:51.892251 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:58:51.893324 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m21:58:51.894171 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:58:51.900924 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:58:51.902142 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:58:51.903369 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m21:58:51.944102 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:58:51.953219 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:58:51.955259 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m21:58:51.958384 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:58:51.967447 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:58:51.969581 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m21:58:51.972715 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:58:51.977152 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:58:51.978459 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:58:51.979710 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:58:51.989157 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:58:51.994656 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m21:58:51.996622 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:58:51.997856 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m21:58:52.009868 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:58:52.016146 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 21:58:51.860798 => 21:58:52.015123
[0m21:58:52.018110 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m21:58:52.021227 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aff038e7-479f-4e57-bddb-cf70abef7cd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7728afd95580>]}
[0m21:58:52.024146 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.20s]
[0m21:58:52.025992 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m21:58:52.028698 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m21:58:52.030000 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m21:58:52.031919 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m21:58:52.033181 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m21:58:52.043340 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m21:58:52.071446 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 21:58:52.034163 => 21:58:52.071065
[0m21:58:52.072620 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m21:58:52.078540 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m21:58:52.106855 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:58:52.108255 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m21:58:52.109276 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:58:52.117054 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:58:52.118311 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:58:52.119613 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        'avg_fg3_pct' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_rebounds' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_turnovers' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_plus_minus' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'avg_steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary,
        s.salary_currency,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk
    FROM "nba"."silver"."players" AS p
    LEFT JOIN player_stats AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        salary_currency,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        salary_currency,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        salary_currency,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)

SELECT
    ss.season,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.salary_currency,
    tt.reason,
    tt.is_free_agent,
    is_injured
FROM spurs_weaknesses ss
JOIN top_targets tt ON 1=1
ORDER BY ss.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m21:58:52.124700 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column s.salary does not exist
LINE 80:         s.salary,
                 ^

[0m21:58:52.126023 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m21:58:52.127653 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 21:58:52.073795 => 21:58:52.127337
[0m21:58:52.128643 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m21:58:52.134255 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column s.salary does not exist
  LINE 80:         s.salary,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:58:52.135349 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aff038e7-479f-4e57-bddb-cf70abef7cd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7728afd74770>]}
[0m21:58:52.136965 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m21:58:52.138435 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m21:58:52.143614 [debug] [MainThread]: Using postgres connection "master"
[0m21:58:52.144992 [debug] [MainThread]: On master: BEGIN
[0m21:58:52.146040 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:58:52.152881 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:58:52.153882 [debug] [MainThread]: On master: COMMIT
[0m21:58:52.154775 [debug] [MainThread]: Using postgres connection "master"
[0m21:58:52.155778 [debug] [MainThread]: On master: COMMIT
[0m21:58:52.157709 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:58:52.158690 [debug] [MainThread]: On master: Close
[0m21:58:52.160402 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:58:52.161437 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m21:58:52.162484 [info ] [MainThread]: 
[0m21:58:52.163588 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 0.87 seconds (0.87s).
[0m21:58:52.165554 [debug] [MainThread]: Command end result
[0m21:58:52.237477 [info ] [MainThread]: 
[0m21:58:52.238599 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:58:52.240434 [info ] [MainThread]: 
[0m21:58:52.241911 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column s.salary does not exist
  LINE 80:         s.salary,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m21:58:52.242992 [info ] [MainThread]: 
[0m21:58:52.244277 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m21:58:52.246154 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.0016341, "process_user_time": 3.564802, "process_kernel_time": 0.433181, "process_mem_max_rss": "200868", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:58:52.247297 [debug] [MainThread]: Command `dbt run` failed at 21:58:52.247101 after 2.00 seconds
[0m21:58:52.248404 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7728b1baca40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7728b01fb4a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7728b09463c0>]}
[0m21:58:52.249387 [debug] [MainThread]: Flushing usage events
[0m14:52:30.486316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75e928d62840>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75e92891f710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75e92891d1f0>]}


============================== 14:52:30.494774 | ca92e679-ef41-498f-943d-524015d8f282 ==============================
[0m14:52:30.494774 [info ] [MainThread]: Running with dbt=1.7.9
[0m14:52:30.496568 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m14:52:31.119221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ca92e679-ef41-498f-943d-524015d8f282', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75e928cf1c10>]}
[0m14:52:31.353350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ca92e679-ef41-498f-943d-524015d8f282', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75e92891d430>]}
[0m14:52:31.355578 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m14:52:31.392813 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m14:52:33.066911 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:52:33.068159 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:52:33.070352 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m14:52:33.084566 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ca92e679-ef41-498f-943d-524015d8f282', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75e928fa4c20>]}
[0m14:52:34.266038 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ca92e679-ef41-498f-943d-524015d8f282', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75e927971250>]}
[0m14:52:34.267994 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m14:52:34.269495 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ca92e679-ef41-498f-943d-524015d8f282', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75e928123650>]}
[0m14:52:34.274668 [info ] [MainThread]: 
[0m14:52:34.277799 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:52:34.282287 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m14:52:34.312372 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m14:52:34.313659 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m14:52:34.315218 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:52:34.349618 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m14:52:34.353029 [debug] [ThreadPool]: On list_nba: Close
[0m14:52:34.358509 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m14:52:34.374243 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m14:52:34.375923 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m14:52:34.377284 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:52:34.387301 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:52:34.388691 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m14:52:34.390280 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m14:52:34.418685 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m14:52:34.422277 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m14:52:34.423955 [debug] [ThreadPool]: On list_nba_gold: Close
[0m14:52:34.438335 [debug] [MainThread]: Using postgres connection "master"
[0m14:52:34.439990 [debug] [MainThread]: On master: BEGIN
[0m14:52:34.442393 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:52:34.451850 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:52:34.453126 [debug] [MainThread]: Using postgres connection "master"
[0m14:52:34.454552 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:52:34.495166 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:52:34.498594 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ca92e679-ef41-498f-943d-524015d8f282', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75e927d373b0>]}
[0m14:52:34.499967 [debug] [MainThread]: On master: ROLLBACK
[0m14:52:34.501554 [debug] [MainThread]: Using postgres connection "master"
[0m14:52:34.502944 [debug] [MainThread]: On master: BEGIN
[0m14:52:34.504762 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:52:34.506133 [debug] [MainThread]: On master: COMMIT
[0m14:52:34.507366 [debug] [MainThread]: Using postgres connection "master"
[0m14:52:34.509071 [debug] [MainThread]: On master: COMMIT
[0m14:52:34.511416 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m14:52:34.513280 [debug] [MainThread]: On master: Close
[0m14:52:34.515668 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m14:52:34.518348 [info ] [MainThread]: 
[0m14:52:34.524389 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m14:52:34.526263 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m14:52:34.528544 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m14:52:34.530043 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m14:52:34.552000 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m14:52:34.599007 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 14:52:34.531534 => 14:52:34.598319
[0m14:52:34.600270 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m14:52:34.717267 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m14:52:34.752867 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:52:34.754483 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m14:52:34.755999 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:52:34.765694 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m14:52:34.767382 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:52:34.769307 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m14:52:34.840374 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m14:52:34.859313 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:52:34.861632 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m14:52:34.867565 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:52:34.876723 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:52:34.878857 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m14:52:34.882572 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:52:34.973963 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m14:52:34.975824 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:52:34.978061 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m14:52:34.986570 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m14:52:35.018920 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m14:52:35.037569 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:52:35.041024 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m14:52:35.055606 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m14:52:35.059995 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 14:52:34.601169 => 14:52:35.059423
[0m14:52:35.061737 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m14:52:35.069371 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ca92e679-ef41-498f-943d-524015d8f282', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75e9275d51f0>]}
[0m14:52:35.075604 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.54s]
[0m14:52:35.078554 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m14:52:35.081999 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m14:52:35.084000 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m14:52:35.094149 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m14:52:35.096548 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m14:52:35.106270 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m14:52:35.142935 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 14:52:35.098082 => 14:52:35.142028
[0m14:52:35.144813 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m14:52:35.158066 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m14:52:35.188363 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:52:35.191040 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m14:52:35.192437 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:52:35.201944 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m14:52:35.203695 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:52:35.205421 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m14:52:35.229578 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m14:52:35.236576 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:52:35.238059 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m14:52:35.239938 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:52:35.246932 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:52:35.248346 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m14:52:35.250496 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:52:35.256352 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m14:52:35.258322 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:52:35.260237 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m14:52:35.266173 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m14:52:35.272592 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m14:52:35.277532 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:52:35.279343 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m14:52:35.287614 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m14:52:35.294572 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 14:52:35.146022 => 14:52:35.293913
[0m14:52:35.296115 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m14:52:35.298283 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ca92e679-ef41-498f-943d-524015d8f282', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75e92712f0e0>]}
[0m14:52:35.301007 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.21s]
[0m14:52:35.305316 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m14:52:35.307405 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m14:52:35.309317 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m14:52:35.311749 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m14:52:35.313239 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m14:52:35.326553 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m14:52:35.387665 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 14:52:35.314465 => 14:52:35.386813
[0m14:52:35.389453 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m14:52:35.407014 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m14:52:35.456493 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:52:35.458033 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m14:52:35.459783 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:52:35.469169 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m14:52:35.470974 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:52:35.474100 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m14:52:35.536069 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m14:52:35.548555 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:52:35.550495 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m14:52:35.553597 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:52:35.559983 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:52:35.561448 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m14:52:35.563545 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:52:35.571667 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m14:52:35.573516 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:52:35.574859 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m14:52:35.583137 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m14:52:35.591182 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m14:52:35.593731 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:52:35.595886 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m14:52:35.603861 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m14:52:35.609271 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 14:52:35.390958 => 14:52:35.608492
[0m14:52:35.611983 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m14:52:35.616530 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ca92e679-ef41-498f-943d-524015d8f282', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75e927180680>]}
[0m14:52:35.619868 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.31s]
[0m14:52:35.622527 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m14:52:35.625657 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m14:52:35.627231 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m14:52:35.630972 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m14:52:35.632719 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m14:52:35.647389 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m14:52:35.705017 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 14:52:35.633779 => 14:52:35.703884
[0m14:52:35.707558 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m14:52:35.725216 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m14:52:35.775727 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m14:52:35.777254 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m14:52:35.778595 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:52:35.788251 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m14:52:35.790686 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m14:52:35.793286 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        'avg_fg3_pct' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_rebounds' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_turnovers' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_plus_minus' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'avg_steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary,
        s.salary_currency,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk
    FROM "nba"."silver"."players" AS p
    LEFT JOIN player_stats AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        salary_currency,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        salary_currency,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        salary_currency,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)

SELECT
    ss.season,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.salary_currency,
    tt.reason,
    tt.is_free_agent,
    is_injured
FROM spurs_weaknesses ss
JOIN top_targets tt ON 1=1
ORDER BY ss.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m14:52:35.803011 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column s.salary does not exist
LINE 80:         s.salary,
                 ^

[0m14:52:35.808237 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m14:52:35.810552 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 14:52:35.708956 => 14:52:35.809903
[0m14:52:35.812334 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m14:52:35.835756 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column s.salary does not exist
  LINE 80:         s.salary,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m14:52:35.837639 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ca92e679-ef41-498f-943d-524015d8f282', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75e927123e60>]}
[0m14:52:35.840019 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.21s]
[0m14:52:35.843594 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m14:52:35.849915 [debug] [MainThread]: Using postgres connection "master"
[0m14:52:35.852016 [debug] [MainThread]: On master: BEGIN
[0m14:52:35.853580 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:52:35.865314 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:52:35.866470 [debug] [MainThread]: On master: COMMIT
[0m14:52:35.867765 [debug] [MainThread]: Using postgres connection "master"
[0m14:52:35.868928 [debug] [MainThread]: On master: COMMIT
[0m14:52:35.870616 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m14:52:35.871853 [debug] [MainThread]: On master: Close
[0m14:52:35.874175 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:52:35.876877 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m14:52:35.878206 [info ] [MainThread]: 
[0m14:52:35.879623 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 1.60 seconds (1.60s).
[0m14:52:35.882675 [debug] [MainThread]: Command end result
[0m14:52:35.971802 [info ] [MainThread]: 
[0m14:52:35.973133 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m14:52:35.974737 [info ] [MainThread]: 
[0m14:52:35.976371 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column s.salary does not exist
  LINE 80:         s.salary,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m14:52:35.977784 [info ] [MainThread]: 
[0m14:52:35.979225 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m14:52:35.981646 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 5.8000803, "process_user_time": 6.809758, "process_kernel_time": 0.838738, "process_mem_max_rss": "201132", "process_in_blocks": "34048", "command_success": false, "process_out_blocks": "0"}
[0m14:52:35.983451 [debug] [MainThread]: Command `dbt run` failed at 14:52:35.982971 after 5.80 seconds
[0m14:52:35.985203 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75e92906ac90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75e927163110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75e927d98b60>]}
[0m14:52:35.986544 [debug] [MainThread]: Flushing usage events
[0m14:57:05.924190 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79b1898a9280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79b18a8738c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79b189d58e30>]}


============================== 14:57:05.984271 | aaa1a4fb-129d-4657-a533-dae4ee37af28 ==============================
[0m14:57:05.984271 [info ] [MainThread]: Running with dbt=1.7.9
[0m14:57:05.985921 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:57:06.323486 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aaa1a4fb-129d-4657-a533-dae4ee37af28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79b1898a9730>]}
[0m14:57:06.482318 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aaa1a4fb-129d-4657-a533-dae4ee37af28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79b189dc9730>]}
[0m14:57:06.483912 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m14:57:06.508879 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m14:57:06.865283 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:57:06.866570 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:57:06.868437 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m14:57:06.878439 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'aaa1a4fb-129d-4657-a533-dae4ee37af28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79b188f437d0>]}
[0m14:57:06.963551 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'aaa1a4fb-129d-4657-a533-dae4ee37af28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79b188ba9520>]}
[0m14:57:06.965113 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m14:57:06.966188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aaa1a4fb-129d-4657-a533-dae4ee37af28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79b189dca8a0>]}
[0m14:57:06.969594 [info ] [MainThread]: 
[0m14:57:06.971625 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:57:06.974913 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m14:57:06.990736 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m14:57:06.991717 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m14:57:06.992498 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:57:07.002668 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m14:57:07.004884 [debug] [ThreadPool]: On list_nba: Close
[0m14:57:07.008042 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m14:57:07.016776 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m14:57:07.017824 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m14:57:07.018698 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:57:07.025478 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:57:07.026526 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m14:57:07.027423 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m14:57:07.032801 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m14:57:07.034964 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m14:57:07.036167 [debug] [ThreadPool]: On list_nba_gold: Close
[0m14:57:07.043079 [debug] [MainThread]: Using postgres connection "master"
[0m14:57:07.044147 [debug] [MainThread]: On master: BEGIN
[0m14:57:07.044999 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:57:07.052642 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:57:07.053652 [debug] [MainThread]: Using postgres connection "master"
[0m14:57:07.054666 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:57:07.071622 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m14:57:07.073783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aaa1a4fb-129d-4657-a533-dae4ee37af28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79b1897a3470>]}
[0m14:57:07.074914 [debug] [MainThread]: On master: ROLLBACK
[0m14:57:07.076103 [debug] [MainThread]: Using postgres connection "master"
[0m14:57:07.077063 [debug] [MainThread]: On master: BEGIN
[0m14:57:07.079179 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:57:07.081185 [debug] [MainThread]: On master: COMMIT
[0m14:57:07.082245 [debug] [MainThread]: Using postgres connection "master"
[0m14:57:07.083130 [debug] [MainThread]: On master: COMMIT
[0m14:57:07.084711 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m14:57:07.085680 [debug] [MainThread]: On master: Close
[0m14:57:07.087235 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m14:57:07.088594 [info ] [MainThread]: 
[0m14:57:07.093567 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m14:57:07.094739 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m14:57:07.096811 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m14:57:07.097984 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m14:57:07.110157 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m14:57:07.131694 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 14:57:07.098698 => 14:57:07.131182
[0m14:57:07.132680 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m14:57:07.190630 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m14:57:07.219536 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:57:07.220642 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m14:57:07.221899 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:57:07.231213 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m14:57:07.232617 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:57:07.234001 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m14:57:07.261564 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m14:57:07.270836 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:57:07.271907 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m14:57:07.273496 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:57:07.278969 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:57:07.280661 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m14:57:07.283482 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:57:07.324346 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m14:57:07.325972 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:57:07.327315 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m14:57:07.334427 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m14:57:07.348325 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m14:57:07.361471 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m14:57:07.362774 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m14:57:07.372253 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m14:57:07.374713 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 14:57:07.133426 => 14:57:07.374418
[0m14:57:07.375790 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m14:57:07.377459 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aaa1a4fb-129d-4657-a533-dae4ee37af28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79b188b3f740>]}
[0m14:57:07.379415 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.28s]
[0m14:57:07.382108 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m14:57:07.383296 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m14:57:07.384795 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m14:57:07.386457 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m14:57:07.387541 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m14:57:07.394411 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m14:57:07.412239 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 14:57:07.388265 => 14:57:07.411793
[0m14:57:07.414042 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m14:57:07.421744 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m14:57:07.442056 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:57:07.443320 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m14:57:07.444514 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:57:07.454581 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m14:57:07.456004 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:57:07.457457 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m14:57:07.486186 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m14:57:07.491550 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:57:07.492632 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m14:57:07.494206 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:57:07.501407 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:57:07.502670 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m14:57:07.504247 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:57:07.507594 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m14:57:07.508608 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:57:07.509506 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m14:57:07.515168 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m14:57:07.519693 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m14:57:07.521212 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m14:57:07.522133 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m14:57:07.528403 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m14:57:07.532050 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 14:57:07.415133 => 14:57:07.531680
[0m14:57:07.533168 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m14:57:07.534979 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aaa1a4fb-129d-4657-a533-dae4ee37af28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79b188376ea0>]}
[0m14:57:07.536180 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m14:57:07.537481 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m14:57:07.538423 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m14:57:07.539485 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m14:57:07.540824 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m14:57:07.541688 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m14:57:07.548785 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m14:57:07.735557 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 14:57:07.542389 => 14:57:07.735036
[0m14:57:07.736494 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m14:57:07.742265 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m14:57:07.773839 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:57:07.774873 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m14:57:07.776117 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:57:07.783002 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m14:57:07.784511 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:57:07.785946 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m14:57:07.822015 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m14:57:07.830829 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:57:07.831998 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m14:57:07.833675 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:57:07.838650 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:57:07.839645 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m14:57:07.841543 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:57:07.846263 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m14:57:07.847546 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:57:07.848873 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m14:57:07.855152 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m14:57:07.859335 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m14:57:07.861529 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m14:57:07.862556 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m14:57:07.869959 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m14:57:07.873316 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 14:57:07.737168 => 14:57:07.872904
[0m14:57:07.874791 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m14:57:07.877312 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aaa1a4fb-129d-4657-a533-dae4ee37af28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79b1883bbce0>]}
[0m14:57:07.879235 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.34s]
[0m14:57:07.881046 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m14:57:07.883580 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m14:57:07.884969 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m14:57:07.886877 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m14:57:07.888113 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m14:57:07.899135 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m14:57:07.933735 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 14:57:07.889083 => 14:57:07.933173
[0m14:57:07.935625 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m14:57:07.943028 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m14:57:07.974934 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m14:57:07.975894 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m14:57:07.977762 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:57:07.985302 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m14:57:07.986618 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m14:57:07.987885 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        'avg_fg3_pct' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_rebounds' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_turnovers' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_plus_minus' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'avg_steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary,
        s.salary_currency,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk
    FROM "nba"."silver"."players" AS p
    LEFT JOIN player_stats AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        salary_currency,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        salary_currency,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        salary_currency,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        salary_currency,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)

SELECT
    ss.season,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.salary_currency,
    tt.reason,
    tt.is_free_agent,
    is_injured
FROM spurs_weaknesses ss
JOIN top_targets tt ON 1=1
ORDER BY ss.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m14:57:07.991509 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column s.salary does not exist
LINE 80:         s.salary,
                 ^

[0m14:57:07.992915 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m14:57:07.995217 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 14:57:07.936589 => 14:57:07.994767
[0m14:57:07.996262 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m14:57:08.004184 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column s.salary does not exist
  LINE 80:         s.salary,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m14:57:08.005568 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aaa1a4fb-129d-4657-a533-dae4ee37af28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79b1898aa1b0>]}
[0m14:57:08.006927 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.12s]
[0m14:57:08.008593 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m14:57:08.013834 [debug] [MainThread]: Using postgres connection "master"
[0m14:57:08.014832 [debug] [MainThread]: On master: BEGIN
[0m14:57:08.015689 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:57:08.022891 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:57:08.023920 [debug] [MainThread]: On master: COMMIT
[0m14:57:08.024837 [debug] [MainThread]: Using postgres connection "master"
[0m14:57:08.025723 [debug] [MainThread]: On master: COMMIT
[0m14:57:08.027240 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m14:57:08.028185 [debug] [MainThread]: On master: Close
[0m14:57:08.029629 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:57:08.030462 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m14:57:08.031448 [info ] [MainThread]: 
[0m14:57:08.032559 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 1.06 seconds (1.06s).
[0m14:57:08.034901 [debug] [MainThread]: Command end result
[0m14:57:08.105967 [info ] [MainThread]: 
[0m14:57:08.107203 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m14:57:08.108517 [info ] [MainThread]: 
[0m14:57:08.110033 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column s.salary does not exist
  LINE 80:         s.salary,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m14:57:08.111923 [info ] [MainThread]: 
[0m14:57:08.112950 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m14:57:08.114558 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.3892033, "process_user_time": 3.807352, "process_kernel_time": 0.588225, "process_mem_max_rss": "201008", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m14:57:08.115572 [debug] [MainThread]: Command `dbt run` failed at 14:57:08.115371 after 2.39 seconds
[0m14:57:08.116591 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79b1899f85c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79b188b3ef60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79b1883bbd10>]}
[0m14:57:08.117583 [debug] [MainThread]: Flushing usage events
[0m15:00:34.447450 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70c3ad234ef0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70c3ad367530>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70c3adf24a70>]}


============================== 15:00:34.452649 | 307a2b5c-b6b3-4366-a33e-ba6e9f896ed5 ==============================
[0m15:00:34.452649 [info ] [MainThread]: Running with dbt=1.7.9
[0m15:00:34.453991 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:00:34.766371 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '307a2b5c-b6b3-4366-a33e-ba6e9f896ed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70c3ac982600>]}
[0m15:00:34.924846 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '307a2b5c-b6b3-4366-a33e-ba6e9f896ed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70c3ac526d80>]}
[0m15:00:34.926332 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m15:00:34.950512 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m15:00:35.224099 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:00:35.225509 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m15:00:35.471221 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m15:00:35.479844 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '307a2b5c-b6b3-4366-a33e-ba6e9f896ed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70c3ac56e180>]}
[0m15:00:35.640453 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '307a2b5c-b6b3-4366-a33e-ba6e9f896ed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70c3ac5b5940>]}
[0m15:00:35.641426 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m15:00:35.642368 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '307a2b5c-b6b3-4366-a33e-ba6e9f896ed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70c3abd88dd0>]}
[0m15:00:35.645321 [info ] [MainThread]: 
[0m15:00:35.646753 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m15:00:35.649282 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m15:00:35.664376 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m15:00:35.665406 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m15:00:35.666354 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:35.676488 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m15:00:35.679430 [debug] [ThreadPool]: On list_nba: Close
[0m15:00:35.683312 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m15:00:35.691914 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m15:00:35.692958 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m15:00:35.693782 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:35.700448 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m15:00:35.701431 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m15:00:35.702300 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m15:00:35.707689 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m15:00:35.709918 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m15:00:35.711269 [debug] [ThreadPool]: On list_nba_gold: Close
[0m15:00:35.719187 [debug] [MainThread]: Using postgres connection "master"
[0m15:00:35.720591 [debug] [MainThread]: On master: BEGIN
[0m15:00:35.721711 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:00:35.729035 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:00:35.730081 [debug] [MainThread]: Using postgres connection "master"
[0m15:00:35.731130 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m15:00:35.749972 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m15:00:35.752351 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '307a2b5c-b6b3-4366-a33e-ba6e9f896ed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70c3ad156960>]}
[0m15:00:35.753351 [debug] [MainThread]: On master: ROLLBACK
[0m15:00:35.754588 [debug] [MainThread]: Using postgres connection "master"
[0m15:00:35.755756 [debug] [MainThread]: On master: BEGIN
[0m15:00:35.757696 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:00:35.758627 [debug] [MainThread]: On master: COMMIT
[0m15:00:35.759493 [debug] [MainThread]: Using postgres connection "master"
[0m15:00:35.760382 [debug] [MainThread]: On master: COMMIT
[0m15:00:35.761520 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m15:00:35.762412 [debug] [MainThread]: On master: Close
[0m15:00:35.763823 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m15:00:35.764933 [info ] [MainThread]: 
[0m15:00:35.769486 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m15:00:35.770724 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m15:00:35.773261 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m15:00:35.774460 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m15:00:35.787858 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m15:00:35.815495 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 15:00:35.775358 => 15:00:35.814964
[0m15:00:35.816485 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m15:00:35.870958 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m15:00:35.904006 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:00:35.905145 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m15:00:35.906497 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:00:35.913112 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:00:35.914209 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:00:35.915150 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m15:00:35.935621 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m15:00:35.945569 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:00:35.946732 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m15:00:35.948466 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:00:35.953151 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:00:35.954221 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m15:00:35.956083 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:00:35.987675 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m15:00:35.989575 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:00:35.991034 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m15:00:35.997312 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:00:36.010100 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m15:00:36.019069 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:00:36.020337 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m15:00:36.028358 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:00:36.031460 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 15:00:35.817187 => 15:00:36.030985
[0m15:00:36.032564 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m15:00:36.034263 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '307a2b5c-b6b3-4366-a33e-ba6e9f896ed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70c3ac56cf50>]}
[0m15:00:36.035814 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.26s]
[0m15:00:36.037361 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m15:00:36.039081 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m15:00:36.041484 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m15:00:36.043405 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m15:00:36.044755 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m15:00:36.050513 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m15:00:36.078302 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 15:00:36.045567 => 15:00:36.077884
[0m15:00:36.079698 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m15:00:36.086827 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m15:00:36.114213 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:00:36.115663 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m15:00:36.116891 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:00:36.126054 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:00:36.127439 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:00:36.128771 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m15:00:36.145854 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m15:00:36.151010 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:00:36.152295 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m15:00:36.154374 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:00:36.160449 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:00:36.161571 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m15:00:36.163482 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:00:36.166617 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m15:00:36.167699 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:00:36.168816 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m15:00:36.174671 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:00:36.181192 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m15:00:36.184310 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:00:36.186081 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m15:00:36.193869 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:00:36.197500 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 15:00:36.080712 => 15:00:36.196741
[0m15:00:36.199015 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m15:00:36.200769 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '307a2b5c-b6b3-4366-a33e-ba6e9f896ed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70c3ab9d5160>]}
[0m15:00:36.202164 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.16s]
[0m15:00:36.204284 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m15:00:36.206331 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m15:00:36.207719 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m15:00:36.209382 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m15:00:36.210505 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m15:00:36.217258 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m15:00:36.258804 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 15:00:36.211337 => 15:00:36.258017
[0m15:00:36.260334 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m15:00:36.269845 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m15:00:36.311940 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:00:36.312806 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m15:00:36.313634 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:00:36.320197 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:00:36.321992 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:00:36.324099 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m15:00:36.357642 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m15:00:36.364033 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:00:36.365327 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m15:00:36.367055 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:00:36.373352 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:00:36.374696 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m15:00:36.376170 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:00:36.379195 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m15:00:36.380239 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:00:36.381338 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m15:00:36.386937 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:00:36.391971 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m15:00:36.393501 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:00:36.394589 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m15:00:36.401430 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:00:36.404372 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 15:00:36.261653 => 15:00:36.403945
[0m15:00:36.405766 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m15:00:36.408076 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '307a2b5c-b6b3-4366-a33e-ba6e9f896ed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70c3ab9d55e0>]}
[0m15:00:36.409509 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.20s]
[0m15:00:36.411047 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m15:00:36.413618 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m15:00:36.414897 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m15:00:36.416604 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m15:00:36.417695 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m15:00:36.428297 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m15:00:36.477990 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 15:00:36.418489 => 15:00:36.477603
[0m15:00:36.479009 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m15:00:36.484642 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m15:00:36.533738 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:00:36.534788 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m15:00:36.535832 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:00:36.544093 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:00:36.545794 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:00:36.547019 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        'avg_fg3_pct' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_rebounds' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_turnovers' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_plus_minus' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'avg_steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk
    FROM "nba"."silver"."players" AS p
    LEFT JOIN player_stats AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)

SELECT
    ss.season,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    tt.is_free_agent,
    is_injured
FROM spurs_weaknesses ss
JOIN top_targets tt ON 1=1
ORDER BY ss.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m15:00:36.550769 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column pgs.avg_fg3_pct does not exist
LINE 81:         pgs.avg_fg3_pct,
                 ^

[0m15:00:36.552123 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m15:00:36.553647 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 15:00:36.480035 => 15:00:36.553288
[0m15:00:36.554701 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m15:00:36.561330 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column pgs.avg_fg3_pct does not exist
  LINE 81:         pgs.avg_fg3_pct,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m15:00:36.562523 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '307a2b5c-b6b3-4366-a33e-ba6e9f896ed5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70c3ab99a150>]}
[0m15:00:36.563854 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.15s]
[0m15:00:36.565309 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m15:00:36.569573 [debug] [MainThread]: Using postgres connection "master"
[0m15:00:36.570831 [debug] [MainThread]: On master: BEGIN
[0m15:00:36.572377 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:00:36.580004 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:00:36.581094 [debug] [MainThread]: On master: COMMIT
[0m15:00:36.582215 [debug] [MainThread]: Using postgres connection "master"
[0m15:00:36.583426 [debug] [MainThread]: On master: COMMIT
[0m15:00:36.584883 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m15:00:36.586094 [debug] [MainThread]: On master: Close
[0m15:00:36.587892 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:00:36.589471 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m15:00:36.590705 [info ] [MainThread]: 
[0m15:00:36.591833 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 0.94 seconds (0.94s).
[0m15:00:36.593672 [debug] [MainThread]: Command end result
[0m15:00:36.670092 [info ] [MainThread]: 
[0m15:00:36.671872 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:00:36.673731 [info ] [MainThread]: 
[0m15:00:36.674785 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column pgs.avg_fg3_pct does not exist
  LINE 81:         pgs.avg_fg3_pct,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m15:00:36.675798 [info ] [MainThread]: 
[0m15:00:36.676806 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m15:00:36.678391 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.450697, "process_user_time": 4.252278, "process_kernel_time": 0.480031, "process_mem_max_rss": "201028", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m15:00:36.679603 [debug] [MainThread]: Command `dbt run` failed at 15:00:36.679360 after 2.45 seconds
[0m15:00:36.680605 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70c3ad367530>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70c3ab913a40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70c3ac90dfd0>]}
[0m15:00:36.681628 [debug] [MainThread]: Flushing usage events
[0m15:17:57.195764 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ccdfdf8ec0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ccdfdfb9b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ccdfdf9160>]}


============================== 15:17:57.200022 | 6b809247-2e1c-4981-8225-3e579c2f049f ==============================
[0m15:17:57.200022 [info ] [MainThread]: Running with dbt=1.7.9
[0m15:17:57.202465 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:17:57.615385 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6b809247-2e1c-4981-8225-3e579c2f049f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72cce01c5ee0>]}
[0m15:17:57.779432 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6b809247-2e1c-4981-8225-3e579c2f049f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ccdfec42f0>]}
[0m15:17:57.780865 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m15:17:57.804966 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m15:17:58.223853 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:17:58.225240 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m15:17:58.476102 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m15:17:58.483955 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6b809247-2e1c-4981-8225-3e579c2f049f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ccde5616d0>]}
[0m15:17:58.739399 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6b809247-2e1c-4981-8225-3e579c2f049f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ccdedb5a30>]}
[0m15:17:58.741175 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m15:17:58.745313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6b809247-2e1c-4981-8225-3e579c2f049f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72cce01c5df0>]}
[0m15:17:58.749130 [info ] [MainThread]: 
[0m15:17:58.751301 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m15:17:58.754563 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m15:17:58.781691 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m15:17:58.782680 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m15:17:58.783677 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:17:58.793488 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m15:17:58.795610 [debug] [ThreadPool]: On list_nba: Close
[0m15:17:58.799388 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m15:17:58.811135 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m15:17:58.812172 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m15:17:58.813243 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:17:58.821522 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m15:17:58.822555 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m15:17:58.823415 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m15:17:58.829007 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m15:17:58.831394 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m15:17:58.832634 [debug] [ThreadPool]: On list_nba_gold: Close
[0m15:17:58.842057 [debug] [MainThread]: Using postgres connection "master"
[0m15:17:58.842906 [debug] [MainThread]: On master: BEGIN
[0m15:17:58.843614 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:17:58.850289 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:17:58.851849 [debug] [MainThread]: Using postgres connection "master"
[0m15:17:58.852878 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m15:17:58.870593 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m15:17:58.873038 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6b809247-2e1c-4981-8225-3e579c2f049f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ccde520f20>]}
[0m15:17:58.874128 [debug] [MainThread]: On master: ROLLBACK
[0m15:17:58.875311 [debug] [MainThread]: Using postgres connection "master"
[0m15:17:58.876203 [debug] [MainThread]: On master: BEGIN
[0m15:17:58.877847 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:17:58.878827 [debug] [MainThread]: On master: COMMIT
[0m15:17:58.879634 [debug] [MainThread]: Using postgres connection "master"
[0m15:17:58.880425 [debug] [MainThread]: On master: COMMIT
[0m15:17:58.881422 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m15:17:58.882324 [debug] [MainThread]: On master: Close
[0m15:17:58.884692 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m15:17:58.886053 [info ] [MainThread]: 
[0m15:17:58.890881 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m15:17:58.891973 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m15:17:58.893395 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m15:17:58.894448 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m15:17:58.910713 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m15:17:58.941678 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 15:17:58.898936 => 15:17:58.941265
[0m15:17:58.942528 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m15:17:59.004126 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m15:17:59.040757 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:17:59.042613 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m15:17:59.044326 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:17:59.054851 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:17:59.056422 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:17:59.057748 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m15:17:59.080809 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m15:17:59.091445 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:17:59.092513 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m15:17:59.094243 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:17:59.098678 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:17:59.099811 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m15:17:59.101723 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:17:59.131246 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m15:17:59.132506 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:17:59.133691 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m15:17:59.140364 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:17:59.150795 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m15:17:59.161447 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:17:59.162469 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m15:17:59.174136 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:17:59.176653 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 15:17:58.943139 => 15:17:59.176366
[0m15:17:59.177688 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m15:17:59.179113 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6b809247-2e1c-4981-8225-3e579c2f049f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ccde561220>]}
[0m15:17:59.180372 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.29s]
[0m15:17:59.181663 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m15:17:59.182603 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m15:17:59.184154 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m15:17:59.185962 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m15:17:59.187055 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m15:17:59.191731 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m15:17:59.215308 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 15:17:59.187743 => 15:17:59.214885
[0m15:17:59.216359 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m15:17:59.222959 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m15:17:59.249425 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:17:59.250515 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m15:17:59.251820 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:17:59.260206 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:17:59.261700 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:17:59.262772 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m15:17:59.281759 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m15:17:59.289933 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:17:59.291136 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m15:17:59.294881 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:17:59.299668 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:17:59.301346 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m15:17:59.303018 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:17:59.306111 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m15:17:59.307158 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:17:59.308088 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m15:17:59.313694 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:17:59.320446 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m15:17:59.322116 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:17:59.323150 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m15:17:59.329920 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:17:59.332633 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 15:17:59.217202 => 15:17:59.332261
[0m15:17:59.334168 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m15:17:59.336557 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6b809247-2e1c-4981-8225-3e579c2f049f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ccde1d82c0>]}
[0m15:17:59.340108 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m15:17:59.341953 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m15:17:59.343444 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m15:17:59.344651 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m15:17:59.346185 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m15:17:59.347211 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m15:17:59.353635 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m15:17:59.581407 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 15:17:59.347978 => 15:17:59.581002
[0m15:17:59.582505 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m15:17:59.588813 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m15:17:59.643080 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:17:59.644122 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m15:17:59.645147 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:17:59.653990 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:17:59.655260 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:17:59.656518 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m15:17:59.690804 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m15:17:59.696763 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:17:59.703201 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m15:17:59.706190 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:17:59.720360 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:17:59.721933 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m15:17:59.724031 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:17:59.728355 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m15:17:59.729611 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:17:59.730497 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m15:17:59.736732 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:17:59.740653 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m15:17:59.742205 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:17:59.743265 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m15:17:59.751023 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:17:59.754193 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 15:17:59.583290 => 15:17:59.753842
[0m15:17:59.755214 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m15:17:59.757137 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6b809247-2e1c-4981-8225-3e579c2f049f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ccde1d5520>]}
[0m15:17:59.758914 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.41s]
[0m15:17:59.760675 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m15:17:59.762628 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m15:17:59.763937 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m15:17:59.765549 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m15:17:59.766570 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m15:17:59.775685 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m15:17:59.851287 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 15:17:59.767747 => 15:17:59.847963
[0m15:17:59.854278 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m15:17:59.860951 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m15:17:59.905291 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:17:59.906393 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m15:17:59.907452 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:17:59.914890 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:17:59.916076 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:17:59.918157 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        'avg_fg3_pct' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_rebounds' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_turnovers' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_plus_minus' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'avg_steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM silver.player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk
    FROM "nba"."silver"."players" AS p
    LEFT JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)

SELECT
    ss.season,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    tt.is_free_agent,
    is_injured
FROM spurs_weaknesses ss
JOIN top_targets tt ON 1=1
ORDER BY ss.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m15:17:59.920624 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "SELECT"
LINE 72:     SELECT
             ^

[0m15:17:59.921793 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m15:17:59.923589 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 15:17:59.855352 => 15:17:59.923193
[0m15:17:59.924583 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m15:17:59.930911 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "SELECT"
  LINE 72:     SELECT
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m15:17:59.932292 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6b809247-2e1c-4981-8225-3e579c2f049f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ccdfdfbb30>]}
[0m15:17:59.934336 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.17s]
[0m15:17:59.936308 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m15:17:59.940412 [debug] [MainThread]: Using postgres connection "master"
[0m15:17:59.941402 [debug] [MainThread]: On master: BEGIN
[0m15:17:59.942356 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:17:59.949426 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:17:59.950821 [debug] [MainThread]: On master: COMMIT
[0m15:17:59.952416 [debug] [MainThread]: Using postgres connection "master"
[0m15:17:59.953357 [debug] [MainThread]: On master: COMMIT
[0m15:17:59.954733 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m15:17:59.955630 [debug] [MainThread]: On master: Close
[0m15:17:59.957378 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:17:59.958615 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m15:17:59.959860 [info ] [MainThread]: 
[0m15:17:59.961085 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 1.21 seconds (1.21s).
[0m15:17:59.963136 [debug] [MainThread]: Command end result
[0m15:18:00.047777 [info ] [MainThread]: 
[0m15:18:00.049007 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:18:00.050261 [info ] [MainThread]: 
[0m15:18:00.051752 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "SELECT"
  LINE 72:     SELECT
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m15:18:00.053086 [info ] [MainThread]: 
[0m15:18:00.054314 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m15:18:00.055987 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 3.0562587, "process_user_time": 4.105231, "process_kernel_time": 0.406897, "process_mem_max_rss": "201012", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m15:18:00.057189 [debug] [MainThread]: Command `dbt run` failed at 15:18:00.056996 after 3.06 seconds
[0m15:18:00.058156 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72cce01761b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ccde187c20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72cce01c6870>]}
[0m15:18:00.059159 [debug] [MainThread]: Flushing usage events
[0m15:19:01.062197 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79bebdf2a240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79bebe3d0b60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79bebe0455e0>]}


============================== 15:19:01.067512 | fa0cfdfa-69a5-4a92-ab8f-51512b343961 ==============================
[0m15:19:01.067512 [info ] [MainThread]: Running with dbt=1.7.9
[0m15:19:01.069145 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m15:19:01.379278 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fa0cfdfa-69a5-4a92-ab8f-51512b343961', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79bebde4a180>]}
[0m15:19:01.516003 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fa0cfdfa-69a5-4a92-ab8f-51512b343961', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79bebf1fa150>]}
[0m15:19:01.517596 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m15:19:01.547407 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m15:19:01.829909 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:19:01.831516 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m15:19:02.051393 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m15:19:02.059829 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fa0cfdfa-69a5-4a92-ab8f-51512b343961', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79bebcd3f7d0>]}
[0m15:19:02.135014 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fa0cfdfa-69a5-4a92-ab8f-51512b343961', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79bebd5ad9a0>]}
[0m15:19:02.136551 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m15:19:02.137990 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fa0cfdfa-69a5-4a92-ab8f-51512b343961', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79bebcd5ef90>]}
[0m15:19:02.141644 [info ] [MainThread]: 
[0m15:19:02.143335 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m15:19:02.145950 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m15:19:02.162478 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m15:19:02.163644 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m15:19:02.164567 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:19:02.177773 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m15:19:02.180037 [debug] [ThreadPool]: On list_nba: Close
[0m15:19:02.183255 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m15:19:02.192155 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m15:19:02.193282 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m15:19:02.194265 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:19:02.201104 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m15:19:02.202283 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m15:19:02.203355 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m15:19:02.209230 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m15:19:02.211619 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m15:19:02.213100 [debug] [ThreadPool]: On list_nba_gold: Close
[0m15:19:02.221847 [debug] [MainThread]: Using postgres connection "master"
[0m15:19:02.223037 [debug] [MainThread]: On master: BEGIN
[0m15:19:02.224053 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:19:02.232373 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:19:02.233357 [debug] [MainThread]: Using postgres connection "master"
[0m15:19:02.234370 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m15:19:02.252254 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m15:19:02.255712 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fa0cfdfa-69a5-4a92-ab8f-51512b343961', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79bebd8b3e00>]}
[0m15:19:02.256918 [debug] [MainThread]: On master: ROLLBACK
[0m15:19:02.258285 [debug] [MainThread]: Using postgres connection "master"
[0m15:19:02.259186 [debug] [MainThread]: On master: BEGIN
[0m15:19:02.261259 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:19:02.262534 [debug] [MainThread]: On master: COMMIT
[0m15:19:02.263626 [debug] [MainThread]: Using postgres connection "master"
[0m15:19:02.264563 [debug] [MainThread]: On master: COMMIT
[0m15:19:02.265872 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m15:19:02.267127 [debug] [MainThread]: On master: Close
[0m15:19:02.268767 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m15:19:02.269926 [info ] [MainThread]: 
[0m15:19:02.275825 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m15:19:02.277354 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m15:19:02.279481 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m15:19:02.280717 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m15:19:02.292723 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m15:19:02.319434 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 15:19:02.281613 => 15:19:02.319032
[0m15:19:02.320602 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m15:19:02.375525 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m15:19:02.404720 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:19:02.406366 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m15:19:02.407509 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:19:02.415615 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:19:02.417030 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:19:02.418472 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m15:19:02.441315 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m15:19:02.453485 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:19:02.455258 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m15:19:02.457083 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:19:02.462016 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:19:02.463276 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m15:19:02.465187 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:19:02.497569 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m15:19:02.499548 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:19:02.501199 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m15:19:02.508682 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:19:02.521494 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m15:19:02.531071 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:19:02.532410 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m15:19:02.540210 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:19:02.544025 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 15:19:02.322002 => 15:19:02.543568
[0m15:19:02.545222 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m15:19:02.546891 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fa0cfdfa-69a5-4a92-ab8f-51512b343961', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79bebd8e7bf0>]}
[0m15:19:02.548496 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.27s]
[0m15:19:02.550539 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m15:19:02.552132 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m15:19:02.554330 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m15:19:02.557342 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m15:19:02.558899 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m15:19:02.564537 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m15:19:02.589482 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 15:19:02.560014 => 15:19:02.588412
[0m15:19:02.591346 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m15:19:02.598254 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m15:19:02.626289 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:19:02.627899 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m15:19:02.629539 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:19:02.636934 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:19:02.638552 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:19:02.639853 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m15:19:02.663125 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m15:19:02.669230 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:19:02.670467 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m15:19:02.672466 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:19:02.677647 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:19:02.678597 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m15:19:02.679943 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:19:02.683184 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m15:19:02.684143 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:19:02.685004 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m15:19:02.692431 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:19:02.697925 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m15:19:02.699466 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:19:02.700318 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m15:19:02.706704 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:19:02.709072 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 15:19:02.592311 => 15:19:02.708797
[0m15:19:02.710163 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m15:19:02.711739 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fa0cfdfa-69a5-4a92-ab8f-51512b343961', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79bebc9c8860>]}
[0m15:19:02.713074 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.16s]
[0m15:19:02.714647 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m15:19:02.715877 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m15:19:02.716999 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m15:19:02.718678 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m15:19:02.719681 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m15:19:02.726975 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m15:19:02.752662 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 15:19:02.720383 => 15:19:02.752255
[0m15:19:02.753596 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m15:19:02.759716 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m15:19:02.783775 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:19:02.784732 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m15:19:02.785615 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:19:02.793706 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:19:02.794812 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:19:02.796061 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m15:19:02.835689 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m15:19:02.841096 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:19:02.842278 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m15:19:02.843902 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:19:02.848509 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:19:02.849767 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m15:19:02.851448 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:19:02.855268 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m15:19:02.856403 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:19:02.857384 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m15:19:02.865493 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:19:02.869574 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m15:19:02.871810 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:19:02.873087 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m15:19:02.879796 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:19:02.882452 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 15:19:02.754468 => 15:19:02.882132
[0m15:19:02.883595 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m15:19:02.885537 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fa0cfdfa-69a5-4a92-ab8f-51512b343961', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79bebc9cbcb0>]}
[0m15:19:02.887138 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.17s]
[0m15:19:02.889709 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m15:19:02.892425 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m15:19:02.893668 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m15:19:02.895258 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m15:19:02.896363 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m15:19:02.905511 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m15:19:02.940026 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 15:19:02.897177 => 15:19:02.939239
[0m15:19:02.942417 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m15:19:02.949387 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m15:19:02.985724 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:19:02.987459 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m15:19:02.989208 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:19:02.999020 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:19:03.000102 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:19:03.001823 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        'avg_fg3_pct' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_rebounds' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_turnovers' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_plus_minus' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'avg_steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM silver.player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk
    FROM "nba"."silver"."players" AS p
    LEFT JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)

SELECT
    ss.season,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    tt.is_free_agent,
    is_injured
FROM spurs_weaknesses ss
JOIN top_targets tt ON 1=1
ORDER BY ss.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m15:19:03.007129 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column ss.season does not exist
LINE 199:     ss.season,
              ^
HINT:  Perhaps you meant to reference the column "ss.season2".

[0m15:19:03.008337 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m15:19:03.009999 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 15:19:02.943166 => 15:19:03.009641
[0m15:19:03.011205 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m15:19:03.016918 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column ss.season does not exist
  LINE 199:     ss.season,
                ^
  HINT:  Perhaps you meant to reference the column "ss.season2".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m15:19:03.018258 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fa0cfdfa-69a5-4a92-ab8f-51512b343961', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79bebd566420>]}
[0m15:19:03.019583 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.12s]
[0m15:19:03.021628 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m15:19:03.026678 [debug] [MainThread]: Using postgres connection "master"
[0m15:19:03.027927 [debug] [MainThread]: On master: BEGIN
[0m15:19:03.029157 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:19:03.036112 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:19:03.037115 [debug] [MainThread]: On master: COMMIT
[0m15:19:03.038472 [debug] [MainThread]: Using postgres connection "master"
[0m15:19:03.039446 [debug] [MainThread]: On master: COMMIT
[0m15:19:03.040591 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m15:19:03.041493 [debug] [MainThread]: On master: Close
[0m15:19:03.042841 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:19:03.043739 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m15:19:03.044727 [info ] [MainThread]: 
[0m15:19:03.045604 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 0.90 seconds (0.90s).
[0m15:19:03.047398 [debug] [MainThread]: Command end result
[0m15:19:03.105820 [info ] [MainThread]: 
[0m15:19:03.107094 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:19:03.108224 [info ] [MainThread]: 
[0m15:19:03.109672 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column ss.season does not exist
  LINE 199:     ss.season,
                ^
  HINT:  Perhaps you meant to reference the column "ss.season2".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m15:19:03.110956 [info ] [MainThread]: 
[0m15:19:03.112013 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m15:19:03.113660 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.1515932, "process_user_time": 3.914675, "process_kernel_time": 0.447506, "process_mem_max_rss": "201016", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m15:19:03.114869 [debug] [MainThread]: Command `dbt run` failed at 15:19:03.114670 after 2.15 seconds
[0m15:19:03.115793 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79bebdff40e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79bebc98f320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79bebcdfb680>]}
[0m15:19:03.116681 [debug] [MainThread]: Flushing usage events
[0m15:20:25.982180 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889fea18f80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889fea1a930>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889fea18e30>]}


============================== 15:20:25.987346 | 49f4d917-8afa-4534-b1f1-e71ce70f6159 ==============================
[0m15:20:25.987346 [info ] [MainThread]: Running with dbt=1.7.9
[0m15:20:25.989305 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:20:26.315690 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '49f4d917-8afa-4534-b1f1-e71ce70f6159', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889fe90ff20>]}
[0m15:20:26.469965 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '49f4d917-8afa-4534-b1f1-e71ce70f6159', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889feb4b8f0>]}
[0m15:20:26.471773 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m15:20:26.495976 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m15:20:26.744709 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:20:26.746114 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m15:20:26.964183 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m15:20:26.972227 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '49f4d917-8afa-4534-b1f1-e71ce70f6159', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889fdd3faa0>]}
[0m15:20:27.047369 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '49f4d917-8afa-4534-b1f1-e71ce70f6159', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889fddad790>]}
[0m15:20:27.048462 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m15:20:27.049516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '49f4d917-8afa-4534-b1f1-e71ce70f6159', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889fe10a8d0>]}
[0m15:20:27.052619 [info ] [MainThread]: 
[0m15:20:27.054842 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m15:20:27.058383 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m15:20:27.076017 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m15:20:27.077010 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m15:20:27.078161 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:20:27.089432 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m15:20:27.091926 [debug] [ThreadPool]: On list_nba: Close
[0m15:20:27.095862 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m15:20:27.106229 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m15:20:27.107325 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m15:20:27.108371 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:20:27.115892 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m15:20:27.117239 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m15:20:27.118368 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m15:20:27.124384 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.0 seconds
[0m15:20:27.126751 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m15:20:27.128220 [debug] [ThreadPool]: On list_nba_gold: Close
[0m15:20:27.136691 [debug] [MainThread]: Using postgres connection "master"
[0m15:20:27.137862 [debug] [MainThread]: On master: BEGIN
[0m15:20:27.139233 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:20:27.146795 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:20:27.147979 [debug] [MainThread]: Using postgres connection "master"
[0m15:20:27.148996 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m15:20:27.166937 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m15:20:27.169736 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '49f4d917-8afa-4534-b1f1-e71ce70f6159', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889fe14be00>]}
[0m15:20:27.171302 [debug] [MainThread]: On master: ROLLBACK
[0m15:20:27.173235 [debug] [MainThread]: Using postgres connection "master"
[0m15:20:27.174582 [debug] [MainThread]: On master: BEGIN
[0m15:20:27.176744 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:20:27.177909 [debug] [MainThread]: On master: COMMIT
[0m15:20:27.178845 [debug] [MainThread]: Using postgres connection "master"
[0m15:20:27.179729 [debug] [MainThread]: On master: COMMIT
[0m15:20:27.180994 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m15:20:27.182138 [debug] [MainThread]: On master: Close
[0m15:20:27.183938 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m15:20:27.186526 [info ] [MainThread]: 
[0m15:20:27.192841 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m15:20:27.194119 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m15:20:27.195602 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m15:20:27.196561 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m15:20:27.207991 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m15:20:27.232987 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 15:20:27.197291 => 15:20:27.232525
[0m15:20:27.234151 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m15:20:27.289166 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m15:20:27.315160 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:20:27.316264 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m15:20:27.317357 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:20:27.325421 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:20:27.326533 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:20:27.327596 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m15:20:27.349589 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m15:20:27.360214 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:20:27.361481 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m15:20:27.363499 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:20:27.368334 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:20:27.369449 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m15:20:27.371249 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:20:27.397905 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m15:20:27.399192 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:20:27.400291 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m15:20:27.406892 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:20:27.415240 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m15:20:27.424901 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:20:27.426270 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m15:20:27.432700 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:20:27.435584 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 15:20:27.234891 => 15:20:27.435223
[0m15:20:27.436864 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m15:20:27.439411 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49f4d917-8afa-4534-b1f1-e71ce70f6159', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889fd10f7a0>]}
[0m15:20:27.440918 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.24s]
[0m15:20:27.442619 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m15:20:27.443976 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m15:20:27.445349 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m15:20:27.447311 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m15:20:27.448537 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m15:20:27.453847 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m15:20:27.481881 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 15:20:27.449417 => 15:20:27.481475
[0m15:20:27.483034 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m15:20:27.490914 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m15:20:27.518519 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:20:27.519521 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m15:20:27.520462 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:20:27.528524 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:20:27.529702 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:20:27.530942 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m15:20:27.548637 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m15:20:27.553235 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:20:27.554621 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m15:20:27.556907 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:20:27.562094 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:20:27.563366 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m15:20:27.564952 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:20:27.568151 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m15:20:27.569699 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:20:27.570986 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m15:20:27.577590 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:20:27.585761 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m15:20:27.588322 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:20:27.590048 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m15:20:27.597774 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:20:27.601932 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 15:20:27.484027 => 15:20:27.601599
[0m15:20:27.603506 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m15:20:27.606531 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49f4d917-8afa-4534-b1f1-e71ce70f6159', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889fd1c83e0>]}
[0m15:20:27.609422 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.16s]
[0m15:20:27.611838 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m15:20:27.614037 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m15:20:27.615785 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m15:20:27.618170 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m15:20:27.619538 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m15:20:27.628031 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m15:20:27.663291 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 15:20:27.620422 => 15:20:27.662815
[0m15:20:27.664278 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m15:20:27.670281 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m15:20:27.702778 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:20:27.704344 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m15:20:27.706402 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:20:27.715400 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:20:27.716631 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:20:27.718350 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m15:20:27.767218 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m15:20:27.772927 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:20:27.774143 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m15:20:27.775710 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:20:27.780577 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:20:27.781704 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m15:20:27.783111 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:20:27.786175 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m15:20:27.787396 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:20:27.788874 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m15:20:27.794076 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:20:27.797915 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m15:20:27.799325 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:20:27.800157 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m15:20:27.806355 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:20:27.809268 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 15:20:27.664949 => 15:20:27.808823
[0m15:20:27.810406 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m15:20:27.812198 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49f4d917-8afa-4534-b1f1-e71ce70f6159', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889fd1ca360>]}
[0m15:20:27.813694 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.19s]
[0m15:20:27.815256 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m15:20:27.817220 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m15:20:27.818500 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m15:20:27.820111 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m15:20:27.821762 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m15:20:27.832215 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m15:20:27.857478 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 15:20:27.823192 => 15:20:27.856962
[0m15:20:27.858472 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m15:20:27.864091 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m15:20:27.889464 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:20:27.890565 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m15:20:27.891605 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:20:27.898698 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:20:27.899711 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:20:27.900841 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        'avg_fg3_pct' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_rebounds' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_turnovers' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_plus_minus' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'avg_steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM silver.player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk
    FROM "nba"."silver"."players" AS p
    LEFT JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)

SELECT
    ss.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    tt.is_free_agent,
    is_injured
FROM spurs_weaknesses ss
JOIN top_targets tt ON 1=1
ORDER BY ss.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m15:20:28.073399 [debug] [Thread-1 (]: SQL status: SELECT 132 in 0.0 seconds
[0m15:20:28.078143 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:20:28.079198 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m15:20:28.080685 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:20:28.083896 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m15:20:28.084926 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:20:28.086048 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m15:20:28.092033 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:20:28.095872 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m15:20:28.097382 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:20:28.098389 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m15:20:28.100091 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:20:28.102695 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 15:20:27.859263 => 15:20:28.102374
[0m15:20:28.103773 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m15:20:28.106537 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49f4d917-8afa-4534-b1f1-e71ce70f6159', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889fd5fb6e0>]}
[0m15:20:28.108332 [info ] [Thread-1 (]: 4 of 4 OK created sql table model gold.players_recommendations ................. [[32mSELECT 132[0m in 0.29s]
[0m15:20:28.109756 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m15:20:28.112751 [debug] [MainThread]: Using postgres connection "master"
[0m15:20:28.113812 [debug] [MainThread]: On master: BEGIN
[0m15:20:28.114658 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:20:28.120966 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:20:28.122616 [debug] [MainThread]: On master: COMMIT
[0m15:20:28.123644 [debug] [MainThread]: Using postgres connection "master"
[0m15:20:28.124648 [debug] [MainThread]: On master: COMMIT
[0m15:20:28.125908 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m15:20:28.126871 [debug] [MainThread]: On master: Close
[0m15:20:28.128336 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:20:28.130161 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m15:20:28.131206 [info ] [MainThread]: 
[0m15:20:28.132116 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 1.08 seconds (1.08s).
[0m15:20:28.134051 [debug] [MainThread]: Command end result
[0m15:20:28.198847 [info ] [MainThread]: 
[0m15:20:28.199972 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:20:28.200963 [info ] [MainThread]: 
[0m15:20:28.202131 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m15:20:28.203806 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.3118613, "process_user_time": 3.929251, "process_kernel_time": 0.414664, "process_mem_max_rss": "201036", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m15:20:28.205394 [debug] [MainThread]: Command `dbt run` succeeded at 15:20:28.204950 after 2.31 seconds
[0m15:20:28.206501 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889fd51be30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889fd1dbef0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889fd1da960>]}
[0m15:20:28.207515 [debug] [MainThread]: Flushing usage events
[0m15:34:17.876711 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ee607278e30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ee60727a7b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ee607278bf0>]}


============================== 15:34:17.882263 | 180f3112-2f38-402b-8bda-b758522b017c ==============================
[0m15:34:17.882263 [info ] [MainThread]: Running with dbt=1.7.9
[0m15:34:17.883666 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:34:18.218634 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '180f3112-2f38-402b-8bda-b758522b017c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ee607279b20>]}
[0m15:34:18.404544 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '180f3112-2f38-402b-8bda-b758522b017c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ee607395730>]}
[0m15:34:18.407215 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m15:34:18.437716 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m15:34:18.806949 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:34:18.809040 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m15:34:19.048743 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m15:34:19.060279 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '180f3112-2f38-402b-8bda-b758522b017c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ee605d15e80>]}
[0m15:34:19.245747 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '180f3112-2f38-402b-8bda-b758522b017c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ee6065a88f0>]}
[0m15:34:19.246744 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m15:34:19.247908 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '180f3112-2f38-402b-8bda-b758522b017c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ee60716ec00>]}
[0m15:34:19.251488 [info ] [MainThread]: 
[0m15:34:19.253148 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m15:34:19.256731 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m15:34:19.279230 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m15:34:19.280867 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m15:34:19.282411 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:34:19.295285 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m15:34:19.299911 [debug] [ThreadPool]: On list_nba: Close
[0m15:34:19.305836 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m15:34:19.322175 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m15:34:19.323533 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m15:34:19.325053 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:34:19.334768 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m15:34:19.336245 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m15:34:19.337644 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m15:34:19.348842 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m15:34:19.351900 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m15:34:19.353607 [debug] [ThreadPool]: On list_nba_gold: Close
[0m15:34:19.365983 [debug] [MainThread]: Using postgres connection "master"
[0m15:34:19.367232 [debug] [MainThread]: On master: BEGIN
[0m15:34:19.368380 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:34:19.378233 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:34:19.386867 [debug] [MainThread]: Using postgres connection "master"
[0m15:34:19.389099 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m15:34:19.420403 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m15:34:19.422614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '180f3112-2f38-402b-8bda-b758522b017c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ee60653f470>]}
[0m15:34:19.423800 [debug] [MainThread]: On master: ROLLBACK
[0m15:34:19.426690 [debug] [MainThread]: Using postgres connection "master"
[0m15:34:19.428045 [debug] [MainThread]: On master: BEGIN
[0m15:34:19.429690 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:34:19.430983 [debug] [MainThread]: On master: COMMIT
[0m15:34:19.431969 [debug] [MainThread]: Using postgres connection "master"
[0m15:34:19.432831 [debug] [MainThread]: On master: COMMIT
[0m15:34:19.434449 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m15:34:19.436068 [debug] [MainThread]: On master: Close
[0m15:34:19.438370 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m15:34:19.439761 [info ] [MainThread]: 
[0m15:34:19.446607 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m15:34:19.448457 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m15:34:19.451235 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m15:34:19.453273 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m15:34:19.468076 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m15:34:19.495934 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 15:34:19.454582 => 15:34:19.495282
[0m15:34:19.497505 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m15:34:19.570352 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m15:34:19.602976 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:34:19.604026 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m15:34:19.605019 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:34:19.613134 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:34:19.614559 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:34:19.615513 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m15:34:19.634400 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m15:34:19.647382 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:34:19.648451 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m15:34:19.650134 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:34:19.654745 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:34:19.655986 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m15:34:19.658299 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:34:19.690478 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m15:34:19.692726 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:34:19.693951 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m15:34:19.699368 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:34:19.710298 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m15:34:19.719477 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:34:19.720464 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m15:34:19.727594 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:34:19.730415 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 15:34:19.498840 => 15:34:19.730054
[0m15:34:19.731363 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m15:34:19.733058 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '180f3112-2f38-402b-8bda-b758522b017c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ee605de6d50>]}
[0m15:34:19.734983 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.28s]
[0m15:34:19.737002 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m15:34:19.738340 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m15:34:19.739658 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m15:34:19.742452 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m15:34:19.743459 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m15:34:19.748626 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m15:34:19.769940 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 15:34:19.744152 => 15:34:19.769508
[0m15:34:19.770824 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m15:34:19.778103 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m15:34:19.798026 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:34:19.799037 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m15:34:19.799848 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:34:19.807484 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:34:19.809243 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:34:19.810391 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m15:34:19.827972 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m15:34:19.833119 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:34:19.834326 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m15:34:19.836097 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:34:19.843187 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:34:19.844248 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m15:34:19.845798 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:34:19.848930 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m15:34:19.849972 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:34:19.850906 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m15:34:19.858799 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:34:19.864798 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m15:34:19.866420 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:34:19.867479 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m15:34:19.881317 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:34:19.884490 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 15:34:19.771529 => 15:34:19.884115
[0m15:34:19.885494 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m15:34:19.886909 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '180f3112-2f38-402b-8bda-b758522b017c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ee6059c7e00>]}
[0m15:34:19.888870 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m15:34:19.890575 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m15:34:19.892032 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m15:34:19.893164 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m15:34:19.894733 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m15:34:19.895733 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m15:34:19.901859 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m15:34:19.959696 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 15:34:19.896342 => 15:34:19.959157
[0m15:34:19.960670 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m15:34:19.966566 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m15:34:20.014094 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:34:20.015088 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m15:34:20.016005 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:34:20.023168 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:34:20.024482 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:34:20.026432 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m15:34:20.065201 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m15:34:20.069949 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:34:20.070837 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m15:34:20.072696 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:34:20.078523 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:34:20.079537 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m15:34:20.080994 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:34:20.084077 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m15:34:20.085108 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:34:20.086213 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m15:34:20.094220 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:34:20.099066 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m15:34:20.100546 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:34:20.101508 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m15:34:20.108707 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:34:20.111300 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 15:34:19.961447 => 15:34:20.111014
[0m15:34:20.112169 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m15:34:20.113671 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '180f3112-2f38-402b-8bda-b758522b017c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ee6059c4b30>]}
[0m15:34:20.114936 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.22s]
[0m15:34:20.116578 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m15:34:20.118880 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m15:34:20.120182 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m15:34:20.122068 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m15:34:20.123235 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m15:34:20.132649 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m15:34:20.174259 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 15:34:20.123964 => 15:34:20.173632
[0m15:34:20.177899 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m15:34:20.183866 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m15:34:20.217119 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:34:20.218055 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m15:34:20.218857 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:34:20.226894 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:34:20.228137 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:34:20.229484 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        'avg_fg3_pct' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_rebounds' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_turnovers' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_plus_minus' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'avg_steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM silver.player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk
    FROM "nba"."silver"."players" AS p
    LEFT JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    where pgs.player_id IS NOT NULL -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m15:34:20.234307 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column tt.player_name does not exist
LINE 204:     tt.player_name AS recommended_player,
              ^

[0m15:34:20.235345 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m15:34:20.237052 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 15:34:20.178748 => 15:34:20.236536
[0m15:34:20.238217 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m15:34:20.245149 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column tt.player_name does not exist
  LINE 204:     tt.player_name AS recommended_player,
                ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m15:34:20.246514 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '180f3112-2f38-402b-8bda-b758522b017c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ee605964350>]}
[0m15:34:20.247858 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.13s]
[0m15:34:20.249318 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m15:34:20.254218 [debug] [MainThread]: Using postgres connection "master"
[0m15:34:20.255240 [debug] [MainThread]: On master: BEGIN
[0m15:34:20.256090 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:34:20.263209 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:34:20.264335 [debug] [MainThread]: On master: COMMIT
[0m15:34:20.265342 [debug] [MainThread]: Using postgres connection "master"
[0m15:34:20.266401 [debug] [MainThread]: On master: COMMIT
[0m15:34:20.267873 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m15:34:20.268846 [debug] [MainThread]: On master: Close
[0m15:34:20.270335 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:34:20.271262 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m15:34:20.272271 [info ] [MainThread]: 
[0m15:34:20.273561 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 1.02 seconds (1.02s).
[0m15:34:20.276366 [debug] [MainThread]: Command end result
[0m15:34:20.353702 [info ] [MainThread]: 
[0m15:34:20.354750 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:34:20.355680 [info ] [MainThread]: 
[0m15:34:20.356801 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column tt.player_name does not exist
  LINE 204:     tt.player_name AS recommended_player,
                ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m15:34:20.358504 [info ] [MainThread]: 
[0m15:34:20.359931 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m15:34:20.361903 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.6750176, "process_user_time": 4.178909, "process_kernel_time": 0.455445, "process_mem_max_rss": "201028", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m15:34:20.362881 [debug] [MainThread]: Command `dbt run` failed at 15:34:20.362684 after 2.68 seconds
[0m15:34:20.363665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ee60bc06f60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ee6059c5730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ee6059b7320>]}
[0m15:34:20.364692 [debug] [MainThread]: Flushing usage events
[0m15:35:22.009418 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x715b3fb3cfe0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x715b3fc89760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x715b3fb3ec30>]}


============================== 15:35:22.016109 | 8a12be2b-5e51-467a-9203-b33aa788e4cc ==============================
[0m15:35:22.016109 [info ] [MainThread]: Running with dbt=1.7.9
[0m15:35:22.017467 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:35:22.360705 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8a12be2b-5e51-467a-9203-b33aa788e4cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x715b3f4ce000>]}
[0m15:35:22.566101 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8a12be2b-5e51-467a-9203-b33aa788e4cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x715b3fb3f950>]}
[0m15:35:22.567887 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m15:35:22.592553 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m15:35:22.846936 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:35:22.848336 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m15:35:23.094663 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m15:35:23.105886 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8a12be2b-5e51-467a-9203-b33aa788e4cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x715b3f13c800>]}
[0m15:35:23.184326 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8a12be2b-5e51-467a-9203-b33aa788e4cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x715b3f1b50a0>]}
[0m15:35:23.185550 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m15:35:23.186701 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8a12be2b-5e51-467a-9203-b33aa788e4cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x715b3e964740>]}
[0m15:35:23.190295 [info ] [MainThread]: 
[0m15:35:23.192266 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m15:35:23.195352 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m15:35:23.213312 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m15:35:23.214803 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m15:35:23.215812 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:35:23.226641 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m15:35:23.230062 [debug] [ThreadPool]: On list_nba: Close
[0m15:35:23.233916 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m15:35:23.242839 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m15:35:23.243830 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m15:35:23.244595 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:35:23.252738 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m15:35:23.253790 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m15:35:23.254632 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m15:35:23.258980 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m15:35:23.262532 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m15:35:23.264745 [debug] [ThreadPool]: On list_nba_gold: Close
[0m15:35:23.274331 [debug] [MainThread]: Using postgres connection "master"
[0m15:35:23.277033 [debug] [MainThread]: On master: BEGIN
[0m15:35:23.280772 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:35:23.290139 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:35:23.292189 [debug] [MainThread]: Using postgres connection "master"
[0m15:35:23.293728 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m15:35:23.318339 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m15:35:23.320540 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8a12be2b-5e51-467a-9203-b33aa788e4cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x715b3ed0c830>]}
[0m15:35:23.321531 [debug] [MainThread]: On master: ROLLBACK
[0m15:35:23.322589 [debug] [MainThread]: Using postgres connection "master"
[0m15:35:23.323418 [debug] [MainThread]: On master: BEGIN
[0m15:35:23.324721 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:35:23.325632 [debug] [MainThread]: On master: COMMIT
[0m15:35:23.326434 [debug] [MainThread]: Using postgres connection "master"
[0m15:35:23.327616 [debug] [MainThread]: On master: COMMIT
[0m15:35:23.329490 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m15:35:23.330694 [debug] [MainThread]: On master: Close
[0m15:35:23.333010 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m15:35:23.334472 [info ] [MainThread]: 
[0m15:35:23.339148 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m15:35:23.340484 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m15:35:23.342080 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m15:35:23.343321 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m15:35:23.364264 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m15:35:23.390068 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 15:35:23.344249 => 15:35:23.389423
[0m15:35:23.391559 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m15:35:23.451308 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m15:35:23.476859 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:35:23.478298 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m15:35:23.479903 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:35:23.487323 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:35:23.488441 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:35:23.489407 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m15:35:23.514527 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m15:35:23.523491 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:35:23.524774 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m15:35:23.526493 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:35:23.536720 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:35:23.538492 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m15:35:23.541241 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:35:23.579338 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m15:35:23.580731 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:35:23.581825 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m15:35:23.587549 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:35:23.599948 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m15:35:23.610583 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:35:23.612048 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m15:35:23.621412 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:35:23.624610 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 15:35:23.392334 => 15:35:23.624237
[0m15:35:23.625735 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m15:35:23.628102 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8a12be2b-5e51-467a-9203-b33aa788e4cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x715b3e50b800>]}
[0m15:35:23.630897 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.29s]
[0m15:35:23.632602 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m15:35:23.634166 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m15:35:23.635930 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m15:35:23.637835 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m15:35:23.638723 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m15:35:23.644160 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m15:35:23.669128 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 15:35:23.639399 => 15:35:23.668714
[0m15:35:23.670137 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m15:35:23.676267 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m15:35:23.697650 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:35:23.698572 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m15:35:23.699489 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:35:23.706867 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:35:23.708195 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:35:23.709217 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m15:35:23.727427 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m15:35:23.732999 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:35:23.734289 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m15:35:23.735938 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:35:23.741066 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:35:23.742078 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m15:35:23.743528 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:35:23.747585 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m15:35:23.748597 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:35:23.749442 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m15:35:23.756325 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:35:23.763404 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m15:35:23.765039 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:35:23.765998 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m15:35:23.772709 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:35:23.775553 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 15:35:23.670839 => 15:35:23.775103
[0m15:35:23.776749 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m15:35:23.778831 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8a12be2b-5e51-467a-9203-b33aa788e4cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x715b3e5cffb0>]}
[0m15:35:23.780653 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.14s]
[0m15:35:23.782199 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m15:35:23.783312 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m15:35:23.784459 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m15:35:23.785931 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m15:35:23.786882 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m15:35:23.792159 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m15:35:23.817795 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 15:35:23.787641 => 15:35:23.817382
[0m15:35:23.818734 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m15:35:23.824418 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m15:35:23.853437 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:35:23.854732 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m15:35:23.856234 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:35:23.865342 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:35:23.866694 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:35:23.868409 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m15:35:23.908188 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m15:35:23.914353 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:35:23.915692 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m15:35:23.917651 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:35:23.924228 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:35:23.925831 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m15:35:23.927735 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:35:23.931815 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m15:35:23.932842 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:35:23.933778 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m15:35:23.939454 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:35:23.946170 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m15:35:23.948851 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:35:23.950394 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m15:35:23.957794 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:35:23.961501 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 15:35:23.819529 => 15:35:23.960980
[0m15:35:23.963494 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m15:35:23.965807 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8a12be2b-5e51-467a-9203-b33aa788e4cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x715b3e5cfbc0>]}
[0m15:35:23.967466 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.18s]
[0m15:35:23.969242 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m15:35:23.971975 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m15:35:23.973670 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m15:35:23.976406 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m15:35:23.978019 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m15:35:23.989781 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m15:35:24.026328 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 15:35:23.979467 => 15:35:24.025493
[0m15:35:24.028389 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m15:35:24.037144 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m15:35:24.063387 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:35:24.064476 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m15:35:24.065379 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:35:24.072067 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:35:24.073041 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:35:24.074262 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        'avg_fg3_pct' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_rebounds' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_turnovers' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_plus_minus' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'avg_steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'avg_blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM silver.player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk
    FROM "nba"."silver"."players" AS p
    LEFT JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    where pgs.player_id IS NOT NULL -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m15:35:24.213550 [debug] [Thread-1 (]: SQL status: SELECT 0 in 0.0 seconds
[0m15:35:24.218461 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:35:24.219560 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m15:35:24.221115 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:35:24.226668 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:35:24.227827 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m15:35:24.232018 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:35:24.235093 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m15:35:24.236121 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:35:24.236974 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m15:35:24.244419 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:35:24.249534 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m15:35:24.251023 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:35:24.252024 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m15:35:24.258243 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:35:24.261059 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 15:35:24.029790 => 15:35:24.260699
[0m15:35:24.263033 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m15:35:24.264799 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8a12be2b-5e51-467a-9203-b33aa788e4cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x715b3e5781a0>]}
[0m15:35:24.266359 [info ] [Thread-1 (]: 4 of 4 OK created sql table model gold.players_recommendations ................. [[32mSELECT 0[0m in 0.29s]
[0m15:35:24.267896 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m15:35:24.270707 [debug] [MainThread]: Using postgres connection "master"
[0m15:35:24.271629 [debug] [MainThread]: On master: BEGIN
[0m15:35:24.272428 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:35:24.279125 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:35:24.280281 [debug] [MainThread]: On master: COMMIT
[0m15:35:24.281095 [debug] [MainThread]: Using postgres connection "master"
[0m15:35:24.281867 [debug] [MainThread]: On master: COMMIT
[0m15:35:24.283096 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m15:35:24.284236 [debug] [MainThread]: On master: Close
[0m15:35:24.285633 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:35:24.286655 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m15:35:24.287864 [info ] [MainThread]: 
[0m15:35:24.289009 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 1.10 seconds (1.10s).
[0m15:35:24.290932 [debug] [MainThread]: Command end result
[0m15:35:24.357538 [info ] [MainThread]: 
[0m15:35:24.359001 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:35:24.360410 [info ] [MainThread]: 
[0m15:35:24.362220 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m15:35:24.364606 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.453161, "process_user_time": 4.412034, "process_kernel_time": 0.469537, "process_mem_max_rss": "201012", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m15:35:24.365780 [debug] [MainThread]: Command `dbt run` succeeded at 15:35:24.365557 after 2.45 seconds
[0m15:35:24.366833 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x715b4417c860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x715b3fa08950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x715b3e5de1b0>]}
[0m15:35:24.367823 [debug] [MainThread]: Flushing usage events
[0m15:53:19.389555 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x784cc48c5370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x784cc4c463c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x784cc48c5310>]}


============================== 15:53:19.393916 | c2bfc221-c728-4e81-88e5-c880e874e713 ==============================
[0m15:53:19.393916 [info ] [MainThread]: Running with dbt=1.7.9
[0m15:53:19.395361 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:53:19.719355 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c2bfc221-c728-4e81-88e5-c880e874e713', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x784cc4925f40>]}
[0m15:53:19.885521 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c2bfc221-c728-4e81-88e5-c880e874e713', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x784cc3d39100>]}
[0m15:53:19.887279 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m15:53:19.911498 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m15:53:20.299184 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:53:20.300863 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m15:53:20.528751 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m15:53:20.536992 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c2bfc221-c728-4e81-88e5-c880e874e713', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x784cc3522150>]}
[0m15:53:20.813234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c2bfc221-c728-4e81-88e5-c880e874e713', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x784cc3569a60>]}
[0m15:53:20.814325 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m15:53:20.815469 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c2bfc221-c728-4e81-88e5-c880e874e713', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x784cc4925a00>]}
[0m15:53:20.820156 [info ] [MainThread]: 
[0m15:53:20.822790 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m15:53:20.826308 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m15:53:20.855917 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m15:53:20.857444 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m15:53:20.858861 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:53:20.870209 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m15:53:20.873442 [debug] [ThreadPool]: On list_nba: Close
[0m15:53:20.877866 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m15:53:20.895065 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m15:53:20.896159 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m15:53:20.897364 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:53:20.906352 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m15:53:20.907881 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m15:53:20.909478 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m15:53:20.917621 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m15:53:20.920868 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m15:53:20.922352 [debug] [ThreadPool]: On list_nba_gold: Close
[0m15:53:20.933344 [debug] [MainThread]: Using postgres connection "master"
[0m15:53:20.935007 [debug] [MainThread]: On master: BEGIN
[0m15:53:20.936321 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:53:20.945060 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:53:20.946557 [debug] [MainThread]: Using postgres connection "master"
[0m15:53:20.947712 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m15:53:20.983245 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m15:53:20.986401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c2bfc221-c728-4e81-88e5-c880e874e713', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x784cc39d9e50>]}
[0m15:53:20.987770 [debug] [MainThread]: On master: ROLLBACK
[0m15:53:20.989307 [debug] [MainThread]: Using postgres connection "master"
[0m15:53:20.990437 [debug] [MainThread]: On master: BEGIN
[0m15:53:20.992480 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:53:20.993804 [debug] [MainThread]: On master: COMMIT
[0m15:53:20.995408 [debug] [MainThread]: Using postgres connection "master"
[0m15:53:20.996513 [debug] [MainThread]: On master: COMMIT
[0m15:53:20.998927 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m15:53:21.002935 [debug] [MainThread]: On master: Close
[0m15:53:21.005597 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m15:53:21.007353 [info ] [MainThread]: 
[0m15:53:21.013535 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m15:53:21.015159 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m15:53:21.017728 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m15:53:21.019611 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m15:53:21.036177 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m15:53:21.072775 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 15:53:21.020780 => 15:53:21.072296
[0m15:53:21.073644 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m15:53:21.128558 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m15:53:21.161326 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:53:21.162347 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m15:53:21.163301 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:53:21.170409 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:53:21.171413 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:53:21.172287 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m15:53:21.192127 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m15:53:21.203724 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:53:21.205022 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m15:53:21.206963 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:53:21.212215 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:53:21.213553 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m15:53:21.215557 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:53:21.250286 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m15:53:21.252302 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:53:21.253492 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m15:53:21.259504 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:53:21.271058 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m15:53:21.281163 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m15:53:21.282291 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m15:53:21.290073 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:53:21.293232 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 15:53:21.074232 => 15:53:21.292865
[0m15:53:21.294407 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m15:53:21.296297 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2bfc221-c728-4e81-88e5-c880e874e713', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x784cc31ca7e0>]}
[0m15:53:21.299009 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.28s]
[0m15:53:21.301307 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m15:53:21.302793 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m15:53:21.304165 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m15:53:21.305956 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m15:53:21.307163 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m15:53:21.313024 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m15:53:21.338764 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 15:53:21.308148 => 15:53:21.338348
[0m15:53:21.339882 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m15:53:21.346106 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m15:53:21.373455 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:53:21.374523 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m15:53:21.375453 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:53:21.382676 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:53:21.384030 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:53:21.385871 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m15:53:21.407459 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m15:53:21.412342 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:53:21.413711 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m15:53:21.415450 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:53:21.421183 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:53:21.422246 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m15:53:21.423737 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:53:21.427006 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m15:53:21.428157 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:53:21.429147 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m15:53:21.435220 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:53:21.441136 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m15:53:21.442902 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m15:53:21.443969 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m15:53:21.451665 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:53:21.454419 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 15:53:21.340747 => 15:53:21.454107
[0m15:53:21.455471 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m15:53:21.457359 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2bfc221-c728-4e81-88e5-c880e874e713', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x784cc2987fe0>]}
[0m15:53:21.458883 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m15:53:21.460425 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m15:53:21.461740 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m15:53:21.462889 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m15:53:21.464323 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m15:53:21.465467 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m15:53:21.473797 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m15:53:21.539239 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 15:53:21.466298 => 15:53:21.538847
[0m15:53:21.540311 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m15:53:21.546145 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m15:53:21.593759 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:53:21.594913 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m15:53:21.595962 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:53:21.603703 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:53:21.604961 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:53:21.606477 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m15:53:21.640369 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m15:53:21.645088 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:53:21.646424 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m15:53:21.648258 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:53:21.654554 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:53:21.655674 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m15:53:21.657449 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m15:53:21.660500 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m15:53:21.661923 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:53:21.663102 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m15:53:21.669363 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m15:53:21.673370 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m15:53:21.675003 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m15:53:21.676101 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m15:53:21.684326 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m15:53:21.687563 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 15:53:21.541383 => 15:53:21.687256
[0m15:53:21.688802 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m15:53:21.691153 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2bfc221-c728-4e81-88e5-c880e874e713', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x784cc2986f30>]}
[0m15:53:21.693192 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.23s]
[0m15:53:21.694647 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m15:53:21.696454 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m15:53:21.697764 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m15:53:21.699352 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m15:53:21.700933 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m15:53:21.709757 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m15:53:21.757511 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 15:53:21.702443 => 15:53:21.757097
[0m15:53:21.758615 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m15:53:21.764417 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m15:53:21.813346 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:53:21.814344 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m15:53:21.815254 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:53:21.822979 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m15:53:21.824110 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m15:53:21.825417 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        '3-point shooting' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Rebounding' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Ball Handling' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Points Differential' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM silver.player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avgavg_plus_minus_blk DESC) AS rank_plusminus,
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Points Differential' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE plus_minus_rank <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m15:53:21.827851 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "FROM"
LINE 120:     FROM "nba"."silver"."players" AS p
              ^

[0m15:53:21.829224 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m15:53:21.830900 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 15:53:21.759419 => 15:53:21.830589
[0m15:53:21.831865 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m15:53:21.838829 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "FROM"
  LINE 120:     FROM "nba"."silver"."players" AS p
                ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m15:53:21.840168 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2bfc221-c728-4e81-88e5-c880e874e713', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x784cc2984230>]}
[0m15:53:21.841617 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.14s]
[0m15:53:21.843076 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m15:53:21.847897 [debug] [MainThread]: Using postgres connection "master"
[0m15:53:21.848962 [debug] [MainThread]: On master: BEGIN
[0m15:53:21.849945 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:53:21.858489 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m15:53:21.859941 [debug] [MainThread]: On master: COMMIT
[0m15:53:21.860914 [debug] [MainThread]: Using postgres connection "master"
[0m15:53:21.861880 [debug] [MainThread]: On master: COMMIT
[0m15:53:21.863375 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m15:53:21.864726 [debug] [MainThread]: On master: Close
[0m15:53:21.866444 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:53:21.867870 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m15:53:21.869626 [info ] [MainThread]: 
[0m15:53:21.870846 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 1.05 seconds (1.05s).
[0m15:53:21.873079 [debug] [MainThread]: Command end result
[0m15:53:21.949802 [info ] [MainThread]: 
[0m15:53:21.951472 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:53:21.953158 [info ] [MainThread]: 
[0m15:53:21.954230 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "FROM"
  LINE 120:     FROM "nba"."silver"."players" AS p
                ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m15:53:21.955463 [info ] [MainThread]: 
[0m15:53:21.956572 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m15:53:21.958583 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.7745152, "process_user_time": 4.12084, "process_kernel_time": 0.415278, "process_mem_max_rss": "201020", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m15:53:21.959802 [debug] [MainThread]: Command `dbt run` failed at 15:53:21.959586 after 2.78 seconds
[0m15:53:21.960828 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x784cc48c5310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x784cc31f8dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x784cc35bcf80>]}
[0m15:53:21.961807 [debug] [MainThread]: Flushing usage events
[0m16:11:58.216513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d2040f90a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d20498f140>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d2040fb1a0>]}


============================== 16:11:58.221874 | 0faf0ea1-4718-45b2-8192-b5e33f2324d5 ==============================
[0m16:11:58.221874 [info ] [MainThread]: Running with dbt=1.7.9
[0m16:11:58.223143 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:11:58.525798 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0faf0ea1-4718-45b2-8192-b5e33f2324d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d204126780>]}
[0m16:11:58.663236 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0faf0ea1-4718-45b2-8192-b5e33f2324d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d2047efda0>]}
[0m16:11:58.664897 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m16:11:58.690744 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m16:11:59.136888 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:11:59.138289 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m16:11:59.363936 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m16:11:59.371614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0faf0ea1-4718-45b2-8192-b5e33f2324d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d203f59d00>]}
[0m16:11:59.592113 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0faf0ea1-4718-45b2-8192-b5e33f2324d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d2033ad850>]}
[0m16:11:59.593447 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m16:11:59.595031 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0faf0ea1-4718-45b2-8192-b5e33f2324d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d203fefd40>]}
[0m16:11:59.598909 [info ] [MainThread]: 
[0m16:11:59.601682 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:11:59.605160 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m16:11:59.624907 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m16:11:59.626313 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m16:11:59.627493 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:11:59.641410 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m16:11:59.644735 [debug] [ThreadPool]: On list_nba: Close
[0m16:11:59.649978 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m16:11:59.661454 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m16:11:59.662838 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m16:11:59.664487 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:11:59.675313 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:11:59.676527 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m16:11:59.677417 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m16:11:59.686251 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m16:11:59.689019 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m16:11:59.690772 [debug] [ThreadPool]: On list_nba_gold: Close
[0m16:11:59.703573 [debug] [MainThread]: Using postgres connection "master"
[0m16:11:59.704910 [debug] [MainThread]: On master: BEGIN
[0m16:11:59.706775 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:11:59.714268 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:11:59.716547 [debug] [MainThread]: Using postgres connection "master"
[0m16:11:59.717691 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:11:59.737938 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:11:59.740158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0faf0ea1-4718-45b2-8192-b5e33f2324d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d205493e00>]}
[0m16:11:59.741329 [debug] [MainThread]: On master: ROLLBACK
[0m16:11:59.742649 [debug] [MainThread]: Using postgres connection "master"
[0m16:11:59.743632 [debug] [MainThread]: On master: BEGIN
[0m16:11:59.745293 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:11:59.746308 [debug] [MainThread]: On master: COMMIT
[0m16:11:59.747262 [debug] [MainThread]: Using postgres connection "master"
[0m16:11:59.748089 [debug] [MainThread]: On master: COMMIT
[0m16:11:59.750166 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m16:11:59.751309 [debug] [MainThread]: On master: Close
[0m16:11:59.752717 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m16:11:59.754882 [info ] [MainThread]: 
[0m16:11:59.759342 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m16:11:59.760626 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m16:11:59.762140 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m16:11:59.763184 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m16:11:59.774960 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m16:11:59.827952 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 16:11:59.763996 => 16:11:59.827329
[0m16:11:59.829203 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m16:11:59.897622 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m16:11:59.930970 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:11:59.932676 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m16:11:59.934305 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:11:59.943447 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:11:59.944660 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:11:59.945884 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m16:11:59.971101 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m16:11:59.985256 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:11:59.986537 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m16:11:59.988629 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:11:59.993495 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:11:59.994906 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m16:11:59.996679 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:12:00.029688 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m16:12:00.031083 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:12:00.032750 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m16:12:00.040623 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:12:00.051375 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m16:12:00.062010 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:12:00.063258 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m16:12:00.071554 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:12:00.074983 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 16:11:59.830209 => 16:12:00.074396
[0m16:12:00.076355 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m16:12:00.078149 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0faf0ea1-4718-45b2-8192-b5e33f2324d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d202707ad0>]}
[0m16:12:00.081202 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.32s]
[0m16:12:00.083644 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m16:12:00.084989 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m16:12:00.086184 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m16:12:00.087786 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m16:12:00.088808 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m16:12:00.094304 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m16:12:00.121003 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 16:12:00.089673 => 16:12:00.120554
[0m16:12:00.122014 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m16:12:00.127918 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m16:12:00.154624 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:12:00.155656 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m16:12:00.156617 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:12:00.166620 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:12:00.167795 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:12:00.168921 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m16:12:00.193764 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m16:12:00.200150 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:12:00.205193 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m16:12:00.207308 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:12:00.213466 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:12:00.214877 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m16:12:00.217181 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:12:00.222445 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m16:12:00.223909 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:12:00.224816 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m16:12:00.229969 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:12:00.237300 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m16:12:00.239110 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:12:00.240114 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m16:12:00.246239 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:12:00.250221 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 16:12:00.122805 => 16:12:00.249631
[0m16:12:00.251473 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m16:12:00.253172 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0faf0ea1-4718-45b2-8192-b5e33f2324d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d2027ca7e0>]}
[0m16:12:00.254915 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.17s]
[0m16:12:00.256681 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m16:12:00.257803 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m16:12:00.259138 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m16:12:00.260922 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m16:12:00.261967 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m16:12:00.269255 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m16:12:00.313377 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 16:12:00.262770 => 16:12:00.312972
[0m16:12:00.314423 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m16:12:00.320902 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m16:12:00.369813 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:12:00.371054 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m16:12:00.372251 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:12:00.380883 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:12:00.382560 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:12:00.383990 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m16:12:00.421351 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m16:12:00.426904 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:12:00.428306 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m16:12:00.430589 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:12:00.436969 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:12:00.438483 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m16:12:00.440630 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:12:00.445610 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m16:12:00.447121 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:12:00.448850 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m16:12:00.457909 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:12:00.465464 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m16:12:00.468137 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:12:00.470175 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m16:12:00.478458 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:12:00.483279 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 16:12:00.315873 => 16:12:00.482808
[0m16:12:00.484734 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m16:12:00.487234 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0faf0ea1-4718-45b2-8192-b5e33f2324d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d2027c9e80>]}
[0m16:12:00.490137 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.23s]
[0m16:12:00.491890 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m16:12:00.494767 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m16:12:00.496123 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m16:12:00.498062 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m16:12:00.499992 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m16:12:00.515749 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m16:12:00.569641 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 16:12:00.501143 => 16:12:00.568917
[0m16:12:00.570999 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m16:12:00.577834 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m16:12:00.620978 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:12:00.622034 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m16:12:00.622944 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:12:00.631690 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:12:00.633686 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:12:00.635262 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        '3-point shooting' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Rebounding' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Ball Handling' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Points Differential' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM FROM "nba"."silver"."player_stats" 
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avgavg_plus_minus_blk DESC) AS rank_plusminus,
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Points Differential' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE plus_minus_rank <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m16:12:00.637418 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "FROM"
LINE 94: FROM FROM "nba"."silver"."player_stats" 
              ^

[0m16:12:00.638778 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m16:12:00.640806 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 16:12:00.571896 => 16:12:00.640190
[0m16:12:00.642574 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m16:12:00.651875 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "FROM"
  LINE 94: FROM FROM "nba"."silver"."player_stats" 
                ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m16:12:00.653667 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0faf0ea1-4718-45b2-8192-b5e33f2324d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d2027caf60>]}
[0m16:12:00.655113 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.16s]
[0m16:12:00.657116 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m16:12:00.662419 [debug] [MainThread]: Using postgres connection "master"
[0m16:12:00.664133 [debug] [MainThread]: On master: BEGIN
[0m16:12:00.665700 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:12:00.674429 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:12:00.675692 [debug] [MainThread]: On master: COMMIT
[0m16:12:00.676715 [debug] [MainThread]: Using postgres connection "master"
[0m16:12:00.677744 [debug] [MainThread]: On master: COMMIT
[0m16:12:00.678922 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m16:12:00.679852 [debug] [MainThread]: On master: Close
[0m16:12:00.681372 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:12:00.682850 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m16:12:00.683812 [info ] [MainThread]: 
[0m16:12:00.684950 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 1.08 seconds (1.08s).
[0m16:12:00.687117 [debug] [MainThread]: Command end result
[0m16:12:00.759838 [info ] [MainThread]: 
[0m16:12:00.761019 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:12:00.762327 [info ] [MainThread]: 
[0m16:12:00.766903 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "FROM"
  LINE 94: FROM FROM "nba"."silver"."player_stats" 
                ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m16:12:00.768168 [info ] [MainThread]: 
[0m16:12:00.769465 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m16:12:00.771397 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.7900462, "process_user_time": 3.972878, "process_kernel_time": 0.469996, "process_mem_max_rss": "201036", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m16:12:00.772579 [debug] [MainThread]: Command `dbt run` failed at 16:12:00.772362 after 2.79 seconds
[0m16:12:00.773525 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d20498f140>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d2044e07a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d2044c38f0>]}
[0m16:12:00.774402 [debug] [MainThread]: Flushing usage events
[0m16:13:07.549099 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a449a3362d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a449a459760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a449a43b8c0>]}


============================== 16:13:07.554316 | d3217c4a-323a-4bc4-8a32-e9adb690b65e ==============================
[0m16:13:07.554316 [info ] [MainThread]: Running with dbt=1.7.9
[0m16:13:07.556508 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:13:07.898878 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd3217c4a-323a-4bc4-8a32-e9adb690b65e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a449b661880>]}
[0m16:13:08.053317 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd3217c4a-323a-4bc4-8a32-e9adb690b65e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a449a9c2570>]}
[0m16:13:08.054909 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m16:13:08.079544 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m16:13:08.357069 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:13:08.358421 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m16:13:08.606385 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m16:13:08.615894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd3217c4a-323a-4bc4-8a32-e9adb690b65e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4499181610>]}
[0m16:13:08.694799 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd3217c4a-323a-4bc4-8a32-e9adb690b65e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a44999b15b0>]}
[0m16:13:08.695856 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m16:13:08.696887 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd3217c4a-323a-4bc4-8a32-e9adb690b65e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4499162ba0>]}
[0m16:13:08.700214 [info ] [MainThread]: 
[0m16:13:08.702078 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:13:08.704429 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m16:13:08.720634 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m16:13:08.721664 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m16:13:08.722647 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:13:08.735407 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m16:13:08.737726 [debug] [ThreadPool]: On list_nba: Close
[0m16:13:08.741480 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m16:13:08.751276 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m16:13:08.752204 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m16:13:08.753004 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:13:08.759376 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:13:08.760284 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m16:13:08.761304 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m16:13:08.765574 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m16:13:08.768292 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m16:13:08.769615 [debug] [ThreadPool]: On list_nba_gold: Close
[0m16:13:08.777131 [debug] [MainThread]: Using postgres connection "master"
[0m16:13:08.778239 [debug] [MainThread]: On master: BEGIN
[0m16:13:08.779374 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:13:08.786617 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:13:08.788027 [debug] [MainThread]: Using postgres connection "master"
[0m16:13:08.789022 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:13:08.809660 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:13:08.812180 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd3217c4a-323a-4bc4-8a32-e9adb690b65e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4499180530>]}
[0m16:13:08.813387 [debug] [MainThread]: On master: ROLLBACK
[0m16:13:08.814688 [debug] [MainThread]: Using postgres connection "master"
[0m16:13:08.815640 [debug] [MainThread]: On master: BEGIN
[0m16:13:08.817709 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:13:08.818872 [debug] [MainThread]: On master: COMMIT
[0m16:13:08.820154 [debug] [MainThread]: Using postgres connection "master"
[0m16:13:08.821037 [debug] [MainThread]: On master: COMMIT
[0m16:13:08.822441 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m16:13:08.823470 [debug] [MainThread]: On master: Close
[0m16:13:08.825118 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m16:13:08.826332 [info ] [MainThread]: 
[0m16:13:08.832427 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m16:13:08.834270 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m16:13:08.836784 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m16:13:08.838410 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m16:13:08.856969 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m16:13:08.884282 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 16:13:08.839664 => 16:13:08.883216
[0m16:13:08.886015 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m16:13:08.946768 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m16:13:08.969045 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:13:08.970040 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m16:13:08.970956 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:13:08.978248 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:13:08.979534 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:13:08.980658 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m16:13:08.999025 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m16:13:09.009456 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:13:09.010624 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m16:13:09.012423 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:13:09.018040 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:13:09.019230 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m16:13:09.020763 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:13:09.056055 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m16:13:09.057157 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:13:09.058046 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m16:13:09.063636 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:13:09.074601 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m16:13:09.085033 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:13:09.086275 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m16:13:09.093704 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:13:09.098543 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 16:13:08.886844 => 16:13:09.097848
[0m16:13:09.100419 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m16:13:09.102914 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd3217c4a-323a-4bc4-8a32-e9adb690b65e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4499d614f0>]}
[0m16:13:09.105162 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.27s]
[0m16:13:09.107487 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m16:13:09.108960 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m16:13:09.110318 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m16:13:09.112697 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m16:13:09.114457 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m16:13:09.124435 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m16:13:09.154803 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 16:13:09.116263 => 16:13:09.154339
[0m16:13:09.156355 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m16:13:09.164539 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m16:13:09.189407 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:13:09.190409 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m16:13:09.191412 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:13:09.198294 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:13:09.199591 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:13:09.201537 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m16:13:09.220818 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m16:13:09.225839 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:13:09.227218 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m16:13:09.228786 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:13:09.234270 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:13:09.235922 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m16:13:09.237985 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:13:09.241411 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m16:13:09.242593 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:13:09.243648 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m16:13:09.249033 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:13:09.255655 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m16:13:09.257538 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:13:09.258791 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m16:13:09.265352 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:13:09.268961 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 16:13:09.157591 => 16:13:09.268661
[0m16:13:09.270083 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m16:13:09.271826 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd3217c4a-323a-4bc4-8a32-e9adb690b65e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4498dc8e30>]}
[0m16:13:09.273321 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.16s]
[0m16:13:09.275055 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m16:13:09.276271 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m16:13:09.277403 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m16:13:09.278868 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m16:13:09.279969 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m16:13:09.286684 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m16:13:09.312499 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 16:13:09.280638 => 16:13:09.312061
[0m16:13:09.313423 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m16:13:09.320296 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m16:13:09.347835 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:13:09.348965 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m16:13:09.350303 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:13:09.358963 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:13:09.360429 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:13:09.361921 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m16:13:09.398307 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m16:13:09.406983 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:13:09.408522 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m16:13:09.410289 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:13:09.417823 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:13:09.418911 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m16:13:09.420539 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:13:09.423991 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m16:13:09.425130 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:13:09.426280 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m16:13:09.431735 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:13:09.437257 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m16:13:09.439102 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:13:09.440617 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m16:13:09.450590 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:13:09.453977 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 16:13:09.314097 => 16:13:09.453676
[0m16:13:09.455136 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m16:13:09.456970 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd3217c4a-323a-4bc4-8a32-e9adb690b65e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4498d0b350>]}
[0m16:13:09.459887 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.18s]
[0m16:13:09.461835 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m16:13:09.464408 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m16:13:09.465729 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m16:13:09.468647 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m16:13:09.470174 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m16:13:09.483569 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m16:13:09.508049 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 16:13:09.471344 => 16:13:09.507490
[0m16:13:09.509606 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m16:13:09.518383 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m16:13:09.545579 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:13:09.546954 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m16:13:09.548239 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:13:09.556659 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:13:09.558091 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:13:09.559669 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        '3-point shooting' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Rebounding' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Ball Handling' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Points Differential' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avgavg_plus_minus_blk DESC) AS rank_plusminus,
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Points Differential' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE plus_minus_rank <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m16:13:09.562681 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "FROM"
LINE 120:     FROM "nba"."silver"."players" AS p
              ^

[0m16:13:09.564191 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m16:13:09.566935 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 16:13:09.510474 => 16:13:09.566139
[0m16:13:09.568837 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m16:13:09.576157 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "FROM"
  LINE 120:     FROM "nba"."silver"."players" AS p
                ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m16:13:09.577406 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd3217c4a-323a-4bc4-8a32-e9adb690b65e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4498d0b350>]}
[0m16:13:09.578685 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.11s]
[0m16:13:09.580246 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m16:13:09.584882 [debug] [MainThread]: Using postgres connection "master"
[0m16:13:09.586326 [debug] [MainThread]: On master: BEGIN
[0m16:13:09.587429 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:13:09.594300 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:13:09.595309 [debug] [MainThread]: On master: COMMIT
[0m16:13:09.596251 [debug] [MainThread]: Using postgres connection "master"
[0m16:13:09.597142 [debug] [MainThread]: On master: COMMIT
[0m16:13:09.598395 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m16:13:09.599516 [debug] [MainThread]: On master: Close
[0m16:13:09.601775 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:13:09.602908 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m16:13:09.604378 [info ] [MainThread]: 
[0m16:13:09.605420 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 0.90 seconds (0.90s).
[0m16:13:09.607414 [debug] [MainThread]: Command end result
[0m16:13:09.663477 [info ] [MainThread]: 
[0m16:13:09.665157 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:13:09.667166 [info ] [MainThread]: 
[0m16:13:09.669205 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "FROM"
  LINE 120:     FROM "nba"."silver"."players" AS p
                ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m16:13:09.671498 [info ] [MainThread]: 
[0m16:13:09.672637 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m16:13:09.674382 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.2266474, "process_user_time": 4.075521, "process_kernel_time": 0.435948, "process_mem_max_rss": "201020", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m16:13:09.675615 [debug] [MainThread]: Command `dbt run` failed at 16:13:09.675368 after 2.23 seconds
[0m16:13:09.676639 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a449a459760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a44991dc350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a449913d130>]}
[0m16:13:09.677744 [debug] [MainThread]: Flushing usage events
[0m16:14:46.847531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c7035a45250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c703699c8c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c7035e54a70>]}


============================== 16:14:46.853263 | a47ce176-f8be-44ee-a466-ea552a9cfe70 ==============================
[0m16:14:46.853263 [info ] [MainThread]: Running with dbt=1.7.9
[0m16:14:46.854565 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m16:14:47.185296 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a47ce176-f8be-44ee-a466-ea552a9cfe70', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c7035e11d90>]}
[0m16:14:47.338808 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a47ce176-f8be-44ee-a466-ea552a9cfe70', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c7035916030>]}
[0m16:14:47.340710 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m16:14:47.366237 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m16:14:47.611593 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:14:47.613021 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m16:14:47.835476 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m16:14:47.843709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a47ce176-f8be-44ee-a466-ea552a9cfe70', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c7034564c50>]}
[0m16:14:47.924445 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a47ce176-f8be-44ee-a466-ea552a9cfe70', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c7034db56a0>]}
[0m16:14:47.925574 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m16:14:47.926673 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a47ce176-f8be-44ee-a466-ea552a9cfe70', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c7034584590>]}
[0m16:14:47.929592 [info ] [MainThread]: 
[0m16:14:47.931870 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:14:47.934960 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m16:14:47.952134 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m16:14:47.953514 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m16:14:47.954796 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:14:47.965502 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m16:14:47.969734 [debug] [ThreadPool]: On list_nba: Close
[0m16:14:47.974307 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m16:14:47.987108 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m16:14:47.988636 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m16:14:47.989918 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:14:48.000625 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:14:48.002324 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m16:14:48.003684 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m16:14:48.012333 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m16:14:48.016391 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m16:14:48.019376 [debug] [ThreadPool]: On list_nba_gold: Close
[0m16:14:48.033791 [debug] [MainThread]: Using postgres connection "master"
[0m16:14:48.035061 [debug] [MainThread]: On master: BEGIN
[0m16:14:48.036617 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:14:48.046428 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:14:48.048297 [debug] [MainThread]: Using postgres connection "master"
[0m16:14:48.050115 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:14:48.077644 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:14:48.080327 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a47ce176-f8be-44ee-a466-ea552a9cfe70', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c7034db5370>]}
[0m16:14:48.081909 [debug] [MainThread]: On master: ROLLBACK
[0m16:14:48.083673 [debug] [MainThread]: Using postgres connection "master"
[0m16:14:48.084883 [debug] [MainThread]: On master: BEGIN
[0m16:14:48.086819 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:14:48.087891 [debug] [MainThread]: On master: COMMIT
[0m16:14:48.089005 [debug] [MainThread]: Using postgres connection "master"
[0m16:14:48.089860 [debug] [MainThread]: On master: COMMIT
[0m16:14:48.090979 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m16:14:48.091863 [debug] [MainThread]: On master: Close
[0m16:14:48.093544 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m16:14:48.094610 [info ] [MainThread]: 
[0m16:14:48.100184 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m16:14:48.101627 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m16:14:48.104127 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m16:14:48.105396 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m16:14:48.118667 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m16:14:48.142158 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 16:14:48.106336 => 16:14:48.141710
[0m16:14:48.143062 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m16:14:48.200260 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m16:14:48.226510 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:14:48.227465 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m16:14:48.228625 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:14:48.236359 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:14:48.237411 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:14:48.238408 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m16:14:48.255832 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m16:14:48.265669 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:14:48.266919 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m16:14:48.268701 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:14:48.274309 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:14:48.275479 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m16:14:48.277141 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:14:48.305613 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m16:14:48.306937 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:14:48.308289 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m16:14:48.314278 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:14:48.327957 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m16:14:48.338753 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:14:48.339832 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m16:14:48.346915 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:14:48.350537 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 16:14:48.143686 => 16:14:48.350232
[0m16:14:48.351763 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m16:14:48.354095 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a47ce176-f8be-44ee-a466-ea552a9cfe70', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c703410fb30>]}
[0m16:14:48.355904 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.25s]
[0m16:14:48.357805 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m16:14:48.359118 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m16:14:48.360407 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m16:14:48.362086 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m16:14:48.363221 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m16:14:48.370050 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m16:14:48.396545 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 16:14:48.364221 => 16:14:48.396082
[0m16:14:48.397794 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m16:14:48.404621 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m16:14:48.432057 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:14:48.433464 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m16:14:48.434838 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:14:48.443881 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:14:48.445253 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:14:48.446317 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m16:14:48.467395 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m16:14:48.472276 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:14:48.473419 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m16:14:48.475015 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:14:48.479503 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:14:48.481253 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m16:14:48.483497 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:14:48.486935 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m16:14:48.488221 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:14:48.489234 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m16:14:48.494699 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:14:48.502003 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m16:14:48.503562 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:14:48.504613 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m16:14:48.511664 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:14:48.514891 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 16:14:48.399146 => 16:14:48.514350
[0m16:14:48.516409 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m16:14:48.518207 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a47ce176-f8be-44ee-a466-ea552a9cfe70', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c7035152c90>]}
[0m16:14:48.519813 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.16s]
[0m16:14:48.522055 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m16:14:48.523506 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m16:14:48.525747 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m16:14:48.528009 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m16:14:48.529780 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m16:14:48.537344 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m16:14:48.565640 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 16:14:48.530837 => 16:14:48.564842
[0m16:14:48.567077 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m16:14:48.572751 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m16:14:48.599751 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:14:48.600934 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m16:14:48.601896 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:14:48.611042 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:14:48.612305 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:14:48.613487 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m16:14:48.647173 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m16:14:48.652249 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:14:48.653408 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m16:14:48.655096 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:14:48.660361 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:14:48.661532 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m16:14:48.663246 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:14:48.667655 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m16:14:48.669138 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:14:48.670152 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m16:14:48.675807 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:14:48.679883 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m16:14:48.682263 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:14:48.683693 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m16:14:48.690770 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:14:48.693919 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 16:14:48.567930 => 16:14:48.693635
[0m16:14:48.694937 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m16:14:48.696861 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a47ce176-f8be-44ee-a466-ea552a9cfe70', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c70341d1e20>]}
[0m16:14:48.700374 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.17s]
[0m16:14:48.701982 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m16:14:48.704173 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m16:14:48.705293 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m16:14:48.706770 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m16:14:48.707781 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m16:14:48.717781 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m16:14:48.744118 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 16:14:48.708607 => 16:14:48.743576
[0m16:14:48.746760 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m16:14:48.754640 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m16:14:48.780032 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:14:48.781370 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m16:14:48.782680 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:14:48.789629 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:14:48.790758 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:14:48.791954 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        '3-point shooting' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Rebounding' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Ball Handling' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Points Differential' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avgavg_plus_minus_blk DESC) AS rank_plusminus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Points Differential' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE plus_minus_rank <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m16:14:48.796657 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column pgs.avgavg_plus_minus_blk does not exist
LINE 119: ...W_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avgavg...
                                                               ^

[0m16:14:48.798455 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m16:14:48.800742 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 16:14:48.748108 => 16:14:48.800397
[0m16:14:48.801832 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m16:14:48.807908 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column pgs.avgavg_plus_minus_blk does not exist
  LINE 119: ...W_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avgavg...
                                                                 ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m16:14:48.809281 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a47ce176-f8be-44ee-a466-ea552a9cfe70', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c70341a7c50>]}
[0m16:14:48.810615 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m16:14:48.812308 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m16:14:48.817147 [debug] [MainThread]: Using postgres connection "master"
[0m16:14:48.818055 [debug] [MainThread]: On master: BEGIN
[0m16:14:48.818815 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:14:48.826349 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:14:48.827345 [debug] [MainThread]: On master: COMMIT
[0m16:14:48.828334 [debug] [MainThread]: Using postgres connection "master"
[0m16:14:48.829256 [debug] [MainThread]: On master: COMMIT
[0m16:14:48.830701 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m16:14:48.832365 [debug] [MainThread]: On master: Close
[0m16:14:48.834249 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:14:48.835282 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m16:14:48.836528 [info ] [MainThread]: 
[0m16:14:48.837779 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 0.91 seconds (0.91s).
[0m16:14:48.839865 [debug] [MainThread]: Command end result
[0m16:14:48.901204 [info ] [MainThread]: 
[0m16:14:48.902499 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:14:48.903657 [info ] [MainThread]: 
[0m16:14:48.905031 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column pgs.avgavg_plus_minus_blk does not exist
  LINE 119: ...W_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avgavg...
                                                                 ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m16:14:48.906268 [info ] [MainThread]: 
[0m16:14:48.907322 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m16:14:48.909126 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.1572678, "process_user_time": 3.978298, "process_kernel_time": 0.456723, "process_mem_max_rss": "201036", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m16:14:48.910263 [debug] [MainThread]: Command `dbt run` failed at 16:14:48.910066 after 2.16 seconds
[0m16:14:48.911246 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c703670b9b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c7035152c90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c70359665a0>]}
[0m16:14:48.912309 [debug] [MainThread]: Flushing usage events
[0m16:15:37.431755 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75db5a1421e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75db5a50f8c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75db5a142060>]}


============================== 16:15:37.436908 | 2cf42fc2-53da-48d6-a15f-33c012fb9fd5 ==============================
[0m16:15:37.436908 [info ] [MainThread]: Running with dbt=1.7.9
[0m16:15:37.438275 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:15:37.739770 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2cf42fc2-53da-48d6-a15f-33c012fb9fd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75db5b259bb0>]}
[0m16:15:37.876821 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2cf42fc2-53da-48d6-a15f-33c012fb9fd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75db5a4e8ce0>]}
[0m16:15:37.878451 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m16:15:37.906802 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m16:15:38.180163 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:15:38.181421 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m16:15:38.408094 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m16:15:38.415544 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2cf42fc2-53da-48d6-a15f-33c012fb9fd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75db58ffab10>]}
[0m16:15:38.490581 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2cf42fc2-53da-48d6-a15f-33c012fb9fd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75db597ad610>]}
[0m16:15:38.491815 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m16:15:38.492870 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2cf42fc2-53da-48d6-a15f-33c012fb9fd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75db59ffa6c0>]}
[0m16:15:38.496256 [info ] [MainThread]: 
[0m16:15:38.498256 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:15:38.501080 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m16:15:38.517653 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m16:15:38.518832 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m16:15:38.520552 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:15:38.535758 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m16:15:38.539480 [debug] [ThreadPool]: On list_nba: Close
[0m16:15:38.543426 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m16:15:38.551896 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m16:15:38.552910 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m16:15:38.554040 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:15:38.562538 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:15:38.563630 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m16:15:38.564502 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m16:15:38.569484 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m16:15:38.573038 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m16:15:38.574367 [debug] [ThreadPool]: On list_nba_gold: Close
[0m16:15:38.582077 [debug] [MainThread]: Using postgres connection "master"
[0m16:15:38.583292 [debug] [MainThread]: On master: BEGIN
[0m16:15:38.584329 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:15:38.593256 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:15:38.594716 [debug] [MainThread]: Using postgres connection "master"
[0m16:15:38.596155 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:15:38.615678 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:15:38.618412 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2cf42fc2-53da-48d6-a15f-33c012fb9fd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75db58fddbe0>]}
[0m16:15:38.619752 [debug] [MainThread]: On master: ROLLBACK
[0m16:15:38.621964 [debug] [MainThread]: Using postgres connection "master"
[0m16:15:38.623132 [debug] [MainThread]: On master: BEGIN
[0m16:15:38.624982 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:15:38.626052 [debug] [MainThread]: On master: COMMIT
[0m16:15:38.627138 [debug] [MainThread]: Using postgres connection "master"
[0m16:15:38.628076 [debug] [MainThread]: On master: COMMIT
[0m16:15:38.629436 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m16:15:38.630609 [debug] [MainThread]: On master: Close
[0m16:15:38.632524 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m16:15:38.633719 [info ] [MainThread]: 
[0m16:15:38.639612 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m16:15:38.641078 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m16:15:38.642800 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m16:15:38.644186 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m16:15:38.656415 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m16:15:38.684288 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 16:15:38.645146 => 16:15:38.683826
[0m16:15:38.685382 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m16:15:38.769631 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m16:15:38.798657 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:15:38.800154 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m16:15:38.801418 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:15:38.811459 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:15:38.813009 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:15:38.814474 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m16:15:38.841596 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m16:15:38.851412 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:15:38.852513 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m16:15:38.854805 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:15:38.859640 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:15:38.860737 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m16:15:38.862286 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:15:38.892919 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m16:15:38.894069 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:15:38.895114 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m16:15:38.900320 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:15:38.911018 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m16:15:38.924560 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:15:38.925786 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m16:15:38.932729 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:15:38.936161 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 16:15:38.686205 => 16:15:38.935811
[0m16:15:38.938046 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m16:15:38.940206 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2cf42fc2-53da-48d6-a15f-33c012fb9fd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75db58b0b920>]}
[0m16:15:38.941669 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.30s]
[0m16:15:38.943881 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m16:15:38.945662 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m16:15:38.947149 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m16:15:38.948926 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m16:15:38.950141 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m16:15:38.956680 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m16:15:38.983760 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 16:15:38.951096 => 16:15:38.983057
[0m16:15:38.985234 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m16:15:38.992461 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m16:15:39.023056 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:15:39.024348 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m16:15:39.025334 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:15:39.032057 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:15:39.033151 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:15:39.034343 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m16:15:39.055532 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m16:15:39.060605 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:15:39.061730 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m16:15:39.063668 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:15:39.069318 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:15:39.071511 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m16:15:39.074015 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:15:39.080080 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m16:15:39.081328 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:15:39.082437 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m16:15:39.088663 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:15:39.104743 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m16:15:39.109214 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:15:39.110871 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m16:15:39.118696 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:15:39.124403 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 16:15:38.986158 => 16:15:39.123861
[0m16:15:39.125929 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m16:15:39.128178 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2cf42fc2-53da-48d6-a15f-33c012fb9fd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75db58bcba40>]}
[0m16:15:39.130062 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.18s]
[0m16:15:39.132345 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m16:15:39.133738 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m16:15:39.135306 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m16:15:39.138613 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m16:15:39.140834 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m16:15:39.147635 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m16:15:39.176058 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 16:15:39.141860 => 16:15:39.175221
[0m16:15:39.177665 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m16:15:39.189153 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m16:15:39.221783 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:15:39.223045 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m16:15:39.223988 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:15:39.231068 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:15:39.232527 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:15:39.233776 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m16:15:39.275101 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m16:15:39.280252 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:15:39.281312 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m16:15:39.282919 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:15:39.288364 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:15:39.289483 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m16:15:39.291130 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:15:39.294091 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m16:15:39.295152 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:15:39.295969 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m16:15:39.301217 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:15:39.305896 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m16:15:39.307757 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:15:39.308971 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m16:15:39.322280 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:15:39.324955 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 16:15:39.178768 => 16:15:39.324615
[0m16:15:39.325967 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m16:15:39.327658 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2cf42fc2-53da-48d6-a15f-33c012fb9fd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75db58bc8cb0>]}
[0m16:15:39.329276 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.19s]
[0m16:15:39.330833 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m16:15:39.333321 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m16:15:39.334779 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m16:15:39.336438 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m16:15:39.337970 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m16:15:39.346704 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m16:15:39.375420 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 16:15:39.339097 => 16:15:39.374990
[0m16:15:39.376365 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m16:15:39.384213 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m16:15:39.411259 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:15:39.412658 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m16:15:39.413909 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:15:39.423535 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:15:39.424909 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:15:39.426375 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        '3-point shooting' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Rebounding' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Ball Handling' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Points Differential' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plusminus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Points Differential' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE plus_minus_rank <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m16:15:39.431458 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "plus_minus_rank" does not exist
LINE 156:     WHERE plus_minus_rank <= 3 --AND position IN ('G', 'G-F'...
                    ^

[0m16:15:39.432840 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m16:15:39.434587 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 16:15:39.377085 => 16:15:39.434199
[0m16:15:39.435842 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m16:15:39.445098 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column "plus_minus_rank" does not exist
  LINE 156:     WHERE plus_minus_rank <= 3 --AND position IN ('G', 'G-F'...
                      ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m16:15:39.446311 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2cf42fc2-53da-48d6-a15f-33c012fb9fd5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75db58b70f50>]}
[0m16:15:39.447806 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.11s]
[0m16:15:39.449711 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m16:15:39.455143 [debug] [MainThread]: Using postgres connection "master"
[0m16:15:39.456546 [debug] [MainThread]: On master: BEGIN
[0m16:15:39.457709 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:15:39.465972 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:15:39.467269 [debug] [MainThread]: On master: COMMIT
[0m16:15:39.468977 [debug] [MainThread]: Using postgres connection "master"
[0m16:15:39.470735 [debug] [MainThread]: On master: COMMIT
[0m16:15:39.472630 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m16:15:39.473840 [debug] [MainThread]: On master: Close
[0m16:15:39.476459 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:15:39.477784 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m16:15:39.479454 [info ] [MainThread]: 
[0m16:15:39.481137 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 0.98 seconds (0.98s).
[0m16:15:39.484866 [debug] [MainThread]: Command end result
[0m16:15:39.560655 [info ] [MainThread]: 
[0m16:15:39.561960 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:15:39.563249 [info ] [MainThread]: 
[0m16:15:39.564830 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column "plus_minus_rank" does not exist
  LINE 156:     WHERE plus_minus_rank <= 3 --AND position IN ('G', 'G-F'...
                      ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m16:15:39.566010 [info ] [MainThread]: 
[0m16:15:39.567133 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m16:15:39.569346 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.2306156, "process_user_time": 4.028255, "process_kernel_time": 0.444028, "process_mem_max_rss": "201020", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m16:15:39.571741 [debug] [MainThread]: Command `dbt run` failed at 16:15:39.571240 after 2.23 seconds
[0m16:15:39.573197 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75db5a1aba40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75db59300f80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75db58f80140>]}
[0m16:15:39.574314 [debug] [MainThread]: Flushing usage events
[0m16:17:52.232460 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79c3f1dd4ef0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79c3f2beadb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79c3f1dd7d10>]}


============================== 16:17:52.236925 | f529b28c-b3c2-41ce-93eb-5641a704fcc2 ==============================
[0m16:17:52.236925 [info ] [MainThread]: Running with dbt=1.7.9
[0m16:17:52.238416 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:17:52.547312 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f529b28c-b3c2-41ce-93eb-5641a704fcc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79c3f18e0410>]}
[0m16:17:52.686222 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f529b28c-b3c2-41ce-93eb-5641a704fcc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79c3f22f4bf0>]}
[0m16:17:52.687836 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m16:17:52.715481 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m16:17:52.994589 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:17:52.996827 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m16:17:53.236140 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m16:17:53.243218 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f529b28c-b3c2-41ce-93eb-5641a704fcc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79c3f1dd5310>]}
[0m16:17:53.318169 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f529b28c-b3c2-41ce-93eb-5641a704fcc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79c3f11715b0>]}
[0m16:17:53.319230 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m16:17:53.320228 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f529b28c-b3c2-41ce-93eb-5641a704fcc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79c3f0dcef30>]}
[0m16:17:53.323417 [info ] [MainThread]: 
[0m16:17:53.325125 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:17:53.327623 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m16:17:53.344485 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m16:17:53.345909 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m16:17:53.347282 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:17:53.356229 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m16:17:53.359589 [debug] [ThreadPool]: On list_nba: Close
[0m16:17:53.363839 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m16:17:53.372352 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m16:17:53.373727 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m16:17:53.374728 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:17:53.382706 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:17:53.383803 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m16:17:53.384728 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m16:17:53.390800 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m16:17:53.393186 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m16:17:53.394771 [debug] [ThreadPool]: On list_nba_gold: Close
[0m16:17:53.402962 [debug] [MainThread]: Using postgres connection "master"
[0m16:17:53.404035 [debug] [MainThread]: On master: BEGIN
[0m16:17:53.404901 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:17:53.413479 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:17:53.414882 [debug] [MainThread]: Using postgres connection "master"
[0m16:17:53.415985 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:17:53.434761 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:17:53.437119 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f529b28c-b3c2-41ce-93eb-5641a704fcc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79c3f1508b60>]}
[0m16:17:53.438461 [debug] [MainThread]: On master: ROLLBACK
[0m16:17:53.439798 [debug] [MainThread]: Using postgres connection "master"
[0m16:17:53.440738 [debug] [MainThread]: On master: BEGIN
[0m16:17:53.442582 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:17:53.443803 [debug] [MainThread]: On master: COMMIT
[0m16:17:53.444889 [debug] [MainThread]: Using postgres connection "master"
[0m16:17:53.446150 [debug] [MainThread]: On master: COMMIT
[0m16:17:53.447952 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m16:17:53.448984 [debug] [MainThread]: On master: Close
[0m16:17:53.450680 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m16:17:53.451857 [info ] [MainThread]: 
[0m16:17:53.457621 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m16:17:53.459247 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m16:17:53.461633 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m16:17:53.463698 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m16:17:53.475128 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m16:17:53.502100 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 16:17:53.464573 => 16:17:53.501659
[0m16:17:53.503141 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m16:17:53.560545 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m16:17:53.603808 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:17:53.604803 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m16:17:53.605960 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:17:53.614270 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:17:53.615501 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:17:53.616624 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m16:17:53.637538 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m16:17:53.647661 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:17:53.648835 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m16:17:53.650511 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:17:53.654969 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:17:53.656073 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m16:17:53.657488 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:17:53.687918 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m16:17:53.689050 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:17:53.689949 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m16:17:53.695975 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:17:53.705664 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m16:17:53.715725 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:17:53.716854 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m16:17:53.725233 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:17:53.727925 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 16:17:53.503938 => 16:17:53.727581
[0m16:17:53.729293 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m16:17:53.731050 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f529b28c-b3c2-41ce-93eb-5641a704fcc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79c3f153fe90>]}
[0m16:17:53.732282 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.27s]
[0m16:17:53.733845 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m16:17:53.734884 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m16:17:53.735818 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m16:17:53.737201 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m16:17:53.738400 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m16:17:53.743505 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m16:17:53.769959 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 16:17:53.739142 => 16:17:53.769541
[0m16:17:53.770946 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m16:17:53.776595 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m16:17:53.800791 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:17:53.802097 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m16:17:53.803469 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:17:53.811128 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:17:53.813069 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:17:53.816011 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m16:17:53.839104 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m16:17:53.844556 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:17:53.846134 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m16:17:53.848155 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:17:53.852793 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:17:53.853946 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m16:17:53.855694 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:17:53.858916 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m16:17:53.859999 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:17:53.860960 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m16:17:53.868100 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:17:53.873763 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m16:17:53.875389 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:17:53.876357 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m16:17:53.882749 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:17:53.885282 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 16:17:53.771703 => 16:17:53.884944
[0m16:17:53.886467 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m16:17:53.888094 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f529b28c-b3c2-41ce-93eb-5641a704fcc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79c3f0588200>]}
[0m16:17:53.889550 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m16:17:53.891134 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m16:17:53.892291 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m16:17:53.893506 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m16:17:53.895536 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m16:17:53.896967 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m16:17:53.902866 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m16:17:53.929128 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 16:17:53.897989 => 16:17:53.928325
[0m16:17:53.930877 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m16:17:53.938259 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m16:17:53.963719 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:17:53.964798 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m16:17:53.965905 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:17:53.973582 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:17:53.974717 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:17:53.975931 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m16:17:54.015117 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m16:17:54.020051 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:17:54.021248 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m16:17:54.023119 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:17:54.028113 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:17:54.029749 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m16:17:54.031572 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:17:54.034811 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m16:17:54.035935 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:17:54.036907 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m16:17:54.045905 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:17:54.050436 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m16:17:54.052036 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:17:54.053098 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m16:17:54.062316 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:17:54.065376 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 16:17:53.931783 => 16:17:54.065042
[0m16:17:54.066620 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m16:17:54.068283 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f529b28c-b3c2-41ce-93eb-5641a704fcc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79c3f058a660>]}
[0m16:17:54.069800 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.17s]
[0m16:17:54.071401 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m16:17:54.073212 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m16:17:54.074409 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m16:17:54.075783 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m16:17:54.076791 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m16:17:54.085734 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m16:17:54.112452 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 16:17:54.077628 => 16:17:54.111729
[0m16:17:54.114092 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m16:17:54.120735 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m16:17:54.149017 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:17:54.150064 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m16:17:54.151124 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:17:54.158901 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:17:54.160290 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:17:54.163355 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        '3-point shooting' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Rebounding' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Ball Handling' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Points Differential' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plusminus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Points Differential' AS weakness_type,
        player,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE plus_minus_rank <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m16:17:54.168794 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "plus_minus_rank" does not exist
LINE 156:     WHERE plus_minus_rank <= 3 --AND position IN ('G', 'G-F'...
                    ^

[0m16:17:54.170299 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m16:17:54.171887 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 16:17:54.115114 => 16:17:54.171548
[0m16:17:54.172994 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m16:17:54.180416 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column "plus_minus_rank" does not exist
  LINE 156:     WHERE plus_minus_rank <= 3 --AND position IN ('G', 'G-F'...
                      ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m16:17:54.181923 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f529b28c-b3c2-41ce-93eb-5641a704fcc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79c3f150af30>]}
[0m16:17:54.183322 [error] [Thread-1 (]: 4 of 4 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.11s]
[0m16:17:54.184665 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m16:17:54.188964 [debug] [MainThread]: Using postgres connection "master"
[0m16:17:54.190054 [debug] [MainThread]: On master: BEGIN
[0m16:17:54.191087 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:17:54.199002 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:17:54.200169 [debug] [MainThread]: On master: COMMIT
[0m16:17:54.201309 [debug] [MainThread]: Using postgres connection "master"
[0m16:17:54.202422 [debug] [MainThread]: On master: COMMIT
[0m16:17:54.203768 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m16:17:54.204794 [debug] [MainThread]: On master: Close
[0m16:17:54.206449 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:17:54.207465 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m16:17:54.208593 [info ] [MainThread]: 
[0m16:17:54.209875 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 0.88 seconds (0.88s).
[0m16:17:54.211816 [debug] [MainThread]: Command end result
[0m16:17:54.277295 [info ] [MainThread]: 
[0m16:17:54.279121 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:17:54.280560 [info ] [MainThread]: 
[0m16:17:54.281579 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column "plus_minus_rank" does not exist
  LINE 156:     WHERE plus_minus_rank <= 3 --AND position IN ('G', 'G-F'...
                      ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m16:17:54.283265 [info ] [MainThread]: 
[0m16:17:54.284376 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m16:17:54.286074 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.1487234, "process_user_time": 3.89918, "process_kernel_time": 0.483898, "process_mem_max_rss": "201012", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m16:17:54.287201 [debug] [MainThread]: Command `dbt run` failed at 16:17:54.287004 after 2.15 seconds
[0m16:17:54.288155 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79c3f2f1ddc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79c3f0577740>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79c3f055ffe0>]}
[0m16:17:54.289080 [debug] [MainThread]: Flushing usage events
[0m16:18:57.295268 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7904033e0ec0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7904033e3110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7904033e1040>]}


============================== 16:18:57.300246 | cfe836f1-71e5-4628-b97a-c85276506ff9 ==============================
[0m16:18:57.300246 [info ] [MainThread]: Running with dbt=1.7.9
[0m16:18:57.302076 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m16:18:57.608909 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cfe836f1-71e5-4628-b97a-c85276506ff9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x790407d6ef60>]}
[0m16:18:57.748651 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cfe836f1-71e5-4628-b97a-c85276506ff9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x790403513da0>]}
[0m16:18:57.751067 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m16:18:57.773414 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m16:18:58.039017 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:18:58.040869 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m16:18:58.264084 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m16:18:58.272108 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cfe836f1-71e5-4628-b97a-c85276506ff9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7904027a3aa0>]}
[0m16:18:58.345325 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cfe836f1-71e5-4628-b97a-c85276506ff9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7904023ad310>]}
[0m16:18:58.346565 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m16:18:58.347680 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cfe836f1-71e5-4628-b97a-c85276506ff9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x790401b5d430>]}
[0m16:18:58.351813 [info ] [MainThread]: 
[0m16:18:58.353552 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:18:58.356287 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m16:18:58.371625 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m16:18:58.372784 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m16:18:58.373859 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:18:58.386441 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m16:18:58.389343 [debug] [ThreadPool]: On list_nba: Close
[0m16:18:58.393214 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m16:18:58.402905 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m16:18:58.404080 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m16:18:58.405070 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:18:58.413586 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:18:58.414675 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m16:18:58.415668 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m16:18:58.421481 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m16:18:58.423821 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m16:18:58.425373 [debug] [ThreadPool]: On list_nba_gold: Close
[0m16:18:58.434657 [debug] [MainThread]: Using postgres connection "master"
[0m16:18:58.435908 [debug] [MainThread]: On master: BEGIN
[0m16:18:58.437060 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:18:58.444563 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:18:58.446224 [debug] [MainThread]: Using postgres connection "master"
[0m16:18:58.447286 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:18:58.466430 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:18:58.469449 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cfe836f1-71e5-4628-b97a-c85276506ff9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7904044f5af0>]}
[0m16:18:58.470714 [debug] [MainThread]: On master: ROLLBACK
[0m16:18:58.472224 [debug] [MainThread]: Using postgres connection "master"
[0m16:18:58.473400 [debug] [MainThread]: On master: BEGIN
[0m16:18:58.475299 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:18:58.476491 [debug] [MainThread]: On master: COMMIT
[0m16:18:58.477914 [debug] [MainThread]: Using postgres connection "master"
[0m16:18:58.479014 [debug] [MainThread]: On master: COMMIT
[0m16:18:58.480735 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m16:18:58.481800 [debug] [MainThread]: On master: Close
[0m16:18:58.483896 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m16:18:58.485378 [info ] [MainThread]: 
[0m16:18:58.490102 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m16:18:58.491308 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m16:18:58.493165 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m16:18:58.494313 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m16:18:58.506475 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m16:18:58.531631 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 16:18:58.495114 => 16:18:58.531074
[0m16:18:58.533128 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m16:18:58.590033 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m16:18:58.618371 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:18:58.619521 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m16:18:58.620649 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:18:58.628196 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:18:58.629397 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:18:58.630490 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m16:18:58.651173 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m16:18:58.659804 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:18:58.661157 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m16:18:58.662927 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:18:58.669589 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:18:58.670898 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m16:18:58.672780 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:18:58.702400 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m16:18:58.703822 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:18:58.704818 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m16:18:58.710776 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:18:58.721344 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m16:18:58.730395 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:18:58.731564 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m16:18:58.739538 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:18:58.743093 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 16:18:58.534642 => 16:18:58.742646
[0m16:18:58.744362 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m16:18:58.746379 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfe836f1-71e5-4628-b97a-c85276506ff9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7904027de360>]}
[0m16:18:58.747883 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.25s]
[0m16:18:58.750371 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m16:18:58.751879 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m16:18:58.753303 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m16:18:58.755112 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m16:18:58.756324 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m16:18:58.764763 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m16:18:58.794020 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 16:18:58.757538 => 16:18:58.793259
[0m16:18:58.795597 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m16:18:58.804488 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m16:18:58.830401 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:18:58.832012 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m16:18:58.834389 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:18:58.843855 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:18:58.845259 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:18:58.846664 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
)

select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc
  );
  
[0m16:18:58.868391 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m16:18:58.874328 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:18:58.875724 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m16:18:58.877974 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:18:58.883799 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:18:58.884927 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m16:18:58.886920 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:18:58.890934 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m16:18:58.891974 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:18:58.893344 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m16:18:58.898881 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:18:58.910653 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m16:18:58.913207 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:18:58.915022 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m16:18:58.922777 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:18:58.926008 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 16:18:58.796608 => 16:18:58.925536
[0m16:18:58.927361 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m16:18:58.929206 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfe836f1-71e5-4628-b97a-c85276506ff9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7904017ca750>]}
[0m16:18:58.930429 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.17s]
[0m16:18:58.932187 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m16:18:58.934117 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m16:18:58.936307 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m16:18:58.939251 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m16:18:58.940823 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m16:18:58.947123 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m16:18:58.978080 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 16:18:58.941851 => 16:18:58.977539
[0m16:18:58.979355 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m16:18:58.986173 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m16:18:59.009551 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:18:59.010539 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m16:18:59.011458 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:18:59.020288 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:18:59.021443 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:18:59.022555 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m16:18:59.056215 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m16:18:59.061151 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:18:59.062332 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m16:18:59.064035 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:18:59.069279 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:18:59.070454 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m16:18:59.072089 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:18:59.075239 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m16:18:59.076431 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:18:59.077421 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m16:18:59.083169 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:18:59.087417 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m16:18:59.089024 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:18:59.090012 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m16:18:59.096811 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:18:59.099841 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 16:18:58.980204 => 16:18:59.099214
[0m16:18:59.101029 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m16:18:59.102641 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfe836f1-71e5-4628-b97a-c85276506ff9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79040178f200>]}
[0m16:18:59.103962 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.16s]
[0m16:18:59.105351 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m16:18:59.107242 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m16:18:59.108251 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m16:18:59.109617 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m16:18:59.110510 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m16:18:59.121365 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m16:18:59.145083 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 16:18:59.111257 => 16:18:59.144662
[0m16:18:59.146713 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m16:18:59.154767 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m16:18:59.177735 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:18:59.178708 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m16:18:59.179662 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:18:59.187731 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:18:59.188885 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:18:59.190090 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        '3-point shooting' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Rebounding' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Ball Handling' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Points Differential' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plusminus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Points Differential' AS weakness_type,
        player,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_plusminus <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m16:18:59.297841 [debug] [Thread-1 (]: SQL status: SELECT 45 in 0.0 seconds
[0m16:18:59.303860 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:18:59.305100 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m16:18:59.306770 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:18:59.311614 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:18:59.312947 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m16:18:59.314869 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:18:59.320250 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m16:18:59.321437 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:18:59.322415 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m16:18:59.328750 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:18:59.333050 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m16:18:59.335740 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:18:59.336869 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m16:18:59.343806 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:18:59.346600 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 16:18:59.147713 => 16:18:59.346279
[0m16:18:59.347767 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m16:18:59.349892 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfe836f1-71e5-4628-b97a-c85276506ff9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79040178d100>]}
[0m16:18:59.351846 [info ] [Thread-1 (]: 4 of 4 OK created sql table model gold.players_recommendations ................. [[32mSELECT 45[0m in 0.24s]
[0m16:18:59.353414 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m16:18:59.357258 [debug] [MainThread]: Using postgres connection "master"
[0m16:18:59.358334 [debug] [MainThread]: On master: BEGIN
[0m16:18:59.359311 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:18:59.366966 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:18:59.368344 [debug] [MainThread]: On master: COMMIT
[0m16:18:59.369450 [debug] [MainThread]: Using postgres connection "master"
[0m16:18:59.370353 [debug] [MainThread]: On master: COMMIT
[0m16:18:59.371589 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m16:18:59.372668 [debug] [MainThread]: On master: Close
[0m16:18:59.374257 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:18:59.375382 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m16:18:59.376547 [info ] [MainThread]: 
[0m16:18:59.377680 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 1.02 seconds (1.02s).
[0m16:18:59.379639 [debug] [MainThread]: Command end result
[0m16:18:59.446073 [info ] [MainThread]: 
[0m16:18:59.447299 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:18:59.448377 [info ] [MainThread]: 
[0m16:18:59.450253 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m16:18:59.453037 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.2516954, "process_user_time": 3.981793, "process_kernel_time": 0.469153, "process_mem_max_rss": "201032", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m16:18:59.454274 [debug] [MainThread]: Command `dbt run` succeeded at 16:18:59.454055 after 2.25 seconds
[0m16:18:59.455249 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7904033e0ec0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7904033e1040>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7904017d9eb0>]}
[0m16:18:59.456208 [debug] [MainThread]: Flushing usage events
[0m16:43:05.575066 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7881f91e25a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7881f91e22a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7881f91e3980>]}


============================== 16:43:05.579256 | 95e5dbfc-8daa-4efa-97aa-a0d461df0834 ==============================
[0m16:43:05.579256 [info ] [MainThread]: Running with dbt=1.7.9
[0m16:43:05.580421 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:43:05.859349 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '95e5dbfc-8daa-4efa-97aa-a0d461df0834', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7881f9f23ec0>]}
[0m16:43:06.112110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '95e5dbfc-8daa-4efa-97aa-a0d461df0834', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7881f909ac90>]}
[0m16:43:06.113415 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m16:43:06.138040 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m16:43:06.428477 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:43:06.429916 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/summary_by_season.sql
[0m16:43:06.800334 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m16:43:06.807542 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '95e5dbfc-8daa-4efa-97aa-a0d461df0834', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7881f710e390>]}
[0m16:43:06.880381 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '95e5dbfc-8daa-4efa-97aa-a0d461df0834', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7881f81ad190>]}
[0m16:43:06.881540 [info ] [MainThread]: Found 4 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m16:43:06.882613 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '95e5dbfc-8daa-4efa-97aa-a0d461df0834', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7881f8549d30>]}
[0m16:43:06.886295 [info ] [MainThread]: 
[0m16:43:06.887854 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:43:06.890248 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m16:43:06.904588 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m16:43:06.905684 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m16:43:06.906605 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:43:06.915431 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m16:43:06.918646 [debug] [ThreadPool]: On list_nba: Close
[0m16:43:06.922374 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m16:43:06.931319 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m16:43:06.932310 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m16:43:06.933361 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:43:06.941271 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:43:06.942571 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m16:43:06.943470 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m16:43:06.948834 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m16:43:06.951735 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m16:43:06.953278 [debug] [ThreadPool]: On list_nba_gold: Close
[0m16:43:06.961372 [debug] [MainThread]: Using postgres connection "master"
[0m16:43:06.962847 [debug] [MainThread]: On master: BEGIN
[0m16:43:06.963936 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:43:06.972974 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:43:06.974110 [debug] [MainThread]: Using postgres connection "master"
[0m16:43:06.975149 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:43:06.993083 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m16:43:06.995130 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '95e5dbfc-8daa-4efa-97aa-a0d461df0834', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7881f710cec0>]}
[0m16:43:06.996181 [debug] [MainThread]: On master: ROLLBACK
[0m16:43:06.997378 [debug] [MainThread]: Using postgres connection "master"
[0m16:43:06.998436 [debug] [MainThread]: On master: BEGIN
[0m16:43:07.000196 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:43:07.001546 [debug] [MainThread]: On master: COMMIT
[0m16:43:07.003083 [debug] [MainThread]: Using postgres connection "master"
[0m16:43:07.004131 [debug] [MainThread]: On master: COMMIT
[0m16:43:07.005425 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m16:43:07.006547 [debug] [MainThread]: On master: Close
[0m16:43:07.008010 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m16:43:07.009056 [info ] [MainThread]: 
[0m16:43:07.013556 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m16:43:07.014906 [info ] [Thread-1 (]: 1 of 4 START sql table model gold.home_vs_away ................................. [RUN]
[0m16:43:07.017473 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m16:43:07.019317 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m16:43:07.029199 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m16:43:07.055520 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 16:43:07.020165 => 16:43:07.055129
[0m16:43:07.056543 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m16:43:07.107132 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m16:43:07.134732 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:43:07.136217 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m16:43:07.137194 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:43:07.143752 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:43:07.144828 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:43:07.145873 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m16:43:07.170493 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m16:43:07.179745 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:43:07.181434 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m16:43:07.183343 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:43:07.188443 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:43:07.189554 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m16:43:07.191616 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:43:07.216389 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m16:43:07.218074 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:43:07.219707 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m16:43:07.228631 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:43:07.238078 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m16:43:07.245537 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m16:43:07.246683 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m16:43:07.254734 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:43:07.257219 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 16:43:07.057337 => 16:43:07.256933
[0m16:43:07.258349 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m16:43:07.259894 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '95e5dbfc-8daa-4efa-97aa-a0d461df0834', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7881f7178b90>]}
[0m16:43:07.261115 [info ] [Thread-1 (]: 1 of 4 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.24s]
[0m16:43:07.262595 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m16:43:07.263739 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m16:43:07.264794 [info ] [Thread-1 (]: 2 of 4 START sql table model gold.summary_by_season ............................ [RUN]
[0m16:43:07.266206 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.summary_by_season)
[0m16:43:07.267656 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m16:43:07.273041 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m16:43:07.305044 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 16:43:07.269120 => 16:43:07.304569
[0m16:43:07.306131 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m16:43:07.313292 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m16:43:07.335801 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:43:07.336749 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m16:43:07.337547 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:43:07.344238 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:43:07.345360 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:43:07.346379 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m16:43:07.364728 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m16:43:07.370666 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:43:07.371627 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m16:43:07.373022 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:43:07.377343 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:43:07.378763 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m16:43:07.380346 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:43:07.383447 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m16:43:07.385020 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:43:07.386614 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m16:43:07.394055 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:43:07.398337 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m16:43:07.399928 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m16:43:07.400974 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m16:43:07.409960 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:43:07.412737 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 16:43:07.306857 => 16:43:07.412349
[0m16:43:07.413832 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m16:43:07.415616 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '95e5dbfc-8daa-4efa-97aa-a0d461df0834', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7881f99f0890>]}
[0m16:43:07.417058 [info ] [Thread-1 (]: 2 of 4 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m16:43:07.419179 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m16:43:07.420352 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m16:43:07.421394 [info ] [Thread-1 (]: 3 of 4 START sql table model gold.team_weaknesses .............................. [RUN]
[0m16:43:07.422813 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m16:43:07.423747 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m16:43:07.428705 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m16:43:07.452586 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 16:43:07.424484 => 16:43:07.451403
[0m16:43:07.454319 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m16:43:07.459830 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m16:43:07.485682 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:43:07.486942 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m16:43:07.487823 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:43:07.494895 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:43:07.496160 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:43:07.497241 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m16:43:07.533358 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m16:43:07.538894 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:43:07.539926 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m16:43:07.541450 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:43:07.546859 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:43:07.549174 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m16:43:07.551416 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:43:07.557052 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m16:43:07.558326 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:43:07.561050 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m16:43:07.566603 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:43:07.571659 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m16:43:07.573081 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m16:43:07.573994 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m16:43:07.580611 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:43:07.583519 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 16:43:07.455178 => 16:43:07.583136
[0m16:43:07.584881 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m16:43:07.586705 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '95e5dbfc-8daa-4efa-97aa-a0d461df0834', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7881f7514bc0>]}
[0m16:43:07.588122 [info ] [Thread-1 (]: 3 of 4 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.16s]
[0m16:43:07.589680 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m16:43:07.591764 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m16:43:07.593043 [info ] [Thread-1 (]: 4 of 4 START sql table model gold.players_recommendations ...................... [RUN]
[0m16:43:07.594480 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m16:43:07.595550 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m16:43:07.604337 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m16:43:07.630061 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 16:43:07.596325 => 16:43:07.629671
[0m16:43:07.631005 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m16:43:07.637942 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m16:43:07.662129 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:43:07.663108 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m16:43:07.664003 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:43:07.671044 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:43:07.672192 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:43:07.674071 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        '3-point shooting' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Rebounding' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Ball Handling' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Points Differential' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plusminus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Points Differential' AS weakness_type,
        player,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_plusminus <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m16:43:07.773440 [debug] [Thread-1 (]: SQL status: SELECT 45 in 0.0 seconds
[0m16:43:07.777985 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:43:07.778935 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m16:43:07.780342 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:43:07.787115 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:43:07.788134 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m16:43:07.789525 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:43:07.792266 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m16:43:07.793153 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:43:07.794013 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m16:43:07.799275 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:43:07.805864 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m16:43:07.807294 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m16:43:07.808178 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m16:43:07.814904 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:43:07.818211 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 16:43:07.631767 => 16:43:07.817511
[0m16:43:07.819533 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m16:43:07.821327 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '95e5dbfc-8daa-4efa-97aa-a0d461df0834', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7881f4568c80>]}
[0m16:43:07.824898 [info ] [Thread-1 (]: 4 of 4 OK created sql table model gold.players_recommendations ................. [[32mSELECT 45[0m in 0.23s]
[0m16:43:07.826318 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m16:43:07.829453 [debug] [MainThread]: Using postgres connection "master"
[0m16:43:07.830422 [debug] [MainThread]: On master: BEGIN
[0m16:43:07.831407 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:43:07.839809 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:43:07.841095 [debug] [MainThread]: On master: COMMIT
[0m16:43:07.842128 [debug] [MainThread]: Using postgres connection "master"
[0m16:43:07.843127 [debug] [MainThread]: On master: COMMIT
[0m16:43:07.844439 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m16:43:07.845442 [debug] [MainThread]: On master: Close
[0m16:43:07.847061 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:43:07.848866 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m16:43:07.850071 [info ] [MainThread]: 
[0m16:43:07.851253 [info ] [MainThread]: Finished running 4 table models in 0 hours 0 minutes and 0.96 seconds (0.96s).
[0m16:43:07.853898 [debug] [MainThread]: Command end result
[0m16:43:07.910615 [info ] [MainThread]: 
[0m16:43:07.911646 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:43:07.912537 [info ] [MainThread]: 
[0m16:43:07.913474 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m16:43:07.915091 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.4269466, "process_user_time": 3.683682, "process_kernel_time": 0.36036, "process_mem_max_rss": "201040", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m16:43:07.916231 [debug] [MainThread]: Command `dbt run` succeeded at 16:43:07.916051 after 2.43 seconds
[0m16:43:07.917458 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7881f9649a00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7881f85e6990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7881f457be00>]}
[0m16:43:07.919758 [debug] [MainThread]: Flushing usage events
[0m18:39:37.623072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f3a6b30fe0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f3a71ade20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f3a6b32f30>]}


============================== 18:39:37.628600 | a890f64c-6f7f-4226-bf80-86d062b6aaeb ==============================
[0m18:39:37.628600 [info ] [MainThread]: Running with dbt=1.7.9
[0m18:39:37.630130 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:39:37.962931 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a890f64c-6f7f-4226-bf80-86d062b6aaeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f3a6a27410>]}
[0m18:39:38.100434 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a890f64c-6f7f-4226-bf80-86d062b6aaeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f3a6b93500>]}
[0m18:39:38.102314 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m18:39:38.125922 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m18:39:38.356201 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m18:39:38.357394 [debug] [MainThread]: Partial parsing: added file: spurs_dbt://models/spurs_analysis/streaks_and_rivals.sql
[0m18:39:38.610347 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m18:39:38.616042 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a890f64c-6f7f-4226-bf80-86d062b6aaeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f3a591a990>]}
[0m18:39:38.681549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a890f64c-6f7f-4226-bf80-86d062b6aaeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f3a61b82c0>]}
[0m18:39:38.682632 [info ] [MainThread]: Found 5 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m18:39:38.683489 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a890f64c-6f7f-4226-bf80-86d062b6aaeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f3a6c4cec0>]}
[0m18:39:38.686263 [info ] [MainThread]: 
[0m18:39:38.687913 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m18:39:38.690698 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m18:39:38.725456 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m18:39:38.726745 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m18:39:38.728162 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:39:38.744219 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m18:39:38.750597 [debug] [ThreadPool]: On list_nba: Close
[0m18:39:38.758823 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m18:39:38.782917 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m18:39:38.784294 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m18:39:38.785921 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:39:38.794575 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m18:39:38.796099 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m18:39:38.797955 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m18:39:38.805590 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.0 seconds
[0m18:39:38.809376 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m18:39:38.811244 [debug] [ThreadPool]: On list_nba_gold: Close
[0m18:39:38.824065 [debug] [MainThread]: Using postgres connection "master"
[0m18:39:38.825340 [debug] [MainThread]: On master: BEGIN
[0m18:39:38.826418 [debug] [MainThread]: Opening a new connection, currently in state init
[0m18:39:38.841623 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:39:38.848688 [debug] [MainThread]: Using postgres connection "master"
[0m18:39:38.849935 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m18:39:38.875065 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m18:39:38.877401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a890f64c-6f7f-4226-bf80-86d062b6aaeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f3a598c9e0>]}
[0m18:39:38.878726 [debug] [MainThread]: On master: ROLLBACK
[0m18:39:38.880492 [debug] [MainThread]: Using postgres connection "master"
[0m18:39:38.881635 [debug] [MainThread]: On master: BEGIN
[0m18:39:38.883635 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:39:38.885063 [debug] [MainThread]: On master: COMMIT
[0m18:39:38.886078 [debug] [MainThread]: Using postgres connection "master"
[0m18:39:38.886994 [debug] [MainThread]: On master: COMMIT
[0m18:39:38.888085 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m18:39:38.889073 [debug] [MainThread]: On master: Close
[0m18:39:38.890511 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m18:39:38.891622 [info ] [MainThread]: 
[0m18:39:38.897052 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m18:39:38.899070 [info ] [Thread-1 (]: 1 of 5 START sql table model gold.home_vs_away ................................. [RUN]
[0m18:39:38.900927 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m18:39:38.901886 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m18:39:38.913012 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m18:39:38.936657 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 18:39:38.902588 => 18:39:38.936103
[0m18:39:38.937682 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m18:39:39.035289 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m18:39:39.074265 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m18:39:39.076504 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m18:39:39.077933 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m18:39:39.095420 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m18:39:39.097888 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m18:39:39.101489 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m18:39:39.134277 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m18:39:39.153376 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m18:39:39.155786 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m18:39:39.158144 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m18:39:39.167904 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m18:39:39.179090 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m18:39:39.181801 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m18:39:39.250451 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m18:39:39.252019 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m18:39:39.253168 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m18:39:39.260492 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m18:39:39.279684 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m18:39:39.290610 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m18:39:39.292069 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m18:39:39.300005 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m18:39:39.305360 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 18:39:38.938435 => 18:39:39.304602
[0m18:39:39.307092 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m18:39:39.309543 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a890f64c-6f7f-4226-bf80-86d062b6aaeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f3a5509970>]}
[0m18:39:39.311952 [info ] [Thread-1 (]: 1 of 5 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.41s]
[0m18:39:39.313756 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m18:39:39.315163 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m18:39:39.316543 [info ] [Thread-1 (]: 2 of 5 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m18:39:39.318005 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m18:39:39.318945 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m18:39:39.325617 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m18:39:39.339832 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 18:39:39.319798 => 18:39:39.339422
[0m18:39:39.340813 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m18:39:39.351440 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m18:39:39.372751 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m18:39:39.373792 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m18:39:39.374892 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m18:39:39.383047 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m18:39:39.384593 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m18:39:39.385736 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m18:39:39.406889 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m18:39:39.412833 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m18:39:39.413950 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m18:39:39.415767 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m18:39:39.419769 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m18:39:39.420904 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m18:39:39.421823 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m18:39:39.427136 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m18:39:39.433486 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m18:39:39.435238 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m18:39:39.436237 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m18:39:39.437640 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m18:39:39.439927 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 18:39:39.342103 => 18:39:39.439593
[0m18:39:39.441274 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m18:39:39.443258 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a890f64c-6f7f-4226-bf80-86d062b6aaeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f3a55cfcb0>]}
[0m18:39:39.444874 [info ] [Thread-1 (]: 2 of 5 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.13s]
[0m18:39:39.446900 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m18:39:39.447937 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m18:39:39.448981 [info ] [Thread-1 (]: 3 of 5 START sql table model gold.summary_by_season ............................ [RUN]
[0m18:39:39.450662 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m18:39:39.451826 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m18:39:39.456481 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m18:39:39.474429 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 18:39:39.452428 => 18:39:39.473916
[0m18:39:39.475669 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m18:39:39.482541 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m18:39:39.510601 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m18:39:39.511667 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m18:39:39.512679 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m18:39:39.521239 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m18:39:39.522549 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m18:39:39.523948 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m18:39:39.546948 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m18:39:39.552161 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m18:39:39.553298 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m18:39:39.555306 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m18:39:39.561465 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m18:39:39.566499 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m18:39:39.568700 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m18:39:39.572636 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m18:39:39.574162 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m18:39:39.575943 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m18:39:39.583528 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m18:39:39.588898 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m18:39:39.590256 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m18:39:39.591094 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m18:39:39.599524 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m18:39:39.602350 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 18:39:39.476642 => 18:39:39.601920
[0m18:39:39.603520 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m18:39:39.605267 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a890f64c-6f7f-4226-bf80-86d062b6aaeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f3a555c140>]}
[0m18:39:39.607039 [info ] [Thread-1 (]: 3 of 5 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.16s]
[0m18:39:39.609741 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m18:39:39.610953 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m18:39:39.612839 [info ] [Thread-1 (]: 4 of 5 START sql table model gold.team_weaknesses .............................. [RUN]
[0m18:39:39.614396 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m18:39:39.615314 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m18:39:39.620828 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m18:39:39.641342 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 18:39:39.615890 => 18:39:39.640894
[0m18:39:39.642132 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m18:39:39.649615 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m18:39:39.672453 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m18:39:39.673405 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m18:39:39.674425 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m18:39:39.680743 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m18:39:39.681618 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m18:39:39.682593 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m18:39:39.711978 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m18:39:39.717114 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m18:39:39.718055 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m18:39:39.719442 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m18:39:39.723564 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m18:39:39.724545 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m18:39:39.725773 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m18:39:39.730244 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m18:39:39.731227 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m18:39:39.732157 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m18:39:39.741094 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m18:39:39.749163 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m18:39:39.750472 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m18:39:39.751251 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m18:39:39.757576 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m18:39:39.760040 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 18:39:39.642857 => 18:39:39.759759
[0m18:39:39.760945 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m18:39:39.762790 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a890f64c-6f7f-4226-bf80-86d062b6aaeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f3a59ed610>]}
[0m18:39:39.764155 [info ] [Thread-1 (]: 4 of 5 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.15s]
[0m18:39:39.765756 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m18:39:39.767365 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m18:39:39.768287 [info ] [Thread-1 (]: 5 of 5 START sql table model gold.players_recommendations ...................... [RUN]
[0m18:39:39.769558 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.players_recommendations)
[0m18:39:39.770350 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m18:39:39.778025 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m18:39:39.798314 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 18:39:39.770932 => 18:39:39.797897
[0m18:39:39.799288 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m18:39:39.806037 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m18:39:39.826366 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m18:39:39.827628 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m18:39:39.829292 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m18:39:39.836357 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m18:39:39.837401 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m18:39:39.838486 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        '3-point shooting' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Rebounding' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Ball Handling' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Points Differential' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plusminus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Points Differential' AS weakness_type,
        player,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_plusminus <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m18:39:39.985773 [debug] [Thread-1 (]: SQL status: SELECT 45 in 0.0 seconds
[0m18:39:39.993933 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m18:39:39.998407 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m18:39:40.001255 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m18:39:40.014384 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m18:39:40.015386 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m18:39:40.016910 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m18:39:40.020595 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m18:39:40.021827 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m18:39:40.023052 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m18:39:40.031826 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m18:39:40.040034 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m18:39:40.069185 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m18:39:40.072080 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m18:39:40.079666 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m18:39:40.083525 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 18:39:39.799963 => 18:39:40.083000
[0m18:39:40.085875 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m18:39:40.088401 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a890f64c-6f7f-4226-bf80-86d062b6aaeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f3a5109310>]}
[0m18:39:40.090371 [info ] [Thread-1 (]: 5 of 5 OK created sql table model gold.players_recommendations ................. [[32mSELECT 45[0m in 0.32s]
[0m18:39:40.092181 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m18:39:40.095494 [debug] [MainThread]: Using postgres connection "master"
[0m18:39:40.097186 [debug] [MainThread]: On master: BEGIN
[0m18:39:40.098578 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m18:39:40.105171 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m18:39:40.106227 [debug] [MainThread]: On master: COMMIT
[0m18:39:40.107000 [debug] [MainThread]: Using postgres connection "master"
[0m18:39:40.107859 [debug] [MainThread]: On master: COMMIT
[0m18:39:40.108816 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m18:39:40.109698 [debug] [MainThread]: On master: Close
[0m18:39:40.110850 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:39:40.111802 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m18:39:40.112997 [info ] [MainThread]: 
[0m18:39:40.114012 [info ] [MainThread]: Finished running 5 table models in 0 hours 0 minutes and 1.43 seconds (1.43s).
[0m18:39:40.116900 [debug] [MainThread]: Command end result
[0m18:39:40.177413 [info ] [MainThread]: 
[0m18:39:40.178539 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:39:40.179793 [info ] [MainThread]: 
[0m18:39:40.180716 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=0 SKIP=0 TOTAL=5
[0m18:39:40.182392 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.688892, "process_user_time": 4.073785, "process_kernel_time": 0.468205, "process_mem_max_rss": "201040", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m18:39:40.183476 [debug] [MainThread]: Command `dbt run` succeeded at 18:39:40.183282 after 2.69 seconds
[0m18:39:40.184496 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f3a6c021b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f3a5502d50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f3a5502de0>]}
[0m18:39:40.185465 [debug] [MainThread]: Flushing usage events
[0m20:27:46.536604 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2fef163c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2fefe3ce0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2fef16300>]}


============================== 20:27:46.541812 | 2a08166b-cc1c-4fa5-8c53-1527cd00ebbd ==============================
[0m20:27:46.541812 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:27:46.543011 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:27:46.869093 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2a08166b-cc1c-4fa5-8c53-1527cd00ebbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2fef17560>]}
[0m20:27:46.976466 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2a08166b-cc1c-4fa5-8c53-1527cd00ebbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2ff5310d0>]}
[0m20:27:46.977904 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:27:47.003631 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:27:47.271102 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m20:27:47.272386 [debug] [MainThread]: Partial parsing: added file: spurs_dbt://models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:27:47.452717 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:27:47.459762 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2a08166b-cc1c-4fa5-8c53-1527cd00ebbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2fe541610>]}
[0m20:27:47.522381 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2a08166b-cc1c-4fa5-8c53-1527cd00ebbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2fe5b4170>]}
[0m20:27:47.523362 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:27:47.524453 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2a08166b-cc1c-4fa5-8c53-1527cd00ebbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2ff0604a0>]}
[0m20:27:47.527273 [info ] [MainThread]: 
[0m20:27:47.529016 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:27:47.532117 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:27:47.546225 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:27:47.547263 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:27:47.548230 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:27:47.562651 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:27:47.564901 [debug] [ThreadPool]: On list_nba: Close
[0m20:27:47.569161 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:27:47.577254 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:27:47.578831 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:27:47.580157 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:27:47.587380 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:27:47.588613 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:27:47.589659 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:27:47.596046 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m20:27:47.598358 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:27:47.599720 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:27:47.607060 [debug] [MainThread]: Using postgres connection "master"
[0m20:27:47.608199 [debug] [MainThread]: On master: BEGIN
[0m20:27:47.610030 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:27:47.617341 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:27:47.618432 [debug] [MainThread]: Using postgres connection "master"
[0m20:27:47.619533 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:27:47.641822 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:27:47.643890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2a08166b-cc1c-4fa5-8c53-1527cd00ebbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2ff041a30>]}
[0m20:27:47.645168 [debug] [MainThread]: On master: ROLLBACK
[0m20:27:47.646722 [debug] [MainThread]: Using postgres connection "master"
[0m20:27:47.647700 [debug] [MainThread]: On master: BEGIN
[0m20:27:47.649592 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:27:47.650717 [debug] [MainThread]: On master: COMMIT
[0m20:27:47.651802 [debug] [MainThread]: Using postgres connection "master"
[0m20:27:47.653250 [debug] [MainThread]: On master: COMMIT
[0m20:27:47.655405 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:27:47.657166 [debug] [MainThread]: On master: Close
[0m20:27:47.659061 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:27:47.660248 [info ] [MainThread]: 
[0m20:27:47.665903 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:27:47.667123 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:27:47.668621 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:27:47.669887 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:27:47.679934 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:27:47.705788 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:27:47.670854 => 20:27:47.705402
[0m20:27:47.706832 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:27:47.751214 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:27:47.777687 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:27:47.778707 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:27:47.779750 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:27:47.787350 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:27:47.788443 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:27:47.789337 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:27:47.831837 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:27:47.839621 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:27:47.840803 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m20:27:47.842646 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:27:47.847131 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:27:47.848356 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m20:27:47.849869 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:27:47.872936 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:27:47.873980 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:27:47.874767 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:27:47.880518 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:27:47.888207 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m20:27:47.895300 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:27:47.896175 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m20:27:47.905825 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:27:47.908261 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:27:47.707612 => 20:27:47.907861
[0m20:27:47.909309 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:27:47.910718 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2a08166b-cc1c-4fa5-8c53-1527cd00ebbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2fddf4140>]}
[0m20:27:47.911828 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.24s]
[0m20:27:47.913304 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:27:47.914308 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m20:27:47.915342 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m20:27:47.916638 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m20:27:47.917463 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m20:27:47.921745 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m20:27:47.948564 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 20:27:47.918088 => 20:27:47.948004
[0m20:27:47.949673 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m20:27:47.955230 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m20:27:47.979743 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:27:47.980864 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m20:27:47.981781 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:27:47.989345 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:27:47.990457 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:27:47.991510 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m20:27:48.011083 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m20:27:48.015540 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:27:48.016681 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m20:27:48.018296 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:27:48.029427 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:27:48.031447 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m20:27:48.034321 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:27:48.040818 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m20:27:48.042911 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:27:48.044689 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m20:27:48.052097 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:27:48.056102 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m20:27:48.057660 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:27:48.058642 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m20:27:48.066798 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:27:48.069397 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 20:27:47.950438 => 20:27:48.069121
[0m20:27:48.070419 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m20:27:48.072094 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2a08166b-cc1c-4fa5-8c53-1527cd00ebbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2fd9c98e0>]}
[0m20:27:48.073418 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.16s]
[0m20:27:48.074749 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m20:27:48.075870 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:27:48.077100 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:27:48.078555 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m20:27:48.079450 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:27:48.084483 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:27:48.116222 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:27:48.080231 => 20:27:48.115418
[0m20:27:48.118100 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:27:48.126014 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:27:48.153875 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:27:48.155399 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:27:48.156778 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:27:48.165749 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:27:48.166990 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:27:48.168302 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m20:27:48.188494 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m20:27:48.194636 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:27:48.196581 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:27:48.198754 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:27:48.203955 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:27:48.205529 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:27:48.207617 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:27:48.211568 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:27:48.212840 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:27:48.214155 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:27:48.220232 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:27:48.225543 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:27:48.227364 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:27:48.228630 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:27:48.236787 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:27:48.239889 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:27:48.119226 => 20:27:48.239447
[0m20:27:48.241577 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:27:48.243681 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2a08166b-cc1c-4fa5-8c53-1527cd00ebbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2fd9c8200>]}
[0m20:27:48.245421 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.17s]
[0m20:27:48.248253 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:27:48.250473 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:27:48.252508 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:27:48.254478 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:27:48.255683 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:27:48.261801 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:27:48.289991 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:27:48.256551 => 20:27:48.289542
[0m20:27:48.291116 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:27:48.296493 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:27:48.315287 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:27:48.316175 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:27:48.316982 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:27:48.322940 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:27:48.323969 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:27:48.325123 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m20:27:48.360389 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m20:27:48.365086 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:27:48.366283 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m20:27:48.368225 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:27:48.372460 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:27:48.373544 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m20:27:48.375005 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:27:48.377888 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:27:48.378845 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:27:48.379843 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:27:48.386071 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:27:48.390240 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m20:27:48.391824 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:27:48.392979 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m20:27:48.400334 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:27:48.402796 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:27:48.291871 => 20:27:48.402526
[0m20:27:48.403811 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:27:48.405538 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2a08166b-cc1c-4fa5-8c53-1527cd00ebbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2fd9cff20>]}
[0m20:27:48.406733 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.15s]
[0m20:27:48.408113 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:27:48.409282 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:27:48.410356 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m20:27:48.411803 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m20:27:48.412838 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:27:48.419732 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:27:48.436871 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 20:27:48.413651 => 20:27:48.436494
[0m20:27:48.437741 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:27:48.442739 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:27:48.459600 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:27:48.460789 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m20:27:48.461979 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:27:48.469659 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:27:48.470679 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:27:48.471633 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct) AS avg_fg_pct,
        AVG(fg3_pct) AS avg_fg3_pct,
        AVG(tov) AS avg_turnovers,
        AVG(reb) AS avg_rebounds,
        AVG(blk) AS avg_blocks,
        AVG(stl) AS avg_steals,
        AVG(plus_minus) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct) AS avg_league_fg_pct,
        AVG(fg3_pct) AS avg_league_fg3_pct,
        AVG(tov) AS avg_league_turnovers,
        AVG(reb) AS avg_league_rebounds,
        AVG(blk) AS avg_league_blocks,
        AVG(stl) AS avg_league_steals,
        AVG(plus_minus) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,,
            team_name,
            AVG(fg_pct) AS avg_fg_pct,
            AVG(fg3_pct) AS avg_fg3_pct,
            AVG(tov) AS avg_turnovers,
            AVG(reb) AS avg_reb,
            AVG(blk) AS avg_blk,
            AVG(stl) AS avg_stl,
            AVG(plus_minus) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season_year, team_name
    ) AS all_teams
    GROUP BY season
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Plus/Minus' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo
FROM unpivoted_weaknesses
ORDER BY season, weakness_type
  );
  
[0m20:27:48.474057 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near ","
LINE 58:             else season end as season2,,
                                                ^

[0m20:27:48.475401 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: ROLLBACK
[0m20:27:48.477113 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 20:27:48.438369 => 20:27:48.476800
[0m20:27:48.478095 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m20:27:48.485987 [debug] [Thread-1 (]: Database Error in model team_weaknesses_unpivoted (models/spurs_analysis/team_weaknesses_unpivoted.sql)
  syntax error at or near ","
  LINE 58:             else season end as season2,,
                                                  ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:27:48.487121 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2a08166b-cc1c-4fa5-8c53-1527cd00ebbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2fd9f0fb0>]}
[0m20:27:48.488588 [error] [Thread-1 (]: 5 of 6 ERROR creating sql table model gold.team_weaknesses_unpivoted ........... [[31mERROR[0m in 0.08s]
[0m20:27:48.490113 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:27:48.491153 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m20:27:48.492977 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m20:27:48.494340 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m20:27:48.495322 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m20:27:48.502759 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m20:27:48.527082 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 20:27:48.496122 => 20:27:48.526702
[0m20:27:48.528090 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m20:27:48.533383 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m20:27:48.558331 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:27:48.559343 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m20:27:48.560316 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:27:48.567188 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:27:48.568345 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:27:48.569771 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        '3-point shooting' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Rebounding' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Ball Handling' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Points Differential' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plusminus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Points Differential' AS weakness_type,
        player,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_plusminus <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m20:27:48.804125 [debug] [Thread-1 (]: SQL status: SELECT 45 in 0.0 seconds
[0m20:27:48.809572 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:27:48.810672 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m20:27:48.812427 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:27:48.817224 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:27:48.818319 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m20:27:48.819745 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:27:48.823295 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m20:27:48.824264 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:27:48.825202 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m20:27:48.830425 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:27:48.834259 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m20:27:48.835748 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:27:48.836695 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m20:27:48.843704 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:27:48.846216 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 20:27:48.528846 => 20:27:48.845952
[0m20:27:48.847241 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m20:27:48.848958 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2a08166b-cc1c-4fa5-8c53-1527cd00ebbd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2fe540890>]}
[0m20:27:48.850224 [info ] [Thread-1 (]: 6 of 6 OK created sql table model gold.players_recommendations ................. [[32mSELECT 45[0m in 0.35s]
[0m20:27:48.851587 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m20:27:48.854638 [debug] [MainThread]: Using postgres connection "master"
[0m20:27:48.855590 [debug] [MainThread]: On master: BEGIN
[0m20:27:48.856583 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:27:48.863318 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:27:48.864755 [debug] [MainThread]: On master: COMMIT
[0m20:27:48.865781 [debug] [MainThread]: Using postgres connection "master"
[0m20:27:48.866793 [debug] [MainThread]: On master: COMMIT
[0m20:27:48.868242 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:27:48.869242 [debug] [MainThread]: On master: Close
[0m20:27:48.870698 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:27:48.871650 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m20:27:48.872967 [info ] [MainThread]: 
[0m20:27:48.873961 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.34 seconds (1.34s).
[0m20:27:48.876020 [debug] [MainThread]: Command end result
[0m20:27:48.931587 [info ] [MainThread]: 
[0m20:27:48.932858 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:27:48.933759 [info ] [MainThread]: 
[0m20:27:48.934660 [error] [MainThread]:   Database Error in model team_weaknesses_unpivoted (models/spurs_analysis/team_weaknesses_unpivoted.sql)
  syntax error at or near ","
  LINE 58:             else season end as season2,,
                                                  ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:27:48.935571 [info ] [MainThread]: 
[0m20:27:48.936457 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m20:27:48.938482 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.479572, "process_user_time": 3.287469, "process_kernel_time": 0.977893, "process_mem_max_rss": "201040", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:27:48.939516 [debug] [MainThread]: Command `dbt run` failed at 20:27:48.939339 after 2.48 seconds
[0m20:27:48.940446 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2ff325be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2fef161e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70d2fd9c7c50>]}
[0m20:27:48.941349 [debug] [MainThread]: Flushing usage events
[0m20:29:33.959538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7048277ccda0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7048277cd700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7048277cdfa0>]}


============================== 20:29:33.963933 | 5088bba7-9dae-49e6-a581-8633f89e4b32 ==============================
[0m20:29:33.963933 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:29:33.965183 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:29:34.222400 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5088bba7-9dae-49e6-a581-8633f89e4b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7048277fa270>]}
[0m20:29:34.324594 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5088bba7-9dae-49e6-a581-8633f89e4b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x704827631850>]}
[0m20:29:34.325951 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:29:34.351207 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:29:34.594693 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:29:34.596052 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:29:34.787552 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:29:34.794082 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5088bba7-9dae-49e6-a581-8633f89e4b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x704825ff7680>]}
[0m20:29:34.860479 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5088bba7-9dae-49e6-a581-8633f89e4b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7048267a9190>]}
[0m20:29:34.861586 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:29:34.862573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5088bba7-9dae-49e6-a581-8633f89e4b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7048267a98e0>]}
[0m20:29:34.865444 [info ] [MainThread]: 
[0m20:29:34.867089 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:29:34.869511 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:29:34.881930 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:29:34.883043 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:29:34.883875 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:29:34.892983 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:29:34.895194 [debug] [ThreadPool]: On list_nba: Close
[0m20:29:34.898619 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:29:34.906234 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:29:34.907321 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:29:34.908206 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:29:34.915935 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:29:34.916832 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:29:34.917600 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:29:34.922973 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m20:29:34.925113 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:29:34.926326 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:29:34.933511 [debug] [MainThread]: Using postgres connection "master"
[0m20:29:34.934684 [debug] [MainThread]: On master: BEGIN
[0m20:29:34.935831 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:29:34.942783 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:29:34.944006 [debug] [MainThread]: Using postgres connection "master"
[0m20:29:34.945048 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:29:34.963040 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:29:34.965194 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5088bba7-9dae-49e6-a581-8633f89e4b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7048267f9e20>]}
[0m20:29:34.966473 [debug] [MainThread]: On master: ROLLBACK
[0m20:29:34.968005 [debug] [MainThread]: Using postgres connection "master"
[0m20:29:34.968974 [debug] [MainThread]: On master: BEGIN
[0m20:29:34.970773 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:29:34.971990 [debug] [MainThread]: On master: COMMIT
[0m20:29:34.972862 [debug] [MainThread]: Using postgres connection "master"
[0m20:29:34.973535 [debug] [MainThread]: On master: COMMIT
[0m20:29:34.974649 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:29:34.975687 [debug] [MainThread]: On master: Close
[0m20:29:34.977078 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:29:34.978031 [info ] [MainThread]: 
[0m20:29:34.983396 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:29:34.984911 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:29:34.986267 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:29:34.987274 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:29:34.997244 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:29:35.023347 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:29:34.988112 => 20:29:35.022948
[0m20:29:35.024346 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:29:35.068797 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:29:35.095836 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:29:35.096902 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:29:35.097905 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:29:35.104466 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:29:35.105502 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:29:35.106475 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:29:35.132007 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:29:35.139935 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:29:35.140867 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m20:29:35.142607 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:29:35.146757 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:29:35.147939 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m20:29:35.149280 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:29:35.173410 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:29:35.174426 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:29:35.175340 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:29:35.181580 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:29:35.189255 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m20:29:35.196483 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:29:35.197313 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m20:29:35.204891 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:29:35.207644 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:29:35.025130 => 20:29:35.207324
[0m20:29:35.208658 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:29:35.210197 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5088bba7-9dae-49e6-a581-8633f89e4b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70482673e8a0>]}
[0m20:29:35.211521 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.22s]
[0m20:29:35.212859 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:29:35.214053 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m20:29:35.215248 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m20:29:35.216548 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m20:29:35.217547 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m20:29:35.222175 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m20:29:35.247348 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 20:29:35.218364 => 20:29:35.246957
[0m20:29:35.248413 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m20:29:35.253858 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m20:29:35.276160 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:29:35.277209 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m20:29:35.278196 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:29:35.286179 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:29:35.287211 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:29:35.288338 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m20:29:35.307644 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m20:29:35.312036 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:29:35.313118 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m20:29:35.314619 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:29:35.318851 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:29:35.319986 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m20:29:35.321380 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:29:35.324316 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m20:29:35.325371 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:29:35.326318 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m20:29:35.332524 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:29:35.337533 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m20:29:35.339059 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:29:35.340030 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m20:29:35.350713 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:29:35.353263 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 20:29:35.249189 => 20:29:35.352958
[0m20:29:35.354202 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m20:29:35.355655 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5088bba7-9dae-49e6-a581-8633f89e4b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x704825bc6840>]}
[0m20:29:35.356754 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.14s]
[0m20:29:35.357998 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m20:29:35.359098 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:29:35.360122 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:29:35.361361 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m20:29:35.362276 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:29:35.366932 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:29:35.390093 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:29:35.363010 => 20:29:35.389695
[0m20:29:35.391213 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:29:35.396461 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:29:35.419761 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:29:35.420854 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:29:35.421707 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:29:35.428423 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:29:35.429475 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:29:35.430499 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m20:29:35.451848 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m20:29:35.456699 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:29:35.457797 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:29:35.459474 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:29:35.464544 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:29:35.465885 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:29:35.467904 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:29:35.471073 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:29:35.472104 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:29:35.473095 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:29:35.479993 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:29:35.484431 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:29:35.486037 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:29:35.487105 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:29:35.494116 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:29:35.496501 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:29:35.391993 => 20:29:35.496241
[0m20:29:35.497568 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:29:35.499210 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5088bba7-9dae-49e6-a581-8633f89e4b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x704825bc4f80>]}
[0m20:29:35.502113 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.14s]
[0m20:29:35.503447 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:29:35.504632 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:29:35.505708 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:29:35.507220 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:29:35.508171 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:29:35.513196 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:29:35.538636 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:29:35.508941 => 20:29:35.538163
[0m20:29:35.539823 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:29:35.546070 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:29:35.576212 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:29:35.577274 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:29:35.578252 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:29:35.587148 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:29:35.588453 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:29:35.589893 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m20:29:35.624827 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m20:29:35.630283 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:29:35.631767 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m20:29:35.633988 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:29:35.638795 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:29:35.640160 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m20:29:35.641732 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:29:35.644848 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:29:35.646029 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:29:35.647470 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:29:35.655629 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:29:35.660566 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m20:29:35.662460 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:29:35.663876 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m20:29:35.670723 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:29:35.673235 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:29:35.540621 => 20:29:35.672969
[0m20:29:35.674224 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:29:35.675933 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5088bba7-9dae-49e6-a581-8633f89e4b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x704825bc26f0>]}
[0m20:29:35.678752 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.17s]
[0m20:29:35.680363 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:29:35.681670 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:29:35.682933 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m20:29:35.684427 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m20:29:35.685503 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:29:35.691286 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:29:35.722487 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 20:29:35.686381 => 20:29:35.722082
[0m20:29:35.723603 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:29:35.731696 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:29:35.759163 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:29:35.760214 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m20:29:35.761154 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:29:35.767971 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:29:35.769198 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:29:35.770366 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct) AS avg_fg_pct,
        AVG(fg3_pct) AS avg_fg3_pct,
        AVG(tov) AS avg_turnovers,
        AVG(reb) AS avg_rebounds,
        AVG(blk) AS avg_blocks,
        AVG(stl) AS avg_steals,
        AVG(plus_minus) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct) AS avg_league_fg_pct,
        AVG(fg3_pct) AS avg_league_fg3_pct,
        AVG(tov) AS avg_league_turnovers,
        AVG(reb) AS avg_league_rebounds,
        AVG(blk) AS avg_league_blocks,
        AVG(stl) AS avg_league_steals,
        AVG(plus_minus) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct) AS avg_fg_pct,
            AVG(fg3_pct) AS avg_fg3_pct,
            AVG(tov) AS avg_turnovers,
            AVG(reb) AS avg_reb,
            AVG(blk) AS avg_blk,
            AVG(stl) AS avg_stl,
            AVG(plus_minus) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season_year, team_name
    ) AS all_teams
    GROUP BY season
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Plus/Minus' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo
FROM unpivoted_weaknesses
ORDER BY season, weakness_type
  );
  
[0m20:29:35.774042 [debug] [Thread-1 (]: Postgres adapter: Postgres error: function avg(character varying) does not exist
LINE 18:         AVG(fg_pct) AS avg_fg_pct,
                 ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.

[0m20:29:35.775322 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: ROLLBACK
[0m20:29:35.777079 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 20:29:35.724393 => 20:29:35.776668
[0m20:29:35.778149 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m20:29:35.784370 [debug] [Thread-1 (]: Database Error in model team_weaknesses_unpivoted (models/spurs_analysis/team_weaknesses_unpivoted.sql)
  function avg(character varying) does not exist
  LINE 18:         AVG(fg_pct) AS avg_fg_pct,
                   ^
  HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:29:35.785779 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5088bba7-9dae-49e6-a581-8633f89e4b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x704825710da0>]}
[0m20:29:35.787233 [error] [Thread-1 (]: 5 of 6 ERROR creating sql table model gold.team_weaknesses_unpivoted ........... [[31mERROR[0m in 0.10s]
[0m20:29:35.788940 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:29:35.790158 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m20:29:35.792201 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m20:29:35.793873 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m20:29:35.795158 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m20:29:35.804176 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m20:29:35.833252 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 20:29:35.796117 => 20:29:35.832874
[0m20:29:35.834263 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m20:29:35.839877 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m20:29:35.863076 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:29:35.864081 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m20:29:35.864980 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:29:35.871429 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:29:35.872605 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:29:35.873895 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        '3-point shooting' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Rebounding' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Ball Handling' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Points Differential' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plusminus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Points Differential' AS weakness_type,
        player,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_plusminus <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m20:29:36.036348 [debug] [Thread-1 (]: SQL status: SELECT 45 in 0.0 seconds
[0m20:29:36.043958 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:29:36.046239 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m20:29:36.049156 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:29:36.057575 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:29:36.059292 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m20:29:36.062192 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:29:36.067701 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m20:29:36.069360 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:29:36.070761 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m20:29:36.078973 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:29:36.086333 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m20:29:36.089355 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:29:36.091086 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m20:29:36.101418 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:29:36.105608 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 20:29:35.835213 => 20:29:36.105109
[0m20:29:36.107117 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m20:29:36.109693 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5088bba7-9dae-49e6-a581-8633f89e4b32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7048257089e0>]}
[0m20:29:36.111969 [info ] [Thread-1 (]: 6 of 6 OK created sql table model gold.players_recommendations ................. [[32mSELECT 45[0m in 0.32s]
[0m20:29:36.114284 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m20:29:36.118990 [debug] [MainThread]: Using postgres connection "master"
[0m20:29:36.120537 [debug] [MainThread]: On master: BEGIN
[0m20:29:36.122041 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:29:36.131256 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:29:36.132858 [debug] [MainThread]: On master: COMMIT
[0m20:29:36.134429 [debug] [MainThread]: Using postgres connection "master"
[0m20:29:36.136128 [debug] [MainThread]: On master: COMMIT
[0m20:29:36.138032 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:29:36.139442 [debug] [MainThread]: On master: Close
[0m20:29:36.141599 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:29:36.142933 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m20:29:36.144776 [info ] [MainThread]: 
[0m20:29:36.146078 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.28 seconds (1.28s).
[0m20:29:36.149801 [debug] [MainThread]: Command end result
[0m20:29:36.222959 [info ] [MainThread]: 
[0m20:29:36.224351 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:29:36.225424 [info ] [MainThread]: 
[0m20:29:36.226925 [error] [MainThread]:   Database Error in model team_weaknesses_unpivoted (models/spurs_analysis/team_weaknesses_unpivoted.sql)
  function avg(character varying) does not exist
  LINE 18:         AVG(fg_pct) AS avg_fg_pct,
                   ^
  HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:29:36.228430 [info ] [MainThread]: 
[0m20:29:36.229811 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m20:29:36.232393 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.3542879, "process_user_time": 3.35907, "process_kernel_time": 0.436919, "process_mem_max_rss": "201020", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:29:36.233946 [debug] [MainThread]: Command `dbt run` failed at 20:29:36.233581 after 2.36 seconds
[0m20:29:36.235455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x704827e7aed0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7048277ccda0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x704825f7c890>]}
[0m20:29:36.236848 [debug] [MainThread]: Flushing usage events
[0m20:31:27.187725 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29c9d0e30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29cef26c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29c9d1040>]}


============================== 20:31:27.193059 | fdd1543a-8bfb-46d0-a8b9-7ab737b5aee6 ==============================
[0m20:31:27.193059 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:31:27.194540 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:31:27.546557 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fdd1543a-8bfb-46d0-a8b9-7ab737b5aee6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29c9fdc70>]}
[0m20:31:27.692034 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fdd1543a-8bfb-46d0-a8b9-7ab737b5aee6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29c476f60>]}
[0m20:31:27.693788 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:31:27.719556 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:31:27.956154 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:31:27.957367 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:31:28.132566 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:31:28.139129 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fdd1543a-8bfb-46d0-a8b9-7ab737b5aee6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29b5f3350>]}
[0m20:31:28.208670 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fdd1543a-8bfb-46d0-a8b9-7ab737b5aee6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29bd6a120>]}
[0m20:31:28.209769 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:31:28.210752 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fdd1543a-8bfb-46d0-a8b9-7ab737b5aee6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29c1621b0>]}
[0m20:31:28.213666 [info ] [MainThread]: 
[0m20:31:28.215141 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:31:28.217786 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:31:28.230766 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:31:28.231803 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:31:28.232786 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:31:28.242601 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:31:28.244980 [debug] [ThreadPool]: On list_nba: Close
[0m20:31:28.248559 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:31:28.256326 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:31:28.257326 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:31:28.258212 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:31:28.265996 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:31:28.267135 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:31:28.267989 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:31:28.273304 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m20:31:28.275631 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:31:28.276799 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:31:28.284351 [debug] [MainThread]: Using postgres connection "master"
[0m20:31:28.285336 [debug] [MainThread]: On master: BEGIN
[0m20:31:28.286234 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:31:28.293347 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:31:28.294417 [debug] [MainThread]: Using postgres connection "master"
[0m20:31:28.295431 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:31:28.312613 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:31:28.314825 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fdd1543a-8bfb-46d0-a8b9-7ab737b5aee6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29ce09b20>]}
[0m20:31:28.315838 [debug] [MainThread]: On master: ROLLBACK
[0m20:31:28.317232 [debug] [MainThread]: Using postgres connection "master"
[0m20:31:28.318129 [debug] [MainThread]: On master: BEGIN
[0m20:31:28.319770 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:31:28.320938 [debug] [MainThread]: On master: COMMIT
[0m20:31:28.321829 [debug] [MainThread]: Using postgres connection "master"
[0m20:31:28.322695 [debug] [MainThread]: On master: COMMIT
[0m20:31:28.323871 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:31:28.324899 [debug] [MainThread]: On master: Close
[0m20:31:28.326349 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:31:28.327393 [info ] [MainThread]: 
[0m20:31:28.332146 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:31:28.333349 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:31:28.334759 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:31:28.335712 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:31:28.346107 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:31:28.371428 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:31:28.336512 => 20:31:28.371046
[0m20:31:28.372520 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:31:28.418965 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:31:28.444463 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:31:28.445655 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:31:28.446586 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:31:28.453805 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:31:28.454980 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:31:28.455915 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:31:28.480904 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:31:28.489125 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:31:28.490189 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m20:31:28.491662 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:31:28.495989 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:31:28.497180 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m20:31:28.498652 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:31:28.526523 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:31:28.527916 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:31:28.529030 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:31:28.534844 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:31:28.543321 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m20:31:28.551181 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:31:28.552197 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m20:31:28.559435 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:31:28.562288 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:31:28.373319 => 20:31:28.561996
[0m20:31:28.563293 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:31:28.564880 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fdd1543a-8bfb-46d0-a8b9-7ab737b5aee6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29b5c86e0>]}
[0m20:31:28.566153 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.23s]
[0m20:31:28.567569 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:31:28.568868 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m20:31:28.569970 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m20:31:28.571442 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m20:31:28.572514 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m20:31:28.577427 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m20:31:28.599884 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 20:31:28.573383 => 20:31:28.599461
[0m20:31:28.601087 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m20:31:28.607993 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m20:31:28.632252 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:31:28.633236 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m20:31:28.634038 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:31:28.642123 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:31:28.643249 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:31:28.644379 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m20:31:28.664684 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m20:31:28.669084 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:31:28.669999 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m20:31:28.671348 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:31:28.675829 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:31:28.676751 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m20:31:28.678066 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:31:28.680861 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m20:31:28.681723 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:31:28.682598 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m20:31:28.688198 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:31:28.694468 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m20:31:28.696185 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:31:28.697183 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m20:31:28.703875 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:31:28.706841 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 20:31:28.601957 => 20:31:28.706459
[0m20:31:28.707830 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m20:31:28.709546 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fdd1543a-8bfb-46d0-a8b9-7ab737b5aee6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29b17b0b0>]}
[0m20:31:28.710835 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.14s]
[0m20:31:28.712270 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m20:31:28.713434 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:31:28.714515 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:31:28.715962 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m20:31:28.717052 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:31:28.721814 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:31:28.748173 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:31:28.717760 => 20:31:28.747697
[0m20:31:28.749232 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:31:28.754615 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:31:28.778093 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:31:28.778978 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:31:28.779858 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:31:28.787313 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:31:28.788506 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:31:28.789505 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m20:31:28.810092 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m20:31:28.814606 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:31:28.815764 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:31:28.817450 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:31:28.821635 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:31:28.822709 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:31:28.824282 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:31:28.827206 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:31:28.828400 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:31:28.829355 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:31:28.835218 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:31:28.839017 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:31:28.840834 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:31:28.841982 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:31:28.848532 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:31:28.851713 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:31:28.749978 => 20:31:28.851297
[0m20:31:28.853150 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:31:28.855229 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fdd1543a-8bfb-46d0-a8b9-7ab737b5aee6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29b17a720>]}
[0m20:31:28.856613 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.14s]
[0m20:31:28.858736 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:31:28.860185 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:31:28.861550 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:31:28.863286 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:31:28.864394 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:31:28.869580 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:31:28.895510 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:31:28.865194 => 20:31:28.895131
[0m20:31:28.896386 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:31:28.901650 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:31:28.923730 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:31:28.924729 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:31:28.925848 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:31:28.932534 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:31:28.933550 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:31:28.934579 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m20:31:28.966623 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m20:31:28.971165 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:31:28.972301 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m20:31:28.973895 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:31:28.978266 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:31:28.979326 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m20:31:28.980773 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:31:28.983731 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:31:28.984842 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:31:28.985776 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:31:28.992462 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:31:28.996400 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m20:31:28.997799 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:31:28.998717 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m20:31:29.006097 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:31:29.008538 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:31:28.896985 => 20:31:29.008260
[0m20:31:29.009530 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:31:29.011095 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fdd1543a-8bfb-46d0-a8b9-7ab737b5aee6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29b19a360>]}
[0m20:31:29.012350 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.15s]
[0m20:31:29.013846 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:31:29.014991 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:31:29.016295 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m20:31:29.017799 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m20:31:29.018778 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:31:29.024212 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:31:29.047268 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 20:31:29.019560 => 20:31:29.046893
[0m20:31:29.048398 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:31:29.055940 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:31:29.081257 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:31:29.082292 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m20:31:29.083308 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:31:29.090147 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:31:29.091266 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:31:29.092497 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct) AS avg_fg_pct,
        AVG(fg3_pct) AS avg_fg3_pct,
        AVG(tov) AS avg_turnovers,
        AVG(reb) AS avg_rebounds,
        AVG(blk) AS avg_blocks,
        AVG(stl) AS avg_steals,
        AVG(plus_minus) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct) AS avg_league_fg_pct,
        AVG(fg3_pct) AS avg_league_fg3_pct,
        AVG(tov) AS avg_league_turnovers,
        AVG(reb) AS avg_league_rebounds,
        AVG(blk) AS avg_league_blocks,
        AVG(stl) AS avg_league_steals,
        AVG(plus_minus) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season_year, team_name
    ) AS all_teams
    GROUP BY season
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Plus/Minus' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo
FROM unpivoted_weaknesses
ORDER BY season, weakness_type
  );
  
[0m20:31:29.094925 [debug] [Thread-1 (]: Postgres adapter: Postgres error: function avg(character varying) does not exist
LINE 18:         AVG(fg_pct) AS avg_fg_pct,
                 ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.

[0m20:31:29.096291 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: ROLLBACK
[0m20:31:29.097842 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 20:31:29.049124 => 20:31:29.097554
[0m20:31:29.098933 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m20:31:29.105160 [debug] [Thread-1 (]: Database Error in model team_weaknesses_unpivoted (models/spurs_analysis/team_weaknesses_unpivoted.sql)
  function avg(character varying) does not exist
  LINE 18:         AVG(fg_pct) AS avg_fg_pct,
                   ^
  HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:31:29.106400 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fdd1543a-8bfb-46d0-a8b9-7ab737b5aee6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29b1ca270>]}
[0m20:31:29.107487 [error] [Thread-1 (]: 5 of 6 ERROR creating sql table model gold.team_weaknesses_unpivoted ........... [[31mERROR[0m in 0.09s]
[0m20:31:29.108768 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:31:29.109790 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m20:31:29.111469 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m20:31:29.112766 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m20:31:29.113705 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m20:31:29.121553 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m20:31:29.147373 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 20:31:29.114581 => 20:31:29.146979
[0m20:31:29.148446 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m20:31:29.153798 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m20:31:29.179081 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:31:29.180070 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m20:31:29.181075 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:31:29.187789 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:31:29.189003 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:31:29.190221 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        '3-point shooting' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Rebounding' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Ball Handling' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Points Differential' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plusminus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Points Differential' AS weakness_type,
        player,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_plusminus <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m20:31:29.291548 [debug] [Thread-1 (]: SQL status: SELECT 45 in 0.0 seconds
[0m20:31:29.295594 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:31:29.296702 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m20:31:29.298387 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:31:29.302107 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:31:29.303138 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m20:31:29.304696 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:31:29.307668 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m20:31:29.308654 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:31:29.309620 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m20:31:29.315534 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:31:29.319414 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m20:31:29.320950 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:31:29.322146 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m20:31:29.329404 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:31:29.331882 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 20:31:29.149176 => 20:31:29.331621
[0m20:31:29.333124 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m20:31:29.334722 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fdd1543a-8bfb-46d0-a8b9-7ab737b5aee6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29b1c8590>]}
[0m20:31:29.335927 [info ] [Thread-1 (]: 6 of 6 OK created sql table model gold.players_recommendations ................. [[32mSELECT 45[0m in 0.22s]
[0m20:31:29.337405 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m20:31:29.341040 [debug] [MainThread]: Using postgres connection "master"
[0m20:31:29.342022 [debug] [MainThread]: On master: BEGIN
[0m20:31:29.342852 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:31:29.349674 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:31:29.350821 [debug] [MainThread]: On master: COMMIT
[0m20:31:29.351737 [debug] [MainThread]: Using postgres connection "master"
[0m20:31:29.352712 [debug] [MainThread]: On master: COMMIT
[0m20:31:29.353979 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:31:29.354899 [debug] [MainThread]: On master: Close
[0m20:31:29.356475 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:31:29.357388 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m20:31:29.358493 [info ] [MainThread]: 
[0m20:31:29.359532 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.14 seconds (1.14s).
[0m20:31:29.361672 [debug] [MainThread]: Command end result
[0m20:31:29.417607 [info ] [MainThread]: 
[0m20:31:29.418622 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:31:29.419538 [info ] [MainThread]: 
[0m20:31:29.420383 [error] [MainThread]:   Database Error in model team_weaknesses_unpivoted (models/spurs_analysis/team_weaknesses_unpivoted.sql)
  function avg(character varying) does not exist
  LINE 18:         AVG(fg_pct) AS avg_fg_pct,
                   ^
  HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:31:29.421397 [info ] [MainThread]: 
[0m20:31:29.422315 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m20:31:29.423969 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.3402472, "process_user_time": 4.085702, "process_kernel_time": 0.472196, "process_mem_max_rss": "201024", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:31:29.425187 [debug] [MainThread]: Command `dbt run` failed at 20:31:29.424978 after 2.34 seconds
[0m20:31:29.426186 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29c9d1040>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29b9e16a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72a29b1b4b30>]}
[0m20:31:29.427159 [debug] [MainThread]: Flushing usage events
[0m20:32:30.527129 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fc834e60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fc836cf0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fc834e90>]}


============================== 20:32:30.531659 | 60ebcf0f-247a-4ec7-ba35-aa4b3bc71503 ==============================
[0m20:32:30.531659 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:32:30.533013 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:32:30.891727 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '60ebcf0f-247a-4ec7-ba35-aa4b3bc71503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fdb5a2a0>]}
[0m20:32:31.028256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '60ebcf0f-247a-4ec7-ba35-aa4b3bc71503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fc317740>]}
[0m20:32:31.030311 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:32:31.054751 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:32:31.309152 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:32:31.310444 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:32:31.569566 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:32:31.577254 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '60ebcf0f-247a-4ec7-ba35-aa4b3bc71503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fbb1db80>]}
[0m20:32:31.645020 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '60ebcf0f-247a-4ec7-ba35-aa4b3bc71503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fbb6dac0>]}
[0m20:32:31.646050 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:32:31.646994 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '60ebcf0f-247a-4ec7-ba35-aa4b3bc71503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fbf04530>]}
[0m20:32:31.650596 [info ] [MainThread]: 
[0m20:32:31.653020 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:32:31.655888 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:32:31.671779 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:32:31.672856 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:32:31.673872 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:32:31.688576 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:32:31.690909 [debug] [ThreadPool]: On list_nba: Close
[0m20:32:31.694199 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:32:31.703912 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:32:31.705054 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:32:31.706140 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:32:31.713833 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:32:31.715049 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:32:31.716052 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:32:31.722070 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m20:32:31.724502 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:32:31.726323 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:32:31.735270 [debug] [MainThread]: Using postgres connection "master"
[0m20:32:31.736379 [debug] [MainThread]: On master: BEGIN
[0m20:32:31.737357 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:32:31.746752 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:32:31.748196 [debug] [MainThread]: Using postgres connection "master"
[0m20:32:31.750277 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:32:31.774064 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:32:31.776792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '60ebcf0f-247a-4ec7-ba35-aa4b3bc71503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fb7d53a0>]}
[0m20:32:31.778434 [debug] [MainThread]: On master: ROLLBACK
[0m20:32:31.780884 [debug] [MainThread]: Using postgres connection "master"
[0m20:32:31.781982 [debug] [MainThread]: On master: BEGIN
[0m20:32:31.783858 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:32:31.786202 [debug] [MainThread]: On master: COMMIT
[0m20:32:31.787358 [debug] [MainThread]: Using postgres connection "master"
[0m20:32:31.788894 [debug] [MainThread]: On master: COMMIT
[0m20:32:31.791931 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:32:31.793049 [debug] [MainThread]: On master: Close
[0m20:32:31.794694 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:32:31.795780 [info ] [MainThread]: 
[0m20:32:31.802071 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:32:31.803449 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:32:31.804962 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:32:31.805908 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:32:31.818172 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:32:31.843991 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:32:31.806685 => 20:32:31.843583
[0m20:32:31.845033 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:32:31.915170 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:32:31.940184 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:32:31.941174 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:32:31.942131 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:32:31.949253 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:32:31.950909 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:32:31.952377 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:32:31.975703 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:32:31.987780 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:32:31.989068 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m20:32:31.990989 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:32:31.995780 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:32:31.996892 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m20:32:31.998632 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:32:32.036453 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:32:32.038236 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:32:32.039326 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:32:32.044770 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:32:32.055114 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m20:32:32.064173 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:32:32.065247 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m20:32:32.072714 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:32:32.075506 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:32:31.846162 => 20:32:32.075168
[0m20:32:32.076545 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:32:32.078609 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '60ebcf0f-247a-4ec7-ba35-aa4b3bc71503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fb3e8650>]}
[0m20:32:32.080195 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.27s]
[0m20:32:32.081600 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:32:32.083710 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m20:32:32.088915 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m20:32:32.090700 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m20:32:32.094226 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m20:32:32.099934 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m20:32:32.126170 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 20:32:32.095125 => 20:32:32.125575
[0m20:32:32.127188 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m20:32:32.135957 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m20:32:32.161631 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:32:32.163187 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m20:32:32.164292 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:32:32.172269 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:32:32.173739 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:32:32.174943 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m20:32:32.195486 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m20:32:32.201076 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:32:32.202325 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m20:32:32.204217 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:32:32.209289 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:32:32.210376 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m20:32:32.211795 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:32:32.215205 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m20:32:32.216352 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:32:32.217882 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m20:32:32.223502 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:32:32.230001 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m20:32:32.231762 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:32:32.232839 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m20:32:32.240462 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:32:32.243307 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 20:32:32.127928 => 20:32:32.242962
[0m20:32:32.244359 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m20:32:32.246072 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '60ebcf0f-247a-4ec7-ba35-aa4b3bc71503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fb3c7b60>]}
[0m20:32:32.247416 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.16s]
[0m20:32:32.248884 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m20:32:32.250556 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:32:32.252108 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:32:32.254222 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m20:32:32.255311 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:32:32.260406 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:32:32.281505 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:32:32.256052 => 20:32:32.281107
[0m20:32:32.282468 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:32:32.288317 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:32:32.311235 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:32:32.312119 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:32:32.312915 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:32:32.320597 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:32:32.321565 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:32:32.322628 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m20:32:32.339701 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m20:32:32.344312 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:32:32.345264 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:32:32.346810 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:32:32.351888 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:32:32.352950 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:32:32.354549 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:32:32.357545 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:32:32.358651 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:32:32.359706 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:32:32.365587 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:32:32.370127 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:32:32.371729 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:32:32.372754 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:32:32.380326 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:32:32.383897 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:32:32.283330 => 20:32:32.383425
[0m20:32:32.385074 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:32:32.386718 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '60ebcf0f-247a-4ec7-ba35-aa4b3bc71503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fb3c7c20>]}
[0m20:32:32.387937 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.13s]
[0m20:32:32.389877 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:32:32.391382 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:32:32.392445 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:32:32.393822 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:32:32.394746 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:32:32.400933 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:32:32.427698 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:32:32.395515 => 20:32:32.427294
[0m20:32:32.428688 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:32:32.435259 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:32:32.460789 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:32:32.461932 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:32:32.462854 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:32:32.470952 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:32:32.472070 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:32:32.473185 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m20:32:32.506973 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m20:32:32.512342 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:32:32.513457 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m20:32:32.515254 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:32:32.520754 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:32:32.521944 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m20:32:32.523546 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:32:32.526665 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:32:32.527645 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:32:32.528607 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:32:32.535564 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:32:32.539350 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m20:32:32.540824 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:32:32.541781 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m20:32:32.551166 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:32:32.553651 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:32:32.429468 => 20:32:32.553382
[0m20:32:32.554822 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:32:32.556451 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '60ebcf0f-247a-4ec7-ba35-aa4b3bc71503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fb3af320>]}
[0m20:32:32.559027 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.16s]
[0m20:32:32.560291 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:32:32.561322 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:32:32.562453 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m20:32:32.563913 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m20:32:32.564897 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:32:32.571435 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:32:32.597550 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 20:32:32.565848 => 20:32:32.597152
[0m20:32:32.598720 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:32:32.607529 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:32:32.634321 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:32:32.635534 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m20:32:32.636434 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:32:32.643245 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:32:32.644377 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:32:32.645484 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct) AS avg_fg_pct,
        AVG(fg3_pct) AS avg_fg3_pct,
        AVG(tov) AS avg_turnovers,
        AVG(reb) AS avg_rebounds,
        AVG(blk) AS avg_blocks,
        AVG(stl) AS avg_steals,
        AVG(plus_minus) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season_year, team_name
    ) AS all_teams
    GROUP BY season
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Plus/Minus' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo
FROM unpivoted_weaknesses
ORDER BY season, weakness_type
  );
  
[0m20:32:32.648052 [debug] [Thread-1 (]: Postgres adapter: Postgres error: function avg(character varying) does not exist
LINE 18:         AVG(fg_pct) AS avg_fg_pct,
                 ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.

[0m20:32:32.649307 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: ROLLBACK
[0m20:32:32.651959 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 20:32:32.599584 => 20:32:32.651603
[0m20:32:32.652927 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m20:32:32.658274 [debug] [Thread-1 (]: Database Error in model team_weaknesses_unpivoted (models/spurs_analysis/team_weaknesses_unpivoted.sql)
  function avg(character varying) does not exist
  LINE 18:         AVG(fg_pct) AS avg_fg_pct,
                   ^
  HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:32:32.659467 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '60ebcf0f-247a-4ec7-ba35-aa4b3bc71503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fafcdc10>]}
[0m20:32:32.660583 [error] [Thread-1 (]: 5 of 6 ERROR creating sql table model gold.team_weaknesses_unpivoted ........... [[31mERROR[0m in 0.10s]
[0m20:32:32.662028 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:32:32.663021 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m20:32:32.664618 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m20:32:32.666234 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m20:32:32.667853 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m20:32:32.675959 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m20:32:32.700898 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 20:32:32.668875 => 20:32:32.700169
[0m20:32:32.702139 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m20:32:32.707558 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m20:32:32.732393 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:32:32.733847 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m20:32:32.735218 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:32:32.742194 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:32:32.743403 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:32:32.744728 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        '3-point shooting' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Rebounding' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Ball Handling' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Points Differential' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plusminus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Points Differential' AS weakness_type,
        player,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_plusminus <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m20:32:32.844895 [debug] [Thread-1 (]: SQL status: SELECT 45 in 0.0 seconds
[0m20:32:32.849027 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:32:32.850587 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m20:32:32.852833 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:32:32.856852 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:32:32.857960 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m20:32:32.859580 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:32:32.862730 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m20:32:32.863844 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:32:32.865193 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m20:32:32.872108 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:32:32.876148 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m20:32:32.877635 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:32:32.878831 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m20:32:32.887231 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:32:32.889646 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 20:32:32.703053 => 20:32:32.889379
[0m20:32:32.890832 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m20:32:32.892343 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '60ebcf0f-247a-4ec7-ba35-aa4b3bc71503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fafb5a30>]}
[0m20:32:32.893543 [info ] [Thread-1 (]: 6 of 6 OK created sql table model gold.players_recommendations ................. [[32mSELECT 45[0m in 0.23s]
[0m20:32:32.895046 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m20:32:32.898654 [debug] [MainThread]: Using postgres connection "master"
[0m20:32:32.899929 [debug] [MainThread]: On master: BEGIN
[0m20:32:32.901522 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:32:32.908805 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:32:32.909929 [debug] [MainThread]: On master: COMMIT
[0m20:32:32.910855 [debug] [MainThread]: Using postgres connection "master"
[0m20:32:32.911770 [debug] [MainThread]: On master: COMMIT
[0m20:32:32.912991 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:32:32.913983 [debug] [MainThread]: On master: Close
[0m20:32:32.915583 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:32:32.916943 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m20:32:32.918342 [info ] [MainThread]: 
[0m20:32:32.919793 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.27 seconds (1.27s).
[0m20:32:32.922773 [debug] [MainThread]: Command end result
[0m20:32:32.981185 [info ] [MainThread]: 
[0m20:32:32.982574 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:32:32.984169 [info ] [MainThread]: 
[0m20:32:32.985323 [error] [MainThread]:   Database Error in model team_weaknesses_unpivoted (models/spurs_analysis/team_weaknesses_unpivoted.sql)
  function avg(character varying) does not exist
  LINE 18:         AVG(fg_pct) AS avg_fg_pct,
                   ^
  HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:32:32.986414 [info ] [MainThread]: 
[0m20:32:32.987354 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m20:32:32.988861 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.580839, "process_user_time": 3.958828, "process_kernel_time": 0.536721, "process_mem_max_rss": "201052", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:32:32.989968 [debug] [MainThread]: Command `dbt run` failed at 20:32:32.989738 after 2.58 seconds
[0m20:32:32.990860 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fc955010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fb3927e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d03fafb5a30>]}
[0m20:32:32.991745 [debug] [MainThread]: Flushing usage events
[0m20:33:16.884851 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49e673d190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49e6b09c40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49e673f5f0>]}


============================== 20:33:16.889563 | 79825cb6-7477-4ef5-9659-10c3f0d10af2 ==============================
[0m20:33:16.889563 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:33:16.891590 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:33:17.151734 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '79825cb6-7477-4ef5-9659-10c3f0d10af2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49e60c9820>]}
[0m20:33:17.271955 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '79825cb6-7477-4ef5-9659-10c3f0d10af2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49e6840710>]}
[0m20:33:17.274027 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:33:17.300759 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:33:17.569088 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:33:17.570510 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:33:17.799038 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:33:17.805611 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '79825cb6-7477-4ef5-9659-10c3f0d10af2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49e60ffaa0>]}
[0m20:33:17.874522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '79825cb6-7477-4ef5-9659-10c3f0d10af2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49e5dad970>]}
[0m20:33:17.876003 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:33:17.877109 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '79825cb6-7477-4ef5-9659-10c3f0d10af2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49e5567110>]}
[0m20:33:17.880072 [info ] [MainThread]: 
[0m20:33:17.881519 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:33:17.884045 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:33:17.898135 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:33:17.899184 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:33:17.900128 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:33:17.909921 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:33:17.912234 [debug] [ThreadPool]: On list_nba: Close
[0m20:33:17.915563 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:33:17.924261 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:33:17.925369 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:33:17.926277 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:33:17.933298 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:33:17.934792 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:33:17.936001 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:33:17.941942 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m20:33:17.944366 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:33:17.945956 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:33:17.953743 [debug] [MainThread]: Using postgres connection "master"
[0m20:33:17.954919 [debug] [MainThread]: On master: BEGIN
[0m20:33:17.956185 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:33:17.963859 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:33:17.964942 [debug] [MainThread]: Using postgres connection "master"
[0m20:33:17.965959 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:33:17.983421 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:33:17.985406 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '79825cb6-7477-4ef5-9659-10c3f0d10af2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49e6e6a960>]}
[0m20:33:17.986552 [debug] [MainThread]: On master: ROLLBACK
[0m20:33:17.987972 [debug] [MainThread]: Using postgres connection "master"
[0m20:33:17.988999 [debug] [MainThread]: On master: BEGIN
[0m20:33:17.991523 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:33:17.992695 [debug] [MainThread]: On master: COMMIT
[0m20:33:17.993561 [debug] [MainThread]: Using postgres connection "master"
[0m20:33:17.994379 [debug] [MainThread]: On master: COMMIT
[0m20:33:17.995523 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:33:17.996655 [debug] [MainThread]: On master: Close
[0m20:33:17.998156 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:33:17.999223 [info ] [MainThread]: 
[0m20:33:18.004284 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:33:18.005550 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:33:18.007979 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:33:18.009162 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:33:18.019099 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:33:18.045530 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:33:18.009957 => 20:33:18.045131
[0m20:33:18.046463 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:33:18.095693 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:33:18.121806 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:33:18.122887 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:33:18.124952 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:33:18.131542 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:33:18.132822 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:33:18.133814 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:33:18.164199 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:33:18.174830 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:33:18.176041 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m20:33:18.177608 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:33:18.182479 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:33:18.183567 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m20:33:18.185149 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:33:18.215540 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:33:18.216849 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:33:18.217812 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:33:18.224256 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:33:18.232392 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m20:33:18.240624 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:33:18.241941 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m20:33:18.248963 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:33:18.251555 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:33:18.047181 => 20:33:18.251247
[0m20:33:18.252740 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:33:18.254471 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '79825cb6-7477-4ef5-9659-10c3f0d10af2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49e5128710>]}
[0m20:33:18.255721 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.25s]
[0m20:33:18.258156 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:33:18.259396 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m20:33:18.260623 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m20:33:18.262050 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m20:33:18.262923 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m20:33:18.267356 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m20:33:18.294676 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 20:33:18.263739 => 20:33:18.294294
[0m20:33:18.295602 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m20:33:18.301011 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m20:33:18.327326 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:33:18.328422 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m20:33:18.329388 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:33:18.336699 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:33:18.337840 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:33:18.339024 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m20:33:18.359710 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m20:33:18.364262 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:33:18.365336 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m20:33:18.366965 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:33:18.371078 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:33:18.372181 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m20:33:18.374130 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:33:18.377383 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m20:33:18.378399 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:33:18.379421 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m20:33:18.385168 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:33:18.391250 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m20:33:18.392916 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:33:18.394001 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m20:33:18.400951 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:33:18.403455 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 20:33:18.296515 => 20:33:18.403191
[0m20:33:18.404536 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m20:33:18.406341 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '79825cb6-7477-4ef5-9659-10c3f0d10af2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49e51baf60>]}
[0m20:33:18.408565 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.14s]
[0m20:33:18.410036 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m20:33:18.510082 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:33:18.511327 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:33:18.512717 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m20:33:18.513810 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:33:18.518187 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:33:18.546617 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:33:18.514706 => 20:33:18.545916
[0m20:33:18.548493 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:33:18.560763 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:33:18.596438 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:33:18.597556 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:33:18.598784 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:33:18.606265 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:33:18.607725 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:33:18.609488 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m20:33:18.628869 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m20:33:18.633293 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:33:18.634319 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:33:18.635956 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:33:18.640917 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:33:18.642499 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:33:18.644177 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:33:18.647040 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:33:18.648102 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:33:18.649145 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:33:18.655002 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:33:18.660095 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:33:18.661692 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:33:18.662736 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:33:18.675780 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:33:18.678426 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:33:18.549843 => 20:33:18.678151
[0m20:33:18.679521 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:33:18.681090 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '79825cb6-7477-4ef5-9659-10c3f0d10af2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49e51bb530>]}
[0m20:33:18.682309 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.17s]
[0m20:33:18.683589 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:33:18.684886 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:33:18.685947 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:33:18.687275 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:33:18.688273 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:33:18.694296 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:33:18.722388 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:33:18.689219 => 20:33:18.722002
[0m20:33:18.724224 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:33:18.729639 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:33:18.754839 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:33:18.756312 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:33:18.758082 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:33:18.765967 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:33:18.767101 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:33:18.768512 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m20:33:18.803461 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m20:33:18.809609 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:33:18.810814 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m20:33:18.812454 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:33:18.816416 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:33:18.817392 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m20:33:18.818808 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:33:18.821785 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:33:18.823353 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:33:18.824849 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:33:18.832427 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:33:18.836356 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m20:33:18.837869 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:33:18.838799 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m20:33:18.846581 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:33:18.849091 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:33:18.725184 => 20:33:18.848845
[0m20:33:18.850086 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:33:18.851562 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '79825cb6-7477-4ef5-9659-10c3f0d10af2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49e51072f0>]}
[0m20:33:18.852854 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.16s]
[0m20:33:18.854416 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:33:18.855499 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:33:18.857465 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m20:33:18.859322 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m20:33:18.860271 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:33:18.865423 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:33:18.894564 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 20:33:18.861002 => 20:33:18.894083
[0m20:33:18.895930 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:33:18.903645 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:33:18.931294 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:33:18.932352 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m20:33:18.933270 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:33:18.941168 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:33:18.942686 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:33:18.945675 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season_year, team_name
    ) AS all_teams
    GROUP BY season
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Plus/Minus' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo
FROM unpivoted_weaknesses
ORDER BY season, weakness_type
  );
  
[0m20:33:18.950077 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "season_year" does not exist
LINE 68:         GROUP BY season_year, team_name
                          ^

[0m20:33:18.951403 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: ROLLBACK
[0m20:33:18.953209 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 20:33:18.896942 => 20:33:18.952756
[0m20:33:18.954755 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m20:33:18.963726 [debug] [Thread-1 (]: Database Error in model team_weaknesses_unpivoted (models/spurs_analysis/team_weaknesses_unpivoted.sql)
  column "season_year" does not exist
  LINE 68:         GROUP BY season_year, team_name
                            ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:33:18.965214 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '79825cb6-7477-4ef5-9659-10c3f0d10af2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49e6872600>]}
[0m20:33:18.966741 [error] [Thread-1 (]: 5 of 6 ERROR creating sql table model gold.team_weaknesses_unpivoted ........... [[31mERROR[0m in 0.11s]
[0m20:33:18.969051 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:33:18.970771 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m20:33:18.973041 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m20:33:18.975094 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m20:33:18.976245 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m20:33:18.986764 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m20:33:19.013215 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 20:33:18.977093 => 20:33:19.012816
[0m20:33:19.014773 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m20:33:19.020712 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m20:33:19.044500 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:33:19.045463 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m20:33:19.046341 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:33:19.053388 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:33:19.054455 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:33:19.055687 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        '3-point shooting' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Rebounding' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Ball Handling' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Points Differential' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plusminus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Points Differential' AS weakness_type,
        player,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_plusminus <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m20:33:19.148990 [debug] [Thread-1 (]: SQL status: SELECT 45 in 0.0 seconds
[0m20:33:19.153131 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:33:19.154125 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m20:33:19.156274 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:33:19.160856 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:33:19.161931 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m20:33:19.163449 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:33:19.166962 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m20:33:19.168157 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:33:19.169123 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m20:33:19.174862 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:33:19.178615 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m20:33:19.180119 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:33:19.181103 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m20:33:19.188197 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:33:19.191670 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 20:33:19.015763 => 20:33:19.191393
[0m20:33:19.192992 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m20:33:19.194695 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '79825cb6-7477-4ef5-9659-10c3f0d10af2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49e51f7e00>]}
[0m20:33:19.195986 [info ] [Thread-1 (]: 6 of 6 OK created sql table model gold.players_recommendations ................. [[32mSELECT 45[0m in 0.22s]
[0m20:33:19.197338 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m20:33:19.200971 [debug] [MainThread]: Using postgres connection "master"
[0m20:33:19.202026 [debug] [MainThread]: On master: BEGIN
[0m20:33:19.203313 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:33:19.210674 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:33:19.211724 [debug] [MainThread]: On master: COMMIT
[0m20:33:19.212720 [debug] [MainThread]: Using postgres connection "master"
[0m20:33:19.213607 [debug] [MainThread]: On master: COMMIT
[0m20:33:19.214850 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:33:19.215972 [debug] [MainThread]: On master: Close
[0m20:33:19.217579 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:33:19.218880 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m20:33:19.220247 [info ] [MainThread]: 
[0m20:33:19.221380 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.34 seconds (1.34s).
[0m20:33:19.225292 [debug] [MainThread]: Command end result
[0m20:33:19.291550 [info ] [MainThread]: 
[0m20:33:19.292987 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:33:19.294014 [info ] [MainThread]: 
[0m20:33:19.294955 [error] [MainThread]:   Database Error in model team_weaknesses_unpivoted (models/spurs_analysis/team_weaknesses_unpivoted.sql)
  column "season_year" does not exist
  LINE 68:         GROUP BY season_year, team_name
                            ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:33:19.295984 [info ] [MainThread]: 
[0m20:33:19.296953 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m20:33:19.298511 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.496952, "process_user_time": 3.496414, "process_kernel_time": 0.409704, "process_mem_max_rss": "201024", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:33:19.299619 [debug] [MainThread]: Command `dbt run` failed at 20:33:19.299432 after 2.50 seconds
[0m20:33:19.300674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49eb0caf60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49eaede6f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c49e6bece30>]}
[0m20:33:19.301668 [debug] [MainThread]: Flushing usage events
[0m20:34:02.995717 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc49fe510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc49fe270>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc49fe360>]}


============================== 20:34:03.002303 | bb9a0b3b-7cba-4b94-993a-b7a37667a234 ==============================
[0m20:34:03.002303 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:34:03.003749 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:34:03.312882 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bb9a0b3b-7cba-4b94-993a-b7a37667a234', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc4a5d880>]}
[0m20:34:03.437526 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bb9a0b3b-7cba-4b94-993a-b7a37667a234', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc3d06000>]}
[0m20:34:03.439076 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:34:03.463400 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:34:03.702751 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:34:03.704522 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:34:03.991257 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:34:04.000406 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bb9a0b3b-7cba-4b94-993a-b7a37667a234', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc31ff740>]}
[0m20:34:04.076289 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bb9a0b3b-7cba-4b94-993a-b7a37667a234', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc39a8a40>]}
[0m20:34:04.077671 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:34:04.078847 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bb9a0b3b-7cba-4b94-993a-b7a37667a234', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc317af60>]}
[0m20:34:04.083427 [info ] [MainThread]: 
[0m20:34:04.085531 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:34:04.088513 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:34:04.109588 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:34:04.110974 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:34:04.112594 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:34:04.127887 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:34:04.130256 [debug] [ThreadPool]: On list_nba: Close
[0m20:34:04.135046 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:34:04.147263 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:34:04.148569 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:34:04.150499 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:34:04.160756 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:34:04.161956 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:34:04.162902 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:34:04.169850 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m20:34:04.172713 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:34:04.174196 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:34:04.183934 [debug] [MainThread]: Using postgres connection "master"
[0m20:34:04.185021 [debug] [MainThread]: On master: BEGIN
[0m20:34:04.185929 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:34:04.193586 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:34:04.194478 [debug] [MainThread]: Using postgres connection "master"
[0m20:34:04.195312 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:34:04.226801 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:34:04.229449 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bb9a0b3b-7cba-4b94-993a-b7a37667a234', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc5142d20>]}
[0m20:34:04.231072 [debug] [MainThread]: On master: ROLLBACK
[0m20:34:04.234579 [debug] [MainThread]: Using postgres connection "master"
[0m20:34:04.236090 [debug] [MainThread]: On master: BEGIN
[0m20:34:04.238778 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:34:04.240070 [debug] [MainThread]: On master: COMMIT
[0m20:34:04.241366 [debug] [MainThread]: Using postgres connection "master"
[0m20:34:04.243476 [debug] [MainThread]: On master: COMMIT
[0m20:34:04.245128 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:34:04.247909 [debug] [MainThread]: On master: Close
[0m20:34:04.250585 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:34:04.253482 [info ] [MainThread]: 
[0m20:34:04.258697 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:34:04.260013 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:34:04.261800 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:34:04.262962 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:34:04.275010 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:34:04.298490 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:34:04.263688 => 20:34:04.298025
[0m20:34:04.301442 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:34:04.354680 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:34:04.378879 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:34:04.379950 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:34:04.380832 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:34:04.388757 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:34:04.389932 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:34:04.391044 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:34:04.410579 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:34:04.420289 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:34:04.421812 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m20:34:04.423865 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:04.428017 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:34:04.429197 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m20:34:04.431250 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:04.470780 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:34:04.472078 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:34:04.473400 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:34:04.480003 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:34:04.491705 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m20:34:04.502206 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:34:04.503427 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m20:34:04.510544 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:34:04.513333 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:34:04.302342 => 20:34:04.513053
[0m20:34:04.514361 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:34:04.516704 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bb9a0b3b-7cba-4b94-993a-b7a37667a234', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc2d14890>]}
[0m20:34:04.518312 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.26s]
[0m20:34:04.520086 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:34:04.521227 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m20:34:04.522251 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m20:34:04.523782 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m20:34:04.524970 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m20:34:04.529968 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m20:34:04.555573 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 20:34:04.525916 => 20:34:04.555174
[0m20:34:04.556793 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m20:34:04.562700 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m20:34:04.593392 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:34:04.594319 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m20:34:04.595170 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:34:04.602816 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:34:04.603926 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:34:04.605092 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m20:34:04.622019 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m20:34:04.626305 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:34:04.627206 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m20:34:04.628644 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:04.634195 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:34:04.635185 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m20:34:04.636615 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:04.639638 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m20:34:04.640629 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:34:04.641396 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m20:34:04.646361 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:34:04.653229 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m20:34:04.654858 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:34:04.655810 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m20:34:04.662022 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:34:04.664765 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 20:34:04.557656 => 20:34:04.664323
[0m20:34:04.665883 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m20:34:04.667943 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bb9a0b3b-7cba-4b94-993a-b7a37667a234', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc2dd0470>]}
[0m20:34:04.669274 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.14s]
[0m20:34:04.670831 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m20:34:04.671925 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:34:04.672991 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:34:04.674461 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m20:34:04.675383 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:34:04.679754 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:34:04.710546 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:34:04.675987 => 20:34:04.710050
[0m20:34:04.711966 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:34:04.721039 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:34:04.747381 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:34:04.748855 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:34:04.751151 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:34:04.759874 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:34:04.761566 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:34:04.763451 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m20:34:04.784895 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m20:34:04.789277 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:34:04.790400 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:34:04.791902 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:04.795968 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:34:04.797023 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:34:04.798781 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:04.803090 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:34:04.804211 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:34:04.805187 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:34:04.810737 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:34:04.814606 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:34:04.817420 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:34:04.818872 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:34:04.825614 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:34:04.828020 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:34:04.713076 => 20:34:04.827750
[0m20:34:04.829070 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:34:04.831167 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bb9a0b3b-7cba-4b94-993a-b7a37667a234', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc2db65d0>]}
[0m20:34:04.833331 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.16s]
[0m20:34:04.835302 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:34:04.836585 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:34:04.837691 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:34:04.839404 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:34:04.840413 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:34:04.845585 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:34:04.874137 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:34:04.841322 => 20:34:04.873733
[0m20:34:04.875086 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:34:04.881008 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:34:04.912843 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:34:04.913911 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:34:04.914861 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:34:04.923365 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:34:04.924551 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:34:04.926040 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m20:34:04.966063 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m20:34:04.971984 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:34:04.973103 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m20:34:04.975120 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:04.979573 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:34:04.980632 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m20:34:04.983127 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:04.986902 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:34:04.988033 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:34:04.988988 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:34:04.997213 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:34:05.003093 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m20:34:05.004686 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:34:05.005689 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m20:34:05.013001 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:34:05.017868 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:34:04.875861 => 20:34:05.017442
[0m20:34:05.019001 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:34:05.020722 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bb9a0b3b-7cba-4b94-993a-b7a37667a234', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc2d7ec00>]}
[0m20:34:05.022184 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.18s]
[0m20:34:05.023741 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:34:05.024935 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:34:05.026098 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m20:34:05.027419 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m20:34:05.028289 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:34:05.035998 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:34:05.062661 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 20:34:05.029271 => 20:34:05.061877
[0m20:34:05.064062 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:34:05.075870 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:34:05.103995 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:34:05.105093 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m20:34:05.106160 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:34:05.113609 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:34:05.114690 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:34:05.116899 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Plus/Minus' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m20:34:05.121076 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "season" does not exist
LINE 70:     GROUP BY season
                      ^
HINT:  Perhaps you meant to reference the column "all_teams.season2".

[0m20:34:05.122115 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: ROLLBACK
[0m20:34:05.123825 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 20:34:05.066367 => 20:34:05.123377
[0m20:34:05.125000 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m20:34:05.133407 [debug] [Thread-1 (]: Database Error in model team_weaknesses_unpivoted (models/spurs_analysis/team_weaknesses_unpivoted.sql)
  column "season" does not exist
  LINE 70:     GROUP BY season
                        ^
  HINT:  Perhaps you meant to reference the column "all_teams.season2".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:34:05.135482 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bb9a0b3b-7cba-4b94-993a-b7a37667a234', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc29064e0>]}
[0m20:34:05.137448 [error] [Thread-1 (]: 5 of 6 ERROR creating sql table model gold.team_weaknesses_unpivoted ........... [[31mERROR[0m in 0.11s]
[0m20:34:05.139408 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:34:05.140632 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m20:34:05.142877 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m20:34:05.144695 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m20:34:05.145765 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m20:34:05.155566 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m20:34:05.180789 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 20:34:05.146653 => 20:34:05.180291
[0m20:34:05.182497 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m20:34:05.189245 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m20:34:05.215282 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:34:05.217084 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m20:34:05.218632 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:34:05.227310 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:34:05.228775 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:34:05.230501 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        '3-point shooting' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Rebounding' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Ball Handling' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Points Differential' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plusminus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Points Differential' AS weakness_type,
        player,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_plusminus <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m20:34:05.395844 [debug] [Thread-1 (]: SQL status: SELECT 45 in 0.0 seconds
[0m20:34:05.401472 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:34:05.402522 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m20:34:05.404272 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:05.409290 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:34:05.410206 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m20:34:05.411512 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:05.415819 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m20:34:05.417194 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:34:05.418135 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m20:34:05.423259 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:34:05.426878 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m20:34:05.428224 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:34:05.429178 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m20:34:05.436156 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:34:05.438853 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 20:34:05.184198 => 20:34:05.438490
[0m20:34:05.439786 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m20:34:05.441316 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bb9a0b3b-7cba-4b94-993a-b7a37667a234', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc29046b0>]}
[0m20:34:05.442621 [info ] [Thread-1 (]: 6 of 6 OK created sql table model gold.players_recommendations ................. [[32mSELECT 45[0m in 0.30s]
[0m20:34:05.444350 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m20:34:05.448228 [debug] [MainThread]: Using postgres connection "master"
[0m20:34:05.449878 [debug] [MainThread]: On master: BEGIN
[0m20:34:05.451021 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:34:05.458315 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:34:05.459329 [debug] [MainThread]: On master: COMMIT
[0m20:34:05.460240 [debug] [MainThread]: Using postgres connection "master"
[0m20:34:05.461138 [debug] [MainThread]: On master: COMMIT
[0m20:34:05.462299 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:34:05.463204 [debug] [MainThread]: On master: Close
[0m20:34:05.464606 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:34:05.465846 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m20:34:05.467301 [info ] [MainThread]: 
[0m20:34:05.468377 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.38 seconds (1.38s).
[0m20:34:05.470874 [debug] [MainThread]: Command end result
[0m20:34:05.527153 [info ] [MainThread]: 
[0m20:34:05.528283 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:34:05.529192 [info ] [MainThread]: 
[0m20:34:05.530073 [error] [MainThread]:   Database Error in model team_weaknesses_unpivoted (models/spurs_analysis/team_weaknesses_unpivoted.sql)
  column "season" does not exist
  LINE 70:     GROUP BY season
                        ^
  HINT:  Perhaps you meant to reference the column "all_teams.season2".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:34:05.531634 [info ] [MainThread]: 
[0m20:34:05.533230 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m20:34:05.535496 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.6309025, "process_user_time": 4.061381, "process_kernel_time": 0.465994, "process_mem_max_rss": "201028", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:34:05.536730 [debug] [MainThread]: Command `dbt run` failed at 20:34:05.536539 after 2.63 seconds
[0m20:34:05.537674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc4b196d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc4afe8d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74adc3179a60>]}
[0m20:34:05.538654 [debug] [MainThread]: Flushing usage events
[0m20:34:57.663555 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7210815063f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72107f884a70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72107f3d79b0>]}


============================== 20:34:57.668306 | 0d92ffb1-3a27-4004-92f4-c7a8e0518df3 ==============================
[0m20:34:57.668306 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:34:57.670076 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m20:34:57.992807 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0d92ffb1-3a27-4004-92f4-c7a8e0518df3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72107f4f16d0>]}
[0m20:34:58.130400 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0d92ffb1-3a27-4004-92f4-c7a8e0518df3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72107f2cb140>]}
[0m20:34:58.132130 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:34:58.155248 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:34:58.488693 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:34:58.490140 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:34:58.699052 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:34:58.706387 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0d92ffb1-3a27-4004-92f4-c7a8e0518df3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72107f502180>]}
[0m20:34:58.785872 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0d92ffb1-3a27-4004-92f4-c7a8e0518df3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72107e3b49e0>]}
[0m20:34:58.787561 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:34:58.789121 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0d92ffb1-3a27-4004-92f4-c7a8e0518df3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72107db4e1e0>]}
[0m20:34:58.793143 [info ] [MainThread]: 
[0m20:34:58.795241 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:34:58.798351 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:34:58.816773 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:34:58.817916 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:34:58.818880 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:34:58.830300 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:34:58.832910 [debug] [ThreadPool]: On list_nba: Close
[0m20:34:58.837782 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:34:58.849028 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:34:58.850143 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:34:58.851268 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:34:58.860686 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:34:58.861932 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:34:58.863740 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:34:58.871078 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m20:34:58.873772 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:34:58.875260 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:34:58.885655 [debug] [MainThread]: Using postgres connection "master"
[0m20:34:58.887013 [debug] [MainThread]: On master: BEGIN
[0m20:34:58.888547 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:34:58.899406 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:34:58.900783 [debug] [MainThread]: Using postgres connection "master"
[0m20:34:58.901945 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:34:58.933129 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:34:58.935001 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0d92ffb1-3a27-4004-92f4-c7a8e0518df3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72107dbf3fb0>]}
[0m20:34:58.935987 [debug] [MainThread]: On master: ROLLBACK
[0m20:34:58.937390 [debug] [MainThread]: Using postgres connection "master"
[0m20:34:58.938512 [debug] [MainThread]: On master: BEGIN
[0m20:34:58.940259 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:34:58.941557 [debug] [MainThread]: On master: COMMIT
[0m20:34:58.942439 [debug] [MainThread]: Using postgres connection "master"
[0m20:34:58.943338 [debug] [MainThread]: On master: COMMIT
[0m20:34:58.944899 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:34:58.946395 [debug] [MainThread]: On master: Close
[0m20:34:58.948107 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:34:58.949757 [info ] [MainThread]: 
[0m20:34:58.955992 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:34:58.957696 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:34:58.959438 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:34:58.960599 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:34:58.971566 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:34:58.992882 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:34:58.961272 => 20:34:58.992491
[0m20:34:58.993892 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:34:59.042439 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:34:59.064546 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:34:59.065471 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:34:59.066259 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:34:59.074671 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:34:59.075538 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:34:59.076408 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:34:59.097229 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:34:59.105867 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:34:59.106963 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m20:34:59.108409 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:59.112604 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:34:59.113595 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m20:34:59.114930 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:59.141038 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:34:59.142218 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:34:59.143195 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:34:59.149223 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:34:59.158861 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m20:34:59.166864 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:34:59.167868 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m20:34:59.175292 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:34:59.177879 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:34:58.994616 => 20:34:59.177626
[0m20:34:59.178842 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:34:59.180399 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d92ffb1-3a27-4004-92f4-c7a8e0518df3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72107df0a030>]}
[0m20:34:59.181580 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.22s]
[0m20:34:59.183048 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:34:59.184037 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m20:34:59.185088 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m20:34:59.187234 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m20:34:59.188996 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m20:34:59.193525 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m20:34:59.218977 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 20:34:59.189755 => 20:34:59.218604
[0m20:34:59.220449 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m20:34:59.226372 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m20:34:59.251003 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:34:59.251898 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m20:34:59.252881 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:34:59.259661 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:34:59.260763 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:34:59.261832 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m20:34:59.282525 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m20:34:59.287387 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:34:59.288612 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m20:34:59.290140 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:59.294339 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:34:59.295342 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m20:34:59.296818 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:59.299809 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m20:34:59.300619 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:34:59.301438 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m20:34:59.307651 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:34:59.312677 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m20:34:59.314053 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:34:59.315008 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m20:34:59.322406 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:34:59.326886 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 20:34:59.221919 => 20:34:59.326602
[0m20:34:59.328080 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m20:34:59.329714 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d92ffb1-3a27-4004-92f4-c7a8e0518df3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72107d7c33e0>]}
[0m20:34:59.331206 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.14s]
[0m20:34:59.333311 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m20:34:59.334548 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:34:59.336086 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:34:59.338536 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m20:34:59.339998 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:34:59.346086 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:34:59.372960 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:34:59.341029 => 20:34:59.372178
[0m20:34:59.374470 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:34:59.380130 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:34:59.408652 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:34:59.409965 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:34:59.411238 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:34:59.418203 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:34:59.419625 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:34:59.422109 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m20:34:59.441015 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m20:34:59.445348 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:34:59.446348 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:34:59.447900 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:59.451949 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:34:59.452991 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:34:59.455530 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:59.458599 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:34:59.459584 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:34:59.460790 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:34:59.468072 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:34:59.472902 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:34:59.474417 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:34:59.475406 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:34:59.481970 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:34:59.484537 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:34:59.375379 => 20:34:59.484272
[0m20:34:59.485581 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:34:59.488025 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d92ffb1-3a27-4004-92f4-c7a8e0518df3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72107d7c3770>]}
[0m20:34:59.489565 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m20:34:59.491066 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:34:59.492114 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:34:59.493230 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:34:59.494609 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:34:59.495786 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:34:59.500811 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:34:59.529470 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:34:59.496647 => 20:34:59.529096
[0m20:34:59.530423 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:34:59.538386 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:34:59.566454 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:34:59.567413 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:34:59.568443 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:34:59.576617 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:34:59.577925 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:34:59.579326 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m20:34:59.612262 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m20:34:59.616729 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:34:59.617894 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m20:34:59.619760 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:59.624757 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:34:59.625804 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m20:34:59.627251 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:59.630100 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:34:59.631162 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:34:59.632178 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:34:59.638255 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:34:59.642435 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m20:34:59.644084 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:34:59.645129 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m20:34:59.652683 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:34:59.656470 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:34:59.531226 => 20:34:59.656155
[0m20:34:59.657767 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:34:59.659540 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d92ffb1-3a27-4004-92f4-c7a8e0518df3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72107d7040b0>]}
[0m20:34:59.660999 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.17s]
[0m20:34:59.663042 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:34:59.664468 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:34:59.665765 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m20:34:59.667330 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m20:34:59.668654 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:34:59.675035 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:34:59.700577 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 20:34:59.669594 => 20:34:59.700112
[0m20:34:59.701968 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:34:59.710243 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:34:59.738062 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:34:59.739728 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m20:34:59.740783 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:34:59.748366 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:34:59.749404 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:34:59.750511 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season

    UNION ALL

    SELECT
        ss.season2,
        'Plus/Minus' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season = ta.season
    JOIN best_team_stats bts ON ss.season = bts.season
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m20:34:59.754464 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column ta.season does not exist
LINE 81:     JOIN team_averages ta ON ss.season2 = ta.season
                                                   ^
HINT:  Perhaps you meant to reference the column "ta.season2".

[0m20:34:59.756094 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: ROLLBACK
[0m20:34:59.758619 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 20:34:59.702909 => 20:34:59.757767
[0m20:34:59.760412 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m20:34:59.771389 [debug] [Thread-1 (]: Database Error in model team_weaknesses_unpivoted (models/spurs_analysis/team_weaknesses_unpivoted.sql)
  column ta.season does not exist
  LINE 81:     JOIN team_averages ta ON ss.season2 = ta.season
                                                     ^
  HINT:  Perhaps you meant to reference the column "ta.season2".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:34:59.773000 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d92ffb1-3a27-4004-92f4-c7a8e0518df3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72107d312d50>]}
[0m20:34:59.774506 [error] [Thread-1 (]: 5 of 6 ERROR creating sql table model gold.team_weaknesses_unpivoted ........... [[31mERROR[0m in 0.11s]
[0m20:34:59.776040 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:34:59.777373 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m20:34:59.779223 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m20:34:59.780990 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m20:34:59.782149 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m20:34:59.791847 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m20:34:59.837112 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 20:34:59.783020 => 20:34:59.836363
[0m20:34:59.839786 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m20:34:59.846497 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m20:34:59.874238 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:34:59.875500 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m20:34:59.876580 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:34:59.883527 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:34:59.884705 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:34:59.885837 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        '3-point shooting' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Rebounding' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Ball Handling' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Points Differential' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plusminus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Points Differential' AS weakness_type,
        player,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_plusminus <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m20:34:59.988623 [debug] [Thread-1 (]: SQL status: SELECT 45 in 0.0 seconds
[0m20:34:59.992582 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:34:59.993671 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m20:34:59.995323 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:34:59.999452 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:35:00.000512 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m20:35:00.002092 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:35:00.007098 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m20:35:00.008603 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:35:00.009593 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m20:35:00.015540 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:35:00.020658 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m20:35:00.022894 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:35:00.024077 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m20:35:00.031019 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:35:00.033531 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 20:34:59.841105 => 20:35:00.033270
[0m20:35:00.034736 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m20:35:00.036612 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d92ffb1-3a27-4004-92f4-c7a8e0518df3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72107d310b60>]}
[0m20:35:00.038689 [info ] [Thread-1 (]: 6 of 6 OK created sql table model gold.players_recommendations ................. [[32mSELECT 45[0m in 0.26s]
[0m20:35:00.040163 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m20:35:00.043701 [debug] [MainThread]: Using postgres connection "master"
[0m20:35:00.044589 [debug] [MainThread]: On master: BEGIN
[0m20:35:00.045486 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:35:00.052347 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:35:00.053608 [debug] [MainThread]: On master: COMMIT
[0m20:35:00.054973 [debug] [MainThread]: Using postgres connection "master"
[0m20:35:00.055895 [debug] [MainThread]: On master: COMMIT
[0m20:35:00.057136 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:35:00.058060 [debug] [MainThread]: On master: Close
[0m20:35:00.059413 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:35:00.060332 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m20:35:00.061229 [info ] [MainThread]: 
[0m20:35:00.062146 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.27 seconds (1.27s).
[0m20:35:00.064300 [debug] [MainThread]: Command end result
[0m20:35:00.126204 [info ] [MainThread]: 
[0m20:35:00.127274 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:35:00.128315 [info ] [MainThread]: 
[0m20:35:00.129250 [error] [MainThread]:   Database Error in model team_weaknesses_unpivoted (models/spurs_analysis/team_weaknesses_unpivoted.sql)
  column ta.season does not exist
  LINE 81:     JOIN team_averages ta ON ss.season2 = ta.season
                                                     ^
  HINT:  Perhaps you meant to reference the column "ta.season2".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:35:00.130230 [info ] [MainThread]: 
[0m20:35:00.131213 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m20:35:00.132925 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.5641217, "process_user_time": 3.916186, "process_kernel_time": 0.38961, "process_mem_max_rss": "201020", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:35:00.133994 [debug] [MainThread]: Command `dbt run` failed at 20:35:00.133820 after 2.57 seconds
[0m20:35:00.134955 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72107f43d970>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72107f2cb7a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72107db4da60>]}
[0m20:35:00.135927 [debug] [MainThread]: Flushing usage events
[0m20:36:18.682239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04c9da0aa0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04ca0ba570>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04ca155220>]}


============================== 20:36:18.686729 | 2f2a72d8-cf10-4085-bbf5-7094d921c52e ==============================
[0m20:36:18.686729 [info ] [MainThread]: Running with dbt=1.7.9
[0m20:36:18.688323 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:36:18.952992 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2f2a72d8-cf10-4085-bbf5-7094d921c52e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04ca051100>]}
[0m20:36:19.075185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2f2a72d8-cf10-4085-bbf5-7094d921c52e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04ca0b9280>]}
[0m20:36:19.076700 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m20:36:19.102769 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m20:36:19.378532 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m20:36:19.379891 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m20:36:19.561790 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m20:36:19.568052 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2f2a72d8-cf10-4085-bbf5-7094d921c52e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04c87fb170>]}
[0m20:36:19.643668 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2f2a72d8-cf10-4085-bbf5-7094d921c52e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04c8fa97c0>]}
[0m20:36:19.644747 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m20:36:19.645761 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2f2a72d8-cf10-4085-bbf5-7094d921c52e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04c8fa8860>]}
[0m20:36:19.648900 [info ] [MainThread]: 
[0m20:36:19.650451 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m20:36:19.653892 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m20:36:19.670907 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m20:36:19.672209 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m20:36:19.673314 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:36:19.684812 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m20:36:19.687773 [debug] [ThreadPool]: On list_nba: Close
[0m20:36:19.691653 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m20:36:19.699326 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:36:19.700349 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m20:36:19.701386 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:36:19.708784 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m20:36:19.709820 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m20:36:19.710875 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m20:36:19.715438 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m20:36:19.717742 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m20:36:19.718962 [debug] [ThreadPool]: On list_nba_gold: Close
[0m20:36:19.727042 [debug] [MainThread]: Using postgres connection "master"
[0m20:36:19.728036 [debug] [MainThread]: On master: BEGIN
[0m20:36:19.728922 [debug] [MainThread]: Opening a new connection, currently in state init
[0m20:36:19.736924 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:36:19.738425 [debug] [MainThread]: Using postgres connection "master"
[0m20:36:19.739448 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m20:36:19.758158 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m20:36:19.760145 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2f2a72d8-cf10-4085-bbf5-7094d921c52e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04c9b9f470>]}
[0m20:36:19.761389 [debug] [MainThread]: On master: ROLLBACK
[0m20:36:19.762703 [debug] [MainThread]: Using postgres connection "master"
[0m20:36:19.763609 [debug] [MainThread]: On master: BEGIN
[0m20:36:19.765304 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:36:19.766300 [debug] [MainThread]: On master: COMMIT
[0m20:36:19.767237 [debug] [MainThread]: Using postgres connection "master"
[0m20:36:19.768180 [debug] [MainThread]: On master: COMMIT
[0m20:36:19.769947 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:36:19.771533 [debug] [MainThread]: On master: Close
[0m20:36:19.773400 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:36:19.774521 [info ] [MainThread]: 
[0m20:36:19.779306 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m20:36:19.780642 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m20:36:19.781996 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m20:36:19.783021 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m20:36:19.796160 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m20:36:19.822124 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 20:36:19.783842 => 20:36:19.821738
[0m20:36:19.823140 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m20:36:19.871217 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m20:36:19.897336 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:36:19.898322 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m20:36:19.899269 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:36:19.906708 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:36:19.907908 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:36:19.909023 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m20:36:19.936857 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m20:36:19.945288 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:36:19.946431 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m20:36:19.947955 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:36:19.952300 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:36:19.954096 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m20:36:19.956199 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:36:19.982009 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:36:19.983087 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:36:19.984032 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m20:36:19.990163 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:36:19.998593 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m20:36:20.008621 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m20:36:20.009737 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m20:36:20.017586 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:36:20.020555 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 20:36:19.823955 => 20:36:20.019919
[0m20:36:20.021986 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m20:36:20.023649 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2f2a72d8-cf10-4085-bbf5-7094d921c52e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04c831c740>]}
[0m20:36:20.024925 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.24s]
[0m20:36:20.026312 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m20:36:20.027472 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m20:36:20.028598 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m20:36:20.029959 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m20:36:20.030946 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m20:36:20.035587 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m20:36:20.062496 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 20:36:20.031768 => 20:36:20.062109
[0m20:36:20.063491 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m20:36:20.069043 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m20:36:20.093947 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:36:20.095049 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m20:36:20.096214 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:36:20.105354 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:36:20.106634 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:36:20.107966 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m20:36:20.129836 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m20:36:20.134381 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:36:20.135479 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m20:36:20.137779 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:36:20.142183 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:36:20.143279 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m20:36:20.144878 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:36:20.147771 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m20:36:20.148753 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:36:20.149672 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m20:36:20.155615 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:36:20.160615 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m20:36:20.162098 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m20:36:20.163070 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m20:36:20.170496 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:36:20.173641 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 20:36:20.064182 => 20:36:20.173334
[0m20:36:20.174695 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m20:36:20.176487 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2f2a72d8-cf10-4085-bbf5-7094d921c52e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04c83b2e70>]}
[0m20:36:20.177972 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.15s]
[0m20:36:20.179965 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m20:36:20.181536 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m20:36:20.182711 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m20:36:20.184241 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m20:36:20.185677 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m20:36:20.191673 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m20:36:20.217442 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 20:36:20.186755 => 20:36:20.217056
[0m20:36:20.218329 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m20:36:20.224785 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m20:36:20.249850 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:36:20.250859 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m20:36:20.251740 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:36:20.259686 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:36:20.260849 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:36:20.261797 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m20:36:20.280722 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m20:36:20.287097 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:36:20.288786 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m20:36:20.290535 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:36:20.294856 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:36:20.296030 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m20:36:20.297654 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:36:20.301273 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:36:20.302592 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:36:20.304200 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m20:36:20.310970 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:36:20.315438 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m20:36:20.317287 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m20:36:20.318462 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m20:36:20.327470 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:36:20.330553 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 20:36:20.219152 => 20:36:20.330097
[0m20:36:20.331782 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m20:36:20.333498 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2f2a72d8-cf10-4085-bbf5-7094d921c52e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04c83b32c0>]}
[0m20:36:20.334863 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m20:36:20.337144 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m20:36:20.338949 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m20:36:20.340084 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m20:36:20.341914 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m20:36:20.343119 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m20:36:20.349558 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m20:36:20.378941 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 20:36:20.344013 => 20:36:20.378540
[0m20:36:20.380056 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m20:36:20.389216 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m20:36:20.417019 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:36:20.418485 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m20:36:20.419830 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:36:20.428190 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:36:20.429491 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:36:20.430768 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m20:36:20.483655 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m20:36:20.491821 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:36:20.493159 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m20:36:20.496530 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:36:20.505430 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:36:20.506798 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m20:36:20.508771 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:36:20.514183 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:36:20.515831 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:36:20.517380 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m20:36:20.524169 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:36:20.530712 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m20:36:20.533594 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m20:36:20.535372 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m20:36:20.543676 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:36:20.546626 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 20:36:20.381307 => 20:36:20.546262
[0m20:36:20.547597 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m20:36:20.549169 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2f2a72d8-cf10-4085-bbf5-7094d921c52e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04c830be00>]}
[0m20:36:20.553116 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.21s]
[0m20:36:20.555282 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m20:36:20.556687 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:36:20.557795 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m20:36:20.559112 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m20:36:20.559988 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:36:20.565815 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:36:20.594583 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 20:36:20.560673 => 20:36:20.593939
[0m20:36:20.595857 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:36:20.606487 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:36:20.630947 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:36:20.632293 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m20:36:20.633448 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:36:20.641641 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:36:20.643408 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:36:20.645097 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Plus/Minus' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m20:36:20.685018 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m20:36:20.690656 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:36:20.691647 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m20:36:20.693112 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:36:20.696002 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m20:36:20.696954 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:36:20.697770 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m20:36:20.702501 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:36:20.707556 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m20:36:20.709390 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m20:36:20.710470 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m20:36:20.711958 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:36:20.714773 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 20:36:20.596923 => 20:36:20.714380
[0m20:36:20.715767 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m20:36:20.717423 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2f2a72d8-cf10-4085-bbf5-7094d921c52e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04c83ec650>]}
[0m20:36:20.718802 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.16s]
[0m20:36:20.721331 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m20:36:20.722540 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m20:36:20.723682 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m20:36:20.725157 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m20:36:20.726135 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m20:36:20.735314 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m20:36:20.755999 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 20:36:20.726844 => 20:36:20.755578
[0m20:36:20.756890 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m20:36:20.761993 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m20:36:20.782474 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:36:20.783358 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m20:36:20.784155 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m20:36:20.790494 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m20:36:20.791406 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:36:20.792494 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        '3-point shooting' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Rebounding' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Ball Handling' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Points Differential' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Steals' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Blocks' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plusminus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        '3-point shooting' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Points Differential' AS weakness_type,
        player,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_plusminus <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebounding' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Ball Handling' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Steals' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Blocks' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m20:36:20.891556 [debug] [Thread-1 (]: SQL status: SELECT 45 in 0.0 seconds
[0m20:36:20.895809 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:36:20.896862 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m20:36:20.898328 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:36:20.902390 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:36:20.904291 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m20:36:20.906378 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m20:36:20.909347 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m20:36:20.910390 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:36:20.911427 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m20:36:20.917615 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m20:36:20.922919 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m20:36:20.924686 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m20:36:20.925826 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m20:36:20.932911 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m20:36:20.935347 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 20:36:20.757527 => 20:36:20.935087
[0m20:36:20.936739 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m20:36:20.938812 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2f2a72d8-cf10-4085-bbf5-7094d921c52e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04c7f01fd0>]}
[0m20:36:20.940141 [info ] [Thread-1 (]: 6 of 6 OK created sql table model gold.players_recommendations ................. [[32mSELECT 45[0m in 0.21s]
[0m20:36:20.941798 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m20:36:20.945303 [debug] [MainThread]: Using postgres connection "master"
[0m20:36:20.946348 [debug] [MainThread]: On master: BEGIN
[0m20:36:20.947251 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m20:36:20.954485 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m20:36:20.955807 [debug] [MainThread]: On master: COMMIT
[0m20:36:20.956794 [debug] [MainThread]: Using postgres connection "master"
[0m20:36:20.957738 [debug] [MainThread]: On master: COMMIT
[0m20:36:20.959018 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m20:36:20.959980 [debug] [MainThread]: On master: Close
[0m20:36:20.961487 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:36:20.962391 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m20:36:20.963466 [info ] [MainThread]: 
[0m20:36:20.964578 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.31 seconds (1.31s).
[0m20:36:20.966670 [debug] [MainThread]: Command end result
[0m20:36:21.026534 [info ] [MainThread]: 
[0m20:36:21.027585 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:36:21.028676 [info ] [MainThread]: 
[0m20:36:21.029661 [info ] [MainThread]: Done. PASS=6 WARN=0 ERROR=0 SKIP=0 TOTAL=6
[0m20:36:21.031224 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.4333544, "process_user_time": 3.710275, "process_kernel_time": 0.427488, "process_mem_max_rss": "201028", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:36:21.032322 [debug] [MainThread]: Command `dbt run` succeeded at 20:36:21.032147 after 2.43 seconds
[0m20:36:21.033399 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04ca075760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04c83baae0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a04c7f08a10>]}
[0m20:36:21.034389 [debug] [MainThread]: Flushing usage events
[0m21:55:15.864930 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92ceba1b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92ceb8e30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92ceba3f0>]}


============================== 21:55:15.869915 | e9e4a55e-96fb-4d29-95f5-453c1474e240 ==============================
[0m21:55:15.869915 [info ] [MainThread]: Running with dbt=1.7.9
[0m21:55:15.871268 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m21:55:16.277418 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e9e4a55e-96fb-4d29-95f5-453c1474e240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92cd1d550>]}
[0m21:55:16.399186 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e9e4a55e-96fb-4d29-95f5-453c1474e240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92e20bda0>]}
[0m21:55:16.400548 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m21:55:16.428716 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m21:55:16.702330 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:55:16.703751 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m21:55:16.918226 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m21:55:16.927798 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e9e4a55e-96fb-4d29-95f5-453c1474e240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92c11ad50>]}
[0m21:55:17.011275 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e9e4a55e-96fb-4d29-95f5-453c1474e240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92c1a9790>]}
[0m21:55:17.012386 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m21:55:17.013367 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e9e4a55e-96fb-4d29-95f5-453c1474e240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92c1a8650>]}
[0m21:55:17.016347 [info ] [MainThread]: 
[0m21:55:17.017782 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:55:17.020258 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m21:55:17.034633 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m21:55:17.035860 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m21:55:17.036837 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:55:17.050173 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m21:55:17.052523 [debug] [ThreadPool]: On list_nba: Close
[0m21:55:17.056363 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m21:55:17.065963 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:55:17.066994 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m21:55:17.067977 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:55:17.075889 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:55:17.077658 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m21:55:17.078743 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m21:55:17.085334 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.0 seconds
[0m21:55:17.088725 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m21:55:17.090258 [debug] [ThreadPool]: On list_nba_gold: Close
[0m21:55:17.101929 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:17.103636 [debug] [MainThread]: On master: BEGIN
[0m21:55:17.104621 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:55:17.112802 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:55:17.113939 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:17.115136 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:55:17.138323 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m21:55:17.140348 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e9e4a55e-96fb-4d29-95f5-453c1474e240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92c1a9400>]}
[0m21:55:17.141310 [debug] [MainThread]: On master: ROLLBACK
[0m21:55:17.143128 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:17.144924 [debug] [MainThread]: On master: BEGIN
[0m21:55:17.146903 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:55:17.148134 [debug] [MainThread]: On master: COMMIT
[0m21:55:17.149185 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:17.150383 [debug] [MainThread]: On master: COMMIT
[0m21:55:17.151992 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:55:17.153035 [debug] [MainThread]: On master: Close
[0m21:55:17.154868 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:55:17.157127 [info ] [MainThread]: 
[0m21:55:17.162935 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m21:55:17.164458 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m21:55:17.166505 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m21:55:17.167663 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m21:55:17.181150 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m21:55:17.207550 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 21:55:17.168550 => 21:55:17.207152
[0m21:55:17.208624 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m21:55:17.268518 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m21:55:17.313945 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:17.320922 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m21:55:17.321866 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:55:17.333063 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:55:17.336948 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:17.338573 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m21:55:17.390498 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m21:55:17.400482 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:17.401485 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m21:55:17.403606 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:17.408407 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:17.409766 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m21:55:17.411980 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:17.438287 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:55:17.439407 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:17.440330 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m21:55:17.446574 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:55:17.454939 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m21:55:17.473437 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m21:55:17.475315 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m21:55:17.491139 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:55:17.494112 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 21:55:17.209565 => 21:55:17.493823
[0m21:55:17.495192 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m21:55:17.496703 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9e4a55e-96fb-4d29-95f5-453c1474e240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92b5106e0>]}
[0m21:55:17.499412 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.33s]
[0m21:55:17.500683 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m21:55:17.501701 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m21:55:17.502727 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m21:55:17.504202 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m21:55:17.505497 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m21:55:17.512467 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m21:55:17.536836 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 21:55:17.506175 => 21:55:17.536436
[0m21:55:17.537809 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m21:55:17.544121 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m21:55:17.566632 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m21:55:17.567777 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m21:55:17.568712 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:55:17.575279 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:55:17.576769 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m21:55:17.577976 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m21:55:17.598878 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:55:17.605618 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m21:55:17.606739 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m21:55:17.608637 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:17.614269 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m21:55:17.617086 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m21:55:17.620586 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:17.623608 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m21:55:17.624833 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m21:55:17.626333 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m21:55:17.632726 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:55:17.637890 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m21:55:17.639434 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m21:55:17.640407 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m21:55:17.648149 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:55:17.650560 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 21:55:17.538549 => 21:55:17.650291
[0m21:55:17.651658 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m21:55:17.653315 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9e4a55e-96fb-4d29-95f5-453c1474e240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92b5b7140>]}
[0m21:55:17.656493 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.15s]
[0m21:55:17.657906 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m21:55:17.659400 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m21:55:17.661538 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m21:55:17.663628 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m21:55:17.664897 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m21:55:17.669717 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m21:55:17.695276 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 21:55:17.665861 => 21:55:17.694622
[0m21:55:17.696536 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m21:55:17.702628 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m21:55:17.730286 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:17.731342 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m21:55:17.732302 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:55:17.739535 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:55:17.740883 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:17.745888 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m21:55:17.777177 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m21:55:17.782357 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:17.783671 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m21:55:17.785722 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:17.791733 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:17.793116 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m21:55:17.795468 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:17.799177 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:55:17.800444 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:17.801512 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m21:55:17.807656 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:55:17.813302 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m21:55:17.815227 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m21:55:17.816289 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m21:55:17.823352 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:55:17.828353 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 21:55:17.697346 => 21:55:17.827673
[0m21:55:17.829636 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m21:55:17.831564 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9e4a55e-96fb-4d29-95f5-453c1474e240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92b5b6ed0>]}
[0m21:55:17.835101 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.17s]
[0m21:55:17.837152 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m21:55:17.838765 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m21:55:17.840006 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m21:55:17.841464 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m21:55:17.843048 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m21:55:17.849717 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m21:55:17.880168 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 21:55:17.844483 => 21:55:17.879476
[0m21:55:17.885544 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m21:55:17.901625 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m21:55:17.929617 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:17.930862 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m21:55:17.932079 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:55:17.938709 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:55:17.939716 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:17.940682 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m21:55:17.974302 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:55:17.979900 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:17.980967 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m21:55:17.982805 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:17.987808 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:17.988868 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m21:55:17.990629 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:17.994937 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:55:17.996017 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:17.996947 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m21:55:18.002560 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:55:18.006850 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m21:55:18.008369 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m21:55:18.009508 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m21:55:18.017131 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:55:18.020252 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 21:55:17.888291 => 21:55:18.019775
[0m21:55:18.026597 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m21:55:18.030758 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9e4a55e-96fb-4d29-95f5-453c1474e240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92b50fd70>]}
[0m21:55:18.033820 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.19s]
[0m21:55:18.040318 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m21:55:18.042841 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m21:55:18.044395 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m21:55:18.046044 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m21:55:18.047226 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m21:55:18.052985 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m21:55:18.081725 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 21:55:18.048045 => 21:55:18.081317
[0m21:55:18.082792 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m21:55:18.090351 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m21:55:18.120322 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m21:55:18.121382 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m21:55:18.122352 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:55:18.130006 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:55:18.131274 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m21:55:18.132402 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Plus/Minus' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m21:55:18.179230 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m21:55:18.184456 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m21:55:18.185667 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m21:55:18.187558 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:18.192617 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m21:55:18.194364 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m21:55:18.195976 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:18.199131 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m21:55:18.200189 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m21:55:18.201157 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m21:55:18.207267 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:55:18.212063 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m21:55:18.213855 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m21:55:18.215261 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m21:55:18.222676 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:55:18.226911 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 21:55:18.083630 => 21:55:18.226091
[0m21:55:18.228384 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m21:55:18.230480 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9e4a55e-96fb-4d29-95f5-453c1474e240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92b10c5c0>]}
[0m21:55:18.231863 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.18s]
[0m21:55:18.233229 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m21:55:18.234338 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m21:55:18.235372 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m21:55:18.236809 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m21:55:18.237868 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m21:55:18.247864 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m21:55:18.272999 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 21:55:18.238609 => 21:55:18.272592
[0m21:55:18.273909 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m21:55:18.280160 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m21:55:18.313203 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:55:18.316869 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m21:55:18.317814 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:55:18.328561 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:55:18.329850 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:55:18.331256 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses AS (
    SELECT
        season2,
        'Porcentaje de tres' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg3_pct_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Porcentaje de tiro de campo' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE fg_pct_rating_vs_league = 'Debilidad'

    UNION ALL


    SELECT
        season2,
        'Rebotes' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE rebounds_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Pérdidas de balón' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE turnovers_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Diferencial Puntos' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE plus_minus_rating_vs_league = 'Debilidad'
    
    UNION ALL

    SELECT
        season2,
        'Robos' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE steals_rating_vs_league = 'Debilidad'

    UNION ALL

    SELECT
        season2,
        'Bloqueos' AS weakness_type
    FROM "nba"."gold"."team_weaknesses"
    WHERE blocks_rating_vs_league = 'Debilidad'
),

player_stats as (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."player_stats" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

player_stats_avg as (
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min::numeric) AS avg_min,
    AVG(fgm::numeric) AS avg_fgm,
    AVG(fga::numeric) AS avg_fga,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3m::numeric) AS avg_fg3m,
    AVG(fg3a::numeric) AS avg_fg3a,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(ftm::numeric) AS avg_ftm,
    AVG(fta::numeric) AS avg_fta,
    AVG(ft_pct::numeric) AS avg_ft_pct,
    AVG(oreb::numeric) AS avg_oreb,
    AVG(dreb::numeric) AS avg_dreb,
    AVG(reb::numeric) AS avg_reb,
    AVG(ast::numeric) AS avg_ast,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM player_stats
GROUP BY player_id, player_name, team_abbreviation
),



ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player,
        p.position,
        case when fa.player_id is null then FALSE else TRUE end as is_free_agent,
        case when I.player_id is null then FALSE else TRUE end as  is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg3_pct,
        pgs.avg_fg_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov, -- Menos pérdidas es mejor
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plusminus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_avg AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    -- Filtra a los jugadores con estadísticas 
    --puede ser agentes libres o no y pueden estar lesionados o no.
    
),

top_targets AS (
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de campo.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'G-F', 'F')


    UNION ALL



    SELECT
        'Diferencial Puntos' AS weakness_type,
        player,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar un jugador que haga diferencia.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_plusminus <= 3 --AND position IN ('G', 'G-F', 'F')


    UNION ALL

    SELECT
        'Rebotes' AS weakness_type,
        player,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Pérdidas de balón' AS weakness_type,
        player,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Robos' AS weakness_type,
        player,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Bloqueos' AS weakness_type,
        player,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason,
        is_free_agent,
        is_injured
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
)


SELECT
    sw.season2,
    tt.weakness_type,
    tt.player AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses sw
JOIN top_targets tt ON sw.weakness_type = tt.weakness_type
ORDER BY sw.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m21:55:18.542376 [debug] [Thread-1 (]: SQL status: SELECT 54 in 0.0 seconds
[0m21:55:18.547741 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:55:18.548931 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m21:55:18.550427 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:18.554419 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:55:18.555534 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m21:55:18.556917 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:55:18.560295 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m21:55:18.561581 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:55:18.562561 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m21:55:18.575683 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:55:18.580394 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m21:55:18.582956 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m21:55:18.584036 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m21:55:18.594014 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:55:18.597903 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 21:55:18.274760 => 21:55:18.597611
[0m21:55:18.598922 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m21:55:18.601375 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9e4a55e-96fb-4d29-95f5-453c1474e240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92b107320>]}
[0m21:55:18.605903 [info ] [Thread-1 (]: 6 of 6 OK created sql table model gold.players_recommendations ................. [[32mSELECT 54[0m in 0.36s]
[0m21:55:18.607433 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m21:55:18.610944 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:18.612067 [debug] [MainThread]: On master: BEGIN
[0m21:55:18.613011 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:55:18.619919 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:55:18.621042 [debug] [MainThread]: On master: COMMIT
[0m21:55:18.621916 [debug] [MainThread]: Using postgres connection "master"
[0m21:55:18.622885 [debug] [MainThread]: On master: COMMIT
[0m21:55:18.624134 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:55:18.625288 [debug] [MainThread]: On master: Close
[0m21:55:18.627585 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:55:18.628632 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m21:55:18.629737 [info ] [MainThread]: 
[0m21:55:18.630805 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.61 seconds (1.61s).
[0m21:55:18.633308 [debug] [MainThread]: Command end result
[0m21:55:18.693035 [info ] [MainThread]: 
[0m21:55:18.694193 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:55:18.695279 [info ] [MainThread]: 
[0m21:55:18.696355 [info ] [MainThread]: Done. PASS=6 WARN=0 ERROR=0 SKIP=0 TOTAL=6
[0m21:55:18.698788 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.924885, "process_user_time": 4.131543, "process_kernel_time": 1.024816, "process_mem_max_rss": "201032", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:55:18.700051 [debug] [MainThread]: Command `dbt run` succeeded at 21:55:18.699857 after 2.93 seconds
[0m21:55:18.700989 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92cf8bd10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92d267bc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f92d289e20>]}
[0m21:55:18.701889 [debug] [MainThread]: Flushing usage events
[0m22:40:45.245463 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0ddffbec0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0e01327e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0ddffabd0>]}


============================== 22:40:45.250827 | e3e0ba2d-4de3-4399-9b1c-b5dffa69ac30 ==============================
[0m22:40:45.250827 [info ] [MainThread]: Running with dbt=1.7.9
[0m22:40:45.251918 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m22:40:45.601875 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e3e0ba2d-4de3-4399-9b1c-b5dffa69ac30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0dee4f2c0>]}
[0m22:40:45.749917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e3e0ba2d-4de3-4399-9b1c-b5dffa69ac30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0ddffa630>]}
[0m22:40:45.752434 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m22:40:45.787946 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m22:40:46.192211 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m22:40:46.194057 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m22:40:46.195213 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m22:40:46.413573 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m22:40:46.419989 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e3e0ba2d-4de3-4399-9b1c-b5dffa69ac30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0dc7a61e0>]}
[0m22:40:46.496613 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e3e0ba2d-4de3-4399-9b1c-b5dffa69ac30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0dcfa8b00>]}
[0m22:40:46.497744 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m22:40:46.498913 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e3e0ba2d-4de3-4399-9b1c-b5dffa69ac30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0dcbf5730>]}
[0m22:40:46.502257 [info ] [MainThread]: 
[0m22:40:46.504183 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:40:46.507792 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m22:40:46.523820 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m22:40:46.525222 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m22:40:46.526911 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:46.538702 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m22:40:46.540748 [debug] [ThreadPool]: On list_nba: Close
[0m22:40:46.544924 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m22:40:46.556344 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m22:40:46.557469 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m22:40:46.558902 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:40:46.567482 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m22:40:46.568594 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m22:40:46.569595 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m22:40:46.577458 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.0 seconds
[0m22:40:46.579738 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m22:40:46.581017 [debug] [ThreadPool]: On list_nba_gold: Close
[0m22:40:46.589509 [debug] [MainThread]: Using postgres connection "master"
[0m22:40:46.590880 [debug] [MainThread]: On master: BEGIN
[0m22:40:46.592244 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:40:46.600405 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:40:46.601605 [debug] [MainThread]: Using postgres connection "master"
[0m22:40:46.602753 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:40:46.630125 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m22:40:46.632588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e3e0ba2d-4de3-4399-9b1c-b5dffa69ac30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0dc7f3c80>]}
[0m22:40:46.633729 [debug] [MainThread]: On master: ROLLBACK
[0m22:40:46.635148 [debug] [MainThread]: Using postgres connection "master"
[0m22:40:46.636178 [debug] [MainThread]: On master: BEGIN
[0m22:40:46.638011 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:40:46.639098 [debug] [MainThread]: On master: COMMIT
[0m22:40:46.640043 [debug] [MainThread]: Using postgres connection "master"
[0m22:40:46.640987 [debug] [MainThread]: On master: COMMIT
[0m22:40:46.643257 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:40:46.644506 [debug] [MainThread]: On master: Close
[0m22:40:46.646353 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:40:46.647554 [info ] [MainThread]: 
[0m22:40:46.652907 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m22:40:46.654162 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m22:40:46.655747 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m22:40:46.656743 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m22:40:46.668299 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m22:40:46.696282 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 22:40:46.657501 => 22:40:46.695871
[0m22:40:46.697488 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m22:40:46.748056 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m22:40:46.776512 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:40:46.777678 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m22:40:46.778711 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:40:46.786744 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:40:46.787860 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:40:46.789082 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m22:40:46.845747 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m22:40:46.853891 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:40:46.855031 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m22:40:46.857051 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:40:46.862387 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:40:46.863375 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m22:40:46.864935 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:40:46.891241 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:40:46.893418 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:40:46.894397 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:40:46.901283 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:40:46.911553 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m22:40:46.919411 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:40:46.920403 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m22:40:46.930231 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:40:46.932629 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 22:40:46.698351 => 22:40:46.932363
[0m22:40:46.933698 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m22:40:46.935366 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3e0ba2d-4de3-4399-9b1c-b5dffa69ac30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0dc310a70>]}
[0m22:40:46.936749 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.28s]
[0m22:40:46.938251 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m22:40:46.939542 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m22:40:46.940787 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m22:40:46.942693 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m22:40:46.943688 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m22:40:46.948668 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m22:40:46.976283 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 22:40:46.944360 => 22:40:46.975793
[0m22:40:46.977331 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m22:40:46.982750 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m22:40:47.009726 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:40:47.010890 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m22:40:47.011926 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:40:47.018702 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:40:47.019840 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:40:47.020981 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m22:40:47.039338 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:40:47.044804 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:40:47.045990 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m22:40:47.048145 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:40:47.052570 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:40:47.053803 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m22:40:47.055282 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:40:47.059732 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m22:40:47.061130 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:40:47.062647 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m22:40:47.068714 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:40:47.075949 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m22:40:47.078197 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:40:47.079483 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m22:40:47.087794 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:40:47.090321 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 22:40:46.978380 => 22:40:47.090051
[0m22:40:47.092147 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m22:40:47.095190 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3e0ba2d-4de3-4399-9b1c-b5dffa69ac30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0dc3d0440>]}
[0m22:40:47.097524 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.15s]
[0m22:40:47.099126 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m22:40:47.100510 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m22:40:47.102089 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m22:40:47.103947 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m22:40:47.105109 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m22:40:47.112293 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m22:40:47.141543 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 22:40:47.106560 => 22:40:47.140757
[0m22:40:47.143053 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m22:40:47.148800 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m22:40:47.173325 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:40:47.174547 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m22:40:47.176078 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:40:47.183484 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:40:47.184663 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:40:47.185978 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m22:40:47.204672 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m22:40:47.210459 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:40:47.211709 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m22:40:47.213824 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:40:47.220241 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:40:47.221404 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m22:40:47.223000 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:40:47.227258 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:40:47.228410 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:40:47.229486 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:40:47.235655 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:40:47.239418 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m22:40:47.240854 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:40:47.242689 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m22:40:47.250408 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:40:47.252882 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 22:40:47.143952 => 22:40:47.252622
[0m22:40:47.253921 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m22:40:47.255701 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3e0ba2d-4de3-4399-9b1c-b5dffa69ac30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0dc3b6360>]}
[0m22:40:47.256993 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m22:40:47.258995 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m22:40:47.260467 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m22:40:47.261815 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m22:40:47.263182 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m22:40:47.264250 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m22:40:47.270215 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m22:40:47.298186 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 22:40:47.265236 => 22:40:47.297800
[0m22:40:47.299245 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m22:40:47.304737 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m22:40:47.332930 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:40:47.333968 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m22:40:47.335007 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:40:47.342096 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:40:47.343266 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:40:47.344454 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m22:40:47.378422 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:40:47.382859 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:40:47.383914 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m22:40:47.385436 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:40:47.389835 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:40:47.391255 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m22:40:47.393979 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:40:47.397022 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m22:40:47.398116 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:40:47.399099 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m22:40:47.405289 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:40:47.410801 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m22:40:47.412372 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:40:47.413501 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m22:40:47.421188 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:40:47.424068 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 22:40:47.300072 => 22:40:47.423751
[0m22:40:47.425332 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m22:40:47.427671 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3e0ba2d-4de3-4399-9b1c-b5dffa69ac30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0dc3084a0>]}
[0m22:40:47.428908 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.16s]
[0m22:40:47.430120 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m22:40:47.431279 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:40:47.432369 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m22:40:47.433869 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m22:40:47.434886 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:40:47.440334 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:40:47.466779 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 22:40:47.435693 => 22:40:47.466389
[0m22:40:47.467873 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:40:47.475613 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:40:47.501327 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:40:47.502343 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m22:40:47.503232 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:40:47.510014 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:40:47.511141 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:40:47.512324 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m22:40:47.546285 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m22:40:47.551843 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:40:47.553050 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m22:40:47.555150 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:40:47.561255 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:40:47.562719 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m22:40:47.564309 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:40:47.567869 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m22:40:47.568952 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:40:47.569955 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m22:40:47.576120 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:40:47.580187 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m22:40:47.581898 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:40:47.582853 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m22:40:47.590236 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:40:47.593663 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 22:40:47.468621 => 22:40:47.593121
[0m22:40:47.594830 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m22:40:47.596470 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3e0ba2d-4de3-4399-9b1c-b5dffa69ac30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0dbf051c0>]}
[0m22:40:47.597810 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.16s]
[0m22:40:47.599297 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:40:47.601124 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m22:40:47.602393 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m22:40:47.603780 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m22:40:47.604786 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m22:40:47.612714 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m22:40:47.640120 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 22:40:47.605678 => 22:40:47.639488
[0m22:40:47.641650 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m22:40:47.647796 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m22:40:47.672692 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:40:47.674163 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m22:40:47.675382 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:40:47.682138 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:40:47.683212 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:40:47.684349 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    LEFT JOIN "nba"."silver"."player_stats" AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    WHERE 
        fa.player_id IS NOT NULL
        AND i.player_id IS NULL
        AND pgs.player_id IS NOT NULL
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')

    UNION ALL

    SELECT
        'Rebotes' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Robos' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Bloqueos' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    
    UNION ALL
    
    SELECT
        'Diferencial de puntos' AS weakness_type,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m22:40:47.688195 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column pgs.avg_fg_pct does not exist
LINE 30:         pgs.avg_fg_pct,
                 ^

[0m22:40:47.689285 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m22:40:47.690992 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 22:40:47.642732 => 22:40:47.690683
[0m22:40:47.692597 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m22:40:47.700618 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column pgs.avg_fg_pct does not exist
  LINE 30:         pgs.avg_fg_pct,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m22:40:47.701799 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3e0ba2d-4de3-4399-9b1c-b5dffa69ac30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0dbf0c3b0>]}
[0m22:40:47.703018 [error] [Thread-1 (]: 6 of 6 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m22:40:47.704428 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m22:40:47.709166 [debug] [MainThread]: Using postgres connection "master"
[0m22:40:47.710449 [debug] [MainThread]: On master: BEGIN
[0m22:40:47.711434 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:40:47.719016 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:40:47.720109 [debug] [MainThread]: On master: COMMIT
[0m22:40:47.721075 [debug] [MainThread]: Using postgres connection "master"
[0m22:40:47.722000 [debug] [MainThread]: On master: COMMIT
[0m22:40:47.723186 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:40:47.724080 [debug] [MainThread]: On master: Close
[0m22:40:47.726199 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:40:47.727400 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m22:40:47.728552 [info ] [MainThread]: 
[0m22:40:47.729639 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.22 seconds (1.22s).
[0m22:40:47.732061 [debug] [MainThread]: Command end result
[0m22:40:47.796621 [info ] [MainThread]: 
[0m22:40:47.797624 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:40:47.798534 [info ] [MainThread]: 
[0m22:40:47.799412 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column pgs.avg_fg_pct does not exist
  LINE 30:         pgs.avg_fg_pct,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m22:40:47.800319 [info ] [MainThread]: 
[0m22:40:47.801270 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m22:40:47.803287 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.6476252, "process_user_time": 3.915087, "process_kernel_time": 0.893617, "process_mem_max_rss": "201032", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m22:40:47.804413 [debug] [MainThread]: Command `dbt run` failed at 22:40:47.804227 after 2.65 seconds
[0m22:40:47.805430 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0de5192e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0ddff9160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72d0dcffd7c0>]}
[0m22:40:47.806477 [debug] [MainThread]: Flushing usage events
[0m22:50:54.127524 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e349c682090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e349ca51d00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e349c683500>]}


============================== 22:50:54.133033 | db81c2e3-9f1e-485a-873e-da3d713c2565 ==============================
[0m22:50:54.133033 [info ] [MainThread]: Running with dbt=1.7.9
[0m22:50:54.134703 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m22:50:54.424835 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'db81c2e3-9f1e-485a-873e-da3d713c2565', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e349ca02330>]}
[0m22:50:54.552576 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'db81c2e3-9f1e-485a-873e-da3d713c2565', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e349d925b80>]}
[0m22:50:54.554085 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m22:50:54.577869 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m22:50:54.851019 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:50:54.852328 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m22:50:55.053643 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m22:50:55.061892 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'db81c2e3-9f1e-485a-873e-da3d713c2565', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e349abf3260>]}
[0m22:50:55.138007 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'db81c2e3-9f1e-485a-873e-da3d713c2565', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e349b369550>]}
[0m22:50:55.139116 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m22:50:55.140462 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'db81c2e3-9f1e-485a-873e-da3d713c2565', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e349b766960>]}
[0m22:50:55.143789 [info ] [MainThread]: 
[0m22:50:55.145256 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:50:55.148177 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m22:50:55.169671 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m22:50:55.171081 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m22:50:55.171983 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:50:55.182460 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m22:50:55.184584 [debug] [ThreadPool]: On list_nba: Close
[0m22:50:55.188242 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m22:50:55.196932 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m22:50:55.198422 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m22:50:55.199973 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:50:55.208301 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m22:50:55.209398 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m22:50:55.210381 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m22:50:55.216556 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.0 seconds
[0m22:50:55.218937 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m22:50:55.220351 [debug] [ThreadPool]: On list_nba_gold: Close
[0m22:50:55.231227 [debug] [MainThread]: Using postgres connection "master"
[0m22:50:55.233296 [debug] [MainThread]: On master: BEGIN
[0m22:50:55.235393 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:50:55.246622 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:50:55.248161 [debug] [MainThread]: Using postgres connection "master"
[0m22:50:55.250241 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:50:55.316476 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m22:50:55.320048 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'db81c2e3-9f1e-485a-873e-da3d713c2565', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e349b3bcfe0>]}
[0m22:50:55.322364 [debug] [MainThread]: On master: ROLLBACK
[0m22:50:55.326871 [debug] [MainThread]: Using postgres connection "master"
[0m22:50:55.329649 [debug] [MainThread]: On master: BEGIN
[0m22:50:55.331831 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:50:55.333531 [debug] [MainThread]: On master: COMMIT
[0m22:50:55.334882 [debug] [MainThread]: Using postgres connection "master"
[0m22:50:55.336516 [debug] [MainThread]: On master: COMMIT
[0m22:50:55.338620 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:50:55.340824 [debug] [MainThread]: On master: Close
[0m22:50:55.344096 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:50:55.346812 [info ] [MainThread]: 
[0m22:50:55.359527 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m22:50:55.361182 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m22:50:55.363678 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m22:50:55.366011 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m22:50:55.392687 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m22:50:55.421148 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 22:50:55.367123 => 22:50:55.420663
[0m22:50:55.422527 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m22:50:55.483114 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m22:50:55.502246 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:50:55.503139 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m22:50:55.504059 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:50:55.511181 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:50:55.512197 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:50:55.513373 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m22:50:55.536355 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m22:50:55.545460 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:50:55.546532 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m22:50:55.548437 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:50:55.552835 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:50:55.553922 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m22:50:55.555660 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:50:55.582164 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:50:55.583208 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:50:55.584288 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:50:55.590802 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:50:55.599452 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m22:50:55.612109 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:50:55.613271 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m22:50:55.625162 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:50:55.629973 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 22:50:55.424122 => 22:50:55.629191
[0m22:50:55.631426 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m22:50:55.635188 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'db81c2e3-9f1e-485a-873e-da3d713c2565', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e349cac6b70>]}
[0m22:50:55.636981 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.27s]
[0m22:50:55.639399 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m22:50:55.641568 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m22:50:55.642889 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m22:50:55.644462 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m22:50:55.645895 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m22:50:55.653323 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m22:50:55.684997 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 22:50:55.647239 => 22:50:55.684270
[0m22:50:55.686455 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m22:50:55.694069 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m22:50:55.719245 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:50:55.720206 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m22:50:55.721088 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:50:55.728784 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:50:55.729801 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:50:55.731108 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m22:50:55.751811 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:50:55.757220 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:50:55.758807 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m22:50:55.760613 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:50:55.765555 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:50:55.766880 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m22:50:55.768785 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:50:55.772386 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m22:50:55.773933 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:50:55.775692 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m22:50:55.781518 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:50:55.787318 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m22:50:55.789075 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:50:55.790326 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m22:50:55.797448 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:50:55.800113 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 22:50:55.687417 => 22:50:55.799747
[0m22:50:55.801143 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m22:50:55.802940 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'db81c2e3-9f1e-485a-873e-da3d713c2565', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e349a777350>]}
[0m22:50:55.804331 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.16s]
[0m22:50:55.805681 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m22:50:55.807422 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m22:50:55.809160 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m22:50:55.810807 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m22:50:55.811723 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m22:50:55.816208 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m22:50:55.838093 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 22:50:55.812454 => 22:50:55.837628
[0m22:50:55.839145 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m22:50:55.845053 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m22:50:55.869103 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:50:55.870251 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m22:50:55.871249 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:50:55.878594 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:50:55.879617 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:50:55.880532 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m22:50:55.898829 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m22:50:55.903187 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:50:55.904211 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m22:50:55.905663 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:50:55.910540 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:50:55.911526 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m22:50:55.913025 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:50:55.915957 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:50:55.916962 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:50:55.917853 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:50:55.924176 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:50:55.928901 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m22:50:55.930491 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:50:55.931479 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m22:50:55.938409 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:50:55.941627 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 22:50:55.840168 => 22:50:55.941343
[0m22:50:55.942759 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m22:50:55.944336 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'db81c2e3-9f1e-485a-873e-da3d713c2565', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e349a7765d0>]}
[0m22:50:55.945485 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.13s]
[0m22:50:55.947091 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m22:50:55.948476 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m22:50:55.949511 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m22:50:55.950787 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m22:50:55.951767 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m22:50:55.957258 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m22:50:55.984695 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 22:50:55.952507 => 22:50:55.984311
[0m22:50:55.985700 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m22:50:55.992202 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m22:50:56.019434 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:50:56.020893 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m22:50:56.022097 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:50:56.032312 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:50:56.033525 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:50:56.034852 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m22:50:56.072154 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:50:56.077605 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:50:56.078761 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m22:50:56.080430 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:50:56.086021 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:50:56.087727 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m22:50:56.090520 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:50:56.095297 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m22:50:56.096404 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:50:56.097531 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m22:50:56.103237 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:50:56.108545 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m22:50:56.110370 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:50:56.111738 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m22:50:56.119781 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:50:56.122522 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 22:50:55.986575 => 22:50:56.122235
[0m22:50:56.124035 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m22:50:56.126074 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'db81c2e3-9f1e-485a-873e-da3d713c2565', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e349ab9ad80>]}
[0m22:50:56.127681 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.18s]
[0m22:50:56.129466 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m22:50:56.130554 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:50:56.131627 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m22:50:56.132985 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m22:50:56.134129 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:50:56.140865 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:50:56.169142 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 22:50:56.134973 => 22:50:56.168751
[0m22:50:56.170303 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:50:56.178463 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:50:56.204902 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:50:56.206051 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m22:50:56.208153 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:50:56.215951 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:50:56.217215 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:50:56.218527 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m22:50:56.252137 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m22:50:56.258356 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:50:56.259518 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m22:50:56.261001 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:50:56.265131 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:50:56.266252 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m22:50:56.268175 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:50:56.271549 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m22:50:56.272691 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:50:56.274397 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m22:50:56.280688 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:50:56.284597 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m22:50:56.286370 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:50:56.287946 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m22:50:56.296163 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:50:56.298798 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 22:50:56.171171 => 22:50:56.298529
[0m22:50:56.299812 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m22:50:56.302094 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'db81c2e3-9f1e-485a-873e-da3d713c2565', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e349ab99700>]}
[0m22:50:56.303392 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.17s]
[0m22:50:56.304766 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:50:56.308054 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m22:50:56.309298 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m22:50:56.310723 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m22:50:56.311701 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m22:50:56.317975 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m22:50:56.347118 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 22:50:56.312495 => 22:50:56.346610
[0m22:50:56.348262 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m22:50:56.353696 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m22:50:56.380436 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:50:56.381460 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m22:50:56.382397 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:50:56.389653 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:50:56.391129 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:50:56.392461 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

WITH player_stats_game as (

SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min) AS avg_min,
    AVG(fg_pct) AS avg_fg_pct,  -- Esta es la columna que falta
    AVG(fg3_pct) AS avg_fg3_pct,
    AVG(reb) AS avg_reb,
    AVG(tov) AS avg_tov,
    AVG(stl) AS avg_stl,
    AVG(blk) AS avg_blk,
    AVG(plus_minus) AS avg_plus_minus
FROM "nba"."silver"."player_stats"
GROUP BY player_id, player_name, team_abbreviation
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_game AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')

    UNION ALL

    SELECT
        'Rebotes' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Robos' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Bloqueos' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    
    UNION ALL
    
    SELECT
        'Diferencial de puntos' AS weakness_type,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m22:50:56.394541 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "WITH"
LINE 22: WITH player_stats_game as (
         ^

[0m22:50:56.395528 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m22:50:56.397055 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 22:50:56.349074 => 22:50:56.396736
[0m22:50:56.398102 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m22:50:56.404366 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "WITH"
  LINE 22: WITH player_stats_game as (
           ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m22:50:56.405563 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'db81c2e3-9f1e-485a-873e-da3d713c2565', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e349a7c5dc0>]}
[0m22:50:56.407822 [error] [Thread-1 (]: 6 of 6 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m22:50:56.409861 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m22:50:56.415686 [debug] [MainThread]: Using postgres connection "master"
[0m22:50:56.417069 [debug] [MainThread]: On master: BEGIN
[0m22:50:56.418089 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:50:56.425553 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:50:56.426586 [debug] [MainThread]: On master: COMMIT
[0m22:50:56.427733 [debug] [MainThread]: Using postgres connection "master"
[0m22:50:56.428680 [debug] [MainThread]: On master: COMMIT
[0m22:50:56.429911 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:50:56.430953 [debug] [MainThread]: On master: Close
[0m22:50:56.432339 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:50:56.433442 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m22:50:56.435138 [info ] [MainThread]: 
[0m22:50:56.436445 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.29 seconds (1.29s).
[0m22:50:56.439209 [debug] [MainThread]: Command end result
[0m22:50:56.503094 [info ] [MainThread]: 
[0m22:50:56.504212 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:50:56.505137 [info ] [MainThread]: 
[0m22:50:56.506105 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "WITH"
  LINE 22: WITH player_stats_game as (
           ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m22:50:56.508014 [info ] [MainThread]: 
[0m22:50:56.509168 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m22:50:56.510833 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.4763217, "process_user_time": 3.981859, "process_kernel_time": 0.500233, "process_mem_max_rss": "201028", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m22:50:56.512061 [debug] [MainThread]: Command `dbt run` failed at 22:50:56.511858 after 2.48 seconds
[0m22:50:56.513081 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e349ca51580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e34a0eead20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e349b7d9a30>]}
[0m22:50:56.514124 [debug] [MainThread]: Flushing usage events
[0m22:53:03.415951 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71629a126270>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71629a22a570>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71629a127c80>]}


============================== 22:53:03.424176 | 2732cd9e-d23d-47ed-bb2f-84046aba562f ==============================
[0m22:53:03.424176 [info ] [MainThread]: Running with dbt=1.7.9
[0m22:53:03.425586 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:53:03.797948 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2732cd9e-d23d-47ed-bb2f-84046aba562f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71629a4f5a30>]}
[0m22:53:03.975749 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2732cd9e-d23d-47ed-bb2f-84046aba562f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x716299f892b0>]}
[0m22:53:03.977696 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m22:53:04.005897 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m22:53:04.411711 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:53:04.412819 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m22:53:04.689757 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m22:53:04.696496 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2732cd9e-d23d-47ed-bb2f-84046aba562f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x716298f482c0>]}
[0m22:53:04.779777 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2732cd9e-d23d-47ed-bb2f-84046aba562f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7162997b4d70>]}
[0m22:53:04.780839 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m22:53:04.782126 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2732cd9e-d23d-47ed-bb2f-84046aba562f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x716298f83620>]}
[0m22:53:04.789419 [info ] [MainThread]: 
[0m22:53:04.791123 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:53:04.794257 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m22:53:04.812205 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m22:53:04.813491 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m22:53:04.814421 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:53:04.826861 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m22:53:04.828987 [debug] [ThreadPool]: On list_nba: Close
[0m22:53:04.833114 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m22:53:04.846141 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m22:53:04.847189 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m22:53:04.848333 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:53:04.860070 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m22:53:04.861327 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m22:53:04.862330 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m22:53:04.869721 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.0 seconds
[0m22:53:04.872994 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m22:53:04.874373 [debug] [ThreadPool]: On list_nba_gold: Close
[0m22:53:04.888462 [debug] [MainThread]: Using postgres connection "master"
[0m22:53:04.889952 [debug] [MainThread]: On master: BEGIN
[0m22:53:04.891001 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:53:04.898970 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:53:04.900922 [debug] [MainThread]: Using postgres connection "master"
[0m22:53:04.903354 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:53:04.939694 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m22:53:04.941827 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2732cd9e-d23d-47ed-bb2f-84046aba562f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x716299304c80>]}
[0m22:53:04.942819 [debug] [MainThread]: On master: ROLLBACK
[0m22:53:04.943970 [debug] [MainThread]: Using postgres connection "master"
[0m22:53:04.944797 [debug] [MainThread]: On master: BEGIN
[0m22:53:04.946425 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:53:04.947431 [debug] [MainThread]: On master: COMMIT
[0m22:53:04.948623 [debug] [MainThread]: Using postgres connection "master"
[0m22:53:04.950946 [debug] [MainThread]: On master: COMMIT
[0m22:53:04.953813 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:53:04.955004 [debug] [MainThread]: On master: Close
[0m22:53:04.956564 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:53:04.957759 [info ] [MainThread]: 
[0m22:53:04.962397 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m22:53:04.963518 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m22:53:04.964764 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m22:53:04.966062 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m22:53:04.984876 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m22:53:05.019712 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 22:53:04.967568 => 22:53:05.018458
[0m22:53:05.021344 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m22:53:05.104809 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m22:53:05.129749 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:53:05.130831 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m22:53:05.132270 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:53:05.142596 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:53:05.143855 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:53:05.145403 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m22:53:05.174757 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m22:53:05.188611 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:53:05.189949 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m22:53:05.191834 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:53:05.199021 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:53:05.202052 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m22:53:05.205950 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:53:05.247012 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:53:05.248759 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:53:05.252787 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:53:05.259220 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:53:05.274484 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m22:53:05.285467 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:53:05.287333 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m22:53:05.294649 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:53:05.297047 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 22:53:05.022397 => 22:53:05.296764
[0m22:53:05.298187 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m22:53:05.300760 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2732cd9e-d23d-47ed-bb2f-84046aba562f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x716298b18c20>]}
[0m22:53:05.303755 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.34s]
[0m22:53:05.305559 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m22:53:05.306595 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m22:53:05.307581 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m22:53:05.309036 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m22:53:05.310005 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m22:53:05.314746 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m22:53:05.341977 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 22:53:05.310621 => 22:53:05.341565
[0m22:53:05.342794 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m22:53:05.348681 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m22:53:05.374298 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:53:05.375423 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m22:53:05.376220 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:53:05.384816 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:53:05.387228 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:53:05.389112 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m22:53:05.411948 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:53:05.421270 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:53:05.422454 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m22:53:05.424196 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:53:05.429472 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:53:05.430602 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m22:53:05.432401 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:53:05.438704 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m22:53:05.439813 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:53:05.440705 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m22:53:05.445861 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:53:05.456327 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m22:53:05.458096 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:53:05.459080 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m22:53:05.465765 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:53:05.470983 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 22:53:05.343387 => 22:53:05.470633
[0m22:53:05.471918 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m22:53:05.473427 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2732cd9e-d23d-47ed-bb2f-84046aba562f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x716298bbb3b0>]}
[0m22:53:05.474543 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.16s]
[0m22:53:05.475828 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m22:53:05.476767 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m22:53:05.477774 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m22:53:05.478982 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m22:53:05.479749 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m22:53:05.487453 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m22:53:05.508591 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 22:53:05.480280 => 22:53:05.508162
[0m22:53:05.509596 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m22:53:05.515606 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m22:53:05.595189 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:53:05.596121 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m22:53:05.597046 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:53:05.608237 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:53:05.610230 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:53:05.613393 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m22:53:05.640329 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m22:53:05.644686 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:53:05.645616 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m22:53:05.646860 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:53:05.655732 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:53:05.657115 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m22:53:05.658883 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:53:05.662083 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:53:05.663003 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:53:05.663805 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:53:05.671290 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:53:05.675500 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m22:53:05.676975 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:53:05.677924 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m22:53:05.685733 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:53:05.689638 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 22:53:05.510392 => 22:53:05.689293
[0m22:53:05.690681 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m22:53:05.692181 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2732cd9e-d23d-47ed-bb2f-84046aba562f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x716298bbbf20>]}
[0m22:53:05.693452 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.21s]
[0m22:53:05.695020 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m22:53:05.696130 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m22:53:05.697324 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m22:53:05.699954 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m22:53:05.702610 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m22:53:05.709014 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m22:53:05.731197 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 22:53:05.703740 => 22:53:05.730777
[0m22:53:05.732549 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m22:53:05.742420 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m22:53:05.764690 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:53:05.766836 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m22:53:05.769799 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:53:05.778230 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:53:05.779299 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:53:05.780411 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m22:53:05.822526 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:53:05.828085 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:53:05.829025 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m22:53:05.830623 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:53:05.838281 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:53:05.839322 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m22:53:05.840651 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:53:05.843629 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m22:53:05.844652 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:53:05.845576 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m22:53:05.852201 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:53:05.856829 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m22:53:05.859073 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:53:05.860338 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m22:53:05.867847 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:53:05.871420 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 22:53:05.734623 => 22:53:05.871073
[0m22:53:05.872343 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m22:53:05.873932 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2732cd9e-d23d-47ed-bb2f-84046aba562f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x716298fdd3a0>]}
[0m22:53:05.875169 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.18s]
[0m22:53:05.876529 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m22:53:05.877483 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:53:05.878421 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m22:53:05.879647 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m22:53:05.880451 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:53:05.890660 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:53:05.917937 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 22:53:05.881014 => 22:53:05.916130
[0m22:53:05.920359 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:53:05.928208 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:53:05.954822 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:53:05.955860 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m22:53:05.956801 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:53:05.963220 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:53:05.964182 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:53:05.965793 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m22:53:06.006749 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m22:53:06.011553 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:53:06.012635 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m22:53:06.014205 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:53:06.021534 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:53:06.022610 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m22:53:06.024168 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:53:06.027276 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m22:53:06.028321 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:53:06.029298 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m22:53:06.035559 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:53:06.042489 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m22:53:06.044517 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:53:06.045691 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m22:53:06.053844 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:53:06.056520 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 22:53:05.921451 => 22:53:06.056196
[0m22:53:06.057637 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m22:53:06.059572 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2732cd9e-d23d-47ed-bb2f-84046aba562f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71629971c710>]}
[0m22:53:06.061358 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.18s]
[0m22:53:06.063473 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:53:06.066591 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m22:53:06.068552 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m22:53:06.072292 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m22:53:06.073428 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m22:53:06.088829 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m22:53:06.116688 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 22:53:06.074395 => 22:53:06.115951
[0m22:53:06.119367 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m22:53:06.126311 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m22:53:06.153784 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:53:06.154936 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m22:53:06.155877 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:53:06.163315 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:53:06.164401 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:53:06.167057 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

player_stats_game as (

SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(min) AS avg_min,
    AVG(fg_pct) AS avg_fg_pct,  -- Esta es la columna que falta
    AVG(fg3_pct) AS avg_fg3_pct,
    AVG(reb) AS avg_reb,
    AVG(tov) AS avg_tov,
    AVG(stl) AS avg_stl,
    AVG(blk) AS avg_blk,
    AVG(plus_minus) AS avg_plus_minus
FROM "nba"."silver"."player_stats"
GROUP BY player_id, player_name, team_abbreviation
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_game AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')

    UNION ALL

    SELECT
        'Rebotes' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Robos' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Bloqueos' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    
    UNION ALL
    
    SELECT
        'Diferencial de puntos' AS weakness_type,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m22:53:06.171982 [debug] [Thread-1 (]: Postgres adapter: Postgres error: function avg(character varying) does not exist
LINE 28:     AVG(min) AS avg_min,
             ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.

[0m22:53:06.173462 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m22:53:06.175006 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 22:53:06.121203 => 22:53:06.174699
[0m22:53:06.176175 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m22:53:06.182439 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  function avg(character varying) does not exist
  LINE 28:     AVG(min) AS avg_min,
               ^
  HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m22:53:06.185464 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2732cd9e-d23d-47ed-bb2f-84046aba562f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7162987080e0>]}
[0m22:53:06.187748 [error] [Thread-1 (]: 6 of 6 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.11s]
[0m22:53:06.189579 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m22:53:06.193521 [debug] [MainThread]: Using postgres connection "master"
[0m22:53:06.194351 [debug] [MainThread]: On master: BEGIN
[0m22:53:06.195072 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:53:06.203324 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:53:06.204625 [debug] [MainThread]: On master: COMMIT
[0m22:53:06.205506 [debug] [MainThread]: Using postgres connection "master"
[0m22:53:06.206336 [debug] [MainThread]: On master: COMMIT
[0m22:53:06.207577 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:53:06.208701 [debug] [MainThread]: On master: Close
[0m22:53:06.210737 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:53:06.211662 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m22:53:06.212481 [info ] [MainThread]: 
[0m22:53:06.213420 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.42 seconds (1.42s).
[0m22:53:06.217462 [debug] [MainThread]: Command end result
[0m22:53:06.286754 [info ] [MainThread]: 
[0m22:53:06.289206 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:53:06.290895 [info ] [MainThread]: 
[0m22:53:06.292552 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  function avg(character varying) does not exist
  LINE 28:     AVG(min) AS avg_min,
               ^
  HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m22:53:06.294218 [info ] [MainThread]: 
[0m22:53:06.295987 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m22:53:06.299396 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.9866934, "process_user_time": 5.454847, "process_kernel_time": 0.665126, "process_mem_max_rss": "201028", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m22:53:06.303794 [debug] [MainThread]: Command `dbt run` failed at 22:53:06.303391 after 2.99 seconds
[0m22:53:06.305404 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71629a127c80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x716298b07980>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x716298ffb590>]}
[0m22:53:06.307032 [debug] [MainThread]: Flushing usage events
[0m22:56:21.239146 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b8326c17f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b8322f6c90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b832575d00>]}


============================== 22:56:21.244970 | 1a671142-61cf-408d-bb21-ebdfd314f15c ==============================
[0m22:56:21.244970 [info ] [MainThread]: Running with dbt=1.7.9
[0m22:56:21.247578 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m22:56:21.606995 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1a671142-61cf-408d-bb21-ebdfd314f15c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b8322f5640>]}
[0m22:56:21.856255 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1a671142-61cf-408d-bb21-ebdfd314f15c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b83285afc0>]}
[0m22:56:21.858151 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m22:56:21.917441 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m22:56:22.328067 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:56:22.331284 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m22:56:22.632874 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m22:56:22.646806 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1a671142-61cf-408d-bb21-ebdfd314f15c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b8321a73e0>]}
[0m22:56:22.747641 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1a671142-61cf-408d-bb21-ebdfd314f15c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b8311687d0>]}
[0m22:56:22.748920 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m22:56:22.750450 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1a671142-61cf-408d-bb21-ebdfd314f15c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b83198b680>]}
[0m22:56:22.755526 [info ] [MainThread]: 
[0m22:56:22.757481 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:56:22.763425 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m22:56:22.788897 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m22:56:22.790004 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m22:56:22.790924 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:56:22.805795 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m22:56:22.808086 [debug] [ThreadPool]: On list_nba: Close
[0m22:56:22.814860 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m22:56:22.831980 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m22:56:22.833137 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m22:56:22.834110 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:56:22.842351 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m22:56:22.845607 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m22:56:22.848521 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m22:56:22.855375 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.0 seconds
[0m22:56:22.859334 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m22:56:22.863328 [debug] [ThreadPool]: On list_nba_gold: Close
[0m22:56:22.874033 [debug] [MainThread]: Using postgres connection "master"
[0m22:56:22.875384 [debug] [MainThread]: On master: BEGIN
[0m22:56:22.877372 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:56:22.886862 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:56:22.887989 [debug] [MainThread]: Using postgres connection "master"
[0m22:56:22.889220 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:56:22.919991 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m22:56:22.923920 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1a671142-61cf-408d-bb21-ebdfd314f15c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b83193a7e0>]}
[0m22:56:22.925755 [debug] [MainThread]: On master: ROLLBACK
[0m22:56:22.929753 [debug] [MainThread]: Using postgres connection "master"
[0m22:56:22.933944 [debug] [MainThread]: On master: BEGIN
[0m22:56:22.936052 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:56:22.937424 [debug] [MainThread]: On master: COMMIT
[0m22:56:22.938789 [debug] [MainThread]: Using postgres connection "master"
[0m22:56:22.939850 [debug] [MainThread]: On master: COMMIT
[0m22:56:22.941437 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:56:22.942641 [debug] [MainThread]: On master: Close
[0m22:56:22.947437 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:56:22.951784 [info ] [MainThread]: 
[0m22:56:22.957933 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m22:56:22.959721 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m22:56:22.963932 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m22:56:22.965942 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m22:56:22.980979 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m22:56:23.007676 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 22:56:22.966924 => 22:56:23.007124
[0m22:56:23.009172 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m22:56:23.089884 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m22:56:23.116941 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:56:23.118757 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m22:56:23.119682 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:56:23.127902 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:56:23.130700 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:56:23.132306 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m22:56:23.155350 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m22:56:23.170270 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:56:23.171361 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m22:56:23.173060 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:56:23.183649 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:56:23.185700 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m22:56:23.188229 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:56:23.248889 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:56:23.250102 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:56:23.251126 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:56:23.258770 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:56:23.274793 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m22:56:23.290567 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:56:23.291608 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m22:56:23.300277 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:56:23.304010 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 22:56:23.011998 => 22:56:23.303417
[0m22:56:23.305376 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m22:56:23.307709 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1a671142-61cf-408d-bb21-ebdfd314f15c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b8309cc950>]}
[0m22:56:23.311372 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.34s]
[0m22:56:23.315554 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m22:56:23.316976 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m22:56:23.318402 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m22:56:23.319937 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m22:56:23.321036 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m22:56:23.326630 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m22:56:23.356035 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 22:56:23.321729 => 22:56:23.355581
[0m22:56:23.357343 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m22:56:23.366148 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m22:56:23.394398 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:56:23.396894 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m22:56:23.398649 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:56:23.405765 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:56:23.406904 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:56:23.408063 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m22:56:23.433109 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:56:23.437828 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:56:23.438766 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m22:56:23.440235 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:56:23.448860 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:56:23.450077 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m22:56:23.451648 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:56:23.454743 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m22:56:23.455770 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:56:23.456793 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m22:56:23.464277 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:56:23.470637 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m22:56:23.473050 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:56:23.474520 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m22:56:23.486913 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:56:23.529822 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 22:56:23.358070 => 22:56:23.529036
[0m22:56:23.539000 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m22:56:23.542402 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1a671142-61cf-408d-bb21-ebdfd314f15c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b8305773b0>]}
[0m22:56:23.545930 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.22s]
[0m22:56:23.549534 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m22:56:23.551851 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m22:56:23.560999 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m22:56:23.565833 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m22:56:23.567844 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m22:56:23.580506 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m22:56:23.605243 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 22:56:23.569211 => 22:56:23.604794
[0m22:56:23.606148 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m22:56:23.616978 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m22:56:23.640371 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:56:23.641345 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m22:56:23.642542 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:56:23.652934 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:56:23.655015 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:56:23.657293 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m22:56:23.684676 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m22:56:23.689967 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:56:23.691144 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m22:56:23.694090 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:56:23.702630 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:56:23.703862 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m22:56:23.705376 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:56:23.709556 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:56:23.711981 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:56:23.715009 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:56:23.721954 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:56:23.729767 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m22:56:23.732391 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:56:23.733436 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m22:56:23.740540 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:56:23.746224 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 22:56:23.606942 => 22:56:23.744943
[0m22:56:23.747940 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m22:56:23.750018 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1a671142-61cf-408d-bb21-ebdfd314f15c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b8309bff20>]}
[0m22:56:23.751583 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.19s]
[0m22:56:23.753298 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m22:56:23.754964 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m22:56:23.756915 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m22:56:23.759445 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m22:56:23.761989 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m22:56:23.774633 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m22:56:23.803243 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 22:56:23.763763 => 22:56:23.802803
[0m22:56:23.804227 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m22:56:23.812086 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m22:56:23.838477 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:56:23.839423 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m22:56:23.840269 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:56:23.850597 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:56:23.851708 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:56:23.853087 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m22:56:23.901506 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:56:23.906589 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:56:23.908221 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m22:56:23.912848 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:56:23.919594 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:56:23.920602 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m22:56:23.922941 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:56:23.928512 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m22:56:23.932063 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:56:23.933999 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m22:56:23.939588 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:56:23.947246 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m22:56:23.950266 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:56:23.951978 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m22:56:23.963205 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:56:23.966927 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 22:56:23.804881 => 22:56:23.966481
[0m22:56:23.968054 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m22:56:23.970605 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1a671142-61cf-408d-bb21-ebdfd314f15c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b8328eee40>]}
[0m22:56:23.973152 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.21s]
[0m22:56:23.975013 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m22:56:23.978417 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:56:23.984500 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m22:56:23.986993 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m22:56:23.988622 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:56:23.999625 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:56:24.031371 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 22:56:23.989677 => 22:56:24.030565
[0m22:56:24.033171 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:56:24.043934 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:56:24.086570 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:56:24.087654 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m22:56:24.088528 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:56:24.097899 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:56:24.099414 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:56:24.100803 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m22:56:24.151091 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m22:56:24.159463 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:56:24.162184 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m22:56:24.165092 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:56:24.170262 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:56:24.171268 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m22:56:24.172818 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:56:24.177724 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m22:56:24.180704 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:56:24.181790 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m22:56:24.187333 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:56:24.191811 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m22:56:24.195281 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:56:24.197719 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m22:56:24.206360 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:56:24.213562 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 22:56:24.034309 => 22:56:24.213077
[0m22:56:24.215983 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m22:56:24.219684 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1a671142-61cf-408d-bb21-ebdfd314f15c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b8305c7650>]}
[0m22:56:24.221620 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.23s]
[0m22:56:24.226161 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:56:24.234148 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m22:56:24.235487 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m22:56:24.237343 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m22:56:24.238546 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m22:56:24.249455 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m22:56:24.273647 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 22:56:24.239284 => 22:56:24.273214
[0m22:56:24.274672 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m22:56:24.287321 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m22:56:24.322108 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:56:24.323656 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m22:56:24.325596 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:56:24.335730 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:56:24.337396 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:56:24.338706 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

player_stats_game as (

SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl)::numeric AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus) AS avg_plus_minus
FROM "nba"."silver"."player_stats"
GROUP BY player_id, player_name, team_abbreviation
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_game AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')

    UNION ALL

    SELECT
        'Rebotes' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Robos' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Bloqueos' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    
    UNION ALL
    
    SELECT
        'Diferencial de puntos' AS weakness_type,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m22:56:24.343556 [debug] [Thread-1 (]: Postgres adapter: Postgres error: function avg(character varying) does not exist
LINE 32:     AVG(stl)::numeric AS avg_stl,
             ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.

[0m22:56:24.346448 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m22:56:24.348854 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 22:56:24.275531 => 22:56:24.348392
[0m22:56:24.349902 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m22:56:24.357431 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  function avg(character varying) does not exist
  LINE 32:     AVG(stl)::numeric AS avg_stl,
               ^
  HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m22:56:24.358801 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1a671142-61cf-408d-bb21-ebdfd314f15c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b8305c4830>]}
[0m22:56:24.361796 [error] [Thread-1 (]: 6 of 6 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.12s]
[0m22:56:24.365282 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m22:56:24.370412 [debug] [MainThread]: Using postgres connection "master"
[0m22:56:24.371694 [debug] [MainThread]: On master: BEGIN
[0m22:56:24.372762 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:56:24.382604 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:56:24.384166 [debug] [MainThread]: On master: COMMIT
[0m22:56:24.385445 [debug] [MainThread]: Using postgres connection "master"
[0m22:56:24.386735 [debug] [MainThread]: On master: COMMIT
[0m22:56:24.388037 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:56:24.389065 [debug] [MainThread]: On master: Close
[0m22:56:24.390343 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:56:24.391140 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m22:56:24.392279 [info ] [MainThread]: 
[0m22:56:24.394313 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.64 seconds (1.64s).
[0m22:56:24.399066 [debug] [MainThread]: Command end result
[0m22:56:24.469259 [info ] [MainThread]: 
[0m22:56:24.470391 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:56:24.471246 [info ] [MainThread]: 
[0m22:56:24.472265 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  function avg(character varying) does not exist
  LINE 32:     AVG(stl)::numeric AS avg_stl,
               ^
  HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m22:56:24.474009 [info ] [MainThread]: 
[0m22:56:24.474950 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m22:56:24.479711 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 3.3479698, "process_user_time": 5.607958, "process_kernel_time": 0.525874, "process_mem_max_rss": "201024", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m22:56:24.481463 [debug] [MainThread]: Command `dbt run` failed at 22:56:24.481233 after 3.35 seconds
[0m22:56:24.482432 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b83306bcb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b8309b6630>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b8311bd6a0>]}
[0m22:56:24.483554 [debug] [MainThread]: Flushing usage events
[0m22:57:24.375447 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df3bb089e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df3bc22bd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df3bbb6300>]}


============================== 22:57:24.380009 | 9a6a5671-7c69-4228-963f-56974475a120 ==============================
[0m22:57:24.380009 [info ] [MainThread]: Running with dbt=1.7.9
[0m22:57:24.384279 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m22:57:24.812122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9a6a5671-7c69-4228-963f-56974475a120', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df3baaf050>]}
[0m22:57:25.002692 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9a6a5671-7c69-4228-963f-56974475a120', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df3af52420>]}
[0m22:57:25.004443 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m22:57:25.095378 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m22:57:25.421611 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:57:25.422805 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m22:57:25.710205 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m22:57:25.720003 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9a6a5671-7c69-4228-963f-56974475a120', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df3a3519d0>]}
[0m22:57:25.809782 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9a6a5671-7c69-4228-963f-56974475a120', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df3abb5430>]}
[0m22:57:25.811065 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m22:57:25.812659 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9a6a5671-7c69-4228-963f-56974475a120', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df3bb0ae70>]}
[0m22:57:25.819795 [info ] [MainThread]: 
[0m22:57:25.821765 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:57:25.824906 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m22:57:25.845124 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m22:57:25.846241 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m22:57:25.848204 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:57:25.865021 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m22:57:25.869626 [debug] [ThreadPool]: On list_nba: Close
[0m22:57:25.873863 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m22:57:25.898564 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m22:57:25.902000 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m22:57:25.903360 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:57:25.911431 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m22:57:25.912436 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m22:57:25.913610 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m22:57:25.921945 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.0 seconds
[0m22:57:25.924240 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m22:57:25.925530 [debug] [ThreadPool]: On list_nba_gold: Close
[0m22:57:25.936547 [debug] [MainThread]: Using postgres connection "master"
[0m22:57:25.938618 [debug] [MainThread]: On master: BEGIN
[0m22:57:25.939908 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:57:25.948460 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:57:25.951320 [debug] [MainThread]: Using postgres connection "master"
[0m22:57:25.953021 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:57:25.983136 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m22:57:25.987072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9a6a5671-7c69-4228-963f-56974475a120', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df3a709dc0>]}
[0m22:57:25.988251 [debug] [MainThread]: On master: ROLLBACK
[0m22:57:25.989459 [debug] [MainThread]: Using postgres connection "master"
[0m22:57:25.990394 [debug] [MainThread]: On master: BEGIN
[0m22:57:25.991857 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:57:25.992835 [debug] [MainThread]: On master: COMMIT
[0m22:57:25.993600 [debug] [MainThread]: Using postgres connection "master"
[0m22:57:25.994525 [debug] [MainThread]: On master: COMMIT
[0m22:57:25.995811 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:57:25.997341 [debug] [MainThread]: On master: Close
[0m22:57:26.001314 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:57:26.003124 [info ] [MainThread]: 
[0m22:57:26.008371 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m22:57:26.009743 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m22:57:26.011756 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m22:57:26.012905 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m22:57:26.033693 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m22:57:26.060620 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 22:57:26.013676 => 22:57:26.059662
[0m22:57:26.062375 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m22:57:26.144397 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m22:57:26.174329 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:57:26.175371 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m22:57:26.176223 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:57:26.186111 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:57:26.187456 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:57:26.188557 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m22:57:26.213760 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m22:57:26.226153 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:57:26.227404 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m22:57:26.228944 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:57:26.237695 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:57:26.238865 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m22:57:26.240406 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:57:26.275557 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:57:26.276715 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:57:26.277681 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:57:26.290609 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:57:26.305547 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m22:57:26.322246 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:57:26.323565 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m22:57:26.335368 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:57:26.339592 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 22:57:26.063439 => 22:57:26.339188
[0m22:57:26.340663 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m22:57:26.342563 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9a6a5671-7c69-4228-963f-56974475a120', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df3a708ec0>]}
[0m22:57:26.344027 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.33s]
[0m22:57:26.345692 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m22:57:26.347418 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m22:57:26.353671 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m22:57:26.371094 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m22:57:26.406972 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m22:57:26.421545 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m22:57:26.461126 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 22:57:26.412277 => 22:57:26.460695
[0m22:57:26.462077 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m22:57:26.472159 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m22:57:26.496901 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:57:26.499637 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m22:57:26.502127 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:57:26.509921 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:57:26.511189 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:57:26.512376 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m22:57:26.537359 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:57:26.542966 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:57:26.544045 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m22:57:26.545485 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:57:26.553622 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:57:26.554838 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m22:57:26.556223 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:57:26.559790 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m22:57:26.561007 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:57:26.562081 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m22:57:26.571004 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:57:26.577288 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m22:57:26.579102 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:57:26.580651 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m22:57:26.589720 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:57:26.592642 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 22:57:26.462818 => 22:57:26.592287
[0m22:57:26.593775 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m22:57:26.595730 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9a6a5671-7c69-4228-963f-56974475a120', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df39fc3350>]}
[0m22:57:26.597880 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.23s]
[0m22:57:26.602674 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m22:57:26.604397 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m22:57:26.605986 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m22:57:26.608887 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m22:57:26.609943 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m22:57:26.615879 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m22:57:26.644248 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 22:57:26.610617 => 22:57:26.643832
[0m22:57:26.645123 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m22:57:26.654215 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m22:57:26.682810 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:57:26.685555 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m22:57:26.687330 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:57:26.695706 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:57:26.697143 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:57:26.698737 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m22:57:26.725625 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m22:57:26.731087 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:57:26.733669 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m22:57:26.736841 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:57:26.741735 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:57:26.742705 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m22:57:26.744098 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:57:26.747994 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:57:26.750878 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:57:26.752905 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:57:26.760556 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:57:26.767112 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m22:57:26.769644 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:57:26.770730 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m22:57:26.777197 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:57:26.780151 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 22:57:26.645749 => 22:57:26.779635
[0m22:57:26.782664 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m22:57:26.786465 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9a6a5671-7c69-4228-963f-56974475a120', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df39fc3320>]}
[0m22:57:26.789215 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.18s]
[0m22:57:26.791079 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m22:57:26.792477 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m22:57:26.794241 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m22:57:26.796018 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m22:57:26.797429 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m22:57:26.809024 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m22:57:26.845040 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 22:57:26.800278 => 22:57:26.844587
[0m22:57:26.845944 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m22:57:26.856589 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m22:57:26.884158 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:57:26.885978 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m22:57:26.887169 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:57:26.893870 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:57:26.894897 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:57:26.895881 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m22:57:26.936582 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:57:26.941738 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:57:26.942730 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m22:57:26.944433 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:57:26.952782 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:57:26.953848 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m22:57:26.955326 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:57:26.958696 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m22:57:26.959688 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:57:26.960501 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m22:57:26.968036 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:57:26.972679 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m22:57:26.974334 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:57:26.975192 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m22:57:26.985228 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:57:26.988294 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 22:57:26.846767 => 22:57:26.987862
[0m22:57:26.989358 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m22:57:26.991012 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9a6a5671-7c69-4228-963f-56974475a120', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df3a385ac0>]}
[0m22:57:26.992706 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.20s]
[0m22:57:26.994814 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m22:57:26.995904 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:57:26.997506 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m22:57:27.001406 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m22:57:27.002836 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:57:27.009421 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:57:27.040667 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 22:57:27.003704 => 22:57:27.040211
[0m22:57:27.042007 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:57:27.051776 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:57:27.084469 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:57:27.086306 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m22:57:27.087365 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:57:27.094494 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:57:27.095426 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:57:27.096565 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m22:57:27.145796 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m22:57:27.154298 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:57:27.155637 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m22:57:27.158371 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:57:27.163684 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:57:27.166624 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m22:57:27.169701 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:57:27.173129 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m22:57:27.174671 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:57:27.175776 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m22:57:27.184613 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:57:27.189507 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m22:57:27.191159 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:57:27.192108 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m22:57:27.201400 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:57:27.204742 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 22:57:27.042911 => 22:57:27.204234
[0m22:57:27.205738 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m22:57:27.207699 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9a6a5671-7c69-4228-963f-56974475a120', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df39b13140>]}
[0m22:57:27.209554 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.21s]
[0m22:57:27.211711 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:57:27.214487 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m22:57:27.219129 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m22:57:27.221547 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m22:57:27.222646 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m22:57:27.230859 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m22:57:27.264550 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 22:57:27.223471 => 22:57:27.263546
[0m22:57:27.267742 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m22:57:27.275714 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m22:57:27.306946 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:57:27.308329 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m22:57:27.309412 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:57:27.319382 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:57:27.321085 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:57:27.322888 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

player_stats_game as (

SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl)::numeric AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM "nba"."silver"."player_stats"
GROUP BY player_id, player_name, team_abbreviation
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_game AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')

    UNION ALL

    SELECT
        'Rebotes' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Robos' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Bloqueos' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    
    UNION ALL
    
    SELECT
        'Diferencial de puntos' AS weakness_type,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m22:57:27.326047 [debug] [Thread-1 (]: Postgres adapter: Postgres error: function avg(character varying) does not exist
LINE 32:     AVG(stl)::numeric AS avg_stl,
             ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.

[0m22:57:27.327330 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m22:57:27.328829 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 22:57:27.268959 => 22:57:27.328462
[0m22:57:27.329910 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m22:57:27.341099 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  function avg(character varying) does not exist
  LINE 32:     AVG(stl)::numeric AS avg_stl,
               ^
  HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m22:57:27.342480 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9a6a5671-7c69-4228-963f-56974475a120', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df3a385160>]}
[0m22:57:27.343851 [error] [Thread-1 (]: 6 of 6 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.12s]
[0m22:57:27.345487 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m22:57:27.352683 [debug] [MainThread]: Using postgres connection "master"
[0m22:57:27.354121 [debug] [MainThread]: On master: BEGIN
[0m22:57:27.355364 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:57:27.364247 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:57:27.367980 [debug] [MainThread]: On master: COMMIT
[0m22:57:27.369654 [debug] [MainThread]: Using postgres connection "master"
[0m22:57:27.370899 [debug] [MainThread]: On master: COMMIT
[0m22:57:27.372916 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:57:27.374496 [debug] [MainThread]: On master: Close
[0m22:57:27.376563 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:57:27.377607 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m22:57:27.378760 [info ] [MainThread]: 
[0m22:57:27.380367 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.56 seconds (1.56s).
[0m22:57:27.387257 [debug] [MainThread]: Command end result
[0m22:57:27.474588 [info ] [MainThread]: 
[0m22:57:27.475792 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:57:27.476729 [info ] [MainThread]: 
[0m22:57:27.477812 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  function avg(character varying) does not exist
  LINE 32:     AVG(stl)::numeric AS avg_stl,
               ^
  HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m22:57:27.479837 [info ] [MainThread]: 
[0m22:57:27.482096 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m22:57:27.486333 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 3.2149522, "process_user_time": 5.392817, "process_kernel_time": 0.650716, "process_mem_max_rss": "201028", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m22:57:27.487657 [debug] [MainThread]: Command `dbt run` failed at 22:57:27.487410 after 3.22 seconds
[0m22:57:27.488607 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df3bbb62a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df39b185c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78df3ab26a80>]}
[0m22:57:27.489391 [debug] [MainThread]: Flushing usage events
[0m22:58:43.215452 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d65d79160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d664926c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d66149d00>]}


============================== 22:58:43.222088 | 9664df49-540c-498a-b596-c06290df2eb1 ==============================
[0m22:58:43.222088 [info ] [MainThread]: Running with dbt=1.7.9
[0m22:58:43.223378 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m22:58:43.573009 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9664df49-540c-498a-b596-c06290df2eb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d65104320>]}
[0m22:58:43.759298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9664df49-540c-498a-b596-c06290df2eb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d65522db0>]}
[0m22:58:43.760749 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m22:58:43.793143 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m22:58:44.124348 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:58:44.125795 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m22:58:44.387959 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m22:58:44.395063 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9664df49-540c-498a-b596-c06290df2eb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d645f7560>]}
[0m22:58:44.464696 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9664df49-540c-498a-b596-c06290df2eb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d64d69a30>]}
[0m22:58:44.466550 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m22:58:44.467878 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9664df49-540c-498a-b596-c06290df2eb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d66d44320>]}
[0m22:58:44.471041 [info ] [MainThread]: 
[0m22:58:44.472547 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:58:44.474909 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m22:58:44.490594 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m22:58:44.491775 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m22:58:44.492660 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:58:44.505999 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m22:58:44.508197 [debug] [ThreadPool]: On list_nba: Close
[0m22:58:44.512344 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m22:58:44.524119 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m22:58:44.525501 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m22:58:44.526843 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:58:44.536689 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m22:58:44.538180 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m22:58:44.539386 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m22:58:44.544656 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.0 seconds
[0m22:58:44.549322 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m22:58:44.551195 [debug] [ThreadPool]: On list_nba_gold: Close
[0m22:58:44.566466 [debug] [MainThread]: Using postgres connection "master"
[0m22:58:44.569738 [debug] [MainThread]: On master: BEGIN
[0m22:58:44.570808 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:58:44.579476 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:58:44.581673 [debug] [MainThread]: Using postgres connection "master"
[0m22:58:44.583489 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:58:44.615712 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m22:58:44.619653 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9664df49-540c-498a-b596-c06290df2eb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d6451fe90>]}
[0m22:58:44.621014 [debug] [MainThread]: On master: ROLLBACK
[0m22:58:44.622530 [debug] [MainThread]: Using postgres connection "master"
[0m22:58:44.623552 [debug] [MainThread]: On master: BEGIN
[0m22:58:44.625533 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:58:44.626726 [debug] [MainThread]: On master: COMMIT
[0m22:58:44.627673 [debug] [MainThread]: Using postgres connection "master"
[0m22:58:44.628582 [debug] [MainThread]: On master: COMMIT
[0m22:58:44.630100 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:58:44.632714 [debug] [MainThread]: On master: Close
[0m22:58:44.635360 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:58:44.637959 [info ] [MainThread]: 
[0m22:58:44.643946 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m22:58:44.647100 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m22:58:44.650510 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m22:58:44.652233 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m22:58:44.670741 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m22:58:44.695682 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 22:58:44.652957 => 22:58:44.695101
[0m22:58:44.697017 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m22:58:44.795809 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m22:58:44.861549 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:58:44.862386 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m22:58:44.863738 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:58:44.873289 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:58:44.874428 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:58:44.875423 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m22:58:44.899620 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m22:58:44.908633 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:58:44.909570 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m22:58:44.910846 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:58:44.917808 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:58:44.918848 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m22:58:44.920173 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:58:44.951203 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:58:44.952297 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:58:44.953107 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:58:44.958523 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:58:44.970176 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m22:58:44.978607 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:58:44.979684 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m22:58:44.986983 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:58:44.989712 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 22:58:44.698983 => 22:58:44.989375
[0m22:58:44.990674 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m22:58:44.992433 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9664df49-540c-498a-b596-c06290df2eb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d64500050>]}
[0m22:58:44.994798 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.34s]
[0m22:58:44.996221 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m22:58:44.998850 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m22:58:45.000721 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m22:58:45.002245 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m22:58:45.003209 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m22:58:45.008030 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m22:58:45.032927 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 22:58:45.003934 => 22:58:45.032210
[0m22:58:45.034756 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m22:58:45.040792 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m22:58:45.071466 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:58:45.072822 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m22:58:45.073976 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:58:45.082477 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:58:45.083815 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:58:45.085597 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m22:58:45.104790 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:58:45.109473 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:58:45.110526 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m22:58:45.112075 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:58:45.120031 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:58:45.121429 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m22:58:45.122991 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:58:45.126309 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m22:58:45.127419 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:58:45.128538 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m22:58:45.134522 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:58:45.139890 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m22:58:45.141524 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:58:45.142402 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m22:58:45.149615 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:58:45.154559 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 22:58:45.035929 => 22:58:45.154024
[0m22:58:45.156256 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m22:58:45.158063 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9664df49-540c-498a-b596-c06290df2eb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d64177ef0>]}
[0m22:58:45.160885 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.16s]
[0m22:58:45.162560 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m22:58:45.164218 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m22:58:45.165577 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m22:58:45.167839 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m22:58:45.169493 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m22:58:45.174285 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m22:58:45.200619 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 22:58:45.170236 => 22:58:45.199820
[0m22:58:45.202151 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m22:58:45.208232 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m22:58:45.232308 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:58:45.234054 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m22:58:45.235132 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:58:45.241829 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:58:45.242886 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:58:45.243789 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m22:58:45.264580 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m22:58:45.270581 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:58:45.271570 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m22:58:45.273013 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:58:45.277418 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:58:45.278380 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m22:58:45.280063 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:58:45.284800 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:58:45.286034 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:58:45.287029 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:58:45.294121 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:58:45.300031 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m22:58:45.301888 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:58:45.302897 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m22:58:45.311707 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:58:45.315701 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 22:58:45.202917 => 22:58:45.315311
[0m22:58:45.317507 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m22:58:45.319346 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9664df49-540c-498a-b596-c06290df2eb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d641779e0>]}
[0m22:58:45.320656 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m22:58:45.322005 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m22:58:45.323101 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m22:58:45.324178 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m22:58:45.325609 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m22:58:45.326683 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m22:58:45.333473 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m22:58:45.358737 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 22:58:45.327526 => 22:58:45.358336
[0m22:58:45.359738 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m22:58:45.368354 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m22:58:45.394281 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:58:45.395259 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m22:58:45.396494 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:58:45.404612 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:58:45.405714 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:58:45.406887 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m22:58:45.444109 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:58:45.451696 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:58:45.452856 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m22:58:45.454637 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:58:45.461620 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:58:45.462813 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m22:58:45.466784 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:58:45.470318 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m22:58:45.471457 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:58:45.472479 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m22:58:45.479824 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:58:45.487128 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m22:58:45.488960 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:58:45.489980 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m22:58:45.497602 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:58:45.502207 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 22:58:45.360488 => 22:58:45.501779
[0m22:58:45.503567 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m22:58:45.505673 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9664df49-540c-498a-b596-c06290df2eb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d64dbdac0>]}
[0m22:58:45.507018 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.18s]
[0m22:58:45.508445 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m22:58:45.509942 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:58:45.511200 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m22:58:45.512632 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m22:58:45.513978 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:58:45.521650 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:58:45.549684 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 22:58:45.515282 => 22:58:45.548837
[0m22:58:45.551113 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:58:45.559700 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:58:45.587647 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:58:45.588607 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m22:58:45.589487 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:58:45.596134 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:58:45.598935 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:58:45.600959 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m22:58:45.640803 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m22:58:45.645896 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:58:45.648280 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m22:58:45.651387 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:58:45.656688 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:58:45.657979 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m22:58:45.659548 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:58:45.662436 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m22:58:45.664019 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:58:45.666144 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m22:58:45.672475 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:58:45.676723 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m22:58:45.678538 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:58:45.680095 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m22:58:45.688776 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:58:45.691313 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 22:58:45.551954 => 22:58:45.691022
[0m22:58:45.692414 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m22:58:45.694078 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9664df49-540c-498a-b596-c06290df2eb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d641c4a70>]}
[0m22:58:45.695304 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.18s]
[0m22:58:45.698204 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:58:45.701319 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m22:58:45.702428 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m22:58:45.704159 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m22:58:45.705361 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m22:58:45.711659 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m22:58:45.738316 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 22:58:45.706160 => 22:58:45.737927
[0m22:58:45.739250 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m22:58:45.744419 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m22:58:45.771322 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:58:45.772301 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m22:58:45.773288 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:58:45.780051 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:58:45.782675 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:58:45.785357 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

player_stats_game as (

SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM "nba"."silver"."player_stats"
GROUP BY player_id, player_name, team_abbreviation
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_game AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')

    UNION ALL

    SELECT
        'Rebotes' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Robos' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Bloqueos' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    
    UNION ALL
    
    SELECT
        'Diferencial de puntos' AS weakness_type,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season, tt.weakness_type, tt.metric_value DESC
  );
  
[0m22:58:45.790359 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column swu.season does not exist
LINE 165: ORDER BY swu.season, tt.weakness_type, tt.metric_value DESC
                   ^
HINT:  Perhaps you meant to reference the column "swu.season2".

[0m22:58:45.791528 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m22:58:45.793069 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 22:58:45.739981 => 22:58:45.792762
[0m22:58:45.794360 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m22:58:45.803799 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column swu.season does not exist
  LINE 165: ORDER BY swu.season, tt.weakness_type, tt.metric_value DESC
                     ^
  HINT:  Perhaps you meant to reference the column "swu.season2".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m22:58:45.805408 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9664df49-540c-498a-b596-c06290df2eb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d641c4b30>]}
[0m22:58:45.806783 [error] [Thread-1 (]: 6 of 6 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m22:58:45.808120 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m22:58:45.812210 [debug] [MainThread]: Using postgres connection "master"
[0m22:58:45.813741 [debug] [MainThread]: On master: BEGIN
[0m22:58:45.815684 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:58:45.823448 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:58:45.824414 [debug] [MainThread]: On master: COMMIT
[0m22:58:45.825323 [debug] [MainThread]: Using postgres connection "master"
[0m22:58:45.826258 [debug] [MainThread]: On master: COMMIT
[0m22:58:45.827419 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:58:45.828351 [debug] [MainThread]: On master: Close
[0m22:58:45.830676 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:58:45.833031 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m22:58:45.834635 [info ] [MainThread]: 
[0m22:58:45.835735 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.36 seconds (1.36s).
[0m22:58:45.838217 [debug] [MainThread]: Command end result
[0m22:58:45.899978 [info ] [MainThread]: 
[0m22:58:45.901863 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:58:45.903444 [info ] [MainThread]: 
[0m22:58:45.904530 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column swu.season does not exist
  LINE 165: ORDER BY swu.season, tt.weakness_type, tt.metric_value DESC
                     ^
  HINT:  Perhaps you meant to reference the column "swu.season2".
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m22:58:45.905768 [info ] [MainThread]: 
[0m22:58:45.907293 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m22:58:45.910108 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.8558567, "process_user_time": 4.438471, "process_kernel_time": 0.454711, "process_mem_max_rss": "201028", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m22:58:45.911964 [debug] [MainThread]: Command `dbt run` failed at 22:58:45.911438 after 2.86 seconds
[0m22:58:45.914070 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d661688f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d66d44320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x778d66149d00>]}
[0m22:58:45.916665 [debug] [MainThread]: Flushing usage events
[0m22:59:42.813047 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732367adba40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732367ea9d00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732367ada3c0>]}


============================== 22:59:42.817997 | 3943947f-bec6-47fc-8e11-a697f41d8312 ==============================
[0m22:59:42.817997 [info ] [MainThread]: Running with dbt=1.7.9
[0m22:59:42.820195 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m22:59:43.109215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3943947f-bec6-47fc-8e11-a697f41d8312', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732368c21be0>]}
[0m22:59:43.241266 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3943947f-bec6-47fc-8e11-a697f41d8312', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732367b31be0>]}
[0m22:59:43.242950 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m22:59:43.270984 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m22:59:43.536019 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:59:43.537934 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m22:59:43.738402 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m22:59:43.745158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3943947f-bec6-47fc-8e11-a697f41d8312', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7323663ef530>]}
[0m22:59:43.812774 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3943947f-bec6-47fc-8e11-a697f41d8312', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732366b69580>]}
[0m22:59:43.813806 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m22:59:43.814852 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3943947f-bec6-47fc-8e11-a697f41d8312', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732366f3a390>]}
[0m22:59:43.818606 [info ] [MainThread]: 
[0m22:59:43.820549 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:59:43.823125 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m22:59:43.837799 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m22:59:43.838790 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m22:59:43.839617 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:59:43.851794 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m22:59:43.854651 [debug] [ThreadPool]: On list_nba: Close
[0m22:59:43.858830 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m22:59:43.866922 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m22:59:43.868025 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m22:59:43.869286 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:59:43.877133 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m22:59:43.878197 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m22:59:43.879152 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m22:59:43.883655 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.0 seconds
[0m22:59:43.887003 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m22:59:43.888460 [debug] [ThreadPool]: On list_nba_gold: Close
[0m22:59:43.896415 [debug] [MainThread]: Using postgres connection "master"
[0m22:59:43.897580 [debug] [MainThread]: On master: BEGIN
[0m22:59:43.898354 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:59:43.907262 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:59:43.908340 [debug] [MainThread]: Using postgres connection "master"
[0m22:59:43.909363 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:59:43.932487 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m22:59:43.934484 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3943947f-bec6-47fc-8e11-a697f41d8312', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7323673c4b60>]}
[0m22:59:43.936043 [debug] [MainThread]: On master: ROLLBACK
[0m22:59:43.937911 [debug] [MainThread]: Using postgres connection "master"
[0m22:59:43.938856 [debug] [MainThread]: On master: BEGIN
[0m22:59:43.940605 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:59:43.942034 [debug] [MainThread]: On master: COMMIT
[0m22:59:43.943038 [debug] [MainThread]: Using postgres connection "master"
[0m22:59:43.944362 [debug] [MainThread]: On master: COMMIT
[0m22:59:43.945874 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:59:43.947005 [debug] [MainThread]: On master: Close
[0m22:59:43.948754 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:59:43.949862 [info ] [MainThread]: 
[0m22:59:43.955213 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m22:59:43.956852 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m22:59:43.958285 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m22:59:43.959284 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m22:59:43.970214 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m22:59:43.997074 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 22:59:43.960058 => 22:59:43.996303
[0m22:59:43.998145 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m22:59:44.049772 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m22:59:44.076356 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:59:44.077724 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m22:59:44.078673 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:59:44.086043 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:59:44.087480 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:59:44.088603 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m22:59:44.111206 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m22:59:44.119940 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:59:44.120988 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m22:59:44.122554 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:59:44.126795 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:59:44.127981 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m22:59:44.129436 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:59:44.157685 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:59:44.158693 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:59:44.159585 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:59:44.165891 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:59:44.177915 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m22:59:44.188561 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:59:44.189906 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m22:59:44.197326 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:59:44.200502 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 22:59:43.998928 => 22:59:44.200038
[0m22:59:44.202015 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m22:59:44.204501 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3943947f-bec6-47fc-8e11-a697f41d8312', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7323663c47a0>]}
[0m22:59:44.206379 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.25s]
[0m22:59:44.208493 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m22:59:44.209984 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m22:59:44.211331 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m22:59:44.213319 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m22:59:44.214548 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m22:59:44.220967 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m22:59:44.246632 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 22:59:44.215428 => 22:59:44.246227
[0m22:59:44.247660 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m22:59:44.254544 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m22:59:44.281159 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:59:44.282418 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m22:59:44.283548 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:59:44.292014 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:59:44.293731 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:59:44.295044 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m22:59:44.314785 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:59:44.321619 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:59:44.322658 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m22:59:44.324215 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:59:44.328617 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:59:44.329654 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m22:59:44.331223 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:59:44.334816 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m22:59:44.336420 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:59:44.337560 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m22:59:44.347107 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:59:44.355199 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m22:59:44.356945 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:59:44.357869 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m22:59:44.364221 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:59:44.367071 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 22:59:44.248623 => 22:59:44.366768
[0m22:59:44.368124 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m22:59:44.370132 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3943947f-bec6-47fc-8e11-a697f41d8312', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732365f771d0>]}
[0m22:59:44.371355 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.16s]
[0m22:59:44.372908 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m22:59:44.373837 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m22:59:44.374818 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m22:59:44.376576 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m22:59:44.377470 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m22:59:44.382176 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m22:59:44.405307 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 22:59:44.378148 => 22:59:44.404892
[0m22:59:44.406244 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m22:59:44.411572 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m22:59:44.436166 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:59:44.437447 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m22:59:44.438344 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:59:44.445730 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:59:44.446873 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:59:44.448007 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m22:59:44.470878 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m22:59:44.475566 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:59:44.476711 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m22:59:44.478207 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:59:44.482395 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:59:44.483367 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m22:59:44.484879 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:59:44.488218 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:59:44.489457 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:59:44.490451 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:59:44.496499 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:59:44.500353 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m22:59:44.502008 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:59:44.503818 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m22:59:44.511040 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:59:44.513552 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 22:59:44.406922 => 22:59:44.513286
[0m22:59:44.514544 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m22:59:44.516324 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3943947f-bec6-47fc-8e11-a697f41d8312', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732365f77140>]}
[0m22:59:44.517870 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.14s]
[0m22:59:44.520175 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m22:59:44.521534 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m22:59:44.522552 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m22:59:44.524087 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m22:59:44.525010 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m22:59:44.530038 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m22:59:44.556986 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 22:59:44.525852 => 22:59:44.556579
[0m22:59:44.558005 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m22:59:44.563520 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m22:59:44.591290 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:59:44.592324 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m22:59:44.593236 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:59:44.601688 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:59:44.603405 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:59:44.604729 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m22:59:44.638832 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:59:44.643149 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:59:44.644132 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m22:59:44.645752 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:59:44.649875 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:59:44.650869 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m22:59:44.653194 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:59:44.656563 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m22:59:44.657503 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:59:44.658398 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m22:59:44.665741 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:59:44.670648 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m22:59:44.672262 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m22:59:44.673224 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m22:59:44.680844 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:59:44.683181 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 22:59:44.558792 => 22:59:44.682918
[0m22:59:44.684159 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m22:59:44.686814 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3943947f-bec6-47fc-8e11-a697f41d8312', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732365f96330>]}
[0m22:59:44.688657 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.16s]
[0m22:59:44.690340 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m22:59:44.691626 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:59:44.692955 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m22:59:44.694351 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m22:59:44.695301 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:59:44.701165 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:59:44.729554 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 22:59:44.696156 => 22:59:44.729136
[0m22:59:44.730479 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:59:44.738633 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:59:44.764138 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:59:44.765161 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m22:59:44.766109 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:59:44.773569 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:59:44.774656 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:59:44.776184 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m22:59:44.812160 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m22:59:44.817433 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:59:44.819037 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m22:59:44.822003 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:59:44.826341 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:59:44.827454 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m22:59:44.828956 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:59:44.832173 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m22:59:44.833217 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:59:44.834221 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m22:59:44.840712 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:59:44.844572 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m22:59:44.846186 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:59:44.847192 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m22:59:44.855666 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:59:44.858526 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 22:59:44.731171 => 22:59:44.858243
[0m22:59:44.859560 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m22:59:44.860952 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3943947f-bec6-47fc-8e11-a697f41d8312', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732365fc4ec0>]}
[0m22:59:44.862282 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.17s]
[0m22:59:44.864020 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:59:44.866275 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m22:59:44.867431 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m22:59:44.869439 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m22:59:44.870710 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m22:59:44.877462 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m22:59:44.906539 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 22:59:44.871563 => 22:59:44.906156
[0m22:59:44.907550 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m22:59:44.913027 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m22:59:44.939917 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:59:44.941124 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m22:59:44.942600 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:59:44.950966 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:59:44.952367 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:59:44.955621 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

player_stats_game as (

SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM "nba"."silver"."player_stats"
GROUP BY player_id, player_name, team_abbreviation
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_game AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')

    UNION ALL

    SELECT
        'Rebotes' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')

    UNION ALL

    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')

    UNION ALL

    SELECT
        'Robos' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')

    UNION ALL

    SELECT
        'Bloqueos' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    
    UNION ALL
    
    SELECT
        'Diferencial de puntos' AS weakness_type,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m22:59:45.244526 [debug] [Thread-1 (]: SQL status: SELECT 21 in 0.0 seconds
[0m22:59:45.248871 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:59:45.249837 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m22:59:45.251230 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:59:45.255895 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:59:45.256923 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m22:59:45.258397 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:59:45.261254 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m22:59:45.262246 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:59:45.263084 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m22:59:45.268702 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:59:45.273456 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m22:59:45.275191 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:59:45.276234 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m22:59:45.286038 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:59:45.289022 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 22:59:44.908432 => 22:59:45.288633
[0m22:59:45.290142 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m22:59:45.291821 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3943947f-bec6-47fc-8e11-a697f41d8312', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732365fc4ec0>]}
[0m22:59:45.295576 [info ] [Thread-1 (]: 6 of 6 OK created sql table model gold.players_recommendations ................. [[32mSELECT 21[0m in 0.42s]
[0m22:59:45.297131 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m22:59:45.300407 [debug] [MainThread]: Using postgres connection "master"
[0m22:59:45.301306 [debug] [MainThread]: On master: BEGIN
[0m22:59:45.302318 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:59:45.311648 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:59:45.312780 [debug] [MainThread]: On master: COMMIT
[0m22:59:45.313732 [debug] [MainThread]: Using postgres connection "master"
[0m22:59:45.314720 [debug] [MainThread]: On master: COMMIT
[0m22:59:45.316060 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:59:45.317124 [debug] [MainThread]: On master: Close
[0m22:59:45.318900 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:59:45.319954 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m22:59:45.321031 [info ] [MainThread]: 
[0m22:59:45.322037 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.50 seconds (1.50s).
[0m22:59:45.324389 [debug] [MainThread]: Command end result
[0m22:59:45.391238 [info ] [MainThread]: 
[0m22:59:45.392334 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:59:45.393321 [info ] [MainThread]: 
[0m22:59:45.394276 [info ] [MainThread]: Done. PASS=6 WARN=0 ERROR=0 SKIP=0 TOTAL=6
[0m22:59:45.396240 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.675676, "process_user_time": 3.754167, "process_kernel_time": 0.457627, "process_mem_max_rss": "201028", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m22:59:45.397742 [debug] [MainThread]: Command `dbt run` succeeded at 22:59:45.397544 after 2.68 seconds
[0m22:59:45.398718 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73236c49ef30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73236837d220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732367adaba0>]}
[0m22:59:45.399673 [debug] [MainThread]: Flushing usage events
[0m23:04:47.954615 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf4352150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf49d21b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf4351fa0>]}


============================== 23:04:47.959965 | 7d8e22d7-9bb4-4c7f-87ef-5e9058db6225 ==============================
[0m23:04:47.959965 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:04:47.961437 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:04:48.297710 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7d8e22d7-9bb4-4c7f-87ef-5e9058db6225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf5694140>]}
[0m23:04:48.432298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7d8e22d7-9bb4-4c7f-87ef-5e9058db6225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf48652b0>]}
[0m23:04:48.433948 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:04:48.460555 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:04:48.802149 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:04:48.804324 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m23:04:49.091963 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m23:04:49.102673 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7d8e22d7-9bb4-4c7f-87ef-5e9058db6225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf31faf60>]}
[0m23:04:49.182180 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7d8e22d7-9bb4-4c7f-87ef-5e9058db6225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf39adac0>]}
[0m23:04:49.183142 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m23:04:49.184204 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7d8e22d7-9bb4-4c7f-87ef-5e9058db6225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf42467e0>]}
[0m23:04:49.187264 [info ] [MainThread]: 
[0m23:04:49.188781 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:04:49.191252 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m23:04:49.205977 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m23:04:49.206825 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m23:04:49.207537 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:04:49.219630 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m23:04:49.221969 [debug] [ThreadPool]: On list_nba: Close
[0m23:04:49.226296 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m23:04:49.235623 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:04:49.236883 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m23:04:49.237894 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:04:49.246210 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m23:04:49.247374 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:04:49.248230 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m23:04:49.253495 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.0 seconds
[0m23:04:49.255855 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m23:04:49.257302 [debug] [ThreadPool]: On list_nba_gold: Close
[0m23:04:49.267393 [debug] [MainThread]: Using postgres connection "master"
[0m23:04:49.268562 [debug] [MainThread]: On master: BEGIN
[0m23:04:49.269375 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:04:49.276965 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:04:49.278190 [debug] [MainThread]: Using postgres connection "master"
[0m23:04:49.279181 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m23:04:49.300327 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m23:04:49.302787 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7d8e22d7-9bb4-4c7f-87ef-5e9058db6225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf31f7830>]}
[0m23:04:49.303991 [debug] [MainThread]: On master: ROLLBACK
[0m23:04:49.305500 [debug] [MainThread]: Using postgres connection "master"
[0m23:04:49.306577 [debug] [MainThread]: On master: BEGIN
[0m23:04:49.308389 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:04:49.309915 [debug] [MainThread]: On master: COMMIT
[0m23:04:49.311481 [debug] [MainThread]: Using postgres connection "master"
[0m23:04:49.312646 [debug] [MainThread]: On master: COMMIT
[0m23:04:49.313939 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:04:49.315051 [debug] [MainThread]: On master: Close
[0m23:04:49.316703 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m23:04:49.318480 [info ] [MainThread]: 
[0m23:04:49.324372 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m23:04:49.325909 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m23:04:49.328057 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m23:04:49.329312 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m23:04:49.340151 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m23:04:49.369242 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 23:04:49.330161 => 23:04:49.368706
[0m23:04:49.370293 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m23:04:49.429453 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m23:04:49.455112 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:04:49.459048 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m23:04:49.460628 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:04:49.468279 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:04:49.469448 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:04:49.470593 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m23:04:49.495084 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m23:04:49.504381 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:04:49.505483 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m23:04:49.507329 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:04:49.512643 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:04:49.513753 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m23:04:49.515398 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:04:49.547974 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:04:49.549500 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:04:49.550943 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:04:49.559608 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:04:49.571211 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m23:04:49.584437 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:04:49.585581 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m23:04:49.594639 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:04:49.598049 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 23:04:49.371056 => 23:04:49.597758
[0m23:04:49.599104 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m23:04:49.600831 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7d8e22d7-9bb4-4c7f-87ef-5e9058db6225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf421e420>]}
[0m23:04:49.602393 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.27s]
[0m23:04:49.603784 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m23:04:49.604915 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m23:04:49.606291 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m23:04:49.607705 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m23:04:49.608746 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m23:04:49.615451 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m23:04:49.639285 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 23:04:49.610200 => 23:04:49.638826
[0m23:04:49.640287 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m23:04:49.646659 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m23:04:49.672372 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:04:49.673531 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m23:04:49.674469 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:04:49.681787 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:04:49.682895 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:04:49.683933 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m23:04:49.703037 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m23:04:49.707844 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:04:49.708849 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m23:04:49.711094 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:04:49.715422 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:04:49.716622 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m23:04:49.718235 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:04:49.721370 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:04:49.722314 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:04:49.723270 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:04:49.729581 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:04:49.734745 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m23:04:49.736450 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:04:49.737755 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m23:04:49.744678 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:04:49.747402 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 23:04:49.641127 => 23:04:49.747135
[0m23:04:49.748355 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m23:04:49.749988 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7d8e22d7-9bb4-4c7f-87ef-5e9058db6225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf2db7f20>]}
[0m23:04:49.751178 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.14s]
[0m23:04:49.752662 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m23:04:49.753918 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m23:04:49.755076 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m23:04:49.756871 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m23:04:49.758096 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m23:04:49.763610 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m23:04:49.789582 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 23:04:49.758935 => 23:04:49.789178
[0m23:04:49.790508 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m23:04:49.797009 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m23:04:49.821921 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:04:49.822874 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m23:04:49.823735 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:04:49.831384 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:04:49.832515 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:04:49.833510 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m23:04:49.855117 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m23:04:49.861220 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:04:49.862470 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m23:04:49.864238 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:04:49.868819 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:04:49.870013 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m23:04:49.871597 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:04:49.874835 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:04:49.876599 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:04:49.878207 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:04:49.884231 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:04:49.888667 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m23:04:49.890478 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:04:49.891700 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m23:04:49.900284 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:04:49.902931 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 23:04:49.791324 => 23:04:49.902654
[0m23:04:49.904022 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m23:04:49.905761 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7d8e22d7-9bb4-4c7f-87ef-5e9058db6225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf2db7f20>]}
[0m23:04:49.907307 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m23:04:49.909010 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m23:04:49.910789 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m23:04:49.911851 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m23:04:49.913240 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m23:04:49.914245 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m23:04:49.920712 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m23:04:49.952330 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 23:04:49.915226 => 23:04:49.951918
[0m23:04:49.953454 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m23:04:49.962187 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m23:04:49.991114 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:04:49.992439 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m23:04:49.994228 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:04:50.001313 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:04:50.002597 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:04:50.003919 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m23:04:50.040748 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m23:04:50.046702 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:04:50.047861 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m23:04:50.049523 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:04:50.053733 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:04:50.054802 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m23:04:50.056634 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:04:50.060732 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:04:50.061962 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:04:50.062944 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:04:50.071192 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:04:50.075407 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m23:04:50.077440 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:04:50.078598 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m23:04:50.086376 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:04:50.088840 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 23:04:49.954261 => 23:04:50.088562
[0m23:04:50.089957 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m23:04:50.091536 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7d8e22d7-9bb4-4c7f-87ef-5e9058db6225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf3501790>]}
[0m23:04:50.092889 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.18s]
[0m23:04:50.094949 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m23:04:50.096862 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:04:50.099267 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m23:04:50.101230 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m23:04:50.102323 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:04:50.107903 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:04:50.135954 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 23:04:50.103155 => 23:04:50.135544
[0m23:04:50.136953 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:04:50.145380 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:04:50.172014 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:04:50.173131 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m23:04:50.174106 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:04:50.181405 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:04:50.182510 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:04:50.183811 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m23:04:50.223106 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m23:04:50.228209 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:04:50.229441 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m23:04:50.231092 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:04:50.235427 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:04:50.236852 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m23:04:50.238821 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:04:50.243051 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:04:50.244381 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:04:50.245527 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:04:50.255077 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:04:50.259839 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m23:04:50.261755 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:04:50.262917 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m23:04:50.270314 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:04:50.272716 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 23:04:50.137948 => 23:04:50.272455
[0m23:04:50.273764 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m23:04:50.275656 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7d8e22d7-9bb4-4c7f-87ef-5e9058db6225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf2dd0800>]}
[0m23:04:50.277998 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.17s]
[0m23:04:50.279578 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:04:50.281908 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m23:04:50.283047 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m23:04:50.284399 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m23:04:50.285452 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m23:04:50.291632 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m23:04:50.321620 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 23:04:50.286380 => 23:04:50.321227
[0m23:04:50.322595 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m23:04:50.328951 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m23:04:50.355656 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:04:50.356678 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m23:04:50.358056 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:04:50.364809 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:04:50.365988 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:04:50.367262 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

player_stats_game as (

SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM "nba"."silver"."player_stats"
GROUP BY player_id, player_name, team_abbreviation
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_game AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')
    order by avg_fg_pct DESC
    limit 3

    UNION ALL

    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')
    order by avg_fg3_pct DESC
    limit 3

    UNION ALL

    SELECT
        'Rebotes' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')
    order by avg_reb DESC
    limit 3

    UNION ALL

    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')
    order by avg_tov ASC    
    limit 3

    UNION ALL

    SELECT
        'Robos' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')
    order by avg_stl DESC
    limit 3

    UNION ALL

    SELECT
        'Bloqueos' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    order by avg_blk DESC
    limit 3
    
    UNION ALL
    
    SELECT
        'Diferencial de puntos' AS weakness_type,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
    order by avg_plus_minus DESC
    limit 3
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m23:04:50.369350 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "UNION"
LINE 84:     UNION ALL
             ^

[0m23:04:50.370399 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m23:04:50.371906 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 23:04:50.323474 => 23:04:50.371597
[0m23:04:50.372953 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m23:04:50.379567 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "UNION"
  LINE 84:     UNION ALL
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m23:04:50.380689 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7d8e22d7-9bb4-4c7f-87ef-5e9058db6225', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf2906000>]}
[0m23:04:50.381859 [error] [Thread-1 (]: 6 of 6 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m23:04:50.383182 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m23:04:50.387199 [debug] [MainThread]: Using postgres connection "master"
[0m23:04:50.388358 [debug] [MainThread]: On master: BEGIN
[0m23:04:50.389470 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:04:50.396930 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:04:50.398248 [debug] [MainThread]: On master: COMMIT
[0m23:04:50.399106 [debug] [MainThread]: Using postgres connection "master"
[0m23:04:50.400068 [debug] [MainThread]: On master: COMMIT
[0m23:04:50.401287 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:04:50.402335 [debug] [MainThread]: On master: Close
[0m23:04:50.403811 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:04:50.404786 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m23:04:50.405894 [info ] [MainThread]: 
[0m23:04:50.406909 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.22 seconds (1.22s).
[0m23:04:50.409644 [debug] [MainThread]: Command end result
[0m23:04:50.468257 [info ] [MainThread]: 
[0m23:04:50.469357 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m23:04:50.470280 [info ] [MainThread]: 
[0m23:04:50.471180 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "UNION"
  LINE 84:     UNION ALL
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m23:04:50.472039 [info ] [MainThread]: 
[0m23:04:50.472985 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m23:04:50.474683 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.617234, "process_user_time": 4.052219, "process_kernel_time": 0.493, "process_mem_max_rss": "201004", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m23:04:50.476232 [debug] [MainThread]: Command `dbt run` failed at 23:04:50.475750 after 2.62 seconds
[0m23:04:50.477848 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf447fb90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf31f5760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x732cf31f56a0>]}
[0m23:04:50.478840 [debug] [MainThread]: Flushing usage events
[0m23:12:34.856290 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f69d8d70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f6da5c40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f69da780>]}


============================== 23:12:34.860690 | 89f47d30-043d-4ba3-9799-ec34ee22ef6c ==============================
[0m23:12:34.860690 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:12:34.862162 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:12:35.168230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '89f47d30-043d-4ba3-9799-ec34ee22ef6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f6e467b0>]}
[0m23:12:35.294431 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '89f47d30-043d-4ba3-9799-ec34ee22ef6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f7cadbe0>]}
[0m23:12:35.295820 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:12:35.323263 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:12:35.588233 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:12:35.589517 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m23:12:35.796723 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m23:12:35.804120 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '89f47d30-043d-4ba3-9799-ec34ee22ef6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f5965040>]}
[0m23:12:35.877770 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '89f47d30-043d-4ba3-9799-ec34ee22ef6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f59ad400>]}
[0m23:12:35.879201 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m23:12:35.880289 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '89f47d30-043d-4ba3-9799-ec34ee22ef6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f5181250>]}
[0m23:12:35.883207 [info ] [MainThread]: 
[0m23:12:35.884691 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:12:35.888188 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m23:12:35.902668 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m23:12:35.904238 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m23:12:35.905204 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:12:35.914460 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m23:12:35.916776 [debug] [ThreadPool]: On list_nba: Close
[0m23:12:35.921354 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m23:12:35.929329 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:12:35.930440 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m23:12:35.931354 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:12:35.940630 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m23:12:35.941857 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:12:35.942721 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m23:12:35.947833 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.0 seconds
[0m23:12:35.950102 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m23:12:35.951306 [debug] [ThreadPool]: On list_nba_gold: Close
[0m23:12:35.960308 [debug] [MainThread]: Using postgres connection "master"
[0m23:12:35.961647 [debug] [MainThread]: On master: BEGIN
[0m23:12:35.962587 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:12:35.969851 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:12:35.971265 [debug] [MainThread]: Using postgres connection "master"
[0m23:12:35.972222 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m23:12:35.991793 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m23:12:35.993908 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '89f47d30-043d-4ba3-9799-ec34ee22ef6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f5501310>]}
[0m23:12:35.994918 [debug] [MainThread]: On master: ROLLBACK
[0m23:12:35.996149 [debug] [MainThread]: Using postgres connection "master"
[0m23:12:35.997145 [debug] [MainThread]: On master: BEGIN
[0m23:12:35.999040 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:12:36.000025 [debug] [MainThread]: On master: COMMIT
[0m23:12:36.000892 [debug] [MainThread]: Using postgres connection "master"
[0m23:12:36.001775 [debug] [MainThread]: On master: COMMIT
[0m23:12:36.003591 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:12:36.004719 [debug] [MainThread]: On master: Close
[0m23:12:36.006228 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m23:12:36.007211 [info ] [MainThread]: 
[0m23:12:36.012400 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m23:12:36.013664 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m23:12:36.014905 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m23:12:36.015846 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m23:12:36.027796 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m23:12:36.055364 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 23:12:36.017040 => 23:12:36.054973
[0m23:12:36.056381 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m23:12:36.110080 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m23:12:36.137387 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:12:36.138699 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m23:12:36.139668 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:12:36.146351 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:12:36.147453 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:12:36.148399 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m23:12:36.172458 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m23:12:36.180712 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:12:36.181829 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m23:12:36.183495 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:12:36.188375 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:12:36.189828 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m23:12:36.191557 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:12:36.221912 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:12:36.222978 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:12:36.224017 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:12:36.234486 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:12:36.245201 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m23:12:36.255462 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:12:36.256539 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m23:12:36.265997 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:12:36.268924 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 23:12:36.057139 => 23:12:36.268387
[0m23:12:36.270710 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m23:12:36.272367 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '89f47d30-043d-4ba3-9799-ec34ee22ef6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f4d108c0>]}
[0m23:12:36.273649 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.26s]
[0m23:12:36.275175 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m23:12:36.276278 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m23:12:36.277570 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m23:12:36.279346 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m23:12:36.280304 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m23:12:36.285340 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m23:12:36.312647 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 23:12:36.281108 => 23:12:36.312265
[0m23:12:36.313614 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m23:12:36.320676 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m23:12:36.348812 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:12:36.350100 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m23:12:36.351109 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:12:36.358374 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:12:36.359470 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:12:36.360557 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m23:12:36.382038 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m23:12:36.391722 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:12:36.393692 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m23:12:36.396506 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:12:36.405795 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:12:36.407794 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m23:12:36.410467 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:12:36.416240 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:12:36.418061 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:12:36.420200 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:12:36.429363 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:12:36.439536 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m23:12:36.441438 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:12:36.442530 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m23:12:36.449446 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:12:36.451983 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 23:12:36.314443 => 23:12:36.451624
[0m23:12:36.453706 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m23:12:36.455705 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '89f47d30-043d-4ba3-9799-ec34ee22ef6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f4dbb2c0>]}
[0m23:12:36.457285 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.18s]
[0m23:12:36.458764 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m23:12:36.459961 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m23:12:36.461313 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m23:12:36.462735 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m23:12:36.463698 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m23:12:36.468359 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m23:12:36.495308 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 23:12:36.464477 => 23:12:36.494919
[0m23:12:36.496511 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m23:12:36.504264 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m23:12:36.529642 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:12:36.530779 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m23:12:36.531738 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:12:36.539685 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:12:36.540792 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:12:36.541909 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m23:12:36.563980 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m23:12:36.568466 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:12:36.569851 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m23:12:36.571519 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:12:36.575753 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:12:36.576778 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m23:12:36.578224 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:12:36.581555 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:12:36.582574 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:12:36.583583 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:12:36.591097 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:12:36.595514 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m23:12:36.597295 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:12:36.598723 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m23:12:36.607973 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:12:36.610916 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 23:12:36.497508 => 23:12:36.610593
[0m23:12:36.611893 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m23:12:36.613557 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '89f47d30-043d-4ba3-9799-ec34ee22ef6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f4dbbef0>]}
[0m23:12:36.615041 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m23:12:36.616571 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m23:12:36.617978 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m23:12:36.619811 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m23:12:36.621641 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m23:12:36.622884 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m23:12:36.628878 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m23:12:36.656482 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 23:12:36.623676 => 23:12:36.656090
[0m23:12:36.657620 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m23:12:36.663948 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m23:12:36.695310 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:12:36.697116 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m23:12:36.698764 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:12:36.707718 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:12:36.709362 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:12:36.711109 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m23:12:36.752773 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m23:12:36.760412 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:12:36.761999 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m23:12:36.763885 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:12:36.770587 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:12:36.772241 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m23:12:36.774936 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:12:36.779396 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:12:36.781486 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:12:36.782949 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:12:36.788872 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:12:36.794210 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m23:12:36.796215 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:12:36.797623 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m23:12:36.805264 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:12:36.808539 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 23:12:36.658812 => 23:12:36.808160
[0m23:12:36.810016 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m23:12:36.811899 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '89f47d30-043d-4ba3-9799-ec34ee22ef6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f4d03800>]}
[0m23:12:36.815081 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.19s]
[0m23:12:36.817210 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m23:12:36.818861 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:12:36.820624 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m23:12:36.822529 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m23:12:36.823927 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:12:36.836637 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:12:36.866202 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 23:12:36.825350 => 23:12:36.865804
[0m23:12:36.867178 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:12:36.875428 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:12:36.903207 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:12:36.904662 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m23:12:36.905773 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:12:36.912637 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:12:36.913698 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:12:36.914868 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m23:12:36.956074 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m23:12:36.961155 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:12:36.962226 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m23:12:36.963605 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:12:36.967749 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:12:36.969188 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m23:12:36.971451 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:12:36.974499 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:12:36.975580 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:12:36.977488 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:12:36.983298 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:12:36.989156 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m23:12:36.990704 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:12:36.991607 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m23:12:36.999913 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:12:37.003246 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 23:12:36.867911 => 23:12:37.002879
[0m23:12:37.004449 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m23:12:37.006273 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '89f47d30-043d-4ba3-9799-ec34ee22ef6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f4909100>]}
[0m23:12:37.007735 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.18s]
[0m23:12:37.009383 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:12:37.011503 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m23:12:37.012786 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m23:12:37.014327 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m23:12:37.015506 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m23:12:37.023231 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m23:12:37.049801 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 23:12:37.016419 => 23:12:37.049333
[0m23:12:37.050829 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m23:12:37.057614 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m23:12:37.083621 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:12:37.084635 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m23:12:37.085844 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:12:37.094203 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:12:37.095322 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:12:37.096500 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

player_stats_game as (

SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM "nba"."silver"."player_stats"
GROUP BY player_id, player_name, team_abbreviation
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_game AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')
    order by avg_fg_pct DESC
   

    UNION ALL

    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')
    order by avg_fg3_pct DESC
    

    UNION ALL

    SELECT
        'Rebotes' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')
    order by avg_reb DESC
    

    UNION ALL

    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')
    order by avg_tov ASC    
   

    UNION ALL

    SELECT
        'Robos' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')
    order by avg_stl DESC
    

    UNION ALL

    SELECT
        'Bloqueos' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    order by avg_blk DESC
    
    
    UNION ALL
    
    SELECT
        'Diferencial de puntos' AS weakness_type,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
    order by avg_plus_minus DESC
    
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m23:12:37.099186 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "UNION"
LINE 84:     UNION ALL
             ^

[0m23:12:37.100451 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m23:12:37.101931 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 23:12:37.051682 => 23:12:37.101532
[0m23:12:37.103388 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m23:12:37.111318 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "UNION"
  LINE 84:     UNION ALL
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m23:12:37.112454 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '89f47d30-043d-4ba3-9799-ec34ee22ef6c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f5111250>]}
[0m23:12:37.113586 [error] [Thread-1 (]: 6 of 6 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m23:12:37.115215 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m23:12:37.120501 [debug] [MainThread]: Using postgres connection "master"
[0m23:12:37.122042 [debug] [MainThread]: On master: BEGIN
[0m23:12:37.123467 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:12:37.131292 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:12:37.132350 [debug] [MainThread]: On master: COMMIT
[0m23:12:37.133306 [debug] [MainThread]: Using postgres connection "master"
[0m23:12:37.134295 [debug] [MainThread]: On master: COMMIT
[0m23:12:37.135819 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:12:37.137443 [debug] [MainThread]: On master: Close
[0m23:12:37.139454 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:12:37.140480 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m23:12:37.141491 [info ] [MainThread]: 
[0m23:12:37.142505 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.26 seconds (1.26s).
[0m23:12:37.144574 [debug] [MainThread]: Command end result
[0m23:12:37.212350 [info ] [MainThread]: 
[0m23:12:37.213398 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m23:12:37.214516 [info ] [MainThread]: 
[0m23:12:37.215717 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "UNION"
  LINE 84:     UNION ALL
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m23:12:37.216878 [info ] [MainThread]: 
[0m23:12:37.218555 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m23:12:37.221285 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.4550169, "process_user_time": 3.847866, "process_kernel_time": 0.453643, "process_mem_max_rss": "201020", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m23:12:37.222438 [debug] [MainThread]: Command `dbt run` failed at 23:12:37.222259 after 2.46 seconds
[0m23:12:37.223444 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f69d8cb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f51802f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7296f5147b60>]}
[0m23:12:37.224453 [debug] [MainThread]: Flushing usage events
[0m23:15:12.221217 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42f04735f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42f0739c40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42f0371940>]}


============================== 23:15:12.225585 | 96d50ed6-f50d-45e7-bd8a-c90a0d12762e ==============================
[0m23:15:12.225585 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:15:12.227280 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:15:12.567211 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '96d50ed6-f50d-45e7-bd8a-c90a0d12762e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42f04a3d70>]}
[0m23:15:12.687640 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '96d50ed6-f50d-45e7-bd8a-c90a0d12762e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42f0242960>]}
[0m23:15:12.689073 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:15:12.716570 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:15:13.047151 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:15:13.048440 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m23:15:13.259942 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m23:15:13.267573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '96d50ed6-f50d-45e7-bd8a-c90a0d12762e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42ef1f7680>]}
[0m23:15:13.345329 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '96d50ed6-f50d-45e7-bd8a-c90a0d12762e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42ef9acc80>]}
[0m23:15:13.346803 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m23:15:13.347931 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '96d50ed6-f50d-45e7-bd8a-c90a0d12762e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42ef181160>]}
[0m23:15:13.350809 [info ] [MainThread]: 
[0m23:15:13.352831 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:15:13.356368 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m23:15:13.371483 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m23:15:13.372536 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m23:15:13.373469 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:15:13.382686 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m23:15:13.384909 [debug] [ThreadPool]: On list_nba: Close
[0m23:15:13.389426 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m23:15:13.397316 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:15:13.398727 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m23:15:13.399894 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:15:13.408749 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m23:15:13.409802 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:15:13.410730 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m23:15:13.415828 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.0 seconds
[0m23:15:13.418189 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m23:15:13.419631 [debug] [ThreadPool]: On list_nba_gold: Close
[0m23:15:13.428121 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:13.429477 [debug] [MainThread]: On master: BEGIN
[0m23:15:13.430416 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:15:13.437489 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:15:13.438581 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:13.439447 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m23:15:13.458191 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m23:15:13.460568 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '96d50ed6-f50d-45e7-bd8a-c90a0d12762e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42f039fb60>]}
[0m23:15:13.461704 [debug] [MainThread]: On master: ROLLBACK
[0m23:15:13.463176 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:13.464186 [debug] [MainThread]: On master: BEGIN
[0m23:15:13.466161 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:15:13.467427 [debug] [MainThread]: On master: COMMIT
[0m23:15:13.468390 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:13.469580 [debug] [MainThread]: On master: COMMIT
[0m23:15:13.471531 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:15:13.472559 [debug] [MainThread]: On master: Close
[0m23:15:13.474043 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m23:15:13.475323 [info ] [MainThread]: 
[0m23:15:13.480901 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m23:15:13.483232 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m23:15:13.484891 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m23:15:13.488030 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m23:15:13.500675 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m23:15:13.526529 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 23:15:13.489261 => 23:15:13.525909
[0m23:15:13.527696 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m23:15:13.580318 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m23:15:13.608506 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:15:13.609565 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m23:15:13.610612 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:15:13.617105 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:15:13.618271 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:15:13.619733 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m23:15:13.639416 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m23:15:13.647996 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:15:13.649128 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m23:15:13.650600 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:15:13.655951 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:15:13.657003 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m23:15:13.658540 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:15:13.689211 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:15:13.690412 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:15:13.691396 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:15:13.697418 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:15:13.708915 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m23:15:13.717101 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:15:13.718240 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m23:15:13.726660 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:15:13.729238 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 23:15:13.528454 => 23:15:13.728969
[0m23:15:13.730288 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m23:15:13.732061 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '96d50ed6-f50d-45e7-bd8a-c90a0d12762e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42eed18800>]}
[0m23:15:13.733469 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.25s]
[0m23:15:13.735284 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m23:15:13.737013 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m23:15:13.738804 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m23:15:13.740666 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m23:15:13.741790 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m23:15:13.746709 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m23:15:13.773606 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 23:15:13.742626 => 23:15:13.773214
[0m23:15:13.774581 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m23:15:13.779822 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m23:15:13.807690 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:15:13.808814 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m23:15:13.809794 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:15:13.817597 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:15:13.818651 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:15:13.820470 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m23:15:13.838894 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m23:15:13.843632 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:15:13.844732 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m23:15:13.846244 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:15:13.853559 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:15:13.856880 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m23:15:13.861106 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:15:13.868492 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:15:13.871839 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:15:13.874762 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:15:13.884456 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:15:13.906778 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m23:15:13.910588 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:15:13.912094 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m23:15:13.919522 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:15:13.923198 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 23:15:13.775216 => 23:15:13.922742
[0m23:15:13.927818 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m23:15:13.932825 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '96d50ed6-f50d-45e7-bd8a-c90a0d12762e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42eedbb410>]}
[0m23:15:13.939896 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.19s]
[0m23:15:13.942021 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m23:15:13.943390 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m23:15:13.944730 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m23:15:13.946896 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m23:15:13.948653 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m23:15:13.955171 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m23:15:13.978456 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 23:15:13.949657 => 23:15:13.977966
[0m23:15:13.979559 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m23:15:13.986572 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m23:15:14.009481 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:15:14.010540 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m23:15:14.011705 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:15:14.020157 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:15:14.021444 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:15:14.022630 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m23:15:14.043009 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m23:15:14.048389 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:15:14.049331 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m23:15:14.050769 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:15:14.056821 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:15:14.057772 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m23:15:14.058989 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:15:14.062103 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:15:14.063443 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:15:14.064411 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:15:14.069890 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:15:14.074058 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m23:15:14.075748 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:15:14.076704 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m23:15:14.082872 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:15:14.085468 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 23:15:13.980463 => 23:15:14.085103
[0m23:15:14.087184 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m23:15:14.088788 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '96d50ed6-f50d-45e7-bd8a-c90a0d12762e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42eedbb680>]}
[0m23:15:14.090027 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.14s]
[0m23:15:14.091453 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m23:15:14.092429 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m23:15:14.093469 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m23:15:14.094948 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m23:15:14.096383 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m23:15:14.101645 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m23:15:14.126974 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 23:15:14.097106 => 23:15:14.126292
[0m23:15:14.128150 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m23:15:14.133522 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m23:15:14.157738 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:15:14.158651 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m23:15:14.159448 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:15:14.166076 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:15:14.167172 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:15:14.168303 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m23:15:14.200011 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m23:15:14.205220 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:15:14.206705 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m23:15:14.208316 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:15:14.212326 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:15:14.213259 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m23:15:14.214612 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:15:14.217394 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:15:14.218419 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:15:14.220054 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:15:14.226508 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:15:14.230551 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m23:15:14.232164 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:15:14.233116 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m23:15:14.240355 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:15:14.242853 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 23:15:14.128863 => 23:15:14.242587
[0m23:15:14.243985 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m23:15:14.245895 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '96d50ed6-f50d-45e7-bd8a-c90a0d12762e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42ef5021e0>]}
[0m23:15:14.247613 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.15s]
[0m23:15:14.249056 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m23:15:14.250496 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:15:14.252156 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m23:15:14.254849 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m23:15:14.257153 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:15:14.265158 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:15:14.297219 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 23:15:14.258781 => 23:15:14.296322
[0m23:15:14.299186 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:15:14.309821 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:15:14.388890 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:15:14.389902 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m23:15:14.391199 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:15:14.400320 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:15:14.401598 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:15:14.403724 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m23:15:14.437655 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m23:15:14.442873 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:15:14.444310 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m23:15:14.446047 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:15:14.450169 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:15:14.451274 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m23:15:14.452956 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:15:14.456081 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:15:14.457165 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:15:14.458067 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:15:14.463456 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:15:14.467686 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m23:15:14.469346 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:15:14.471592 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m23:15:14.477995 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:15:14.480526 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 23:15:14.300347 => 23:15:14.480237
[0m23:15:14.481363 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m23:15:14.482961 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '96d50ed6-f50d-45e7-bd8a-c90a0d12762e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42ee90b1a0>]}
[0m23:15:14.484231 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.23s]
[0m23:15:14.485649 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:15:14.488700 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m23:15:14.489899 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m23:15:14.491360 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m23:15:14.492230 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m23:15:14.498972 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m23:15:14.523950 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 23:15:14.492864 => 23:15:14.523430
[0m23:15:14.525150 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m23:15:14.530950 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m23:15:14.553979 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:15:14.555301 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m23:15:14.556352 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:15:14.563668 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:15:14.564709 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:15:14.565835 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

player_stats_game as (

SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM "nba"."silver"."player_stats"
GROUP BY player_id, player_name, team_abbreviation
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_game AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')
    order by avg_fg_pct DESC
   

    UNION ALL

    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')
    order by avg_fg3_pct DESC
    

    UNION ALL

    SELECT
        'Rebotes' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')
    order by avg_reb DESC
    

    UNION ALL

    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')
    order by avg_tov ASC    
   

    UNION ALL

    SELECT
        'Robos' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')
    order by avg_stl DESC
    

    UNION ALL

    SELECT
        'Bloqueos' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    order by avg_blk DESC
    
    
    UNION ALL
    
    SELECT
        'Diferencial de puntos' AS weakness_type,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
    order by avg_plus_minus DESC
    
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m23:15:14.568211 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "UNION"
LINE 84:     UNION ALL
             ^

[0m23:15:14.569571 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m23:15:14.571605 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 23:15:14.526008 => 23:15:14.571227
[0m23:15:14.572545 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m23:15:14.578016 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "UNION"
  LINE 84:     UNION ALL
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m23:15:14.579171 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '96d50ed6-f50d-45e7-bd8a-c90a0d12762e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42ee90b1a0>]}
[0m23:15:14.580296 [error] [Thread-1 (]: 6 of 6 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.09s]
[0m23:15:14.581550 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m23:15:14.585150 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:14.586284 [debug] [MainThread]: On master: BEGIN
[0m23:15:14.587393 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:15:14.593709 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:15:14.594677 [debug] [MainThread]: On master: COMMIT
[0m23:15:14.595522 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:14.596332 [debug] [MainThread]: On master: COMMIT
[0m23:15:14.597470 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:15:14.598269 [debug] [MainThread]: On master: Close
[0m23:15:14.599606 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:15:14.600616 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m23:15:14.601634 [info ] [MainThread]: 
[0m23:15:14.602760 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.25 seconds (1.25s).
[0m23:15:14.605342 [debug] [MainThread]: Command end result
[0m23:15:14.663134 [info ] [MainThread]: 
[0m23:15:14.664211 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m23:15:14.665130 [info ] [MainThread]: 
[0m23:15:14.666198 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "UNION"
  LINE 84:     UNION ALL
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m23:15:14.667199 [info ] [MainThread]: 
[0m23:15:14.668150 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m23:15:14.670228 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.5388944, "process_user_time": 3.924323, "process_kernel_time": 0.455109, "process_mem_max_rss": "201016", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m23:15:14.671400 [debug] [MainThread]: Command `dbt run` failed at 23:15:14.671198 after 2.54 seconds
[0m23:15:14.672392 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42f49a8da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42efcbc0e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e42ef1fb680>]}
[0m23:15:14.673413 [debug] [MainThread]: Flushing usage events
[0m23:17:04.626200 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31f263ef0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31f262bd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31f262240>]}


============================== 23:17:04.633761 | 3091135a-3d6a-42a5-8314-2ceb014c49bb ==============================
[0m23:17:04.633761 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:17:04.635728 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:17:05.023398 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3091135a-3d6a-42a5-8314-2ceb014c49bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31e984740>]}
[0m23:17:05.180612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3091135a-3d6a-42a5-8314-2ceb014c49bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31f28f230>]}
[0m23:17:05.182265 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:17:05.210172 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:17:05.532745 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:17:05.535212 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m23:17:05.784062 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m23:17:05.794307 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3091135a-3d6a-42a5-8314-2ceb014c49bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31e9f0650>]}
[0m23:17:05.931767 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3091135a-3d6a-42a5-8314-2ceb014c49bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31e5b5310>]}
[0m23:17:05.932838 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m23:17:05.935159 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3091135a-3d6a-42a5-8314-2ceb014c49bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31dd1ddf0>]}
[0m23:17:05.940046 [info ] [MainThread]: 
[0m23:17:05.941693 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:17:05.944359 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m23:17:05.962715 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m23:17:05.963705 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m23:17:05.964394 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:17:05.975702 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m23:17:05.977790 [debug] [ThreadPool]: On list_nba: Close
[0m23:17:05.981082 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m23:17:05.992744 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:17:05.993710 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m23:17:05.994531 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:17:06.003941 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m23:17:06.005180 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:17:06.006065 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m23:17:06.011744 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.0 seconds
[0m23:17:06.014161 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m23:17:06.015430 [debug] [ThreadPool]: On list_nba_gold: Close
[0m23:17:06.027643 [debug] [MainThread]: Using postgres connection "master"
[0m23:17:06.029247 [debug] [MainThread]: On master: BEGIN
[0m23:17:06.030259 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:17:06.040461 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:17:06.041635 [debug] [MainThread]: Using postgres connection "master"
[0m23:17:06.042652 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m23:17:06.066478 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m23:17:06.071665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3091135a-3d6a-42a5-8314-2ceb014c49bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31ddffb90>]}
[0m23:17:06.073391 [debug] [MainThread]: On master: ROLLBACK
[0m23:17:06.075083 [debug] [MainThread]: Using postgres connection "master"
[0m23:17:06.076397 [debug] [MainThread]: On master: BEGIN
[0m23:17:06.078342 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:17:06.079776 [debug] [MainThread]: On master: COMMIT
[0m23:17:06.080651 [debug] [MainThread]: Using postgres connection "master"
[0m23:17:06.081480 [debug] [MainThread]: On master: COMMIT
[0m23:17:06.082677 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:17:06.084814 [debug] [MainThread]: On master: Close
[0m23:17:06.088080 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m23:17:06.090497 [info ] [MainThread]: 
[0m23:17:06.096315 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m23:17:06.097596 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m23:17:06.099736 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m23:17:06.102644 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m23:17:06.119361 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m23:17:06.143551 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 23:17:06.104561 => 23:17:06.143078
[0m23:17:06.144499 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m23:17:06.232756 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m23:17:06.264168 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:17:06.265944 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m23:17:06.268160 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:17:06.278504 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:17:06.280460 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:17:06.283406 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m23:17:06.311202 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m23:17:06.323870 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:17:06.325209 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m23:17:06.327905 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:17:06.336778 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:17:06.338590 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m23:17:06.340233 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:17:06.372650 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:17:06.373851 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:17:06.374746 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:17:06.386531 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:17:06.396827 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m23:17:06.409521 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:17:06.410514 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m23:17:06.421098 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:17:06.424429 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 23:17:06.145290 => 23:17:06.424110
[0m23:17:06.425536 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m23:17:06.427531 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3091135a-3d6a-42a5-8314-2ceb014c49bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31e525cd0>]}
[0m23:17:06.429129 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.33s]
[0m23:17:06.431047 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m23:17:06.432281 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m23:17:06.434249 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m23:17:06.439042 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m23:17:06.440224 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m23:17:06.446241 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m23:17:06.470285 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 23:17:06.441356 => 23:17:06.469485
[0m23:17:06.471964 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m23:17:06.478215 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m23:17:06.501331 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:17:06.504044 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m23:17:06.505573 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:17:06.513693 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:17:06.514931 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:17:06.516113 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m23:17:06.541764 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m23:17:06.547179 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:17:06.548354 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m23:17:06.550086 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:17:06.560450 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:17:06.561538 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m23:17:06.563022 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:17:06.566039 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:17:06.567606 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:17:06.570038 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:17:06.576607 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:17:06.582120 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m23:17:06.584320 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:17:06.586821 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m23:17:06.595871 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:17:06.598550 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 23:17:06.472846 => 23:17:06.598205
[0m23:17:06.599567 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m23:17:06.603236 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3091135a-3d6a-42a5-8314-2ceb014c49bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31d9dc5c0>]}
[0m23:17:06.605530 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.16s]
[0m23:17:06.607956 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m23:17:06.609530 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m23:17:06.611071 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m23:17:06.612579 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m23:17:06.613502 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m23:17:06.621103 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m23:17:06.642201 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 23:17:06.614262 => 23:17:06.641746
[0m23:17:06.643164 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m23:17:06.648449 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m23:17:06.670534 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:17:06.672014 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m23:17:06.672930 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:17:06.679354 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:17:06.680294 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:17:06.681082 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m23:17:06.711863 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m23:17:06.716269 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:17:06.717635 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m23:17:06.720251 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:17:06.725089 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:17:06.725976 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m23:17:06.727218 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:17:06.730065 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:17:06.730931 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:17:06.731706 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:17:06.738804 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:17:06.742598 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m23:17:06.743963 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:17:06.744761 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m23:17:06.751531 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:17:06.755222 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 23:17:06.643734 => 23:17:06.754920
[0m23:17:06.756204 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m23:17:06.757780 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3091135a-3d6a-42a5-8314-2ceb014c49bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31d9ceba0>]}
[0m23:17:06.759014 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m23:17:06.760307 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m23:17:06.761283 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m23:17:06.762297 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m23:17:06.763653 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m23:17:06.764556 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m23:17:06.771527 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m23:17:06.795193 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 23:17:06.765209 => 23:17:06.794711
[0m23:17:06.796083 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m23:17:06.803724 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m23:17:06.834585 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:17:06.836969 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m23:17:06.838685 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:17:06.846488 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:17:06.847680 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:17:06.849140 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m23:17:06.887923 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m23:17:06.894107 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:17:06.895674 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m23:17:06.897660 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:17:06.906133 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:17:06.907596 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m23:17:06.909293 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:17:06.912633 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:17:06.913708 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:17:06.914779 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:17:06.921178 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:17:06.933001 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m23:17:06.976396 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:17:06.980120 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m23:17:06.996858 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:17:07.000499 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 23:17:06.796671 => 23:17:06.999880
[0m23:17:07.003672 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m23:17:07.005941 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3091135a-3d6a-42a5-8314-2ceb014c49bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31f99eb70>]}
[0m23:17:07.007479 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.24s]
[0m23:17:07.009727 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m23:17:07.011429 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:17:07.013672 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m23:17:07.016240 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m23:17:07.021916 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:17:07.036214 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:17:07.062151 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 23:17:07.024922 => 23:17:07.061749
[0m23:17:07.063113 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:17:07.073029 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:17:07.097226 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:17:07.098120 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m23:17:07.098967 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:17:07.107559 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:17:07.109085 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:17:07.110616 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m23:17:07.148027 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m23:17:07.155152 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:17:07.156111 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m23:17:07.157619 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:17:07.161852 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:17:07.162760 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m23:17:07.164040 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:17:07.167773 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:17:07.169830 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:17:07.171022 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:17:07.175991 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:17:07.180600 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m23:17:07.181971 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:17:07.183165 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m23:17:07.191578 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:17:07.194080 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 23:17:07.063695 => 23:17:07.193790
[0m23:17:07.195208 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m23:17:07.196789 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3091135a-3d6a-42a5-8314-2ceb014c49bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31d5131a0>]}
[0m23:17:07.198047 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.18s]
[0m23:17:07.200308 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:17:07.204488 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m23:17:07.206192 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m23:17:07.207786 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m23:17:07.209260 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m23:17:07.216222 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m23:17:07.242268 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 23:17:07.210274 => 23:17:07.241825
[0m23:17:07.243257 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m23:17:07.249611 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m23:17:07.272335 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:17:07.273251 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m23:17:07.274111 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:17:07.281141 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:17:07.282034 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:17:07.283318 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

player_stats_game as (

SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM "nba"."silver"."player_stats"
GROUP BY player_id, player_name, team_abbreviation
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_game AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')
    order by avg_fg_pct DESC
   

    UNION ALL

    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')
  
    

    UNION ALL

    SELECT
        'Rebotes' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')
  
    

    UNION ALL

    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')
    
   

    UNION ALL

    SELECT
        'Robos' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')
    
    

    UNION ALL

    SELECT
        'Bloqueos' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    
    
    
    UNION ALL
    
    SELECT
        'Diferencial de puntos' AS weakness_type,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
  
    
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m23:17:07.287159 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "UNION"
LINE 84:     UNION ALL
             ^

[0m23:17:07.288773 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m23:17:07.290230 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 23:17:07.243947 => 23:17:07.289890
[0m23:17:07.291152 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m23:17:07.297045 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "UNION"
  LINE 84:     UNION ALL
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m23:17:07.298059 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3091135a-3d6a-42a5-8314-2ceb014c49bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31d518410>]}
[0m23:17:07.299207 [error] [Thread-1 (]: 6 of 6 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.09s]
[0m23:17:07.301362 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m23:17:07.307344 [debug] [MainThread]: Using postgres connection "master"
[0m23:17:07.308733 [debug] [MainThread]: On master: BEGIN
[0m23:17:07.310159 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:17:07.317677 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:17:07.319339 [debug] [MainThread]: On master: COMMIT
[0m23:17:07.320980 [debug] [MainThread]: Using postgres connection "master"
[0m23:17:07.322255 [debug] [MainThread]: On master: COMMIT
[0m23:17:07.323446 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:17:07.324321 [debug] [MainThread]: On master: Close
[0m23:17:07.325571 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:17:07.326378 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m23:17:07.327320 [info ] [MainThread]: 
[0m23:17:07.328599 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.39 seconds (1.39s).
[0m23:17:07.331188 [debug] [MainThread]: Command end result
[0m23:17:07.390819 [info ] [MainThread]: 
[0m23:17:07.391879 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m23:17:07.392696 [info ] [MainThread]: 
[0m23:17:07.393616 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "UNION"
  LINE 84:     UNION ALL
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m23:17:07.394482 [info ] [MainThread]: 
[0m23:17:07.395351 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m23:17:07.396968 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.8741593, "process_user_time": 5.439158, "process_kernel_time": 0.521898, "process_mem_max_rss": "201020", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m23:17:07.397911 [debug] [MainThread]: Command `dbt run` failed at 23:17:07.397730 after 2.88 seconds
[0m23:17:07.398776 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31f62f9b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31e912d80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75f31f132f30>]}
[0m23:17:07.399797 [debug] [MainThread]: Flushing usage events
[0m23:25:17.185818 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598e9c0aa0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598e6fcad0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598e5afe90>]}


============================== 23:25:17.191275 | 4a697797-6cf5-4f79-bb4e-be1afd8a891a ==============================
[0m23:25:17.191275 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:25:17.192932 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:25:17.631402 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4a697797-6cf5-4f79-bb4e-be1afd8a891a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598ea5df10>]}
[0m23:25:17.780567 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4a697797-6cf5-4f79-bb4e-be1afd8a891a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598e6de150>]}
[0m23:25:17.781929 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:25:17.806524 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:25:18.394869 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:25:18.398293 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m23:25:18.875714 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m23:25:18.891655 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4a697797-6cf5-4f79-bb4e-be1afd8a891a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598d97a390>]}
[0m23:25:18.967762 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4a697797-6cf5-4f79-bb4e-be1afd8a891a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598d5a9820>]}
[0m23:25:18.969505 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m23:25:18.972069 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4a697797-6cf5-4f79-bb4e-be1afd8a891a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598cd7c710>]}
[0m23:25:18.976321 [info ] [MainThread]: 
[0m23:25:18.978104 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:25:18.980798 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m23:25:18.999294 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m23:25:19.000211 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m23:25:19.000925 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:25:19.011976 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m23:25:19.014097 [debug] [ThreadPool]: On list_nba: Close
[0m23:25:19.018297 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m23:25:19.032595 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:25:19.033802 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m23:25:19.034655 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:25:19.045097 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m23:25:19.046037 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:25:19.046951 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m23:25:19.052828 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.0 seconds
[0m23:25:19.057102 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m23:25:19.058565 [debug] [ThreadPool]: On list_nba_gold: Close
[0m23:25:19.066991 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:19.068605 [debug] [MainThread]: On master: BEGIN
[0m23:25:19.071203 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:25:19.080929 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:25:19.081908 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:19.083159 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m23:25:19.116477 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m23:25:19.119462 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4a697797-6cf5-4f79-bb4e-be1afd8a891a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598d5fd0d0>]}
[0m23:25:19.121684 [debug] [MainThread]: On master: ROLLBACK
[0m23:25:19.123513 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:19.124754 [debug] [MainThread]: On master: BEGIN
[0m23:25:19.126590 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:25:19.128245 [debug] [MainThread]: On master: COMMIT
[0m23:25:19.129135 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:19.129854 [debug] [MainThread]: On master: COMMIT
[0m23:25:19.130931 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:25:19.131606 [debug] [MainThread]: On master: Close
[0m23:25:19.132936 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m23:25:19.134004 [info ] [MainThread]: 
[0m23:25:19.141539 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m23:25:19.142999 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m23:25:19.144534 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m23:25:19.145569 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m23:25:19.161716 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m23:25:19.182230 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 23:25:19.146150 => 23:25:19.181820
[0m23:25:19.183144 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m23:25:19.267607 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m23:25:19.301217 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:25:19.303433 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m23:25:19.305252 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:25:19.314604 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:25:19.315873 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:25:19.318036 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m23:25:19.368096 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m23:25:19.381366 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:25:19.383049 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m23:25:19.389208 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:25:19.400747 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:25:19.402949 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m23:25:19.405652 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:25:19.448339 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:25:19.449444 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:25:19.450489 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:25:19.458821 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:25:19.470576 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m23:25:19.483514 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:25:19.485323 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m23:25:19.498257 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:25:19.500961 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 23:25:19.183743 => 23:25:19.500559
[0m23:25:19.502128 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m23:25:19.504102 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4a697797-6cf5-4f79-bb4e-be1afd8a891a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598cd47770>]}
[0m23:25:19.506156 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.36s]
[0m23:25:19.508426 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m23:25:19.510048 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m23:25:19.511259 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m23:25:19.513180 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m23:25:19.514234 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m23:25:19.522813 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m23:25:19.553960 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 23:25:19.514880 => 23:25:19.553221
[0m23:25:19.555466 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m23:25:19.569787 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m23:25:19.595625 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:25:19.597107 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m23:25:19.598231 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:25:19.607521 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:25:19.609759 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:25:19.611390 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m23:25:19.637482 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m23:25:19.649024 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:25:19.650347 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m23:25:19.656077 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:25:19.669428 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:25:19.676220 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m23:25:19.681429 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:25:19.687805 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:25:19.689558 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:25:19.692103 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:25:19.700153 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:25:19.712165 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m23:25:19.714487 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:25:19.715590 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m23:25:19.726033 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:25:19.729950 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 23:25:19.557005 => 23:25:19.729645
[0m23:25:19.731325 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m23:25:19.733670 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4a697797-6cf5-4f79-bb4e-be1afd8a891a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598c9b7200>]}
[0m23:25:19.737826 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.22s]
[0m23:25:19.739838 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m23:25:19.741024 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m23:25:19.742290 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m23:25:19.744075 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m23:25:19.745111 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m23:25:19.751423 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m23:25:19.772479 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 23:25:19.745821 => 23:25:19.772029
[0m23:25:19.773407 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m23:25:19.782096 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m23:25:19.803382 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:25:19.804341 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m23:25:19.805075 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:25:19.811677 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:25:19.812585 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:25:19.813463 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m23:25:19.829732 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m23:25:19.834024 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:25:19.835100 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m23:25:19.837085 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:25:19.841813 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:25:19.842712 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m23:25:19.843925 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:25:19.846643 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:25:19.847585 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:25:19.848422 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:25:19.853517 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:25:19.858147 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m23:25:19.859537 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:25:19.860397 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m23:25:19.866745 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:25:19.870374 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 23:25:19.773982 => 23:25:19.869615
[0m23:25:19.871990 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m23:25:19.873660 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4a697797-6cf5-4f79-bb4e-be1afd8a891a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598c9b7e00>]}
[0m23:25:19.874885 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.13s]
[0m23:25:19.876225 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m23:25:19.877170 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m23:25:19.878194 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m23:25:19.879621 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m23:25:19.880604 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m23:25:19.886181 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m23:25:19.910813 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 23:25:19.881344 => 23:25:19.910090
[0m23:25:19.913077 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m23:25:19.924519 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m23:25:19.957602 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:25:19.958600 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m23:25:19.959910 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:25:19.967363 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:25:19.969249 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:25:19.970803 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m23:25:20.002751 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m23:25:20.007221 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:25:20.008244 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m23:25:20.009890 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:25:20.014104 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:25:20.015107 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m23:25:20.016673 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:25:20.020270 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:25:20.021321 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:25:20.022172 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:25:20.033937 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:25:20.039303 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m23:25:20.041090 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:25:20.042166 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m23:25:20.049114 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:25:20.052206 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 23:25:19.914033 => 23:25:20.051651
[0m23:25:20.053938 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m23:25:20.055874 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4a697797-6cf5-4f79-bb4e-be1afd8a891a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598c981670>]}
[0m23:25:20.057507 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.18s]
[0m23:25:20.058975 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m23:25:20.060110 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:25:20.061235 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m23:25:20.062565 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m23:25:20.063701 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:25:20.070136 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:25:20.095033 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 23:25:20.064560 => 23:25:20.094609
[0m23:25:20.096004 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:25:20.105294 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:25:20.129362 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:25:20.130410 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m23:25:20.131448 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:25:20.139648 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:25:20.140871 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:25:20.142113 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m23:25:20.180520 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m23:25:20.190523 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:25:20.193914 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m23:25:20.196935 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:25:20.205620 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:25:20.207013 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m23:25:20.209380 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:25:20.213375 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:25:20.214939 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:25:20.217428 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:25:20.227450 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:25:20.234951 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m23:25:20.248973 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:25:20.259459 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m23:25:20.273822 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:25:20.277804 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 23:25:20.096866 => 23:25:20.277486
[0m23:25:20.279185 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m23:25:20.282686 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4a697797-6cf5-4f79-bb4e-be1afd8a891a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598c504050>]}
[0m23:25:20.289002 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.22s]
[0m23:25:20.290740 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:25:20.292988 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m23:25:20.294193 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m23:25:20.296017 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m23:25:20.297313 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m23:25:20.306647 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m23:25:20.341733 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 23:25:20.298285 => 23:25:20.341315
[0m23:25:20.342683 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m23:25:20.350336 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m23:25:20.378985 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:25:20.380128 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m23:25:20.381149 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:25:20.390163 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:25:20.391665 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:25:20.393000 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

player_stats_game as (

SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM "nba"."silver"."player_stats"
GROUP BY player_id, player_name, team_abbreviation
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_game AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')
    order by avg_fg_pct DESC
    UNION ALL
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')
    UNION ALL
    SELECT
        'Rebotes' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')
    UNION ALL
    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')
    UNION ALL
    SELECT
        'Robos' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')
    UNION ALL
    SELECT
        'Bloqueos' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    UNION ALL
    SELECT
        'Diferencial de puntos' AS weakness_type,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
     
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m23:25:20.395565 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "UNION"
LINE 82:     UNION ALL
             ^

[0m23:25:20.397510 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m23:25:20.400047 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 23:25:20.343360 => 23:25:20.399487
[0m23:25:20.401718 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m23:25:20.411563 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "UNION"
  LINE 82:     UNION ALL
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m23:25:20.413050 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4a697797-6cf5-4f79-bb4e-be1afd8a891a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598cd7c170>]}
[0m23:25:20.414609 [error] [Thread-1 (]: 6 of 6 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.12s]
[0m23:25:20.416337 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m23:25:20.422219 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:20.423813 [debug] [MainThread]: On master: BEGIN
[0m23:25:20.424946 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:25:20.433237 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:25:20.434200 [debug] [MainThread]: On master: COMMIT
[0m23:25:20.436102 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:20.438181 [debug] [MainThread]: On master: COMMIT
[0m23:25:20.439658 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:25:20.441002 [debug] [MainThread]: On master: Close
[0m23:25:20.443243 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:25:20.445553 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m23:25:20.446879 [info ] [MainThread]: 
[0m23:25:20.449358 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.47 seconds (1.47s).
[0m23:25:20.454699 [debug] [MainThread]: Command end result
[0m23:25:20.590387 [info ] [MainThread]: 
[0m23:25:20.591728 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m23:25:20.592846 [info ] [MainThread]: 
[0m23:25:20.594102 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "UNION"
  LINE 82:     UNION ALL
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m23:25:20.596874 [info ] [MainThread]: 
[0m23:25:20.598211 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m23:25:20.600445 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 3.506989, "process_user_time": 4.808717, "process_kernel_time": 0.502583, "process_mem_max_rss": "201020", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m23:25:20.602259 [debug] [MainThread]: Command `dbt run` failed at 23:25:20.601908 after 3.51 seconds
[0m23:25:20.603517 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598cda6120>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598c9bc200>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e598d142c00>]}
[0m23:25:20.604547 [debug] [MainThread]: Flushing usage events
[0m23:33:53.995488 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f399e0f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f399e990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f399cd10>]}


============================== 23:33:53.999750 | 422a71c1-b445-4860-b7de-a7dbe2cb0169 ==============================
[0m23:33:53.999750 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:33:54.001295 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m23:33:54.303252 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '422a71c1-b445-4860-b7de-a7dbe2cb0169', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f3e0e330>]}
[0m23:33:54.442545 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '422a71c1-b445-4860-b7de-a7dbe2cb0169', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f409b9e0>]}
[0m23:33:54.443987 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:33:54.470067 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:33:54.769540 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:33:54.770627 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:33:54.772431 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m23:33:54.780333 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '422a71c1-b445-4860-b7de-a7dbe2cb0169', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f29210a0>]}
[0m23:33:54.855043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '422a71c1-b445-4860-b7de-a7dbe2cb0169', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f2968770>]}
[0m23:33:54.856144 [info ] [MainThread]: Found 6 models, 5 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m23:33:54.857096 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '422a71c1-b445-4860-b7de-a7dbe2cb0169', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f39ca960>]}
[0m23:33:54.860062 [info ] [MainThread]: 
[0m23:33:54.861761 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:33:54.864427 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m23:33:54.879777 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m23:33:54.880897 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m23:33:54.881867 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:33:54.892570 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m23:33:54.895026 [debug] [ThreadPool]: On list_nba: Close
[0m23:33:54.898316 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m23:33:54.906937 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:33:54.907968 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m23:33:54.908957 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:33:54.916896 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m23:33:54.918433 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:33:54.919458 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m23:33:54.924679 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.0 seconds
[0m23:33:54.926861 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m23:33:54.927992 [debug] [ThreadPool]: On list_nba_gold: Close
[0m23:33:54.937399 [debug] [MainThread]: Using postgres connection "master"
[0m23:33:54.938515 [debug] [MainThread]: On master: BEGIN
[0m23:33:54.939652 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:33:54.946438 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:33:54.947441 [debug] [MainThread]: Using postgres connection "master"
[0m23:33:54.948575 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m23:33:54.969342 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m23:33:54.971362 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '422a71c1-b445-4860-b7de-a7dbe2cb0169', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f39c8110>]}
[0m23:33:54.972786 [debug] [MainThread]: On master: ROLLBACK
[0m23:33:54.974132 [debug] [MainThread]: Using postgres connection "master"
[0m23:33:54.975131 [debug] [MainThread]: On master: BEGIN
[0m23:33:54.976793 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:33:54.977899 [debug] [MainThread]: On master: COMMIT
[0m23:33:54.978983 [debug] [MainThread]: Using postgres connection "master"
[0m23:33:54.979953 [debug] [MainThread]: On master: COMMIT
[0m23:33:54.981285 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:33:54.982321 [debug] [MainThread]: On master: Close
[0m23:33:54.983866 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m23:33:54.985684 [info ] [MainThread]: 
[0m23:33:54.991039 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m23:33:54.992263 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m23:33:54.994033 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m23:33:54.995049 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m23:33:55.006712 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m23:33:55.032792 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 23:33:54.995734 => 23:33:55.032142
[0m23:33:55.033815 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m23:33:55.086974 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m23:33:55.113892 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:33:55.115186 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m23:33:55.116160 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:33:55.123999 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:33:55.125056 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:33:55.126138 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m23:33:55.147553 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m23:33:55.156864 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:33:55.158082 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m23:33:55.159766 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:33:55.164052 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:33:55.165089 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m23:33:55.166916 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:33:55.194625 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:33:55.195670 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:33:55.196650 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:33:55.206776 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:33:55.215814 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m23:33:55.225279 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:33:55.226432 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m23:33:55.234727 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:33:55.237827 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 23:33:55.035242 => 23:33:55.237513
[0m23:33:55.239069 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m23:33:55.240769 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '422a71c1-b445-4860-b7de-a7dbe2cb0169', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f25d7980>]}
[0m23:33:55.243586 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.25s]
[0m23:33:55.245049 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m23:33:55.246269 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m23:33:55.247385 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m23:33:55.248774 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m23:33:55.249815 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m23:33:55.255735 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m23:33:55.282348 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 23:33:55.250845 => 23:33:55.281803
[0m23:33:55.283387 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m23:33:55.289398 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m23:33:55.315029 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:33:55.316085 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m23:33:55.317013 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:33:55.324619 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:33:55.325856 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:33:55.327190 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m23:33:55.346235 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m23:33:55.351124 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:33:55.352749 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m23:33:55.354576 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:33:55.358817 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:33:55.359866 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m23:33:55.361254 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:33:55.364276 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:33:55.365288 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:33:55.366320 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:33:55.372814 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:33:55.376693 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m23:33:55.378199 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:33:55.379219 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m23:33:55.386892 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:33:55.389424 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 23:33:55.284282 => 23:33:55.389148
[0m23:33:55.390495 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m23:33:55.392649 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '422a71c1-b445-4860-b7de-a7dbe2cb0169', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f296bc20>]}
[0m23:33:55.394274 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.14s]
[0m23:33:55.395590 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m23:33:55.396731 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m23:33:55.397762 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m23:33:55.399275 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m23:33:55.400215 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m23:33:55.405444 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m23:33:55.435793 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 23:33:55.401156 => 23:33:55.435217
[0m23:33:55.436910 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m23:33:55.442552 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m23:33:55.468223 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:33:55.469653 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m23:33:55.470824 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:33:55.478754 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:33:55.479930 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:33:55.481037 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m23:33:55.503424 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m23:33:55.509614 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:33:55.510867 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m23:33:55.512811 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:33:55.517121 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:33:55.518521 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m23:33:55.520608 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:33:55.526509 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:33:55.528111 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:33:55.529167 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:33:55.535701 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:33:55.539954 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m23:33:55.542181 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:33:55.543791 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m23:33:55.553405 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:33:55.556216 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 23:33:55.437764 => 23:33:55.555931
[0m23:33:55.557263 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m23:33:55.559097 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '422a71c1-b445-4860-b7de-a7dbe2cb0169', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f2172210>]}
[0m23:33:55.561774 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.16s]
[0m23:33:55.563387 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m23:33:55.564688 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses
[0m23:33:55.566370 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.team_weaknesses .............................. [RUN]
[0m23:33:55.568646 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses)
[0m23:33:55.570059 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses
[0m23:33:55.575896 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses"
[0m23:33:55.615296 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (compile): 23:33:55.571138 => 23:33:55.614586
[0m23:33:55.617759 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses
[0m23:33:55.629012 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses"
[0m23:33:55.664667 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:33:55.666427 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: BEGIN
[0m23:33:55.668555 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:33:55.677935 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:33:55.679554 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:33:55.681625 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */

  
    

  create  table "nba"."gold"."team_weaknesses__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
         case when t1.season like '2024' then '2024-25'
            else t1.season end as season2, t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


spurs_stats AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    WHERE team_id = '1610612759'  -- Team ID for San Antonio Spurs
    GROUP BY season2
),

team_averages AS (
    SELECT
        season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM nba_games
    GROUP BY season2
),

all_teams_stats AS (
    SELECT
        season2,
        team_id,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM nba_games
    GROUP BY season2, team_id
),

best_team_stats AS (
    SELECT
        season2,
        avg_fg_pct AS best_team_avg_fg_pct,
        avg_fg3_pct AS best_team_avg_fg3_pct,
        avg_turnovers AS best_team_avg_turnovers,
        avg_rebounds AS best_team_avg_rebounds,
        avg_blocks AS best_team_avg_blocks,
        avg_steals AS best_team_avg_steals,
        avg_plus_minus AS best_team_avg_plus_minus
    FROM (
        SELECT
            season2,
            avg_fg_pct,
            avg_fg3_pct,
            avg_turnovers,
            avg_rebounds,
            avg_blocks,
            avg_steals,
            avg_plus_minus,
            ROW_NUMBER() OVER (PARTITION BY season2 ORDER BY avg_plus_minus DESC) AS rn
        FROM all_teams_stats
    ) X
    WHERE X.rn = 1
)

SELECT
    ss.season2,
    ss.avg_fg_pct,
    ta.avg_league_fg_pct,
    bts.best_team_avg_fg_pct,
    ss.avg_fg3_pct,
    ta.avg_league_fg3_pct,
    bts.best_team_avg_fg3_pct,
    ss.avg_turnovers,
    ta.avg_league_turnovers,
    bts.best_team_avg_turnovers,
    ss.avg_rebounds,
    ta.avg_league_rebounds,
    bts.best_team_avg_rebounds,
    ss.avg_blocks,
    ta.avg_league_blocks,
    bts.best_team_avg_blocks,
    ss.avg_steals,
    ta.avg_league_steals,
    bts.best_team_avg_steals,
    ss.avg_plus_minus,
    ta.avg_league_plus_minus,
    bts.best_team_avg_plus_minus,
    CASE WHEN ss.avg_fg_pct < ta.avg_league_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_league,
    CASE WHEN ss.avg_fg_pct < bts.best_team_avg_fg_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg_pct_rating_vs_best_team,
    CASE WHEN ss.avg_fg3_pct < ta.avg_league_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_league,
    CASE WHEN ss.avg_fg3_pct < bts.best_team_avg_fg3_pct THEN 'Debilidad' ELSE 'Fortaleza' END AS fg3_pct_rating_vs_best_team,
    CASE WHEN ss.avg_turnovers > ta.avg_league_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_league,
    CASE WHEN ss.avg_turnovers > bts.best_team_avg_turnovers THEN 'Debilidad' ELSE 'Fortaleza' END AS turnovers_rating_vs_best_team,
    CASE WHEN ss.avg_rebounds < ta.avg_league_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_league,
    CASE WHEN ss.avg_rebounds < bts.best_team_avg_rebounds THEN 'Debilidad' ELSE 'Fortaleza' END AS rebounds_rating_vs_best_team,
    CASE WHEN ss.avg_blocks < ta.avg_league_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_league,
    CASE WHEN ss.avg_blocks < bts.best_team_avg_blocks THEN 'Debilidad' ELSE 'Fortaleza' END AS blocks_rating_vs_best_team,
    CASE WHEN ss.avg_steals < ta.avg_league_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_league,
    CASE WHEN ss.avg_steals < bts.best_team_avg_steals THEN 'Debilidad' ELSE 'Fortaleza' END AS steals_rating_vs_best_team,
    CASE WHEN ss.avg_plus_minus < ta.avg_league_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_league,
    CASE WHEN ss.avg_plus_minus < bts.best_team_avg_plus_minus THEN 'Debilidad' ELSE 'Fortaleza' END AS plus_minus_rating_vs_best_team
FROM spurs_stats ss
JOIN team_averages ta ON ss.season2 = ta.season2
JOIN best_team_stats bts ON ss.season2 = bts.season2
  );
  
[0m23:33:55.730565 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m23:33:55.739095 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:33:55.740709 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses" rename to "team_weaknesses__dbt_backup"
[0m23:33:55.742660 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:33:55.753095 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:33:55.754374 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
alter table "nba"."gold"."team_weaknesses__dbt_tmp" rename to "team_weaknesses"
[0m23:33:55.756311 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:33:55.760323 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:33:55.761559 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:33:55.763053 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: COMMIT
[0m23:33:55.769184 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:33:55.775064 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses__dbt_backup"
[0m23:33:55.777500 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses"
[0m23:33:55.779278 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses"} */
drop table if exists "nba"."gold"."team_weaknesses__dbt_backup" cascade
[0m23:33:55.786722 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:33:55.791737 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses (execute): 23:33:55.619803 => 23:33:55.791382
[0m23:33:55.792799 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses: Close
[0m23:33:55.794557 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '422a71c1-b445-4860-b7de-a7dbe2cb0169', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f2188260>]}
[0m23:33:55.797314 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.team_weaknesses ......................... [[32mSELECT 1[0m in 0.23s]
[0m23:33:55.798706 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses
[0m23:33:55.799710 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:33:55.800778 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m23:33:55.802605 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m23:33:55.803537 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:33:55.809739 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:33:55.828795 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 23:33:55.804452 => 23:33:55.828393
[0m23:33:55.829551 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:33:55.835657 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:33:55.856625 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:33:55.857494 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m23:33:55.858333 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:33:55.864405 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:33:55.865400 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:33:55.866621 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m23:33:55.899106 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m23:33:55.904435 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:33:55.905677 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m23:33:55.907660 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:33:55.912764 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:33:55.914333 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m23:33:55.915882 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:33:55.919696 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:33:55.920815 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:33:55.922025 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:33:55.927585 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:33:55.934972 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m23:33:55.936831 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:33:55.937821 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m23:33:55.945404 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:33:55.948300 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 23:33:55.830146 => 23:33:55.947971
[0m23:33:55.949430 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m23:33:55.951793 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '422a71c1-b445-4860-b7de-a7dbe2cb0169', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f2159460>]}
[0m23:33:55.954750 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.15s]
[0m23:33:55.956136 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:33:55.958225 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m23:33:55.959566 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m23:33:55.961825 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m23:33:55.962912 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m23:33:55.969354 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m23:33:55.991236 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 23:33:55.963599 => 23:33:55.990614
[0m23:33:55.992621 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m23:33:55.998667 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m23:33:56.026018 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:33:56.027150 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m23:33:56.028188 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:33:56.036798 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:33:56.038047 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:33:56.039296 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

player_stats_game as (

SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM "nba"."silver"."player_stats"
GROUP BY player_id, player_name, team_abbreviation
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN player_stats_game AS pgs ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')
    order by avg_fg_pct DESC
    UNION ALL
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')
    UNION ALL
    SELECT
        'Rebotes' AS weakness_type,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')
    UNION ALL
    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')
    UNION ALL
    SELECT
        'Robos' AS weakness_type,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')
    UNION ALL
    SELECT
        'Bloqueos' AS weakness_type,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    UNION ALL
    SELECT
        'Diferencial de puntos' AS weakness_type,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
     
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m23:33:56.041713 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "UNION"
LINE 82:     UNION ALL
             ^

[0m23:33:56.043031 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m23:33:56.044666 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 23:33:55.993777 => 23:33:56.044292
[0m23:33:56.045690 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m23:33:56.053443 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "UNION"
  LINE 82:     UNION ALL
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m23:33:56.054914 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '422a71c1-b445-4860-b7de-a7dbe2cb0169', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f219b740>]}
[0m23:33:56.056144 [error] [Thread-1 (]: 6 of 6 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.09s]
[0m23:33:56.057539 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m23:33:56.062056 [debug] [MainThread]: Using postgres connection "master"
[0m23:33:56.063363 [debug] [MainThread]: On master: BEGIN
[0m23:33:56.064527 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:33:56.072340 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:33:56.073657 [debug] [MainThread]: On master: COMMIT
[0m23:33:56.074806 [debug] [MainThread]: Using postgres connection "master"
[0m23:33:56.075748 [debug] [MainThread]: On master: COMMIT
[0m23:33:56.077056 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:33:56.078218 [debug] [MainThread]: On master: Close
[0m23:33:56.079870 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:33:56.081006 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m23:33:56.082213 [info ] [MainThread]: 
[0m23:33:56.083312 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.22 seconds (1.22s).
[0m23:33:56.087772 [debug] [MainThread]: Command end result
[0m23:33:56.151117 [info ] [MainThread]: 
[0m23:33:56.152990 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m23:33:56.154065 [info ] [MainThread]: 
[0m23:33:56.155117 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "UNION"
  LINE 82:     UNION ALL
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m23:33:56.156101 [info ] [MainThread]: 
[0m23:33:56.157019 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m23:33:56.158722 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.2532136, "process_user_time": 3.601674, "process_kernel_time": 0.463186, "process_mem_max_rss": "201020", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m23:33:56.159918 [debug] [MainThread]: Command `dbt run` failed at 23:33:56.159732 after 2.25 seconds
[0m23:33:56.160975 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f3a6d4f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f40e6e10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77b3f39c8110>]}
[0m23:33:56.161928 [debug] [MainThread]: Flushing usage events
[0m23:50:48.607163 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76de22da1130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76de22da2d50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76de22da2060>]}


============================== 23:50:48.615411 | cac2b646-317f-44e4-a3a2-b95f6873b0c9 ==============================
[0m23:50:48.615411 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:50:48.617516 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:50:48.970083 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cac2b646-317f-44e4-a3a2-b95f6873b0c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76de22137c80>]}
[0m23:50:49.196360 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cac2b646-317f-44e4-a3a2-b95f6873b0c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76de234bb2f0>]}
[0m23:50:49.198505 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:50:49.230326 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:50:49.528974 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m23:50:49.530216 [debug] [MainThread]: Partial parsing: added file: spurs_dbt://models/spurs_analysis/player_stats_summary.sql
[0m23:50:49.531164 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m23:50:49.896355 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.spurs_dbt.players_recommendations' (models/spurs_analysis/players_recommendations.sql) depends on a node named 'player_stats_summary' in package or project 'gold' which was not found
[0m23:50:49.898326 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.3954786, "process_user_time": 4.533028, "process_kernel_time": 0.384224, "process_mem_max_rss": "201044", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m23:50:49.899545 [debug] [MainThread]: Command `dbt run` failed at 23:50:49.899237 after 1.40 seconds
[0m23:50:49.900635 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76de23172660>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76de2757a690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76de221d95e0>]}
[0m23:50:49.901844 [debug] [MainThread]: Flushing usage events
[0m23:53:25.814015 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cee0cac2180>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cee0cac1dc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cee0cac23f0>]}


============================== 23:53:25.818877 | 92985599-8f73-4a2f-a509-6417f7bfcd7e ==============================
[0m23:53:25.818877 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:53:25.821054 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:53:26.394843 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '92985599-8f73-4a2f-a509-6417f7bfcd7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cee0c144320>]}
[0m23:53:26.548233 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '92985599-8f73-4a2f-a509-6417f7bfcd7e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cee0cac21e0>]}
[0m23:53:26.549811 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:53:26.583624 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:53:26.976003 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m23:53:26.977391 [debug] [MainThread]: Partial parsing: added file: spurs_dbt://models/spurs_analysis/player_stats_summary.sql
[0m23:53:26.978619 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m23:53:27.243087 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.spurs_dbt.players_recommendations' (models/spurs_analysis/players_recommendations.sql) depends on a source named 'gold.player_stats_summary' which was not found
[0m23:53:27.245243 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.5521818, "process_user_time": 4.641929, "process_kernel_time": 0.609047, "process_mem_max_rss": "201020", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m23:53:27.246563 [debug] [MainThread]: Command `dbt run` failed at 23:53:27.246365 after 1.55 seconds
[0m23:53:27.247697 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cee0ce6fa40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cee0cac2c90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cee0b540590>]}
[0m23:53:27.248597 [debug] [MainThread]: Flushing usage events
[0m23:57:55.503406 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed9c9732000>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed9c97332f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed9c9732270>]}


============================== 23:57:55.514189 | e4aa5b74-3255-4955-8ec0-9213995614f5 ==============================
[0m23:57:55.514189 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:57:55.515361 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:57:56.150429 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e4aa5b74-3255-4955-8ec0-9213995614f5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed9c90bf7d0>]}
[0m23:57:56.319325 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e4aa5b74-3255-4955-8ec0-9213995614f5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed9c97c2330>]}
[0m23:57:56.322853 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:57:56.353875 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:57:56.688976 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 0 files added, 1 files changed.
[0m23:57:56.691059 [debug] [MainThread]: Partial parsing: deleted file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m23:57:56.692538 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m23:57:56.997933 [warn ] [MainThread]: [[33mWARNING[0m]: Did not find matching node for patch with name 'team_weaknesses' in the 'models' section of file 'models/spurs_analysis/spurs_analysis.yml'
[0m23:57:56.999478 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.spurs_dbt.players_recommendations' (models/spurs_analysis/players_recommendations.sql) depends on a source named 'gold.player_stats_summary' which was not found
[0m23:57:57.001194 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.6084682, "process_user_time": 4.5809, "process_kernel_time": 0.529038, "process_mem_max_rss": "201052", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m23:57:57.002501 [debug] [MainThread]: Command `dbt run` failed at 23:57:57.002150 after 1.61 seconds
[0m23:57:57.005123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed9c9dae1b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed9c89f52e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed9c9627e60>]}
[0m23:57:57.007480 [debug] [MainThread]: Flushing usage events
[0m23:59:32.840876 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c9a4f48a360>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c9a4f48af90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c9a4f48a4e0>]}


============================== 23:59:32.845225 | a8683c0b-7302-40ec-9dfa-8c5a61d79f56 ==============================
[0m23:59:32.845225 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:59:32.846389 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:59:33.138231 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a8683c0b-7302-40ec-9dfa-8c5a61d79f56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c9a4eb0a8d0>]}
[0m23:59:33.281147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a8683c0b-7302-40ec-9dfa-8c5a61d79f56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c9a4f35a4e0>]}
[0m23:59:33.282631 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:59:33.310708 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:59:33.628128 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 0 files added, 2 files changed.
[0m23:59:33.629487 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/spurs_analysis.yml
[0m23:59:33.630364 [debug] [MainThread]: Partial parsing: deleted file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m23:59:33.631405 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m23:59:34.064026 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.spurs_dbt.players_recommendations' (models/spurs_analysis/players_recommendations.sql) depends on a source named 'gold.player_stats_summary' which was not found
[0m23:59:34.066063 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.3202833, "process_user_time": 3.882858, "process_kernel_time": 0.376277, "process_mem_max_rss": "201020", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m23:59:34.067813 [debug] [MainThread]: Command `dbt run` failed at 23:59:34.067419 after 1.32 seconds
[0m23:59:34.069427 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c9a4fad0b60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c9a4e7fc080>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c9a4dff9040>]}
[0m23:59:34.070556 [debug] [MainThread]: Flushing usage events
[0m00:03:15.767355 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78bd5e4ad0d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78bd5e53ef00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78bd5e4ad250>]}


============================== 00:03:15.774097 | 365f853b-2a46-4cbb-aac7-753d534f726f ==============================
[0m00:03:15.774097 [info ] [MainThread]: Running with dbt=1.7.9
[0m00:03:15.778300 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m00:03:16.186162 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '365f853b-2a46-4cbb-aac7-753d534f726f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78bd5e3a33b0>]}
[0m00:03:16.353555 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '365f853b-2a46-4cbb-aac7-753d534f726f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78bd5e875b50>]}
[0m00:03:16.355239 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m00:03:16.386062 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m00:03:16.730811 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 0 files added, 2 files changed.
[0m00:03:16.732426 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/spurs_analysis.yml
[0m00:03:16.733421 [debug] [MainThread]: Partial parsing: deleted file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m00:03:16.734272 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m00:03:17.276405 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.spurs_dbt.players_recommendations' (models/spurs_analysis/players_recommendations.sql) depends on a source named 'gold.player_stats_summary' which was not found
[0m00:03:17.278700 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.6450603, "process_user_time": 4.381611, "process_kernel_time": 0.521232, "process_mem_max_rss": "200864", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m00:03:17.280059 [debug] [MainThread]: Command `dbt run` failed at 00:03:17.279838 after 1.65 seconds
[0m00:03:17.281020 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78bd5cbde720>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78bd5d742d20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78bd5e4ad250>]}
[0m00:03:17.282025 [debug] [MainThread]: Flushing usage events
[0m00:07:37.040444 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7013b119bdd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7013b119af00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7013b119bec0>]}


============================== 00:07:37.044712 | 84d2d147-a44d-46e0-905d-6038c36e153b ==============================
[0m00:07:37.044712 [info ] [MainThread]: Running with dbt=1.7.9
[0m00:07:37.045828 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m00:07:37.435575 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '84d2d147-a44d-46e0-905d-6038c36e153b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7013b0ff9940>]}
[0m00:07:37.632097 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '84d2d147-a44d-46e0-905d-6038c36e153b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7013b11c7320>]}
[0m00:07:37.633951 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m00:07:37.664296 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m00:07:38.107753 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 0 files added, 2 files changed.
[0m00:07:38.110625 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/spurs_analysis.yml
[0m00:07:38.111816 [debug] [MainThread]: Partial parsing: deleted file: spurs_dbt://models/spurs_analysis/team_weaknesses.sql
[0m00:07:38.113159 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m00:07:38.808819 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m00:07:38.816974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '84d2d147-a44d-46e0-905d-6038c36e153b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7013afbeb020>]}
[0m00:07:38.974188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '84d2d147-a44d-46e0-905d-6038c36e153b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7013b07b8b30>]}
[0m00:07:38.975866 [info ] [MainThread]: Found 5 models, 6 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m00:07:38.977352 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '84d2d147-a44d-46e0-905d-6038c36e153b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7013afb1d190>]}
[0m00:07:38.980963 [info ] [MainThread]: 
[0m00:07:38.982731 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m00:07:38.986268 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m00:07:39.012181 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m00:07:39.013282 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m00:07:39.014183 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:07:39.028925 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m00:07:39.031517 [debug] [ThreadPool]: On list_nba: Close
[0m00:07:39.036360 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m00:07:39.051945 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:07:39.054133 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m00:07:39.056327 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:07:39.065661 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m00:07:39.066714 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:07:39.067721 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m00:07:39.079356 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m00:07:39.082351 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m00:07:39.083838 [debug] [ThreadPool]: On list_nba_gold: Close
[0m00:07:39.098538 [debug] [MainThread]: Using postgres connection "master"
[0m00:07:39.100218 [debug] [MainThread]: On master: BEGIN
[0m00:07:39.101154 [debug] [MainThread]: Opening a new connection, currently in state init
[0m00:07:39.114839 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:07:39.115989 [debug] [MainThread]: Using postgres connection "master"
[0m00:07:39.117429 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m00:07:39.161935 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m00:07:39.164567 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '84d2d147-a44d-46e0-905d-6038c36e153b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7013b07721e0>]}
[0m00:07:39.165972 [debug] [MainThread]: On master: ROLLBACK
[0m00:07:39.167576 [debug] [MainThread]: Using postgres connection "master"
[0m00:07:39.169440 [debug] [MainThread]: On master: BEGIN
[0m00:07:39.173414 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:07:39.174966 [debug] [MainThread]: On master: COMMIT
[0m00:07:39.175943 [debug] [MainThread]: Using postgres connection "master"
[0m00:07:39.177257 [debug] [MainThread]: On master: COMMIT
[0m00:07:39.178858 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:07:39.179955 [debug] [MainThread]: On master: Close
[0m00:07:39.181751 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m00:07:39.183119 [info ] [MainThread]: 
[0m00:07:39.193365 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m00:07:39.195170 [info ] [Thread-1 (]: 1 of 5 START sql table model gold.home_vs_away ................................. [RUN]
[0m00:07:39.197342 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m00:07:39.198660 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m00:07:39.215877 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m00:07:39.232568 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 00:07:39.199346 => 00:07:39.232098
[0m00:07:39.233686 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m00:07:39.308758 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m00:07:39.328779 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:07:39.329989 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m00:07:39.331478 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:07:39.343253 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:07:39.344967 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:07:39.346120 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m00:07:39.399807 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m00:07:39.413072 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:07:39.414170 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m00:07:39.415988 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:07:39.424254 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:07:39.425387 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m00:07:39.426937 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:07:39.464218 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:07:39.465378 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:07:39.466365 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:07:39.475212 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:07:39.488014 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m00:07:39.499043 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:07:39.500420 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m00:07:39.513445 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:07:39.516538 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 00:07:39.234513 => 00:07:39.516192
[0m00:07:39.517520 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m00:07:39.522384 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84d2d147-a44d-46e0-905d-6038c36e153b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7013af789c10>]}
[0m00:07:39.524557 [info ] [Thread-1 (]: 1 of 5 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.33s]
[0m00:07:39.526177 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m00:07:39.527428 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m00:07:39.528564 [info ] [Thread-1 (]: 2 of 5 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m00:07:39.530449 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m00:07:39.531588 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m00:07:39.539989 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m00:07:39.557371 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 00:07:39.532289 => 00:07:39.556461
[0m00:07:39.558666 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m00:07:39.567102 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m00:07:39.584005 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:07:39.585065 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m00:07:39.586717 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:07:39.598181 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:07:39.599757 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:07:39.601987 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m00:07:39.771610 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m00:07:39.778150 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:07:39.779369 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m00:07:39.781521 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:07:39.787956 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:07:39.790275 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m00:07:39.792425 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:07:39.795836 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:07:39.796860 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:07:39.797773 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:07:39.806247 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:07:39.811176 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m00:07:39.812842 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:07:39.813866 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m00:07:39.823258 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:07:39.826869 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 00:07:39.559458 => 00:07:39.826247
[0m00:07:39.828136 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m00:07:39.830232 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84d2d147-a44d-46e0-905d-6038c36e153b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7013af35cc80>]}
[0m00:07:39.831511 [info ] [Thread-1 (]: 2 of 5 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.30s]
[0m00:07:39.833178 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m00:07:39.834231 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m00:07:39.835875 [info ] [Thread-1 (]: 3 of 5 START sql table model gold.summary_by_season ............................ [RUN]
[0m00:07:39.840395 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m00:07:39.841965 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m00:07:39.847122 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m00:07:39.864324 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 00:07:39.842759 => 00:07:39.863860
[0m00:07:39.865266 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m00:07:39.875855 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m00:07:39.892660 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:07:39.893877 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m00:07:39.894787 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:07:39.906927 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:07:39.908427 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:07:39.909672 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m00:07:39.929398 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m00:07:39.934760 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:07:39.937395 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m00:07:39.940946 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:07:39.945761 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:07:39.946710 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m00:07:39.948017 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:07:39.951446 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:07:39.953151 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:07:39.955326 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:07:39.962668 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:07:39.967592 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m00:07:39.972189 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:07:39.973804 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m00:07:39.981393 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:07:39.984267 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 00:07:39.865970 => 00:07:39.983949
[0m00:07:39.986139 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m00:07:39.990376 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84d2d147-a44d-46e0-905d-6038c36e153b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7013af79b380>]}
[0m00:07:39.992068 [info ] [Thread-1 (]: 3 of 5 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m00:07:39.993750 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m00:07:39.994820 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:07:39.995860 [info ] [Thread-1 (]: 4 of 5 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m00:07:39.997315 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m00:07:39.998596 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:07:40.010927 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:07:40.028973 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 00:07:39.999601 => 00:07:40.028223
[0m00:07:40.030230 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:07:40.042007 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:07:40.062085 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:07:40.063112 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m00:07:40.063975 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:07:40.075048 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:07:40.076153 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:07:40.077682 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m00:07:40.116757 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m00:07:40.125960 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:07:40.126959 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m00:07:40.128768 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:07:40.139480 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:07:40.140780 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m00:07:40.142609 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:07:40.146359 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:07:40.147856 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:07:40.149288 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:07:40.156570 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:07:40.164275 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m00:07:40.166395 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:07:40.167451 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m00:07:40.177438 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:07:40.180603 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 00:07:40.031229 => 00:07:40.180265
[0m00:07:40.181750 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m00:07:40.183378 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84d2d147-a44d-46e0-905d-6038c36e153b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7013af37bb00>]}
[0m00:07:40.184892 [info ] [Thread-1 (]: 4 of 5 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.19s]
[0m00:07:40.188902 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:07:40.193681 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m00:07:40.195127 [info ] [Thread-1 (]: 5 of 5 START sql table model gold.players_recommendations ...................... [RUN]
[0m00:07:40.196490 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m00:07:40.197426 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m00:07:40.210674 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m00:07:40.228862 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 00:07:40.198148 => 00:07:40.228320
[0m00:07:40.230142 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m00:07:40.241479 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m00:07:40.260807 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:07:40.262458 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m00:07:40.263909 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:07:40.275622 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:07:40.277414 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:07:40.280001 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN (SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM "nba"."silver"."player_stats") AS pgs
    ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
    UNION ALL
    
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN (SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) from "nba"."silver"."player_stats"
    GROUP BY player_id, player_name, team_abbreviation) AS pgs
    on p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')
    order by avg_fg_pct DESC
    UNION ALL
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')
    UNION ALL
    SELECT
        'Rebotes' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')
    UNION ALL
    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')
    UNION ALL
    SELECT
        'Robos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')
    UNION ALL
    SELECT
        'Bloqueos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    UNION ALL
    SELECT
        'Diferencial Puntos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
     
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    player_id,
    is_free_agent,
    is_injured,
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m00:07:40.283278 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "UNION"
LINE 119:     UNION ALL
              ^

[0m00:07:40.285100 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m00:07:40.289256 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 00:07:40.230995 => 00:07:40.288047
[0m00:07:40.292376 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m00:07:40.301488 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "UNION"
  LINE 119:     UNION ALL
                ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m00:07:40.305072 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84d2d147-a44d-46e0-905d-6038c36e153b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7013af37adb0>]}
[0m00:07:40.308495 [error] [Thread-1 (]: 5 of 5 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.11s]
[0m00:07:40.310681 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m00:07:40.315590 [debug] [MainThread]: Using postgres connection "master"
[0m00:07:40.316835 [debug] [MainThread]: On master: BEGIN
[0m00:07:40.318117 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m00:07:40.329111 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:07:40.330310 [debug] [MainThread]: On master: COMMIT
[0m00:07:40.331230 [debug] [MainThread]: Using postgres connection "master"
[0m00:07:40.332236 [debug] [MainThread]: On master: COMMIT
[0m00:07:40.333641 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:07:40.334946 [debug] [MainThread]: On master: Close
[0m00:07:40.339710 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:07:40.341393 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m00:07:40.343516 [info ] [MainThread]: 
[0m00:07:40.345321 [info ] [MainThread]: Finished running 5 table models in 0 hours 0 minutes and 1.36 seconds (1.36s).
[0m00:07:40.348884 [debug] [MainThread]: Command end result
[0m00:07:40.421886 [info ] [MainThread]: 
[0m00:07:40.425231 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m00:07:40.426920 [info ] [MainThread]: 
[0m00:07:40.428528 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "UNION"
  LINE 119:     UNION ALL
                ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m00:07:40.430343 [info ] [MainThread]: 
[0m00:07:40.432267 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=1 SKIP=0 TOTAL=5
[0m00:07:40.436683 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 3.4871545, "process_user_time": 4.735562, "process_kernel_time": 0.502927, "process_mem_max_rss": "200852", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m00:07:40.440990 [debug] [MainThread]: Command `dbt run` failed at 00:07:40.440484 after 3.49 seconds
[0m00:07:40.442840 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7013b119b9e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7013afb84050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7013b5932570>]}
[0m00:07:40.444504 [debug] [MainThread]: Flushing usage events
[0m00:10:04.164597 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7daca8cc65a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7daca8cc52e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7daca8cc7ce0>]}


============================== 00:10:04.170527 | 62d49a47-62a7-4e51-aee4-dee7860b34b4 ==============================
[0m00:10:04.170527 [info ] [MainThread]: Running with dbt=1.7.9
[0m00:10:04.172002 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m00:10:04.545534 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '62d49a47-62a7-4e51-aee4-dee7860b34b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7daca8313170>]}
[0m00:10:04.688631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '62d49a47-62a7-4e51-aee4-dee7860b34b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7daca8b92c00>]}
[0m00:10:04.690438 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m00:10:04.717597 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m00:10:05.007007 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m00:10:05.008219 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m00:10:05.208529 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m00:10:05.217123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '62d49a47-62a7-4e51-aee4-dee7860b34b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7daca83b2c90>]}
[0m00:10:05.289698 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '62d49a47-62a7-4e51-aee4-dee7860b34b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7daca7fb4e30>]}
[0m00:10:05.290883 [info ] [MainThread]: Found 5 models, 6 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m00:10:05.291801 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '62d49a47-62a7-4e51-aee4-dee7860b34b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7daca7742570>]}
[0m00:10:05.295521 [info ] [MainThread]: 
[0m00:10:05.297074 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m00:10:05.299613 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m00:10:05.313596 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m00:10:05.315066 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m00:10:05.316136 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:10:05.325165 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m00:10:05.327822 [debug] [ThreadPool]: On list_nba: Close
[0m00:10:05.331696 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m00:10:05.339948 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:10:05.340997 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m00:10:05.342040 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:10:05.349197 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m00:10:05.350367 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:10:05.351355 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m00:10:05.356388 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m00:10:05.358640 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m00:10:05.359966 [debug] [ThreadPool]: On list_nba_gold: Close
[0m00:10:05.367881 [debug] [MainThread]: Using postgres connection "master"
[0m00:10:05.368779 [debug] [MainThread]: On master: BEGIN
[0m00:10:05.369489 [debug] [MainThread]: Opening a new connection, currently in state init
[0m00:10:05.376275 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:10:05.377567 [debug] [MainThread]: Using postgres connection "master"
[0m00:10:05.378867 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m00:10:05.396619 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m00:10:05.398775 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '62d49a47-62a7-4e51-aee4-dee7860b34b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7daca7fb75f0>]}
[0m00:10:05.399815 [debug] [MainThread]: On master: ROLLBACK
[0m00:10:05.400995 [debug] [MainThread]: Using postgres connection "master"
[0m00:10:05.402025 [debug] [MainThread]: On master: BEGIN
[0m00:10:05.403724 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:10:05.404849 [debug] [MainThread]: On master: COMMIT
[0m00:10:05.405766 [debug] [MainThread]: Using postgres connection "master"
[0m00:10:05.406922 [debug] [MainThread]: On master: COMMIT
[0m00:10:05.408456 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:10:05.409603 [debug] [MainThread]: On master: Close
[0m00:10:05.412581 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m00:10:05.414595 [info ] [MainThread]: 
[0m00:10:05.419594 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m00:10:05.420806 [info ] [Thread-1 (]: 1 of 5 START sql table model gold.home_vs_away ................................. [RUN]
[0m00:10:05.422496 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m00:10:05.423607 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m00:10:05.436952 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m00:10:05.464319 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 00:10:05.424514 => 00:10:05.463914
[0m00:10:05.465306 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m00:10:05.517673 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m00:10:05.544126 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:10:05.545370 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m00:10:05.546328 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:10:05.553120 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:10:05.554411 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:10:05.555658 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m00:10:05.576391 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m00:10:05.585024 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:10:05.586416 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m00:10:05.588097 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:10:05.592286 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:10:05.593392 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m00:10:05.595348 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:10:05.621698 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:10:05.622893 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:10:05.623955 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:10:05.630400 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:10:05.639993 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m00:10:05.648806 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:10:05.650003 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m00:10:05.657620 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:10:05.660286 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 00:10:05.466080 => 00:10:05.659928
[0m00:10:05.662245 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m00:10:05.664133 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '62d49a47-62a7-4e51-aee4-dee7860b34b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7daca7330380>]}
[0m00:10:05.665413 [info ] [Thread-1 (]: 1 of 5 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.24s]
[0m00:10:05.666781 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m00:10:05.667772 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m00:10:05.668754 [info ] [Thread-1 (]: 2 of 5 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m00:10:05.670256 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m00:10:05.671304 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m00:10:05.676392 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m00:10:05.703454 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 00:10:05.672089 => 00:10:05.703074
[0m00:10:05.704538 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m00:10:05.710655 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m00:10:05.739030 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:10:05.740083 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m00:10:05.740972 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:10:05.747905 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:10:05.748977 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:10:05.750070 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m00:10:05.766834 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m00:10:05.771615 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:10:05.772827 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m00:10:05.774498 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:10:05.779541 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:10:05.780696 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m00:10:05.782283 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:10:05.785751 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:10:05.787379 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:10:05.788733 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:10:05.795077 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:10:05.819615 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m00:10:05.823257 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:10:05.825167 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m00:10:05.836202 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:10:05.841256 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 00:10:05.705404 => 00:10:05.840714
[0m00:10:05.843633 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m00:10:05.853402 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '62d49a47-62a7-4e51-aee4-dee7860b34b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7daca73baed0>]}
[0m00:10:05.856755 [info ] [Thread-1 (]: 2 of 5 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.18s]
[0m00:10:05.860117 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m00:10:05.862908 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m00:10:05.867526 [info ] [Thread-1 (]: 3 of 5 START sql table model gold.summary_by_season ............................ [RUN]
[0m00:10:05.870790 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m00:10:05.873273 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m00:10:05.882385 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m00:10:05.915012 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 00:10:05.878154 => 00:10:05.914575
[0m00:10:05.915902 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m00:10:05.921109 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m00:10:05.939118 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:10:05.939942 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m00:10:05.940757 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:10:05.947638 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:10:05.948548 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:10:05.949321 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m00:10:05.975588 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m00:10:05.981201 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:10:05.982387 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m00:10:05.984191 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:10:05.989196 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:10:05.990437 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m00:10:05.992152 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:10:05.996227 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:10:05.997373 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:10:05.998490 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:10:06.005113 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:10:06.009328 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m00:10:06.011440 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:10:06.012902 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m00:10:06.021537 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:10:06.024439 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 00:10:05.916514 => 00:10:06.024059
[0m00:10:06.025583 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m00:10:06.027586 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '62d49a47-62a7-4e51-aee4-dee7860b34b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7daca73bb500>]}
[0m00:10:06.029083 [info ] [Thread-1 (]: 3 of 5 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.16s]
[0m00:10:06.030535 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m00:10:06.031681 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:10:06.032739 [info ] [Thread-1 (]: 4 of 5 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m00:10:06.034707 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m00:10:06.035918 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:10:06.041290 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:10:06.069066 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 00:10:06.036811 => 00:10:06.068675
[0m00:10:06.070156 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:10:06.076002 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:10:06.104672 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:10:06.105719 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m00:10:06.106729 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:10:06.115439 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:10:06.116654 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:10:06.118247 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m00:10:06.153027 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m00:10:06.158564 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:10:06.159881 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m00:10:06.161854 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:10:06.166901 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:10:06.168023 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m00:10:06.169555 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:10:06.172425 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:10:06.173619 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:10:06.174964 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:10:06.180945 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:10:06.184926 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m00:10:06.186531 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:10:06.187513 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m00:10:06.195444 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:10:06.198035 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 00:10:06.070901 => 00:10:06.197699
[0m00:10:06.199104 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m00:10:06.200759 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '62d49a47-62a7-4e51-aee4-dee7860b34b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7daca7313740>]}
[0m00:10:06.202265 [info ] [Thread-1 (]: 4 of 5 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.17s]
[0m00:10:06.203742 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:10:06.205914 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m00:10:06.207171 [info ] [Thread-1 (]: 5 of 5 START sql table model gold.players_recommendations ...................... [RUN]
[0m00:10:06.208489 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m00:10:06.209601 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m00:10:06.218927 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m00:10:06.248372 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 00:10:06.210706 => 00:10:06.247991
[0m00:10:06.249366 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m00:10:06.256774 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m00:10:06.287029 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:10:06.288059 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m00:10:06.289011 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:10:06.297119 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:10:06.298202 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:10:06.299438 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN (SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM "nba"."silver"."player_stats") AS pgs
    ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
    UNION ALL
    
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN (SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) from "nba"."silver"."player_stats"
    GROUP BY player_id, player_name, team_abbreviation) AS pgs
    on p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')
    
    UNION ALL
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')
    UNION ALL
    SELECT
        'Rebotes' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')
    UNION ALL
    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')
    UNION ALL
    SELECT
        'Robos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')
    UNION ALL
    SELECT
        'Bloqueos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    UNION ALL
    SELECT
        'Diferencial Puntos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
     
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    player_id,
    is_free_agent,
    is_injured,
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m00:10:06.301754 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "FROM"
LINE 211: FROM spurs_weaknesses_unpivoted swu
          ^

[0m00:10:06.302982 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m00:10:06.304637 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 00:10:06.250194 => 00:10:06.304332
[0m00:10:06.305577 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m00:10:06.311914 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "FROM"
  LINE 211: FROM spurs_weaknesses_unpivoted swu
            ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m00:10:06.313178 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '62d49a47-62a7-4e51-aee4-dee7860b34b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7daca6f10c50>]}
[0m00:10:06.314665 [error] [Thread-1 (]: 5 of 5 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m00:10:06.315999 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m00:10:06.319607 [debug] [MainThread]: Using postgres connection "master"
[0m00:10:06.320522 [debug] [MainThread]: On master: BEGIN
[0m00:10:06.321378 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m00:10:06.328083 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:10:06.329211 [debug] [MainThread]: On master: COMMIT
[0m00:10:06.330212 [debug] [MainThread]: Using postgres connection "master"
[0m00:10:06.331068 [debug] [MainThread]: On master: COMMIT
[0m00:10:06.332273 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:10:06.333218 [debug] [MainThread]: On master: Close
[0m00:10:06.334826 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:10:06.335757 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m00:10:06.336810 [info ] [MainThread]: 
[0m00:10:06.337742 [info ] [MainThread]: Finished running 5 table models in 0 hours 0 minutes and 1.04 seconds (1.04s).
[0m00:10:06.339884 [debug] [MainThread]: Command end result
[0m00:10:06.401428 [info ] [MainThread]: 
[0m00:10:06.402493 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m00:10:06.403403 [info ] [MainThread]: 
[0m00:10:06.404356 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "FROM"
  LINE 211: FROM spurs_weaknesses_unpivoted swu
            ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m00:10:06.405240 [info ] [MainThread]: 
[0m00:10:06.406538 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=1 SKIP=0 TOTAL=5
[0m00:10:06.408072 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.3486814, "process_user_time": 4.920355, "process_kernel_time": 0.656601, "process_mem_max_rss": "200856", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m00:10:06.409245 [debug] [MainThread]: Command `dbt run` failed at 00:10:06.409073 after 2.35 seconds
[0m00:10:06.410436 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7daca93739b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7daca95592e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7daca8bbb7a0>]}
[0m00:10:06.412619 [debug] [MainThread]: Flushing usage events
[0m00:11:59.758075 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742f0710fa40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742f0710cd70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742f0710ff50>]}


============================== 00:11:59.762425 | ae2127d6-d868-48b0-b007-609615b88e5e ==============================
[0m00:11:59.762425 [info ] [MainThread]: Running with dbt=1.7.9
[0m00:11:59.763803 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m00:12:00.057288 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ae2127d6-d868-48b0-b007-609615b88e5e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742f079ae240>]}
[0m00:12:00.188022 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ae2127d6-d868-48b0-b007-609615b88e5e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742f07178a70>]}
[0m00:12:00.189621 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m00:12:00.216395 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m00:12:00.475608 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m00:12:00.476733 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m00:12:00.478053 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m00:12:00.485586 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ae2127d6-d868-48b0-b007-609615b88e5e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742f06aa08c0>]}
[0m00:12:00.555064 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ae2127d6-d868-48b0-b007-609615b88e5e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742f067acf20>]}
[0m00:12:00.556202 [info ] [MainThread]: Found 5 models, 6 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m00:12:00.557717 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ae2127d6-d868-48b0-b007-609615b88e5e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742f067ac9e0>]}
[0m00:12:00.560782 [info ] [MainThread]: 
[0m00:12:00.562351 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m00:12:00.564754 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m00:12:00.579927 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m00:12:00.581131 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m00:12:00.582068 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:12:00.591786 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m00:12:00.594126 [debug] [ThreadPool]: On list_nba: Close
[0m00:12:00.597325 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m00:12:00.606407 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:12:00.607637 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m00:12:00.608559 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:12:00.615994 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m00:12:00.617087 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:12:00.618138 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m00:12:00.624128 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m00:12:00.626309 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m00:12:00.627642 [debug] [ThreadPool]: On list_nba_gold: Close
[0m00:12:00.636259 [debug] [MainThread]: Using postgres connection "master"
[0m00:12:00.637713 [debug] [MainThread]: On master: BEGIN
[0m00:12:00.638596 [debug] [MainThread]: Opening a new connection, currently in state init
[0m00:12:00.646519 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:12:00.647817 [debug] [MainThread]: Using postgres connection "master"
[0m00:12:00.648919 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m00:12:00.666964 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m00:12:00.669363 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ae2127d6-d868-48b0-b007-609615b88e5e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742f07ddf6e0>]}
[0m00:12:00.670987 [debug] [MainThread]: On master: ROLLBACK
[0m00:12:00.672734 [debug] [MainThread]: Using postgres connection "master"
[0m00:12:00.673638 [debug] [MainThread]: On master: BEGIN
[0m00:12:00.675117 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:12:00.676267 [debug] [MainThread]: On master: COMMIT
[0m00:12:00.677163 [debug] [MainThread]: Using postgres connection "master"
[0m00:12:00.678035 [debug] [MainThread]: On master: COMMIT
[0m00:12:00.679136 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:12:00.680111 [debug] [MainThread]: On master: Close
[0m00:12:00.681489 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m00:12:00.682649 [info ] [MainThread]: 
[0m00:12:00.688150 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m00:12:00.689404 [info ] [Thread-1 (]: 1 of 5 START sql table model gold.home_vs_away ................................. [RUN]
[0m00:12:00.690789 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m00:12:00.692012 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m00:12:00.703957 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m00:12:00.730697 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 00:12:00.693062 => 00:12:00.730254
[0m00:12:00.732084 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m00:12:00.789454 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m00:12:00.813650 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:12:00.814637 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m00:12:00.815655 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:12:00.823574 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:12:00.824610 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:12:00.825696 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m00:12:00.844044 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m00:12:00.853104 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:12:00.854838 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m00:12:00.856438 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:12:00.860621 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:12:00.861717 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m00:12:00.863103 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:12:00.891861 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:12:00.893145 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:12:00.894031 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:12:00.900007 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:12:00.909832 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m00:12:00.918354 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:12:00.920373 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m00:12:00.927394 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:12:00.930119 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 00:12:00.733180 => 00:12:00.929849
[0m00:12:00.931248 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m00:12:00.933899 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ae2127d6-d868-48b0-b007-609615b88e5e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742f05f1de50>]}
[0m00:12:00.936509 [info ] [Thread-1 (]: 1 of 5 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.24s]
[0m00:12:00.938122 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m00:12:00.939240 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m00:12:00.940564 [info ] [Thread-1 (]: 2 of 5 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m00:12:00.942058 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m00:12:00.942918 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m00:12:00.947990 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m00:12:00.973071 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 00:12:00.943631 => 00:12:00.972676
[0m00:12:00.974041 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m00:12:00.980236 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m00:12:01.006709 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:12:01.008203 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m00:12:01.009347 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:12:01.017678 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:12:01.019026 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:12:01.020843 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m00:12:01.038566 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m00:12:01.043534 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:12:01.045037 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m00:12:01.046664 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:12:01.051135 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:12:01.052943 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m00:12:01.054890 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:12:01.058267 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:12:01.059635 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:12:01.060595 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:12:01.066503 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:12:01.071661 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m00:12:01.073273 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:12:01.074266 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m00:12:01.080870 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:12:01.083370 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 00:12:00.974834 => 00:12:01.083104
[0m00:12:01.084535 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m00:12:01.087288 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ae2127d6-d868-48b0-b007-609615b88e5e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742f06764980>]}
[0m00:12:01.089577 [info ] [Thread-1 (]: 2 of 5 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.15s]
[0m00:12:01.091140 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m00:12:01.092667 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m00:12:01.093775 [info ] [Thread-1 (]: 3 of 5 START sql table model gold.summary_by_season ............................ [RUN]
[0m00:12:01.095020 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m00:12:01.096065 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m00:12:01.100455 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m00:12:01.125878 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 00:12:01.096792 => 00:12:01.125504
[0m00:12:01.126799 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m00:12:01.132660 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m00:12:01.161186 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:12:01.162225 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m00:12:01.163133 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:12:01.171825 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:12:01.173061 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:12:01.174031 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m00:12:01.192335 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m00:12:01.198208 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:12:01.199253 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m00:12:01.200683 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:12:01.205696 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:12:01.206705 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m00:12:01.208124 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:12:01.210892 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:12:01.212011 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:12:01.213012 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:12:01.219041 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:12:01.223909 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m00:12:01.225301 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:12:01.226272 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m00:12:01.233249 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:12:01.236097 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 00:12:01.127558 => 00:12:01.235634
[0m00:12:01.237211 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m00:12:01.238772 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ae2127d6-d868-48b0-b007-609615b88e5e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742f05f920f0>]}
[0m00:12:01.240018 [info ] [Thread-1 (]: 3 of 5 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.14s]
[0m00:12:01.241436 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m00:12:01.242603 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:12:01.243694 [info ] [Thread-1 (]: 4 of 5 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m00:12:01.245105 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m00:12:01.246172 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:12:01.251529 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:12:01.278521 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 00:12:01.246899 => 00:12:01.278113
[0m00:12:01.279591 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:12:01.284818 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:12:01.314257 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:12:01.315308 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m00:12:01.316521 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:12:01.324650 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:12:01.325774 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:12:01.327085 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m00:12:01.362933 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m00:12:01.369717 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:12:01.371982 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m00:12:01.373890 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:12:01.380463 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:12:01.382006 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m00:12:01.384220 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:12:01.388700 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:12:01.389805 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:12:01.390816 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:12:01.396338 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:12:01.400825 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m00:12:01.403258 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:12:01.404658 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m00:12:01.412163 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:12:01.415019 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 00:12:01.280420 => 00:12:01.414694
[0m00:12:01.416446 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m00:12:01.418940 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ae2127d6-d868-48b0-b007-609615b88e5e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742f05f9ddc0>]}
[0m00:12:01.420790 [info ] [Thread-1 (]: 4 of 5 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.17s]
[0m00:12:01.422508 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:12:01.424831 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m00:12:01.426580 [info ] [Thread-1 (]: 5 of 5 START sql table model gold.players_recommendations ...................... [RUN]
[0m00:12:01.428235 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m00:12:01.429269 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m00:12:01.439175 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m00:12:01.463628 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 00:12:01.430116 => 00:12:01.462999
[0m00:12:01.464757 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m00:12:01.472299 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m00:12:01.498334 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:12:01.499332 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m00:12:01.500331 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:12:01.507472 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:12:01.508632 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:12:01.510089 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN (SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM "nba"."silver"."player_stats") AS pgs
    ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
    UNION ALL
    
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN (SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) from "nba"."silver"."player_stats"
    GROUP BY player_id, player_name, team_abbreviation) AS pgs
    on p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')
    
    UNION ALL
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')
    UNION ALL
    SELECT
        'Rebotes' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')
    UNION ALL
    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')
    UNION ALL
    SELECT
        'Robos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')
    UNION ALL
    SELECT
        'Bloqueos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    UNION ALL
    SELECT
        'Diferencial Puntos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
     
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    player_id,
    is_free_agent,
    is_injured,
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m00:12:01.512770 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "FROM"
LINE 211: FROM spurs_weaknesses_unpivoted swu
          ^

[0m00:12:01.514022 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m00:12:01.515708 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 00:12:01.465607 => 00:12:01.515275
[0m00:12:01.516815 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m00:12:01.524074 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "FROM"
  LINE 211: FROM spurs_weaknesses_unpivoted swu
            ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m00:12:01.525403 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ae2127d6-d868-48b0-b007-609615b88e5e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742f05f97ec0>]}
[0m00:12:01.526586 [error] [Thread-1 (]: 5 of 5 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m00:12:01.527987 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m00:12:01.532534 [debug] [MainThread]: Using postgres connection "master"
[0m00:12:01.533595 [debug] [MainThread]: On master: BEGIN
[0m00:12:01.534419 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m00:12:01.541179 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:12:01.542252 [debug] [MainThread]: On master: COMMIT
[0m00:12:01.543167 [debug] [MainThread]: Using postgres connection "master"
[0m00:12:01.544019 [debug] [MainThread]: On master: COMMIT
[0m00:12:01.545232 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:12:01.546067 [debug] [MainThread]: On master: Close
[0m00:12:01.547511 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:12:01.548397 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m00:12:01.549336 [info ] [MainThread]: 
[0m00:12:01.550262 [info ] [MainThread]: Finished running 5 table models in 0 hours 0 minutes and 0.99 seconds (0.99s).
[0m00:12:01.553619 [debug] [MainThread]: Command end result
[0m00:12:01.620467 [info ] [MainThread]: 
[0m00:12:01.622034 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m00:12:01.623260 [info ] [MainThread]: 
[0m00:12:01.624497 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  syntax error at or near "FROM"
  LINE 211: FROM spurs_weaknesses_unpivoted swu
            ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m00:12:01.625612 [info ] [MainThread]: 
[0m00:12:01.626767 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=1 SKIP=0 TOTAL=5
[0m00:12:01.628739 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 1.957945, "process_user_time": 3.781726, "process_kernel_time": 0.368558, "process_mem_max_rss": "200856", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m00:12:01.630013 [debug] [MainThread]: Command `dbt run` failed at 00:12:01.629771 after 1.96 seconds
[0m00:12:01.631473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742f0748d2e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742f07178a70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742f074ddac0>]}
[0m00:12:01.633042 [debug] [MainThread]: Flushing usage events
[0m00:12:53.205529 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71a66caed0a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71a66ceb9f70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71a66caecfb0>]}


============================== 00:12:53.212334 | 49bd9e01-0ebe-41e0-866e-526af6cf9f16 ==============================
[0m00:12:53.212334 [info ] [MainThread]: Running with dbt=1.7.9
[0m00:12:53.213542 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m00:12:53.487513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '49bd9e01-0ebe-41e0-866e-526af6cf9f16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71a66d70d580>]}
[0m00:12:53.614854 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '49bd9e01-0ebe-41e0-866e-526af6cf9f16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71a66c9e33b0>]}
[0m00:12:53.616191 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m00:12:53.640372 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m00:12:53.853698 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m00:12:53.855004 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m00:12:54.054027 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m00:12:54.062020 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '49bd9e01-0ebe-41e0-866e-526af6cf9f16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71a66ceb9610>]}
[0m00:12:54.134640 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '49bd9e01-0ebe-41e0-866e-526af6cf9f16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71a66bda8b30>]}
[0m00:12:54.135740 [info ] [MainThread]: Found 5 models, 6 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m00:12:54.136793 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '49bd9e01-0ebe-41e0-866e-526af6cf9f16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71a66cbea8a0>]}
[0m00:12:54.139573 [info ] [MainThread]: 
[0m00:12:54.140978 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m00:12:54.144318 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m00:12:54.157770 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m00:12:54.159026 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m00:12:54.160746 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:12:54.173565 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m00:12:54.177229 [debug] [ThreadPool]: On list_nba: Close
[0m00:12:54.181353 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m00:12:54.191165 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:12:54.192621 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m00:12:54.194401 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:12:54.203823 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m00:12:54.205016 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:12:54.205967 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m00:12:54.212469 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m00:12:54.215090 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m00:12:54.216449 [debug] [ThreadPool]: On list_nba_gold: Close
[0m00:12:54.227474 [debug] [MainThread]: Using postgres connection "master"
[0m00:12:54.228540 [debug] [MainThread]: On master: BEGIN
[0m00:12:54.229446 [debug] [MainThread]: Opening a new connection, currently in state init
[0m00:12:54.237590 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:12:54.238942 [debug] [MainThread]: Using postgres connection "master"
[0m00:12:54.240183 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m00:12:54.261888 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m00:12:54.264198 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '49bd9e01-0ebe-41e0-866e-526af6cf9f16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71a66bdfc9e0>]}
[0m00:12:54.265739 [debug] [MainThread]: On master: ROLLBACK
[0m00:12:54.267804 [debug] [MainThread]: Using postgres connection "master"
[0m00:12:54.269112 [debug] [MainThread]: On master: BEGIN
[0m00:12:54.271077 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:12:54.272514 [debug] [MainThread]: On master: COMMIT
[0m00:12:54.273702 [debug] [MainThread]: Using postgres connection "master"
[0m00:12:54.274780 [debug] [MainThread]: On master: COMMIT
[0m00:12:54.276634 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:12:54.278350 [debug] [MainThread]: On master: Close
[0m00:12:54.280993 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m00:12:54.282178 [info ] [MainThread]: 
[0m00:12:54.287410 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m00:12:54.288830 [info ] [Thread-1 (]: 1 of 5 START sql table model gold.home_vs_away ................................. [RUN]
[0m00:12:54.290768 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m00:12:54.292220 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m00:12:54.307479 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m00:12:54.332452 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 00:12:54.293761 => 00:12:54.331918
[0m00:12:54.333464 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m00:12:54.399658 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m00:12:54.427805 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:12:54.428831 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m00:12:54.429801 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:12:54.437470 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:12:54.438578 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:12:54.439690 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m00:12:54.460880 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m00:12:54.469921 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:12:54.471162 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m00:12:54.472640 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:12:54.477701 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:12:54.479071 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m00:12:54.480770 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:12:54.507212 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:12:54.508364 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:12:54.509713 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:12:54.516754 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:12:54.526189 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m00:12:54.534867 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:12:54.535917 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m00:12:54.543553 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:12:54.546182 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 00:12:54.334146 => 00:12:54.545906
[0m00:12:54.547621 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m00:12:54.549751 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49bd9e01-0ebe-41e0-866e-526af6cf9f16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71a66b10c5c0>]}
[0m00:12:54.552086 [info ] [Thread-1 (]: 1 of 5 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.26s]
[0m00:12:54.554314 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m00:12:54.555545 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m00:12:54.557033 [info ] [Thread-1 (]: 2 of 5 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m00:12:54.559592 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m00:12:54.561275 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m00:12:54.566371 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m00:12:54.590464 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 00:12:54.562117 => 00:12:54.590057
[0m00:12:54.591643 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m00:12:54.597785 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m00:12:54.622236 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:12:54.623413 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m00:12:54.624302 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:12:54.631100 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:12:54.632196 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:12:54.633280 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m00:12:54.651110 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m00:12:54.655738 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:12:54.656867 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m00:12:54.658368 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:12:54.663132 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:12:54.664265 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m00:12:54.665778 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:12:54.668930 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:12:54.670040 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:12:54.670964 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:12:54.676898 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:12:54.682398 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m00:12:54.684145 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:12:54.685190 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m00:12:54.692140 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:12:54.695031 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 00:12:54.592766 => 00:12:54.694737
[0m00:12:54.696188 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m00:12:54.697888 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49bd9e01-0ebe-41e0-866e-526af6cf9f16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71a66b1b3b30>]}
[0m00:12:54.699218 [info ] [Thread-1 (]: 2 of 5 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.14s]
[0m00:12:54.700669 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m00:12:54.701891 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m00:12:54.703056 [info ] [Thread-1 (]: 3 of 5 START sql table model gold.summary_by_season ............................ [RUN]
[0m00:12:54.704470 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m00:12:54.705524 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m00:12:54.711215 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m00:12:54.736078 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 00:12:54.706373 => 00:12:54.735668
[0m00:12:54.737155 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m00:12:54.743766 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m00:12:54.769360 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:12:54.770428 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m00:12:54.771549 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:12:54.778653 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:12:54.779774 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:12:54.780838 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m00:12:54.800641 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m00:12:54.805348 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:12:54.806482 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m00:12:54.808108 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:12:54.812796 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:12:54.813942 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m00:12:54.815484 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:12:54.819108 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:12:54.820429 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:12:54.821664 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:12:54.828375 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:12:54.832470 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m00:12:54.833965 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:12:54.835116 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m00:12:54.843122 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:12:54.845788 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 00:12:54.737952 => 00:12:54.845473
[0m00:12:54.846871 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m00:12:54.848506 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49bd9e01-0ebe-41e0-866e-526af6cf9f16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71a66b1b08f0>]}
[0m00:12:54.850057 [info ] [Thread-1 (]: 3 of 5 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.14s]
[0m00:12:54.851773 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m00:12:54.853170 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:12:54.854430 [info ] [Thread-1 (]: 4 of 5 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m00:12:54.855975 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m00:12:54.857152 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:12:54.864312 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:12:54.890987 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 00:12:54.857881 => 00:12:54.890505
[0m00:12:54.892324 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:12:54.898781 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:12:54.925148 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:12:54.927052 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m00:12:54.928826 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:12:54.936433 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:12:54.937630 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:12:54.938892 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m00:12:54.971572 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m00:12:54.977156 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:12:54.978340 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m00:12:54.979940 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:12:54.984615 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:12:54.985756 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m00:12:54.987407 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:12:54.990813 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:12:54.992004 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:12:54.993591 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:12:55.000334 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:12:55.004472 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m00:12:55.005997 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:12:55.007068 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m00:12:55.013609 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:12:55.016096 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 00:12:54.893473 => 00:12:55.015802
[0m00:12:55.017167 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m00:12:55.018905 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49bd9e01-0ebe-41e0-866e-526af6cf9f16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71a66bdab7a0>]}
[0m00:12:55.020424 [info ] [Thread-1 (]: 4 of 5 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.16s]
[0m00:12:55.022262 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:12:55.025271 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m00:12:55.027343 [info ] [Thread-1 (]: 5 of 5 START sql table model gold.players_recommendations ...................... [RUN]
[0m00:12:55.028977 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m00:12:55.030079 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m00:12:55.039410 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m00:12:55.068832 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 00:12:55.030978 => 00:12:55.068349
[0m00:12:55.070057 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m00:12:55.078501 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m00:12:55.104254 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:12:55.105312 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m00:12:55.106196 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:12:55.112947 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:12:55.114098 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:12:55.115327 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN (SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM "nba"."silver"."player_stats") AS pgs
    ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
    UNION ALL
    
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN (SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) from "nba"."silver"."player_stats"
    GROUP BY player_id, player_name, team_abbreviation) AS pgs
    on p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')
    
    UNION ALL
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')
    UNION ALL
    SELECT
        'Rebotes' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')
    UNION ALL
    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')
    UNION ALL
    SELECT
        'Robos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')
    UNION ALL
    SELECT
        'Bloqueos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    UNION ALL
    SELECT
        'Diferencial Puntos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
     
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    player_id,
    is_free_agent,
    is_injured
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m00:12:55.118510 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "player_stats.player_id" must appear in the GROUP BY clause or be used in an aggregate function
LINE 47:     player_id,
             ^

[0m00:12:55.119773 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m00:12:55.121430 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 00:12:55.070968 => 00:12:55.121116
[0m00:12:55.122737 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m00:12:55.128847 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column "player_stats.player_id" must appear in the GROUP BY clause or be used in an aggregate function
  LINE 47:     player_id,
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m00:12:55.130083 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49bd9e01-0ebe-41e0-866e-526af6cf9f16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71a66b1ee450>]}
[0m00:12:55.131420 [error] [Thread-1 (]: 5 of 5 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m00:12:55.132849 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m00:12:55.137024 [debug] [MainThread]: Using postgres connection "master"
[0m00:12:55.138096 [debug] [MainThread]: On master: BEGIN
[0m00:12:55.139095 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m00:12:55.147213 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:12:55.148388 [debug] [MainThread]: On master: COMMIT
[0m00:12:55.149316 [debug] [MainThread]: Using postgres connection "master"
[0m00:12:55.150201 [debug] [MainThread]: On master: COMMIT
[0m00:12:55.151383 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:12:55.152280 [debug] [MainThread]: On master: Close
[0m00:12:55.153650 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:12:55.154735 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m00:12:55.155910 [info ] [MainThread]: 
[0m00:12:55.156916 [info ] [MainThread]: Finished running 5 table models in 0 hours 0 minutes and 1.02 seconds (1.02s).
[0m00:12:55.159126 [debug] [MainThread]: Command end result
[0m00:12:55.218310 [info ] [MainThread]: 
[0m00:12:55.219421 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m00:12:55.220281 [info ] [MainThread]: 
[0m00:12:55.221114 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column "player_stats.player_id" must appear in the GROUP BY clause or be used in an aggregate function
  LINE 47:     player_id,
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m00:12:55.222741 [info ] [MainThread]: 
[0m00:12:55.223891 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=1 SKIP=0 TOTAL=5
[0m00:12:55.225737 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.1028752, "process_user_time": 3.702541, "process_kernel_time": 0.3967, "process_mem_max_rss": "200856", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m00:12:55.226964 [debug] [MainThread]: Command `dbt run` failed at 00:12:55.226743 after 2.10 seconds
[0m00:12:55.227965 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71a66ad086e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71a66b1a50d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71a66b50ea20>]}
[0m00:12:55.228940 [debug] [MainThread]: Flushing usage events
[0m00:14:23.613977 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7599e5b2cf20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7599e5ededb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7599e5b2f620>]}


============================== 00:14:23.618066 | c84532f2-1671-4fce-a00e-c7999dd0e7c2 ==============================
[0m00:14:23.618066 [info ] [MainThread]: Running with dbt=1.7.9
[0m00:14:23.619369 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m00:14:23.908179 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c84532f2-1671-4fce-a00e-c7999dd0e7c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7599e5c51640>]}
[0m00:14:24.034712 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c84532f2-1671-4fce-a00e-c7999dd0e7c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7599e5b8df10>]}
[0m00:14:24.036163 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m00:14:24.061655 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m00:14:24.317041 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m00:14:24.318435 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m00:14:24.530276 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m00:14:24.538108 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c84532f2-1671-4fce-a00e-c7999dd0e7c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7599e43ff7a0>]}
[0m00:14:24.612400 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c84532f2-1671-4fce-a00e-c7999dd0e7c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7599e4b69310>]}
[0m00:14:24.613928 [info ] [MainThread]: Found 5 models, 6 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m00:14:24.615149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c84532f2-1671-4fce-a00e-c7999dd0e7c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7599e431e960>]}
[0m00:14:24.618266 [info ] [MainThread]: 
[0m00:14:24.619796 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m00:14:24.622310 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m00:14:24.642411 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m00:14:24.644069 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m00:14:24.645451 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:14:24.657628 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m00:14:24.660547 [debug] [ThreadPool]: On list_nba: Close
[0m00:14:24.664384 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m00:14:24.672075 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:14:24.673447 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m00:14:24.674510 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:14:24.682495 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m00:14:24.683714 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:14:24.684565 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m00:14:24.689043 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m00:14:24.691161 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m00:14:24.692928 [debug] [ThreadPool]: On list_nba_gold: Close
[0m00:14:24.700884 [debug] [MainThread]: Using postgres connection "master"
[0m00:14:24.702044 [debug] [MainThread]: On master: BEGIN
[0m00:14:24.702983 [debug] [MainThread]: Opening a new connection, currently in state init
[0m00:14:24.710837 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:14:24.711988 [debug] [MainThread]: Using postgres connection "master"
[0m00:14:24.713284 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m00:14:24.731204 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m00:14:24.733926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c84532f2-1671-4fce-a00e-c7999dd0e7c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7599e431c590>]}
[0m00:14:24.735119 [debug] [MainThread]: On master: ROLLBACK
[0m00:14:24.736428 [debug] [MainThread]: Using postgres connection "master"
[0m00:14:24.737394 [debug] [MainThread]: On master: BEGIN
[0m00:14:24.739117 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:14:24.740100 [debug] [MainThread]: On master: COMMIT
[0m00:14:24.741049 [debug] [MainThread]: Using postgres connection "master"
[0m00:14:24.742560 [debug] [MainThread]: On master: COMMIT
[0m00:14:24.744877 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:14:24.746030 [debug] [MainThread]: On master: Close
[0m00:14:24.747705 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m00:14:24.748884 [info ] [MainThread]: 
[0m00:14:24.753982 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m00:14:24.755159 [info ] [Thread-1 (]: 1 of 5 START sql table model gold.home_vs_away ................................. [RUN]
[0m00:14:24.756585 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m00:14:24.757914 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m00:14:24.769002 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m00:14:24.796201 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 00:14:24.759130 => 00:14:24.795808
[0m00:14:24.797276 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m00:14:24.850387 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m00:14:24.881688 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:14:24.883119 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m00:14:24.884457 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:14:24.892710 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:14:24.894542 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:14:24.896198 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m00:14:24.927833 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m00:14:24.936738 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:14:24.937914 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m00:14:24.939419 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:14:24.944762 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:14:24.945912 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m00:14:24.947442 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:14:24.973211 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:14:24.974682 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:14:24.978179 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:14:24.986027 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:14:24.995600 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m00:14:25.003657 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:14:25.004809 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m00:14:25.014486 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:14:25.017428 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 00:14:24.798077 => 00:14:25.017112
[0m00:14:25.018554 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m00:14:25.020624 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c84532f2-1671-4fce-a00e-c7999dd0e7c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7599e43c7f80>]}
[0m00:14:25.022283 [info ] [Thread-1 (]: 1 of 5 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.26s]
[0m00:14:25.024123 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m00:14:25.026112 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m00:14:25.027894 [info ] [Thread-1 (]: 2 of 5 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m00:14:25.029671 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m00:14:25.030985 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m00:14:25.035969 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m00:14:25.063384 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 00:14:25.031718 => 00:14:25.062953
[0m00:14:25.064480 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m00:14:25.070074 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m00:14:25.097472 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:14:25.099833 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m00:14:25.100982 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:14:25.109525 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:14:25.111009 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:14:25.112445 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m00:14:25.131991 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m00:14:25.137632 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:14:25.138925 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m00:14:25.141077 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:14:25.149305 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:14:25.150782 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m00:14:25.152692 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:14:25.156331 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:14:25.157697 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:14:25.159792 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:14:25.166189 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:14:25.171769 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m00:14:25.173832 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:14:25.175696 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m00:14:25.183778 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:14:25.187621 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 00:14:25.065280 => 00:14:25.187239
[0m00:14:25.188917 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m00:14:25.191029 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c84532f2-1671-4fce-a00e-c7999dd0e7c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7599e3f74920>]}
[0m00:14:25.193212 [info ] [Thread-1 (]: 2 of 5 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.16s]
[0m00:14:25.194872 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m00:14:25.196089 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m00:14:25.197311 [info ] [Thread-1 (]: 3 of 5 START sql table model gold.summary_by_season ............................ [RUN]
[0m00:14:25.198946 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m00:14:25.199968 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m00:14:25.205189 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m00:14:25.233052 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 00:14:25.200764 => 00:14:25.232510
[0m00:14:25.234686 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m00:14:25.240527 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m00:14:25.266008 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:14:25.267088 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m00:14:25.268213 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:14:25.275465 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:14:25.277285 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:14:25.278542 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m00:14:25.298603 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m00:14:25.303558 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:14:25.304682 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m00:14:25.306248 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:14:25.311076 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:14:25.312205 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m00:14:25.314164 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:14:25.317148 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:14:25.318277 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:14:25.319323 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:14:25.327768 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:14:25.331642 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m00:14:25.333435 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:14:25.334710 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m00:14:25.343280 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:14:25.345925 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 00:14:25.235489 => 00:14:25.345568
[0m00:14:25.347059 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m00:14:25.348692 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c84532f2-1671-4fce-a00e-c7999dd0e7c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7599e3f74890>]}
[0m00:14:25.349978 [info ] [Thread-1 (]: 3 of 5 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m00:14:25.351290 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m00:14:25.352446 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:14:25.354011 [info ] [Thread-1 (]: 4 of 5 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m00:14:25.355450 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m00:14:25.356487 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:14:25.362723 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:14:25.388317 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 00:14:25.357263 => 00:14:25.387940
[0m00:14:25.389406 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:14:25.396225 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:14:25.420947 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:14:25.422180 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m00:14:25.423231 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:14:25.432521 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:14:25.434357 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:14:25.436460 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m00:14:25.471576 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m00:14:25.477978 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:14:25.479031 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m00:14:25.480554 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:14:25.484913 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:14:25.486161 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m00:14:25.487886 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:14:25.490795 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:14:25.492141 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:14:25.494041 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:14:25.500359 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:14:25.504634 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m00:14:25.506239 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:14:25.507291 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m00:14:25.514684 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:14:25.517112 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 00:14:25.390293 => 00:14:25.516839
[0m00:14:25.518067 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m00:14:25.519822 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c84532f2-1671-4fce-a00e-c7999dd0e7c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7599e43af590>]}
[0m00:14:25.521086 [info ] [Thread-1 (]: 4 of 5 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.16s]
[0m00:14:25.522654 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:14:25.524615 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m00:14:25.526435 [info ] [Thread-1 (]: 5 of 5 START sql table model gold.players_recommendations ...................... [RUN]
[0m00:14:25.528017 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m00:14:25.529024 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m00:14:25.537360 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m00:14:25.564954 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 00:14:25.529891 => 00:14:25.564542
[0m00:14:25.566046 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m00:14:25.573157 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m00:14:25.599627 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:14:25.600697 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m00:14:25.601638 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:14:25.608726 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:14:25.610685 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:14:25.612095 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN (SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
FROM "nba"."silver"."player_stats") AS pgs
    ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
    UNION ALL
    
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN (SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) from "nba"."silver"."player_stats"
    GROUP BY player_id, player_name, team_abbreviation) AS pgs
    on p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')
    
    UNION ALL
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')
    UNION ALL
    SELECT
        'Rebotes' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')
    UNION ALL
    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')
    UNION ALL
    SELECT
        'Robos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')
    UNION ALL
    SELECT
        'Bloqueos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    UNION ALL
    SELECT
        'Diferencial Puntos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
     
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    tt.player_id,
    tt.is_free_agent,
    tt.is_injured
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m00:14:25.614936 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "player_stats.player_id" must appear in the GROUP BY clause or be used in an aggregate function
LINE 47:     player_id,
             ^

[0m00:14:25.615988 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m00:14:25.617552 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 00:14:25.566905 => 00:14:25.617241
[0m00:14:25.618713 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m00:14:25.624246 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column "player_stats.player_id" must appear in the GROUP BY clause or be used in an aggregate function
  LINE 47:     player_id,
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m00:14:25.625628 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c84532f2-1671-4fce-a00e-c7999dd0e7c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7599e3fc4e30>]}
[0m00:14:25.627737 [error] [Thread-1 (]: 5 of 5 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m00:14:25.629384 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m00:14:25.634421 [debug] [MainThread]: Using postgres connection "master"
[0m00:14:25.635396 [debug] [MainThread]: On master: BEGIN
[0m00:14:25.636237 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m00:14:25.643723 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:14:25.644725 [debug] [MainThread]: On master: COMMIT
[0m00:14:25.645814 [debug] [MainThread]: Using postgres connection "master"
[0m00:14:25.646855 [debug] [MainThread]: On master: COMMIT
[0m00:14:25.648210 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:14:25.649215 [debug] [MainThread]: On master: Close
[0m00:14:25.650656 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:14:25.651657 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m00:14:25.652846 [info ] [MainThread]: 
[0m00:14:25.654189 [info ] [MainThread]: Finished running 5 table models in 0 hours 0 minutes and 1.03 seconds (1.03s).
[0m00:14:25.656252 [debug] [MainThread]: Command end result
[0m00:14:25.718052 [info ] [MainThread]: 
[0m00:14:25.719165 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m00:14:25.720122 [info ] [MainThread]: 
[0m00:14:25.721073 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column "player_stats.player_id" must appear in the GROUP BY clause or be used in an aggregate function
  LINE 47:     player_id,
               ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m00:14:25.722024 [info ] [MainThread]: 
[0m00:14:25.722966 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=1 SKIP=0 TOTAL=5
[0m00:14:25.724614 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.1987526, "process_user_time": 3.780471, "process_kernel_time": 0.342232, "process_mem_max_rss": "200864", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m00:14:25.726268 [debug] [MainThread]: Command `dbt run` failed at 00:14:25.725843 after 2.20 seconds
[0m00:14:25.727440 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7599e622fcb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7599e3f69070>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7599e47ef200>]}
[0m00:14:25.728482 [debug] [MainThread]: Flushing usage events
[0m00:15:45.386020 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4489ded100>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a448a46c440>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4489ded040>]}


============================== 00:15:45.391193 | 95bde720-767f-4770-bac8-f498d1ffec3f ==============================
[0m00:15:45.391193 [info ] [MainThread]: Running with dbt=1.7.9
[0m00:15:45.392500 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m00:15:45.682073 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '95bde720-767f-4770-bac8-f498d1ffec3f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4489107c20>]}
[0m00:15:45.805355 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '95bde720-767f-4770-bac8-f498d1ffec3f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4489e57a70>]}
[0m00:15:45.807521 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m00:15:45.835351 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m00:15:46.072717 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m00:15:46.074514 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m00:15:46.316771 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m00:15:46.328114 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '95bde720-767f-4770-bac8-f498d1ffec3f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a44885ffa40>]}
[0m00:15:46.394376 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '95bde720-767f-4770-bac8-f498d1ffec3f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4488dacaa0>]}
[0m00:15:46.395374 [info ] [MainThread]: Found 5 models, 6 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m00:15:46.396320 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '95bde720-767f-4770-bac8-f498d1ffec3f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a448a1653a0>]}
[0m00:15:46.399051 [info ] [MainThread]: 
[0m00:15:46.400552 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m00:15:46.403570 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m00:15:46.420753 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m00:15:46.421888 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m00:15:46.423338 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:15:46.433677 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m00:15:46.435909 [debug] [ThreadPool]: On list_nba: Close
[0m00:15:46.439414 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m00:15:46.447587 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:15:46.448665 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m00:15:46.449583 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:15:46.457279 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m00:15:46.458360 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:15:46.459273 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m00:15:46.463871 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m00:15:46.466147 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m00:15:46.467362 [debug] [ThreadPool]: On list_nba_gold: Close
[0m00:15:46.475882 [debug] [MainThread]: Using postgres connection "master"
[0m00:15:46.476887 [debug] [MainThread]: On master: BEGIN
[0m00:15:46.477859 [debug] [MainThread]: Opening a new connection, currently in state init
[0m00:15:46.485871 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:15:46.487024 [debug] [MainThread]: Using postgres connection "master"
[0m00:15:46.488069 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m00:15:46.508535 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m00:15:46.511134 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '95bde720-767f-4770-bac8-f498d1ffec3f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4488d23b60>]}
[0m00:15:46.512366 [debug] [MainThread]: On master: ROLLBACK
[0m00:15:46.513668 [debug] [MainThread]: Using postgres connection "master"
[0m00:15:46.514753 [debug] [MainThread]: On master: BEGIN
[0m00:15:46.516401 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:15:46.517412 [debug] [MainThread]: On master: COMMIT
[0m00:15:46.518314 [debug] [MainThread]: Using postgres connection "master"
[0m00:15:46.519285 [debug] [MainThread]: On master: COMMIT
[0m00:15:46.520649 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:15:46.521593 [debug] [MainThread]: On master: Close
[0m00:15:46.524256 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m00:15:46.526162 [info ] [MainThread]: 
[0m00:15:46.531699 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m00:15:46.533075 [info ] [Thread-1 (]: 1 of 5 START sql table model gold.home_vs_away ................................. [RUN]
[0m00:15:46.534694 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m00:15:46.535871 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m00:15:46.547392 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m00:15:46.571406 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 00:15:46.536782 => 00:15:46.570992
[0m00:15:46.572790 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m00:15:46.625986 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m00:15:46.651853 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:15:46.652906 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m00:15:46.653865 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:15:46.661082 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:15:46.662272 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:15:46.663257 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m00:15:46.684328 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m00:15:46.693302 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:15:46.694418 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m00:15:46.696130 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:15:46.701318 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:15:46.702419 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m00:15:46.703836 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:15:46.734449 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:15:46.735578 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:15:46.736523 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:15:46.742559 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:15:46.751952 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m00:15:46.761134 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:15:46.762251 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m00:15:46.771193 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:15:46.774588 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 00:15:46.574256 => 00:15:46.774285
[0m00:15:46.775948 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m00:15:46.777725 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '95bde720-767f-4770-bac8-f498d1ffec3f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4488120590>]}
[0m00:15:46.780341 [info ] [Thread-1 (]: 1 of 5 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.24s]
[0m00:15:46.781735 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m00:15:46.782926 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m00:15:46.783996 [info ] [Thread-1 (]: 2 of 5 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m00:15:46.785388 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m00:15:46.786422 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m00:15:46.792497 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m00:15:46.818996 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 00:15:46.787234 => 00:15:46.818591
[0m00:15:46.820031 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m00:15:46.826055 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m00:15:46.851655 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:15:46.852820 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m00:15:46.853880 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:15:46.863043 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:15:46.864352 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:15:46.865598 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m00:15:46.884545 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m00:15:46.890163 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:15:46.891640 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m00:15:46.893243 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:15:46.897766 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:15:46.899375 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m00:15:46.901094 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:15:46.904602 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:15:46.906162 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:15:46.907942 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:15:46.913857 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:15:46.919396 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m00:15:46.921114 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:15:46.922228 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m00:15:46.935626 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:15:46.938324 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 00:15:46.820686 => 00:15:46.938032
[0m00:15:46.939532 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m00:15:46.941691 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '95bde720-767f-4770-bac8-f498d1ffec3f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a44881bbf20>]}
[0m00:15:46.944695 [info ] [Thread-1 (]: 2 of 5 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.16s]
[0m00:15:46.946441 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m00:15:46.947711 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m00:15:46.948794 [info ] [Thread-1 (]: 3 of 5 START sql table model gold.summary_by_season ............................ [RUN]
[0m00:15:46.950623 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m00:15:46.951750 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m00:15:46.957117 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m00:15:46.984440 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 00:15:46.952642 => 00:15:46.983955
[0m00:15:46.985529 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m00:15:46.993357 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m00:15:47.022811 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:15:47.024168 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m00:15:47.025379 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:15:47.033959 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:15:47.035692 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:15:47.037344 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m00:15:47.072879 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m00:15:47.079844 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:15:47.080978 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m00:15:47.082911 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:15:47.089831 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:15:47.091624 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m00:15:47.093700 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:15:47.097195 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:15:47.098604 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:15:47.099885 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:15:47.105128 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:15:47.111701 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m00:15:47.114039 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:15:47.115425 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m00:15:47.123943 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:15:47.126833 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 00:15:46.986560 => 00:15:47.126492
[0m00:15:47.127894 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m00:15:47.129717 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '95bde720-767f-4770-bac8-f498d1ffec3f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a44881b9070>]}
[0m00:15:47.131519 [info ] [Thread-1 (]: 3 of 5 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.18s]
[0m00:15:47.133099 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m00:15:47.134418 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:15:47.135760 [info ] [Thread-1 (]: 4 of 5 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m00:15:47.137645 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m00:15:47.139081 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:15:47.145630 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:15:47.171989 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 00:15:47.140612 => 00:15:47.171456
[0m00:15:47.174117 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:15:47.180045 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:15:47.207743 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:15:47.209206 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m00:15:47.210500 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:15:47.217535 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:15:47.218680 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:15:47.219960 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m00:15:47.259358 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m00:15:47.264049 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:15:47.265054 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m00:15:47.266543 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:15:47.270919 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:15:47.272033 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m00:15:47.274051 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:15:47.277472 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:15:47.278658 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:15:47.280031 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:15:47.287790 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:15:47.292954 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m00:15:47.294596 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:15:47.295507 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m00:15:47.302417 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:15:47.304836 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 00:15:47.174991 => 00:15:47.304577
[0m00:15:47.306430 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m00:15:47.308605 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '95bde720-767f-4770-bac8-f498d1ffec3f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4488184590>]}
[0m00:15:47.310075 [info ] [Thread-1 (]: 4 of 5 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.17s]
[0m00:15:47.311644 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:15:47.313584 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m00:15:47.314738 [info ] [Thread-1 (]: 5 of 5 START sql table model gold.players_recommendations ...................... [RUN]
[0m00:15:47.316033 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m00:15:47.316981 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m00:15:47.326224 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m00:15:47.351023 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 00:15:47.317706 => 00:15:47.350639
[0m00:15:47.352028 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m00:15:47.359977 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m00:15:47.384998 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:15:47.386061 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m00:15:47.387013 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:15:47.395376 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:15:47.396681 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:15:47.398297 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN (SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."player_stats"
    group by player_id, player_name, team_abbreviation
    ) AS pgs
    ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
    UNION ALL
    
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN (SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) from "nba"."silver"."player_stats"
    GROUP BY player_id, player_name, team_abbreviation) AS pgs
    on p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')
    
    UNION ALL
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')
    UNION ALL
    SELECT
        'Rebotes' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')
    UNION ALL
    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')
    UNION ALL
    SELECT
        'Robos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')
    UNION ALL
    SELECT
        'Bloqueos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    UNION ALL
    SELECT
        'Diferencial Puntos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
     
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    tt.player_id,
    tt.is_free_agent,
    tt.is_injured
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m00:15:47.402878 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column pgs.avg_plus_minus does not exist
LINE 78:         pgs.avg_plus_minus,
                 ^

[0m00:15:47.404178 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m00:15:47.406143 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 00:15:47.352840 => 00:15:47.405346
[0m00:15:47.407855 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m00:15:47.414921 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column pgs.avg_plus_minus does not exist
  LINE 78:         pgs.avg_plus_minus,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m00:15:47.416187 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '95bde720-767f-4770-bac8-f498d1ffec3f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4487d0a990>]}
[0m00:15:47.417449 [error] [Thread-1 (]: 5 of 5 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m00:15:47.418756 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m00:15:47.423278 [debug] [MainThread]: Using postgres connection "master"
[0m00:15:47.424593 [debug] [MainThread]: On master: BEGIN
[0m00:15:47.425663 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m00:15:47.433218 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:15:47.434322 [debug] [MainThread]: On master: COMMIT
[0m00:15:47.435173 [debug] [MainThread]: Using postgres connection "master"
[0m00:15:47.436025 [debug] [MainThread]: On master: COMMIT
[0m00:15:47.437209 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:15:47.438264 [debug] [MainThread]: On master: Close
[0m00:15:47.440614 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:15:47.442176 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m00:15:47.443180 [info ] [MainThread]: 
[0m00:15:47.444105 [info ] [MainThread]: Finished running 5 table models in 0 hours 0 minutes and 1.04 seconds (1.04s).
[0m00:15:47.446458 [debug] [MainThread]: Command end result
[0m00:15:47.504238 [info ] [MainThread]: 
[0m00:15:47.505258 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m00:15:47.506601 [info ] [MainThread]: 
[0m00:15:47.508472 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column pgs.avg_plus_minus does not exist
  LINE 78:         pgs.avg_plus_minus,
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m00:15:47.509640 [info ] [MainThread]: 
[0m00:15:47.510789 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=1 SKIP=0 TOTAL=5
[0m00:15:47.512420 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.21387, "process_user_time": 3.749115, "process_kernel_time": 0.451171, "process_mem_max_rss": "200860", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m00:15:47.513454 [debug] [MainThread]: Command `dbt run` failed at 00:15:47.513266 after 2.21 seconds
[0m00:15:47.514358 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a44881a8230>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a448a193920>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a44889f1010>]}
[0m00:15:47.515278 [debug] [MainThread]: Flushing usage events
[0m00:19:12.298097 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c84f7a1a0f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c84f7a19af0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c84f7a1a360>]}


============================== 00:19:12.303348 | 9d6322e5-e441-427b-a13c-e8c0abbbe5db ==============================
[0m00:19:12.303348 [info ] [MainThread]: Running with dbt=1.7.9
[0m00:19:12.304688 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m00:19:12.594731 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9d6322e5-e441-427b-a13c-e8c0abbbe5db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c84f7a195b0>]}
[0m00:19:12.720465 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9d6322e5-e441-427b-a13c-e8c0abbbe5db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c84f790efc0>]}
[0m00:19:12.721940 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m00:19:12.749348 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m00:19:13.047224 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m00:19:13.048811 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m00:19:13.260867 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m00:19:13.268873 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9d6322e5-e441-427b-a13c-e8c0abbbe5db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c84f6d642c0>]}
[0m00:19:13.344099 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9d6322e5-e441-427b-a13c-e8c0abbbe5db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c84f6dad4c0>]}
[0m00:19:13.345140 [info ] [MainThread]: Found 5 models, 6 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m00:19:13.346202 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9d6322e5-e441-427b-a13c-e8c0abbbe5db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c84f6560680>]}
[0m00:19:13.348965 [info ] [MainThread]: 
[0m00:19:13.350473 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m00:19:13.354157 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m00:19:13.368188 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m00:19:13.369906 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m00:19:13.370867 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:19:13.379374 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m00:19:13.381777 [debug] [ThreadPool]: On list_nba: Close
[0m00:19:13.386444 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m00:19:13.394490 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:19:13.395624 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m00:19:13.396581 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:19:13.404460 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m00:19:13.405507 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:19:13.406305 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m00:19:13.410596 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m00:19:13.413562 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m00:19:13.414847 [debug] [ThreadPool]: On list_nba_gold: Close
[0m00:19:13.423534 [debug] [MainThread]: Using postgres connection "master"
[0m00:19:13.424665 [debug] [MainThread]: On master: BEGIN
[0m00:19:13.425564 [debug] [MainThread]: Opening a new connection, currently in state init
[0m00:19:13.432628 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:19:13.433750 [debug] [MainThread]: Using postgres connection "master"
[0m00:19:13.435228 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m00:19:13.453527 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m00:19:13.456443 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9d6322e5-e441-427b-a13c-e8c0abbbe5db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c84f8156c00>]}
[0m00:19:13.457897 [debug] [MainThread]: On master: ROLLBACK
[0m00:19:13.459545 [debug] [MainThread]: Using postgres connection "master"
[0m00:19:13.460515 [debug] [MainThread]: On master: BEGIN
[0m00:19:13.462511 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:19:13.463879 [debug] [MainThread]: On master: COMMIT
[0m00:19:13.465045 [debug] [MainThread]: Using postgres connection "master"
[0m00:19:13.466278 [debug] [MainThread]: On master: COMMIT
[0m00:19:13.467622 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:19:13.469313 [debug] [MainThread]: On master: Close
[0m00:19:13.470907 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m00:19:13.472287 [info ] [MainThread]: 
[0m00:19:13.476677 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m00:19:13.477870 [info ] [Thread-1 (]: 1 of 5 START sql table model gold.home_vs_away ................................. [RUN]
[0m00:19:13.479726 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m00:19:13.480982 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m00:19:13.493359 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m00:19:13.522694 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 00:19:13.482251 => 00:19:13.522251
[0m00:19:13.523818 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m00:19:13.576261 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m00:19:13.603019 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:19:13.604092 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m00:19:13.605080 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:19:13.611897 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:19:13.613315 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:19:13.614315 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m00:19:13.633972 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m00:19:13.642505 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:19:13.643687 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m00:19:13.645323 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:19:13.649584 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:19:13.650854 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m00:19:13.653628 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:19:13.679550 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:19:13.680727 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:19:13.681772 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:19:13.688060 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:19:13.696880 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m00:19:13.706873 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:19:13.707999 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m00:19:13.715006 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:19:13.718296 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 00:19:13.524700 => 00:19:13.717452
[0m00:19:13.719779 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m00:19:13.721446 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d6322e5-e441-427b-a13c-e8c0abbbe5db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c84f6dadd30>]}
[0m00:19:13.724023 [info ] [Thread-1 (]: 1 of 5 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.24s]
[0m00:19:13.725410 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m00:19:13.726474 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m00:19:13.727544 [info ] [Thread-1 (]: 2 of 5 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m00:19:13.728909 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m00:19:13.729962 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m00:19:13.735919 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m00:19:13.763946 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 00:19:13.730791 => 00:19:13.763546
[0m00:19:13.764969 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m00:19:13.770955 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m00:19:13.797795 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:19:13.798843 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m00:19:13.799846 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:19:13.807896 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:19:13.809054 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:19:13.810161 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m00:19:13.833810 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m00:19:13.838610 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:19:13.839723 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m00:19:13.841322 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:19:13.845776 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:19:13.846872 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m00:19:13.848336 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:19:13.853059 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:19:13.854431 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:19:13.855572 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:19:13.862361 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:19:13.867587 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m00:19:13.869724 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:19:13.870744 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m00:19:13.877787 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:19:13.880408 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 00:19:13.765696 => 00:19:13.880040
[0m00:19:13.881456 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m00:19:13.883037 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d6322e5-e441-427b-a13c-e8c0abbbe5db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c84f61af1d0>]}
[0m00:19:13.884938 [info ] [Thread-1 (]: 2 of 5 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.15s]
[0m00:19:13.889562 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m00:19:13.892745 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m00:19:13.895674 [info ] [Thread-1 (]: 3 of 5 START sql table model gold.summary_by_season ............................ [RUN]
[0m00:19:13.897978 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m00:19:13.899091 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m00:19:13.907841 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m00:19:13.952116 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 00:19:13.900245 => 00:19:13.951473
[0m00:19:13.953486 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m00:19:13.959588 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m00:19:13.992968 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:19:13.993991 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m00:19:13.994918 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:19:14.002000 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:19:14.003167 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:19:14.004327 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m00:19:14.023159 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m00:19:14.027672 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:19:14.028685 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m00:19:14.030145 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:19:14.035618 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:19:14.036875 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m00:19:14.038297 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:19:14.041555 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:19:14.042689 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:19:14.043704 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:19:14.050436 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:19:14.056302 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m00:19:14.058105 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:19:14.062219 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m00:19:14.069531 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:19:14.073409 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 00:19:13.954289 => 00:19:14.073113
[0m00:19:14.074522 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m00:19:14.076358 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d6322e5-e441-427b-a13c-e8c0abbbe5db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c84f61afd40>]}
[0m00:19:14.079079 [info ] [Thread-1 (]: 3 of 5 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.18s]
[0m00:19:14.080852 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m00:19:14.082519 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:19:14.083774 [info ] [Thread-1 (]: 4 of 5 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m00:19:14.086342 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m00:19:14.087670 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:19:14.101565 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:19:14.133311 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 00:19:14.088665 => 00:19:14.132905
[0m00:19:14.134825 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:19:14.141176 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:19:14.166398 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:19:14.167858 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m00:19:14.169329 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:19:14.176338 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:19:14.177508 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:19:14.178695 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_league_fg_pct,
        AVG(fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(tov::numeric) AS avg_league_turnovers,
        AVG(reb::numeric) AS avg_league_rebounds,
        AVG(blk::numeric) AS avg_league_blocks,
        AVG(stl::numeric) AS avg_league_steals,
        AVG(plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games"
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when season like '2024' then '2024-25'
            else season end as season2,
            team_name,
            AVG(fg_pct::numeric) AS avg_fg_pct,
            AVG(fg3_pct::numeric) AS avg_fg3_pct,
            AVG(tov::numeric) AS avg_turnovers,
            AVG(reb::numeric) AS avg_reb,
            AVG(blk::numeric) AS avg_blk,
            AVG(stl::numeric) AS avg_stl,
            AVG(plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games"
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m00:19:14.214813 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m00:19:14.221315 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:19:14.222650 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m00:19:14.224375 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:19:14.229702 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:19:14.232618 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m00:19:14.238180 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:19:14.243715 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:19:14.244750 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:19:14.245756 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:19:14.254430 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:19:14.259002 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m00:19:14.260789 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:19:14.261850 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m00:19:14.269482 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:19:14.272929 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 00:19:14.136427 => 00:19:14.272543
[0m00:19:14.274074 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m00:19:14.276163 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d6322e5-e441-427b-a13c-e8c0abbbe5db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c84f61d2360>]}
[0m00:19:14.277425 [info ] [Thread-1 (]: 4 of 5 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.19s]
[0m00:19:14.278941 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:19:14.280790 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m00:19:14.282028 [info ] [Thread-1 (]: 5 of 5 START sql table model gold.players_recommendations ...................... [RUN]
[0m00:19:14.283577 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m00:19:14.285055 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m00:19:14.292078 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m00:19:14.321605 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 00:19:14.286325 => 00:19:14.321216
[0m00:19:14.322737 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m00:19:14.329716 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m00:19:14.363146 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:19:14.364238 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m00:19:14.365286 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:19:14.376845 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:19:14.379244 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:19:14.381128 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN (SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."player_stats"
    group by player_id, player_name, team_abbreviation
    ) AS pgs
    ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')
    
    UNION ALL
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')
    UNION ALL
    SELECT
        'Rebotes' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')
    UNION ALL
    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')
    UNION ALL
    SELECT
        'Robos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')
    UNION ALL
    SELECT
        'Bloqueos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    UNION ALL
    SELECT
        'Diferencial Puntos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
     
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    tt.player_id,
    tt.is_free_agent,
    tt.is_injured
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m00:19:14.700336 [debug] [Thread-1 (]: SQL status: SELECT 42 in 0.0 seconds
[0m00:19:14.705625 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:19:14.706749 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m00:19:14.708353 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:19:14.713562 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:19:14.714675 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m00:19:14.716317 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:19:14.720230 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m00:19:14.721376 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:19:14.722533 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m00:19:14.728425 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:19:14.733493 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m00:19:14.736509 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:19:14.738354 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m00:19:14.744984 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:19:14.747610 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 00:19:14.323778 => 00:19:14.747213
[0m00:19:14.748683 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m00:19:14.750237 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d6322e5-e441-427b-a13c-e8c0abbbe5db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c84f61e33e0>]}
[0m00:19:14.752150 [info ] [Thread-1 (]: 5 of 5 OK created sql table model gold.players_recommendations ................. [[32mSELECT 42[0m in 0.47s]
[0m00:19:14.753974 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m00:19:14.757448 [debug] [MainThread]: Using postgres connection "master"
[0m00:19:14.758563 [debug] [MainThread]: On master: BEGIN
[0m00:19:14.759603 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m00:19:14.767056 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:19:14.768922 [debug] [MainThread]: On master: COMMIT
[0m00:19:14.769935 [debug] [MainThread]: Using postgres connection "master"
[0m00:19:14.770924 [debug] [MainThread]: On master: COMMIT
[0m00:19:14.772526 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:19:14.773878 [debug] [MainThread]: On master: Close
[0m00:19:14.775452 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:19:14.776423 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m00:19:14.777435 [info ] [MainThread]: 
[0m00:19:14.778389 [info ] [MainThread]: Finished running 5 table models in 0 hours 0 minutes and 1.43 seconds (1.43s).
[0m00:19:14.780414 [debug] [MainThread]: Command end result
[0m00:19:14.851878 [info ] [MainThread]: 
[0m00:19:14.853733 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:19:14.854952 [info ] [MainThread]: 
[0m00:19:14.855997 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=0 SKIP=0 TOTAL=5
[0m00:19:14.857536 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.648606, "process_user_time": 3.785716, "process_kernel_time": 0.396791, "process_mem_max_rss": "200864", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m00:19:14.858605 [debug] [MainThread]: Command `dbt run` succeeded at 00:19:14.858434 after 2.65 seconds
[0m00:19:14.859693 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c84f8094800>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c84f61fbef0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c84f61d2360>]}
[0m00:19:14.860620 [debug] [MainThread]: Flushing usage events
[0m00:33:25.817738 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c4e0f5cd190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c4e0f5cf050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c4e0f5cd1f0>]}


============================== 00:33:25.822736 | ae8cdc57-f5bd-4693-8631-c93665b872f0 ==============================
[0m00:33:25.822736 [info ] [MainThread]: Running with dbt=1.7.9
[0m00:33:25.823859 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m00:33:26.109591 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ae8cdc57-f5bd-4693-8631-c93665b872f0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c4e0f42db20>]}
[0m00:33:26.231440 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ae8cdc57-f5bd-4693-8631-c93665b872f0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c4e1052d670>]}
[0m00:33:26.233185 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m00:33:26.260594 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m00:33:26.548984 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m00:33:26.550503 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/team_weaknesses_unpivoted.sql
[0m00:33:26.962375 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m00:33:26.974189 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ae8cdc57-f5bd-4693-8631-c93665b872f0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c4e0ddf0e30>]}
[0m00:33:27.045630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ae8cdc57-f5bd-4693-8631-c93665b872f0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c4e0e5a8c80>]}
[0m00:33:27.046958 [info ] [MainThread]: Found 5 models, 6 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m00:33:27.048254 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ae8cdc57-f5bd-4693-8631-c93665b872f0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c4e0d90fc50>]}
[0m00:33:27.051341 [info ] [MainThread]: 
[0m00:33:27.053450 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m00:33:27.056128 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m00:33:27.070875 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m00:33:27.072017 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m00:33:27.073014 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:33:27.083267 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m00:33:27.086558 [debug] [ThreadPool]: On list_nba: Close
[0m00:33:27.090191 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m00:33:27.098444 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:33:27.099497 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m00:33:27.100394 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:33:27.108136 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m00:33:27.109265 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:33:27.110410 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m00:33:27.115815 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m00:33:27.118058 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m00:33:27.120226 [debug] [ThreadPool]: On list_nba_gold: Close
[0m00:33:27.128106 [debug] [MainThread]: Using postgres connection "master"
[0m00:33:27.129194 [debug] [MainThread]: On master: BEGIN
[0m00:33:27.130365 [debug] [MainThread]: Opening a new connection, currently in state init
[0m00:33:27.140664 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:33:27.142009 [debug] [MainThread]: Using postgres connection "master"
[0m00:33:27.143137 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m00:33:27.164466 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m00:33:27.166832 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ae8cdc57-f5bd-4693-8631-c93665b872f0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c4e0e5fc5c0>]}
[0m00:33:27.167915 [debug] [MainThread]: On master: ROLLBACK
[0m00:33:27.169858 [debug] [MainThread]: Using postgres connection "master"
[0m00:33:27.171023 [debug] [MainThread]: On master: BEGIN
[0m00:33:27.172666 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:33:27.174054 [debug] [MainThread]: On master: COMMIT
[0m00:33:27.175173 [debug] [MainThread]: Using postgres connection "master"
[0m00:33:27.176095 [debug] [MainThread]: On master: COMMIT
[0m00:33:27.177366 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:33:27.178342 [debug] [MainThread]: On master: Close
[0m00:33:27.179802 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m00:33:27.180863 [info ] [MainThread]: 
[0m00:33:27.185881 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m00:33:27.187446 [info ] [Thread-1 (]: 1 of 5 START sql table model gold.home_vs_away ................................. [RUN]
[0m00:33:27.189121 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m00:33:27.190451 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m00:33:27.200830 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m00:33:27.225836 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 00:33:27.191360 => 00:33:27.225420
[0m00:33:27.226925 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m00:33:27.277592 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m00:33:27.307579 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:33:27.308766 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m00:33:27.309815 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:33:27.317712 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:33:27.319401 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:33:27.320550 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m00:33:27.338537 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m00:33:27.346907 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:33:27.348013 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m00:33:27.349639 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:33:27.355310 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:33:27.356355 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m00:33:27.358460 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:33:27.385303 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:33:27.387035 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:33:27.388045 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:33:27.394498 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:33:27.403527 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m00:33:27.411471 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:33:27.412598 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m00:33:27.421020 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:33:27.424227 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 00:33:27.227664 => 00:33:27.423847
[0m00:33:27.425311 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m00:33:27.427316 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ae8cdc57-f5bd-4693-8631-c93665b872f0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c4e0d585790>]}
[0m00:33:27.430413 [info ] [Thread-1 (]: 1 of 5 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.24s]
[0m00:33:27.432227 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m00:33:27.433788 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m00:33:27.435792 [info ] [Thread-1 (]: 2 of 5 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m00:33:27.437939 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m00:33:27.439275 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m00:33:27.445255 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m00:33:27.470789 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 00:33:27.440138 => 00:33:27.470391
[0m00:33:27.471835 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m00:33:27.479567 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m00:33:27.507032 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:33:27.508135 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m00:33:27.509053 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:33:27.516810 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:33:27.517749 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:33:27.519531 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m00:33:27.537594 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m00:33:27.542000 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:33:27.543450 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m00:33:27.545312 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:33:27.549633 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:33:27.550740 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m00:33:27.553607 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:33:27.559936 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:33:27.561885 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:33:27.563775 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:33:27.570997 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:33:27.578987 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m00:33:27.581819 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:33:27.583280 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m00:33:27.590321 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:33:27.593072 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 00:33:27.472688 => 00:33:27.592674
[0m00:33:27.594340 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m00:33:27.596277 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ae8cdc57-f5bd-4693-8631-c93665b872f0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c4e0c139460>]}
[0m00:33:27.598790 [info ] [Thread-1 (]: 2 of 5 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.16s]
[0m00:33:27.600368 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m00:33:27.602014 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m00:33:27.603896 [info ] [Thread-1 (]: 3 of 5 START sql table model gold.summary_by_season ............................ [RUN]
[0m00:33:27.605440 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m00:33:27.606620 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m00:33:27.611258 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m00:33:27.641571 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 00:33:27.607404 => 00:33:27.641133
[0m00:33:27.642821 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m00:33:27.648421 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m00:33:27.675204 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:33:27.676195 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m00:33:27.677139 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:33:27.683948 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:33:27.685329 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:33:27.686756 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m00:33:27.705852 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m00:33:27.710362 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:33:27.711418 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m00:33:27.712990 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:33:27.718057 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:33:27.719503 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m00:33:27.721185 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:33:27.724190 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:33:27.725318 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:33:27.726303 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:33:27.732482 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:33:27.737730 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m00:33:27.739350 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:33:27.740384 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m00:33:27.747630 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:33:27.750019 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 00:33:27.643722 => 00:33:27.749749
[0m00:33:27.751194 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m00:33:27.753620 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ae8cdc57-f5bd-4693-8631-c93665b872f0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c4e0c13b3b0>]}
[0m00:33:27.755216 [info ] [Thread-1 (]: 3 of 5 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.15s]
[0m00:33:27.756613 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m00:33:27.757698 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:33:27.758765 [info ] [Thread-1 (]: 4 of 5 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m00:33:27.760217 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m00:33:27.761208 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:33:27.767474 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:33:27.794451 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 00:33:27.762082 => 00:33:27.793921
[0m00:33:27.795484 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:33:27.801091 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:33:27.827799 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:33:27.828894 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m00:33:27.829820 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:33:27.838454 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:33:27.839544 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:33:27.840779 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when t1.season like '2024' then '2024-25'
            else t1.season end as season2,
        AVG(t1.fg_pct::numeric) AS avg_league_fg_pct,
        AVG(t1.fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(t1.tov::numeric) AS avg_league_turnovers,
        AVG(t1.reb::numeric) AS avg_league_rebounds,
        AVG(t1.blk::numeric) AS avg_league_blocks,
        AVG(t1.stl::numeric) AS avg_league_steals,
        AVG(t1.plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games" t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when t1.season like '2024' then '2024-25'
            else t1.season end as season2,
            t1.team_name,
            AVG(t1.fg_pct::numeric) AS avg_fg_pct,
            AVG(t1.fg3_pct::numeric) AS avg_fg3_pct,
            AVG(t1.tov::numeric) AS avg_turnovers,
            AVG(t1.reb::numeric) AS avg_reb,
            AVG(t1.blk::numeric) AS avg_blk,
            AVG(t1.stl::numeric) AS avg_stl,
            AVG(t1.plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games" t1
        INNER JOIN "nba"."silver"."teams" AS t2
            ON t1.team_id = t2.id
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m00:33:27.874457 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m00:33:27.879656 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:33:27.880913 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m00:33:27.882966 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:33:27.892953 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:33:27.894757 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m00:33:27.896833 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:33:27.901156 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:33:27.903023 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:33:27.904237 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:33:27.910456 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:33:27.915299 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m00:33:27.917065 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:33:27.918602 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m00:33:27.926254 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:33:27.928866 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 00:33:27.796288 => 00:33:27.928586
[0m00:33:27.929954 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m00:33:27.931930 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ae8cdc57-f5bd-4693-8631-c93665b872f0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c4e0c163350>]}
[0m00:33:27.933699 [info ] [Thread-1 (]: 4 of 5 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.17s]
[0m00:33:27.935985 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:33:27.938117 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m00:33:27.939315 [info ] [Thread-1 (]: 5 of 5 START sql table model gold.players_recommendations ...................... [RUN]
[0m00:33:27.940640 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m00:33:27.941621 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m00:33:27.947947 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m00:33:27.976050 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 00:33:27.942372 => 00:33:27.975663
[0m00:33:27.977082 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m00:33:27.983328 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m00:33:28.012837 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:33:28.014404 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m00:33:28.015940 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:33:28.024915 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:33:28.026434 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:33:28.027964 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),


ranked_free_agents AS (
    SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM "nba"."silver"."players" AS p
    JOIN (SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."player_stats"
    group by player_id, player_name, team_abbreviation
    ) AS pgs
    ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents" AS fa ON p.player_id = fa.player_id
    LEFT JOIN "nba"."silver"."injuries" AS i ON p.player_id = i.player_id
    LEFT JOIN "nba"."silver"."salaries" AS s ON p.player_id = s.player_id
    
       
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')
    
    UNION ALL
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')
    UNION ALL
    SELECT
        'Rebotes' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')
    UNION ALL
    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')
    UNION ALL
    SELECT
        'Robos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')
    UNION ALL
    SELECT
        'Bloqueos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    UNION ALL
    SELECT
        'Diferencial Puntos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
     
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    tt.player_id,
    tt.is_free_agent,
    tt.is_injured
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m00:33:28.240625 [debug] [Thread-1 (]: SQL status: SELECT 51 in 0.0 seconds
[0m00:33:28.246041 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:33:28.247590 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m00:33:28.249147 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:33:28.255833 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:33:28.256885 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m00:33:28.258838 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:33:28.263299 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m00:33:28.264519 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:33:28.265735 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m00:33:28.271471 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:33:28.277994 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m00:33:28.279705 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:33:28.280757 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m00:33:28.287425 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:33:28.291393 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 00:33:27.977957 => 00:33:28.290722
[0m00:33:28.292949 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m00:33:28.295433 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ae8cdc57-f5bd-4693-8631-c93665b872f0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c4e0c10bc50>]}
[0m00:33:28.296876 [info ] [Thread-1 (]: 5 of 5 OK created sql table model gold.players_recommendations ................. [[32mSELECT 51[0m in 0.36s]
[0m00:33:28.299000 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m00:33:28.303687 [debug] [MainThread]: Using postgres connection "master"
[0m00:33:28.304955 [debug] [MainThread]: On master: BEGIN
[0m00:33:28.307293 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m00:33:28.317929 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:33:28.319738 [debug] [MainThread]: On master: COMMIT
[0m00:33:28.322553 [debug] [MainThread]: Using postgres connection "master"
[0m00:33:28.323838 [debug] [MainThread]: On master: COMMIT
[0m00:33:28.325392 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:33:28.326479 [debug] [MainThread]: On master: Close
[0m00:33:28.328367 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:33:28.330521 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m00:33:28.331970 [info ] [MainThread]: 
[0m00:33:28.333202 [info ] [MainThread]: Finished running 5 table models in 0 hours 0 minutes and 1.28 seconds (1.28s).
[0m00:33:28.339235 [debug] [MainThread]: Command end result
[0m00:33:28.404549 [info ] [MainThread]: 
[0m00:33:28.405559 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:33:28.406468 [info ] [MainThread]: 
[0m00:33:28.407378 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=0 SKIP=0 TOTAL=5
[0m00:33:28.409020 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.6788104, "process_user_time": 4.005487, "process_kernel_time": 0.356132, "process_mem_max_rss": "200868", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m00:33:28.409998 [debug] [MainThread]: Command `dbt run` succeeded at 00:33:28.409808 after 2.68 seconds
[0m00:33:28.410918 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c4e13f5af60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c4e0f5cf050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c4e0c157c20>]}
[0m00:33:28.411734 [debug] [MainThread]: Flushing usage events
[0m01:13:33.816607 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c7086268fb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c708626b8c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c70862690d0>]}


============================== 01:13:33.821694 | b322bbba-c19f-4d83-a205-0a1dcd7151a4 ==============================
[0m01:13:33.821694 [info ] [MainThread]: Running with dbt=1.7.9
[0m01:13:33.822897 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m01:13:34.177691 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b322bbba-c19f-4d83-a205-0a1dcd7151a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c70860ca000>]}
[0m01:13:34.301993 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b322bbba-c19f-4d83-a205-0a1dcd7151a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c708667adb0>]}
[0m01:13:34.303562 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m01:13:34.330846 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m01:13:34.657251 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m01:13:34.658600 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m01:13:34.866181 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m01:13:34.873302 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b322bbba-c19f-4d83-a205-0a1dcd7151a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c7084dff9e0>]}
[0m01:13:34.943294 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b322bbba-c19f-4d83-a205-0a1dcd7151a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c70855a9460>]}
[0m01:13:34.944441 [info ] [MainThread]: Found 5 models, 6 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m01:13:34.945801 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b322bbba-c19f-4d83-a205-0a1dcd7151a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c708618a390>]}
[0m01:13:34.949934 [info ] [MainThread]: 
[0m01:13:34.951439 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m01:13:34.954285 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m01:13:34.969188 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m01:13:34.970294 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m01:13:34.971247 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:13:34.985001 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m01:13:34.987199 [debug] [ThreadPool]: On list_nba: Close
[0m01:13:34.990181 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m01:13:34.999967 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m01:13:35.001097 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m01:13:35.002046 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m01:13:35.010559 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m01:13:35.011607 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m01:13:35.012608 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m01:13:35.020879 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m01:13:35.023788 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m01:13:35.025289 [debug] [ThreadPool]: On list_nba_gold: Close
[0m01:13:35.036067 [debug] [MainThread]: Using postgres connection "master"
[0m01:13:35.037290 [debug] [MainThread]: On master: BEGIN
[0m01:13:35.039434 [debug] [MainThread]: Opening a new connection, currently in state init
[0m01:13:35.050598 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m01:13:35.052259 [debug] [MainThread]: Using postgres connection "master"
[0m01:13:35.053982 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m01:13:35.078362 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m01:13:35.080413 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b322bbba-c19f-4d83-a205-0a1dcd7151a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c7084d0f5f0>]}
[0m01:13:35.082173 [debug] [MainThread]: On master: ROLLBACK
[0m01:13:35.083553 [debug] [MainThread]: Using postgres connection "master"
[0m01:13:35.084524 [debug] [MainThread]: On master: BEGIN
[0m01:13:35.086379 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m01:13:35.087630 [debug] [MainThread]: On master: COMMIT
[0m01:13:35.088847 [debug] [MainThread]: Using postgres connection "master"
[0m01:13:35.089833 [debug] [MainThread]: On master: COMMIT
[0m01:13:35.091184 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m01:13:35.092147 [debug] [MainThread]: On master: Close
[0m01:13:35.093718 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m01:13:35.094773 [info ] [MainThread]: 
[0m01:13:35.100471 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m01:13:35.101957 [info ] [Thread-1 (]: 1 of 5 START sql table model gold.home_vs_away ................................. [RUN]
[0m01:13:35.103676 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m01:13:35.104836 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m01:13:35.116465 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m01:13:35.142970 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 01:13:35.105682 => 01:13:35.142584
[0m01:13:35.143976 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m01:13:35.203537 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m01:13:35.232906 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m01:13:35.234265 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m01:13:35.235413 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m01:13:35.242651 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m01:13:35.243687 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m01:13:35.244653 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m01:13:35.280532 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m01:13:35.290999 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m01:13:35.292005 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m01:13:35.294143 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:13:35.299659 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m01:13:35.300721 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m01:13:35.302172 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:13:35.328538 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m01:13:35.329646 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m01:13:35.330667 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m01:13:35.340929 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m01:13:35.351372 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m01:13:35.359952 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m01:13:35.361073 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m01:13:35.371166 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m01:13:35.373857 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 01:13:35.144615 => 01:13:35.373401
[0m01:13:35.375241 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m01:13:35.376999 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b322bbba-c19f-4d83-a205-0a1dcd7151a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c7086294740>]}
[0m01:13:35.378392 [info ] [Thread-1 (]: 1 of 5 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.27s]
[0m01:13:35.379819 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m01:13:35.381416 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m01:13:35.383177 [info ] [Thread-1 (]: 2 of 5 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m01:13:35.384846 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m01:13:35.385920 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m01:13:35.390638 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m01:13:35.420796 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 01:13:35.386732 => 01:13:35.420406
[0m01:13:35.421851 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m01:13:35.428042 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m01:13:35.455529 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m01:13:35.456583 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m01:13:35.457519 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m01:13:35.464626 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m01:13:35.466222 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m01:13:35.467332 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m01:13:35.486399 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m01:13:35.492154 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m01:13:35.493290 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m01:13:35.495300 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:13:35.501706 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m01:13:35.503045 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m01:13:35.504671 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:13:35.508274 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m01:13:35.509402 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m01:13:35.510551 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m01:13:35.516889 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m01:13:35.523422 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m01:13:35.525610 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m01:13:35.526886 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m01:13:35.535636 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m01:13:35.538781 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 01:13:35.422642 => 01:13:35.538492
[0m01:13:35.539785 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m01:13:35.541571 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b322bbba-c19f-4d83-a205-0a1dcd7151a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c70849b1c10>]}
[0m01:13:35.543095 [info ] [Thread-1 (]: 2 of 5 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.16s]
[0m01:13:35.544771 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m01:13:35.545871 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m01:13:35.547325 [info ] [Thread-1 (]: 3 of 5 START sql table model gold.summary_by_season ............................ [RUN]
[0m01:13:35.549751 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m01:13:35.551290 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m01:13:35.557092 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m01:13:35.586849 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 01:13:35.552185 => 01:13:35.586055
[0m01:13:35.588192 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m01:13:35.594404 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m01:13:35.622671 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m01:13:35.624000 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m01:13:35.625495 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m01:13:35.634425 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m01:13:35.636316 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m01:13:35.638015 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m01:13:35.657802 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m01:13:35.662555 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m01:13:35.663822 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m01:13:35.666634 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:13:35.671431 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m01:13:35.672476 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m01:13:35.674179 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:13:35.677605 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m01:13:35.678626 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m01:13:35.679738 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m01:13:35.686346 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m01:13:35.690362 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m01:13:35.691921 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m01:13:35.692812 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m01:13:35.700240 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m01:13:35.702731 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 01:13:35.588972 => 01:13:35.702455
[0m01:13:35.703848 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m01:13:35.705553 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b322bbba-c19f-4d83-a205-0a1dcd7151a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c70849b3ef0>]}
[0m01:13:35.706846 [info ] [Thread-1 (]: 3 of 5 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.16s]
[0m01:13:35.708294 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m01:13:35.709301 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m01:13:35.710501 [info ] [Thread-1 (]: 4 of 5 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m01:13:35.712131 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m01:13:35.713027 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m01:13:35.720870 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m01:13:35.746229 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 01:13:35.714116 => 01:13:35.745673
[0m01:13:35.747474 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m01:13:35.754954 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m01:13:35.783773 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m01:13:35.784819 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m01:13:35.785831 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m01:13:35.793194 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m01:13:35.794369 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m01:13:35.795575 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when t1.season like '2024' then '2024-25'
            else t1.season end as season2,
        AVG(t1.fg_pct::numeric) AS avg_league_fg_pct,
        AVG(t1.fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(t1.tov::numeric) AS avg_league_turnovers,
        AVG(t1.reb::numeric) AS avg_league_rebounds,
        AVG(t1.blk::numeric) AS avg_league_blocks,
        AVG(t1.stl::numeric) AS avg_league_steals,
        AVG(t1.plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games" t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when t1.season like '2024' then '2024-25'
            else t1.season end as season2,
            t1.team_name,
            AVG(t1.fg_pct::numeric) AS avg_fg_pct,
            AVG(t1.fg3_pct::numeric) AS avg_fg3_pct,
            AVG(t1.tov::numeric) AS avg_turnovers,
            AVG(t1.reb::numeric) AS avg_reb,
            AVG(t1.blk::numeric) AS avg_blk,
            AVG(t1.stl::numeric) AS avg_stl,
            AVG(t1.plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games" t1
        INNER JOIN "nba"."silver"."teams" AS t2
            ON t1.team_id = t2.id
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m01:13:35.827312 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m01:13:35.832791 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m01:13:35.833893 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m01:13:35.835896 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:13:35.840627 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m01:13:35.841774 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m01:13:35.843192 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:13:35.846189 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m01:13:35.847453 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m01:13:35.849067 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m01:13:35.855021 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m01:13:35.859315 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m01:13:35.860752 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m01:13:35.861829 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m01:13:35.868714 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m01:13:35.871308 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 01:13:35.749220 => 01:13:35.871029
[0m01:13:35.872365 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m01:13:35.873927 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b322bbba-c19f-4d83-a205-0a1dcd7151a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c70849b0800>]}
[0m01:13:35.875161 [info ] [Thread-1 (]: 4 of 5 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.16s]
[0m01:13:35.876568 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m01:13:35.878367 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m01:13:35.879396 [info ] [Thread-1 (]: 5 of 5 START sql table model gold.players_recommendations ...................... [RUN]
[0m01:13:35.881163 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m01:13:35.882426 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m01:13:35.888995 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m01:13:35.915624 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 01:13:35.883151 => 01:13:35.915218
[0m01:13:35.916829 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m01:13:35.924950 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m01:13:35.954741 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m01:13:35.956319 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m01:13:35.957277 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m01:13:35.964537 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m01:13:35.966032 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m01:13:35.967324 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

ranked_free_agents AS (
  SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (PARTITION BY p.position ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM (select distinct player_id,player,position from "nba"."silver"."players") AS p
    JOIN (SELECT
    player_id,
    player_name,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."player_stats" 
	group by player_id, player_name
    ) AS pgs
    ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents"  AS fa ON p.player_id = fa.player_id
    LEFT JOIN (Select player_id from "nba"."silver"."injuries"  group by player_id) 
	AS i ON p.player_id = i.player_id
    LEFT JOIN (select player_id,max(salary_usd) as salary_usd from "nba"."silver"."salaries" group by player_id) AS s ON p.player_id = s.player_id
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')
    
    UNION ALL
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')
    UNION ALL
    SELECT
        'Rebotes' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')
    UNION ALL
    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')
    UNION ALL
    SELECT
        'Robos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')
    UNION ALL
    SELECT
        'Bloqueos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    UNION ALL
    SELECT
        'Diferencial Puntos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
     
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    tt.player_id,
    tt.is_free_agent,
    tt.is_injured
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m01:13:36.122682 [debug] [Thread-1 (]: SQL status: SELECT 51 in 0.0 seconds
[0m01:13:36.127215 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m01:13:36.128365 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m01:13:36.130020 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:13:36.135874 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m01:13:36.136958 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m01:13:36.138580 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:13:36.141410 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m01:13:36.142581 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m01:13:36.143469 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m01:13:36.149225 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m01:13:36.152951 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m01:13:36.154318 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m01:13:36.155522 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m01:13:36.163166 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m01:13:36.166510 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 01:13:35.918110 => 01:13:36.166220
[0m01:13:36.167516 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m01:13:36.169015 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b322bbba-c19f-4d83-a205-0a1dcd7151a4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c7084501f10>]}
[0m01:13:36.170287 [info ] [Thread-1 (]: 5 of 5 OK created sql table model gold.players_recommendations ................. [[32mSELECT 51[0m in 0.29s]
[0m01:13:36.171784 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m01:13:36.175013 [debug] [MainThread]: Using postgres connection "master"
[0m01:13:36.176004 [debug] [MainThread]: On master: BEGIN
[0m01:13:36.176855 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m01:13:36.184463 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m01:13:36.185541 [debug] [MainThread]: On master: COMMIT
[0m01:13:36.186400 [debug] [MainThread]: Using postgres connection "master"
[0m01:13:36.187145 [debug] [MainThread]: On master: COMMIT
[0m01:13:36.188264 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m01:13:36.189042 [debug] [MainThread]: On master: Close
[0m01:13:36.190478 [debug] [MainThread]: Connection 'master' was properly closed.
[0m01:13:36.191358 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m01:13:36.192341 [info ] [MainThread]: 
[0m01:13:36.193550 [info ] [MainThread]: Finished running 5 table models in 0 hours 0 minutes and 1.24 seconds (1.24s).
[0m01:13:36.196573 [debug] [MainThread]: Command end result
[0m01:13:36.255874 [info ] [MainThread]: 
[0m01:13:36.257010 [info ] [MainThread]: [32mCompleted successfully[0m
[0m01:13:36.258160 [info ] [MainThread]: 
[0m01:13:36.259113 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=0 SKIP=0 TOTAL=5
[0m01:13:36.261245 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.5402424, "process_user_time": 3.815952, "process_kernel_time": 0.968106, "process_mem_max_rss": "200856", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m01:13:36.262409 [debug] [MainThread]: Command `dbt run` succeeded at 01:13:36.262224 after 2.54 seconds
[0m01:13:36.263323 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c7086268fb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c70862690d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c7084d0f5f0>]}
[0m01:13:36.265193 [debug] [MainThread]: Flushing usage events
[0m01:46:37.897311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x772b442f20c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x772b442f1c40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x772b442f2390>]}


============================== 01:46:37.902020 | 9aaa8631-53e1-43f1-a2f0-8b245b64b7d8 ==============================
[0m01:46:37.902020 [info ] [MainThread]: Running with dbt=1.7.9
[0m01:46:37.903394 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/usr/local/airflow/dbt/logs', 'debug': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m01:46:38.239419 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9aaa8631-53e1-43f1-a2f0-8b245b64b7d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x772b446c1a90>]}
[0m01:46:38.437468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9aaa8631-53e1-43f1-a2f0-8b245b64b7d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x772b44a0a060>]}
[0m01:46:38.441995 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m01:46:38.599865 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m01:46:39.166719 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m01:46:39.168189 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m01:46:39.442081 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m01:46:39.455562 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9aaa8631-53e1-43f1-a2f0-8b245b64b7d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x772b42bffc50>]}
[0m01:46:39.543806 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9aaa8631-53e1-43f1-a2f0-8b245b64b7d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x772b43368d70>]}
[0m01:46:39.548473 [info ] [MainThread]: Found 5 models, 6 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m01:46:39.550604 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9aaa8631-53e1-43f1-a2f0-8b245b64b7d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x772b4431e960>]}
[0m01:46:39.554171 [info ] [MainThread]: 
[0m01:46:39.556929 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m01:46:39.562355 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m01:46:39.590122 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m01:46:39.600027 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m01:46:39.601510 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:46:39.616131 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m01:46:39.619435 [debug] [ThreadPool]: On list_nba: Close
[0m01:46:39.623358 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m01:46:39.635246 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m01:46:39.636264 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m01:46:39.637188 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m01:46:39.647769 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m01:46:39.649160 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m01:46:39.650428 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m01:46:39.656105 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m01:46:39.658204 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m01:46:39.659281 [debug] [ThreadPool]: On list_nba_gold: Close
[0m01:46:39.671531 [debug] [MainThread]: Using postgres connection "master"
[0m01:46:39.672477 [debug] [MainThread]: On master: BEGIN
[0m01:46:39.673175 [debug] [MainThread]: Opening a new connection, currently in state init
[0m01:46:39.682549 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m01:46:39.683567 [debug] [MainThread]: Using postgres connection "master"
[0m01:46:39.684669 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m01:46:39.708010 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m01:46:39.710856 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9aaa8631-53e1-43f1-a2f0-8b245b64b7d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x772b442f2360>]}
[0m01:46:39.713383 [debug] [MainThread]: On master: ROLLBACK
[0m01:46:39.715283 [debug] [MainThread]: Using postgres connection "master"
[0m01:46:39.716389 [debug] [MainThread]: On master: BEGIN
[0m01:46:39.719051 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m01:46:39.720238 [debug] [MainThread]: On master: COMMIT
[0m01:46:39.721085 [debug] [MainThread]: Using postgres connection "master"
[0m01:46:39.722130 [debug] [MainThread]: On master: COMMIT
[0m01:46:39.723264 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m01:46:39.724123 [debug] [MainThread]: On master: Close
[0m01:46:39.725666 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m01:46:39.727413 [info ] [MainThread]: 
[0m01:46:39.734866 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m01:46:39.736269 [info ] [Thread-1 (]: 1 of 5 START sql table model gold.home_vs_away ................................. [RUN]
[0m01:46:39.737899 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m01:46:39.738829 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m01:46:39.755521 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m01:46:39.777267 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 01:46:39.739660 => 01:46:39.776778
[0m01:46:39.778933 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m01:46:39.860280 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m01:46:39.888247 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m01:46:39.889204 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m01:46:39.890214 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m01:46:39.900212 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m01:46:39.901507 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m01:46:39.902766 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m01:46:39.931508 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m01:46:39.942469 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m01:46:39.944276 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m01:46:39.948138 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:46:39.956065 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m01:46:39.957470 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m01:46:39.958867 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:46:40.006016 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m01:46:40.007060 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m01:46:40.007959 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m01:46:40.019759 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m01:46:40.031566 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m01:46:40.039980 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m01:46:40.040961 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m01:46:40.057011 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m01:46:40.060261 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 01:46:39.780335 => 01:46:40.059872
[0m01:46:40.061733 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m01:46:40.065184 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9aaa8631-53e1-43f1-a2f0-8b245b64b7d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x772b437660c0>]}
[0m01:46:40.066535 [info ] [Thread-1 (]: 1 of 5 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.33s]
[0m01:46:40.068409 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m01:46:40.070082 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m01:46:40.071767 [info ] [Thread-1 (]: 2 of 5 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m01:46:40.074481 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.streaks_and_rivals)
[0m01:46:40.075785 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m01:46:40.084580 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m01:46:40.109156 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 01:46:40.077194 => 01:46:40.108759
[0m01:46:40.110599 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m01:46:40.119108 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m01:46:40.140072 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m01:46:40.140880 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m01:46:40.141710 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m01:46:40.150731 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m01:46:40.151910 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m01:46:40.152877 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m01:46:40.173574 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m01:46:40.180972 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m01:46:40.182319 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m01:46:40.183939 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:46:40.188271 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m01:46:40.189240 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m01:46:40.190522 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:46:40.195410 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m01:46:40.198445 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m01:46:40.199997 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m01:46:40.207916 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m01:46:40.217075 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m01:46:40.218569 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m01:46:40.219512 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m01:46:40.226845 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m01:46:40.233592 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 01:46:40.112296 => 01:46:40.232828
[0m01:46:40.235189 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m01:46:40.237271 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9aaa8631-53e1-43f1-a2f0-8b245b64b7d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x772b4276d040>]}
[0m01:46:40.238822 [info ] [Thread-1 (]: 2 of 5 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.16s]
[0m01:46:40.240378 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m01:46:40.241520 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m01:46:40.242891 [info ] [Thread-1 (]: 3 of 5 START sql table model gold.summary_by_season ............................ [RUN]
[0m01:46:40.246927 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m01:46:40.248906 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m01:46:40.254348 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m01:46:40.284568 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 01:46:40.250111 => 01:46:40.283409
[0m01:46:40.286435 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m01:46:40.296829 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m01:46:40.324378 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m01:46:40.325619 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m01:46:40.327331 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m01:46:40.338789 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m01:46:40.340167 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m01:46:40.341568 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m01:46:40.369981 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m01:46:40.374598 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m01:46:40.375759 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m01:46:40.378416 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:46:40.384693 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m01:46:40.385711 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m01:46:40.387060 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:46:40.390206 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m01:46:40.391587 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m01:46:40.392808 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m01:46:40.400851 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m01:46:40.405991 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m01:46:40.407655 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m01:46:40.408606 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m01:46:40.416704 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m01:46:40.419150 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 01:46:40.287742 => 01:46:40.418802
[0m01:46:40.420102 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m01:46:40.421607 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9aaa8631-53e1-43f1-a2f0-8b245b64b7d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x772b4276fb30>]}
[0m01:46:40.422854 [info ] [Thread-1 (]: 3 of 5 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.18s]
[0m01:46:40.424191 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m01:46:40.425256 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m01:46:40.426426 [info ] [Thread-1 (]: 4 of 5 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m01:46:40.430309 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m01:46:40.432000 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m01:46:40.438312 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m01:46:40.469621 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 01:46:40.432793 => 01:46:40.469173
[0m01:46:40.470603 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m01:46:40.476202 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m01:46:40.506148 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m01:46:40.507288 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m01:46:40.508281 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m01:46:40.517696 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m01:46:40.518647 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m01:46:40.519949 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when t1.season like '2024' then '2024-25'
            else t1.season end as season2,
        AVG(t1.fg_pct::numeric) AS avg_league_fg_pct,
        AVG(t1.fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(t1.tov::numeric) AS avg_league_turnovers,
        AVG(t1.reb::numeric) AS avg_league_rebounds,
        AVG(t1.blk::numeric) AS avg_league_blocks,
        AVG(t1.stl::numeric) AS avg_league_steals,
        AVG(t1.plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games" t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when t1.season like '2024' then '2024-25'
            else t1.season end as season2,
            t1.team_name,
            AVG(t1.fg_pct::numeric) AS avg_fg_pct,
            AVG(t1.fg3_pct::numeric) AS avg_fg3_pct,
            AVG(t1.tov::numeric) AS avg_turnovers,
            AVG(t1.reb::numeric) AS avg_reb,
            AVG(t1.blk::numeric) AS avg_blk,
            AVG(t1.stl::numeric) AS avg_stl,
            AVG(t1.plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games" t1
        INNER JOIN "nba"."silver"."teams" AS t2
            ON t1.team_id = t2.id
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m01:46:40.553605 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m01:46:40.558109 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m01:46:40.559263 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m01:46:40.561745 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:46:40.567861 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m01:46:40.569010 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m01:46:40.570484 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:46:40.573459 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m01:46:40.574469 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m01:46:40.575337 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m01:46:40.583019 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m01:46:40.588579 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m01:46:40.590292 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m01:46:40.591350 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m01:46:40.599844 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m01:46:40.603433 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 01:46:40.471364 => 01:46:40.603036
[0m01:46:40.604582 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m01:46:40.606488 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9aaa8631-53e1-43f1-a2f0-8b245b64b7d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x772b42bc7b60>]}
[0m01:46:40.608020 [info ] [Thread-1 (]: 4 of 5 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.18s]
[0m01:46:40.610126 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m01:46:40.615286 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m01:46:40.618914 [info ] [Thread-1 (]: 5 of 5 START sql table model gold.players_recommendations ...................... [RUN]
[0m01:46:40.621824 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m01:46:40.624084 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m01:46:40.659513 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m01:46:40.770706 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 01:46:40.625543 => 01:46:40.770213
[0m01:46:40.771996 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m01:46:40.787014 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m01:46:40.826337 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m01:46:40.830839 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m01:46:40.832881 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m01:46:40.843059 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m01:46:40.845687 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m01:46:40.848382 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

ranked_free_agents AS (
  SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM (select distinct player_id,player,position from "nba"."silver"."players") AS p
    JOIN (SELECT
    player_id,
    player_name,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."player_stats" 
	group by player_id, player_name
    ) AS pgs
    ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents"  AS fa ON p.player_id = fa.player_id
    LEFT JOIN (Select player_id from "nba"."silver"."injuries"  group by player_id) 
	AS i ON p.player_id = i.player_id
    LEFT JOIN (select player_id,max(salary_usd) as salary_usd from "nba"."silver"."salaries" group by player_id) AS s ON p.player_id = s.player_id
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 3 AND position IN ('G', 'F')
    
    UNION ALL
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 3 AND position IN ('G', 'G-F', 'F')
    UNION ALL
    SELECT
        'Rebotes' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 3 AND position IN ('F', 'F-C', 'C')
    UNION ALL
    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 3 AND position IN ('G')
    UNION ALL
    SELECT
        'Robos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 3 AND position IN ('G', 'F')
    UNION ALL
    SELECT
        'Bloqueos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 3 AND position IN ('F-C', 'C')
    UNION ALL
    SELECT
        'Diferencial Puntos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 3
     
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    tt.player_id,
    tt.is_free_agent,
    tt.is_injured
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m01:46:41.053012 [debug] [Thread-1 (]: SQL status: SELECT 9 in 0.0 seconds
[0m01:46:41.062699 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m01:46:41.064708 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m01:46:41.066824 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:46:41.072750 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m01:46:41.073923 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m01:46:41.076164 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m01:46:41.084595 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m01:46:41.085730 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m01:46:41.086673 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m01:46:41.092529 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m01:46:41.101792 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m01:46:41.104443 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m01:46:41.106407 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m01:46:41.131952 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m01:46:41.137199 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 01:46:40.773887 => 01:46:41.136530
[0m01:46:41.138762 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m01:46:41.143705 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9aaa8631-53e1-43f1-a2f0-8b245b64b7d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x772b427c3aa0>]}
[0m01:46:41.145936 [info ] [Thread-1 (]: 5 of 5 OK created sql table model gold.players_recommendations ................. [[32mSELECT 9[0m in 0.52s]
[0m01:46:41.148299 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m01:46:41.153199 [debug] [MainThread]: Using postgres connection "master"
[0m01:46:41.154965 [debug] [MainThread]: On master: BEGIN
[0m01:46:41.156823 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m01:46:41.166754 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m01:46:41.167881 [debug] [MainThread]: On master: COMMIT
[0m01:46:41.168712 [debug] [MainThread]: Using postgres connection "master"
[0m01:46:41.169400 [debug] [MainThread]: On master: COMMIT
[0m01:46:41.170669 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m01:46:41.171863 [debug] [MainThread]: On master: Close
[0m01:46:41.173537 [debug] [MainThread]: Connection 'master' was properly closed.
[0m01:46:41.175150 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m01:46:41.176581 [info ] [MainThread]: 
[0m01:46:41.178063 [info ] [MainThread]: Finished running 5 table models in 0 hours 0 minutes and 1.62 seconds (1.62s).
[0m01:46:41.183438 [debug] [MainThread]: Command end result
[0m01:46:41.246715 [info ] [MainThread]: 
[0m01:46:41.247854 [info ] [MainThread]: [32mCompleted successfully[0m
[0m01:46:41.248849 [info ] [MainThread]: 
[0m01:46:41.249796 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=0 SKIP=0 TOTAL=5
[0m01:46:41.251609 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.4421506, "process_user_time": 4.724633, "process_kernel_time": 0.49014, "process_mem_max_rss": "200860", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m01:46:41.252792 [debug] [MainThread]: Command `dbt run` succeeded at 01:46:41.252539 after 3.44 seconds
[0m01:46:41.253638 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x772b44386db0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x772b4373b320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x772b427a87a0>]}
[0m01:46:41.254408 [debug] [MainThread]: Flushing usage events
[0m23:28:56.237459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f40e88ef0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f41299c40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f41db31d0>]}


============================== 23:28:56.292141 | 696f6866-c423-4fad-a5ff-67fe759b14d8 ==============================
[0m23:28:56.292141 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:28:56.293324 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:28:56.763250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '696f6866-c423-4fad-a5ff-67fe759b14d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f41233b30>]}
[0m23:28:56.891856 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '696f6866-c423-4fad-a5ff-67fe759b14d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f4149dd00>]}
[0m23:28:56.893701 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:28:56.920000 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:28:57.485153 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m23:28:57.486733 [debug] [MainThread]: Partial parsing: added file: spurs_dbt://models/spurs_analysis/spurs_player_contributions_unpivoted.sql
[0m23:28:57.487816 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m23:28:57.698001 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m23:28:57.708666 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '696f6866-c423-4fad-a5ff-67fe759b14d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f4014b350>]}
[0m23:28:57.917170 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '696f6866-c423-4fad-a5ff-67fe759b14d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f401b4650>]}
[0m23:28:57.918648 [info ] [MainThread]: Found 6 models, 6 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m23:28:57.920338 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '696f6866-c423-4fad-a5ff-67fe759b14d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f3fdf8c20>]}
[0m23:28:57.923471 [info ] [MainThread]: 
[0m23:28:57.925137 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:28:57.927658 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m23:28:57.941884 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m23:28:57.943011 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m23:28:57.943873 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:28:57.956352 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m23:28:57.958637 [debug] [ThreadPool]: On list_nba: Close
[0m23:28:57.962036 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m23:28:57.973054 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:28:57.974313 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m23:28:57.975428 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:28:57.983219 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m23:28:57.984811 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:28:57.986479 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m23:28:57.997847 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m23:28:58.000123 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m23:28:58.001684 [debug] [ThreadPool]: On list_nba_gold: Close
[0m23:28:58.011970 [debug] [MainThread]: Using postgres connection "master"
[0m23:28:58.013080 [debug] [MainThread]: On master: BEGIN
[0m23:28:58.013994 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:28:58.023092 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:28:58.024130 [debug] [MainThread]: Using postgres connection "master"
[0m23:28:58.025116 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m23:28:58.057845 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m23:28:58.060071 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '696f6866-c423-4fad-a5ff-67fe759b14d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f415b6a20>]}
[0m23:28:58.061131 [debug] [MainThread]: On master: ROLLBACK
[0m23:28:58.062547 [debug] [MainThread]: Using postgres connection "master"
[0m23:28:58.063730 [debug] [MainThread]: On master: BEGIN
[0m23:28:58.065510 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:28:58.066535 [debug] [MainThread]: On master: COMMIT
[0m23:28:58.067530 [debug] [MainThread]: Using postgres connection "master"
[0m23:28:58.068883 [debug] [MainThread]: On master: COMMIT
[0m23:28:58.070710 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:28:58.071668 [debug] [MainThread]: On master: Close
[0m23:28:58.073118 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m23:28:58.075446 [info ] [MainThread]: 
[0m23:28:58.080910 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m23:28:58.082353 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m23:28:58.084419 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m23:28:58.086940 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m23:28:58.113939 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m23:28:58.140287 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 23:28:58.088266 => 23:28:58.139869
[0m23:28:58.141254 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m23:28:58.194516 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m23:28:58.215090 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:28:58.215922 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m23:28:58.216693 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:28:58.223560 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:28:58.224511 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:28:58.225348 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m23:28:58.270411 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m23:28:58.279261 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:28:58.280145 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m23:28:58.282451 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:28:58.289764 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:28:58.291067 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m23:28:58.292767 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:28:58.323240 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:28:58.324252 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:28:58.325125 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:28:58.332432 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:28:58.341674 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m23:28:58.350058 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:28:58.351191 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m23:28:58.362497 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:28:58.365186 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 23:28:58.141990 => 23:28:58.364826
[0m23:28:58.366326 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m23:28:58.367836 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '696f6866-c423-4fad-a5ff-67fe759b14d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f3f9f2a80>]}
[0m23:28:58.369538 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.28s]
[0m23:28:58.370930 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m23:28:58.371874 [debug] [Thread-1 (]: Began running node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m23:28:58.372827 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.spurs_player_contributions_unpivoted ......... [RUN]
[0m23:28:58.374123 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.spurs_player_contributions_unpivoted)
[0m23:28:58.374974 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m23:28:58.379088 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m23:28:58.391548 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.spurs_player_contributions_unpivoted (compile): 23:28:58.375628 => 23:28:58.391151
[0m23:28:58.392394 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m23:28:58.397717 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m23:28:58.425205 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m23:28:58.426376 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: BEGIN
[0m23:28:58.427307 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:28:58.435010 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:28:58.436649 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m23:28:58.437922 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.spurs_player_contributions_unpivoted"} */

  
    

  create  table "nba"."gold"."spurs_player_contributions_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH source_data AS (

    -- Usamos `source` si tienes la tabla definida en tu `sources.yml`,
    -- o la referenciamos directamente si es un modelo intermedio.
    -- Reemplaza `your_source_name` y `your_table_name` con los nombres correctos.
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
from 
silver.player_stats
where team_abbreviation = 'SAS'
GROUP BY player_id, player_name, team_abbreviation
),


unpivoted_contribucion AS (
    SELECT
        ss.player_id,
        ss.player_name,
        'Porcentaje de tiro de campo' AS rubro,
        ss.avg_fg_pct AS valor
    FROM source_data ss
    
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Porcentaje de tres' AS rubro,
        ss.avg_fg3_pct as valor
    FROM source_data ss
  
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Pérdidas de balón' AS rubro,
        ss.avg_turnovers as valor
    FROM source_data ss
   
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Rebotes' AS rubro,
        ss.avg_rebounds as valor
    FROM source_data ss
  
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Robos' AS rubro,
        ss.avg_steals as valor
    FROM source_data ss
   
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Bloqueos' AS rubro,
        ss.avg_blocks as valor
    FROM source_data ss
  
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Diferencial Puntos' AS rubro,
        ss.avg_plus_minus as valor
    FROM source_data ss
    
)

SELECT * FROM unpivoted_contribucion
  );
  
[0m23:28:58.441221 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column ss.avg_turnovers does not exist
LINE 60:         ss.avg_turnovers as valor
                 ^

[0m23:28:58.442320 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: ROLLBACK
[0m23:28:58.443806 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.spurs_player_contributions_unpivoted (execute): 23:28:58.393019 => 23:28:58.443487
[0m23:28:58.444814 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: Close
[0m23:28:58.455267 [debug] [Thread-1 (]: Database Error in model spurs_player_contributions_unpivoted (models/spurs_analysis/spurs_player_contributions_unpivoted.sql)
  column ss.avg_turnovers does not exist
  LINE 60:         ss.avg_turnovers as valor
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/spurs_player_contributions_unpivoted.sql
[0m23:28:58.456434 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '696f6866-c423-4fad-a5ff-67fe759b14d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f3f9846e0>]}
[0m23:28:58.457516 [error] [Thread-1 (]: 2 of 6 ERROR creating sql table model gold.spurs_player_contributions_unpivoted  [[31mERROR[0m in 0.08s]
[0m23:28:58.458751 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m23:28:58.459808 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m23:28:58.461374 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m23:28:58.462766 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.spurs_player_contributions_unpivoted, now model.spurs_dbt.streaks_and_rivals)
[0m23:28:58.463707 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m23:28:58.469445 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m23:28:58.547925 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 23:28:58.464386 => 23:28:58.547534
[0m23:28:58.548957 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m23:28:58.558396 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m23:28:58.591881 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:28:58.592928 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m23:28:58.593859 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:28:58.600916 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:28:58.602611 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:28:58.603912 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m23:28:58.623585 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m23:28:58.627896 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:28:58.629008 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m23:28:58.630748 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:28:58.635339 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:28:58.636800 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m23:28:58.638408 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:28:58.641219 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:28:58.642211 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:28:58.643121 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:28:58.648172 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:28:58.652537 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m23:28:58.654621 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:28:58.655502 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m23:28:58.661995 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:28:58.664528 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 23:28:58.549870 => 23:28:58.664259
[0m23:28:58.665473 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m23:28:58.667141 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '696f6866-c423-4fad-a5ff-67fe759b14d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f3f5c8d10>]}
[0m23:28:58.668893 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.20s]
[0m23:28:58.670878 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m23:28:58.671945 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m23:28:58.673001 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m23:28:58.674471 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m23:28:58.675368 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m23:28:58.679628 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m23:28:58.712934 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 23:28:58.676024 => 23:28:58.712131
[0m23:28:58.714006 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m23:28:58.721681 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m23:28:58.744096 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:28:58.744963 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m23:28:58.746027 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:28:58.753924 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:28:58.755234 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:28:58.756344 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m23:28:58.779234 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m23:28:58.784249 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:28:58.785435 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m23:28:58.787327 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:28:58.791984 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:28:58.793053 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m23:28:58.794413 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:28:58.799089 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:28:58.800570 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:28:58.802021 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:28:58.810420 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:28:58.815736 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m23:28:58.817464 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:28:58.818963 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m23:28:58.827038 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:28:58.829620 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 23:28:58.714887 => 23:28:58.829308
[0m23:28:58.830773 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m23:28:58.832662 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '696f6866-c423-4fad-a5ff-67fe759b14d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f3f134920>]}
[0m23:28:58.833931 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.16s]
[0m23:28:58.837188 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m23:28:58.838729 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:28:58.840035 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m23:28:58.842263 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m23:28:58.843336 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:28:58.850866 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:28:58.952887 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 23:28:58.844075 => 23:28:58.951916
[0m23:28:58.954587 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:28:58.971057 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:28:59.015163 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:28:59.017226 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m23:28:59.020401 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:28:59.031755 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:28:59.033895 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:28:59.037572 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when t1.season like '2024' then '2024-25'
            else t1.season end as season2,
        AVG(t1.fg_pct::numeric) AS avg_league_fg_pct,
        AVG(t1.fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(t1.tov::numeric) AS avg_league_turnovers,
        AVG(t1.reb::numeric) AS avg_league_rebounds,
        AVG(t1.blk::numeric) AS avg_league_blocks,
        AVG(t1.stl::numeric) AS avg_league_steals,
        AVG(t1.plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games" t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when t1.season like '2024' then '2024-25'
            else t1.season end as season2,
            t1.team_name,
            AVG(t1.fg_pct::numeric) AS avg_fg_pct,
            AVG(t1.fg3_pct::numeric) AS avg_fg3_pct,
            AVG(t1.tov::numeric) AS avg_turnovers,
            AVG(t1.reb::numeric) AS avg_reb,
            AVG(t1.blk::numeric) AS avg_blk,
            AVG(t1.stl::numeric) AS avg_stl,
            AVG(t1.plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games" t1
        INNER JOIN "nba"."silver"."teams" AS t2
            ON t1.team_id = t2.id
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m23:28:59.108660 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m23:28:59.127817 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:28:59.129813 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m23:28:59.133073 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:28:59.144018 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:28:59.148585 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m23:28:59.151784 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:28:59.160049 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:28:59.165189 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:28:59.170191 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:28:59.176767 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:28:59.193587 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m23:28:59.199329 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:28:59.203645 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m23:28:59.214575 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:28:59.223375 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 23:28:58.955516 => 23:28:59.221165
[0m23:28:59.228629 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m23:28:59.231509 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '696f6866-c423-4fad-a5ff-67fe759b14d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f3f985a00>]}
[0m23:28:59.236532 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.39s]
[0m23:28:59.239712 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:28:59.243770 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m23:28:59.246322 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m23:28:59.255155 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m23:28:59.259179 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m23:28:59.278145 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m23:28:59.334342 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 23:28:59.261781 => 23:28:59.333468
[0m23:28:59.338437 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m23:28:59.357392 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m23:28:59.406707 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:28:59.408871 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m23:28:59.411159 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:28:59.428075 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:28:59.430767 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:28:59.433049 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

ranked_free_agents AS (
  SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM (select distinct player_id,player,position from "nba"."silver"."players") AS p
    JOIN (SELECT
    player_id,
    player_name,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."player_stats" 
	group by player_id, player_name
    ) AS pgs
    ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents"  AS fa ON p.player_id = fa.player_id
    LEFT JOIN (Select player_id from "nba"."silver"."injuries"  group by player_id) 
	AS i ON p.player_id = i.player_id
    LEFT JOIN (select player_id,max(salary_usd) as salary_usd from "nba"."silver"."salaries" group by player_id) AS s ON p.player_id = s.player_id
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 5 AND position IN ('G', 'F')
    
    UNION ALL
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 5 AND position IN ('G', 'G-F', 'F')
    UNION ALL
    SELECT
        'Rebotes' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 5 AND position IN ('F', 'F-C', 'C')
    UNION ALL
    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 5 AND position IN ('G')
    UNION ALL
    SELECT
        'Robos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 5 AND position IN ('G', 'F')
    UNION ALL
    SELECT
        'Bloqueos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 5 AND position IN ('F-C', 'C')
    UNION ALL
    SELECT
        'Diferencial Puntos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 5
     
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    tt.player_id,
    tt.is_free_agent,
    tt.is_injured
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m23:28:59.709928 [debug] [Thread-1 (]: SQL status: SELECT 17 in 0.0 seconds
[0m23:28:59.714480 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:28:59.715331 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m23:28:59.716647 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:28:59.721381 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:28:59.722678 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m23:28:59.724120 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:28:59.727277 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m23:28:59.728159 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:28:59.728990 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m23:28:59.733978 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:28:59.739322 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m23:28:59.740819 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:28:59.741600 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m23:28:59.749844 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:28:59.753386 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 23:28:59.340413 => 23:28:59.753032
[0m23:28:59.754621 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m23:28:59.756100 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '696f6866-c423-4fad-a5ff-67fe759b14d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f3fd51880>]}
[0m23:28:59.757243 [info ] [Thread-1 (]: 6 of 6 OK created sql table model gold.players_recommendations ................. [[32mSELECT 17[0m in 0.51s]
[0m23:28:59.758540 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m23:28:59.761580 [debug] [MainThread]: Using postgres connection "master"
[0m23:28:59.762396 [debug] [MainThread]: On master: BEGIN
[0m23:28:59.763095 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:28:59.769208 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:28:59.770158 [debug] [MainThread]: On master: COMMIT
[0m23:28:59.770868 [debug] [MainThread]: Using postgres connection "master"
[0m23:28:59.771523 [debug] [MainThread]: On master: COMMIT
[0m23:28:59.772420 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:28:59.773136 [debug] [MainThread]: On master: Close
[0m23:28:59.774364 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:28:59.775085 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m23:28:59.775840 [info ] [MainThread]: 
[0m23:28:59.776798 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.85 seconds (1.85s).
[0m23:28:59.779043 [debug] [MainThread]: Command end result
[0m23:28:59.868730 [info ] [MainThread]: 
[0m23:28:59.870443 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m23:28:59.871834 [info ] [MainThread]: 
[0m23:28:59.873114 [error] [MainThread]:   Database Error in model spurs_player_contributions_unpivoted (models/spurs_analysis/spurs_player_contributions_unpivoted.sql)
  column ss.avg_turnovers does not exist
  LINE 60:         ss.avg_turnovers as valor
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/spurs_player_contributions_unpivoted.sql
[0m23:28:59.874503 [info ] [MainThread]: 
[0m23:28:59.876040 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m23:28:59.878322 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 4.0847, "process_user_time": 4.180727, "process_kernel_time": 1.030034, "process_mem_max_rss": "200836", "process_in_blocks": "4600", "command_success": false, "process_out_blocks": "0"}
[0m23:28:59.879623 [debug] [MainThread]: Command `dbt run` failed at 23:28:59.879373 after 4.09 seconds
[0m23:28:59.880588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f41299c40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f40da8aa0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x761f405f2ff0>]}
[0m23:28:59.881538 [debug] [MainThread]: Flushing usage events
[0m23:30:07.983935 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f111aa390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f111a97f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f111aa150>]}


============================== 23:30:07.988519 | f3870eee-0241-4894-afe0-f5aa4556a90a ==============================
[0m23:30:07.988519 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:30:07.990526 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:30:08.280807 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f3870eee-0241-4894-afe0-f5aa4556a90a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f110cbc80>]}
[0m23:30:08.399640 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f3870eee-0241-4894-afe0-f5aa4556a90a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f111aac30>]}
[0m23:30:08.401028 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:30:08.423711 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:30:08.708844 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:30:08.710226 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/spurs_player_contributions_unpivoted.sql
[0m23:30:08.930237 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m23:30:08.944193 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f3870eee-0241-4894-afe0-f5aa4556a90a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f0f95eed0>]}
[0m23:30:09.045950 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f3870eee-0241-4894-afe0-f5aa4556a90a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f101ac410>]}
[0m23:30:09.048157 [info ] [MainThread]: Found 6 models, 6 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m23:30:09.050186 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f3870eee-0241-4894-afe0-f5aa4556a90a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f11522330>]}
[0m23:30:09.058728 [info ] [MainThread]: 
[0m23:30:09.061393 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:30:09.066861 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m23:30:09.116244 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m23:30:09.118856 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m23:30:09.124061 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:30:09.138419 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m23:30:09.142654 [debug] [ThreadPool]: On list_nba: Close
[0m23:30:09.149514 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m23:30:09.174836 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:30:09.177366 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m23:30:09.180592 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:30:09.200827 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m23:30:09.203284 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:30:09.206404 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m23:30:09.216744 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m23:30:09.221010 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m23:30:09.223029 [debug] [ThreadPool]: On list_nba_gold: Close
[0m23:30:09.255812 [debug] [MainThread]: Using postgres connection "master"
[0m23:30:09.270431 [debug] [MainThread]: On master: BEGIN
[0m23:30:09.275547 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:30:09.302603 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:30:09.306301 [debug] [MainThread]: Using postgres connection "master"
[0m23:30:09.310153 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m23:30:09.363013 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m23:30:09.366658 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f3870eee-0241-4894-afe0-f5aa4556a90a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f0f9fbfe0>]}
[0m23:30:09.371254 [debug] [MainThread]: On master: ROLLBACK
[0m23:30:09.373305 [debug] [MainThread]: Using postgres connection "master"
[0m23:30:09.374955 [debug] [MainThread]: On master: BEGIN
[0m23:30:09.377188 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:30:09.378571 [debug] [MainThread]: On master: COMMIT
[0m23:30:09.379910 [debug] [MainThread]: Using postgres connection "master"
[0m23:30:09.381332 [debug] [MainThread]: On master: COMMIT
[0m23:30:09.382896 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:30:09.385099 [debug] [MainThread]: On master: Close
[0m23:30:09.388036 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m23:30:09.389759 [info ] [MainThread]: 
[0m23:30:09.398560 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m23:30:09.400446 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m23:30:09.403534 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m23:30:09.405807 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m23:30:09.427423 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m23:30:09.466808 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 23:30:09.407150 => 23:30:09.465828
[0m23:30:09.468504 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m23:30:09.664084 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m23:30:09.701162 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:30:09.702903 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m23:30:09.704772 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:30:09.713828 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:30:09.714928 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:30:09.715726 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m23:30:09.738284 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m23:30:09.746820 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:30:09.747799 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m23:30:09.749555 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:30:09.755020 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:30:09.755962 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m23:30:09.757192 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:30:09.783437 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:30:09.784373 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:30:09.785279 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:30:09.793041 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:30:09.801291 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m23:30:09.810149 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:30:09.811404 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m23:30:09.820323 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:30:09.822934 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 23:30:09.471337 => 23:30:09.822612
[0m23:30:09.823781 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m23:30:09.825189 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3870eee-0241-4894-afe0-f5aa4556a90a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f0f54d0d0>]}
[0m23:30:09.826521 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.42s]
[0m23:30:09.828055 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m23:30:09.829064 [debug] [Thread-1 (]: Began running node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m23:30:09.830032 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.spurs_player_contributions_unpivoted ......... [RUN]
[0m23:30:09.831670 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.spurs_player_contributions_unpivoted)
[0m23:30:09.832590 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m23:30:09.839212 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m23:30:09.860674 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.spurs_player_contributions_unpivoted (compile): 23:30:09.833242 => 23:30:09.860281
[0m23:30:09.861655 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m23:30:09.866980 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m23:30:09.891381 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m23:30:09.892383 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: BEGIN
[0m23:30:09.893248 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:30:09.899634 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:30:09.900592 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m23:30:09.901555 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.spurs_player_contributions_unpivoted"} */

  
    

  create  table "nba"."gold"."spurs_player_contributions_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH source_data AS (

    -- Usamos `source` si tienes la tabla definida en tu `sources.yml`,
    -- o la referenciamos directamente si es un modelo intermedio.
    -- Reemplaza `your_source_name` y `your_table_name` con los nombres correctos.
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
from 
silver.player_stats
where team_abbreviation = 'SAS'
GROUP BY player_id, player_name, team_abbreviation
),


unpivoted_contribucion AS (
    SELECT
        ss.player_id,
        ss.player_name,
        'Porcentaje de tiro de campo' AS rubro,
        ss.avg_fg_pct AS valor
    FROM source_data ss
    
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Porcentaje de tres' AS rubro,
        ss.avg_fg3_pct as valor
    FROM source_data ss
  
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Pérdidas de balón' AS rubro,
        ss.avg_tov as valor
    FROM source_data ss
   
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Rebotes' AS rubro,
        ss.avg_rebounds as valor
    FROM source_data ss
  
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Robos' AS rubro,
        ss.avg_steals as valor
    FROM source_data ss
   
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Bloqueos' AS rubro,
        ss.avg_blocks as valor
    FROM source_data ss
  
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Diferencial Puntos' AS rubro,
        ss.avg_plus_minus as valor
    FROM source_data ss
    
)

SELECT * FROM unpivoted_contribucion
  );
  
[0m23:30:09.904821 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column ss.avg_rebounds does not exist
LINE 69:         ss.avg_rebounds as valor
                 ^

[0m23:30:09.905801 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: ROLLBACK
[0m23:30:09.907121 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.spurs_player_contributions_unpivoted (execute): 23:30:09.862432 => 23:30:09.906805
[0m23:30:09.907951 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: Close
[0m23:30:09.913892 [debug] [Thread-1 (]: Database Error in model spurs_player_contributions_unpivoted (models/spurs_analysis/spurs_player_contributions_unpivoted.sql)
  column ss.avg_rebounds does not exist
  LINE 69:         ss.avg_rebounds as valor
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/spurs_player_contributions_unpivoted.sql
[0m23:30:09.914933 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3870eee-0241-4894-afe0-f5aa4556a90a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f0f599a60>]}
[0m23:30:09.915939 [error] [Thread-1 (]: 2 of 6 ERROR creating sql table model gold.spurs_player_contributions_unpivoted  [[31mERROR[0m in 0.08s]
[0m23:30:09.917179 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m23:30:09.918150 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m23:30:09.920553 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m23:30:09.922187 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.spurs_player_contributions_unpivoted, now model.spurs_dbt.streaks_and_rivals)
[0m23:30:09.923240 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m23:30:09.928361 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m23:30:09.949460 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 23:30:09.923943 => 23:30:09.949054
[0m23:30:09.950977 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m23:30:09.961929 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m23:30:09.988271 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:30:09.989608 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m23:30:09.990981 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:30:09.998615 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:30:09.999890 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:30:10.001700 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m23:30:10.039952 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m23:30:10.044662 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:30:10.045899 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m23:30:10.047640 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:30:10.054715 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:30:10.055804 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m23:30:10.057320 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:30:10.060462 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:30:10.061737 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:30:10.062715 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:30:10.070132 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:30:10.074223 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m23:30:10.075793 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:30:10.076682 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m23:30:10.083466 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:30:10.087056 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 23:30:09.952241 => 23:30:10.086076
[0m23:30:10.088309 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m23:30:10.090018 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3870eee-0241-4894-afe0-f5aa4556a90a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f0f5b29c0>]}
[0m23:30:10.091440 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.17s]
[0m23:30:10.093322 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m23:30:10.094507 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m23:30:10.095552 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m23:30:10.096888 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m23:30:10.097756 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m23:30:10.102113 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m23:30:10.127371 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 23:30:10.098448 => 23:30:10.126841
[0m23:30:10.128338 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m23:30:10.133730 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m23:30:10.159676 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:30:10.161571 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m23:30:10.163053 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:30:10.171162 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:30:10.172810 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:30:10.173879 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m23:30:10.190734 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m23:30:10.195047 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:30:10.195985 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m23:30:10.197375 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:30:10.201389 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:30:10.202879 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m23:30:10.204495 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:30:10.207704 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:30:10.208806 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:30:10.209715 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:30:10.217924 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:30:10.222308 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m23:30:10.223835 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:30:10.224798 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m23:30:10.234099 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:30:10.237466 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 23:30:10.128973 => 23:30:10.237174
[0m23:30:10.238442 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m23:30:10.239856 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3870eee-0241-4894-afe0-f5aa4556a90a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f0f5c03b0>]}
[0m23:30:10.241027 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.14s]
[0m23:30:10.242383 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m23:30:10.243377 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:30:10.244339 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m23:30:10.245641 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m23:30:10.246512 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:30:10.253046 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:30:10.276391 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 23:30:10.247124 => 23:30:10.275632
[0m23:30:10.277459 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:30:10.284093 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:30:10.313720 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:30:10.315500 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m23:30:10.317267 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:30:10.327159 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:30:10.328517 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:30:10.329957 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when t1.season like '2024' then '2024-25'
            else t1.season end as season2,
        AVG(t1.fg_pct::numeric) AS avg_league_fg_pct,
        AVG(t1.fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(t1.tov::numeric) AS avg_league_turnovers,
        AVG(t1.reb::numeric) AS avg_league_rebounds,
        AVG(t1.blk::numeric) AS avg_league_blocks,
        AVG(t1.stl::numeric) AS avg_league_steals,
        AVG(t1.plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games" t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when t1.season like '2024' then '2024-25'
            else t1.season end as season2,
            t1.team_name,
            AVG(t1.fg_pct::numeric) AS avg_fg_pct,
            AVG(t1.fg3_pct::numeric) AS avg_fg3_pct,
            AVG(t1.tov::numeric) AS avg_turnovers,
            AVG(t1.reb::numeric) AS avg_reb,
            AVG(t1.blk::numeric) AS avg_blk,
            AVG(t1.stl::numeric) AS avg_stl,
            AVG(t1.plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games" t1
        INNER JOIN "nba"."silver"."teams" AS t2
            ON t1.team_id = t2.id
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m23:30:10.367903 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m23:30:10.373356 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:30:10.374634 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m23:30:10.377373 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:30:10.386214 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:30:10.387879 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m23:30:10.389504 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:30:10.394468 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:30:10.395488 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:30:10.396291 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:30:10.401674 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:30:10.406465 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m23:30:10.408665 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:30:10.410421 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m23:30:10.417274 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:30:10.420977 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 23:30:10.278166 => 23:30:10.420671
[0m23:30:10.422012 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m23:30:10.424010 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3870eee-0241-4894-afe0-f5aa4556a90a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f0f9e8860>]}
[0m23:30:10.425523 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.18s]
[0m23:30:10.427631 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:30:10.430143 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m23:30:10.431367 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m23:30:10.432801 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m23:30:10.433774 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m23:30:10.441558 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m23:30:10.464719 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 23:30:10.434463 => 23:30:10.464309
[0m23:30:10.465621 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m23:30:10.471945 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m23:30:10.495692 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:30:10.496593 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m23:30:10.497358 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:30:10.504682 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:30:10.506133 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:30:10.507455 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

ranked_free_agents AS (
  SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM (select distinct player_id,player,position from "nba"."silver"."players") AS p
    JOIN (SELECT
    player_id,
    player_name,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."player_stats" 
	group by player_id, player_name
    ) AS pgs
    ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents"  AS fa ON p.player_id = fa.player_id
    LEFT JOIN (Select player_id from "nba"."silver"."injuries"  group by player_id) 
	AS i ON p.player_id = i.player_id
    LEFT JOIN (select player_id,max(salary_usd) as salary_usd from "nba"."silver"."salaries" group by player_id) AS s ON p.player_id = s.player_id
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 5 AND position IN ('G', 'F')
    
    UNION ALL
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 5 AND position IN ('G', 'G-F', 'F')
    UNION ALL
    SELECT
        'Rebotes' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 5 AND position IN ('F', 'F-C', 'C')
    UNION ALL
    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 5 AND position IN ('G')
    UNION ALL
    SELECT
        'Robos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 5 AND position IN ('G', 'F')
    UNION ALL
    SELECT
        'Bloqueos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 5 AND position IN ('F-C', 'C')
    UNION ALL
    SELECT
        'Diferencial Puntos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 5
     
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    tt.player_id,
    tt.is_free_agent,
    tt.is_injured
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m23:30:10.635024 [debug] [Thread-1 (]: SQL status: SELECT 17 in 0.0 seconds
[0m23:30:10.640734 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:30:10.641687 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m23:30:10.643382 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:30:10.647424 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:30:10.648353 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m23:30:10.649696 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:30:10.653944 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m23:30:10.655064 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:30:10.655870 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m23:30:10.660875 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:30:10.664511 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m23:30:10.665807 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:30:10.666649 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m23:30:10.672854 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:30:10.675182 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 23:30:10.466199 => 23:30:10.674896
[0m23:30:10.676016 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m23:30:10.677285 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3870eee-0241-4894-afe0-f5aa4556a90a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f0fd7af00>]}
[0m23:30:10.678392 [info ] [Thread-1 (]: 6 of 6 OK created sql table model gold.players_recommendations ................. [[32mSELECT 17[0m in 0.24s]
[0m23:30:10.679634 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m23:30:10.683039 [debug] [MainThread]: Using postgres connection "master"
[0m23:30:10.684048 [debug] [MainThread]: On master: BEGIN
[0m23:30:10.685170 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:30:10.692318 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:30:10.693182 [debug] [MainThread]: On master: COMMIT
[0m23:30:10.693928 [debug] [MainThread]: Using postgres connection "master"
[0m23:30:10.694687 [debug] [MainThread]: On master: COMMIT
[0m23:30:10.695585 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:30:10.696263 [debug] [MainThread]: On master: Close
[0m23:30:10.697482 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:30:10.698177 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m23:30:10.699253 [info ] [MainThread]: 
[0m23:30:10.700117 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.64 seconds (1.64s).
[0m23:30:10.702543 [debug] [MainThread]: Command end result
[0m23:30:10.753496 [info ] [MainThread]: 
[0m23:30:10.754733 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m23:30:10.755624 [info ] [MainThread]: 
[0m23:30:10.756408 [error] [MainThread]:   Database Error in model spurs_player_contributions_unpivoted (models/spurs_analysis/spurs_player_contributions_unpivoted.sql)
  column ss.avg_rebounds does not exist
  LINE 69:         ss.avg_rebounds as valor
                   ^
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/spurs_player_contributions_unpivoted.sql
[0m23:30:10.757847 [info ] [MainThread]: 
[0m23:30:10.758716 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m23:30:10.760234 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 2.979283, "process_user_time": 4.209795, "process_kernel_time": 0.397301, "process_mem_max_rss": "200860", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m23:30:10.761188 [debug] [MainThread]: Command `dbt run` failed at 23:30:10.761016 after 2.98 seconds
[0m23:30:10.762056 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f11650b60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f0f5afad0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x731f101426f0>]}
[0m23:30:10.763001 [debug] [MainThread]: Flushing usage events
[0m23:32:55.066823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7524ffd225a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75250053edb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7524ffd233b0>]}


============================== 23:32:55.071907 | e319c871-d18e-47f0-b85a-2f2cab814cfc ==============================
[0m23:32:55.071907 [info ] [MainThread]: Running with dbt=1.7.9
[0m23:32:55.073999 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m23:32:55.356815 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e319c871-d18e-47f0-b85a-2f2cab814cfc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7524ff102420>]}
[0m23:32:55.476730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e319c871-d18e-47f0-b85a-2f2cab814cfc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7524ffd7d850>]}
[0m23:32:55.478256 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m23:32:55.501320 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m23:32:55.769077 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m23:32:55.770459 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/spurs_player_contributions_unpivoted.sql
[0m23:32:56.002775 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m23:32:56.011896 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e319c871-d18e-47f0-b85a-2f2cab814cfc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7524fe5fbf80>]}
[0m23:32:56.086443 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e319c871-d18e-47f0-b85a-2f2cab814cfc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7524fed68ce0>]}
[0m23:32:56.088332 [info ] [MainThread]: Found 6 models, 6 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m23:32:56.090748 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e319c871-d18e-47f0-b85a-2f2cab814cfc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7524ff55f230>]}
[0m23:32:56.097626 [info ] [MainThread]: 
[0m23:32:56.100988 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:32:56.106673 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m23:32:56.146477 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m23:32:56.147890 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m23:32:56.150020 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:32:56.165268 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m23:32:56.169113 [debug] [ThreadPool]: On list_nba: Close
[0m23:32:56.175486 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m23:32:56.195150 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:32:56.196686 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m23:32:56.198133 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:32:56.210632 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m23:32:56.212205 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m23:32:56.214357 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m23:32:56.225281 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.0 seconds
[0m23:32:56.231577 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m23:32:56.234092 [debug] [ThreadPool]: On list_nba_gold: Close
[0m23:32:56.259621 [debug] [MainThread]: Using postgres connection "master"
[0m23:32:56.261178 [debug] [MainThread]: On master: BEGIN
[0m23:32:56.262604 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:32:56.272000 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:32:56.273661 [debug] [MainThread]: Using postgres connection "master"
[0m23:32:56.275431 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m23:32:56.306197 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m23:32:56.308164 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e319c871-d18e-47f0-b85a-2f2cab814cfc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7524ff1a5e80>]}
[0m23:32:56.309171 [debug] [MainThread]: On master: ROLLBACK
[0m23:32:56.310300 [debug] [MainThread]: Using postgres connection "master"
[0m23:32:56.311127 [debug] [MainThread]: On master: BEGIN
[0m23:32:56.312546 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:32:56.313778 [debug] [MainThread]: On master: COMMIT
[0m23:32:56.314730 [debug] [MainThread]: Using postgres connection "master"
[0m23:32:56.315574 [debug] [MainThread]: On master: COMMIT
[0m23:32:56.316696 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:32:56.317584 [debug] [MainThread]: On master: Close
[0m23:32:56.319073 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m23:32:56.320049 [info ] [MainThread]: 
[0m23:32:56.327275 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m23:32:56.328413 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m23:32:56.329932 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m23:32:56.330908 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m23:32:56.342230 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m23:32:56.365792 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 23:32:56.331596 => 23:32:56.365324
[0m23:32:56.366843 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m23:32:56.423447 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m23:32:56.447197 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:32:56.448210 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m23:32:56.449095 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:32:56.456951 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:32:56.458392 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:32:56.460263 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m23:32:56.492393 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m23:32:56.518371 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:32:56.519913 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m23:32:56.522752 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:32:56.531922 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:32:56.534075 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m23:32:56.536217 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:32:56.575749 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:32:56.576716 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:32:56.577511 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m23:32:56.584405 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:32:56.598284 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m23:32:56.610712 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m23:32:56.612484 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m23:32:56.619868 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:32:56.623445 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 23:32:56.367548 => 23:32:56.623111
[0m23:32:56.624706 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m23:32:56.627141 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e319c871-d18e-47f0-b85a-2f2cab814cfc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7524fe5b2630>]}
[0m23:32:56.629758 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.30s]
[0m23:32:56.631640 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m23:32:56.632692 [debug] [Thread-1 (]: Began running node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m23:32:56.634029 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.spurs_player_contributions_unpivoted ......... [RUN]
[0m23:32:56.635557 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.spurs_player_contributions_unpivoted)
[0m23:32:56.636497 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m23:32:56.644238 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m23:32:56.665057 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.spurs_player_contributions_unpivoted (compile): 23:32:56.637765 => 23:32:56.664649
[0m23:32:56.665931 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m23:32:56.671852 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m23:32:56.692740 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m23:32:56.693588 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: BEGIN
[0m23:32:56.694427 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:32:56.701058 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:32:56.702193 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m23:32:56.703217 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.spurs_player_contributions_unpivoted"} */

  
    

  create  table "nba"."gold"."spurs_player_contributions_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH source_data AS (

    -- Usamos `source` si tienes la tabla definida en tu `sources.yml`,
    -- o la referenciamos directamente si es un modelo intermedio.
    -- Reemplaza `your_source_name` y `your_table_name` con los nombres correctos.
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
from 
silver.player_stats
where team_abbreviation = 'SAS'
GROUP BY player_id, player_name, team_abbreviation
),


unpivoted_contribucion AS (
    SELECT
        ss.player_id,
        ss.player_name,
        'Porcentaje de tiro de campo' AS rubro,
        ss.avg_fg_pct AS valor
    FROM source_data ss
    
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Porcentaje de tres' AS rubro,
        ss.avg_fg3_pct as valor
    FROM source_data ss
  
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Pérdidas de balón' AS rubro,
        ss.avg_tov as valor
    FROM source_data ss
   
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Rebotes' AS rubro,
        ss.avg_reb as valor
    FROM source_data ss
  
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Robos' AS rubro,
        ss.avg_stl as valor
    FROM source_data ss
   
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Bloqueos' AS rubro,
        ss.avg_blk as valor
    FROM source_data ss
  
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Diferencial Puntos' AS rubro,
        ss.avg_plus_minus as valor
    FROM source_data ss
    
)

SELECT * FROM unpivoted_contribucion
  );
  
[0m23:32:56.730969 [debug] [Thread-1 (]: SQL status: SELECT 238 in 0.0 seconds
[0m23:32:56.735235 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m23:32:56.736098 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.spurs_player_contributions_unpivoted"} */
alter table "nba"."gold"."spurs_player_contributions_unpivoted__dbt_tmp" rename to "spurs_player_contributions_unpivoted"
[0m23:32:56.737497 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:32:56.741197 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: COMMIT
[0m23:32:56.742128 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m23:32:56.742914 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: COMMIT
[0m23:32:56.750953 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:32:56.755573 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."spurs_player_contributions_unpivoted__dbt_backup"
[0m23:32:56.757162 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m23:32:56.758078 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.spurs_player_contributions_unpivoted"} */
drop table if exists "nba"."gold"."spurs_player_contributions_unpivoted__dbt_backup" cascade
[0m23:32:56.759389 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:32:56.761812 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.spurs_player_contributions_unpivoted (execute): 23:32:56.666504 => 23:32:56.761526
[0m23:32:56.762991 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: Close
[0m23:32:56.764536 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e319c871-d18e-47f0-b85a-2f2cab814cfc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7524fe1687d0>]}
[0m23:32:56.767255 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.spurs_player_contributions_unpivoted .... [[32mSELECT 238[0m in 0.13s]
[0m23:32:56.768659 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m23:32:56.769729 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m23:32:56.771650 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m23:32:56.773556 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.spurs_player_contributions_unpivoted, now model.spurs_dbt.streaks_and_rivals)
[0m23:32:56.774599 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m23:32:56.781543 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m23:32:56.810254 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 23:32:56.775310 => 23:32:56.809330
[0m23:32:56.811446 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m23:32:56.817345 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m23:32:56.843802 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:32:56.844846 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m23:32:56.845665 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:32:56.851979 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:32:56.852950 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:32:56.854186 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m23:32:56.876363 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m23:32:56.880786 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:32:56.881789 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m23:32:56.883240 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:32:56.887598 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:32:56.889320 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m23:32:56.890924 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:32:56.893811 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:32:56.894951 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:32:56.895867 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m23:32:56.903406 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:32:56.908106 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m23:32:56.909461 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m23:32:56.910351 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m23:32:56.916065 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:32:56.918493 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 23:32:56.812211 => 23:32:56.918217
[0m23:32:56.919343 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m23:32:56.921198 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e319c871-d18e-47f0-b85a-2f2cab814cfc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7524fe16a2a0>]}
[0m23:32:56.923043 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.15s]
[0m23:32:56.924651 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m23:32:56.925802 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m23:32:56.927274 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m23:32:56.929594 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m23:32:56.930763 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m23:32:56.935454 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m23:32:56.959518 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 23:32:56.931451 => 23:32:56.959060
[0m23:32:56.960482 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m23:32:56.966322 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m23:32:56.991183 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:32:56.992614 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m23:32:56.993469 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:32:56.999762 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:32:57.000735 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:32:57.001547 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m23:32:57.019773 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m23:32:57.025469 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:32:57.026448 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m23:32:57.027748 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:32:57.031718 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:32:57.032540 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m23:32:57.033659 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:32:57.036331 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:32:57.037099 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:32:57.038617 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m23:32:57.046347 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:32:57.050008 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m23:32:57.051330 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m23:32:57.052164 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m23:32:57.058232 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:32:57.060600 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 23:32:56.961185 => 23:32:57.060319
[0m23:32:57.061462 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m23:32:57.062808 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e319c871-d18e-47f0-b85a-2f2cab814cfc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7524fe176690>]}
[0m23:32:57.063898 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.13s]
[0m23:32:57.065160 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m23:32:57.066202 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:32:57.067229 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m23:32:57.068459 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m23:32:57.069294 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:32:57.076705 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:32:57.095975 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 23:32:57.070367 => 23:32:57.095569
[0m23:32:57.096861 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:32:57.102598 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:32:57.127232 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:32:57.128230 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m23:32:57.129090 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:32:57.135618 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:32:57.136801 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:32:57.139510 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when t1.season like '2024' then '2024-25'
            else t1.season end as season2,
        AVG(t1.fg_pct::numeric) AS avg_league_fg_pct,
        AVG(t1.fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(t1.tov::numeric) AS avg_league_turnovers,
        AVG(t1.reb::numeric) AS avg_league_rebounds,
        AVG(t1.blk::numeric) AS avg_league_blocks,
        AVG(t1.stl::numeric) AS avg_league_steals,
        AVG(t1.plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games" t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when t1.season like '2024' then '2024-25'
            else t1.season end as season2,
            t1.team_name,
            AVG(t1.fg_pct::numeric) AS avg_fg_pct,
            AVG(t1.fg3_pct::numeric) AS avg_fg3_pct,
            AVG(t1.tov::numeric) AS avg_turnovers,
            AVG(t1.reb::numeric) AS avg_reb,
            AVG(t1.blk::numeric) AS avg_blk,
            AVG(t1.stl::numeric) AS avg_stl,
            AVG(t1.plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games" t1
        INNER JOIN "nba"."silver"."teams" AS t2
            ON t1.team_id = t2.id
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m23:32:57.169581 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m23:32:57.176436 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:32:57.177492 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m23:32:57.178903 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:32:57.183202 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:32:57.184212 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m23:32:57.185637 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:32:57.191310 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:32:57.192642 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:32:57.193563 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m23:32:57.200744 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:32:57.205416 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m23:32:57.207377 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m23:32:57.208294 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m23:32:57.214583 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:32:57.217081 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 23:32:57.097492 => 23:32:57.216790
[0m23:32:57.218122 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m23:32:57.219735 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e319c871-d18e-47f0-b85a-2f2cab814cfc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7524fe19a8d0>]}
[0m23:32:57.221274 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.15s]
[0m23:32:57.223252 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m23:32:57.225525 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m23:32:57.226522 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m23:32:57.227817 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m23:32:57.228724 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m23:32:57.234874 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m23:32:57.262943 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 23:32:57.229370 => 23:32:57.262528
[0m23:32:57.263826 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m23:32:57.268980 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m23:32:57.290918 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:32:57.291749 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m23:32:57.292473 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:32:57.298443 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m23:32:57.299453 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:32:57.300550 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

ranked_free_agents AS (
  SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM (select distinct player_id,player,position from "nba"."silver"."players") AS p
    JOIN (SELECT
    player_id,
    player_name,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."player_stats" 
	group by player_id, player_name
    ) AS pgs
    ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents"  AS fa ON p.player_id = fa.player_id
    LEFT JOIN (Select player_id from "nba"."silver"."injuries"  group by player_id) 
	AS i ON p.player_id = i.player_id
    LEFT JOIN (select player_id,max(salary_usd) as salary_usd from "nba"."silver"."salaries" group by player_id) AS s ON p.player_id = s.player_id
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 5 AND position IN ('G', 'F')
    
    UNION ALL
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 5 AND position IN ('G', 'G-F', 'F')
    UNION ALL
    SELECT
        'Rebotes' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 5 AND position IN ('F', 'F-C', 'C')
    UNION ALL
    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 5 AND position IN ('G')
    UNION ALL
    SELECT
        'Robos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 5 AND position IN ('G', 'F')
    UNION ALL
    SELECT
        'Bloqueos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 5 AND position IN ('F-C', 'C')
    UNION ALL
    SELECT
        'Diferencial Puntos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 5
     
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    tt.player_id,
    tt.is_free_agent,
    tt.is_injured
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m23:32:57.422964 [debug] [Thread-1 (]: SQL status: SELECT 17 in 0.0 seconds
[0m23:32:57.427447 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:32:57.428439 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m23:32:57.429807 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:32:57.434035 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:32:57.434948 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m23:32:57.436152 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m23:32:57.441051 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m23:32:57.442282 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:32:57.443228 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m23:32:57.448747 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m23:32:57.452475 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m23:32:57.453944 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m23:32:57.455792 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m23:32:57.461943 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m23:32:57.464304 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 23:32:57.264471 => 23:32:57.464031
[0m23:32:57.465309 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m23:32:57.466831 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e319c871-d18e-47f0-b85a-2f2cab814cfc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7524fe1b0e60>]}
[0m23:32:57.468031 [info ] [Thread-1 (]: 6 of 6 OK created sql table model gold.players_recommendations ................. [[32mSELECT 17[0m in 0.24s]
[0m23:32:57.469706 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m23:32:57.473326 [debug] [MainThread]: Using postgres connection "master"
[0m23:32:57.474196 [debug] [MainThread]: On master: BEGIN
[0m23:32:57.475036 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:32:57.481065 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m23:32:57.482083 [debug] [MainThread]: On master: COMMIT
[0m23:32:57.482865 [debug] [MainThread]: Using postgres connection "master"
[0m23:32:57.483698 [debug] [MainThread]: On master: COMMIT
[0m23:32:57.484711 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m23:32:57.485453 [debug] [MainThread]: On master: Close
[0m23:32:57.486823 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:32:57.488257 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m23:32:57.489640 [info ] [MainThread]: 
[0m23:32:57.490643 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.39 seconds (1.39s).
[0m23:32:57.492723 [debug] [MainThread]: Command end result
[0m23:32:57.549206 [info ] [MainThread]: 
[0m23:32:57.550128 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:32:57.551125 [info ] [MainThread]: 
[0m23:32:57.552022 [info ] [MainThread]: Done. PASS=6 WARN=0 ERROR=0 SKIP=0 TOTAL=6
[0m23:32:57.553468 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.5754461, "process_user_time": 3.967857, "process_kernel_time": 0.466333, "process_mem_max_rss": "200860", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m23:32:57.554671 [debug] [MainThread]: Command `dbt run` succeeded at 23:32:57.554302 after 2.58 seconds
[0m23:32:57.555769 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7524ffd225a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7524ff589b80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7524fe177680>]}
[0m23:32:57.556746 [debug] [MainThread]: Flushing usage events
[0m00:30:46.859282 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f56687de2d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f566673d400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5666a75c40>]}


============================== 00:30:46.866527 | c97cddc4-28be-48e9-aab8-71afc23c8616 ==============================
[0m00:30:46.866527 [info ] [MainThread]: Running with dbt=1.7.9
[0m00:30:46.867828 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/usr/local/airflow/dbt/logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m00:30:47.290362 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c97cddc4-28be-48e9-aab8-71afc23c8616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5666b1ab40>]}
[0m00:30:47.421209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c97cddc4-28be-48e9-aab8-71afc23c8616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f56667faf00>]}
[0m00:30:47.423114 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m00:30:47.446599 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m00:30:47.765188 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m00:30:47.766409 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m00:30:48.028723 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m00:30:48.036969 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c97cddc4-28be-48e9-aab8-71afc23c8616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f56666abbc0>]}
[0m00:30:48.117701 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c97cddc4-28be-48e9-aab8-71afc23c8616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f56659afcb0>]}
[0m00:30:48.119069 [info ] [MainThread]: Found 6 models, 6 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m00:30:48.120734 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c97cddc4-28be-48e9-aab8-71afc23c8616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f56651606b0>]}
[0m00:30:48.125810 [info ] [MainThread]: 
[0m00:30:48.127567 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m00:30:48.130593 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m00:30:48.146097 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m00:30:48.147049 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m00:30:48.147873 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:30:48.159169 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m00:30:48.161339 [debug] [ThreadPool]: On list_nba: Close
[0m00:30:48.165080 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m00:30:48.173036 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:30:48.174616 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m00:30:48.176209 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:30:48.183649 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m00:30:48.184778 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m00:30:48.185555 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m00:30:48.192880 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.0 seconds
[0m00:30:48.195228 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m00:30:48.196405 [debug] [ThreadPool]: On list_nba_gold: Close
[0m00:30:48.208148 [debug] [MainThread]: Using postgres connection "master"
[0m00:30:48.209277 [debug] [MainThread]: On master: BEGIN
[0m00:30:48.210022 [debug] [MainThread]: Opening a new connection, currently in state init
[0m00:30:48.216644 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:30:48.217898 [debug] [MainThread]: Using postgres connection "master"
[0m00:30:48.218861 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m00:30:48.247009 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m00:30:48.249123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c97cddc4-28be-48e9-aab8-71afc23c8616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f56659af710>]}
[0m00:30:48.250224 [debug] [MainThread]: On master: ROLLBACK
[0m00:30:48.251487 [debug] [MainThread]: Using postgres connection "master"
[0m00:30:48.252638 [debug] [MainThread]: On master: BEGIN
[0m00:30:48.254347 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:30:48.255999 [debug] [MainThread]: On master: COMMIT
[0m00:30:48.257634 [debug] [MainThread]: Using postgres connection "master"
[0m00:30:48.259365 [debug] [MainThread]: On master: COMMIT
[0m00:30:48.260452 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:30:48.261203 [debug] [MainThread]: On master: Close
[0m00:30:48.262458 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m00:30:48.263346 [info ] [MainThread]: 
[0m00:30:48.269272 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m00:30:48.270414 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m00:30:48.271925 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m00:30:48.272806 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m00:30:48.283799 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m00:30:48.309677 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 00:30:48.273374 => 00:30:48.309255
[0m00:30:48.310676 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m00:30:48.367573 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m00:30:48.395203 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:30:48.396386 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m00:30:48.397321 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:30:48.404937 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:30:48.406255 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:30:48.407857 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m00:30:48.436566 [debug] [Thread-1 (]: SQL status: SELECT 52 in 0.0 seconds
[0m00:30:48.446267 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:30:48.447409 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m00:30:48.449171 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:30:48.455825 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:30:48.457470 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m00:30:48.459977 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:30:48.487860 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:30:48.488903 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:30:48.489934 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m00:30:48.498326 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:30:48.508378 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m00:30:48.517299 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m00:30:48.518363 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m00:30:48.528963 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:30:48.533929 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 00:30:48.311396 => 00:30:48.533217
[0m00:30:48.535228 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m00:30:48.537525 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c97cddc4-28be-48e9-aab8-71afc23c8616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5664d0b980>]}
[0m00:30:48.539430 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 52[0m in 0.27s]
[0m00:30:48.541480 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m00:30:48.542833 [debug] [Thread-1 (]: Began running node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m00:30:48.543990 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.spurs_player_contributions_unpivoted ......... [RUN]
[0m00:30:48.545492 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.spurs_player_contributions_unpivoted)
[0m00:30:48.546599 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m00:30:48.550915 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m00:30:48.574027 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.spurs_player_contributions_unpivoted (compile): 00:30:48.547321 => 00:30:48.573166
[0m00:30:48.575811 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m00:30:48.581499 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m00:30:48.607197 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m00:30:48.608926 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: BEGIN
[0m00:30:48.610830 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:30:48.618514 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:30:48.619492 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m00:30:48.620784 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.spurs_player_contributions_unpivoted"} */

  
    

  create  table "nba"."gold"."spurs_player_contributions_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH source_data AS (

    -- Usamos `source` si tienes la tabla definida en tu `sources.yml`,
    -- o la referenciamos directamente si es un modelo intermedio.
    -- Reemplaza `your_source_name` y `your_table_name` con los nombres correctos.
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
from 
silver.player_stats
where team_abbreviation = 'SAS'
GROUP BY player_id, player_name, team_abbreviation
),


unpivoted_contribucion AS (
    SELECT
        ss.player_id,
        ss.player_name,
        'Porcentaje de tiro de campo' AS rubro,
        ss.avg_fg_pct AS valor
    FROM source_data ss
    
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Porcentaje de tres' AS rubro,
        ss.avg_fg3_pct as valor
    FROM source_data ss
  
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Pérdidas de balón' AS rubro,
        ss.avg_tov as valor
    FROM source_data ss
   
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Rebotes' AS rubro,
        ss.avg_reb as valor
    FROM source_data ss
  
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Robos' AS rubro,
        ss.avg_stl as valor
    FROM source_data ss
   
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Bloqueos' AS rubro,
        ss.avg_blk as valor
    FROM source_data ss
  
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Diferencial Puntos' AS rubro,
        ss.avg_plus_minus as valor
    FROM source_data ss
    
)

SELECT * FROM unpivoted_contribucion
  );
  
[0m00:30:48.871241 [debug] [Thread-1 (]: SQL status: SELECT 238 in 0.0 seconds
[0m00:30:48.895985 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m00:30:48.900099 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.spurs_player_contributions_unpivoted"} */
alter table "nba"."gold"."spurs_player_contributions_unpivoted" rename to "spurs_player_contributions_unpivoted__dbt_backup"
[0m00:30:48.904452 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:30:48.917484 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m00:30:48.926321 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.spurs_player_contributions_unpivoted"} */
alter table "nba"."gold"."spurs_player_contributions_unpivoted__dbt_tmp" rename to "spurs_player_contributions_unpivoted"
[0m00:30:48.929482 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:30:48.935252 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: COMMIT
[0m00:30:48.937385 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m00:30:48.943873 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: COMMIT
[0m00:30:48.950844 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:30:48.967009 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."spurs_player_contributions_unpivoted__dbt_backup"
[0m00:30:48.969785 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m00:30:48.973733 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.spurs_player_contributions_unpivoted"} */
drop table if exists "nba"."gold"."spurs_player_contributions_unpivoted__dbt_backup" cascade
[0m00:30:48.992810 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:30:48.998104 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.spurs_player_contributions_unpivoted (execute): 00:30:48.576504 => 00:30:48.997707
[0m00:30:48.999922 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: Close
[0m00:30:49.003097 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c97cddc4-28be-48e9-aab8-71afc23c8616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5664db77d0>]}
[0m00:30:49.005328 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.spurs_player_contributions_unpivoted .... [[32mSELECT 238[0m in 0.46s]
[0m00:30:49.008365 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m00:30:49.010645 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m00:30:49.012256 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m00:30:49.015771 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.spurs_player_contributions_unpivoted, now model.spurs_dbt.streaks_and_rivals)
[0m00:30:49.017986 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m00:30:49.030661 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m00:30:49.068157 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 00:30:49.021008 => 00:30:49.067309
[0m00:30:49.069675 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m00:30:49.081546 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m00:30:49.120397 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:30:49.122247 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m00:30:49.124373 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:30:49.134013 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:30:49.135743 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:30:49.138500 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m00:30:49.168603 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m00:30:49.178297 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:30:49.180203 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m00:30:49.183712 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:30:49.194159 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:30:49.196592 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m00:30:49.199858 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:30:49.207576 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:30:49.212198 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:30:49.214167 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m00:30:49.222479 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:30:49.230847 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m00:30:49.235463 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m00:30:49.237250 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m00:30:49.246690 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:30:49.251285 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 00:30:49.070701 => 00:30:49.250158
[0m00:30:49.253814 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m00:30:49.256475 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c97cddc4-28be-48e9-aab8-71afc23c8616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5664db7320>]}
[0m00:30:49.259256 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.24s]
[0m00:30:49.261590 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m00:30:49.263076 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m00:30:49.264749 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m00:30:49.266953 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m00:30:49.268283 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m00:30:49.278230 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m00:30:49.306942 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 00:30:49.269306 => 00:30:49.306209
[0m00:30:49.308518 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m00:30:49.314111 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m00:30:49.335669 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:30:49.336515 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m00:30:49.337259 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:30:49.344582 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:30:49.345632 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:30:49.346761 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m00:30:49.366980 [debug] [Thread-1 (]: SQL status: SELECT 26 in 0.0 seconds
[0m00:30:49.371272 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:30:49.372085 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m00:30:49.373531 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:30:49.378158 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:30:49.379223 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m00:30:49.380395 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:30:49.383162 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:30:49.383951 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:30:49.384693 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m00:30:49.390426 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:30:49.394568 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m00:30:49.395897 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m00:30:49.396698 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m00:30:49.403086 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:30:49.405509 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 00:30:49.309241 => 00:30:49.405200
[0m00:30:49.407083 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m00:30:49.409020 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c97cddc4-28be-48e9-aab8-71afc23c8616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5664d806b0>]}
[0m00:30:49.410241 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 26[0m in 0.14s]
[0m00:30:49.411801 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m00:30:49.412953 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:30:49.413996 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m00:30:49.415516 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m00:30:49.416478 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:30:49.422993 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:30:49.448519 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 00:30:49.417250 => 00:30:49.447756
[0m00:30:49.449992 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:30:49.457895 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:30:49.483934 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:30:49.484842 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m00:30:49.485662 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:30:49.492191 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:30:49.493215 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:30:49.494292 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when t1.season like '2024' then '2024-25'
            else t1.season end as season2,
        AVG(t1.fg_pct::numeric) AS avg_league_fg_pct,
        AVG(t1.fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(t1.tov::numeric) AS avg_league_turnovers,
        AVG(t1.reb::numeric) AS avg_league_rebounds,
        AVG(t1.blk::numeric) AS avg_league_blocks,
        AVG(t1.stl::numeric) AS avg_league_steals,
        AVG(t1.plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games" t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when t1.season like '2024' then '2024-25'
            else t1.season end as season2,
            t1.team_name,
            AVG(t1.fg_pct::numeric) AS avg_fg_pct,
            AVG(t1.fg3_pct::numeric) AS avg_fg3_pct,
            AVG(t1.tov::numeric) AS avg_turnovers,
            AVG(t1.reb::numeric) AS avg_reb,
            AVG(t1.blk::numeric) AS avg_blk,
            AVG(t1.stl::numeric) AS avg_stl,
            AVG(t1.plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games" t1
        INNER JOIN "nba"."silver"."teams" AS t2
            ON t1.team_id = t2.id
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m00:30:49.523115 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m00:30:49.528061 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:30:49.529068 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m00:30:49.530390 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:30:49.535689 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:30:49.536864 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m00:30:49.538592 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m00:30:49.543368 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:30:49.544430 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:30:49.545357 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m00:30:49.551175 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m00:30:49.554926 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m00:30:49.556604 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m00:30:49.558339 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m00:30:49.565568 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m00:30:49.568046 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 00:30:49.450863 => 00:30:49.567755
[0m00:30:49.568942 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m00:30:49.570306 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c97cddc4-28be-48e9-aab8-71afc23c8616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5664ded970>]}
[0m00:30:49.571511 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.16s]
[0m00:30:49.572892 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m00:30:49.575269 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m00:30:49.576438 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m00:30:49.577850 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m00:30:49.578833 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m00:30:49.584881 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m00:30:49.611977 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 00:30:49.579511 => 00:30:49.611567
[0m00:30:49.612841 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m00:30:49.617985 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m00:30:49.641431 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:30:49.643014 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m00:30:49.643864 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m00:30:49.650776 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m00:30:49.651729 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m00:30:49.652770 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

ranked_free_agents AS (
  SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM (select distinct player_id,player,position from "nba"."silver"."players") AS p
    JOIN (SELECT
    player_id,
    player_name,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."player_stats" 
	group by player_id, player_name
    ) AS pgs
    ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents"  AS fa ON p.player_id = fa.player_id
    LEFT JOIN (Select player_id from "nba"."silver"."injuries"  group by player_id) 
	AS i ON p.player_id = i.player_id
    LEFT JOIN (select player_id,max(salary_usd) as salary_usd from "nba"."silver"."salaries" group by player_id) AS s ON p.player_id = s.player_id
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 5 AND position IN ('G', 'F')
    
    UNION ALL
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 5 AND position IN ('G', 'G-F', 'F')
    UNION ALL
    SELECT
        'Rebotes' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 5 AND position IN ('F', 'F-C', 'C')
    UNION ALL
    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 5 AND position IN ('G')
    UNION ALL
    SELECT
        'Robos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 5 AND position IN ('G', 'F')
    UNION ALL
    SELECT
        'Bloqueos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 5 AND position IN ('F-C', 'C')
    UNION ALL
    SELECT
        'Diferencial Puntos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 5
     
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_id,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    tt.player_id,
    tt.is_free_agent,
    tt.is_injured
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m00:30:49.660959 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "player_id" specified more than once

[0m00:30:49.661984 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: ROLLBACK
[0m00:30:49.663423 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 00:30:49.613467 => 00:30:49.663099
[0m00:30:49.664286 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m00:30:49.671918 [debug] [Thread-1 (]: Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column "player_id" specified more than once
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m00:30:49.673137 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c97cddc4-28be-48e9-aab8-71afc23c8616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5664904410>]}
[0m00:30:49.674855 [error] [Thread-1 (]: 6 of 6 ERROR creating sql table model gold.players_recommendations ............. [[31mERROR[0m in 0.10s]
[0m00:30:49.676308 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m00:30:49.680478 [debug] [MainThread]: Using postgres connection "master"
[0m00:30:49.681377 [debug] [MainThread]: On master: BEGIN
[0m00:30:49.682223 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m00:30:49.688749 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m00:30:49.689846 [debug] [MainThread]: On master: COMMIT
[0m00:30:49.691431 [debug] [MainThread]: Using postgres connection "master"
[0m00:30:49.692663 [debug] [MainThread]: On master: COMMIT
[0m00:30:49.693791 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m00:30:49.694717 [debug] [MainThread]: On master: Close
[0m00:30:49.696046 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:30:49.696812 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m00:30:49.697617 [info ] [MainThread]: 
[0m00:30:49.698570 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.57 seconds (1.57s).
[0m00:30:49.700760 [debug] [MainThread]: Command end result
[0m00:30:50.153616 [info ] [MainThread]: 
[0m00:30:50.155065 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m00:30:50.156699 [info ] [MainThread]: 
[0m00:30:50.158489 [error] [MainThread]:   Database Error in model players_recommendations (models/spurs_analysis/players_recommendations.sql)
  column "player_id" specified more than once
  compiled Code at target/run/spurs_dbt/models/spurs_analysis/players_recommendations.sql
[0m00:30:50.159845 [info ] [MainThread]: 
[0m00:30:50.160973 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=1 SKIP=0 TOTAL=6
[0m00:30:50.164424 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 3.4164996, "process_user_time": 4.388371, "process_kernel_time": 1.14583, "process_mem_max_rss": "200860", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m00:30:50.166277 [debug] [MainThread]: Command `dbt run` failed at 00:30:50.165697 after 3.42 seconds
[0m00:30:50.167881 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f5666a77980>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f56651f78c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f56651f7f20>]}
[0m00:30:50.169020 [debug] [MainThread]: Flushing usage events
[0m22:17:27.988664 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72690c6c8860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72690d0ea6c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72690c6a9d00>]}


============================== 22:17:27.994985 | dfc9402d-b606-4e5b-b085-403885a35e23 ==============================
[0m22:17:27.994985 [info ] [MainThread]: Running with dbt=1.7.9
[0m22:17:27.996670 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': '/usr/local/airflow/dbt', 'log_path': '/usr/local/airflow/dbt/logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:17:28.582936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dfc9402d-b606-4e5b-b085-403885a35e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72690bbc2990>]}
[0m22:17:28.822812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dfc9402d-b606-4e5b-b085-403885a35e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72690c40e870>]}
[0m22:17:28.825916 [info ] [MainThread]: Registered adapter: postgres=1.7.9
[0m22:17:28.857092 [debug] [MainThread]: checksum: 6ff0d83c3b46f350064523b4e08d9241403ad71d606ba49c4e670afba3668b39, vars: {}, profile: , target: , version: 1.7.9
[0m22:17:29.225822 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 3 files changed.
[0m22:17:29.228430 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/sources.yml
[0m22:17:29.230438 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/spurs_analysis.yml
[0m22:17:29.231627 [debug] [MainThread]: Partial parsing: updated file: spurs_dbt://models/spurs_analysis/players_recommendations.sql
[0m22:17:29.846519 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.spurs_analysis
[0m22:17:29.858247 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dfc9402d-b606-4e5b-b085-403885a35e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72690abe1a60>]}
[0m22:17:29.929323 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dfc9402d-b606-4e5b-b085-403885a35e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72690afad520>]}
[0m22:17:29.930628 [info ] [MainThread]: Found 6 models, 12 tests, 7 sources, 0 exposures, 0 metrics, 402 macros, 0 groups, 0 semantic models
[0m22:17:29.931929 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dfc9402d-b606-4e5b-b085-403885a35e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72690abce960>]}
[0m22:17:29.936284 [info ] [MainThread]: 
[0m22:17:29.938373 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:17:29.941338 [debug] [ThreadPool]: Acquiring new postgres connection 'list_nba'
[0m22:17:29.959329 [debug] [ThreadPool]: Using postgres connection "list_nba"
[0m22:17:29.961029 [debug] [ThreadPool]: On list_nba: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba"} */

    select distinct nspname from pg_namespace
  
[0m22:17:29.962658 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:17:29.978872 [debug] [ThreadPool]: SQL status: SELECT 8 in 0.0 seconds
[0m22:17:29.983444 [debug] [ThreadPool]: On list_nba: Close
[0m22:17:29.988348 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_nba, now list_nba_gold)
[0m22:17:29.998405 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m22:17:29.999565 [debug] [ThreadPool]: On list_nba_gold: BEGIN
[0m22:17:30.000509 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:17:30.011791 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m22:17:30.013210 [debug] [ThreadPool]: Using postgres connection "list_nba_gold"
[0m22:17:30.014671 [debug] [ThreadPool]: On list_nba_gold: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "list_nba_gold"} */
select
      'nba' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'gold'
    union all
    select
      'nba' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'gold'
  
[0m22:17:30.032597 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.0 seconds
[0m22:17:30.034844 [debug] [ThreadPool]: On list_nba_gold: ROLLBACK
[0m22:17:30.036010 [debug] [ThreadPool]: On list_nba_gold: Close
[0m22:17:30.044206 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:30.045505 [debug] [MainThread]: On master: BEGIN
[0m22:17:30.046530 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:17:30.053370 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:17:30.054349 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:30.055297 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:17:30.081074 [debug] [MainThread]: SQL status: SELECT 0 in 0.0 seconds
[0m22:17:30.083291 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dfc9402d-b606-4e5b-b085-403885a35e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72690ab63a40>]}
[0m22:17:30.084520 [debug] [MainThread]: On master: ROLLBACK
[0m22:17:30.086088 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:30.087210 [debug] [MainThread]: On master: BEGIN
[0m22:17:30.089582 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:17:30.091155 [debug] [MainThread]: On master: COMMIT
[0m22:17:30.092310 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:30.093309 [debug] [MainThread]: On master: COMMIT
[0m22:17:30.095121 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:17:30.096368 [debug] [MainThread]: On master: Close
[0m22:17:30.098390 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:17:30.101434 [info ] [MainThread]: 
[0m22:17:30.107873 [debug] [Thread-1 (]: Began running node model.spurs_dbt.home_vs_away
[0m22:17:30.109405 [info ] [Thread-1 (]: 1 of 6 START sql table model gold.home_vs_away ................................. [RUN]
[0m22:17:30.111711 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_nba_gold, now model.spurs_dbt.home_vs_away)
[0m22:17:30.113239 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.home_vs_away
[0m22:17:30.124753 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.home_vs_away"
[0m22:17:30.145455 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (compile): 22:17:30.114131 => 22:17:30.144676
[0m22:17:30.146931 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.home_vs_away
[0m22:17:30.203762 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.home_vs_away"
[0m22:17:30.225178 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:17:30.226480 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: BEGIN
[0m22:17:30.228241 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:17:30.236761 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:17:30.238144 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:17:30.239442 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */

  
    

  create  table "nba"."gold"."home_vs_away__dbt_tmp"
  
  
    as
  
  (
    
WITH nba_games AS (
    SELECT
        t1.*,t2.full_name AS team_name2
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),


base as (
  select
    case when season like '2024' then '2024-25'
         else season end as season,
    team_name2 as team_name,     
    case
      when matchup like '%@%' then 'Away'
      else 'Home'
    end as location,
    wl,
    pts::int as pts
  from nba_games
)

select
  season,
  team_name,
  location,
  count(*) as games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name,location
order by season, location,wins desc
  );
  
[0m22:17:30.271864 [debug] [Thread-1 (]: SQL status: SELECT 58 in 0.0 seconds
[0m22:17:30.284687 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:17:30.285988 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away" rename to "home_vs_away__dbt_backup"
[0m22:17:30.288924 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:17:30.295378 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:17:30.296972 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
alter table "nba"."gold"."home_vs_away__dbt_tmp" rename to "home_vs_away"
[0m22:17:30.298925 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:17:30.330086 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:17:30.331331 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:17:30.332533 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: COMMIT
[0m22:17:30.340488 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:17:30.350643 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."home_vs_away__dbt_backup"
[0m22:17:30.359427 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.home_vs_away"
[0m22:17:30.360799 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.home_vs_away"} */
drop table if exists "nba"."gold"."home_vs_away__dbt_backup" cascade
[0m22:17:30.370546 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:17:30.373665 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.home_vs_away (execute): 22:17:30.147809 => 22:17:30.373378
[0m22:17:30.374715 [debug] [Thread-1 (]: On model.spurs_dbt.home_vs_away: Close
[0m22:17:30.376571 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dfc9402d-b606-4e5b-b085-403885a35e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72690a725df0>]}
[0m22:17:30.378422 [info ] [Thread-1 (]: 1 of 6 OK created sql table model gold.home_vs_away ............................ [[32mSELECT 58[0m in 0.27s]
[0m22:17:30.380333 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.home_vs_away
[0m22:17:30.381918 [debug] [Thread-1 (]: Began running node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m22:17:30.383200 [info ] [Thread-1 (]: 2 of 6 START sql table model gold.spurs_player_contributions_unpivoted ......... [RUN]
[0m22:17:30.384880 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.home_vs_away, now model.spurs_dbt.spurs_player_contributions_unpivoted)
[0m22:17:30.386061 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m22:17:30.390545 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m22:17:30.410543 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.spurs_player_contributions_unpivoted (compile): 22:17:30.387016 => 22:17:30.410087
[0m22:17:30.412047 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m22:17:30.418275 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m22:17:30.439193 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m22:17:30.440226 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: BEGIN
[0m22:17:30.441154 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:17:30.450022 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:17:30.451153 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m22:17:30.452217 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.spurs_player_contributions_unpivoted"} */

  
    

  create  table "nba"."gold"."spurs_player_contributions_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH source_data AS (

    -- Usamos `source` si tienes la tabla definida en tu `sources.yml`,
    -- o la referenciamos directamente si es un modelo intermedio.
    -- Reemplaza `your_source_name` y `your_table_name` con los nombres correctos.
    SELECT
    player_id,
    player_name,
    team_abbreviation,
    AVG(fg_pct::numeric) AS avg_fg_pct,
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
from 
silver.player_stats
where team_abbreviation = 'SAS'
GROUP BY player_id, player_name, team_abbreviation
),


unpivoted_contribucion AS (
    SELECT
        ss.player_id,
        ss.player_name,
        'Porcentaje de tiro de campo' AS rubro,
        ss.avg_fg_pct AS valor
    FROM source_data ss
    
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Porcentaje de tres' AS rubro,
        ss.avg_fg3_pct as valor
    FROM source_data ss
  
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Pérdidas de balón' AS rubro,
        ss.avg_tov as valor
    FROM source_data ss
   
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Rebotes' AS rubro,
        ss.avg_reb as valor
    FROM source_data ss
  
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Robos' AS rubro,
        ss.avg_stl as valor
    FROM source_data ss
   
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Bloqueos' AS rubro,
        ss.avg_blk as valor
    FROM source_data ss
  
    UNION ALL

    SELECT
        ss.player_id,
        ss.player_name,
        'Diferencial Puntos' AS rubro,
        ss.avg_plus_minus as valor
    FROM source_data ss
    
)

SELECT * FROM unpivoted_contribucion
  );
  
[0m22:17:30.499806 [debug] [Thread-1 (]: SQL status: SELECT 238 in 0.0 seconds
[0m22:17:30.504949 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m22:17:30.506160 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.spurs_player_contributions_unpivoted"} */
alter table "nba"."gold"."spurs_player_contributions_unpivoted" rename to "spurs_player_contributions_unpivoted__dbt_backup"
[0m22:17:30.507941 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:17:30.513727 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m22:17:30.515023 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.spurs_player_contributions_unpivoted"} */
alter table "nba"."gold"."spurs_player_contributions_unpivoted__dbt_tmp" rename to "spurs_player_contributions_unpivoted"
[0m22:17:30.516765 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:17:30.519896 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: COMMIT
[0m22:17:30.521196 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m22:17:30.522352 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: COMMIT
[0m22:17:30.532287 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:17:30.536414 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."spurs_player_contributions_unpivoted__dbt_backup"
[0m22:17:30.538001 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.spurs_player_contributions_unpivoted"
[0m22:17:30.539133 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.spurs_player_contributions_unpivoted"} */
drop table if exists "nba"."gold"."spurs_player_contributions_unpivoted__dbt_backup" cascade
[0m22:17:30.547730 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:17:30.551040 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.spurs_player_contributions_unpivoted (execute): 22:17:30.412971 => 22:17:30.550600
[0m22:17:30.552277 [debug] [Thread-1 (]: On model.spurs_dbt.spurs_player_contributions_unpivoted: Close
[0m22:17:30.554129 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dfc9402d-b606-4e5b-b085-403885a35e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72690b3bf320>]}
[0m22:17:30.555564 [info ] [Thread-1 (]: 2 of 6 OK created sql table model gold.spurs_player_contributions_unpivoted .... [[32mSELECT 238[0m in 0.17s]
[0m22:17:30.557205 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.spurs_player_contributions_unpivoted
[0m22:17:30.558370 [debug] [Thread-1 (]: Began running node model.spurs_dbt.streaks_and_rivals
[0m22:17:30.559511 [info ] [Thread-1 (]: 3 of 6 START sql table model gold.streaks_and_rivals ........................... [RUN]
[0m22:17:30.561597 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.spurs_player_contributions_unpivoted, now model.spurs_dbt.streaks_and_rivals)
[0m22:17:30.563028 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.streaks_and_rivals
[0m22:17:30.569391 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.streaks_and_rivals"
[0m22:17:30.590386 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (compile): 22:17:30.563733 => 22:17:30.589918
[0m22:17:30.591471 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.streaks_and_rivals
[0m22:17:30.597614 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.streaks_and_rivals"
[0m22:17:30.615285 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:17:30.616188 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: BEGIN
[0m22:17:30.617226 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:17:30.623970 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:17:30.625110 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:17:30.626217 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */

  
    

  create  table "nba"."gold"."streaks_and_rivals__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_games AS (
    SELECT
        case when season like '2024' then '2024-25'
         else season end as season,
        game_date,
        matchup,
        plus_minus,
        CASE 
            WHEN wl = 'W' THEN 1 
            ELSE 0 
        END AS is_win,
        CASE 
            WHEN wl = 'L' THEN 1 
            ELSE 0 
        END AS is_loss
    FROM "nba"."silver"."games"
    WHERE team_abbreviation = 'SAS'
),

winning_streaks AS (
    SELECT
        *,
        SUM(is_loss) OVER (ORDER BY game_date) AS loss_group
    FROM spurs_games
),

losing_streaks AS (
    SELECT
        *,
        SUM(is_win) OVER (ORDER BY game_date) AS win_group
    FROM spurs_games
),

best_winning_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM winning_streaks
    WHERE is_win = 1
    GROUP BY season, loss_group
    ORDER BY streak_length DESC
    LIMIT 1
),

worst_losing_streak AS (
    SELECT
        season,
        COUNT(*) AS streak_length
    FROM losing_streaks
    WHERE is_loss = 1
    GROUP BY season, win_group
    ORDER BY streak_length DESC
    LIMIT 1
),

biggest_win AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MAX(plus_minus) FROM spurs_games)
    ORDER BY point_differential DESC
    LIMIT 1
),

biggest_loss AS (
    SELECT
        season,
        -- Extrae el nombre del oponente de la columna 'matchup'
        CASE
            WHEN matchup LIKE '%vs.%' THEN SPLIT_PART(matchup, 'vs. ', 2)
            WHEN matchup LIKE '%@%' THEN SPLIT_PART(matchup, '@ ', 2)
            ELSE matchup
        END AS opponent,
        plus_minus AS point_differential
    FROM spurs_games
    WHERE plus_minus = (SELECT MIN(plus_minus) FROM spurs_games)
    ORDER BY point_differential ASC
    LIMIT 1
)

-- Consulta final que une todas las métricas en una sola fila
SELECT
    (SELECT season FROM best_winning_streak) AS best_winning_streak_season,
    (SELECT streak_length FROM best_winning_streak) AS best_winning_streak_length,
    (SELECT season FROM worst_losing_streak) AS worst_losing_streak_season,
    (SELECT streak_length FROM worst_losing_streak) AS worst_losing_streak_length,
    (SELECT season FROM biggest_win) AS biggest_win_season,
    (SELECT opponent FROM biggest_win) AS team_beat_by_most,
    (SELECT point_differential FROM biggest_win) AS biggest_win_margin,
    (SELECT season FROM biggest_loss) AS biggest_loss_season,
    (SELECT opponent FROM biggest_loss) AS team_lost_to_by_most,
    (SELECT point_differential FROM biggest_loss) AS biggest_loss_margin
  );
  
[0m22:17:30.647938 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:17:30.652250 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:17:30.653496 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals" rename to "streaks_and_rivals__dbt_backup"
[0m22:17:30.655165 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:17:30.659490 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:17:30.661004 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
alter table "nba"."gold"."streaks_and_rivals__dbt_tmp" rename to "streaks_and_rivals"
[0m22:17:30.663292 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:17:30.666605 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m22:17:30.667948 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:17:30.668947 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: COMMIT
[0m22:17:30.674895 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:17:30.680789 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."streaks_and_rivals__dbt_backup"
[0m22:17:30.682742 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.streaks_and_rivals"
[0m22:17:30.683797 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.streaks_and_rivals"} */
drop table if exists "nba"."gold"."streaks_and_rivals__dbt_backup" cascade
[0m22:17:30.693870 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:17:30.698009 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.streaks_and_rivals (execute): 22:17:30.592247 => 22:17:30.697705
[0m22:17:30.699167 [debug] [Thread-1 (]: On model.spurs_dbt.streaks_and_rivals: Close
[0m22:17:30.701058 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dfc9402d-b606-4e5b-b085-403885a35e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7269087014c0>]}
[0m22:17:30.702645 [info ] [Thread-1 (]: 3 of 6 OK created sql table model gold.streaks_and_rivals ...................... [[32mSELECT 1[0m in 0.14s]
[0m22:17:30.704201 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.streaks_and_rivals
[0m22:17:30.705434 [debug] [Thread-1 (]: Began running node model.spurs_dbt.summary_by_season
[0m22:17:30.706623 [info ] [Thread-1 (]: 4 of 6 START sql table model gold.summary_by_season ............................ [RUN]
[0m22:17:30.708126 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.streaks_and_rivals, now model.spurs_dbt.summary_by_season)
[0m22:17:30.709318 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.summary_by_season
[0m22:17:30.715071 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.summary_by_season"
[0m22:17:30.734516 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (compile): 22:17:30.710333 => 22:17:30.734130
[0m22:17:30.735497 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.summary_by_season
[0m22:17:30.741471 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.summary_by_season"
[0m22:17:30.759113 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:17:30.760154 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: BEGIN
[0m22:17:30.761413 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:17:30.768415 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:17:30.769570 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:17:30.770604 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */

  
    

  create  table "nba"."gold"."summary_by_season__dbt_tmp"
  
  
    as
  
  (
    

WITH nba_games AS (
    SELECT
        t1.*
    FROM "nba"."silver"."games" AS t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
),

base as (
  select
    case when season like '2024' then '2024-25'
        else season end as season,
    team_name,
    wl,
    pts::int as pts
  from nba_games
  
),

sumariza as (select
  season,
  team_name,
  count(*) as total_games,
  sum(case when wl = 'W' then 1 else 0 end) as wins,
  sum(case when wl = 'L' then 1 else 0 end) as losses,
  round(avg(pts), 2) as avg_points
from base
group by season,team_name
order by season,wins desc)

 
  SELECT
    t1.season,
    t1.team_name,
    t1.wins,
    t1.losses,
    t1.total_games,
    t1.avg_points,
    DENSE_RANK() OVER (PARTITION BY t1.season ORDER BY t1.wins DESC, t1.losses ASC,t1.avg_points desc) AS team_ranking
from sumariza t1
  );
  
[0m22:17:30.793916 [debug] [Thread-1 (]: SQL status: SELECT 29 in 0.0 seconds
[0m22:17:30.798792 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:17:30.799933 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season" rename to "summary_by_season__dbt_backup"
[0m22:17:30.801512 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:17:30.805757 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:17:30.807095 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
alter table "nba"."gold"."summary_by_season__dbt_tmp" rename to "summary_by_season"
[0m22:17:30.808473 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:17:30.812840 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:17:30.814094 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:17:30.815167 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: COMMIT
[0m22:17:30.821321 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:17:30.825752 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."summary_by_season__dbt_backup"
[0m22:17:30.827971 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.summary_by_season"
[0m22:17:30.829711 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.summary_by_season"} */
drop table if exists "nba"."gold"."summary_by_season__dbt_backup" cascade
[0m22:17:30.838047 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:17:30.840523 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.summary_by_season (execute): 22:17:30.736259 => 22:17:30.840257
[0m22:17:30.841919 [debug] [Thread-1 (]: On model.spurs_dbt.summary_by_season: Close
[0m22:17:30.843651 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dfc9402d-b606-4e5b-b085-403885a35e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72690b323f80>]}
[0m22:17:30.846421 [info ] [Thread-1 (]: 4 of 6 OK created sql table model gold.summary_by_season ....................... [[32mSELECT 29[0m in 0.14s]
[0m22:17:30.848826 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.summary_by_season
[0m22:17:30.850664 [debug] [Thread-1 (]: Began running node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:17:30.852215 [info ] [Thread-1 (]: 5 of 6 START sql table model gold.team_weaknesses_unpivoted .................... [RUN]
[0m22:17:30.854105 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.summary_by_season, now model.spurs_dbt.team_weaknesses_unpivoted)
[0m22:17:30.855225 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:17:30.862637 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:17:30.882382 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (compile): 22:17:30.856100 => 22:17:30.881912
[0m22:17:30.883433 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:17:30.890174 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:17:30.909192 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:17:30.910414 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: BEGIN
[0m22:17:30.911857 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:17:30.919466 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:17:30.923350 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:17:30.924862 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */

  
    

  create  table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_stats AS (
    SELECT
        case when season like '2024' then '2024-25'
            else season end as season2,
        AVG(fg_pct::numeric) AS avg_fg_pct,
        AVG(fg3_pct::numeric) AS avg_fg3_pct,
        AVG(tov::numeric) AS avg_turnovers,
        AVG(reb::numeric) AS avg_rebounds,
        AVG(blk::numeric) AS avg_blocks,
        AVG(stl::numeric) AS avg_steals,
        AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."games"
    WHERE team_name = 'San Antonio Spurs'
    GROUP BY season2
),

team_averages AS (
    SELECT
        case when t1.season like '2024' then '2024-25'
            else t1.season end as season2,
        AVG(t1.fg_pct::numeric) AS avg_league_fg_pct,
        AVG(t1.fg3_pct::numeric) AS avg_league_fg3_pct,
        AVG(t1.tov::numeric) AS avg_league_turnovers,
        AVG(t1.reb::numeric) AS avg_league_rebounds,
        AVG(t1.blk::numeric) AS avg_league_blocks,
        AVG(t1.stl::numeric) AS avg_league_steals,
        AVG(t1.plus_minus::numeric) AS avg_league_plus_minus
    FROM "nba"."silver"."games" t1
    INNER JOIN "nba"."silver"."teams" AS t2
        ON t1.team_id = t2.id
    GROUP BY season2
),

best_team_stats AS (
    SELECT
        season2 AS season2,
        MAX(avg_fg_pct) AS best_team_avg_fg_pct,
        MAX(avg_fg3_pct) AS best_team_avg_fg3_pct,
        MIN(avg_turnovers) AS best_team_avg_turnovers, -- Menos pérdidas es mejor
        MAX(avg_reb) AS best_team_avg_rebounds,
        MAX(avg_blk) AS best_team_avg_blocks,
        MAX(avg_stl) AS best_team_avg_steals,
        MAX(avg_plus_minus) AS best_team_avg_plus_minus
    FROM (
        SELECT
            case when t1.season like '2024' then '2024-25'
            else t1.season end as season2,
            t1.team_name,
            AVG(t1.fg_pct::numeric) AS avg_fg_pct,
            AVG(t1.fg3_pct::numeric) AS avg_fg3_pct,
            AVG(t1.tov::numeric) AS avg_turnovers,
            AVG(t1.reb::numeric) AS avg_reb,
            AVG(t1.blk::numeric) AS avg_blk,
            AVG(t1.stl::numeric) AS avg_stl,
            AVG(t1.plus_minus::numeric) AS avg_plus_minus
        FROM "nba"."silver"."games" t1
        INNER JOIN "nba"."silver"."teams" AS t2
            ON t1.team_id = t2.id
        GROUP BY season2, team_name
    ) AS all_teams
    GROUP BY season2
),

unpivoted_weaknesses AS (
    SELECT
        ss.season2,
        'Porcentaje de tiro de campo' AS weakness_type,
        ss.avg_fg_pct AS valor_equipo,
        ta.avg_league_fg_pct AS valor_liga,
        bts.best_team_avg_fg_pct AS valor_mejor_equipo,
        case when ss.avg_fg_pct < ta.avg_league_fg_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
    
    UNION ALL

    SELECT
        ss.season2,
        'Porcentaje de tres' AS weakness_type,
        ss.avg_fg3_pct,
        ta.avg_league_fg3_pct,
        bts.best_team_avg_fg3_pct,
        case when ss.avg_fg3_pct < ta.avg_league_fg3_pct then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Pérdidas de balón' AS weakness_type,
        ss.avg_turnovers,
        ta.avg_league_turnovers,
        bts.best_team_avg_turnovers,
        case when ss.avg_turnovers > ta.avg_league_turnovers then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Rebotes' AS weakness_type,
        ss.avg_rebounds,
        ta.avg_league_rebounds,
        bts.best_team_avg_rebounds,
        case when ss.avg_rebounds < ta.avg_league_rebounds then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Robos' AS weakness_type,
        ss.avg_steals,
        ta.avg_league_steals,
        bts.best_team_avg_steals,
        case when ss.avg_steals < ta.avg_league_steals then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Bloqueos' AS weakness_type,
        ss.avg_blocks,
        ta.avg_league_blocks,
        bts.best_team_avg_blocks,
        case when ss.avg_blocks < ta.avg_league_blocks then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2

    UNION ALL

    SELECT
        ss.season2,
        'Diferencial Puntos' AS weakness_type,
        ss.avg_plus_minus,
        ta.avg_league_plus_minus,
        bts.best_team_avg_plus_minus,
        case when ss.avg_plus_minus < ta.avg_league_plus_minus then 'Debilidad' else 'Fortaleza' end AS Resultado
    FROM spurs_stats ss
    JOIN team_averages ta ON ss.season2 = ta.season2
    JOIN best_team_stats bts ON ss.season2 = bts.season2
)

SELECT
    season2,
    weakness_type,
    valor_equipo,
    valor_liga,
    valor_mejor_equipo,
    resultado
FROM unpivoted_weaknesses
ORDER BY season2, weakness_type
  );
  
[0m22:17:30.964489 [debug] [Thread-1 (]: SQL status: SELECT 7 in 0.0 seconds
[0m22:17:30.970103 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:17:30.971569 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted" rename to "team_weaknesses_unpivoted__dbt_backup"
[0m22:17:30.973830 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:17:31.062630 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:17:31.063929 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
alter table "nba"."gold"."team_weaknesses_unpivoted__dbt_tmp" rename to "team_weaknesses_unpivoted"
[0m22:17:31.065852 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:17:31.069645 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m22:17:31.070691 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:17:31.071615 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: COMMIT
[0m22:17:31.077894 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:17:31.082821 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."team_weaknesses_unpivoted__dbt_backup"
[0m22:17:31.084391 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.team_weaknesses_unpivoted"
[0m22:17:31.085461 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.team_weaknesses_unpivoted"} */
drop table if exists "nba"."gold"."team_weaknesses_unpivoted__dbt_backup" cascade
[0m22:17:31.093899 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:17:31.097368 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.team_weaknesses_unpivoted (execute): 22:17:30.884286 => 22:17:31.097041
[0m22:17:31.098351 [debug] [Thread-1 (]: On model.spurs_dbt.team_weaknesses_unpivoted: Close
[0m22:17:31.100182 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dfc9402d-b606-4e5b-b085-403885a35e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7269087465d0>]}
[0m22:17:31.101572 [info ] [Thread-1 (]: 5 of 6 OK created sql table model gold.team_weaknesses_unpivoted ............... [[32mSELECT 7[0m in 0.25s]
[0m22:17:31.103432 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.team_weaknesses_unpivoted
[0m22:17:31.105595 [debug] [Thread-1 (]: Began running node model.spurs_dbt.players_recommendations
[0m22:17:31.107061 [info ] [Thread-1 (]: 6 of 6 START sql table model gold.players_recommendations ...................... [RUN]
[0m22:17:31.108762 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.spurs_dbt.team_weaknesses_unpivoted, now model.spurs_dbt.players_recommendations)
[0m22:17:31.109998 [debug] [Thread-1 (]: Began compiling node model.spurs_dbt.players_recommendations
[0m22:17:31.118042 [debug] [Thread-1 (]: Writing injected SQL for node "model.spurs_dbt.players_recommendations"
[0m22:17:31.135350 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (compile): 22:17:31.111096 => 22:17:31.134944
[0m22:17:31.136514 [debug] [Thread-1 (]: Began executing node model.spurs_dbt.players_recommendations
[0m22:17:31.143572 [debug] [Thread-1 (]: Writing runtime sql for node "model.spurs_dbt.players_recommendations"
[0m22:17:31.159182 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:17:31.160178 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: BEGIN
[0m22:17:31.162171 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:17:31.169420 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:17:31.170725 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:17:31.172892 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */

  
    

  create  table "nba"."gold"."players_recommendations__dbt_tmp"
  
  
    as
  
  (
    

WITH spurs_weaknesses_unpivoted AS (
    SELECT
        season2,
        weakness_type
    FROM "nba"."gold"."team_weaknesses_unpivoted"
    WHERE Resultado = 'Debilidad'
),

ranked_free_agents AS (
  SELECT
        p.player_id,
        p.player AS player_name,
        p.position,
        CASE WHEN fa.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_free_agent,
        CASE WHEN i.player_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_injured,
        s.salary_usd::numeric AS salary,
        pgs.avg_fg_pct,
        pgs.avg_fg3_pct,
        pgs.avg_reb,
        pgs.avg_tov,
        pgs.avg_plus_minus,
        pgs.avg_stl,
        pgs.avg_blk,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_fg_pct DESC) AS rank_fg,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_fg3_pct DESC) AS rank_fg3,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_reb DESC) AS rank_reb,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_tov ASC) AS rank_tov,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_stl DESC) AS rank_stl,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_blk DESC) AS rank_blk,
        ROW_NUMBER() OVER (ORDER BY pgs.avg_plus_minus DESC) AS rank_plus_minus
    FROM (select distinct player_id,player,position from "nba"."silver"."players") AS p
    JOIN (SELECT
    player_id,
    player_name,
    AVG(fg_pct::numeric) AS avg_fg_pct,  
    AVG(fg3_pct::numeric) AS avg_fg3_pct,
    AVG(reb::numeric) AS avg_reb,
    AVG(tov::numeric) AS avg_tov,
    AVG(stl::numeric) AS avg_stl,
    AVG(blk::numeric) AS avg_blk,
    AVG(plus_minus::numeric) AS avg_plus_minus
    FROM "nba"."silver"."player_stats" 
	group by player_id, player_name
    ) AS pgs
    ON p.player_id = pgs.player_id
    LEFT JOIN "nba"."silver"."free_agents"  AS fa ON p.player_id = fa.player_id
    LEFT JOIN (Select player_id from "nba"."silver"."injuries"  group by player_id) 
	AS i ON p.player_id = i.player_id
    LEFT JOIN (select player_id,max(salary_usd) as salary_usd from "nba"."silver"."salaries" group by player_id) AS s ON p.player_id = s.player_id
),

top_targets AS (
    SELECT
        'Porcentaje de tiro de campo' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para mejorar la eficiencia del tiro.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg <= 5 AND position IN ('G', 'F')
    
    UNION ALL
    SELECT
        'Porcentaje de tres' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_fg3_pct AS metric_value,
        position,
        salary,
        'Contratar un tirador de élite para abrir el campo.' AS reason
    FROM ranked_free_agents
    WHERE rank_fg3 <= 5 AND position IN ('G', 'G-F', 'F')
    UNION ALL
    SELECT
        'Rebotes' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_reb AS metric_value,
        position,
        salary,
        'Adquirir un rebotador consistente para controlar los tableros.' AS reason
    FROM ranked_free_agents
    WHERE rank_reb <= 5 AND position IN ('F', 'F-C', 'C')
    UNION ALL
    SELECT
        'Pérdidas de balón' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_tov AS metric_value,
        position,
        salary,
        'Incorporar un base que reduzca las pérdidas de balón.' AS reason
    FROM ranked_free_agents
    WHERE rank_tov <= 5 AND position IN ('G')
    UNION ALL
    SELECT
        'Robos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_stl AS metric_value,
        position,
        salary,
        'Firmar un defensor perimetral para mejorar la defensa en el robo de balones.' AS reason
    FROM ranked_free_agents
    WHERE rank_stl <= 5 AND position IN ('G', 'F')
    UNION ALL
    SELECT
        'Bloqueos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_blk AS metric_value,
        position,
        salary,
        'Contratar un defensor interior para proteger el aro y aumentar los bloqueos.' AS reason
    FROM ranked_free_agents
    WHERE rank_blk <= 5 AND position IN ('F-C', 'C')
    UNION ALL
    SELECT
        'Diferencial Puntos' AS weakness_type,
        player_id,
        is_free_agent,
        is_injured,
        player_name,
        avg_plus_minus AS metric_value,
        position,
        salary,
        'Contratar a un jugador con impacto positivo en el diferencial de puntos.' AS reason
    FROM ranked_free_agents
    WHERE rank_plus_minus <= 5
     
)

SELECT
    swu.season2,
    tt.weakness_type,
    tt.player_name AS recommended_player,
    tt.position,
    tt.metric_value,
    tt.salary,
    tt.reason,
    tt.player_id,
    tt.is_free_agent,
    tt.is_injured
FROM spurs_weaknesses_unpivoted swu
JOIN top_targets tt ON swu.weakness_type = tt.weakness_type
ORDER BY swu.season2, tt.weakness_type, tt.metric_value DESC
  );
  
[0m22:17:31.382776 [debug] [Thread-1 (]: SQL status: SELECT 15 in 0.0 seconds
[0m22:17:31.387443 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:17:31.388415 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations" rename to "players_recommendations__dbt_backup"
[0m22:17:31.390024 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:17:31.395379 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:17:31.396431 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
alter table "nba"."gold"."players_recommendations__dbt_tmp" rename to "players_recommendations"
[0m22:17:31.397863 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:17:31.400711 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m22:17:31.401501 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:17:31.402312 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: COMMIT
[0m22:17:31.407094 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:17:31.411213 [debug] [Thread-1 (]: Applying DROP to: "nba"."gold"."players_recommendations__dbt_backup"
[0m22:17:31.412763 [debug] [Thread-1 (]: Using postgres connection "model.spurs_dbt.players_recommendations"
[0m22:17:31.413538 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: /* {"app": "dbt", "dbt_version": "1.7.9", "profile_name": "spurs_profile", "target_name": "dev", "node_id": "model.spurs_dbt.players_recommendations"} */
drop table if exists "nba"."gold"."players_recommendations__dbt_backup" cascade
[0m22:17:31.419384 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:17:31.421916 [debug] [Thread-1 (]: Timing info for model.spurs_dbt.players_recommendations (execute): 22:17:31.137701 => 22:17:31.421577
[0m22:17:31.422803 [debug] [Thread-1 (]: On model.spurs_dbt.players_recommendations: Close
[0m22:17:31.424166 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dfc9402d-b606-4e5b-b085-403885a35e23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72690afbede0>]}
[0m22:17:31.425235 [info ] [Thread-1 (]: 6 of 6 OK created sql table model gold.players_recommendations ................. [[32mSELECT 15[0m in 0.32s]
[0m22:17:31.426400 [debug] [Thread-1 (]: Finished running node model.spurs_dbt.players_recommendations
[0m22:17:31.429571 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:31.430415 [debug] [MainThread]: On master: BEGIN
[0m22:17:31.431188 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:17:31.437275 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:17:31.438179 [debug] [MainThread]: On master: COMMIT
[0m22:17:31.438930 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:31.439687 [debug] [MainThread]: On master: COMMIT
[0m22:17:31.440776 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:17:31.441696 [debug] [MainThread]: On master: Close
[0m22:17:31.443106 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:17:31.444069 [debug] [MainThread]: Connection 'model.spurs_dbt.players_recommendations' was properly closed.
[0m22:17:31.445744 [info ] [MainThread]: 
[0m22:17:31.446817 [info ] [MainThread]: Finished running 6 table models in 0 hours 0 minutes and 1.51 seconds (1.51s).
[0m22:17:31.449045 [debug] [MainThread]: Command end result
[0m22:17:31.500906 [info ] [MainThread]: 
[0m22:17:31.501972 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:17:31.502970 [info ] [MainThread]: 
[0m22:17:31.503923 [info ] [MainThread]: Done. PASS=6 WARN=0 ERROR=0 SKIP=0 TOTAL=6
[0m22:17:31.506403 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.6135979, "process_user_time": 5.038011, "process_kernel_time": 1.26452, "process_mem_max_rss": "200996", "process_in_blocks": "4488", "process_out_blocks": "0"}
[0m22:17:31.507593 [debug] [MainThread]: Command `dbt run` succeeded at 22:17:31.507390 after 3.62 seconds
[0m22:17:31.508757 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72690c6c8860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72690afada60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72690a7bfce0>]}
[0m22:17:31.509863 [debug] [MainThread]: Flushing usage events
